<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>Naomi Nosonovsky &#8211; LessthanDot</title>
	<atom:link href="/index.php/author/naomi/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>ASP.NET MVC project with Modal dialogs and Flexigrid</title>
		<link>/index.php/webdev/uidevelopment/ajax/asp-net-mvc-project-with/</link>
		<comments>/index.php/webdev/uidevelopment/ajax/asp-net-mvc-project-with/#comments</comments>
		<pubDate>Sun, 27 Jan 2013 20:24:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[AJAX]]></category>

		<guid isPermaLink="false">/index.php/2013/01/asp-net-mvc-project-with/</guid>
		<description><![CDATA[In the last few months I started working on my first ASP.NET MVC project. I already had a Visual FoxPro application I wrote in a few days and I wanted to replicate it for the Web using ASP.NET MVC. This project is still in its infancy, but I want to sha&#8230;]]></description>
				<content:encoded><![CDATA[<p>In the last few months I started working on my first ASP.NET MVC project. I already had a Visual FoxPro application I wrote in a few days and I wanted to replicate it for the Web using ASP.NET MVC. This project is still in its infancy, but I want to share my experience and some success I have with it.</p>
<p>I also first want to thank people who helped me to get where I am now with this project: Viv Phillips and Paul Mrozowski from UniversalThread, Darin Dimitrov from stackoverflow, Alex Ullrich and Sergey Kosik and also Jazzen Chen from MS. I also want to thank authors of many blogs and articles I read while working on this project.</p>
<p>I started my project from defining my models using Entity Framework Code first pattern since I already had the database defined. I am going to discuss only one model &#8220;Client&#8221; for the Clients table.</p>
<p>This is how the table looks in the database:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span><span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">int</span><span class="br0">&#93;</span> <span class="kw1">IDENTITY</span><span class="br0">&#40;</span><span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">smallint</span><span class="br0">&#93;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">30</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Address<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">char</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">6</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">smalldatetime</span><span class="br0">&#93;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">char</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">6</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">smalldatetime</span><span class="br0">&#93;</span> <span class="sy0">NULL</span>,
&nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>PK_Clients_ClientID<span class="br0">&#93;</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="kw1">CLUSTERED</span> 
<span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span> <span class="kw1">ASC</span>
<span class="br0">&#41;</span><span class="kw1">WITH</span> <span class="br0">&#40;</span>PAD_<span class="sy0">IN</span>DEX &nbsp;<span class="sy0">=</span> <span class="kw1">OFF</span>, STATISTICS_N<span class="sy0">OR</span>ECOMPUTE &nbsp;<span class="sy0">=</span> <span class="kw1">OFF</span>, IGN<span class="sy0">OR</span>E_DUP_KEY <span class="sy0">=</span> <span class="kw1">OFF</span>, <span class="sy0">ALL</span>OW_ROW_LOCKS &nbsp;<span class="sy0">=</span> <span class="kw1">ON</span>, <span class="sy0">ALL</span>OW_PAGE_LOCKS &nbsp;<span class="sy0">=</span> <span class="kw1">ON</span><span class="br0">&#41;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span><span class="kw1">PRIMARY</span><span class="br0">&#93;</span>
<span class="br0">&#41;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span><span class="kw1">PRIMARY</span><span class="br0">&#93;</span> TEXTIMAGE_ON <span class="br0">&#91;</span><span class="kw1">PRIMARY</span><span class="br0">&#93;</span>
GO
<span class="kw1">SET</span> ANSI_PADD<span class="sy0">IN</span>G <span class="kw1">OFF</span>
GO
<span class="kw1">CREATE</span> <span class="kw1">NONCLUSTERED</span> <span class="kw1">INDEX</span> <span class="br0">&#91;</span>idxClients_Client_No<span class="br0">&#93;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> 
<span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span> <span class="kw1">ASC</span>
<span class="br0">&#41;</span><span class="kw1">WITH</span> <span class="br0">&#40;</span>PAD_<span class="sy0">IN</span>DEX &nbsp;<span class="sy0">=</span> <span class="kw1">OFF</span>, STATISTICS_N<span class="sy0">OR</span>ECOMPUTE &nbsp;<span class="sy0">=</span> <span class="kw1">OFF</span>, S<span class="sy0">OR</span>T_<span class="sy0">IN</span>_TEMPDB <span class="sy0">=</span> <span class="kw1">OFF</span>, IGN<span class="sy0">OR</span>E_DUP_KEY <span class="sy0">=</span> <span class="kw1">OFF</span>, DROP_EXIST<span class="sy0">IN</span>G <span class="sy0">=</span> <span class="kw1">OFF</span>, ONL<span class="sy0">IN</span>E <span class="sy0">=</span> <span class="kw1">OFF</span>, <span class="sy0">ALL</span>OW_ROW_LOCKS &nbsp;<span class="sy0">=</span> <span class="kw1">ON</span>, <span class="sy0">ALL</span>OW_PAGE_LOCKS &nbsp;<span class="sy0">=</span> <span class="kw1">ON</span><span class="br0">&#41;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span><span class="kw1">PRIMARY</span><span class="br0">&#93;</span>
&nbsp;
<span class="coMULTI">/****** Object: &nbsp;Default [DF_Clients_EnteredBy] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>DF_Clients_EnteredBy<span class="br0">&#93;</span> &nbsp;<span class="kw1">DEFAULT</span> <span class="br0">&#40;</span><span class="st0">'ADMIN'</span><span class="br0">&#41;</span> <span class="kw1">FOR</span> <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;Default [DF_Clients_EnteredOn] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>DF_Clients_EnteredOn<span class="br0">&#93;</span> &nbsp;<span class="kw1">DEFAULT</span> <span class="br0">&#40;</span><span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">FOR</span> <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;Check [CK_Clients_C1_Phone] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> &nbsp;<span class="kw1">WITH</span> <span class="kw1">CHECK</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>CK_Clients_C1_Phone<span class="br0">&#93;</span> <span class="kw1">CHECK</span> &nbsp;<span class="br0">&#40;</span><span class="br0">&#40;</span><span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span> like <span class="st0">'[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">CHECK</span> <span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>CK_Clients_C1_Phone<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;Check [CK_Clients_C2_Phone] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> &nbsp;<span class="kw1">WITH</span> <span class="kw1">CHECK</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>CK_Clients_C2_Phone<span class="br0">&#93;</span> <span class="kw1">CHECK</span> &nbsp;<span class="br0">&#40;</span><span class="br0">&#40;</span><span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span> like <span class="st0">'[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">CHECK</span> <span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>CK_Clients_C2_Phone<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;ForeignKey [FK_Clients_Operators_EnteredBy] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> &nbsp;<span class="kw1">WITH</span> <span class="kw1">CHECK</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>FK_Clients_Operators_EnteredBy<span class="br0">&#93;</span> <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span><span class="br0">&#40;</span><span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span><span class="br0">&#41;</span>
<span class="kw1">REFERENCES</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Operators<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>op_code<span class="br0">&#93;</span><span class="br0">&#41;</span>
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">CHECK</span> <span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>FK_Clients_Operators_EnteredBy<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;ForeignKey [FK_Clients_Operators_ModifiedBy] &nbsp; &nbsp;Script Date: 12/19/2012 07:00:35 ******/</span>
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> &nbsp;<span class="kw1">WITH</span> <span class="kw1">CHECK</span> <span class="kw1">ADD</span> &nbsp;<span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>FK_Clients_Operators_ModifiedBy<span class="br0">&#93;</span> <span class="kw1">FOREIGN</span> <span class="kw1">KEY</span><span class="br0">&#40;</span><span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span><span class="br0">&#41;</span>
<span class="kw1">REFERENCES</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Operators<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>op_code<span class="br0">&#93;</span><span class="br0">&#41;</span>
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">CHECK</span> <span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>FK_Clients_Operators_ModifiedBy<span class="br0">&#93;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE [dbo].[Clients](
	[ClientID] [int] IDENTITY(1,1) NOT NULL,
	[client_no] [smallint] NOT NULL,
	[client_name] [varchar](30) NULL,
	[Contact1] [varchar](100) NULL,
	[C1_Email] [varchar](100) NULL,
	[Contact2] [varchar](100) NULL,
	[C2_Email] [varchar](100) NULL,
	[C1_Phone] [varchar](10) NULL,
	[C1_Ext] [varchar](5) NULL,
	[C2_Phone] [varchar](10) NULL,
	[C2_Ext] [varchar](5) NULL,
	[Address] [varchar](max) NULL,
	[EnteredBy] [char](6) NOT NULL,
	[EnteredOn] [smalldatetime] NULL,
	[ModifiedBy] [char](6) NULL,
	[ModifiedOn] [smalldatetime] NULL,
 CONSTRAINT [PK_Clients_ClientID] PRIMARY KEY CLUSTERED 
(
	[ClientID] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO
SET ANSI_PADDING OFF
GO
CREATE NONCLUSTERED INDEX [idxClients_Client_No] ON [dbo].[Clients] 
(
	[client_no] ASC
)WITH (PAD_INDEX  = OFF, STATISTICS_NORECOMPUTE  = OFF, SORT_IN_TEMPDB = OFF, IGNORE_DUP_KEY = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS  = ON, ALLOW_PAGE_LOCKS  = ON) ON [PRIMARY]

/****** Object:  Default [DF_Clients_EnteredBy]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients] ADD  CONSTRAINT [DF_Clients_EnteredBy]  DEFAULT ('ADMIN') FOR [EnteredBy]
GO
/****** Object:  Default [DF_Clients_EnteredOn]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients] ADD  CONSTRAINT [DF_Clients_EnteredOn]  DEFAULT (getdate()) FOR [EnteredOn]
GO
/****** Object:  Check [CK_Clients_C1_Phone]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients]  WITH CHECK ADD  CONSTRAINT [CK_Clients_C1_Phone] CHECK  (([C1_Phone] like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'))
GO
ALTER TABLE [dbo].[Clients] CHECK CONSTRAINT [CK_Clients_C1_Phone]
GO
/****** Object:  Check [CK_Clients_C2_Phone]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients]  WITH CHECK ADD  CONSTRAINT [CK_Clients_C2_Phone] CHECK  (([C2_Phone] like '[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]'))
GO
ALTER TABLE [dbo].[Clients] CHECK CONSTRAINT [CK_Clients_C2_Phone]
GO
/****** Object:  ForeignKey [FK_Clients_Operators_EnteredBy]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients]  WITH CHECK ADD  CONSTRAINT [FK_Clients_Operators_EnteredBy] FOREIGN KEY([EnteredBy])
REFERENCES [dbo].[Operators] ([op_code])
GO
ALTER TABLE [dbo].[Clients] CHECK CONSTRAINT [FK_Clients_Operators_EnteredBy]
GO
/****** Object:  ForeignKey [FK_Clients_Operators_ModifiedBy]    Script Date: 12/19/2012 07:00:35 ******/
ALTER TABLE [dbo].[Clients]  WITH CHECK ADD  CONSTRAINT [FK_Clients_Operators_ModifiedBy] FOREIGN KEY([ModifiedBy])
REFERENCES [dbo].[Operators] ([op_code])
GO
ALTER TABLE [dbo].[Clients] CHECK CONSTRAINT [FK_Clients_Operators_ModifiedBy]
GO</pre></div></div>

<p>Last 2 constraints in the above script refer to the Operators table I am not showing here.</p>
<p>Let&#8217;s add some data to insert:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1">GO
<span class="kw1">SET</span> <span class="kw1">IDENTITY_INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="kw1">ON</span>
&nbsp;
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">3</span>, <span class="nu0">8096</span>, N<span class="st0">'Wachusett'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">4</span>, <span class="nu0">6700</span>, N<span class="st0">'Buck Hill'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">5</span>, <span class="nu0">6238</span>, N<span class="st0">'Jamz'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">7</span>, <span class="nu0">8363</span>, N<span class="st0">'Okemo'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">8</span>, <span class="nu0">1161</span>, N<span class="st0">'Shawnee Mountain'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">9</span>, <span class="nu0">7497</span>, N<span class="st0">'Southern Star Obs Wheel'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">10</span>, <span class="nu0">1636</span>, N<span class="st0">'Mount Rose'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span>
<span class="kw1">INSERT</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Clients<span class="br0">&#93;</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>ClientID<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_no<span class="br0">&#93;</span>, <span class="br0">&#91;</span>client_name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact1<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Contact2<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Email<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C1_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Phone<span class="br0">&#93;</span>, <span class="br0">&#91;</span>C2_Ext<span class="br0">&#93;</span>, <span class="br0">&#91;</span>Address<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>EnteredOn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedBy<span class="br0">&#93;</span>, <span class="br0">&#91;</span>ModifiedOn<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="kw1">VALUES</span> <span class="br0">&#40;</span><span class="nu0">11</span>, <span class="nu0">3951</span>, N<span class="st0">'Crystal Mtn Washington'</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, N<span class="st0">'ADMIN '</span>, <span class="kw1">CAST</span><span class="br0">&#40;</span>0x9F9002DD <span class="kw1">AS</span> <span class="kw1">SmallDateTime</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GO
SET IDENTITY_INSERT [dbo].[Clients] ON

INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (3, 8096, N'Wachusett', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (4, 6700, N'Buck Hill', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (5, 6238, N'Jamz', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (7, 8363, N'Okemo', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (8, 1161, N'Shawnee Mountain', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (9, 7497, N'Southern Star Obs Wheel', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (10, 1636, N'Mount Rose', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)
INSERT [dbo].[Clients] ([ClientID], [client_no], [client_name], [Contact1], [C1_Email], [Contact2], [C2_Email], [C1_Phone], [C1_Ext], [C2_Phone], [C2_Ext], [Address], [EnteredBy], [EnteredOn], [ModifiedBy], [ModifiedOn]) VALUES (11, 3951, N'Crystal Mtn Washington', NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL, N'ADMIN ', CAST(0x9F9002DD AS SmallDateTime), NULL, NULL)</pre></div></div>

<p>It took me many iterations and consultations with various blogs about Entity Framework to come up with the following model:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre></td><td class="de1"><pre class="de1"><span class="kw1">using</span> <span class="co3">System</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">using</span> <span class="co3">System.ComponentModel.DataAnnotations</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.ComponentModel</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">using</span> <span class="co3">DataAnnotationsExtensions</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.ComponentModel.DataAnnotations.Schema</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Collections.Generic</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">namespace</span> CardNumbers<span class="sy0">.</span><span class="me1">Objects</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>ComplexType<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> PhoneInfo
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DataType<span class="br0">&#40;</span>DataType<span class="sy0">.</span><span class="me1">PhoneNumber</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Phone&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>RegularExpression<span class="br0">&#40;</span><span class="st_h">@&quot;^(((d{3})|d{3})s?)?d{3}[-s]?d{4}s*$&quot;</span>, ErrorMessage <span class="sy0">=</span> <span class="st0">&quot;Please enter valid Phone Number&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Phone <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>StringLength<span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Ext&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Ext <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">bool</span> HasValue
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">get</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="br0">&#40;</span>Phone <span class="sy0">!=</span> <span class="kw1">null</span> <span class="sy0">||</span> Ext <span class="sy0">!=</span> <span class="kw1">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>ComplexType<span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> ContactDetail
&nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//Constructor</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> ContactDetail<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; phoneInfo <span class="sy0">=</span> <span class="kw3">new</span> PhoneInfo<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>StringLength<span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Contact Name&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayFormat<span class="br0">&#40;</span>NullDisplayText <span class="sy0">=</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Contact <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Email<span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>StringLength<span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DataType<span class="br0">&#40;</span>DataType<span class="sy0">.</span><span class="me1">EmailAddress</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Email&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Email <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> PhoneInfo phoneInfo <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">bool</span> HasValue
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">get</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="br0">&#40;</span>Contact <span class="sy0">!=</span> <span class="kw1">null</span> <span class="sy0">||</span> Email <span class="sy0">!=</span> <span class="kw1">null</span> <span class="sy0">||</span> phoneInfo<span class="sy0">.</span><span class="me1">HasValue</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
<span class="co1">/// &lt;summary&gt;</span>
<span class="co1">/// Client class (Client No, Client Name, Address, Contact1, Contact2 info, Created By, Modified By (operator and date)</span>
<span class="co1">/// &lt;/summary&gt;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> Client
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> Client<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Contact1 <span class="sy0">=</span> <span class="kw3">new</span> ContactDetail<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Contact2 <span class="sy0">=</span> <span class="kw3">new</span> ContactDetail<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Key<span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Editable<span class="br0">&#40;</span><span class="kw1">false</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Column<span class="br0">&#40;</span><span class="st0">&quot;ClientId&quot;</span>,TypeName <span class="sy0">=</span> <span class="st0">&quot;int&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">int</span> Id <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//[Required]</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Client No&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span> &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Column<span class="br0">&#40;</span><span class="st0">&quot;client_no&quot;</span>, TypeName <span class="sy0">=</span> <span class="st0">&quot;smallint&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> Int16 Number <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//[Required]</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Column<span class="br0">&#40;</span><span class="st0">&quot;client_name&quot;</span>, TypeName <span class="sy0">=</span> <span class="st0">&quot;varchar&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Client Name&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>MaxLength<span class="br0">&#40;</span><span class="nu0">30</span>, ErrorMessage <span class="sy0">=</span> <span class="st0">&quot;Client Name should not be longer than 30 characters&quot;</span> <span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>MinLength<span class="br0">&#40;</span><span class="nu0">3</span>, ErrorMessage <span class="sy0">=</span> <span class="st0">&quot;Client Name is too short&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Name <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DataType<span class="br0">&#40;</span>DataType<span class="sy0">.</span><span class="me1">MultilineText</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">string</span> Address <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> ContactDetail Contact1 <span class="br0">&#123;</span><span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span><span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> ContactDetail Contact2 <span class="br0">&#123;</span><span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span><span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>ForeignKey<span class="br0">&#40;</span><span class="st0">&quot;EnteredByOperator&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">string</span> EnteredBy <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>InverseProperty<span class="br0">&#40;</span><span class="st0">&quot;ClientsEnteredBy&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw1">Operator</span> EnteredByOperator <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>ForeignKey<span class="br0">&#40;</span><span class="st0">&quot;ModifiedByOperator&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">string</span> ModifiedBy <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>InverseProperty<span class="br0">&#40;</span><span class="st0">&quot;ClientsUpdatedBy&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw1">Operator</span> ModifiedByOperator <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DataType<span class="br0">&#40;</span>DataType<span class="sy0">.</span><span class="me1">DateTime</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Created on&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DateTime EnteredOn <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DataType<span class="br0">&#40;</span>DataType<span class="sy0">.</span><span class="me1">DateTime</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>DisplayName<span class="br0">&#40;</span><span class="st0">&quot;Modified on&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DateTime<span class="sy0">?</span> ModifiedOn <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> ICollection<span class="sy0">&lt;</span>ClientOrder<span class="sy0">&gt;</span> ClientOrders <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">virtual</span> ICollection<span class="sy0">&lt;</span>Reorder<span class="sy0">&gt;</span> Reorders <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">using System;

using System.ComponentModel.DataAnnotations;
using System.ComponentModel;

using DataAnnotationsExtensions;
using System.ComponentModel.DataAnnotations.Schema;
using System.Collections.Generic;

namespace CardNumbers.Objects
{
    [ComplexType]
    public class PhoneInfo
    {
        [DataType(DataType.PhoneNumber)]
        
        [DisplayName("Phone")]
        [RegularExpression(@"^(((d{3})|d{3})s?)?d{3}[-s]?d{4}s*$", ErrorMessage = "Please enter valid Phone Number")]
        public virtual string Phone { get; set; }

        [StringLength(5)]
        [DisplayName("Ext")]
        public virtual string Ext { get; set; }

        public bool HasValue
        {
            get
            {
                return (Phone != null || Ext != null);
            }
        }

    }

      [ComplexType]
      public class ContactDetail
      {
          //Constructor
          public ContactDetail()
          {
              phoneInfo = new PhoneInfo();
          }

          [StringLength(100)]
          [DisplayName("Contact Name")]
          [DisplayFormat(NullDisplayText = "")]
          public virtual string Contact { get; set; }

          [Email]
          [StringLength(100)]
          [DataType(DataType.EmailAddress)]
          [DisplayName("Email")]
          public virtual string Email { get; set; }

          public virtual PhoneInfo phoneInfo { get; set; }
          public bool HasValue
          {
              get
              {
                  return (Contact != null || Email != null || phoneInfo.HasValue);
              }
          }
      }

/// &lt;summary&gt;
/// Client class (Client No, Client Name, Address, Contact1, Contact2 info, Created By, Modified By (operator and date)
/// &lt;/summary&gt;
    public class Client
    {
        public Client()
        {
            Contact1 = new ContactDetail();
            Contact2 = new ContactDetail();
     }

        [Key]
        [Editable(false)]
        [Column("ClientId",TypeName = "int")]
        public virtual int Id { get; set; }
        
        //[Required]
        [DisplayName("Client No")]      
        [Column("client_no", TypeName = "smallint")]
        public virtual Int16 Number { get; set; }
        
        //[Required]
        [Column("client_name", TypeName = "varchar")]
        [DisplayName("Client Name")]
        [MaxLength(30, ErrorMessage = "Client Name should not be longer than 30 characters" )]
        [MinLength(3, ErrorMessage = "Client Name is too short")]

        public virtual string Name { get; set; }

        [DataType(DataType.MultilineText)]
        public virtual string Address { get; set; }

        public virtual ContactDetail Contact1 {get; set;}
        public virtual ContactDetail Contact2 {get; set;}

        [ForeignKey("EnteredByOperator")]
        public string EnteredBy { get; set; }

        [InverseProperty("ClientsEnteredBy")]
        public virtual Operator EnteredByOperator { get; set; }

        [ForeignKey("ModifiedByOperator")]
        public string ModifiedBy { get; set; }

        [InverseProperty("ClientsUpdatedBy")]
        public virtual Operator ModifiedByOperator { get; set; }

        [DataType(DataType.DateTime)]
        [DisplayName("Created on")]
        public DateTime EnteredOn { get; set; }

        [DataType(DataType.DateTime)]
        [DisplayName("Modified on")]
        public DateTime? ModifiedOn { get; set; }

        public virtual ICollection&lt;ClientOrder&gt; ClientOrders { get; set; }
        
        public virtual ICollection&lt;Reorder&gt; Reorders { get; set; }
    }
}</pre></div></div>

<p>The interesting thing in this model is 2 Complex Types. Originally this model didn&#8217;t have Complex Types, but I found later that I need them in order to create one Editor for each Contact information (as we see, the table is not properly normalized and contains 2 contacts columns). </p>
<p>I created all my models in one project called CardNumbers.Objects. I later was criticized for such project name, but I used the same naming convention that was used by our 3 days course teacher and therefore left it as is. In my next project I am going to be more thoughtful in regards to project names.</p>
<p>I also created another project called CardNumbers.Data where I placed repository objects. I also originally built them the same way we were taught by the instructor, but as I found later it was not the best way, so I re-designed based on some blog posts and StackOverflow questions this way:</p>
<p>IClientRepository.cs:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="de1"><pre class="de1"><span class="kw1">using</span> <span class="co3">CardNumbers.Objects</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Collections.Generic</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Linq</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">namespace</span> CardNumbers<span class="sy0">.</span><span class="me1">Data</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">interface</span> IClientRepository<span class="sy0">:</span>IDisposable
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; IQueryable<span class="sy0">&lt;</span>Client<span class="sy0">&gt;</span> Clients <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Client GetClientById<span class="br0">&#40;</span><span class="kw4">int</span> clientId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> Commit<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> AddClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> DeleteClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> DeleteClient<span class="br0">&#40;</span><span class="kw4">int</span> clientId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">void</span> UpdateClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">using CardNumbers.Objects;
using System;
using System.Collections.Generic;
using System.Linq;
 
namespace CardNumbers.Data
{
    public interface IClientRepository:IDisposable
    {
        IQueryable&lt;Client&gt; Clients { get; }
        Client GetClientById(int clientId);
        void Commit();

        void AddClient(Client client, bool autoCommit = true);

        void DeleteClient(Client client, bool autoCommit = true);
        
        void DeleteClient(int clientId);

        void UpdateClient(Client client, bool autoCommit = true);
    }
}</pre></div></div>

<p>and the actual implementation of the above interface:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="de1"><pre class="de1"><span class="kw1">using</span> <span class="co3">System</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Collections.Generic</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Data</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Data.Entity</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Linq</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">CardNumbers.Objects</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">namespace</span> CardNumbers<span class="sy0">.</span><span class="me1">Data</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> ClientRepository <span class="sy0">:</span> IClientRepository, IDisposable 
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> CardNumbersContext context<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> ClientRepository<span class="br0">&#40;</span>CardNumbersContext context<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span> <span class="sy0">=</span> context<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; IQueryable<span class="sy0">&lt;</span>Client<span class="sy0">&gt;</span> IClientRepository<span class="sy0">.</span><span class="me1">Clients</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">get</span> <span class="br0">&#123;</span> <span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> Commit<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">SaveChanges</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> AddClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client<span class="sy0">.</span><span class="me1">EnteredOn</span> <span class="sy0">=</span> DateTime<span class="sy0">.</span><span class="me1">Now</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span>client<span class="br0">&#41;</span> &nbsp; <span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>autoCommit<span class="br0">&#41;</span> <span class="kw1">this</span><span class="sy0">.</span><span class="me1">Commit</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> DeleteClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">.</span><span class="kw1">Remove</span><span class="br0">&#40;</span>client<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>autoCommit<span class="br0">&#41;</span> <span class="kw1">this</span><span class="sy0">.</span><span class="me1">Commit</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> DeleteClient<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">.</span><span class="kw1">Remove</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="sy0">.</span><span class="me1">GetClientById</span><span class="br0">&#40;</span>id<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">Commit</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> Client GetClientById<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">.</span><span class="me1">Find</span><span class="br0">&#40;</span>id<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> UpdateClient<span class="br0">&#40;</span>Client client, <span class="kw4">bool</span> autoCommit <span class="sy0">=</span> <span class="kw1">true</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; client<span class="sy0">.</span><span class="me1">ModifiedOn</span> <span class="sy0">=</span> DateTime<span class="sy0">.</span><span class="me1">Now</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">context</span><span class="sy0">.</span><span class="me1">Entry</span><span class="br0">&#40;</span>client<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">State</span> <span class="sy0">=</span> EntityState<span class="sy0">.</span><span class="me1">Modified</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>autoCommit<span class="br0">&#41;</span> <span class="kw1">this</span><span class="sy0">.</span><span class="me1">Commit</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">bool</span> disposed <span class="sy0">=</span> <span class="kw1">false</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">protected</span> <span class="kw1">virtual</span> <span class="kw4">void</span> Dispose<span class="br0">&#40;</span><span class="kw4">bool</span> disposing<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw1">this</span><span class="sy0">.</span><span class="me1">disposed</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>disposing<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; context<span class="sy0">.</span><span class="me1">Dispose</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">disposed</span> <span class="sy0">=</span> <span class="kw1">true</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> Dispose<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Dispose<span class="br0">&#40;</span><span class="kw1">true</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; GC<span class="sy0">.</span><span class="me1">SuppressFinalize</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">using System;
using System.Collections.Generic;
using System.Data;
using System.Data.Entity;
using System.Linq;
using CardNumbers.Objects;

namespace CardNumbers.Data
{
    public class ClientRepository : IClientRepository, IDisposable 
    {
        private CardNumbersContext context;

        public ClientRepository(CardNumbersContext context)
        {
            this.context = context;
        }        

        IQueryable&lt;Client&gt; IClientRepository.Clients
        {
            get { return this.context.Clients; }
        }
       
        public void Commit()
        {
            this.context.SaveChanges();
        }

        public void AddClient(Client client, bool autoCommit = true)
        {
            client.EnteredOn = DateTime.Now;
            this.context.Clients.Add(client)   ;
            if (autoCommit) this.Commit();
        }

        public void DeleteClient(Client client, bool autoCommit = true)
        {
            this.context.Clients.Remove(client);
            if (autoCommit) this.Commit();
        }

        public void DeleteClient(int id)
        {
            this.context.Clients.Remove(this.GetClientById(id));
            this.Commit();
        }

        public Client GetClientById(int id)
        {
            return this.context.Clients.Find(id);
        }

        public void UpdateClient(Client client, bool autoCommit = true)
        {
            client.ModifiedOn = DateTime.Now;
            this.context.Entry(client).State = EntityState.Modified;
            if (autoCommit) this.Commit();
        }

        private bool disposed = false;

        protected virtual void Dispose(bool disposing)
        {
            if (!this.disposed)
            {
                if (disposing)
                {
                    context.Dispose();
                }
            }
            this.disposed = true;
        }

        public void Dispose()
        {
            Dispose(true);
            GC.SuppressFinalize(this);
        }
        
    }
}</pre></div></div>

<p>and I show CardNumbersContext.cs for completion:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="de1"><pre class="de1"><span class="kw1">using</span> <span class="co3">System</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Collections.Generic</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Data.Entity</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">CardNumbers.Objects</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">System.Data.Entity.ModelConfiguration.Conventions</span><span class="sy0">;</span>
<span class="kw1">using</span> <span class="co3">CardNumbers.Objects.Mapping</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">namespace</span> CardNumbers<span class="sy0">.</span><span class="me1">Data</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> CardNumbersContext <span class="sy0">:</span> DbContext
&nbsp;
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DbSet<span class="sy0">&lt;</span>Client<span class="sy0">&gt;</span> Clients <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DbSet<span class="sy0">&lt;</span><span class="kw1">Operator</span><span class="sy0">&gt;</span> Operators <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DbSet<span class="sy0">&lt;</span>Reorder<span class="sy0">&gt;</span> Reorders <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> DbSet<span class="sy0">&lt;</span>ClientOrder<span class="sy0">&gt;</span> ClientOrders <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">protected</span> <span class="kw1">override</span> <span class="kw4">void</span> OnModelCreating<span class="br0">&#40;</span>DbModelBuilder modelBuilder<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">// base.OnModelCreating(modelBuilder);</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modelBuilder<span class="sy0">.</span><span class="me1">Configurations</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> ClientMap<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modelBuilder<span class="sy0">.</span><span class="me1">Configurations</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> OperatorMap<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modelBuilder<span class="sy0">.</span><span class="me1">Configurations</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> ClientOrdersMap<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; modelBuilder<span class="sy0">.</span><span class="me1">Configurations</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> ReorderMap<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">using System;
using System.Collections.Generic;
using System.Data.Entity;
using CardNumbers.Objects;
using System.Data.Entity.ModelConfiguration.Conventions;
using CardNumbers.Objects.Mapping;

namespace CardNumbers.Data
{
    public class CardNumbersContext : DbContext

    {
        public DbSet&lt;Client&gt; Clients { get; set; }
        public DbSet&lt;Operator&gt; Operators { get; set; }
        public DbSet&lt;Reorder&gt; Reorders { get; set; }
        public DbSet&lt;ClientOrder&gt; ClientOrders { get; set; }

        protected override void OnModelCreating(DbModelBuilder modelBuilder)
        {
           // base.OnModelCreating(modelBuilder);
            modelBuilder.Configurations.Add(new ClientMap());
            modelBuilder.Configurations.Add(new OperatorMap());
            modelBuilder.Configurations.Add(new ClientOrdersMap());            
            modelBuilder.Configurations.Add(new ReorderMap());
        }
    }
}</pre></div></div>

<p>So, the above two projects describe my models and means to work with them.</p>
<p>Now I am going to describe the CardNumbers.Web project. </p>
<p>I started from designing the view for working with the Clients. Here I didn&#8217;t want to go with the standard shown in all tutorials ways of displaying all clients information in a one page grid with inline Edit/Delete buttons. I didn&#8217;t like this interface much. So, I started my research as what existing grids I may try to implement. I looked up a few different grid implementations and at some point someone suggested me to look into <a href="http://flexigrid.info/">flexigrid</a> CodePlex project. I really liked its look and decided to go with it. Also, I believe that same person suggested me <a href="http://mvc4beginner.com/Sample-Code/Insert-Update-Delete/Asp-.Net-MVC-Ajax-Insert-Update-Delete-Using-Flexigrid.html">his site</a> which was enough to get me started. I got the Clients view working relatively quickly based on that information.</p>
<p>However, I didn&#8217;t want to start from displaying all Clients. I wanted to simulate my current VFP application where I started from the empty grid, typed some letters in the client name search textbox and based on that show only small subset of rows initially.</p>
<p>This took me a while to figure out. I was almost ready to give up, but finally found addFormData method (which was there all the time) and figured out how to use it for my purpose. It may seem silly to most of the experienced jquery developers, but for me it was my first mini-success.</p>
<p>So, I will show you how my Client View now looks and the relevant portions of Clients.js script file and the ClientController.cs file:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="de1"><pre class="de1">@model CardNumbers.Models.ClientViewModel
&nbsp;
@section scripts {
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">script</span> <span class="kw3">src</span><span class="sy0">=</span><span class="st0">&quot;@Url.Content(&quot;</span>~<span class="sy0">/</span>Scripts<span class="sy0">/</span>Clients.js<span class="st0">&quot;)&quot;</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;text/javascript&quot;</span> &gt;&lt;<span class="sy0">/</span><span class="kw2">script</span>&gt;</span>
}
&nbsp;
<span class="sc2">&lt;<span class="kw2">form</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;frmClientsSearch&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> <span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;clientNo&quot;</span>&gt;</span>Client No: <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;number&quot;</span> <span class="kw3">name</span><span class="sy0">=</span><span class="st0">&quot;searchClientNo&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;numericOnly&quot;</span> <span class="sy0">/</span>&gt;&lt;<span class="kw2">br</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> <span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;clientName&quot;</span>&gt;</span>Client Name: <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;search&quot;</span> <span class="kw3">size</span><span class="sy0">=</span><span class="st0">&quot;25&quot;</span> <span class="kw3">value</span><span class="sy0">=</span><span class="st0">&quot;Please enter the search value&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;SelectOnEntry&quot;</span></span>
<span class="sc2"> &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw3">name</span><span class="sy0">=</span><span class="st0">&quot;searchClientName&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;button&quot;</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;btnClientsSearch&quot;</span> <span class="kw3">value</span><span class="sy0">=</span><span class="st0">&quot;Find / Refresh&quot;</span> <span class="sy0">/</span>&gt;</span>
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">form</span>&gt;</span>
<span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">style</span><span class="sy0">=</span><span class="st0">&quot;padding-left: 150px; padding-top: 50px; padding-bottom: 50px;&quot;</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;ClientsResults&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">table</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;flexClients&quot;</span> <span class="kw3">style</span><span class="sy0">=</span><span class="st0">&quot;display: none&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">table</span>&gt;</span>
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp;
&nbsp;<span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;add-edit-dialog&quot;</span> <span class="kw3">style</span><span class="sy0">=</span><span class="st0">&quot;display: none&quot;</span> <span class="kw3">title</span><span class="sy0">=</span><span class="st0">&quot;Add / Edit Client&quot;</span>&gt;</span> 
&nbsp; &nbsp; @Html.Partial(&quot;_ClientForm&quot;, Model)
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">@model CardNumbers.Models.ClientViewModel

@section scripts {
    &lt;script src="@Url.Content("~/Scripts/Clients.js")" type="text/javascript" &gt;&lt;/script&gt;
}

&lt;form id="frmClientsSearch"&gt;
    &lt;label for="clientNo"&gt;Client No: &lt;/label&gt;
    &lt;input type="number" name="searchClientNo" class="numericOnly" /&gt;&lt;br /&gt;
    &lt;label for="clientName"&gt;Client Name: &lt;/label&gt;
    &lt;input type="search" size="25" value="Please enter the search value" class="SelectOnEntry"
        name="searchClientName" /&gt;

    &lt;input type="button" id="btnClientsSearch" value="Find / Refresh" /&gt;
&lt;/form&gt;
&lt;div style="padding-left: 150px; padding-top: 50px; padding-bottom: 50px;" id="ClientsResults"&gt;
    &lt;table id="flexClients" style="display: none"&gt;
    &lt;/table&gt;
&lt;/div&gt;

 &lt;div id="add-edit-dialog" style="display: none" title="Add / Edit Client"&gt; 
    @Html.Partial("_ClientForm", Model)
&lt;/div&gt;</pre></div></div>

<p>As you can see, this main view has just few controls and lines of code. At the top I display two search controls and at the bottom the flexigrid placeholder and the dialog (invisible initially) for my modal Add/Edit dialogs.</p>
<p>Now I want to show the Clients.js part that is responsible for the flexigrid and passing Search form data to the controller through form&#8217;s collection:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="javascript"><thead><tr><td colspan="2"  class="head">Javascript</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="de1"><pre class="de1">$<span class="br0">&#40;</span><span class="st0">&quot;#flexClients&quot;</span><span class="br0">&#41;</span>.<span class="me1">flexigrid</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
&nbsp; &nbsp; url<span class="sy0">:</span> <span class="st0">'/Client/Client/'</span><span class="sy0">,</span>
&nbsp; &nbsp; dataType<span class="sy0">:</span> <span class="st0">'json'</span><span class="sy0">,</span>
&nbsp; &nbsp; colModel<span class="sy0">:</span> <span class="br0">&#91;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> display<span class="sy0">:</span> <span class="st0">'Client Id'</span><span class="sy0">,</span> name<span class="sy0">:</span> <span class="st0">'Id'</span><span class="sy0">,</span> width<span class="sy0">:</span> <span class="nu0">100</span><span class="sy0">,</span> sortable<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> align<span class="sy0">:</span> <span class="st0">'center'</span><span class="sy0">,</span> hide<span class="sy0">:</span> <span class="kw2">true</span> <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> display<span class="sy0">:</span> <span class="st0">'Client #'</span><span class="sy0">,</span> name<span class="sy0">:</span> <span class="st0">'Number'</span><span class="sy0">,</span> width<span class="sy0">:</span> <span class="nu0">100</span><span class="sy0">,</span> sortable<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> align<span class="sy0">:</span> <span class="st0">'center'</span> <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> display<span class="sy0">:</span> <span class="st0">'Name'</span><span class="sy0">,</span> name<span class="sy0">:</span> <span class="st0">'Name'</span><span class="sy0">,</span> width<span class="sy0">:</span> <span class="nu0">350</span><span class="sy0">,</span> sortable<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> align<span class="sy0">:</span> <span class="st0">'center'</span> <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> display<span class="sy0">:</span> <span class="st0">'Contact 1'</span><span class="sy0">,</span> name<span class="sy0">:</span> <span class="st0">'Contact1'</span><span class="sy0">,</span> width<span class="sy0">:</span> <span class="nu0">350</span><span class="sy0">,</span> sortable<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span> align<span class="sy0">:</span> <span class="st0">'center'</span> <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#93;</span><span class="sy0">,</span>
&nbsp; &nbsp; buttons<span class="sy0">:</span> <span class="br0">&#91;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> name<span class="sy0">:</span> <span class="st0">'Add'</span><span class="sy0">,</span> bclass<span class="sy0">:</span> <span class="st0">'add'</span><span class="sy0">,</span> onpress<span class="sy0">:</span> add <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> name<span class="sy0">:</span> <span class="st0">'Edit'</span><span class="sy0">,</span> bclass<span class="sy0">:</span> <span class="st0">'edit'</span><span class="sy0">,</span> onpress<span class="sy0">:</span> edit <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> name<span class="sy0">:</span> <span class="st0">'Delete'</span><span class="sy0">,</span> bclass<span class="sy0">:</span> <span class="st0">'delete'</span><span class="sy0">,</span> onpress<span class="sy0">:</span> del <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> separator<span class="sy0">:</span> <span class="kw2">true</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#93;</span><span class="sy0">,</span>
&nbsp; &nbsp; searchitems<span class="sy0">:</span> <span class="br0">&#91;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> display<span class="sy0">:</span> <span class="st0">'Client Name'</span><span class="sy0">,</span> name<span class="sy0">:</span> <span class="st0">'Name'</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#93;</span><span class="sy0">,</span>
&nbsp; &nbsp; sortname<span class="sy0">:</span> <span class="st0">&quot;Name&quot;</span><span class="sy0">,</span>
&nbsp; &nbsp; sortorder<span class="sy0">:</span> <span class="st0">&quot;asc&quot;</span><span class="sy0">,</span>
&nbsp; &nbsp; usepager<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span>
&nbsp; &nbsp; title<span class="sy0">:</span> <span class="st0">'Clients'</span><span class="sy0">,</span>
&nbsp; &nbsp; useRp<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span>
&nbsp; &nbsp; rp<span class="sy0">:</span> <span class="nu0">15</span><span class="sy0">,</span>
&nbsp; &nbsp; rpOptions<span class="sy0">:</span> <span class="br0">&#91;</span><span class="nu0">5</span><span class="sy0">,</span> <span class="nu0">10</span><span class="sy0">,</span> <span class="nu0">15</span><span class="sy0">,</span> <span class="nu0">20</span><span class="sy0">,</span> <span class="nu0">25</span><span class="sy0">,</span> <span class="nu0">40</span><span class="br0">&#93;</span><span class="sy0">,</span>
&nbsp; &nbsp; showTableToggleBtn<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span>
&nbsp; &nbsp; width<span class="sy0">:</span> <span class="nu0">900</span><span class="sy0">,</span>
&nbsp; &nbsp; onSuccess<span class="sy0">:</span> bindDblClick<span class="sy0">,</span>
&nbsp; &nbsp; onSubmit<span class="sy0">:</span> addFormData<span class="sy0">,</span>
&nbsp; &nbsp; hideOnSubmit<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span>
&nbsp; &nbsp; height<span class="sy0">:</span> <span class="st0">'auto'</span><span class="sy0">,</span>
&nbsp; &nbsp; singleSelect<span class="sy0">:</span> <span class="kw2">true</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">//$('.flexigrid').on('dblclick', 'tr[id*=&quot;row&quot;]', function () {</span>
<span class="co1">// &nbsp; &nbsp;// console.log('mouseenter rowId: ' + $(this).attr('id').substr(3));</span>
<span class="co1">// &nbsp; &nbsp;alert($(this).attr('id').substr(3));</span>
<span class="co1">// &nbsp; &nbsp;//Edit();</span>
<span class="co1">//});</span>
&nbsp;
<span class="kw1">function</span> bindDblClick<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'#flexClients tr'</span><span class="br0">&#41;</span>.<span class="me1">dblclick</span><span class="br0">&#40;</span><span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;edit<span class="br0">&#40;</span><span class="st0">'Edit'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="co1">//This function adds parameters to the post of flexigrid. You can add a verification as well by return to false if you don't want flexigrid to submit &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span>
<span class="kw1">function</span> addFormData<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">//passing a form object to serializeArray will get the valid data from all the objects, but, if the you pass a non-form object, you have to specify the input elements that the data will come from</span>
&nbsp; &nbsp; <span class="kw1">var</span> dt <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="st0">&quot;#add-edit-form&quot;</span><span class="br0">&#41;</span>.<span class="me1">serializeArray</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; dt <span class="sy0">=</span> dt.<span class="me1">concat</span><span class="br0">&#40;</span>$<span class="br0">&#40;</span><span class="st0">'#frmClientsSearch'</span><span class="br0">&#41;</span>.<span class="me1">serializeArray</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; 
&nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">&quot;#flexClients&quot;</span><span class="br0">&#41;</span>.<span class="me1">flexOptions</span><span class="br0">&#40;</span><span class="br0">&#123;</span> params<span class="sy0">:</span> dt <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw2">true</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">$("#flexClients").flexigrid({
    url: '/Client/Client/',
    dataType: 'json',
    colModel: [
    { display: 'Client Id', name: 'Id', width: 100, sortable: true, align: 'center', hide: true },
    { display: 'Client #', name: 'Number', width: 100, sortable: true, align: 'center' },
    { display: 'Name', name: 'Name', width: 350, sortable: true, align: 'center' },
    { display: 'Contact 1', name: 'Contact1', width: 350, sortable: true, align: 'center' },
    ],
    buttons: [
    { name: 'Add', bclass: 'add', onpress: add },
    { name: 'Edit', bclass: 'edit', onpress: edit },
    { name: 'Delete', bclass: 'delete', onpress: del },
    { separator: true }
    ],
    searchitems: [
    { display: 'Client Name', name: 'Name' }
    ],
    sortname: "Name",
    sortorder: "asc",
    usepager: true,
    title: 'Clients',
    useRp: true,
    rp: 15,
    rpOptions: [5, 10, 15, 20, 25, 40],
    showTableToggleBtn: true,
    width: 900,
    onSuccess: bindDblClick,
    onSubmit: addFormData,
    hideOnSubmit: false,
    height: 'auto',
    singleSelect: true
});

//$('.flexigrid').on('dblclick', 'tr[id*="row"]', function () {
//    // console.log('mouseenter rowId: ' + $(this).attr('id').substr(3));
//    alert($(this).attr('id').substr(3));
//    //Edit();
//});

function bindDblClick()
{
    $('#flexClients tr').dblclick(function () {          
       edit('Edit');
    });
}

//This function adds parameters to the post of flexigrid. You can add a verification as well by return to false if you don't want flexigrid to submit			
function addFormData() {

    //passing a form object to serializeArray will get the valid data from all the objects, but, if the you pass a non-form object, you have to specify the input elements that the data will come from
    var dt = $("#add-edit-form").serializeArray();
    dt = dt.concat($('#frmClientsSearch').serializeArray());
  
    $("#flexClients").flexOptions({ params: dt });
    return true;
}</pre></div></div>

<p>So, the first part defines flexigrid (you can see that it used Client controller Client method to return its data). Then the next piece of code binds grid&#8217;s double click with the same method that is called by the Edit button (in other words, I want to either click on the Edit button or double click on the selected row in a grid to get the same behavior) and the last piece of code (addFormData) is used to pass both Search form and add-edit-form data back to my controller. </p>
<p>And this is how Client method of the controller looks like (I separated this method into 2 based on the idea I took from looking at the <a href="http://www.s4sme.com/Blog/Post/aspnet-mvc-4-application-with-flexigrid-jquery-ui-and-jquery-validation">following solution</a>)</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
</pre></td><td class="de1"><pre class="de1">&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>HttpPost<span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> ActionResult Client<span class="br0">&#40;</span>FormCollection formValues<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Assume we want to select everything</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> clients <span class="sy0">=</span> Db<span class="sy0">.</span><span class="me1">Clients</span><span class="sy0">;</span> <span class="co1">// Should set type of clients to IQueryable&lt;Clients&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> searchClientNo <span class="sy0">=</span> <span class="nu0">0</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span><span class="sy0">.</span><span class="me1">TryParse</span><span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;searchClientNo&quot;</span><span class="br0">&#93;</span>, <span class="kw1">out</span> searchClientNo <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> searchClientName <span class="sy0">=</span> <span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;searchClientName&quot;</span><span class="br0">&#93;</span><span class="sy0">??</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>searchClientNo <span class="sy0">==</span> <span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> searchClientName <span class="sy0">==</span> <span class="st0">&quot;Please enter the search value&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="kw1">Where</span><span class="br0">&#40;</span>c <span class="sy0">=&gt;</span> <span class="br0">&#40;</span>c<span class="sy0">.</span><span class="me1">Number</span> <span class="sy0">==</span> searchClientNo<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>searchClientNo <span class="sy0">!=</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="co1">//Number was supplied</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="kw1">Where</span><span class="br0">&#40;</span>c <span class="sy0">=&gt;</span> <span class="br0">&#40;</span>c<span class="sy0">.</span><span class="me1">Number</span> <span class="sy0">==</span> searchClientNo<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// If clientNo was supplied, clients is now filtered by that. If not, it still has the full list. The following will further filter it.</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">String</span><span class="sy0">.</span><span class="me1">IsNullOrWhiteSpace</span><span class="br0">&#40;</span>searchClientName<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="co1">// Part of the name was supplied</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="kw1">Where</span><span class="br0">&#40;</span>c <span class="sy0">=&gt;</span> <span class="br0">&#40;</span>c<span class="sy0">.</span><span class="me1">Name</span><span class="sy0">.</span><span class="me1">Contains</span><span class="br0">&#40;</span>searchClientName<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> page <span class="sy0">=</span> <span class="kw4">int</span><span class="sy0">.</span><span class="me1">Parse</span><span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;page&quot;</span><span class="br0">&#93;</span> <span class="sy0">??</span> <span class="st0">&quot;1&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> rp <span class="sy0">=</span> <span class="kw4">int</span><span class="sy0">.</span><span class="me1">Parse</span><span class="br0">&#40;</span><span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;rp&quot;</span><span class="br0">&#93;</span><span class="sy0">??</span><span class="st0">&quot;15&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> qtype <span class="sy0">=</span> <span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;qtype&quot;</span><span class="br0">&#93;</span><span class="sy0">??</span><span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> query <span class="sy0">=</span> <span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;query&quot;</span><span class="br0">&#93;</span> <span class="sy0">??</span> <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> sortname <span class="sy0">=</span> <span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;sortname&quot;</span><span class="br0">&#93;</span> <span class="sy0">??</span> <span class="st0">&quot;Name&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> sortorder <span class="sy0">=</span> <span class="br0">&#40;</span>formValues<span class="br0">&#91;</span><span class="st0">&quot;sortorder&quot;</span><span class="br0">&#93;</span> <span class="sy0">??</span> <span class="st0">&quot;asc&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>sortname<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>sortorder<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="me1">OrderBy</span><span class="br0">&#40;</span>sortname, <span class="br0">&#40;</span>sortorder <span class="sy0">==</span> <span class="st0">&quot;asc&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>qtype<span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> <span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>query<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="me1">Like</span><span class="br0">&#40;</span>qtype, query<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">int</span> Total <span class="sy0">=</span> clients<span class="sy0">.</span><span class="me1">Count</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clients <span class="sy0">=</span> clients<span class="sy0">.</span><span class="me1">Skip</span><span class="br0">&#40;</span><span class="br0">&#40;</span>page <span class="sy0">-</span> <span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">*</span> rp<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">Take</span><span class="br0">&#40;</span>rp<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> CreateFlexiJson<span class="br0">&#40;</span>clients, page, Total<span class="br0">&#41;</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">private</span> JsonResult CreateFlexiJson<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>Client<span class="sy0">&gt;</span> items, <span class="kw4">int</span> page, <span class="kw4">int</span> total<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> Json<span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; page,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; total,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; rows <span class="sy0">=</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; items
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Select</span><span class="br0">&#40;</span>x <span class="sy0">=&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id <span class="sy0">=</span> x<span class="sy0">.</span><span class="me1">Id</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// either use GetPropertyList(x) method to get all columns </span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cell <span class="sy0">=</span> <span class="kw3">new</span> <span class="br0">&#123;</span> Id <span class="sy0">=</span> x<span class="sy0">.</span><span class="me1">Id</span>, Number <span class="sy0">=</span> x<span class="sy0">.</span><span class="me1">Number</span>, Name <span class="sy0">=</span> x<span class="sy0">.</span><span class="me1">Name</span>, Contact1 <span class="sy0">=</span> x<span class="sy0">.</span><span class="me1">Contact1</span><span class="sy0">.</span><span class="me1">Contact</span> <span class="sy0">??</span> <span class="kw4">String</span><span class="sy0">.</span><span class="me1">Empty</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>, JsonRequestBehavior<span class="sy0">.</span><span class="me1">AllowGet</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">        [HttpPost]
        public ActionResult Client(FormCollection formValues)
        {
            // Assume we want to select everything
            var clients = Db.Clients; // Should set type of clients to IQueryable&lt;Clients&gt;
            int searchClientNo = 0;
            
            int.TryParse(formValues["searchClientNo"], out searchClientNo );
            string searchClientName = (formValues["searchClientName"]??"").ToString();

            if (searchClientNo == 0 &amp;&amp; searchClientName == "Please enter the search value")
                clients = clients.Where(c =&gt; (c.Number == searchClientNo));
            else
            {
                if (searchClientNo != 0) //Number was supplied
                    clients = clients.Where(c =&gt; (c.Number == searchClientNo));

                // If clientNo was supplied, clients is now filtered by that. If not, it still has the full list. The following will further filter it.
                if (!String.IsNullOrWhiteSpace(searchClientName)) // Part of the name was supplied
                    clients = clients.Where(c =&gt; (c.Name.Contains(searchClientName)));

            }
            int page = int.Parse(formValues["page"] ?? "1");

            int rp = int.Parse((formValues["rp"]??"15"));
            string qtype = (formValues["qtype"]??"").ToString();

            string query = (formValues["query"] ?? "").ToString();

            string sortname = (formValues["sortname"] ?? "Name").ToString();
            string sortorder = (formValues["sortorder"] ?? "asc").ToString();           

            if (!string.IsNullOrEmpty(sortname) &amp;&amp; !string.IsNullOrEmpty(sortorder))
            {
                clients = clients.OrderBy(sortname, (sortorder == "asc"));
            }

            if (!string.IsNullOrEmpty(qtype) &amp;&amp; !string.IsNullOrEmpty(query))
            {
                clients = clients.Like(qtype, query);
            }

            int Total = clients.Count();

            clients = clients.Skip((page - 1) * rp).Take(rp);
            return CreateFlexiJson(clients, page, Total);           

        }

        private JsonResult CreateFlexiJson(IEnumerable&lt;Client&gt; items, int page, int total)
        {
            return Json(
                    new
                    {
                        page,
                        total,
                        rows =
                            items
                            .Select(x =&gt;
                                new
                                {
                                    id = x.Id,
                                    // either use GetPropertyList(x) method to get all columns 
                                    cell = new { Id = x.Id, Number = x.Number, Name = x.Name, Contact1 = x.Contact1.Contact ?? String.Empty }
                                })
                    }, JsonRequestBehavior.AllowGet);
        }</pre></div></div>

<p>So far so good. Now I want to describe the modal dialogs implementation for Add and Edit buttons. This really took me a very long time to get working correctly and I was lucky to finally got this resolved with Jazzen Chen help.</p>
<p>First I want to show the partial view _ClientForm. There is nothing too interesting in that view besides using special EditorForm I implemented based on <a href="http://dotnetspeak.com/index.php/2012/10/asp-net-mvc-template-and-knockout-js/">this blog post</a> by Sergey Barskiy:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="de1"><pre class="de1">@using CardNumbers.Helper
@model CardNumbers.Models.ClientViewModel
&nbsp; <span class="sc2">&lt;<span class="kw2">form</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;add-edit-form&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">fieldset</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">legend</span>&gt;</span>Client Info<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">legend</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; @Html.ValidationSummary(true)
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;hidden&quot;</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;fntype&quot;</span> <span class="kw3">name</span><span class="sy0">=</span><span class="st0">&quot;fntype&quot;</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; @Html.HiddenFor(m =&gt; m.ClientId)
&nbsp; &nbsp; &nbsp; &nbsp; @Html.EditorFor(m =&gt; m.ClientNumber, EditorTemplate.TextBox)
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; @Html.EditorFor(m =&gt; m.ClientName, EditorTemplate.TextBox)
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; @Html.EditorFor(m =&gt; m.Client.Address, EditorTemplate.EditBox)
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;ContactsInfo&quot;</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;Contact1&quot;</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Html.EditorFor(m =&gt; m.Client.Contact1)
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;Contact2&quot;</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Html.EditorFor(m =&gt; m.Client.Contact2)
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;@* <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;SaveCancel&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;float-right&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">button</span> <span class="kw3">id</span><span class="sy0">=</span><span class="st0">&quot;btnSave&quot;</span>&gt;</span>Save<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">button</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">button</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;reset&quot;</span> <span class="kw3">id</span> <span class="sy0">=</span><span class="st0">&quot;btnCancel&quot;</span> <span class="kw3">name</span><span class="sy0">=</span><span class="st0">&quot;Reset&quot;</span>&gt;</span>Cancel<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">button</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>*@
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">fieldset</span>&gt;</span>
&nbsp;
&nbsp;<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">form</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">@using CardNumbers.Helper
@model CardNumbers.Models.ClientViewModel
  &lt;form id="add-edit-form"&gt;
    &lt;fieldset&gt;
        &lt;legend&gt;Client Info&lt;/legend&gt;

        @Html.ValidationSummary(true)
       
        &lt;input type="hidden" id="fntype" name="fntype"&gt;

        @Html.HiddenFor(m =&gt; m.ClientId)
        @Html.EditorFor(m =&gt; m.ClientNumber, EditorTemplate.TextBox)

        @Html.EditorFor(m =&gt; m.ClientName, EditorTemplate.TextBox)

        @Html.EditorFor(m =&gt; m.Client.Address, EditorTemplate.EditBox)

        &lt;div id="ContactsInfo"&gt;

            &lt;div id="Contact1"&gt;

                @Html.EditorFor(m =&gt; m.Client.Contact1)

            &lt;/div&gt;

            &lt;div id="Contact2"&gt;

                @Html.EditorFor(m =&gt; m.Client.Contact2)
            &lt;/div&gt;
        &lt;/div&gt;

       @* &lt;div id="SaveCancel" class="float-right"&gt;
            &lt;button id="btnSave"&gt;Save&lt;/button&gt;
            &lt;button type="reset" id ="btnCancel" name="Reset"&gt;Cancel&lt;/button&gt;
        &lt;/div&gt;*@
    &lt;/fieldset&gt;

 &lt;/form&gt;</pre></div></div>

<p>This is the Clients.js relevant code which drives that Add, Edit and Delete (for completeness) buttons:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="javascript"><thead><tr><td colspan="2"  class="head">Javascript</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
</pre></td><td class="de1"><pre class="de1"><span class="kw1">function</span> del<span class="br0">&#40;</span>com<span class="sy0">,</span> grid<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">try</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> clientName <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="st0">'.trSelected td:eq(2)'</span><span class="br0">&#41;</span>.<span class="me1">text</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>clientName<span class="br0">&#41;</span> <span class="co1">//Variable is defined and not empty</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>confirm<span class="br0">&#40;</span><span class="st0">&quot;Are you sure you want to delete &quot;</span> <span class="sy0">+</span> $.<span class="me1">trim</span><span class="br0">&#40;</span>clientName<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">&quot;?&quot;</span><span class="br0">&#41;</span><span class="sy0">===</span><span class="kw2">false</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'.trSelected'</span><span class="sy0">,</span> grid<span class="br0">&#41;</span>.<span class="me1">each</span><span class="br0">&#40;</span><span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> id <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>.<span class="me1">attr</span><span class="br0">&#40;</span><span class="st0">'id'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id <span class="sy0">=</span> id.<span class="me1">substring</span><span class="br0">&#40;</span>id.<span class="me1">lastIndexOf</span><span class="br0">&#40;</span><span class="st0">'row'</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">3</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addFormData<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> $<span class="br0">&#40;</span><span class="st0">'#flexClients'</span><span class="br0">&#41;</span>.<span class="me1">flexOptions</span><span class="br0">&#40;</span><span class="br0">&#123;</span> url<span class="sy0">:</span> <span class="st0">'/Client/Delete/'</span><span class="sy0">+</span> id <span class="br0">&#125;</span><span class="br0">&#41;</span>.<span class="me1">flexReload</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="kw1">catch</span><span class="br0">&#40;</span>e<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; alert<span class="br0">&#40;</span><span class="st0">'Error '</span> <span class="sy0">+</span> e<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">var</span> validator <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="st0">&quot;#add-edit-form&quot;</span><span class="br0">&#41;</span>.<span class="me1">validate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">var</span> $dlg <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="st0">&quot;#add-edit-dialog&quot;</span><span class="br0">&#41;</span>.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
&nbsp; &nbsp; autoOpen<span class="sy0">:</span> <span class="kw2">false</span><span class="sy0">,</span>
&nbsp; &nbsp; show<span class="sy0">:</span> <span class="st0">&quot;blind&quot;</span><span class="sy0">,</span>
&nbsp; &nbsp; closeOnEscape<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span>
&nbsp; &nbsp; resizable<span class="sy0">:</span> <span class="kw2">true</span><span class="sy0">,</span>
&nbsp; &nbsp; width<span class="sy0">:</span> <span class="nu0">1200</span><span class="sy0">,</span>
&nbsp; &nbsp; height<span class="sy0">:</span> <span class="nu0">750</span><span class="sy0">,</span>
&nbsp; &nbsp; minHeight<span class="sy0">:</span> <span class="nu0">600</span><span class="sy0">,</span>
&nbsp; &nbsp; minWidth<span class="sy0">:</span> <span class="nu0">950</span><span class="sy0">,</span>
&nbsp; &nbsp; buttons<span class="sy0">:</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">&quot;Save&quot;</span><span class="sy0">:</span> <span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>$<span class="br0">&#40;</span><span class="st0">&quot;#add-edit-form&quot;</span><span class="br0">&#41;</span>.<span class="me1">valid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// jobPost.setVals(txtId.val(), txtRole.val(), txtLocation.val(), txtJobType.val(), txtDescription.val()); &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $.<span class="me1">ajax</span><span class="br0">&#40;</span><span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; type<span class="sy0">:</span> <span class="st0">'POST'</span><span class="sy0">,</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//data: JSON.stringify(clientInformation),</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; url<span class="sy0">:</span> <span class="st0">'/Client/Save'</span><span class="sy0">,</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; dataType<span class="sy0">:</span> <span class="st0">'json'</span><span class="sy0">,</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; contentType<span class="sy0">:</span> <span class="st0">'application/json'</span><span class="sy0">,</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; success<span class="sy0">:</span> <span class="kw1">function</span> <span class="br0">&#40;</span>result<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// insert new list into grid</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'#flexClients'</span><span class="br0">&#41;</span>.<span class="me1">flexAddData</span><span class="br0">&#40;</span>result<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">'close'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">else</span> <span class="kw1">return</span> <span class="kw2">false</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; &nbsp; &nbsp; Cancel<span class="sy0">:</span> <span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">&quot;close&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; clearForm<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>validator<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; validator.<span class="me1">resetForm</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; close<span class="sy0">:</span> <span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> clearForm<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> <span class="br0">&#125;</span><span class="sy0">,</span>
&nbsp; &nbsp; open<span class="sy0">:</span> <span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$(&quot;#add-edit-dialog&quot;).parent().appendTo($(&quot;#add-edit-form&quot;));</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">function</span> RunModalDialog<span class="br0">&#40;</span>title<span class="sy0">,</span> url<span class="br0">&#41;</span>
<span class="br0">&#123;</span> &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>title<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; $dlg.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">&quot;option&quot;</span><span class="sy0">,</span> <span class="br0">&#123;</span><span class="st0">&quot;title&quot;</span><span class="sy0">:</span> title <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>url<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span> &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; $dlg.<span class="me1">load</span><span class="br0">&#40;</span>url<span class="br0">&#41;</span>.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">&quot;option&quot;</span><span class="sy0">,</span> <span class="br0">&#123;</span> <span class="st0">&quot;title&quot;</span><span class="sy0">:</span> title <span class="br0">&#125;</span><span class="br0">&#41;</span>.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">&quot;open&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//$dlg.load(url, function () {</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; &nbsp;var validator = $(&quot;#sform&quot;).validate();</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; &nbsp;if (validator)</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; &nbsp; &nbsp; &nbsp; validator.resetForm();</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp; &nbsp;$dlg.dialog(&quot;option&quot;, { &quot;title&quot;: title }).dialog(&quot;open&quot;);</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//});</span>
&nbsp; &nbsp; <span class="kw1">else</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; $dlg.<span class="me1">dialog</span><span class="br0">&#40;</span><span class="st0">&quot;open&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">function</span> add<span class="br0">&#40;</span>com<span class="sy0">,</span> grid<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'#fntype'</span><span class="br0">&#41;</span>.<span class="me1">val</span><span class="br0">&#40;</span><span class="st0">'Add'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> url <span class="sy0">=</span> <span class="st0">'/Client/Add/'</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="co1">//location.replace(url);</span>
&nbsp; &nbsp; RunModalDialog<span class="br0">&#40;</span><span class="st0">&quot;Create New Client&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp;<span class="co1">// clearForm(); &nbsp; &nbsp;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">function</span> edit<span class="br0">&#40;</span>com<span class="sy0">,</span> grid<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'.trSelected'</span><span class="sy0">,</span> grid<span class="br0">&#41;</span>.<span class="me1">each</span><span class="br0">&#40;</span><span class="kw1">function</span> <span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> id <span class="sy0">=</span> $<span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span>.<span class="me1">attr</span><span class="br0">&#40;</span><span class="st0">'id'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id <span class="sy0">=</span> id.<span class="me1">substring</span><span class="br0">&#40;</span>id.<span class="me1">lastIndexOf</span><span class="br0">&#40;</span><span class="st0">'row'</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">3</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; currentId <span class="sy0">=</span> id<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span><span class="st0">'#fntype'</span><span class="br0">&#41;</span>.<span class="me1">val</span><span class="br0">&#40;</span><span class="st0">'Edit'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> ClientName<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ClientName <span class="sy0">=</span>$<span class="br0">&#40;</span><span class="st0">'.trSelected td:eq(2)'</span><span class="br0">&#41;</span>.<span class="me1">text</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> url <span class="sy0">=</span> <span class="st0">'/Client/Edit/'</span> <span class="sy0">+</span> id <span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $.<span class="kw1">get</span><span class="br0">&#40;</span>url<span class="sy0">,</span> <span class="kw1">function</span> <span class="br0">&#40;</span>html<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// &nbsp;setFormControls(data.Id, data.Role, data.Location, data.JobType, data.Description);</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// alert(data);</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span>$dlg<span class="br0">&#41;</span>.<span class="me1">html</span><span class="br0">&#40;</span>html<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">//location.replace(url);</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;RunModalDialog<span class="br0">&#40;</span><span class="st0">&quot;Edit Client: &quot;</span> <span class="sy0">+</span> ClientName<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">function del(com, grid) {
    try {
        var clientName = $('.trSelected td:eq(2)').text();
        if (clientName) //Variable is defined and not empty
        {
            if (confirm("Are you sure you want to delete " + $.trim(clientName) + "?")===false)
                return false;            

            $('.trSelected', grid).each(function () {
                var id = $(this).attr('id');
                id = id.substring(id.lastIndexOf('row') + 3);

                addFormData(); $('#flexClients').flexOptions({ url: '/Client/Delete/'+ id }).flexReload();
            });
        }
    }
    catch(e) {
        alert('Error ' + e);
    }
}

var validator = $("#add-edit-form").validate();

var $dlg = $("#add-edit-dialog").dialog({
    autoOpen: false,
    show: "blind",
    closeOnEscape: true,
    resizable: true,
    width: 1200,
    height: 750,
    minHeight: 600,
    minWidth: 950,
    buttons: {
        "Save": function () {

            if ($("#add-edit-form").valid()) {
                // jobPost.setVals(txtId.val(), txtRole.val(), txtLocation.val(), txtJobType.val(), txtDescription.val());                            

                $.ajax({
                    type: 'POST',
                    //data: JSON.stringify(clientInformation),
                    url: '/Client/Save',
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function (result) {
                        // insert new list into grid
                        $('#flexClients').flexAddData(result);
                    }
                });
                $(this).dialog('close');
            } else return false;

        },
        Cancel: function () {
            $(this).dialog("close");
            clearForm();
            if (validator)
                validator.resetForm();
        }
    },
    close: function () { clearForm(); },
    open: function () {
        //$("#add-edit-dialog").parent().appendTo($("#add-edit-form"));
    }
});

function RunModalDialog(title, url)
{    
    if (title)
        $dlg.dialog("option", {"title": title });

    if (url)
    {        
        $dlg.load(url).dialog("option", { "title": title }).dialog("open");
    }
        //$dlg.load(url, function () {
        //    var validator = $("#sform").validate();
        //    if (validator)
        //         validator.resetForm();
        //    $dlg.dialog("option", { "title": title }).dialog("open");
        //});
    else {
        
        $dlg.dialog("open");
    }
}

function add(com, grid) {
    $('#fntype').val('Add');
    var url = '/Client/Add/';
    //location.replace(url);
    RunModalDialog("Create New Client");
   // clearForm();    
}
 
function edit(com, grid)
{
        $('.trSelected', grid).each(function () {
          
                var id = $(this).attr('id');
                id = id.substring(id.lastIndexOf('row') + 3);
                currentId = id;
                $('#fntype').val('Edit');
                var ClientName;
                ClientName =$('.trSelected td:eq(2)').text();
                var url = '/Client/Edit/' + id ;

                $.get(url, function (html) {
                    //  setFormControls(data.Id, data.Role, data.Location, data.JobType, data.Description);
                    // alert(data);
                    $($dlg).html(html);
                });
               //location.replace(url);
               RunModalDialog("Edit Client: " + ClientName);
        });

    }</pre></div></div>

<p>The most complicated part in the above script was to figure out how to make a server trip to get data for the Edit button and return that page back for editing.<br />
This is done with these two lines of code:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="javascript"><thead><tr><td colspan="2"  class="head">Javascript</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1">$.<span class="kw1">get</span><span class="br0">&#40;</span>url<span class="sy0">,</span> <span class="kw1">function</span> <span class="br0">&#40;</span>html<span class="br0">&#41;</span> <span class="br0">&#123;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $<span class="br0">&#40;</span>$dlg<span class="br0">&#41;</span>.<span class="me1">html</span><span class="br0">&#40;</span>html<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">$.get(url, function (html) {                   
                    $($dlg).html(html);
                });</pre></div></div>

<p>And to make the whole picture complete I&#8217;ll show the Edit method of my controller that returns the above data:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> ActionResult Edit<span class="br0">&#40;</span><span class="kw4">int</span> id<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ClientViewModel model <span class="sy0">=</span> <span class="kw3">new</span> ClientViewModel<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> client <span class="sy0">=</span> Db<span class="sy0">.</span><span class="me1">GetClientById</span><span class="br0">&#40;</span>id<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; model<span class="sy0">.</span><span class="me1">Client</span> <span class="sy0">=</span> client<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> PartialView<span class="br0">&#40;</span><span class="st0">&quot;_ClientForm&quot;</span>,model<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public ActionResult Edit(int id)
        {
            ClientViewModel model = new ClientViewModel(); 
            var client = Db.GetClientById(id);
            model.Client = client;
            
            return PartialView("_ClientForm",model);
        }</pre></div></div>

<p>As you can see, just a few lines of code to return the model data and the partial view.</p>
<p>This all may seem very easy now, but I can tell you it was not easy to figure all the pieces out.</p>
<p>I am not showing certain functionality here such as my view model or EditorFor custom editors. I also don&#8217;t show the RemoteValidator used to provide uniqueness of the client number and client name. If there will be an interest, I may discuss these details in the separate blog post.</p>
<p>Hope this blog post can help people struggling with the modal dialogs implementation in ASP.NET MVC application.</p>
<p>
*** <strong>Remember, if you have a Web application related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=6&amp;sid=ebc29b65310d77fa409af74cf8d5cd70">Web Developer</a> forum.</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/webdev/uidevelopment/ajax/asp-net-mvc-project-with/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		</item>
		<item>
		<title>Dealing with the &#8220;The text, ntext, or image pointer value conflicts with the column name specified.&#8221; error from Visual Foxpro</title>
		<link>/index.php/datamgmt/datadesign/dealing-with-the-the-text/</link>
		<comments>/index.php/datamgmt/datadesign/dealing-with-the-the-text/#comments</comments>
		<pubDate>Tue, 03 Apr 2012 22:58:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2012/04/dealing-with-the-the-text/</guid>
		<description><![CDATA[Recently my colleague sent me a strange error she was getting in our VFP application
"The text, ntext, or image pointer value conflicts with the column name specified."

I was not getting the same error, so it was puzzling indeed. After some research&#8230;]]></description>
				<content:encoded><![CDATA[<p>Recently my colleague sent me a strange error she was getting in our VFP application<br />
&#8220;The text, ntext, or image pointer value conflicts with the column name specified.&#8221;</p>
<p>I was not getting the same error, so it was puzzling indeed. After some research online I found the <a href="http://social.msdn.microsoft.com/Forums/en/transactsql/thread/d26e2143-630b-46e7-a81b-a33a24af20ce">following thread</a> and suspected the problem was in the image size. And yes, after I chose a file about 2MB in size I was able to reproduce the same error. I haven&#8217;t been able to determine the exact image size when this error occurs, but in my tests the files less than 400Kb worked and bigger files produced the error.</p>
<p>This is how our VFP application is structured. We use SPT for data retrieval, then using an approach similar to described in <a href="http://www.universalthread.com/ViewPageNewFAQ.aspx?ID=8153">this FAQ</a> we make this cursor updateable and then send updates using TABLEUPDATE function. We&#8217;re also using DSN and old SQL Server driver. In the table that was giving this error the field for storing images is varbinary(max).</p>
<p>I tested a similar form where the table used an image column. The same error didn&#8217;t occur and I was able to import 2MB files without a problem.</p>
<p>So, we now determine an internal SQL Server bug (most likely in the old SQL Server driver) that can not work with big varbinary(max) columns by using remote views form Visual FoxPro.<br />
I also found a thread on a <a href="http://www.foxite.com/archives/warning-possible-bug-sql-server-0000239346.htm">similar topic</a> by Cetin Basoz at foxite.com forum.</p>
<p>Luckily there was a relatively simple solution for this problem: use direct updates/inserts with parameters instead of remote views. So, in my forms I was checking for big size images and used a different approach when saving data.</p>
<p>Here is a test program that can demonstrate the problem:</p>
<pre>ON ERROR 
CLEAR ALL
CLEAR 
oAppObj = NEWOBJECT('my_appObj','my_Class.vcx')
=CURSORSETPROP('MapBinary',.t.,0)
WAIT WINDOW NOWAIT NOCLEAR 'Connecting to server data ...'

      SQLSETPROP(0, "ConnectTimeOut", 15)
      SQLSETPROP(0, "DispWarnings", .F.)
      SQLSETPROP(0, "DispLogin", 3)  &amp;&amp; disable login dialog if there is a problem
      SQLHandle=SQLCONNECT('MyDB', 'userid', 'password')
      sqlexec(SQLHandle, 'use MyDB' )   

lcPicFile = GETFILE('jpg;png')

lcStr = CAST(FILETOSTR(m.lcPicFile)  as blob)       

TEXT TO lcSQL TEXTMERGE NOSHOW 
update dbo.rsSeatMaps set SeatMap = ?m.lcStr
where SeatMapID = 10
ENDTEXT 

?SQLEXEC(SQLHandle, m.lcSQL)
aError(laError)
DISPLAY MEMORY LIKE laError

? SQLEXEC(SQLHandle,'select * from dbo.rsSeatMaps where SeatMapID = 10','rsSeatMaps')
?make_view_updatable('rsSeatMaps',5, SQLHandle)

replace SeatMap WITH m.lcStr IN rsSeatMaps

?TABLEUPDATE(.t.,.t., 'rsSeatMaps')
?AERROR(laError)
DISPLAY MEMORY LIKE laError
SQLDISCONNECT(0)
WAIT CLEAR</pre>
<p>The first direct update command succeeds, but the second remote view update fails.</p>
<p>Hopefully this blog post will be helpful.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/dealing-with-the-the-text/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Displaying and Saving Unicode data in Visual FoxPro desktop application</title>
		<link>/index.php/datamgmt/datadesign/displaying-and-saving-unicode-data/</link>
		<comments>/index.php/datamgmt/datadesign/displaying-and-saving-unicode-data/#comments</comments>
		<pubDate>Sun, 01 Jan 2012 17:09:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2012/01/displaying-and-saving-unicode-data/</guid>
		<description><![CDATA[Recently I had to deal with the problem of displaying and saving Unicode data in a Visual FoxPro form. As we all know, Visual FoxPro does not support Unicode, so this was  quite a challenge for me. I would never have solved this problem by myself if Gre&#8230;]]></description>
				<content:encoded><![CDATA[<p>Recently I had to deal with the problem of displaying and saving Unicode data in a Visual FoxPro form. As we all know, Visual FoxPro does not support Unicode, so this was  quite a challenge for me. I would never have solved this problem by myself if Gregory Adam from the <a href="http://universalthread.com/">UniversalThread</a> would not lend me his generous support and practically solved the problem of saving for me. I want to show the full solution we came to together as this may be a very important topic for the remaining Visual FoxPro developers (and because Koen asked me to write this blog post).</p>
<p>There used to be the classical and very comprehensive article on this topic written by Rick Strahl Using Unicode in Visual FoxPro Web and Desktop Applications. The link to that article now appears to be broken, so I found another shorter article: <a href="https://www.west-wind.com/wconnect/WebLog/ShowEntry.blog?id=608">Unicode to ANSI Translation in VFP 9.0 &#8211; Sys(987)</a> </p>
<p>I originally started from the first mentioned article. Our application uses SQL Server to hold data and uses sql pass thru technique to send information from and to SQL Server. </p>
<p>Now, since I am describing the solution I used for the particular application, I will start with the SQL Server table I was using. That table was named Prefs_sl and it was a flat table with 1 record containing all preferences for a sales point. Because of its flat nature it was badly normalized. Say, it had 11 language fields language00 &#8211; language10 (nvarchar(100)) to hold name of the language the Sales Point can display and 11 image lngImage00-lngImage10 (varbinary(max)) fields to hold the image of the country flag. So, this was the table I was working with on the SQL Server side.</p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/Prefs_sl SQL Server table.JPG?mtime=1325442752"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Prefs_sl SQL Server table.JPG?mtime=1325442752" width="1764" height="162" /></a></div>
<p>Now, I wanted to display these 11 languages with their corresponding flags on the form, so the logical choice was to create a class with the textbox for the unicode text and image for the image flag and then instantiate this class on the form.</p>
<p>The first question was what to chose for displaying unicode data? Rick mentioned MS Edit Box control ActiveX, but I didn&#8217;t find it in the list of my installed ActiveX. But I found MS Forms2 TextBox ActiveX control and since I also remembered <a href="http://www.foxite.com/archives/how-to-implement-unicode-in-vfp-0000209431.htm">this thread</a> on foxite forum, I decided to try this ActiveX control.<br />
The first problem I encountered with this ActiveX as that it didn&#8217;t show up until I clicked on it when I was running the form. Luckily I found the following solution &#8211; invoke SetFocus of this control (I called it txtLanguage in my class) and then it was displayed correctly. I am not sure if my solution is the best to handle this ActiveX behavior quirks, but hey, it works.</p>
<p>Ok, so far so good. Now, following Rick&#8217;s article I used the following in my form to get the data in the binary format:</p>
<pre>LOCAL lcSQL
TEXT TO lcSQL noshow
SELECT pri_key      
      ,defltlang
      ,cast(language00 as varbinary(100)) as language00
      ,lngimage00      
      ,cast(language01 as varbinary(100)) as language01
      ,lngimage01
      ,cast(language02 as varbinary(100)) as language02
      ,lngimage02
      ,cast(language03 as varbinary(100)) as language03
      ,lngimage03
      ,cast(language04 as varbinary(100)) as language04
      ,lngimage04
      ,cast(language05 as varbinary(100)) as language05
      ,lngimage05
      ,cast(language06 as varbinary(100)) as language06
      ,lngimage06
      ,cast(language07 as varbinary(100)) as language07
      ,lngimage07
      ,cast(language08 as varbinary(100)) as language08
      ,lngimage08
      ,cast(language09 as varbinary(100)) as language09
      ,lngimage09
      ,cast(language10 as varbinary(100)) as language10
      ,lngimage10      
  FROM dbo.prefs_sl
endtext  
mysqlexec(m.lcSQL, 'Prefs_sl', program())</pre>
<p>mysqlexec here is a wrapper for the sqlexec function.</p>
<p>Now I found the first discrepancy with Rick&#8217;s article &#8211; I found that I don&#8217;t need any conversion after that, I can assign the field&#8217;s content to the text property of this ActiveX (or ControlSource property) and the control correctly displays the unicode data!</p>
<p>I was happy &#8211; the first part of displaying data turned out to be quite easy!</p>
<p>Here is the code I used to display the data:</p>
<pre>FOR EACH loObject IN thisform.Objects foxobject
   IF loObject.Baseclass = 'Container'
      loObject.LanguageField = SUBSTR(loObject.name,4,LEN(loObject.name))
      loObject.ImageField = 'lngImage' + RIGHT(loObject.Name,2)
   ENDIF 
next   

thisform.cntLanguage01.SetFocus()</pre>
<p>And in the container itself the following code in the LanguageField assign method:</p>
<pre>this.lblLanguage.caption = this.lblLanguage.caption + ' ' + transform(val(right(tLanguageField,2)))
  this.txtLanguage.Enabled = .t.
  this.txtLanguage.TabStop = .t.   
  this.lProgrammaticChange = .t.
  this.txtLanguage.text = evaluate('prefs_sl.' + tLanguageField)
  this.lProgrammaticChange = .f.</pre>
<p>Everything was good so far. However, I haven&#8217;t expected how hard (for me) it will be the &#8216;saving&#8217; data part. I was spending days trying various ideas from Rick&#8217;s article and was still unable to achieve the desired result. I was about to throw all I had away and try to switch to ADO for data retrieval, but luckily Gregory Adam helped me here and published a working sample.</p>
<p>First of all, we need to make sure there is no UT8 translation to the current code page. For this we need to do the following</p>
<pre>COMPROP(this,'UTF8',1)</pre>
<p>In the txtLanguage Init method.</p>
<p>We also need the following functions:</p>
<pre>&amp;&amp; StringConversion
&amp;&amp; Gregory Adam 2011
*===============================================================================
#define true	.T.
#define false	.F.

*_______________________________________________________________________________
function StringToUTF8(utf8Out, stringIn, codepageIn)
	
	local success
	success = true
	
	do case
	case !m.success
	
	case !StringToUTF16(@m.utf8Out, m.stringIn, m.codepageIn)
		assert false
		success = false
	
	case !StringUTF16ToUTF8(@m.utf8Out, m.utf8Out)
		assert false
		success = false
	
	endcase
	
	return m.success
	
endfunc
*_______________________________________________________________________________


*_______________________________________________________________________________
*_______________________________________________________________________________
#define CP_ACP					0
#define CP_MACCP				2
#define CP_OEMCP				1
#define CP_SYMBOL				42
#define CP_THREAD_ACP			3
#define CP_UTF7					65000
#define CP_UTF8					65001
#define MB_PRECOMPOSED			0x1
#define MB_COMPOSITE			0x2
#define MB_USEGLYPHCHARS		0x4
#define MB_ERR_INVALID_CHARS	0x8

#define WC_DEFAULTCHAR			0x00000040 
#define WC_ERR_INVALID_CHARS	0x00000080 
#define WC_NO_BEST_FIT_CHARS 	0x00000400 
*_______________________________________________________________________________
function StringToUTF16(utf16Out, stringIn, codepageIn)

	local success
	success = true
	
	do case
	case !m.success
	
	case empty(len(m.stringIn))
		utf16Out = ''
		
	otherwise
		local lpWideCharStr, result
		lpWideCharStr = space(len(m.stringIn)*2)
	
		result = MultiByteToWideChar( ;
					evl(m.codepageIn, cpcurrent()), ;
					MB_ERR_INVALID_CHARS, ;
					@m.stringIn, ;
					len(m.stringIn), ;
					@m.lpWideCharStr, ;
					len(m.lpWideCharStr) ;
				)
			
		do case
		case !m.success
		
		case empty(m.result)
			assert false
			success = false
		
		otherwise
			utf16Out = left(m.lpWideCharStr, m.result * 2) 
		
		endcase
		
	endcase
	
	return m.success
	
	
endfunc
*_______________________________________________________________________________
function StringUTF16ToUTF8(utf8Out, utf16In)

	local success
	success = true
	
	do case
	case !m.success
	
	case empty(len(m.utf16In))
		utf8Out = ''
		
	otherwise
	
		local lpMultiByteStr, lpUsedDefaultChar, result
		lpMultiByteStr = space(len(m.utf16In) * 2)
		lpUsedDefaultChar = 0
		
		result = WideCharToMultiByte( ;
					CP_UTF8, ;
					WC_ERR_INVALID_CHARS, ;
					@m.utf16In, ;
					len(m.utf16In)/2, ;
					@m.lpMultiByteStr, ;
					len(m.lpMultiByteStr), ;
					null, ;
					@m.lpUsedDefaultChar ;
				)
		
		do case
		case !m.success
		
		case empty(m.result)			
			assert false
			success = false
			
			
		otherwise
			utf8Out = left(m.lpMultiByteStr, m.result)
		
		endcase
	endcase
	
	return m.success
	
	
endfunc
*_______________________________________________________________________________
function StringUTF8ToUTF16(utf16Out, uft8In)

	return StringToUTF16(@m.utf16Out, uft8In, CP_UTF8)
	
endfunc
*_______________________________________________________________________________

function MultiByteToWideChar
	lparameters codepage, ;
				dwFlags, ;
				lpMultiByteStr, ;
				cbMultiByte, ;
				lpWideCharStr, ;
				cchWideChar

	local success
	success = true

	local result
	
	do case
	case !m.success
	
	otherwise
		try
			declare integer MultiByteToWideChar in Kernel32.dll ;
				long	codepage, ;
				long	dwFlags, ;
				string@	lpMultiByteStr, ;
				integer	cbMultiByte, ;
				string@	lpWideCharStr, ;
				integer	cchWideChar
		
			result = MultiByteToWideChar( ;
					m.codepage, ;
					m.dwFlags, ;
					@m.lpMultiByteStr, ;
					m.cbMultiByte, ;
					@m.lpWideCharStr, ;
					m.cchWideChar ;
				)
		catch
			assert false
			success = false
			
		endtry
	endcase
	
	return iif(m.success, m.result, 0)
	
endfunc
*_______________________________________________________________________________
function WideCharToMultiByte
	lparameters codepage, ;
				dwFlags, ;
				lpWideCharStr, ;
				cchWideChar, ;
				lpMultiByteStr, ;
				cbMultiByte, ;
				lpDefaultChar, ;
				lpUsedDefaultChar

	local success
	success = true

	local result
	
	do case
	case !m.success
	
	otherwise
		try
			declare integer WideCharToMultiByte in Kernel32.dll ;
				long	codepage, ;
				long	dwFlags, ;
				string@	lpWideCharStr, ;
				integer	cchWideChar, ;
				string@	lpMultiByteStr, ;
				integer	cbMultiByte, ;
				string	lpDefaultChar, ;
				integer	@lpUsedDefaultChar
		
			result = WideCharToMultiByte ( ;
					m.codepage, ;
					m.dwFlags, ;
					@m.lpWideCharStr, ;
					m.cchWideChar, ;
					@m.lpMultiByteStr, ;
					m.cbMultiByte, ;
					m.lpDefaultChar, ;
					@m.lpUsedDefaultChar;
				)
		catch
			assert false
			success = false
			
		endtry
	endcase
	
	return iif(m.success, m.result, 0)
	
endfunc</pre>
<p>and then in the Change event of the ActiveX textbox I added the following code</p>
<pre>IF this.parent.lProgrammaticChange 
    RETURN
ENDIF     
if thisform.IsChanged OR (not this.CurrentValue == this.Text)
   thisform.IsChanged = .t.
   local utf8, utf16Out
   utf8 = this.text
   if not empty(utf8)
      = StringUtf8ToUTF16(@m.utf16Out, m.utf8)
      replace (this.parent.LanguageField) with utf16Out
   else
      replace (this.parent.LanguageField) with ''
   endif
endif</pre>
<p>and finally in the Save method of the form</p>
<pre>IF THISFORM.IsChanged 
  LOCAL lcSQL

  TEXT TO lcSQL noshow
     UPDATE dbo.prefs_sl 
     SET defltlang = ?prefs_sl.DefltLang,
     language00 = cast(?prefs_sl.language00 as nvarchar(100)),
     lngimage00 = ?prefs_sl.lngimage00,
     language01 = cast(?prefs_sl.language01 as nvarchar(100)),
     lngimage01 = ?prefs_sl.lngimage01,
     language02 = cast(?prefs_sl.language02 as nvarchar(100)),
     lngimage02 = ?prefs_sl.lngimage02,
     language03 = cast(?prefs_sl.language03 as nvarchar(100)),
     lngimage03 = ?prefs_sl.lngimage03,
     language04 = cast(?prefs_sl.language04 as nvarchar(100)),
     lngimage04 = ?prefs_sl.lngimage04,
     language05 = cast(?prefs_sl.language05 as nvarchar(100)),
     lngimage05 = ?prefs_sl.lngimage05,
     language06 = cast(?prefs_sl.language06 as nvarchar(100)),
     lngimage06 = ?prefs_sl.lngimage06,
     language07 = cast(?prefs_sl.language07 as nvarchar(100)),
     lngimage07 = ?prefs_sl.lngimage07,
     language08 = cast(?prefs_sl.language08 as nvarchar(100)),
     lngimage08 = ?prefs_sl.lngimage08,
     language09 = cast(?prefs_sl.language09 as nvarchar(100)),
     lngimage09 = ?prefs_sl.lngimage09,
     language10 = cast(?prefs_sl.language10 as nvarchar(100)),
     lngimage10 = ?prefs_sl.lngimage10
     where pri_key = ?prefs_sl.pri_key
  ENDTEXT
 RETURN mySQLExec(m.lcSQL, '',PROGRAM())
ENDIF</pre>
<p>As we can see, we need to convert data back from binary to nvarchar.<br />
With all this code in place, we display the unicode data and save them back to SQL Server.</p>
<p>A big thanks to Gregory for helping me with the code &#8211; I don&#8217;t know where I would be without his help.</p>
<p>Olaf Doschke showed another way which is even simpler than implemented solution and in accordance to the original Rick&#8217;s article.</p>
<p>In the form&#8217;s Load we need the following:</p>
<pre>Sys(987,.F.)
Sys(3101,65001)</pre>
<p>Then, after getting binary data from SQL Server the same way as I show in this blog, we still need to use createbinary, e.g.</p>
<p>this.txtLanguage.text = createbinary(prefs_sl.Language00)</p>
<p>We don&#8217;t want to use COMPROP now for the ActiveX.</p>
<p>and then, saving data, we need to follow Rick&#8217;s steps:</p>
<pre>pcSavedText1 = Strconv(This.Text,12)

*** Must explicitly force to binary  can also use CAST in 9.0
pcSavedText1 = CREATEBINARY(pcSavedText1)</pre>
<p>and then convert this value back to nvarchar(max) when saving with sqlexec.</p>
<p>This is how the form with many languages looked like</p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/ManyLanguages.JPG?mtime=1325442752"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/ManyLanguages.JPG?mtime=1325442752" width="927" height="654" /></a></div>
<p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;<br />
I need to also tell, that after I finished the form and was happy to show it to my colleagues, I was up to a big disappointment. It turned out we are not going to support unicode (our main application is not up to support it yet) and so I will be re-doing this form after we will agree on the tables&#8217; structures (they also are going to change). So, what I showed in this blog post we&#8217;re not going to use at present in production.</p>
<p><span class="MT_red">UPDATE.</span> My colleague also re-designed prefs_sl table to one EAV Settings table. We know that EAV design has its own problems, but for saving various application level settings it can be used. I already re-designed the forms we&#8217;re going to use. </p>
<p>But in any case, it was a very important exercise and I hope it will help other people who need to display and save Unicode data in their Visual FoxPro applications.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/displaying-and-saving-unicode-data/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		</item>
		<item>
		<title>Maximum length of data in every column in a table</title>
		<link>/index.php/datamgmt/datadesign/maximum-length-of-data-in/</link>
		<comments>/index.php/datamgmt/datadesign/maximum-length-of-data-in/#comments</comments>
		<pubDate>Tue, 06 Dec 2011 13:41:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/12/maximum-length-of-data-in/</guid>
		<description><![CDATA[In this short blog post I would like to share a script I wrote yesterday as an answer to this MSDN thread to find maximum length of data in every column of a table passed as a parameter.

Some notes for the script:

LTRIM function can be used with m&#8230;]]></description>
				<content:encoded><![CDATA[<p>In this short blog post I would like to share a script I wrote yesterday as an answer to <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/d2d765e2-7994-4b3e-826b-c49c12f3b6fe">this MSDN thread</a> to find maximum length of data in every column of a table passed as a parameter.</p>
<p>Some notes for the script:</p>
<p>LEN function can be used with many SQL Server types excluding text and new types such as Geography or HierarchyID. I added exclusion of these types directly in the query, there may be some other types which need to be also excluded.</p>
<p>I am using one of my favorite ideas of generating script to run using available meta-data.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> AdventureWorks2008R2
&nbsp;
<span class="co1">--declare @TableName sysname = 'Employee', @TableSchema sysname = 'HumanResources'</span>
<span class="kw1">DECLARE</span> @TableName sysname <span class="sy0">=</span> <span class="st0">'Address'</span>, @TableSchema sysname <span class="sy0">=</span> <span class="st0">'Person'</span>
<span class="kw1">DECLARE</span> @<span class="kw1">SQL</span> <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw2">STUFF</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw1">SELECT</span> 
<span class="st0">'</span>
<span class="st0">UNION ALL </span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Table_Name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS Table_Name, '</span> <span class="sy0">+</span> 
<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Column_Name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS ColumnName, MAX(LEN('</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Column_Name<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">')) as [Max Length], '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>C.<span class="me1">DATA_TYPE</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS Data_Type, '</span> <span class="sy0">+</span> 
<span class="kw1">CAST</span><span class="br0">&#40;</span><span class="kw1">COALESCE</span><span class="br0">&#40;</span>C.<span class="me1">CHARACTER_MAXIMUM_LENGTH</span>, C.<span class="me1">NUMERIC_SCALE</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' &nbsp;AS Data_Width FROM '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>TABLE_SCHEMA<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.'</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Table_Name<span class="br0">&#41;</span>
<span class="kw1">FROM</span> <span class="sy0">IN</span>F<span class="sy0">OR</span>MATION_SCHEMA.<span class="me1">COLUMNS</span> C 
<span class="kw1">WHERE</span> TABLE_NAME <span class="sy0">=</span> @TableName 
<span class="sy0">AND</span> table_schema <span class="sy0">=</span> @TableSchema
<span class="sy0">AND</span> DATA_TYPE <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="st0">'text'</span>,<span class="st0">'ntext'</span>,<span class="st0">'XML'</span>,<span class="st0">'HierarchyID'</span>,<span class="st0">'Geometry'</span>,<span class="st0">'Geography'</span><span class="br0">&#41;</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> COLUMN_NAME 
<span class="kw1">FOR</span> XML <span class="kw1">PATH</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span>,Type<span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'.'</span>,<span class="st0">'varchar(max)'</span><span class="br0">&#41;</span>,<span class="nu0">1</span>,<span class="nu0">11</span>,<span class="st0">''</span><span class="br0">&#41;</span> &nbsp;
<span class="co1">--print @SQL</span>
<span class="kw1">EXECUTE</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE AdventureWorks2008R2

--declare @TableName sysname = 'Employee', @TableSchema sysname = 'HumanResources'
DECLARE @TableName sysname = 'Address', @TableSchema sysname = 'Person'
DECLARE @SQL NVARCHAR(MAX)

SELECT @SQL = STUFF((SELECT 
'
UNION ALL 
select ' + QUOTENAME(Table_Name,'''') + ' AS Table_Name, ' + 
QUOTENAME(Column_Name,'''') + ' AS ColumnName, MAX(LEN(' + QUOTENAME(Column_Name) + 
')) as [Max Length], ' + QUOTENAME(C.DATA_TYPE,'''') + ' AS Data_Type, ' + 
CAST(COALESCE(C.CHARACTER_MAXIMUM_LENGTH, C.NUMERIC_SCALE,0) AS VARCHAR(10)) + 
'  AS Data_Width FROM ' + QUOTENAME(TABLE_SCHEMA) + '.' + QUOTENAME(Table_Name)
FROM INFORMATION_SCHEMA.COLUMNS C 
WHERE TABLE_NAME = @TableName 
AND table_schema = @TableSchema
AND DATA_TYPE NOT IN ('text','ntext','XML','HierarchyID','Geometry','Geography')
ORDER BY COLUMN_NAME 
FOR XML PATH(''),Type).value('.','varchar(max)'),1,11,'')  
--print @SQL
EXECUTE (@SQL)</pre></div></div>

<p>Here is another version of the same script which attempts to list every column in a table but uses DATALENGTH function instead of LEN for the types where we can not use LEN function:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> AdventureWorks2008R2
<span class="co1">--declare @TableName sysname = 'Employee', @TableSchema sysname = 'HumanResources'</span>
<span class="kw1">DECLARE</span> @TableName sysname <span class="sy0">=</span> <span class="st0">'Address'</span>, @TableSchema sysname <span class="sy0">=</span> <span class="st0">'Person'</span>
<span class="kw1">DECLARE</span> @<span class="kw1">SQL</span> <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw2">STUFF</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw1">SELECT</span> 
<span class="st0">'</span>
<span class="st0">UNION ALL </span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Table_Name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS Table_Name, '</span> <span class="sy0">+</span> 
<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Column_Name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS ColumnName, MAX('</span> <span class="sy0">+</span> 
<span class="kw1">CASE</span> <span class="kw1">WHEN</span> DATA_TYPE <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="st0">'XML'</span>,<span class="st0">'HierarchyID'</span>,<span class="st0">'Geometry'</span>,<span class="st0">'Geography'</span>,<span class="st0">'text'</span>,<span class="st0">'ntext'</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp;<span class="kw1">THEN</span> <span class="st0">'DATALENGTH('</span> <span class="kw1">ELSE</span> <span class="st0">'LEN('</span> <span class="kw1">END</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Column_Name<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">')) as [Max Length], '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>C.<span class="me1">DATA_TYPE</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AS Data_Type, '</span> <span class="sy0">+</span> 
<span class="kw1">CAST</span><span class="br0">&#40;</span><span class="kw1">COALESCE</span><span class="br0">&#40;</span>C.<span class="me1">CHARACTER_MAXIMUM_LENGTH</span>, C.<span class="me1">NUMERIC_SCALE</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' &nbsp;AS Data_Width FROM '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>TABLE_SCHEMA<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.'</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Table_Name<span class="br0">&#41;</span>
<span class="kw1">FROM</span> <span class="sy0">IN</span>F<span class="sy0">OR</span>MATION_SCHEMA.<span class="me1">COLUMNS</span> C 
<span class="kw1">WHERE</span> TABLE_NAME <span class="sy0">=</span> @TableName 
<span class="sy0">AND</span> table_schema <span class="sy0">=</span> @TableSchema
<span class="co1">--AND DATA_TYPE NOT IN ('XML','HierarchyID','Geometry','Geography')</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> COLUMN_NAME 
<span class="kw1">FOR</span> XML <span class="kw1">PATH</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span>,Type<span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'.'</span>,<span class="st0">'varchar(max)'</span><span class="br0">&#41;</span>,<span class="nu0">1</span>,<span class="nu0">11</span>,<span class="st0">''</span><span class="br0">&#41;</span> &nbsp;
<span class="co1">--print @SQL</span>
<span class="kw1">EXECUTE</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE AdventureWorks2008R2
--declare @TableName sysname = 'Employee', @TableSchema sysname = 'HumanResources'
DECLARE @TableName sysname = 'Address', @TableSchema sysname = 'Person'
DECLARE @SQL NVARCHAR(MAX)

SELECT @SQL = STUFF((SELECT 
'
UNION ALL 
select ' + QUOTENAME(Table_Name,'''') + ' AS Table_Name, ' + 
QUOTENAME(Column_Name,'''') + ' AS ColumnName, MAX(' + 
CASE WHEN DATA_TYPE IN ('XML','HierarchyID','Geometry','Geography','text','ntext')
     THEN 'DATALENGTH(' ELSE 'LEN(' END + QUOTENAME(Column_Name) + 
')) as [Max Length], ' + QUOTENAME(C.DATA_TYPE,'''') + ' AS Data_Type, ' + 
CAST(COALESCE(C.CHARACTER_MAXIMUM_LENGTH, C.NUMERIC_SCALE,0) AS VARCHAR(10)) + 
'  AS Data_Width FROM ' + QUOTENAME(TABLE_SCHEMA) + '.' + QUOTENAME(Table_Name)
FROM INFORMATION_SCHEMA.COLUMNS C 
WHERE TABLE_NAME = @TableName 
AND table_schema = @TableSchema
--AND DATA_TYPE NOT IN ('XML','HierarchyID','Geometry','Geography')
ORDER BY COLUMN_NAME 
FOR XML PATH(''),Type).value('.','varchar(max)'),1,11,'')  
--print @SQL
EXECUTE (@SQL)</pre></div></div>

<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/maximum-length-of-data-in/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>How to get information about all databases without a loop</title>
		<link>/index.php/datamgmt/datadesign/how-to-get-information-about-all-databas/</link>
		<comments>/index.php/datamgmt/datadesign/how-to-get-information-about-all-databas/#comments</comments>
		<pubDate>Wed, 30 Nov 2011 12:47:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/11/how-to-get-information-about-all-databas/</guid>
		<description><![CDATA[Quite often we want to consolidate query information across all databases (or all user databases). When this question is asked in forums, the usual recommendation is to either try running undocumented sp_MSForEachDB stored procedure or do a loop and use&#8230;]]></description>
				<content:encoded><![CDATA[<p>Quite often we want to consolidate query information across all databases (or all user databases). When this question is asked in forums, the usual recommendation is to either try running <a href="http://www.mssqltips.com/tip.asp?tip=1905&amp;ctc">undocumented sp_MSForEachDB stored procedure</a> or do a loop and use dynamic SQL. The example of such stored procedures can be found, for example, <a href="http://sqlusa.com/bestpractices/training/scripts/dynamicsql/">THIRD EXAMPLE &#8211; SPROC to enumerate all objects in databases</a>.</p>
<p>The idea occurred to me last night that while we do need a dynamic SQL to solve this problem, we don&#8217;t really need a loop unless we need a second loop involving looping through all tables.</p>
<h3>Table of Contents:</h3>
<p><a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#1">Indexes in all databases with their usage</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#2">Indexes in all databases with their physical stats</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#3">Count of all objects in all databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#4">Record Count in every table in a database</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#5">Quick Record Count in All Tables in All Databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#6">Quick Record Count in All Tables in All Databases (2)</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#7">Sizes of All Tables in a Database</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#8">Database Files Sizes in All Databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#9">Database Files Sizes in All Databases and used space</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#10">Backup All Databases with Compression (SQL 2008+)</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#11">All Schema Names in All Databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#12">List of All Tables in All Databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#13">List of All Tables in All Databases (2)</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#14">List of all Stored Procedures in All Databases</a><br />
<a href="/index.php/DataMgmt/DataDesign/how-to-get-information-about-all-databas#15">Database Files Growth</a></p>
<p>Here is a script demonstrating this idea &#8211; it lists indexes in all databases with their usage. This script was an answer to <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/ab4b39b0-5bb2-4ffc-a25d-6bb8fe6124ef/#f3a3a011-4318-44e2-97c1-5bdadd7b2444">Help in T-SQL Query thread</a> in MSDN T-SQL forum.</p>
<h2 id="1">Indexes in all databases with their usage</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">if</span> <span class="kw2">object_id</span><span class="br0">&#40;</span><span class="st0">'tempdb..#Result'</span>,<span class="st0">'U'</span><span class="br0">&#41;</span> <span class="kw1">IS</span> not <span class="sy0">NULL</span>
&nbsp;<span class="kw1">drop</span> <span class="kw1">table</span> #Result
<span class="kw1">create</span> <span class="kw1">table</span> #Result <span class="br0">&#40;</span>DBName sysname, TableName Sysname, IndexName sysname, <span class="kw1">Usage</span> <span class="kw1">bigint</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' use '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">';</span>
<span class="st0">insert into #Result select '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as DbName, </span>
<span class="st0">object_name(i.object_id) as tablename, &nbsp;i.name as indexname, </span>
<span class="st0">s.user_seeks + s.user_scans + s.user_lookups + s.user_updates as usage</span>
<span class="st0">from sys.indexes i &nbsp; </span>
<span class="st0">inner join sys.dm_db_index_usage_stats s &nbsp; &nbsp; &nbsp; &nbsp;</span>
<span class="st0">on s.object_id = i.object_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span>
<span class="st0">and s.index_id = i.index_id &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span>
<span class="st0">and s.database_id = db_id()</span>
<span class="st0">where objectproperty(i.object_id, '</span><span class="st0">'IsUserTable'</span><span class="st0">') = 1 &nbsp; </span>
<span class="st0">and i.index_id &gt; 0 </span>
<span class="st0">order by usage;'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span> 
<span class="co1">--print (@SQL)</span>
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> #Result <span class="kw1">order</span> <span class="kw1">by</span> <span class="br0">&#91;</span>DbName<span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="kw1">Usage</span><span class="br0">&#93;</span>
<span class="kw1">drop</span> <span class="kw1">table</span> #Result</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SQL nvarchar(max)
if object_id('tempdb..#Result','U') IS not NULL
 drop table #Result
create table #Result (DBName sysname, TableName Sysname, IndexName sysname, Usage bigint)

select @SQL = coalesce(@SQL,'') + CHAR(13) + CHAR(10) + ' use ' + QUOTENAME([Name]) + ';
insert into #Result select ' + quotename([Name],'''') + ' as DbName, 
object_name(i.object_id) as tablename,  i.name as indexname, 
s.user_seeks + s.user_scans + s.user_lookups + s.user_updates as usage
from sys.indexes i   
inner join sys.dm_db_index_usage_stats s        
on s.object_id = i.object_id                    
and s.index_id = i.index_id              
and s.database_id = db_id()
where objectproperty(i.object_id, ''IsUserTable'') = 1   
and i.index_id &gt; 0 
order by usage;' from sys.databases 
--print (@SQL)
execute (@SQL)
select * from #Result order by [DbName],[Usage]
drop table #Result</pre></div></div>

<h2 id="2">Indexes in all databases with their physical stats</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">''</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span>
<span class="st0">'Select '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as [DB Name], </span>
<span class="st0">object_Name(PS.Object_ID,'</span> <span class="sy0">+</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span>,database_id<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">') as [Object],</span>
<span class="st0">I.Name as [Index Name], PS.Partition_Number, PS.Index_Type_Desc, </span>
<span class="st0">PS.alloc_unit_type_desc,&nbsp; &nbsp; PS.index_depth, PS.index_level,</span>
<span class="st0">PS.avg_fragmentation_in_percent,&nbsp; &nbsp; PS.fragment_count,&nbsp; PS.avg_fragment_size_in_pages,</span>
<span class="st0">PS.page_count,&nbsp; PS.avg_page_space_used_in_percent,&nbsp; PS.record_count,&nbsp; &nbsp; </span>
<span class="st0">PS.ghost_record_count,&nbsp; PS.version_ghost_record_count,</span>
<span class="st0">PS.min_record_size_in_bytes,&nbsp; &nbsp; PS.max_record_size_in_bytes,&nbsp; &nbsp; PS.avg_record_size_in_bytes,</span>
<span class="st0">PS.forwarded_record_count,&nbsp; PS.compressed_page_count</span>
<span class="st0"> from '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.dm_db_index_physical_stats('</span> <span class="sy0">+</span> 
<span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span>,database_id<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">', NULL, NULL, NULL, NULL) PS </span>
<span class="st0">INNER JOIN '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">'.sys.Indexes I on PS.Object_ID = I.Object_ID and PS.Index_ID = I.Index_ID '</span> 
<span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp;
&nbsp;<span class="kw1">from</span> sys.<span class="me1">databases</span> <span class="kw1">where</span> state_desc <span class="sy0">=</span> <span class="st0">'ONLINE'</span>
&nbsp;
<span class="kw1">execute</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SQL nvarchar(max)
set @SQL = ''
select @SQL = @SQL +
'Select ' + quotename(name,'''') + ' as [DB Name], 
object_Name(PS.Object_ID,' + convert(varchar(10),database_id) + ') as [Object],
I.Name as [Index Name], PS.Partition_Number, PS.Index_Type_Desc, 
PS.alloc_unit_type_desc,	PS.index_depth,	PS.index_level,
PS.avg_fragmentation_in_percent,	PS.fragment_count,	PS.avg_fragment_size_in_pages,
PS.page_count,	PS.avg_page_space_used_in_percent,	PS.record_count,	
PS.ghost_record_count,	PS.version_ghost_record_count,
PS.min_record_size_in_bytes,	PS.max_record_size_in_bytes,	PS.avg_record_size_in_bytes,
PS.forwarded_record_count,	PS.compressed_page_count
 from ' + quotename(name) + '.sys.dm_db_index_physical_stats(' + 
convert(varchar(10),database_id) + ', NULL, NULL, NULL, NULL) PS 
INNER JOIN ' + quotename(name) + 
'.sys.Indexes I on PS.Object_ID = I.Object_ID and PS.Index_ID = I.Index_ID ' 
+ CHAR(13)

 from sys.databases where state_desc = 'ONLINE'

execute(@SQL)</pre></div></div>

<p>Another example of the same idea you can find in <a href="http://wiki.lessthandot.com/index.php/Finding_Record_with_Last_Modified_date_in_all_tables">Finding Record with Last Modified date in all tables</a></p>
<p>Using this same idea you can get a count of all objects in all your databases using this PIVOT query:</p>
<h2 id="3">Count of all objects in all databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @Qry <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span> 
<span class="kw1">select</span> @Qry <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@Qry <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' UNION ALL '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as DBName, [AGGREGATE_FUNCTION], [CHECK_CONSTRAINT],[DEFAULT_CONSTRAINT],</span>
&nbsp;
<span class="st0">[FOREIGN_KEY_CONSTRAINT],</span>
&nbsp;
<span class="st0">[SQL_SCALAR_FUNCTION],</span>
&nbsp;
<span class="st0">[CLR_SCALAR_FUNCTION],</span>
&nbsp;
<span class="st0">[CLR_TABLE_VALUED_FUNCTION],</span>
&nbsp;
<span class="st0">[SQL_INLINE_TABLE_VALUED_FUNCTION],</span>
&nbsp;
<span class="st0">[INTERNAL_TABLE],[SQL_STORED_PROCEDURE],[CLR_STORED_PROCEDURE],[PLAN_GUIDE],[PRIMARY_KEY_CONSTRAINT],</span>
<span class="st0">[RULE],[REPLICATION_FILTER_PROCEDURE],[SYNONYM],[SERVICE_QUEUE],[CLR_TRIGGER],[SQL_TABLE_VALUED_FUNCTION],[SQL_TRIGGER],</span>
<span class="st0">[TABLE_TYPE],[USER_TABLE],[UNIQUE_CONSTRAINT],[VIEW],[EXTENDED_STORED_PROCEDURE]</span>
&nbsp;
<span class="st0">from (select [Name], type_Desc from '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.objects where is_ms_shipped = 0) src </span>
<span class="st0">PIVOT (count([Name]) FOR type_desc in ([AGGREGATE_FUNCTION], [CHECK_CONSTRAINT],[DEFAULT_CONSTRAINT],</span>
&nbsp;
<span class="st0">[FOREIGN_KEY_CONSTRAINT],</span>
&nbsp;
<span class="st0">[SQL_SCALAR_FUNCTION],</span>
&nbsp;
<span class="st0">[CLR_SCALAR_FUNCTION],</span>
&nbsp;
<span class="st0">[CLR_TABLE_VALUED_FUNCTION],</span>
&nbsp;
<span class="st0">[SQL_INLINE_TABLE_VALUED_FUNCTION],</span>
&nbsp;
<span class="st0">[INTERNAL_TABLE],[SQL_STORED_PROCEDURE],[CLR_STORED_PROCEDURE],[PLAN_GUIDE],[PRIMARY_KEY_CONSTRAINT],</span>
<span class="st0">[RULE],[REPLICATION_FILTER_PROCEDURE],[SYNONYM],[SERVICE_QUEUE],[CLR_TRIGGER],[SQL_TABLE_VALUED_FUNCTION],[SQL_TRIGGER],</span>
<span class="st0">[TABLE_TYPE],[USER_TABLE],[UNIQUE_CONSTRAINT],[VIEW],[EXTENDED_STORED_PROCEDURE])) pvt'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span> 
<span class="kw1">where</span> <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="st0">'master'</span>,<span class="st0">'tempdb'</span>,<span class="st0">'model'</span>,<span class="st0">'msdb'</span><span class="br0">&#41;</span> <span class="kw1">order</span> <span class="kw1">by</span> <span class="br0">&#91;</span>Name<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">execute</span><span class="br0">&#40;</span>@Qry<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @Qry nvarchar(max) 
select @Qry = coalesce(@Qry + char(13) + char(10) + ' UNION ALL ','') + '
select ' + quotename([Name],'''') + ' as DBName, [AGGREGATE_FUNCTION], [CHECK_CONSTRAINT],[DEFAULT_CONSTRAINT],

[FOREIGN_KEY_CONSTRAINT],

[SQL_SCALAR_FUNCTION],

[CLR_SCALAR_FUNCTION],

[CLR_TABLE_VALUED_FUNCTION],

[SQL_INLINE_TABLE_VALUED_FUNCTION],

[INTERNAL_TABLE],[SQL_STORED_PROCEDURE],[CLR_STORED_PROCEDURE],[PLAN_GUIDE],[PRIMARY_KEY_CONSTRAINT],
[RULE],[REPLICATION_FILTER_PROCEDURE],[SYNONYM],[SERVICE_QUEUE],[CLR_TRIGGER],[SQL_TABLE_VALUED_FUNCTION],[SQL_TRIGGER],
[TABLE_TYPE],[USER_TABLE],[UNIQUE_CONSTRAINT],[VIEW],[EXTENDED_STORED_PROCEDURE]

from (select [Name], type_Desc from ' + quotename([Name]) + '.sys.objects where is_ms_shipped = 0) src 
PIVOT (count([Name]) FOR type_desc in ([AGGREGATE_FUNCTION], [CHECK_CONSTRAINT],[DEFAULT_CONSTRAINT],

[FOREIGN_KEY_CONSTRAINT],

[SQL_SCALAR_FUNCTION],

[CLR_SCALAR_FUNCTION],

[CLR_TABLE_VALUED_FUNCTION],

[SQL_INLINE_TABLE_VALUED_FUNCTION],

[INTERNAL_TABLE],[SQL_STORED_PROCEDURE],[CLR_STORED_PROCEDURE],[PLAN_GUIDE],[PRIMARY_KEY_CONSTRAINT],
[RULE],[REPLICATION_FILTER_PROCEDURE],[SYNONYM],[SERVICE_QUEUE],[CLR_TRIGGER],[SQL_TABLE_VALUED_FUNCTION],[SQL_TRIGGER],
[TABLE_TYPE],[USER_TABLE],[UNIQUE_CONSTRAINT],[VIEW],[EXTENDED_STORED_PROCEDURE])) pvt' from sys.databases 
where [name] NOT IN ('master','tempdb','model','msdb') order by [Name]

execute(@Qry)</pre></div></div>

<p>You can only list types you&#8217;re interested in, of course.</p>
<p>The script below will give you a count of records in every table in a database:</p>
<h2 id="4">Record Count in every table in a database</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> &nbsp;@DynamicSQL <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> &nbsp; @DynamicSQL <span class="sy0">=</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>@DynamicSQL <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' UNION ALL '</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">'SELECT '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>table_schema,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as [Schema Name], '</span> <span class="sy0">+</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>TABLE_NAME,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">' as [Table Name], COUNT(*) AS [Records Count] FROM '</span> <span class="sy0">+</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">quotename</span><span class="br0">&#40;</span>Table_schema<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.'</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>TABLE_NAME<span class="br0">&#41;</span>
<span class="kw1">FROM</span> &nbsp; &nbsp; <span class="sy0">IN</span>F<span class="sy0">OR</span>MATION_SCHEMA.<span class="me1">TABLES</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> TABLE_NAME
&nbsp;
<span class="co1">--print (@DynamicSQL) -- we may want to use PRINT to debug the SQL</span>
<span class="kw1">EXEC</span><span class="br0">&#40;</span> @DynamicSQL<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE  @DynamicSQL NVARCHAR(MAX)
 
SELECT   @DynamicSQL = COALESCE(@DynamicSQL + CHAR(13) + ' UNION ALL ' + CHAR(13),
                                '') + 
                                'SELECT ' + quotename(table_schema,'''') + ' as [Schema Name], ' +
                                QUOTENAME(TABLE_NAME,'''') + 
                                ' as [Table Name], COUNT(*) AS [Records Count] FROM ' + 
                                quotename(Table_schema) + '.' + QUOTENAME(TABLE_NAME)
FROM     INFORMATION_SCHEMA.TABLES
ORDER BY TABLE_NAME
 
--print (@DynamicSQL) -- we may want to use PRINT to debug the SQL
EXEC( @DynamicSQL)</pre></div></div>

<p>Quick row count in all tables in all databases in the server instance (you can exclude system databases from that loop, obviously)</p>
<h2 id="5">Quick Record Count in All Tables in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">''</span>
<span class="co1">--select * from sys.databases </span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'USE '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="br0">&#91;</span>name<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">';</span>
<span class="st0">SELECT '</span> <span class="sy0">+</span><span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>name<span class="br0">&#93;</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'as [Database Name], </span>
<span class="st0"> &nbsp; SchemaName=s.name</span>
<span class="st0"> &nbsp;,TableName=t.name</span>
<span class="st0"> &nbsp;,CreateDate=t.create_date</span>
<span class="st0"> &nbsp;,ModifyDate=t.modify_date</span>
<span class="st0"> &nbsp;,p.rows</span>
<span class="st0"> &nbsp;,DataInKB=sum(a.used_pages)*8</span>
<span class="st0">FROM sys.schemas s</span>
<span class="st0">JOIN sys.tables t on s.schema_id=t.schema_id</span>
<span class="st0">JOIN sys.partitions p on t.object_id=p.object_id</span>
<span class="st0">JOIN sys.allocation_units a on a.container_id=p.partition_id</span>
<span class="st0">GROUP BY s.name, t.name, t.create_date, t.modify_date, p.rows</span>
<span class="st0">ORDER BY SchemaName, TableName'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span> &nbsp;
&nbsp;
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SQL nvarchar(max)

set @SQL = ''
--select * from sys.databases 
select @SQL = @SQL + CHAR(13) + 'USE ' + QUOTENAME([name]) + ';
SELECT ' +quotename([name],'''') + 'as [Database Name], 
   SchemaName=s.name
  ,TableName=t.name
  ,CreateDate=t.create_date
  ,ModifyDate=t.modify_date
  ,p.rows
  ,DataInKB=sum(a.used_pages)*8
FROM sys.schemas s
JOIN sys.tables t on s.schema_id=t.schema_id
JOIN sys.partitions p on t.object_id=p.object_id
JOIN sys.allocation_units a on a.container_id=p.partition_id
GROUP BY s.name, t.name, t.create_date, t.modify_date, p.rows
ORDER BY SchemaName, TableName' from sys.databases  

execute (@SQL)</pre></div></div>

<p>Another way with less info:</p>
<h2 id="6">Quick Record Count in All Tables in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">''</span>
<span class="co1">--select * from sys.databases </span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'USE '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="br0">&#91;</span>name<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">';</span>
<span class="st0">SELECT '</span> <span class="sy0">+</span><span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>name<span class="br0">&#93;</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'as [Database Name], so.name AS [Table Name], &nbsp; </span>
<span class="st0"> &nbsp; &nbsp;rows AS [RowCount] &nbsp; </span>
<span class="st0">FROM sysindexes AS si &nbsp; </span>
<span class="st0"> &nbsp; &nbsp;join sysobjects AS so on si.id = so.id &nbsp; </span>
<span class="st0">WHERE indid IN (0,1) &nbsp; </span>
<span class="st0"> &nbsp; &nbsp;AND xtype = '</span><span class="st0">'U'</span><span class="st0">''</span> <span class="kw1">from</span> sys.<span class="me1">databases</span> &nbsp;
&nbsp;
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span> &nbsp; &nbsp;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SQL nvarchar(max)

set @SQL = ''
--select * from sys.databases 
select @SQL = @SQL + CHAR(13) + 'USE ' + QUOTENAME([name]) + ';
SELECT ' +quotename([name],'''') + 'as [Database Name], so.name AS [Table Name],   
    rows AS [RowCount]   
FROM sysindexes AS si   
    join sysobjects AS so on si.id = so.id   
WHERE indid IN (0,1)   
    AND xtype = ''U''' from sys.databases  

execute (@SQL)    </pre></div></div>

<p>Here is a script showing sizes from all tables in a database.</p>
<h2 id="7">Sizes of All Tables in a Database</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="de1"><pre class="de1"><span class="co1">--exec sp_MSforeachtable 'print ''?'' exec sp_spaceused ''?'''</span>
<span class="kw1">if</span> <span class="kw2">OBJECT_ID</span><span class="br0">&#40;</span><span class="st0">'tempdb..#TablesSizes'</span><span class="br0">&#41;</span> <span class="kw1">IS</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>
&nbsp; &nbsp;<span class="kw1">drop</span> <span class="kw1">table</span> #TablesSizes
&nbsp; &nbsp;
<span class="kw1">create</span> <span class="kw1">table</span> #TablesSizes <span class="br0">&#40;</span>TableName sysname, <span class="kw1">Rows</span> <span class="kw1">bigint</span>, reserved <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, <span class="kw1">data</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, index_size <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, unused <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">declare</span> @<span class="kw1">sql</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">select</span> @<span class="kw1">sql</span> <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">sql</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into #TablesSizes execute sp_spaceused '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Table_Name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="kw1">from</span> <span class="sy0">IN</span>F<span class="sy0">OR</span>MATION_SCHEMA.<span class="me1">TABLES</span>
&nbsp;
<span class="co1">--print (@SQL)</span>
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> #TablesSizes <span class="kw1">order</span> <span class="kw1">by</span> TableName</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">--exec sp_MSforeachtable 'print ''?'' exec sp_spaceused ''?'''
if OBJECT_ID('tempdb..#TablesSizes') IS NOT NULL
   drop table #TablesSizes
   
create table #TablesSizes (TableName sysname, Rows bigint, reserved varchar(100), data varchar(100), index_size varchar(100), unused varchar(100))

declare @sql varchar(max)
select @sql = coalesce(@sql,'') + '
insert into #TablesSizes execute sp_spaceused ' + QUOTENAME(Table_Name,'''') from INFORMATION_SCHEMA.TABLES

--print (@SQL)
execute (@SQL)

select * from #TablesSizes order by TableName</pre></div></div>

<p>Here is a script showing database files sizes for all databases</p>
<p>Before I show the T-SQL code I&#8217;d like to point to this <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2010/11/02/use-powershell-to-obtain-sql-server-database-sizes.aspx">very interesting blog</a> as how to get database sizes in all SQL Server instances using PowerShell</p>
<h2 id="8">Database Files Sizes in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> &nbsp;<span class="kw1">table</span> #FileSizes <span class="br0">&#40;</span>DBName sysname, <span class="br0">&#91;</span><span class="kw1">File</span> Name<span class="br0">&#93;</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>, <span class="br0">&#91;</span>Physical Name<span class="br0">&#93;</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>,
<span class="kw1">Size</span> <span class="kw1">decimal</span><span class="br0">&#40;</span><span class="nu0">12</span>,<span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">''</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">'USE'</span> &nbsp;<span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into #FileSizes</span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">', Name, Physical_Name, size/1024.0 from sys.database_files '</span> 
<span class="kw1">from</span> sys.<span class="me1">databases</span>
&nbsp;
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> #FileSizes <span class="kw1">order</span> <span class="kw1">by</span> DBName, <span class="br0">&#91;</span><span class="kw1">File</span> Name<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create  table #FileSizes (DBName sysname, [File Name] varchar(max), [Physical Name] varchar(max),
Size decimal(12,2))
declare @SQL nvarchar(max)
set @SQL = ''
select @SQL = @SQL + 'USE'  + QUOTENAME(name) + '
insert into #FileSizes
select ' + QUOTENAME(name,'''') + ', Name, Physical_Name, size/1024.0 from sys.database_files ' 
from sys.databases

execute (@SQL)
select * from #FileSizes order by DBName, [File Name]</pre></div></div>

<p>&nbsp;</p>
<p>You can also find the script to show all database sizes using sp_MsForEachDB <a href="http://www.kodyaz.com/articles/list-database-size-using-sql-server-sp_msforeachdb.aspx">here</a>. See also this <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/226bbffc-2cfa-4fa8-8873-48dec6b5f17f">relevant thread</a> at MSDN.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">Sql</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span><span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'UNION ALL </span>
<span class="st0">'</span> ,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'SELECT '</span><span class="st0">''</span> <span class="sy0">+</span> name <span class="sy0">+</span> <span class="st0">''</span><span class="st0">' AS DBNAME,'</span> <span class="sy0">+</span> 
<span class="st0">'sum(size * 8 /1024.0) AS MB from '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.dbo.sysfiles'</span> 
<span class="kw1">from</span> sys.<span class="me1">databases</span>
<span class="kw1">order</span> <span class="kw1">by</span> name
&nbsp;
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @Sql varchar(max)
select @SQL =coalesce(@SQL + char(13) + 'UNION ALL 
' ,'') + 'SELECT ''' + name + ''' AS DBNAME,' + 
'sum(size * 8 /1024.0) AS MB from ' + quotename(name) + '.dbo.sysfiles' 
from sys.databases
order by name

execute (@SQL)</pre></div></div>

<p>&nbsp;</p>
<h2 id="9">Database Files Sizes in All Databases and used space</h2>
<p>Note, that this script assumes that database files have the same name as the database itself. If this is not true, this script will not return correct result.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> #Test <span class="br0">&#40;</span>DbName sysname, TotalSize <span class="kw1">decimal</span><span class="br0">&#40;</span><span class="nu0">20</span>,<span class="nu0">2</span><span class="br0">&#41;</span>, Used <span class="kw1">decimal</span><span class="br0">&#40;</span><span class="nu0">20</span>,<span class="nu0">2</span><span class="br0">&#41;</span>, <span class="br0">&#91;</span><span class="kw1">free</span> <span class="kw1">space</span> percentage<span class="br0">&#93;</span> <span class="kw1">decimal</span><span class="br0">&#40;</span><span class="nu0">20</span>,<span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">'USE '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into #Test</span>
<span class="st0">select DB.name, ssf.size*8 as total, </span>
<span class="st0">FILEPROPERTY (AF.name, '</span><span class="st0">'spaceused'</span><span class="st0">')*8 as used, </span>
<span class="st0">((ssf.size*8) - (FILEPROPERTY (AF.name, '</span><span class="st0">'spaceused'</span><span class="st0">')*8))*100/(ssf.size*8) as [free space percentage]</span>
<span class="st0">from sys.sysALTfiles AF </span>
<span class="st0">inner join sys.sysfiles ssf on ssf.name=AF.name COLLATE SQL_Latin1_General_CP1_CI_AS</span>
<span class="st0">INNER JOIN sys.databases DB ON AF.dbid=DB.database_id </span>
<span class="st0">where ssf.groupid&lt;&gt;1'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span>
&nbsp;
<span class="kw1">execute</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> #Test <span class="kw1">order</span> <span class="kw1">by</span> DbName </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table #Test (DbName sysname, TotalSize decimal(20,2), Used decimal(20,2), [free space percentage] decimal(20,2))

declare @SQL nvarchar(max)
select @SQL = coalesce(@SQL,'') + 
'USE ' + QUOTENAME(Name) + '
insert into #Test
select DB.name, ssf.size*8 as total, 
FILEPROPERTY (AF.name, ''spaceused'')*8 as used, 
((ssf.size*8) - (FILEPROPERTY (AF.name, ''spaceused'')*8))*100/(ssf.size*8) as [free space percentage]
from sys.sysALTfiles AF 
inner join sys.sysfiles ssf on ssf.name=AF.name COLLATE SQL_Latin1_General_CP1_CI_AS
INNER JOIN sys.databases DB ON AF.dbid=DB.database_id 
where ssf.groupid&lt;&gt;1' from sys.databases

execute(@SQL)

select * from #Test order by DbName </pre></div></div>

<p>This script will backup all databases (using compression):</p>
<h2 id="10">Backup All Databases with Compression (SQL 2008+)</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="de1"><pre class="de1"><span class="kw1">Declare</span> @ToExecute <span class="kw1">nvarChar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>;
<span class="kw1">declare</span> @cBackupPath <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span> <span class="sy0">=</span> N<span class="st0">'D:\SQL Server Databases\SQL 2014\Backup'</span>;
&nbsp;
<span class="kw1">Select</span> @ToExecute <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'Backup Database '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span><span class="br0">&#41;</span> <span class="sy0">+</span>
<span class="st0">' To Disk = '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>@cBackupPath <span class="sy0">+</span> <span class="br0">&#91;</span>Name<span class="br0">&#93;</span> <span class="sy0">+</span> <span class="st0">'.bak'</span>,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">WITH NOFORMAT, NOINIT,</span>
<span class="st0">SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10;'</span>
&nbsp;
<span class="kw1">From</span> sys.<span class="me1">databases</span>
&nbsp;
<span class="kw1">Where</span> <span class="br0">&#91;</span>Name<span class="br0">&#93;</span> Not In <span class="br0">&#40;</span><span class="st0">'tempdb'</span><span class="br0">&#41;</span> and <span class="kw2">databasepropertyex</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>Name<span class="br0">&#93;</span>,<span class="st0">'Status'</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="st0">'online'</span>
<span class="kw1">order</span> <span class="kw1">by</span> <span class="br0">&#91;</span>name<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">for</span> xml <span class="kw1">path</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span>, type<span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'.'</span>, <span class="st0">'nvarchar(max)'</span><span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">print</span> @ToExecute
&nbsp;
<span class="kw1">Execute</span> <span class="br0">&#40;</span>@ToExecute<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">Declare @ToExecute nvarChar(max);
declare @cBackupPath nvarchar(max) = N'D:\SQL Server Databases\SQL 2014\Backup';

Select @ToExecute = (select CHAR(13) + CHAR(10) + CHAR(13) + CHAR(10) + 'Backup Database ' + quotename([Name]) +
' To Disk = ' + quotename(@cBackupPath + [Name] + '.bak','''') + '
WITH NOFORMAT, NOINIT,
SKIP, NOREWIND, NOUNLOAD, COMPRESSION, STATS = 10;'

From sys.databases

Where [Name] Not In ('tempdb') and databasepropertyex ([Name],'Status') = 'online'
order by [name]

for xml path(''), type).value('.', 'nvarchar(max)');

print @ToExecute

Execute (@ToExecute)</pre></div></div>

<p>&nbsp;</p>
<h2 id="11">All Schema Names in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @<span class="kw1">Sql</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">create</span> <span class="kw1">table</span> AllDBSchemas <span class="br0">&#40;</span><span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span> sysname, <span class="br0">&#91;</span><span class="kw1">Schema</span> Name<span class="br0">&#93;</span> sysname<span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> @<span class="kw1">Sql</span> <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">Sql</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into AllDBSchemas</span>
&nbsp;
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as [DB Name], [Name] as [Schema Name] from '</span> <span class="sy0">+</span> 
<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.schemas order by [DB Name],[Name];'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span>
<span class="kw1">order</span> <span class="kw1">by</span> name
&nbsp;
<span class="kw1">execute</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> AllDBSchemas <span class="kw1">order</span> <span class="kw1">by</span> <span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="kw1">SCHEMA</span> NAME<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @Sql nvarchar(max)
create table AllDBSchemas ([DB Name] sysname, [Schema Name] sysname)

select @Sql = coalesce(@Sql,'') + '
insert into AllDBSchemas

select ' + QUOTENAME(name,'''') + ' as [DB Name], [Name] as [Schema Name] from ' + 
QUOTENAME(Name) + '.sys.schemas order by [DB Name],[Name];' from sys.databases
order by name

execute(@SQL)

select * from AllDBSchemas order by [DB Name],[SCHEMA NAME]</pre></div></div>

<p>&nbsp;</p>
<h2 id="12">List of All Tables in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> AllTables <span class="br0">&#40;</span><span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span> sysname, <span class="br0">&#91;</span><span class="kw1">Schema</span> Name<span class="br0">&#93;</span> sysname, <span class="br0">&#91;</span><span class="kw1">Table</span> Name<span class="br0">&#93;</span> sysname<span class="br0">&#41;</span>
&nbsp;
<span class="kw1">DECLARE</span> @<span class="kw1">SQL</span> <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into AllTables</span>
&nbsp;
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as [DB Name], [Table_Schema] as [Table Schema], [Table_Name] as [Table Name] from '</span> <span class="sy0">+</span>
<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.INFORMATION_SCHEMA.Tables;'</span> <span class="kw1">FROM</span> sys.<span class="me1">databases</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> name
&nbsp;
<span class="kw1">EXECUTE</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> AllTables <span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="kw1">SCHEMA</span> NAME<span class="br0">&#93;</span>, <span class="br0">&#91;</span><span class="kw1">Table</span> Name<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE AllTables ([DB Name] sysname, [Schema Name] sysname, [Table Name] sysname)

DECLARE @SQL NVARCHAR(MAX)
 
SELECT @SQL = COALESCE(@SQL,'') + '
insert into AllTables
 
select ' + QUOTENAME(name,'''') + ' as [DB Name], [Table_Schema] as [Table Schema], [Table_Name] as [Table Name] from ' +
QUOTENAME(Name) + '.INFORMATION_SCHEMA.Tables;' FROM sys.databases
ORDER BY name
 
EXECUTE(@SQL)
 
SELECT * FROM AllTables ORDER BY [DB Name],[SCHEMA NAME], [Table Name]</pre></div></div>

<p>Alternative way to get all tables in all databases:</p>
<h2 id="13">List of All Tables in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">if</span> <span class="kw2">object_ID</span><span class="br0">&#40;</span><span class="st0">'TempDB..#AllTables'</span>,<span class="st0">'U'</span><span class="br0">&#41;</span> <span class="kw1">IS</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">drop</span> <span class="kw1">table</span> #AllTables
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> #AllTables <span class="br0">&#40;</span><span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span> sysname, <span class="br0">&#91;</span><span class="kw1">Schema</span> Name<span class="br0">&#93;</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="nu0">128</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>, <span class="br0">&#91;</span><span class="kw1">Table</span> Name<span class="br0">&#93;</span> sysname, create_date <span class="kw1">datetime</span>, modify_date <span class="kw1">datetime</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">DECLARE</span> @<span class="kw1">SQL</span> <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'USE '</span> <span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">insert into #AllTables </span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' as [DB Name], schema_name(schema_id) as [Table Schema], [Name] as [Table Name], Create_Date, Modify_Date</span>
<span class="st0"> from '</span> <span class="sy0">+</span>
<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.Tables;'</span> <span class="kw1">FROM</span> sys.<span class="me1">databases</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> name
<span class="co1">--print @SQL </span>
<span class="kw1">EXECUTE</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">if object_ID('TempDB..#AllTables','U') IS NOT NULL drop table #AllTables
CREATE TABLE #AllTables ([DB Name] sysname, [Schema Name] nvarchar(128) NULL, [Table Name] sysname, create_date datetime, modify_date datetime)

DECLARE @SQL NVARCHAR(MAX)
 
SELECT @SQL = COALESCE(@SQL,'') + 'USE ' + quotename(name) + '
insert into #AllTables 
select ' + QUOTENAME(name,'''') + ' as [DB Name], schema_name(schema_id) as [Table Schema], [Name] as [Table Name], Create_Date, Modify_Date
 from ' +
QUOTENAME(Name) + '.sys.Tables;' FROM sys.databases
ORDER BY name
--print @SQL 
EXECUTE(@SQL)</pre></div></div>

<h2 id="14">List of all Stored Procedures in All Databases</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> #SPList <span class="br0">&#40;</span><span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span> sysname, <span class="br0">&#91;</span>SP Name<span class="br0">&#93;</span> sysname, create_date <span class="kw1">datetime</span>, modify_date <span class="kw1">datetime</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">''</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">' insert into #SPList </span>
<span class="st0">select '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name, <span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">', name, create_date, modify_date</span>
<span class="st0">from '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.procedures'</span> <span class="kw1">from</span> sys.<span class="me1">databases</span>
&nbsp;
<span class="kw1">execute</span> <span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> #SPList <span class="kw1">order</span> <span class="kw1">by</span> <span class="br0">&#91;</span>DB Name<span class="br0">&#93;</span>, <span class="br0">&#91;</span>SP Name<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table #SPList ([DB Name] sysname, [SP Name] sysname, create_date datetime, modify_date datetime)

declare @SQL nvarchar(max)
set @SQL = ''
select @SQL = @SQL + ' insert into #SPList 
select ' + QUOTENAME(name, '''') + ', name, create_date, modify_date
from ' + QUOTENAME(name) + '.sys.procedures' from sys.databases

execute (@SQL)

select * from #SPList order by [DB Name], [SP Name]</pre></div></div>

<h2 id="15">Database Files Growth</h2>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="de1"><pre class="de1"><span class="co1">--select * from sys.sysfiles &nbsp;</span>
&nbsp;
<span class="kw1">declare</span> @<span class="kw1">SQL</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>
<span class="kw1">select</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="kw1">coalesce</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">'</span>
<span class="st0">UNION ALL '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
&nbsp;
<span class="st0">'SELECT CONVERT(varchar(100),</span>
<span class="st0">SERVERPROPERTY('</span><span class="st0">'Servername'</span><span class="st0">')) AS Server, '</span> <span class="sy0">+</span> 
<span class="kw2">quotename</span><span class="br0">&#40;</span>name,<span class="st0">''</span><span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span><span class="st0">' &nbsp;as DatabaseName,</span>
<span class="st0"> &nbsp; &nbsp;CAST(name as varchar(128)) COLLATE SQL_Latin1_General_CP1_CI_AS as name,</span>
<span class="st0"> &nbsp; &nbsp;CAST(filename as varchar(128)) COLLATE SQL_Latin1_General_CP1_CI_AS as FileName,</span>
<span class="st0"> &nbsp; &nbsp;Autogrowth = '</span><span class="st0">'Autogrowth: '</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;+</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;CASE</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN (status &amp; 0x100000 = 0 AND CEILING((growth * 8192.0) / (1024.0 * 1024.0)) = 0.00) OR growth = 0 THEN '</span><span class="st0">'None'</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN status &amp; 0x100000 = 0 THEN '</span><span class="st0">'By '</span><span class="st0">' + </span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CONVERT(VARCHAR,CEILING((growth * 8192.0) / (1024.0 * 1024.0))) + '</span><span class="st0">' MB'</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE '</span><span class="st0">'By '</span><span class="st0">' + CONVERT(VARCHAR,growth) + '</span><span class="st0">' percent'</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;END</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;+</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;CASE</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN (status &amp; 0x100000 = 0 AND CEILING((growth * 8192.0) / (1024.0 * 1024.0)) = 0.00) OR growth = 0 THEN '</span><span class="st0">''</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;WHEN CAST([maxsize] * 8.0 / 1024 AS DEC(20,2)) &lt;= 0.00 THEN '</span><span class="st0">', unrestricted growth'</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ELSE '</span><span class="st0">', restricted growth to '</span><span class="st0">' + CAST(CAST([maxsize] * 8.0 / 1024 AS DEC(20)) AS VARCHAR) + '</span><span class="st0">' MB'</span><span class="st0">'</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp;END</span>
<span class="st0">FROM '</span> &nbsp;<span class="sy0">+</span> <span class="kw2">quotename</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'.sys.sysfiles &nbsp;s'</span>
<span class="kw1">from</span> sys.<span class="me1">databases</span>
&nbsp;
<span class="kw1">set</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">' </span>
<span class="st0">ORDER BY DatabaseName'</span>
&nbsp;
<span class="kw1">print</span> @<span class="kw1">SQL</span>
&nbsp;
<span class="kw1">execute</span><span class="br0">&#40;</span>@<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">--select * from sys.sysfiles  

declare @SQL nvarchar(max)
select @SQL = coalesce(@SQL + '
UNION ALL ','') + 

'SELECT CONVERT(varchar(100),
SERVERPROPERTY(''Servername'')) AS Server, ' + 
quotename(name,'''') +'  as DatabaseName,
    CAST(name as varchar(128)) COLLATE SQL_Latin1_General_CP1_CI_AS as name,
    CAST(filename as varchar(128)) COLLATE SQL_Latin1_General_CP1_CI_AS as FileName,
    Autogrowth = ''Autogrowth: ''
        +
        CASE
            WHEN (status &amp; 0x100000 = 0 AND CEILING((growth * 8192.0) / (1024.0 * 1024.0)) = 0.00) OR growth = 0 THEN ''None''
            WHEN status &amp; 0x100000 = 0 THEN ''By '' + 
            CONVERT(VARCHAR,CEILING((growth * 8192.0) / (1024.0 * 1024.0))) + '' MB''
            ELSE ''By '' + CONVERT(VARCHAR,growth) + '' percent''
        END
        +
        CASE
            WHEN (status &amp; 0x100000 = 0 AND CEILING((growth * 8192.0) / (1024.0 * 1024.0)) = 0.00) OR growth = 0 THEN ''''
            WHEN CAST([maxsize] * 8.0 / 1024 AS DEC(20,2)) &lt;= 0.00 THEN '', unrestricted growth''
            ELSE '', restricted growth to '' + CAST(CAST([maxsize] * 8.0 / 1024 AS DEC(20)) AS VARCHAR) + '' MB''
        END
FROM '  + quotename(name) + '.sys.sysfiles  s'
from sys.databases

set @SQL = @SQL + ' 
ORDER BY DatabaseName'

print @SQL

execute(@SQL)</pre></div></div>

<p>The possibilities are endless.</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum.</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/how-to-get-information-about-all-databas/feed/</wfw:commentRss>
		<slash:comments>30</slash:comments>
		</item>
		<item>
		<title>Aggregates with multiple tables</title>
		<link>/index.php/datamgmt/datadesign/aggregates-with-multiple-tables/</link>
		<comments>/index.php/datamgmt/datadesign/aggregates-with-multiple-tables/#comments</comments>
		<pubDate>Sun, 25 Sep 2011 18:13:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/09/aggregates-with-multiple-tables/</guid>
		<description><![CDATA[In this blog post I would like to touch a very common problem which often trips up newbies and even serious SQL Professionals. I wanted to write this blog post for quite some time, but always put it aside. However, just a few days ago I have been dealin&#8230;]]></description>
				<content:encoded><![CDATA[<p>In this blog post I would like to touch a very common problem which often trips up newbies and even serious SQL Professionals. I wanted to write this blog post for quite some time, but always put it aside. However, just a few days ago I have been dealing with this problem at my work place, so I believe it&#8217;s time to discuss the problem.</p>
<p>For the discussion let&#8217;s consider AdventureWorks database SalesOrderHeader and SalesOrderDetail tables. To illustrate the problem, let&#8217;s assume that returns are handled in a different table with a structure very similar to SalesOrderDetail. And let&#8217;s assume there are about 20 percent of returns (the business must not be doing too well!).</p>
<p>Ok, to create the returns table in the Sales schema let&#8217;s use the following code:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="kw1">IDENTITY</span><span class="br0">&#40;</span><span class="kw1">INT</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ReturnID, D.<span class="me1">LineTotal</span> <span class="kw1">AS</span> ReturnTotal, D.<span class="me1">ProductID</span>, D.<span class="me1">OrderQty</span>, D.<span class="me1">UnitPrice</span>, D.<span class="me1">SalesOrderID</span>
<span class="kw1">INTO</span> Sales.<span class="me1">SalesReturns</span>
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderDetail</span> D TABLESAMPLE <span class="br0">&#40;</span><span class="nu0">20</span> <span class="kw1">PERCENT</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT IDENTITY(INT) AS ReturnID, D.LineTotal AS ReturnTotal, D.ProductID, D.OrderQty, D.UnitPrice, D.SalesOrderID
INTO Sales.SalesReturns
FROM Sales.SalesOrderDetail D TABLESAMPLE (20 PERCENT)</pre></div></div>

<p>Now, suppose we need to get quantity ordered and quantity returned as well as line total for both quantity and returned grouped by Customer ID. Let&#8217;s write the most intuitive query:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned quantity<span class="br0">&#93;</span>, &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">ReturnTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesReturns</span> R <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> R.<span class="me1">SalesOrderID</span> 
<span class="kw1">GROUP</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="kw1">ORDER</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT OH.CustomerID, 
       COALESCE(SUM(OD.OrderQty),0) AS [Ordered quantity],
       COALESCE(SUM(OD.LineTotal),0) AS [Ordered],
       COALESCE(SUM(R.OrderQty),0) AS [Returned quantity],       
       COALESCE(SUM(R.ReturnTotal),0) AS [Returned]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
LEFT JOIN Sales.SalesReturns R ON OH.SalesOrderID = R.SalesOrderID 
GROUP BY OH.CustomerID 
ORDER BY OH.CustomerID </pre></div></div>

<p>Which gives us these results</p>
<div class="tables">
<center></p>
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Aggregate Query Results &#8211; Ordered and Returned</caption>
<tr>
<th align="right">CustomerID</th>
<th align="right">Ordered quantity</th>
<th align="right">Ordered</th>
<th align="right">Returned quantity</th>
<th align="right">Returned</th>
</tr>
<tr>
<td align="right">1</td>
<td align="right">882</td>
<td align="right">724610.142300</td>
<td align="right">857</td>
<td align="right">713619.368600</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">198</td>
<td align="right">25199.499392</td>
<td align="right">0</td>
<td align="right">0.000000</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">20140</td>
<td align="right">4084947.217763</td>
<td align="right">18916</td>
<td align="right">3814775.599788</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">8268</td>
<td align="right">4493242.544792</td>
<td align="right">7530</td>
<td align="right">4036924.558800</td>
</tr>
<tr>
<td align="right">5</td>
<td align="right">1190</td>
<td align="right">325894.561736</td>
<td align="right">973</td>
<td align="right">261739.811536</td>
</tr>
</table>
<p></center>
</div>
<p>Now, let&#8217;s verify these results by only running Ordered amounts.</p>
<p>Let&#8217;s run this query (I re-wrote using CTE for simplicity):</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">with</span> cte <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">GROUP</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> cte</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;with cte as (SELECT OH.CustomerID, 
       COALESCE(SUM(OD.OrderQty),0) AS [Ordered quantity],
       COALESCE(SUM(OD.LineTotal),0) AS [Ordered]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
GROUP BY OH.CustomerID 
)
SELECT * FROM cte</pre></div></div>

<p>which produces the following results:</p>
<div class="tables"> <center></p>
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Aggregate Query Results &#8211; Ordered only</caption>
<tr>
<th align="right">CustomerID</th>
<th align="right">Ordered quantity</th>
<th align="right">Ordered</th>
</tr>
<tr>
<td align="right">1</td>
<td align="right">121</td>
<td align="right">85177.081200</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">198</td>
<td align="right">25199.499392</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">1695</td>
<td align="right">361999.058170</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">980</td>
<td align="right">586524.947384</td>
</tr>
<tr>
<td align="right">5</td>
<td align="right">299</td>
<td align="right">86177.847024</td>
</tr>
</table>
<p> </center>
</div>
<p>We see that numbers differ dramatically. So, what did happen in our first query? Why did it produce such high numbers that have nothing to do with the real numbers?</p>
<p>The reason is that for each row of Ordered results we get N Returned rows and so the total number of rows per one customer became M*N, where M is number of Ordered rows and N number of Returned rows. Therefore our results get much higher numbers.</p>
<p>So, the rule I always employ when I need to do aggregates that will involve more than one table to JOIN is to produce the necessary results separately as derived tables or CTE and only then join them together to form final result.</p>
<p>Here is how our query works when I re-write it using this idea:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">WITH</span> Ordered <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">Group</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>,
&nbsp;
Returned <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">ReturnTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesReturns</span> R <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> R.<span class="me1">SalesOrderID</span>
<span class="kw1">Group</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="me1">CustomerID</span>, R.<span class="me1">CustomerID</span><span class="br0">&#41;</span> <span class="kw1">AS</span> CustomerID, 
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>, 
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Ordered O <span class="kw1">FULL</span> <span class="sy0">JOIN</span> Returned R <span class="kw1">ON</span> O.<span class="me1">CustomerID</span> <span class="sy0">=</span> R.<span class="me1">CustomerID</span> 
<span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="me1">CustomerID</span>, R.<span class="me1">CustomerID</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;WITH Ordered AS (SELECT OH.CustomerID, 
       COALESCE(SUM(OD.OrderQty),0) AS [Ordered Quantity],
       COALESCE(SUM(OD.LineTotal),0) AS [Ordered]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
Group BY OH.CustomerID 
),

Returned AS (SELECT OH.CustomerID, 
       COALESCE(SUM(R.OrderQty),0) AS [Returned Quantity],
       COALESCE(SUM(R.ReturnTotal),0) AS [Returned]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesReturns R ON OH.SalesOrderID = R.SalesOrderID
Group BY OH.CustomerID 
)

SELECT COALESCE(O.CustomerID, R.CustomerID) AS CustomerID, 
COALESCE(O.[Ordered Quantity],0) AS [Ordered Quantity],
COALESCE(O.[Ordered],0) AS [Ordered], 
COALESCE(R.[Returned Quantity],0) AS [Returned Quantity],
COALESCE(R.[Returned],0) AS [Returned]

FROM Ordered O FULL JOIN Returned R ON O.CustomerID = R.CustomerID 
ORDER BY COALESCE(O.CustomerID, R.CustomerID)</pre></div></div>

<p>with these correct now results:</p>
<div class="tables"> <center></p>
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Aggregate Query Results &#8211; Ordered and Returned</caption>
<tr>
<th align="right">CustomerID</th>
<th align="right">Ordered Quantity</th>
<th align="right">Ordered</th>
<th align="right">Returned Quantity</th>
<th align="right">Returned</th>
</tr>
<tr>
<td align="right">1</td>
<td align="right">121</td>
<td align="right">85177.081200</td>
<td align="right">44</td>
<td align="right">37199.802700</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">198</td>
<td align="right">25199.499392</td>
<td align="right">0</td>
<td align="right">0.000000</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">1695</td>
<td align="right">361999.058170</td>
<td align="right">471</td>
<td align="right">91827.440195</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">980</td>
<td align="right">586524.947384</td>
<td align="right">242</td>
<td align="right">130206.961392</td>
</tr>
<tr>
<td align="right">5</td>
<td align="right">299</td>
<td align="right">86177.847024</td>
<td align="right">82</td>
<td align="right">22023.096824</td>
</tr>
</table>
<p></center>
</div>
<p>I used the FULL JOIN just in case we may have Ordered items and no returns or vs. versa for the customer.</p>
<p>I received a question of how to write this code for SQL 2000. In SQL 2000 we can not use CTE (common table expressions), but we can use derived tables, so the code above will be re-written in this manner:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="me1">CustomerID</span>, R.<span class="me1">CustomerID</span><span class="br0">&#41;</span> <span class="kw1">AS</span> CustomerID,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">GROUP</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span>
<span class="br0">&#41;</span>O <span class="kw1">FULL</span> <span class="sy0">JOIN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">ReturnTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesReturns</span> R <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> R.<span class="me1">SalesOrderID</span>
<span class="kw1">GROUP</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span>
<span class="br0">&#41;</span> R <span class="kw1">ON</span> O.<span class="me1">CustomerID</span> <span class="sy0">=</span> R.<span class="me1">CustomerID</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="me1">CustomerID</span>, R.<span class="me1">CustomerID</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT COALESCE(O.CustomerID, R.CustomerID) AS CustomerID,
COALESCE(O.[Ordered Quantity],0) AS [Ordered Quantity],
COALESCE(O.[Ordered],0) AS [Ordered],
COALESCE(R.[Returned Quantity],0) AS [Returned Quantity],
COALESCE(R.[Returned],0) AS [Returned]
 
FROM (SELECT OH.CustomerID,
       COALESCE(SUM(OD.OrderQty),0) AS [Ordered Quantity],
       COALESCE(SUM(OD.LineTotal),0) AS [Ordered]
 
FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
GROUP BY OH.CustomerID
)O FULL JOIN (SELECT OH.CustomerID,
       COALESCE(SUM(R.OrderQty),0) AS [Returned Quantity],
       COALESCE(SUM(R.ReturnTotal),0) AS [Returned]
 
FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesReturns R ON OH.SalesOrderID = R.SalesOrderID
GROUP BY OH.CustomerID
) R ON O.CustomerID = R.CustomerID
ORDER BY COALESCE(O.CustomerID, R.CustomerID)</pre></div></div>

<p>So, hopefully you can now easily recognize the problem and apply the same idea when dealing with a similar situation.</p>
<p>Say, few days ago I looked into report. The number of joins used in the query made my head dizzy &#8211; I told right away that because of the JOINs the total results are not going to be correct.</p>
<p>So, how did I solve the problem? I included the totals using WINDOW AGGREGATE function in the CTE first and then added the rest of the JOINs to get the data needed for report.</p>
<p>Unfortunately, I am not sure if an easier method exists for reports in SSRS when we need to present information for customer orders, for example, but also display customer addresses (and there may be many addresses per customer). Obviously, we will not get correct totals if we will just sum the records &#8211; we need to apply some tricks, simplest of them will be to pre-calculate totals and include these fields as part of the returned dataset. I will be interested to know your solutions for this problem.</p>
<p>I should also mention another way to solve this query (assuming we also want to return the Customer name) by using OUTER APPLY query. </p>
<p>Here I am showing two different approaches for comparison. The first approach performs better.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">WITH</span> Ordered <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">Group</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>,
&nbsp;
Returned <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> OH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">ReturnTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesReturns</span> R <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> R.<span class="me1">SalesOrderID</span>
<span class="kw1">Group</span> <span class="kw1">BY</span> OH.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> C.<span class="me1">FirstName</span>, C.<span class="me1">LastName</span>, 
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>, 
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
<span class="co1">--INTO dbo.QueryResults</span>
<span class="kw1">FROM</span> Sales.<span class="me1">vIndividualCustomer</span> C
<span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Ordered O <span class="kw1">On</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
<span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Returned R <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> R.<span class="me1">CustomerID</span> 
<span class="kw1">ORDER</span> <span class="kw1">BY</span> C.<span class="me1">CustomerID</span> 
&nbsp;
&nbsp;
<span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> C.<span class="me1">CustomerID</span>, C.<span class="me1">FirstName</span>, C.<span class="me1">LastName</span>, &nbsp;
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>O.<span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>, 
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
<span class="kw1">COALESCE</span><span class="br0">&#40;</span>R.<span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
<span class="kw1">FROM</span> Sales.<span class="me1">vIndividualCustomer</span> C
<span class="sy0">OUTER</span> APPLY <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">OrderQty</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered Quantity<span class="br0">&#93;</span>,
<span class="kw2">SUM</span><span class="br0">&#40;</span>OD.<span class="me1">LineTotal</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Ordered<span class="br0">&#93;</span>
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH 
<span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderDetail</span> OD <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> OD.<span class="me1">SalesOrderID</span>
<span class="kw1">WHERE</span> OH.<span class="me1">CustomerID</span> <span class="sy0">=</span> C.<span class="me1">CustomerID</span><span class="br0">&#41;</span> O
&nbsp;
<span class="sy0">OUTER</span> APPLY <span class="br0">&#40;</span><span class="kw1">SELECT</span> 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">OrderQty</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned Quantity<span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>R.<span class="me1">ReturnTotal</span><span class="br0">&#41;</span>,<span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Returned<span class="br0">&#93;</span>
&nbsp;
<span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span> OH 
<span class="kw1">LEFT</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesReturns</span> R <span class="kw1">ON</span> OH.<span class="me1">SalesOrderID</span> <span class="sy0">=</span> R.<span class="me1">SalesOrderID</span>
<span class="kw1">WHERE</span> OH.<span class="me1">CustomerID</span> <span class="sy0">=</span> C.<span class="me1">CustomerID</span><span class="br0">&#41;</span> R
<span class="kw1">ORDER</span> <span class="kw1">BY</span> C.<span class="me1">CustomerID</span> </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;WITH Ordered AS (SELECT OH.CustomerID, 
       COALESCE(SUM(OD.OrderQty),0) AS [Ordered Quantity],
       COALESCE(SUM(OD.LineTotal),0) AS [Ordered]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
Group BY OH.CustomerID 
),

Returned AS (SELECT OH.CustomerID, 
       COALESCE(SUM(R.OrderQty),0) AS [Returned Quantity],
       COALESCE(SUM(R.ReturnTotal),0) AS [Returned]

FROM Sales.SalesOrderHeader OH LEFT JOIN Sales.SalesReturns R ON OH.SalesOrderID = R.SalesOrderID
Group BY OH.CustomerID 
)

SELECT TOP (10) C.FirstName, C.LastName, 
COALESCE(O.[Ordered Quantity],0) AS [Ordered Quantity],
COALESCE(O.[Ordered],0) AS [Ordered], 
COALESCE(R.[Returned Quantity],0) AS [Returned Quantity],
COALESCE(R.[Returned],0) AS [Returned]
--INTO dbo.QueryResults
FROM Sales.vIndividualCustomer C
LEFT JOIN Ordered O On C.CustomerID = O.CustomerID 
LEFT JOIN Returned R ON C.CustomerID = R.CustomerID 
ORDER BY C.CustomerID 


SELECT TOP (10) C.CustomerID, C.FirstName, C.LastName,  
COALESCE(O.[Ordered Quantity],0) AS [Ordered Quantity],
COALESCE(O.[Ordered],0) AS [Ordered], 
COALESCE(R.[Returned Quantity],0) AS [Returned Quantity],
COALESCE(R.[Returned],0) AS [Returned]
FROM Sales.vIndividualCustomer C
OUTER APPLY (SELECT SUM(OD.OrderQty) AS [Ordered Quantity],
SUM(OD.LineTotal) AS [Ordered]
FROM Sales.SalesOrderHeader OH 
LEFT JOIN Sales.SalesOrderDetail OD ON OH.SalesOrderID = OD.SalesOrderID
WHERE OH.CustomerID = C.CustomerID) O
 
OUTER APPLY (SELECT 
       COALESCE(SUM(R.OrderQty),0) AS [Returned Quantity],
       COALESCE(SUM(R.ReturnTotal),0) AS [Returned]

FROM Sales.SalesOrderHeader OH 
LEFT JOIN Sales.SalesReturns R ON OH.SalesOrderID = R.SalesOrderID
WHERE OH.CustomerID = C.CustomerID) R
ORDER BY C.CustomerID </pre></div></div>

<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/aggregates-with-multiple-tables/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		</item>
		<item>
		<title>Finding the Winning Streak</title>
		<link>/index.php/datamgmt/datadesign/finding-the-winning-streak/</link>
		<comments>/index.php/datamgmt/datadesign/finding-the-winning-streak/#comments</comments>
		<pubDate>Thu, 14 Jul 2011 00:32:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/07/finding-the-winning-streak/</guid>
		<description><![CDATA[Ok, I hope I got your attention with this title :)

I want to share my solution of an interesting problem I saw today at tek-tips forum SQL 2005: Find the longest sequence of events within a table]]></description>
				<content:encoded><![CDATA[<p>Ok, I hope I got your attention with this title <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>I want to share my solution of an interesting problem I saw today at tek-tips forum <a href="http://tek-tips.com/viewthread.cfm?qid=1654675&amp;page=1">SQL 2005: Find longest sequence of events within a table</a></p>
<p>Given the following table:</p>
<div class="tables">
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Team Table</caption>
<tr>
<th align="left">Team</th>
<th align="left">Date</th>
<th align="left">WiLose</th>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-01 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-07 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-13 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-19 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-25 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-01-31 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-02-06 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-02-12 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">A</td>
<td align="left">2010-02-18 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-01 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-07 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-13 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-19 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-25 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-01-31 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-02-06 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-02-12 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">2010-02-18 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-01 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-07 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-13 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-19 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-25 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-01-31 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-02-06 00:00:00.000</td>
<td align="left">Win</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-02-12 00:00:00.000</td>
<td align="left">Lose</td>
</tr>
<tr>
<td align="left">C</td>
<td align="left">2010-02-18 00:00:00.000</td>
<td align="left">Win</td>
</tr>
</table>
</div>
<p>find the biggest number of consecutive wins or loses regardless of the team.</p>
<p>Here is the code that creates our team table:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> team <span class="br0">&#40;</span> 
&nbsp; Team &nbsp; <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>, 
&nbsp; <span class="kw1">DATE</span> &nbsp; <span class="kw1">DATETIME</span>, 
&nbsp; WiLose <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">SET</span> DATEF<span class="sy0">OR</span>MAT &nbsp;dmy 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'01/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'07/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'13/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'19/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'25/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'31/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'06/02/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'12/02/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'A'</span>,<span class="st0">'18/02/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'01/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'07/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'13/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'19/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'25/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'31/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'06/02/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'12/02/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'B'</span>,<span class="st0">'18/02/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'01/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'07/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'13/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'19/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'25/01/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'31/01/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'06/02/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'12/02/2010'</span>,<span class="st0">'Lose'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> team 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="st0">'C'</span>,<span class="st0">'18/02/2010'</span>,<span class="st0">'Win'</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">SET</span> DATEF<span class="sy0">OR</span>MAT &nbsp;mdy 
&nbsp;
<span class="kw1">SELECT</span> <span class="sy0">*</span> 
<span class="kw1">FROM</span> &nbsp; team</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE team ( 
  Team   CHAR(1), 
  DATE   DATETIME, 
  WiLose VARCHAR(10)) 

SET DATEFORMAT  dmy 

INSERT INTO team 
VALUES     ('A','01/01/2010','Win') 

INSERT INTO team 
VALUES     ('A','07/01/2010','Lose') 

INSERT INTO team 
VALUES     ('A','13/01/2010','Lose') 

INSERT INTO team 
VALUES     ('A','19/01/2010','Lose') 

INSERT INTO team 
VALUES     ('A','25/01/2010','Lose') 

INSERT INTO team 
VALUES     ('A','31/01/2010','Lose') 

INSERT INTO team 
VALUES     ('A','06/02/2010','Win') 

INSERT INTO team 
VALUES     ('A','12/02/2010','Lose') 

INSERT INTO team 
VALUES     ('A','18/02/2010','Win') 

INSERT INTO team 
VALUES     ('B','01/01/2010','Lose') 

INSERT INTO team 
VALUES     ('B','07/01/2010','Win') 

INSERT INTO team 
VALUES     ('B','13/01/2010','Lose') 

INSERT INTO team 
VALUES     ('B','19/01/2010','Win') 

INSERT INTO team 
VALUES     ('B','25/01/2010','Win') 

INSERT INTO team 
VALUES     ('B','31/01/2010','Win') 

INSERT INTO team 
VALUES     ('B','06/02/2010','Win') 

INSERT INTO team 
VALUES     ('B','12/02/2010','Lose') 

INSERT INTO team 
VALUES     ('B','18/02/2010','Lose') 

INSERT INTO team 
VALUES     ('C','01/01/2010','Lose') 

INSERT INTO team 
VALUES     ('C','07/01/2010','Lose') 

INSERT INTO team 
VALUES     ('C','13/01/2010','Lose') 

INSERT INTO team 
VALUES     ('C','19/01/2010','Lose') 

INSERT INTO team 
VALUES     ('C','25/01/2010','Lose') 

INSERT INTO team 
VALUES     ('C','31/01/2010','Win') 

INSERT INTO team 
VALUES     ('C','06/02/2010','Win') 

INSERT INTO team 
VALUES     ('C','12/02/2010','Lose') 

INSERT INTO team 
VALUES     ('C','18/02/2010','Win') 

SET DATEFORMAT  mdy 

SELECT * 
FROM   team</pre></div></div>

<p>This problem is known as &#8216;finding islands of data&#8217;, and I always refer to this blog by Plamen Ratchev <a href="http://pratchev.blogspot.com/2010/02/refactoring-ranges.html">Refactoring Ranges</a> when I am facing such scenario.</p>
<p>The idea of a solution is to first identify the blocks of consecutive wins or loses by each team. Applying the idea from Plamen&#8217;s blog first step will be</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">WITH</span> cte <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="sy0">*</span>, 
ROW_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> 
<span class="br0">&#40;</span>
PARTITION <span class="kw1">BY</span> team <span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="kw1">DATE</span>
<span class="br0">&#41;</span> <span class="sy0">-</span> ROW_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span>PARTITION <span class="kw1">BY</span> team, wilose <span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="kw1">DATE</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>GroupID<span class="br0">&#93;</span>
<span class="kw1">FROM</span> team<span class="br0">&#41;</span>,</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;WITH cte AS (SELECT *, 
ROW_NUMBER() OVER 
(
PARTITION BY team ORDER BY DATE
) - ROW_NUMBER() OVER (PARTITION BY team, wilose ORDER BY DATE) AS [GroupID]
FROM team),</pre></div></div>

<p>By assigning GroupID we identified blocks of winning or losing streaks.</p>
<p>The last two steps are simple enough:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="de1"><pre class="de1"><span class="co1">-- Calculate Wins/Loses totals per each team/block</span>
cte1 <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> team, 
<span class="kw2">SUM</span><span class="br0">&#40;</span><span class="kw1">CASE</span> <span class="kw1">WHEN</span> WiLose <span class="sy0">=</span> <span class="st0">'Win'</span> <span class="kw1">THEN</span> <span class="nu0">1</span> <span class="kw1">ELSE</span> <span class="nu0">0</span> <span class="kw1">END</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Wins<span class="br0">&#93;</span>,
<span class="kw2">SUM</span><span class="br0">&#40;</span><span class="kw1">CASE</span> <span class="kw1">WHEN</span> WiLose <span class="sy0">=</span> <span class="st0">'Lose'</span> <span class="kw1">THEN</span> <span class="nu0">1</span> <span class="kw1">ELSE</span> <span class="nu0">0</span> <span class="kw1">END</span><span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Loses<span class="br0">&#93;</span>
<span class="kw1">FROM</span> cte
<span class="kw1">GROUP</span> <span class="kw1">BY</span> Team, GroupID<span class="br0">&#41;</span>,
&nbsp;
<span class="co1">-- Rank from highest to lowest wins / loses</span>
cteSummary <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="sy0">*</span>, RANK<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span><span class="kw1">ORDER</span> <span class="kw1">BY</span> Wins <span class="kw1">DESC</span><span class="br0">&#41;</span> <span class="kw1">AS</span> WinsRank,
RANK<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span><span class="kw1">ORDER</span> <span class="kw1">BY</span> Loses <span class="kw1">DESC</span><span class="br0">&#41;</span> <span class="kw1">AS</span> LosesRank
<span class="kw1">FROM</span> cte1<span class="br0">&#41;</span>
<span class="co1">-- Get final results</span>
<span class="kw1">SELECT</span> Team, <span class="br0">&#91;</span>Wins<span class="br0">&#93;</span>,<span class="br0">&#91;</span>Loses<span class="br0">&#93;</span>
&nbsp;<span class="kw1">FROM</span> cteSummary <span class="kw1">WHERE</span> WinsRank <span class="sy0">=</span> <span class="nu0">1</span> <span class="sy0">OR</span> LosesRank <span class="sy0">=</span> <span class="nu0">1</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> Team</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">-- Calculate Wins/Loses totals per each team/block
cte1 AS (SELECT team, 
SUM(CASE WHEN WiLose = 'Win' THEN 1 ELSE 0 END) AS [Wins],
SUM(CASE WHEN WiLose = 'Lose' THEN 1 ELSE 0 END) AS [Loses]
FROM cte
GROUP BY Team, GroupID),

-- Rank from highest to lowest wins / loses
cteSummary AS (SELECT *, RANK() OVER (ORDER BY Wins DESC) AS WinsRank,
RANK() OVER (ORDER BY Loses DESC) AS LosesRank
FROM cte1)
-- Get final results
SELECT Team, [Wins],[Loses]
 FROM cteSummary WHERE WinsRank = 1 OR LosesRank = 1
ORDER BY Team</pre></div></div>

<p>So, correctly identifying a known pattern helps to solve such problems very quickly.</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/finding-the-winning-streak/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>Finding Duplicates &#8211; Interesting twist</title>
		<link>/index.php/datamgmt/datadesign/finding-duplicates-interesting-twist/</link>
		<comments>/index.php/datamgmt/datadesign/finding-duplicates-interesting-twist/#comments</comments>
		<pubDate>Sun, 05 Jun 2011 23:48:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/06/finding-duplicates-interesting-twist/</guid>
		<description><![CDATA[A recent MSDN thread
presented a very interesting problem - find duplicates based on any 4 of the 5 columns and eliminate the duplicates.

Here is the data table we will be working with:


CREATE TABLE tblTEST ( 
  ID           INT    UNIQUE    N&#8230;]]></description>
				<content:encoded><![CDATA[<p>A recent <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/8ce895b9-11f1-494c-a63e-e25f08f93bd8">MSDN thread</a> presented a very interesting problem &#8211; find duplicates based on any 4 of the 5 columns and eliminate the duplicates.</p>
<p>Here is the data table we will be working with:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> tblTEST <span class="br0">&#40;</span> 
&nbsp; ID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">INT</span> &nbsp; &nbsp;<span class="kw1">UNIQUE</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
&nbsp; FirstColumn &nbsp;<span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
&nbsp; SecondColumn <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
&nbsp; ThirdColumn &nbsp;<span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
&nbsp; FourthColumn <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
&nbsp; FifthColumn &nbsp;<span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp; &nbsp;<span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> tblTEST 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span>ID, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FirstColumn, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SecondColumn, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ThirdColumn, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FourthColumn, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FifthColumn<span class="br0">&#41;</span> 
<span class="kw1">VALUES</span> &nbsp; &nbsp; <span class="br0">&#40;</span><span class="nu0">1</span>,<span class="st0">'value1'</span>,<span class="st0">'value2'</span>,<span class="st0">'value3'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">2</span>,<span class="st0">'value2'</span>,<span class="st0">'value3'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span>,<span class="st0">'value6'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">3</span>,<span class="st0">'value1'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span>,<span class="st0">'value8'</span>,<span class="st0">'value9'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">4</span>,<span class="st0">'value1'</span>,<span class="st0">'value2'</span>,<span class="st0">'value7'</span>,<span class="st0">'value8'</span>,<span class="st0">'value9'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">5</span>,<span class="st0">'value3'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span>,<span class="st0">'value6'</span>,<span class="st0">'value7'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">6</span>,<span class="st0">'value1'</span>,<span class="st0">'value2'</span>,<span class="st0">'value9'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">7</span>,<span class="st0">'value2'</span>,<span class="st0">'value3'</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span>,<span class="st0">'value11'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="nu0">8</span>,<span class="st0">'value4'</span>,<span class="st0">'value5'</span>,<span class="st0">'value3'</span>,<span class="st0">'value9'</span>,<span class="st0">'value1'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE tblTEST ( 
  ID           INT    UNIQUE    NOT NULL, 
  FirstColumn  VARCHAR(50)    NOT NULL, 
  SecondColumn VARCHAR(50)    NOT NULL, 
  ThirdColumn  VARCHAR(50)    NOT NULL, 
  FourthColumn VARCHAR(50)    NOT NULL, 
  FifthColumn  VARCHAR(50)    NOT NULL ) 

INSERT INTO tblTEST 
           (ID, 
            FirstColumn, 
            SecondColumn, 
            ThirdColumn, 
            FourthColumn, 
            FifthColumn) 
VALUES     (1,'value1','value2','value3','value4','value5'), 
           (2,'value2','value3','value4','value5','value6'), 
           (3,'value1','value4','value5','value8','value9'), 
           (4,'value1','value2','value7','value8','value9'), 
           (5,'value3','value4','value5','value6','value7'), 
           (6,'value1','value2','value9','value4','value5'), 
           (7,'value2','value3','value4','value5','value11'), 
           (8,'value4','value5','value3','value9','value1')</pre></div></div>

<p>Our test table:</p>
<div class="tables">
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Test Table with Duplicates</caption>
<tr>
<th>ID</th>
<th>FirstColumn</th>
<th>SecondColumn</th>
<th>ThirdColumn</th>
<th>FourthColumn</th>
<th>FifthColumn</th>
</tr>
<tr>
<td>1</td>
<td>value1</td>
<td>value2</td>
<td>value3</td>
<td>value4</td>
<td>value5</td>
</tr>
<tr>
<td>2</td>
<td>value2</td>
<td>value3</td>
<td>value4</td>
<td>value5</td>
<td>value6</td>
</tr>
<tr>
<td>3</td>
<td>value1</td>
<td>value4</td>
<td>value5</td>
<td>value8</td>
<td>value9</td>
</tr>
<tr>
<td>4</td>
<td>value1</td>
<td>value2</td>
<td>value7</td>
<td>value8</td>
<td>value9</td>
</tr>
<tr>
<td>5</td>
<td>value3</td>
<td>value4</td>
<td>value5</td>
<td>value6</td>
<td>value7</td>
</tr>
<tr>
<td>6</td>
<td>value1</td>
<td>value2</td>
<td>value9</td>
<td>value4</td>
<td>value5</td>
</tr>
<tr>
<td>7</td>
<td>value2</td>
<td>value3</td>
<td>value4</td>
<td>value5</td>
<td>value11</td>
</tr>
<tr>
<td>8</td>
<td>value4</td>
<td>value5</td>
<td>value3</td>
<td>value9</td>
<td>value1</td>
</tr>
</table>
</div>
<p>This problem is different from the typical find the duplicates problem and at first does not even seem solvable.</p>
<p>The first idea that comes to mind is to UNPIVOT values from these 5 columns into rows. This is simple enough with this code:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">with</span> UnPvt <span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> ID, ColValue <span class="kw1">FROM</span> tblTEST 
UNPIVOT <span class="br0">&#40;</span>ColValue <span class="kw1">FOR</span> ColName <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>FirstColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>SecondColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>ThirdColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>FourthColumn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>FifthColumn<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> unpvt<span class="br0">&#41;</span>,</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;with UnPvt AS (SELECT ID, ColValue FROM tblTEST 
UNPIVOT (ColValue FOR ColName IN ([FirstColumn],[SecondColumn],[ThirdColumn],[FourthColumn], [FifthColumn])) unpvt),</pre></div></div>

<p>The second step is also more or less clear &#8211; find possible duplicates by counting IDs partitioned by ColValue</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1">SameVals <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="sy0">*</span>, <span class="kw2">COUNT</span><span class="br0">&#40;</span>ID<span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span>PARTITION <span class="kw1">by</span> ColValue<span class="br0">&#41;</span> <span class="kw1">as</span> cntSame <span class="kw1">from</span> UnPvt<span class="br0">&#41;</span> X <span class="kw1">WHERE</span> cntSame <span class="sy0">&gt;=</span><span class="nu0">2</span><span class="br0">&#41;</span>,</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SameVals as (SELECT * FROM (select *, COUNT(ID) OVER (PARTITION by ColValue) as cntSame from UnPvt) X WHERE cntSame &gt;=2),</pre></div></div>

<p>Now, what can we do next? The next step was a road block for me. But then, an Eureka moment &#8211; we can use CROSS APPLY and find all records that have more than 4 values matching the current record values</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1">DupRecs <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> T.<span class="sy0">*</span>,S.<span class="me1">cntDups</span>, S.<span class="me1">ID</span> <span class="kw1">as</span> DupID
&nbsp;<span class="kw1">from</span> tblTEST T <span class="sy0">CROSS</span> APPLY <span class="br0">&#40;</span><span class="kw1">select</span> S.<span class="me1">ID</span>, <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw1">as</span> cntDups <span class="kw1">from</span> SameVals S
<span class="kw1">WHERE</span> T.<span class="me1">ID</span> <span class="sy0">&lt;</span> S.<span class="me1">ID</span> and S.<span class="me1">ColValue</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>T.<span class="me1">FirstColumn</span>,T.<span class="me1">SecondColumn</span>,T.<span class="me1">ThirdColumn</span>,T.<span class="me1">FourthColumn</span>, T.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> <span class="kw1">GROUP</span> <span class="kw1">BY</span> S.<span class="me1">ID</span><span class="br0">&#41;</span> S<span class="br0">&#41;</span>,
&nbsp;
Candidates <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="kw1">distinct</span> ID,DupID &nbsp;<span class="kw1">from</span> DupRecs <span class="kw1">where</span> cntDups <span class="sy0">&gt;=</span><span class="nu0">4</span><span class="br0">&#41;</span> </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DupRecs as (select T.*,S.cntDups, S.ID as DupID
 from tblTEST T CROSS APPLY (select S.ID, COUNT(*) as cntDups from SameVals S
WHERE T.ID &lt; S.ID and S.ColValue IN (T.FirstColumn,T.SecondColumn,T.ThirdColumn,T.FourthColumn, T.FifthColumn) GROUP BY S.ID) S),

Candidates as (select distinct ID,DupID  from DupRecs where cntDups &gt;=4) </pre></div></div>

<p>Ok, but do we want to delete all records identified in DupID column? Turned out, that it&#8217;s not even that simple. </p>
<p>Say, in our sample rows 1 &amp; 2 match. So, do we want to delete the row 2? Well, row 2 matches with the row 5. Which rows of 2/5 we delete and which to keep? That&#8217;s not easy at all.</p>
<p>So, my final select is</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="kw1">Distinct</span> DupID <span class="kw1">from</span> Candidates <span class="kw1">where</span> DupID not <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">select</span> ID <span class="kw1">from</span> Candidates<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select Distinct DupID from Candidates where DupID not IN (select ID from Candidates)</pre></div></div>

<p>This select will only produce real duplicates.</p>
<p>Now, this is the whole solution again as one statement:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1">;<span class="kw1">with</span> UnPvt <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> ID, ColValue <span class="kw1">from</span> tblTEST 
UNPIVOT <span class="br0">&#40;</span>ColValue <span class="kw1">for</span> ColName <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="br0">&#91;</span>FirstColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>SecondColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>ThirdColumn<span class="br0">&#93;</span>,<span class="br0">&#91;</span>FourthColumn<span class="br0">&#93;</span>, <span class="br0">&#91;</span>FifthColumn<span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> unpvt<span class="br0">&#41;</span>,
SameVals <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="sy0">*</span>, <span class="kw2">COUNT</span><span class="br0">&#40;</span>ID<span class="br0">&#41;</span> <span class="kw1">over</span> <span class="br0">&#40;</span>partition <span class="kw1">by</span> ColValue<span class="br0">&#41;</span> <span class="kw1">as</span> cntSame <span class="kw1">from</span> UnPvt<span class="br0">&#41;</span> X <span class="kw1">where</span> cntSame <span class="sy0">&gt;=</span><span class="nu0">2</span><span class="br0">&#41;</span>,
DupRecs <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> T.<span class="sy0">*</span>,S.<span class="me1">cntDups</span>, S.<span class="me1">ID</span> <span class="kw1">as</span> DupID
&nbsp;<span class="kw1">from</span> tblTEST T <span class="sy0">CROSS</span> APPLY <span class="br0">&#40;</span><span class="kw1">select</span> S.<span class="me1">ID</span>, <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="kw1">as</span> cntDups <span class="kw1">from</span> SameVals S
<span class="kw1">WHERE</span> T.<span class="me1">ID</span> <span class="sy0">&lt;</span> S.<span class="me1">ID</span> and S.<span class="me1">ColValue</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>T.<span class="me1">FirstColumn</span>,T.<span class="me1">SecondColumn</span>,T.<span class="me1">ThirdColumn</span>,T.<span class="me1">FourthColumn</span>, T.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> <span class="kw1">GROUP</span> <span class="kw1">BY</span> S.<span class="me1">ID</span><span class="br0">&#41;</span> S<span class="br0">&#41;</span>,
&nbsp;
Candidates <span class="kw1">as</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="kw1">distinct</span> ID,DupID &nbsp;<span class="kw1">from</span> DupRecs <span class="kw1">where</span> cntDups <span class="sy0">&gt;=</span><span class="nu0">4</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">select</span> <span class="kw1">Distinct</span> DupID <span class="kw1">from</span> Candidates <span class="kw1">where</span> DupID not <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">select</span> ID <span class="kw1">from</span> Candidates<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">;with UnPvt as (select ID, ColValue from tblTEST 
UNPIVOT (ColValue for ColName IN ([FirstColumn],[SecondColumn],[ThirdColumn],[FourthColumn], [FifthColumn])) unpvt),
SameVals as (select * from (select *, COUNT(ID) over (partition by ColValue) as cntSame from UnPvt) X where cntSame &gt;=2),
DupRecs as (select T.*,S.cntDups, S.ID as DupID
 from tblTEST T CROSS APPLY (select S.ID, COUNT(*) as cntDups from SameVals S
WHERE T.ID &lt; S.ID and S.ColValue IN (T.FirstColumn,T.SecondColumn,T.ThirdColumn,T.FourthColumn, T.FifthColumn) GROUP BY S.ID) S),

Candidates as (select distinct ID,DupID  from DupRecs where cntDups &gt;=4) 

select Distinct DupID from Candidates where DupID not IN (select ID from Candidates)</pre></div></div>

<p>Well, even the above solution is not quite right as now it doesn&#8217;t delete all duplicates.</p>
<p>After some more discussion in the mentioned thread and with the help of Peter Larsson, here is the solution that seems to work for the problem:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> &nbsp;@DupLoop <span class="kw1">INT</span> 
&nbsp;
<span class="kw1">SET</span> @DupLoop <span class="sy0">=</span> <span class="nu0">1</span> 
&nbsp;
<span class="kw1">WHILE</span> @DupLoop <span class="sy0">=</span> <span class="nu0">1</span> 
&nbsp; <span class="kw1">BEGIN</span> 
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">WITH</span> Dups 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="kw1">DISTINCT</span> a.<span class="me1">ID</span> <span class="kw1">AS</span> DuplicateID 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">FROM</span> &nbsp; dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> t 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> a 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ON</span> a.<span class="me1">ID</span> <span class="sy0">&gt;</span> t.<span class="me1">ID</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> a.<span class="me1">FirstColumn</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>t.<span class="me1">FirstColumn</span>,t.<span class="me1">SecondColumn</span>,t.<span class="me1">ThirdColumn</span>,t.<span class="me1">FourthColumn</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> b 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ON</span> b.<span class="me1">ID</span> <span class="sy0">=</span> a.<span class="me1">ID</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> b.<span class="me1">SecondColumn</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>t.<span class="me1">FirstColumn</span>,t.<span class="me1">SecondColumn</span>,t.<span class="me1">ThirdColumn</span>,t.<span class="me1">FourthColumn</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> c 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ON</span> c.<span class="me1">ID</span> <span class="sy0">=</span> a.<span class="me1">ID</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> c.<span class="me1">ThirdColumn</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>t.<span class="me1">FirstColumn</span>,t.<span class="me1">SecondColumn</span>,t.<span class="me1">ThirdColumn</span>,t.<span class="me1">FourthColumn</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> d 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ON</span> d.<span class="me1">ID</span> <span class="sy0">=</span> a.<span class="me1">ID</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> d.<span class="me1">FourthColumn</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>t.<span class="me1">FirstColumn</span>,t.<span class="me1">SecondColumn</span>,t.<span class="me1">ThirdColumn</span>,t.<span class="me1">FourthColumn</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; t.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">JOIN</span> dbo.<span class="me1">tblTEST</span> <span class="kw1">AS</span> e 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ON</span> e.<span class="me1">ID</span> <span class="sy0">=</span> a.<span class="me1">ID</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> e.<span class="me1">FifthColumn</span> <span class="sy0">IN</span> <span class="br0">&#40;</span>t.<span class="me1">FirstColumn</span>,t.<span class="me1">SecondColumn</span>,t.<span class="me1">ThirdColumn</span>,t.<span class="me1">FourthColumn</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;t.<span class="me1">FifthColumn</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">WHERE</span> &nbsp;<span class="kw1">CASE</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHEN</span> a.<span class="me1">ID</span> <span class="kw1">IS</span> <span class="sy0">NULL</span> <span class="kw1">THEN</span> <span class="nu0">0</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span> <span class="nu0">1</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span> <span class="sy0">+</span> <span class="kw1">CASE</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHEN</span> b.<span class="me1">ID</span> <span class="kw1">IS</span> <span class="sy0">NULL</span> <span class="kw1">THEN</span> <span class="nu0">0</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span> <span class="nu0">1</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span> <span class="sy0">+</span> <span class="kw1">CASE</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHEN</span> c.<span class="me1">ID</span> <span class="kw1">IS</span> <span class="sy0">NULL</span> <span class="kw1">THEN</span> <span class="nu0">0</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span> <span class="nu0">1</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span> <span class="sy0">+</span> <span class="kw1">CASE</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHEN</span> d.<span class="me1">ID</span> <span class="kw1">IS</span> <span class="sy0">NULL</span> <span class="kw1">THEN</span> <span class="nu0">0</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span> <span class="nu0">1</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span> <span class="sy0">+</span> <span class="kw1">CASE</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHEN</span> e.<span class="me1">ID</span> <span class="kw1">IS</span> <span class="sy0">NULL</span> <span class="kw1">THEN</span> <span class="nu0">0</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span> <span class="nu0">1</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span> <span class="sy0">&gt;=</span> <span class="nu0">4</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; <span class="kw1">DELETE</span> <span class="kw1">FROM</span> tblTEST 
&nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp; &nbsp; &nbsp; ID <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> &nbsp; <span class="kw1">TOP</span> <span class="br0">&#40;</span> <span class="nu0">1</span> <span class="br0">&#41;</span> DuplicateID 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">FROM</span> &nbsp; &nbsp; Dups 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">ORDER</span> <span class="kw1">BY</span> DuplicateID<span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">SELECT</span> @DupLoop <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span> 
&nbsp; <span class="kw1">END</span> 
&nbsp;
<span class="kw1">SELECT</span> <span class="sy0">*</span> 
<span class="kw1">FROM</span> &nbsp; tblTest</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE  @DupLoop INT 

SET @DupLoop = 1 

WHILE @DupLoop = 1 
  BEGIN 
     
     
    WITH Dups 
         AS (SELECT DISTINCT a.ID AS DuplicateID 
             FROM   dbo.tblTEST AS t 
                    LEFT JOIN dbo.tblTEST AS a 
                      ON a.ID &gt; t.ID 
                         AND a.FirstColumn IN (t.FirstColumn,t.SecondColumn,t.ThirdColumn,t.FourthColumn,
                                               t.FifthColumn) 
                    LEFT JOIN dbo.tblTEST AS b 
                      ON b.ID = a.ID 
                         AND b.SecondColumn IN (t.FirstColumn,t.SecondColumn,t.ThirdColumn,t.FourthColumn,
                                                t.FifthColumn) 
                    LEFT JOIN dbo.tblTEST AS c 
                      ON c.ID = a.ID 
                         AND c.ThirdColumn IN (t.FirstColumn,t.SecondColumn,t.ThirdColumn,t.FourthColumn,
                                               t.FifthColumn) 
                    LEFT JOIN dbo.tblTEST AS d 
                      ON d.ID = a.ID 
                         AND d.FourthColumn IN (t.FirstColumn,t.SecondColumn,t.ThirdColumn,t.FourthColumn,
                                                t.FifthColumn) 
                    LEFT JOIN dbo.tblTEST AS e 
                      ON e.ID = a.ID 
                         AND e.FifthColumn IN (t.FirstColumn,t.SecondColumn,t.ThirdColumn,t.FourthColumn,
                                               t.FifthColumn) 
             WHERE  CASE 
                      WHEN a.ID IS NULL THEN 0 
                      ELSE 1 
                    END + CASE 
                            WHEN b.ID IS NULL THEN 0 
                            ELSE 1 
                          END + CASE 
                                  WHEN c.ID IS NULL THEN 0 
                                  ELSE 1 
                                END + CASE 
                                        WHEN d.ID IS NULL THEN 0 
                                        ELSE 1 
                                      END + CASE 
                                              WHEN e.ID IS NULL THEN 0 
                                              ELSE 1 
                                            END &gt;= 4) 
    DELETE FROM tblTEST 
    WHERE       ID IN (SELECT   TOP ( 1 ) DuplicateID 
                       FROM     Dups 
                       ORDER BY DuplicateID) 
     
    SELECT @DupLoop = @@ROWCOUNT 
  END 

SELECT * 
FROM   tblTest</pre></div></div>

<p>Well, hopefully this was interesting to read as for me trying to solve such problem. Thanks for listening!</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/finding-duplicates-interesting-twist/feed/</wfw:commentRss>
		<slash:comments>8</slash:comments>
		</item>
		<item>
		<title>Dynamic PIVOT on multiple columns</title>
		<link>/index.php/datamgmt/datadesign/dynamic-pivot-on-multiple-columns/</link>
		<comments>/index.php/datamgmt/datadesign/dynamic-pivot-on-multiple-columns/#comments</comments>
		<pubDate>Sun, 29 May 2011 14:42:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/05/dynamic-pivot-on-multiple-columns/</guid>
		<description><![CDATA[In this blog post I want to discuss a problem I encounter frequently in SQL related forums - how to perform dynamic PIVOT involving multiple columns using pure T-SQL solution.

With the introduction of PIVOT operator in SQL 2005, it became very easy t&#8230;]]></description>
				<content:encoded><![CDATA[<p>In this blog post I want to discuss a problem I encounter frequently in SQL related forums &#8211; how to perform dynamic PIVOT involving multiple columns using pure T-SQL solution. In SQL Server Reporting Services this functionality can be easily achieved using <a href="http://msdn.microsoft.com/en-us/library/ms157334(SQL.100).aspx">Matrix template</a>.</p>
<p>With the introduction of PIVOT operator in SQL 2005, it became very easy to write queries that transform rows into columns. There are numerous articles on the Web as how to perform PIVOT and even dynamic PIVOT. However, most of these articles explain how to perform such queries for just one column. I want to expand the transformation for multiple columns.</p>
<p>The idea of a solution is quite simple &#8211; you need to generate the SQL dynamically. Since we want to use pivot on multiple columns, we need to use <a href="/index.php/DataMgmt/DataDesign/understanding-sql-server-2000-pivot">CASE based pivot</a>.</p>
<p>You need to keep in mind, that resulting query should have less than 1024 columns. You may build the check for number of columns into the query.</p>
<p>Now, every time I need to create a dynamic query, I need to know what is the final query I am going to arrive to. Having the idea in mind and printing the SQL command until I got it right helps to create the working query.</p>
<p>Let&#8217;s consider the first example based on the AdventureWorks SalesOrderHeader table.<br />
This code creates the table we&#8217;re going to transform &#8211; it gives us summary of orders and total due per each quarter:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> AdventureWorks 
&nbsp;
<span class="kw1">SELECT</span> &nbsp; <span class="kw2">DATEPART</span><span class="br0">&#40;</span>quarter,OrderDate<span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw2">DATEPART</span><span class="br0">&#40;</span><span class="kw1">YEAR</span>,OrderDate<span class="br0">&#41;</span> &nbsp; &nbsp;<span class="kw1">AS</span> <span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw2">COUNT</span><span class="br0">&#40;</span>SalesOrderID<span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">AS</span> <span class="br0">&#91;</span>Orders <span class="kw2">Count</span><span class="br0">&#93;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw2">SUM</span><span class="br0">&#40;</span>TotalDue<span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">AS</span> <span class="br0">&#91;</span>Total Due<span class="br0">&#93;</span> 
<span class="kw1">INTO</span> &nbsp; &nbsp; #SalesSummary 
<span class="kw1">FROM</span> &nbsp; &nbsp; Sales.<span class="me1">SalesOrderHeader</span> 
<span class="kw1">GROUP</span> <span class="kw1">BY</span> <span class="kw2">DATEPART</span><span class="br0">&#40;</span>quarter,OrderDate<span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw2">DATEPART</span><span class="br0">&#40;</span><span class="kw1">YEAR</span>,OrderDate<span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">SELECT</span> &nbsp; <span class="sy0">*</span> 
<span class="kw1">FROM</span> &nbsp; &nbsp; #SalesSummary 
<span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE AdventureWorks 

SELECT   DATEPART(quarter,OrderDate) AS [Quarter], 
         DATEPART(YEAR,OrderDate)    AS [Year], 
         COUNT(SalesOrderID)         AS [Orders Count], 
         SUM(TotalDue)               AS [Total Due] 
INTO     #SalesSummary 
FROM     Sales.SalesOrderHeader 
GROUP BY DATEPART(quarter,OrderDate), 
         DATEPART(YEAR,OrderDate) 

SELECT   * 
FROM     #SalesSummary 
ORDER BY [Year], 
         [Quarter]</pre></div></div>

<p>The #SalesSummary table lists count of orders and total due for each quarter and year.</p>
<p><center></p>
<div class="tables">
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Quarterly Orders Summary</caption>
<tr>
<th>Quarter</th>
<th>Year</th>
<th>Orders Count</th>
<th>Total Due</th>
</tr>
<tr>
<td align="right" style="width: 20%">3</td>
<td align="right" style="width: 20%">2001</td>
<td align="right" style="width: 20%">	621</td>
<td align="right" style="width: 20%">	$5,850,932.9483</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">	2001</td>
<td align="right">	758</td>
<td align="right">	$8,476,619.278</td>
</tr>
<tr>
<td align="right">1</td>
<td align="right">	2002</td>
<td align="right">	741</td>
<td align="right">	$7,379,686.3091</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">	2002</td>
<td align="right">	825</td>
<td align="right">	$8,210,285.1655</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">	2002</td>
<td align="right">	1054</td>
<td align="right">	$13,458,206.13</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">	2002</td>
<td align="right">	1072</td>
<td align="right">	$10,827,327.4904</td>
</tr>
<tr>
<td align="right">1</td>
<td align="right">	2003</td>
<td align="right">	1091</td>
<td align="right">	$8,550,831.8702</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">	2003</td>
<td align="right">	1260</td>
<td align="right">	$10,749,269.374</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">	2003</td>
<td align="right">	4152</td>
<td align="right">	$18,220,131.5285</td>
</tr>
<tr>
<td align="right">4</td>
<td align="right">	2003</td>
<td align="right">	5940</td>
<td align="right">	$16,787,382.3141</td>
</tr>
<tr>
<td align="right">1</td>
<td align="right">	2004</td>
<td align="right">	6087</td>
<td align="right">	$14,170,982.5455</td>
</tr>
<tr>
<td align="right">2</td>
<td align="right">	2004</td>
<td align="right">	6888</td>
<td align="right">	$17,969,750.9487</td>
</tr>
<tr>
<td align="right">3</td>
<td align="right">	2004</td>
<td align="right">	976</td>
<td align="right">	$56,178.9223</td>
</tr>
</table>
</div>
<p></center></p>
<p>Now, suppose we want to see these results horizontally. The following dynamic SQL produces the desired output:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> &nbsp;@<span class="kw1">SQL</span> &nbsp;<span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@Cols <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
<span class="kw1">SELECT</span> @Cols <span class="sy0">=</span> <span class="kw2">STUFF</span><span class="br0">&#40;</span><span class="br0">&#40;</span><span class="kw1">select</span> <span class="st0">', </span>
<span class="st0">SUM(CASE WHEN [Quarter]='</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' AND [Year] = '</span> <span class="sy0">+</span> 
<span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' THEN [Orders Count] ELSE 0 END) AS ['</span> <span class="sy0">+</span> 
<span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'-'</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' Orders], </span>
<span class="st0">SUM(CASE WHEN [Quarter]='</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' AND [Year] = '</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' THEN [Total Due] ELSE 0 END) AS ['</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">4</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'-'</span> <span class="sy0">+</span> 
<span class="kw1">CAST</span><span class="br0">&#40;</span><span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span> <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' Sales]'</span>
<span class="kw1">FROM</span> #SalesSummary 
<span class="kw1">ORDER</span> <span class="kw1">BY</span> <span class="br0">&#91;</span><span class="kw1">Year</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span>Quarter<span class="br0">&#93;</span> <span class="kw1">FOR</span> XML <span class="kw1">PATH</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span>,type<span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'.'</span>,<span class="st0">'varchar(max)'</span><span class="br0">&#41;</span>,<span class="nu0">1</span>,<span class="nu0">2</span>,<span class="st0">''</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SET</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">'SELECT '</span> <span class="sy0">+</span> @Cols <span class="sy0">+</span> <span class="st0">' &nbsp;FROM #SalesSummary'</span> 
&nbsp;
<span class="co1">--print @SQL </span>
<span class="kw1">EXECUTE</span><span class="br0">&#40;</span> @<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE  @SQL  NVARCHAR(MAX), 
         @Cols NVARCHAR(MAX)
         
SELECT @Cols = STUFF((select ', 
SUM(CASE WHEN [Quarter]=' + CAST([Quarter] as varchar(3)) + ' AND [Year] = ' + 
CAST([Year] as char(4)) + 
' THEN [Orders Count] ELSE 0 END) AS [' + 
CAST([Year] as char(4)) + '-' + CAST([Quarter] as varchar(3)) + 
' Orders], 
SUM(CASE WHEN [Quarter]=' + CAST([Quarter] as varchar(3)) + 
' AND [Year] = ' + CAST([Year] as char(4)) + 
' THEN [Total Due] ELSE 0 END) AS [' + CAST([Year] as char(4)) + '-' + 
CAST([Quarter] as varchar(3)) + ' Sales]'
FROM #SalesSummary 
ORDER BY [Year],[Quarter] FOR XML PATH(''),type).value('.','varchar(max)'),1,2,'')

SET @SQL = 'SELECT ' + @Cols + '  FROM #SalesSummary' 

--print @SQL 
EXECUTE( @SQL)</pre></div></div>

<p>It produces the transformed result (I show only few first columns):</p>
<div class="tables">
<table border="1" cellpadding ="6" cellspacing = "4">
<caption style="color:blue;font-weight:bold">Transformed result</caption>
<tr>
<th>2001-3 Orders</th>
<th>2001-3 Sales</th>
<th>2001-4 Orders</th>
<th>2001-4 Sales</th>
<th>2002-1 Orders</th>
<th>2002-1 Sales</th>
<th>2002-2 Orders</th>
<th>2002-2 Sales</th>
</tr>
<tr>
<td align="right">
621</td>
<td align="right">$5,850,932.9483</td>
<td align="right">758</td>
<td align="right">$8,476,619.278</td>
<td align="right">741</td>
<td align="right">	$7,379,686.3091</td>
<td align="right">825</td>
<td align="right">$8,210,285.1655</td>
</tr>
</table>
</div>
<p>You may want to un-comment PRINT @SQL statement if you want to see the generated command. I used XML PATH to concatenate rows into a string based on this blog post by Brad Schulz <a href="http://bradsruminations.blogspot.com/2009/10/making-list-and-checking-it-twice.html">Making a list and checking it twice</a>.</p>
<p>Another interesting problem was presented in this <a href="http://social.msdn.microsoft.com/Forums/hu-HU/transactsql/thread/f64ca6b6-9d7b-4863-86fa-591af1ec2b9f">MSDN Transact-SQL forum thread</a>:</p>
<p>For the claims table that has many integer columns, transform rows into columns. I demonstrate just the solution with the table creation script:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> tempdb 
&nbsp;
<span class="kw1">IF</span> <span class="kw2">OBJECT_ID</span><span class="br0">&#40;</span><span class="st0">'Claims'</span>,<span class="st0">'U'</span><span class="br0">&#41;</span> <span class="kw1">IS</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> 
&nbsp; <span class="kw1">DROP</span> <span class="kw1">TABLE</span> Claims 
&nbsp;
GO 
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> Claims <span class="br0">&#40;</span> 
&nbsp; Claim &nbsp;<span class="kw1">INT</span>, 
&nbsp; HCPC &nbsp; <span class="kw1">INT</span>, 
&nbsp; <span class="br0">&#91;</span>mod<span class="br0">&#93;</span> &nbsp;<span class="kw1">INT</span>, 
&nbsp; charge <span class="kw1">INT</span>, 
&nbsp; paid &nbsp; <span class="kw1">INT</span>, 
&nbsp; Qty &nbsp; &nbsp;<span class="kw1">INT</span><span class="br0">&#41;</span> 
&nbsp;
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> Claims 
<span class="kw1">SELECT</span> <span class="nu0">12345</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">99245</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">90</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">20</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">10</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">1</span> 
<span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="nu0">12345</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">99112</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">NULL</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">30</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">20</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">1</span> 
<span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="nu0">12345</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">99111</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">80</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">50</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">25</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">2</span> 
<span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="nu0">11112</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">99911</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">60</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">50</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">20</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">1</span> 
<span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="nu0">12222</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">99454</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">NULL</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">50</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">20</span>, 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="nu0">1</span> 
&nbsp;
<span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> Claims</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE tempdb 

IF OBJECT_ID('Claims','U') IS NOT NULL 
  DROP TABLE Claims 

GO 

CREATE TABLE Claims ( 
  Claim  INT, 
  HCPC   INT, 
  [mod]  INT, 
  charge INT, 
  paid   INT, 
  Qty    INT) 

INSERT INTO Claims 
SELECT 12345, 
       99245, 
       90, 
       20, 
       10, 
       1 
UNION ALL 
SELECT 12345, 
       99112, 
       NULL, 
       30, 
       20, 
       1 
UNION ALL 
SELECT 12345, 
       99111, 
       80, 
       50, 
       25, 
       2 
UNION ALL 
SELECT 11112, 
       99911, 
       60, 
       50, 
       20, 
       1 
UNION ALL 
SELECT 12222, 
       99454, 
       NULL, 
       50, 
       20, 
       1 

SELECT * FROM Claims</pre></div></div>

<p>The output is:<br />
<center></p>
<div class="tables">
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Claims table</caption>
<tr>
<th>Claim</th>
<th>HCPC</th>
<th>mod</th>
<th>Charge</th>
<th>Paid</th>
<th>Qty</th>
</tr>
<tr>
<td align="right" style="width: 20%">12345</td>
<td align="right" style="width: 20%">	99245</td>
<td align="right" style="width: 20%">	90</td>
<td align="right" style="width: 20%">	20</td>
<td align="right" style="width: 20%">	10</td>
<td align="right" style="width: 20%">	1</td>
</tr>
<tr>
<td align="right" style="width: 20%">12345</td>
<td align="right" style="width: 20%">	99112</td>
<td align="right" style="width: 20%">	NULL</td>
<td align="right" style="width: 20%">	30</td>
<td align="right" style="width: 20%">	20</td>
<td align="right" style="width: 20%">	1</td>
</tr>
<tr>
<td align="right" style="width: 20%">12345</td>
<td align="right" style="width: 20%">	99111</td>
<td align="right" style="width: 20%">	80</td>
<td align="right" style="width: 20%">	50</td>
<td align="right" style="width: 20%">	25</td>
<td align="right" style="width: 20%">	2</td>
</tr>
<tr>
<td align="right" style="width: 20%">11112</td>
<td align="right" style="width: 20%">	99911</td>
<td align="right" style="width: 20%">	60</td>
<td align="right" style="width: 20%">	50</td>
<td align="right" style="width: 20%">	20</td>
<td align="right" style="width: 20%">	1</td>
</tr>
<tr>
<td align="right" style="width: 20%">12222</td>
<td align="right" style="width: 20%">	99454</td>
<td align="right" style="width: 20%">	NULL</td>
<td align="right" style="width: 20%">	50</td>
<td align="right" style="width: 20%">	20</td>
<td align="right" style="width: 20%">	1</td>
</tr>
</table>
</div>
<p></center></p>
<p>And the following code transforms the result (as you see, I am using a loop and ROW_NUMBER() approach):</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> &nbsp;@<span class="kw1">SQL</span> &nbsp; &nbsp; <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@Loop &nbsp; &nbsp;<span class="kw1">INT</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@MaxRows <span class="kw1">INT</span> 
&nbsp;
<span class="kw1">SET</span> @<span class="kw1">Sql</span> <span class="sy0">=</span> <span class="st0">''</span> 
&nbsp;
<span class="kw1">SELECT</span> @MaxRows <span class="sy0">=</span> <span class="kw2">MAX</span><span class="br0">&#40;</span>MaxRow<span class="br0">&#41;</span> 
<span class="kw1">FROM</span> &nbsp; <span class="br0">&#40;</span><span class="kw1">SELECT</span> &nbsp; <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span> <span class="br0">&#41;</span> <span class="kw1">AS</span> MaxRow, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Claim 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; &nbsp; Claims 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">GROUP</span> <span class="kw1">BY</span> Claim<span class="br0">&#41;</span> X 
&nbsp;
<span class="kw1">SET</span> @Loop <span class="sy0">=</span> <span class="nu0">1</span> 
&nbsp;
<span class="kw1">WHILE</span> @Loop <span class="sy0">&lt;=</span> @MaxRows 
&nbsp; <span class="kw1">BEGIN</span> 
&nbsp; &nbsp; <span class="kw1">SELECT</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">', &nbsp; &nbsp; SUM(CASE WHEN Row = '</span> <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span>@Loop <span class="kw1">AS</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' THEN '</span> <span class="sy0">+</span> <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>Column_Name<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">' END) AS ['</span> <span class="sy0">+</span> COLUMN_NAME <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span>@Loop <span class="kw1">AS</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">']'</span>
&nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; <span class="sy0">IN</span>F<span class="sy0">OR</span>MATION_SCHEMA.<span class="me1">COLUMNS</span> 
&nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp;TABLE_Name <span class="sy0">=</span> <span class="st0">'Claims'</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">AND</span> COLUMN_NAME <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="st0">'Row'</span>,<span class="st0">'Claim'</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">SET</span> @Loop <span class="sy0">=</span> @Loop <span class="sy0">+</span> <span class="nu0">1</span> 
&nbsp; <span class="kw1">END</span> 
&nbsp;
<span class="co1">--PRINT @SQL </span>
<span class="kw1">SET</span> @<span class="kw1">SQL</span> <span class="sy0">=</span> <span class="st0">'SELECT Claim'</span> <span class="sy0">+</span> @<span class="kw1">SQL</span> <span class="sy0">+</span> <span class="st0">' FROM (select *, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;row_number() over (partition by Claim ORDER BY Claim) as Row &nbsp; &nbsp; &nbsp; &nbsp; FROM Claims) X GROUP BY Claim '</span> 
&nbsp;
<span class="kw1">PRINT</span> @<span class="kw1">SQL</span> 
&nbsp;
<span class="kw1">EXECUTE</span><span class="br0">&#40;</span> @<span class="kw1">SQL</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE  @SQL     NVARCHAR(MAX), 
         @Loop    INT, 
         @MaxRows INT 

SET @Sql = '' 

SELECT @MaxRows = MAX(MaxRow) 
FROM   (SELECT   COUNT(* ) AS MaxRow, 
                 Claim 
        FROM     Claims 
        GROUP BY Claim) X 

SET @Loop = 1 

WHILE @Loop &lt;= @MaxRows 
  BEGIN 
    SELECT @SQL = @SQL + ',     SUM(CASE WHEN Row = ' + CAST(@Loop AS VARCHAR(10)) + ' THEN ' + QUOTENAME(Column_Name) + ' END) AS [' + COLUMN_NAME + CAST(@Loop AS VARCHAR(10)) + ']'
    FROM   INFORMATION_SCHEMA.COLUMNS 
    WHERE  TABLE_Name = 'Claims' 
           AND COLUMN_NAME NOT IN ('Row','Claim') 
     
    SET @Loop = @Loop + 1 
  END 

--PRINT @SQL 
SET @SQL = 'SELECT Claim' + @SQL + ' FROM (select *,          row_number() over (partition by Claim ORDER BY Claim) as Row         FROM Claims) X GROUP BY Claim ' 

PRINT @SQL 

EXECUTE( @SQL)</pre></div></div>

<div class="tables">
<table border="1" cellpadding ="5" cellspacing = "5">
<caption style="color:blue;font-weight:bold">Transformed Output</caption>
<tr>
<th>Claim</th>
<th>HCPC1</th>
<th>mod1</th>
<th>Charge1</th>
<th>Paid1</th>
<th>Qty1</th>
<th>HCPC2</th>
<th>mod2</th>
<th>Charge2</th>
<th>Paid2</th>
<th>Qty2</th>
<th>HCPC3</th>
<th>mod3</th>
<th>Charge3</th>
<th>Paid3</th>
<th>Qty3</th>
</tr>
<tr>
<td align="right" style="width: 20%">11112</td>
<td align="right" style="width: 10%">	99911</td>
<td align="right" style="width: 10%">	60</td>
<td align="right" style="width: 10%">	50</td>
<td align="right" style="width: 10%">	20</td>
<td align="right">	1</td>
<td align="right" style="width: 20%">NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL	</td>
<td align="right" style="width: 20%">NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
</tr>
<tr>
<td align="right" style="width: 20%">12222</td>
<td align="right">	99454</td>
<td align="right">	NULL</td>
<td align="right">	50</td>
<td align="right">	20</td>
<td align="right">	1	</td>
<td align="right" style="width: 20%">NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
<td align="right">	NULL</td>
</tr>
<tr>
<td align="right" style="width: 20%">12345</td>
<td align="right">	99245</td>
<td align="right">	90</td>
<td align="right">	20</td>
<td align="right">	10</td>
<td align="right">	1	</td>
<td align="right" style="width: 20%">99112</td>
<td align="right">	NULL</td>
<td align="right">	30</td>
<td align="right">	20</td>
<td align="right">	1</td>
<td align="right">	99111</td>
<td align="right">	80</td>
<td align="right">	50</td>
<td align="right">	25</td>
<td align="right">	2</td>
</tr>
</table>
</div>
<p>I&#8217;ll post another recent problem found in the following MSDN thread <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/89d5954f-d518-4eb4-8c44-c124c6e1ee6d">Basic Crosstab Query</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SET</span> <span class="kw1">NOCOUNT</span> <span class="kw1">ON</span>;
GO
<span class="kw1">USE</span> tempdb;
GO
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> #T <span class="br0">&#40;</span>
StoreID <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
CriteriaNo <span class="kw1">int</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
<span class="kw1">Result</span> <span class="kw1">int</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>, 
Position <span class="kw1">int</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
<span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> <span class="br0">&#40;</span>StoreID, CriteriaNo<span class="br0">&#41;</span>
<span class="br0">&#41;</span>;
GO
<span class="kw1">INSERT</span> <span class="kw1">INTO</span> #T<span class="br0">&#40;</span>StoreID, CriteriaNo, <span class="kw1">Result</span>, Position<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="st0">'0001'</span>, <span class="nu0">9</span>, <span class="nu0">10</span>, <span class="nu0">1</span> <span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="st0">'0002'</span>, <span class="nu0">9</span>, <span class="nu0">12</span>, <span class="nu0">2</span> <span class="kw1">UNION</span> <span class="sy0">ALL</span> 
<span class="kw1">SELECT</span> <span class="st0">'0001'</span>, <span class="nu0">10</span>, <span class="nu0">5</span>, <span class="nu0">1</span> <span class="kw1">UNION</span> <span class="sy0">ALL</span>
<span class="kw1">SELECT</span> <span class="st0">'0002'</span>, <span class="nu0">10</span>, <span class="nu0">6</span>, <span class="nu0">2</span>;
GO
<span class="co1">-- dynamic</span>
<span class="kw1">DECLARE</span> @<span class="kw1">sql</span> <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">MAX</span><span class="br0">&#41;</span>, @Cols <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="kw2">max</span><span class="br0">&#41;</span>;
&nbsp;
<span class="kw1">SELECT</span> @Cols <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="st0">', '</span> <span class="sy0">+</span> <span class="st0">'MAX(case when CriteriaNo = '</span> <span class="sy0">+</span> <span class="kw1">CONVERT</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>, CriteriaNo<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' then Result else 0 end) AS CriteriaNo'</span> <span class="sy0">+</span> <span class="kw1">CONVERT</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>, CriteriaNo<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">', MAX(case when CriteriaNo = '</span> <span class="sy0">+</span> <span class="kw1">CONVERT</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>, CriteriaNo<span class="br0">&#41;</span> <span class="sy0">+</span> 
<span class="st0">' then Position else 0 end) AS CriteriaPosition'</span> <span class="sy0">+</span> <span class="kw1">CONVERT</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>, CriteriaNo<span class="br0">&#41;</span>
<span class="kw1">from</span> <span class="br0">&#40;</span><span class="kw1">select</span> <span class="kw1">distinct</span> CriteriaNo <span class="kw1">from</span> #T<span class="br0">&#41;</span> X <span class="kw1">ORDER</span> <span class="kw1">By</span> CriteriaNo 
<span class="kw1">FOR</span> XML <span class="kw1">PATH</span><span class="br0">&#40;</span><span class="st0">''</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">SET</span> @<span class="kw1">sql</span> <span class="sy0">=</span> <span class="st0">'SELECT StoreID'</span> <span class="sy0">+</span> @Cols <span class="sy0">+</span> <span class="st0">', SUM(Result) as PerformancePrint</span>
<span class="st0">FROM #T</span>
<span class="st0">GROUP BY StoreID'</span>
&nbsp;
<span class="kw1">EXECUTE</span><span class="br0">&#40;</span>@<span class="kw1">sql</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SET NOCOUNT ON;
GO
USE tempdb;
GO
CREATE TABLE #T (
StoreID char(5) NOT NULL,
CriteriaNo int NOT NULL,
Result int NOT NULL, 
Position int NOT NULL,
PRIMARY KEY (StoreID, CriteriaNo)
);
GO
INSERT INTO #T(StoreID, CriteriaNo, Result, Position)
SELECT '0001', 9, 10, 1 UNION ALL 
SELECT '0002', 9, 12, 2 UNION ALL 
SELECT '0001', 10, 5, 1 UNION ALL
SELECT '0002', 10, 6, 2;
GO
-- dynamic
DECLARE @sql nvarchar(MAX), @Cols nvarchar(max);

SELECT @Cols = (select ', ' + 'MAX(case when CriteriaNo = ' + CONVERT(varchar(20), CriteriaNo) + 
' then Result else 0 end) AS CriteriaNo' + CONVERT(varchar(20), CriteriaNo) + 
', MAX(case when CriteriaNo = ' + CONVERT(varchar(20), CriteriaNo) + 
' then Position else 0 end) AS CriteriaPosition' + CONVERT(varchar(20), CriteriaNo)
from (select distinct CriteriaNo from #T) X ORDER By CriteriaNo 
FOR XML PATH(''))

SET @sql = 'SELECT StoreID' + @Cols + ', SUM(Result) as PerformancePrint
FROM #T
GROUP BY StoreID'

EXECUTE(@sql)</pre></div></div>

<p>See also my TechNet WiKi article on this same topic with more code samples</p>
<p><a href="http://social.technet.microsoft.com/wiki/contents/articles/17510.t-sql-dynamic-pivot-on-multiple-columns.aspx">T-SQL: Dynamic Pivot on Multiple Columns</a></p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/dynamic-pivot-on-multiple-columns/feed/</wfw:commentRss>
		<slash:comments>24</slash:comments>
		</item>
		<item>
		<title>Get weekly transactions showing Monday&#8217;s date</title>
		<link>/index.php/datamgmt/datadesign/get-weekly-transactions-showing-monday/</link>
		<comments>/index.php/datamgmt/datadesign/get-weekly-transactions-showing-monday/#comments</comments>
		<pubDate>Mon, 11 Apr 2011 11:25:00 +0000</pubDate>
		<dc:creator><![CDATA[Naomi Nosonovsky]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>

		<guid isPermaLink="false">/index.php/2011/04/get-weekly-transactions-showing-monday/</guid>
		<description><![CDATA[This recent MSDN thread presented an interesting, as I believe, question:

For a predefined set of the Application IDs show the weekly transactions and display Monday's day for each week. The interesting twist in this common PIVOT query is to display&#8230;]]></description>
				<content:encoded><![CDATA[<p>This <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/5442bbd7-ef89-47f8-8ba9-eef04b6b5fe4/#aa2f0695-501b-43b2-a559-290f6c50b0c7">recent MSDN thread</a> presented an interesting, I believe, question:</p>
<p>For a predefined set of the Application IDs show the weekly transactions and display Monday&#8217;s day for each week. The interesting twist in this common PIVOT query is to display a Monday&#8217;s date for a week.</p>
<p>Rather than showing a solution for that particular thread, I show an AdventureWorks sample query. This query will return top 5 total amounts for each week by Customer (using SalesOrderHeader table).</p>
<p>Here is the query

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> &nbsp;@First_Bow &nbsp; &nbsp; &nbsp;<span class="kw1">DATETIME</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;@Week_Start_Day <span class="kw1">TINYINT</span> 
&nbsp;
<span class="kw1">SET</span> @Week_Start_Day <span class="sy0">=</span> <span class="nu0">2</span> 
&nbsp;
<span class="kw1">SELECT</span> @First_Bow <span class="sy0">=</span> <span class="kw1">CONVERT</span><span class="br0">&#40;</span><span class="kw1">DATETIME</span>,<span class="sy0">-</span><span class="nu0">53690</span> <span class="sy0">+</span> <span class="br0">&#40;</span><span class="br0">&#40;</span>@Week_Start_Day <span class="sy0">+</span> <span class="nu0">5</span><span class="br0">&#41;</span><span class="sy0">%</span>7<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">WITH</span> cte 
&nbsp; &nbsp; &nbsp;<span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> SH.<span class="me1">CustomerID</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; TotalDue &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">AS</span> Total, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">DATEADD</span><span class="br0">&#40;</span><span class="kw1">DAY</span>,<span class="br0">&#40;</span><span class="kw2">DATEDIFF</span><span class="br0">&#40;</span><span class="kw1">DAY</span>,@FIRST_BOW,OrderDate<span class="br0">&#41;</span> <span class="sy0">/</span> <span class="nu0">7</span><span class="br0">&#41;</span> <span class="sy0">*</span> <span class="nu0">7</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @FIRST_BOW<span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="br0">&#91;</span>MondayDate<span class="br0">&#93;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">FROM</span> &nbsp; Sales.<span class="me1">SalesOrderHeader</span> SH<span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp;cte2 
&nbsp; &nbsp; &nbsp;<span class="kw1">AS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> Total, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; MondayDate, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ROW_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">OVER</span><span class="br0">&#40;</span>PARTITION <span class="kw1">BY</span> MondayDate <span class="kw1">ORDER</span> <span class="kw1">BY</span> Total <span class="kw1">DESC</span>, CustomerID<span class="br0">&#41;</span> <span class="kw1">AS</span> <span class="kw1">Row</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">FROM</span> &nbsp; cte<span class="br0">&#41;</span> 
<span class="kw1">SELECT</span> <span class="sy0">*</span> 
<span class="kw1">FROM</span> &nbsp; cte2 
&nbsp; &nbsp; &nbsp; &nbsp;PIVOT 
&nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#40;</span><span class="kw2">SUM</span><span class="br0">&#40;</span>Total<span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FOR</span> <span class="kw1">Row</span> <span class="sy0">IN</span> <span class="br0">&#40;</span> <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="nu0">5</span><span class="br0">&#93;</span>,<span class="br0">&#91;</span><span class="nu0">6</span><span class="br0">&#93;</span> <span class="br0">&#41;</span> <span class="br0">&#41;</span> pvt</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE  @First_Bow      DATETIME, 
         @Week_Start_Day TINYINT 

SET @Week_Start_Day = 2 

SELECT @First_Bow = CONVERT(DATETIME,-53690 + ((@Week_Start_Day + 5)%7))

WITH cte 
     AS (SELECT SH.CustomerID, 
                TotalDue            AS Total, 
                DATEADD(DAY,(DATEDIFF(DAY,@FIRST_BOW,OrderDate) / 7) * 7, 
                        @FIRST_BOW) AS [MondayDate] 
         FROM   Sales.SalesOrderHeader SH), 
     cte2 
     AS (SELECT Total, 
                MondayDate, 
                ROW_NUMBER() 
                  OVER(PARTITION BY MondayDate ORDER BY Total DESC, CustomerID) AS Row 
         FROM   cte) 
SELECT * 
FROM   cte2 
       PIVOT 
       (SUM(Total) 
        FOR Row IN ( [1],[2],[3],[4],[5],[6] ) ) pvt</pre></div></div>

<p>The interesting part here is in determining the Monday&#8217;s day for each week. I decided to use a solution presented in SQL Server Forums <a href="http://www.sqlteam.com/forums/topic.asp?TOPIC_ID=47307">topic</a>.</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/get-weekly-transactions-showing-monday/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
	</channel>
</rss>
