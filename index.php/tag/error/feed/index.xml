<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>error &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/error/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>MDS: A Database Error Has Occurred</title>
		<link>/index.php/datamgmt/dbadmin/mssqlserveradmin/mds-a-database-error-has-occurred/</link>
		<comments>/index.php/datamgmt/dbadmin/mssqlserveradmin/mds-a-database-error-has-occurred/#comments</comments>
		<pubDate>Fri, 18 Apr 2014 09:20:36 +0000</pubDate>
		<dc:creator><![CDATA[Koen Verbeeck]]></dc:creator>
				<category><![CDATA[Master Data Services (MDS)]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[batch]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[mds]]></category>
		<category><![CDATA[syndicated]]></category>

		<guid isPermaLink="false">/?p=2583</guid>
		<description><![CDATA[I recently came across the following error message when I tried to look at the batches in the Integration Management section of MDS: 515: A database error has occurred. Please contact your system administrator Too bad I am the system administrator on that machine&#8230; Anyway, after some searching it came out the MDS stored procedure udpEntityStagingAllBatchesByModelGet throws [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>I recently came across the following error message when I tried to look at the batches in the Integration Management section of MDS:</p>
<pre>515: A database error has occurred. Please contact your system administrator</pre>
<p><a href="/wp-content/uploads/2014/04/koen_mdserror.png"><img class="alignnone size-full wp-image-2585" alt="koen_mdserror" src="/wp-content/uploads/2014/04/koen_mdserror.png" width="299" height="120" /></a></p>
<p>Too bad I am the system administrator on that machine&#8230;</p>
<p>Anyway, after some searching it came out the MDS stored procedure <em>udpEntityStagingAllBatchesByModelGet</em> throws a bit of a temper tantrum if one of the batch tags used in the staging process of a leaf member is NULL. You can check this in the table <strong>mdm.tblStgBatch</strong>.</p>
<p>Simple delete the offending batches and you&#8217;re good to go!</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DELETE</span> <span class="kw1">FROM</span> mdm.<span class="me1">tblStgBatch</span>
<span class="kw1">WHERE</span> BatchTag <span class="kw1">IS</span> <span class="sy0">NULL</span>;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DELETE FROM mdm.tblStgBatch
WHERE BatchTag IS NULL;</pre></div></div>

]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbadmin/mssqlserveradmin/mds-a-database-error-has-occurred/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Master Data Services stops working after an upgrade</title>
		<link>/index.php/datamgmt/dbadmin/mssqlserveradmin/master-data-services-stops-working/</link>
		<comments>/index.php/datamgmt/dbadmin/mssqlserveradmin/master-data-services-stops-working/#comments</comments>
		<pubDate>Wed, 27 Nov 2013 11:57:00 +0000</pubDate>
		<dc:creator><![CDATA[Koen Verbeeck]]></dc:creator>
				<category><![CDATA[Business Intelligence]]></category>
		<category><![CDATA[Master Data Services (MDS)]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[cumulative update]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[master data services]]></category>
		<category><![CDATA[mds]]></category>
		<category><![CDATA[sql server]]></category>
		<category><![CDATA[syndicated]]></category>
		<category><![CDATA[version]]></category>

		<guid isPermaLink="false">/index.php/2013/11/master-data-services-stops-working/</guid>
		<description><![CDATA[Recently some SQL Server instances at a client were upgraded to the latest cumulative update of SQL Server 2012 service pack 1. The reason for this update was the added functionality to create Power View reports on top of Analysis Services Multidimensio&#8230;]]></description>
				<content:encoded><![CDATA[<p style="text-align: justify;">Recently some SQL Server instances at a client were upgraded to the latest cumulative update of SQL Server 2012 service pack 1. The reason for this update was the added functionality to create Power View reports on top of Analysis Services Multidimensional. However, one of the instances also has Master Data Services (MDS) installed and after the update we couldn’t connect to the Master Data Manage anymore using the browser. There were two separate issues that had to be solved.</p>
<h3 style="text-align: justify;">Lost permissions</h3>
<p style="text-align: justify;">Somehow some permissions were lost during the upgrade, leading to the following error screen when trying to connect:</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/ErrorScreen1.jpg?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/ErrorScreen1.jpg?mtime=1385540686" alt="" width="773" height="406" /></a></p>
<p style="text-align: justify;">For once, the error message is crystal clear: <em>Cannot read configuration file due to insufficient permissions</em>. It even details the location of the web.config file. All we have to do now is add the local account <strong>MDS_ServiceAccounts</strong> if it isn’t added yet and give this account read permission on the config file.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/webconfigperms.png?mtime=1385540749"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/webconfigperms.png?mtime=1385540749" alt="" width="292" height="354" /></a></p>
<p style="text-align: justify;">This should get rid of the internal error message.</p>
<h3 style="text-align: justify;">MDS Database needs an upgrade</h3>
<p style="text-align: justify;">Unfortunately our problems weren’t over, as we were now greeted with another error screen when trying to connect.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/ErrorScreen2.jpg?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/ErrorScreen2.jpg?mtime=1385540686" alt="" width="646" height="240" /></a></p>
<p style="text-align: justify;">MDS now complains the database version (meaning SQL Server) has a more recent version than the client (which is MDS itself). Let’s take a look at the MDS Server Configuration Manager to see what is going on. Make sure you open the Configuration Manager using admin privileges. We can immediately see that something is wrong at the welcome screen:</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_1.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_1.png?mtime=1385540686" alt="" width="405" height="304" /></a></p>
<p style="text-align: justify;">It looks like no SQL Server database has been configured, while this was the case before the upgrade. Let’s go to the database configuration tab.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_2.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_2.png?mtime=1385540686" alt="" width="420" height="263" /></a></p>
<p style="text-align: justify;">Hmm, this looks pretty empty. Click on <em>Select Database…</em> and configure your MDS database in the prompt.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_3.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_3.png?mtime=1385540686" alt="" width="375" height="294" /></a></p>
<p style="text-align: justify;">The result already looks much better, except the error in bright red of course.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_4.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_4.png?mtime=1385540686" alt="" width="593" height="156" /></a></p>
<p style="text-align: justify;">This error says the database needs to be upgraded. Right next to it is a button called <em>Upgrade Database</em> so it seems obvious we’ll click that one. This will start a wizard which will guide you through the upgrade process. Hit <em>Next</em> until the upgrading begins. The wizard will fire off some scripts against the database to get it to consistent version.</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_7.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_7.png?mtime=1385540686" alt="" width="476" height="342" /></a></p>
<p style="text-align: justify;">Once the wizard has finished, everything looks OK in the configuration screen:</p>
<p style="text-align: justify;"><a href="/media/users/koenverbeeck/MDSStopsWorking/configscreen_8.png?mtime=1385540686"><img src="/wp-content/uploads/users/koenverbeeck/MDSStopsWorking/configscreen_8.png?mtime=1385540686" alt="" width="410" height="282" /></a></p>
<p style="text-align: justify;">Now we can connect back to the Master Data Manager using the browser or Excel (if you have the plug-in installed).</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbadmin/mssqlserveradmin/master-data-services-stops-working/feed/</wfw:commentRss>
		<slash:comments>3</slash:comments>
		</item>
		<item>
		<title>Fixing a SQL Server could not spawn FRunCM thread error</title>
		<link>/index.php/datamgmt/dbadmin/mssqlserveradmin/fixing-a-sql-server-could/</link>
		<comments>/index.php/datamgmt/dbadmin/mssqlserveradmin/fixing-a-sql-server-could/#comments</comments>
		<pubDate>Tue, 30 Apr 2013 12:28:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[encryption]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[fix]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2012]]></category>

		<guid isPermaLink="false">/index.php/2013/04/fixing-a-sql-server-could/</guid>
		<description><![CDATA[I had to change the account that some SQL Server boxes were using to run the SQL Server services. After I changed the account on one machine from DomainNameUser to DomainNameNewUser SQL Server wouldn't start up

In the error log I saw the following&#8230;]]></description>
				<content:encoded><![CDATA[<p>I had to change the domain account on some SQL Server boxes that we have. After I changed the account on one machine from DomainNameUser to DomainNameNewUser SQL Server wouldn&#8217;t start up</p>
<p>In the error log I saw the following messages</p>
<blockquote><p>Server      Error: 17190, Severity: 16, State: 1.<br />
2013-04-30 12:42:06.11 Server      Initializing the FallBack certificate failed with error code: 1, state: 1, error number: -2146893802.<br />
2013-04-30 12:42:06.11 Server      Unable to initialize SSL encryption because a valid certificate could not be found, and it is not possible to create a self-signed certificate.<br />
2013-04-30 12:42:06.11 Server      Error: 17182, Severity: 16, State: 1.<br />
2013-04-30 12:42:06.11 Server      TDSSNIClient initialization failed with error 0x80092004, status code 0x80. Reason: Unable to initialize SSL support. Cannot find object or property.</p>
<p>2013-04-30 12:42:06.11 Server      Error: 17182, Severity: 16, State: 1.<br />
2013-04-30 12:42:06.11 Server      TDSSNIClient initialization failed with error 0x80092004, status code 0x1. Reason: Initialization failed with an infrastructure error. Check for previous errors. Cannot find object or property.</p>
<p>2013-04-30 12:42:06.11 Server      Error: 17826, Severity: 18, State: 3.<br />
2013-04-30 12:42:06.11 Server      Could not start the network library because of an internal error in the network library. To determine the cause, review the errors immediately preceding this one in the error log.<br />
2013-04-30 12:42:06.11 Server      Error: 17120, Severity: 16, State: 1.<br />
2013-04-30 12:42:06.11 Server      SQL Server could not spawn FRunCM thread. Check the SQL Server error log and the Windows event logs for information about possible related problems.</p></blockquote>
<p>We are not using encryption, VIA is disabled as well. After trying all kinds of different things I notice that when logging on with this profile on the box there was an error. Something about that the profile couldn&#8217;t be created and a temporary profile would be used instead</p>
<p>In the end I had to wipe out the user profile from the box</p>
<p>You do that by following these steps</p>
<p>Right click on computer, select Properties<br />
Click on Advanced System Settings<br />
Select the  Advanced Tab<br />
On the user profiles section click on Settings</p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/Denis/SQL2013/UserProfile.PNG?mtime=1367323923"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/SQL2013/UserProfile.PNG?mtime=1367323923" width="399" height="451" /></a></div>
<p>Select the profile and hit Delete</p>
<p>If you try to log in as that user, the profile will be recreated.</p>
<p>Now when I tried to start SQL Server again, the errors were not there and SQL Server started up without a problem</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbadmin/mssqlserveradmin/fixing-a-sql-server-could/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>SQL Advent 2011 Day 21: TRY CATCH</title>
		<link>/index.php/datamgmt/datadesign/try-catch-sql-advent-2011/</link>
		<comments>/index.php/datamgmt/datadesign/try-catch-sql-advent-2011/#respond</comments>
		<pubDate>Wed, 21 Dec 2011 23:15:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[error handling]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[try catch]]></category>

		<guid isPermaLink="false">/index.php/2011/12/try-catch-sql-advent-2011/</guid>
		<description><![CDATA[Today we are going to take a look at TRY CATCH. Like in most modern programming languages, you put your code in the TRY block and you check for the errors in the CATCH block. SQL Server has a bunch of functions that will help you identify why your code failed, here is a list of the functions and what they return]]></description>
				<content:encoded><![CDATA[<p>In my <a href="/index.php/DataMgmt/DataDesign/are-you-ready-for-sql">Are you ready for SQL Server 2012 or are you still partying like it is 1999?</a> post, I wrote about how you should start using SQL Server 2005 and SQL Server 2008 functionality now in order to prepare for SQL Server 2012. I still see tons of code that is written in the pre 2005 style and people still keep using those functions, procs and statements even though SQL Server 2005 and 2008 have much better functionality.</p>
<p>Today we are going to take a look at TRY CATCH. Like in most modern programming languages, you put your code in the TRY block and you check for the errors in the CATCH block. SQL Server has a bunch of functions that will help you identify why your code failed, here is a list of the functions and what they return</p>
<p><strong>ERROR_NUMBER() </strong><br />
returns the number of the error</p>
<p><strong>ERROR_SEVERITY() </strong><br />
returns the severity of the error</p>
<p><strong>ERROR_STATE()</strong><br />
returns the error state number</p>
<p><strong>ERROR_PROCEDURE()</strong><br />
returns the name of the stored procedure or trigger where the error occurred, this will be NULL if you run an ad-hoc SQL statement</p>
<p><strong>ERROR_LINE()</strong><br />
returns the line number inside the routine that caused the error</p>
<p><strong>ERROR_MESSAGE()</strong><br />
returns the complete text of the error message. The text includes the values supplied for any substitutable parameters, such as lengths, object names, or times</p>
<p>
Let&#8217;s run an example that generates a divide by zero error, in the catch we are just doing a simple select that calls the functions mentioned before to see what they return</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BEGIN</span> <span class="kw1">TRY</span>
&nbsp; &nbsp; <span class="co1">-- &nbsp;divide-by-zero error.</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="nu0">1</span><span class="sy0">/</span><span class="nu0">0</span>
<span class="kw1">END</span> <span class="kw1">TRY</span>
<span class="kw1">BEGIN</span> <span class="kw1">CATCH</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span>
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorNumber
&nbsp; &nbsp; ,ERR<span class="sy0">OR</span>_SEVERITY<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorSeverity
&nbsp; &nbsp; ,ERR<span class="sy0">OR</span>_STATE<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorState
&nbsp; &nbsp; ,ERR<span class="sy0">OR</span>_PROCEDURE<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorProcedure
&nbsp; &nbsp; ,ERR<span class="sy0">OR</span>_L<span class="sy0">IN</span>E<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorLine
&nbsp; &nbsp; ,ERR<span class="sy0">OR</span>_MESSAGE<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">AS</span> ErrorMessage;
<span class="kw1">END</span> <span class="kw1">CATCH</span>;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BEGIN TRY
    --  divide-by-zero error.
    SELECT 1/0
END TRY
BEGIN CATCH
    SELECT
    ERROR_NUMBER() AS ErrorNumber
    ,ERROR_SEVERITY() AS ErrorSeverity
    ,ERROR_STATE() AS ErrorState
    ,ERROR_PROCEDURE() AS ErrorProcedure
    ,ERROR_LINE() AS ErrorLine
    ,ERROR_MESSAGE() AS ErrorMessage;
END CATCH;</pre></div></div>

<p></p>
<pre>ErrorNumber	ErrorSeverity	ErrorState	ErrorProcedure	ErrorLine	ErrorMessage
8134	        16	        1	        NULL	        3	       Divide by zero 
                                                                               error encountered.</pre>
<p></p>
<p>As you can see we got all that information back, that was pretty nice. Let&#8217;s take it to the next step</p>
<p>Create the following table to store all the error information in</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> LogErrors <span class="br0">&#40;</span>ErrorTime <span class="kw1">datetime</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorNumber <span class="kw1">int</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorSeverity <span class="kw1">int</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorState <span class="kw1">int</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorProc <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorLine <span class="kw1">int</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ErrorMessage <span class="kw1">nvarchar</span><span class="br0">&#40;</span><span class="nu0">1000</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE LogErrors (ErrorTime datetime,
			ErrorNumber int,
			ErrorSeverity int,
			ErrorState int, 
			ErrorProc nvarchar(100), 
			ErrorLine int, 
			ErrorMessage nvarchar(1000))
GO</pre></div></div>

<p>Create this stored procedure that will insert into the table we just created</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">PROCEDURE</span> prInsertError
<span class="kw1">AS</span>
<span class="kw1">INSERT</span> LogErrors
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_SEVERITY<span class="br0">&#40;</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_STATE<span class="br0">&#40;</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_PROCEDURE<span class="br0">&#40;</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_L<span class="sy0">IN</span>E<span class="br0">&#40;</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; ERR<span class="sy0">OR</span>_MESSAGE<span class="br0">&#40;</span><span class="br0">&#41;</span> ;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE PROCEDURE prInsertError
AS
INSERT LogErrors
SELECT GETDATE(),
    ERROR_NUMBER(),
    ERROR_SEVERITY(), 
    ERROR_STATE(), 
    ERROR_PROCEDURE(), 
    ERROR_LINE(), 
    ERROR_MESSAGE() ;
GO</pre></div></div>

<p>Run these 3 queries, they will generate 3 inserts into the LogErrors table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BEGIN</span> <span class="kw1">TRY</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="nu0">1</span><span class="sy0">/</span><span class="nu0">0</span>
<span class="kw1">END</span> <span class="kw1">TRY</span>
<span class="kw1">BEGIN</span> <span class="kw1">CATCH</span>
&nbsp; &nbsp; <span class="kw1">EXEC</span> prInsertError
<span class="kw1">END</span> <span class="kw1">CATCH</span>;
&nbsp;
&nbsp;
<span class="kw1">BEGIN</span> <span class="kw1">TRY</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">int</span>,<span class="st0">'a'</span><span class="br0">&#41;</span>
<span class="kw1">END</span> <span class="kw1">TRY</span>
<span class="kw1">BEGIN</span> <span class="kw1">CATCH</span>
&nbsp; &nbsp; <span class="kw1">EXEC</span> prInsertError
<span class="kw1">END</span> <span class="kw1">CATCH</span>;
&nbsp;
&nbsp;
<span class="kw1">BEGIN</span> <span class="kw1">TRY</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">tinyint</span>,<span class="nu0">300</span><span class="br0">&#41;</span>
<span class="kw1">END</span> <span class="kw1">TRY</span>
<span class="kw1">BEGIN</span> <span class="kw1">CATCH</span>
&nbsp; &nbsp; <span class="kw1">EXEC</span> prInsertError
<span class="kw1">END</span> <span class="kw1">CATCH</span>;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BEGIN TRY
    SELECT 1/0
END TRY
BEGIN CATCH
    EXEC prInsertError
END CATCH;


BEGIN TRY
    SELECT convert(int,'a')
END TRY
BEGIN CATCH
    EXEC prInsertError
END CATCH;


BEGIN TRY
    SELECT convert(tinyint,300)
END TRY
BEGIN CATCH
    EXEC prInsertError
END CATCH;</pre></div></div>

<p>If you check now what is in the table, you will see 3 rows</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> LogErrors</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT * FROM LogErrors</pre></div></div>

<p></p>
<div class="tables">
<table>
<tr>
<th>	ErrorTime</th>
<th>	ErrorNumber</th>
<th>	ErrorSeverity</th>
<th>	ErrorState</th>
<th>	ErrorProc</th>
<th>	ErrorLine</th>
<th>	ErrorMessage</th>
</tr>
<tr>
<td>2011-12-21 20:08:20.890</td>
<td>	8134</td>
<td>	16</td>
<td>	1</td>
<td>	NULL</td>
<td>	2</td>
<td>	Divide by zero error encountered.</td>
</tr>
<tr>
<td>2011-12-21 20:08:22.907</td>
<td>	245</td>
<td>	16</td>
<td>	1</td>
<td>	NULL</td>
<td>	2</td>
<td>	Conversion failed when converting the varchar value &#8216;a&#8217; to data type int.</td>
</tr>
<tr>
<td>2011-12-21 20:08:25.270</td>
<td>	220</td>
<td>	16</td>
<td>	2</td>
<td>	NULL</td>
<td>	2</td>
<td>	Arithmetic overflow error for data type tinyint, value = 300.</td>
</tr>
</table>
</div>
<p>
That is all for today, as you can see error handling is much better than having to check for @@ERROR after every insert. You can also have 1 stored proc that you can call from everywhere and this proc will log all errors plus any other information you want to capture like user name, host name etc etc</p>
<p>Come back tomorrow for the next post in this series</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/try-catch-sql-advent-2011/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>How to capture the error output from a stored procedure when calling another stored procedure in SQL Server?</title>
		<link>/index.php/datamgmt/datadesign/how-to-capture-the-error/</link>
		<comments>/index.php/datamgmt/datadesign/how-to-capture-the-error/#respond</comments>
		<pubDate>Thu, 01 Dec 2011 15:22:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[output parameter]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[tip]]></category>

		<guid isPermaLink="false">/index.php/2011/12/how-to-capture-the-error/</guid>
		<description><![CDATA[This is a quick post, this question was asked recently

I have a stored procedure which is being called by some business objects and it's working fine. I want to extend this stored procedure to call a new stored procedure (basically it will insert som&#8230;]]></description>
				<content:encoded><![CDATA[<p>This is a quick post, this <a href="http://stackoverflow.com/questions/8171359/capture-the-error-output-from-a-stored-procedure-when-calling-another-stored-pro/8171572#8171572">question</a> was asked recently</p>
<blockquote><p>I have a stored procedure which is being called by some business objects and it&#8217;s working fine. I want to extend this stored procedure to call a new stored procedure (basically it will insert some of the passed in data into another table), but this isn&#8217;t working. How can I get the error output back from both stored procedures?</p></blockquote>
<p>This is pretty simple to do if you capture the output from the first procedure and then you can use an output parameter to pass it back. Here is a very simple version of how it would work</p>
<p>This is our first proc, as you can see I hardcoded the value 1 so that we are sure this is returned from the first proc</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">PROC</span> prtest1
<span class="kw1">AS</span>
<span class="kw1">RETURN</span> <span class="nu0">1</span> <span class="co1">--@@error</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE PROC prtest1
AS
RETURN 1 --@@error
GO</pre></div></div>

<p>This is our second proc, as you can see I hardcoded the value 2 so that we are sure this is returned from the first proc. You can also see that I store the return value from the stored procedure prtest1 in the @error and this is an output parameter</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">PROC</span> prtest2 @error <span class="kw1">INT</span> <span class="kw1">OUTPUT</span>
<span class="kw1">AS</span>
<span class="kw1">EXEC</span> @error <span class="sy0">=</span> prtest1
<span class="kw1">RETURN</span> <span class="nu0">2</span> <span class="co1">--@@error</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE PROC prtest2 @error INT OUTPUT
AS
EXEC @error = prtest1
RETURN 2 --@@error
GO</pre></div></div>

<p>Here is now how you bring both statuses back by using a combination of a return value and an output parameter. this part <em>EXEC @SecondProc = prtest2</em> will get the return value. </p>
<p>This part <em>@error = @FirstProc   OUTPUT </em>will get the value that is returned from the output parameter</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @SecondProc <span class="kw1">INT</span>, @FirstProc <span class="kw1">INT</span>
<span class="kw1">EXEC</span> @SecondProc <span class="sy0">=</span> prtest2 @error <span class="sy0">=</span> @FirstProc &nbsp; <span class="kw1">OUTPUT</span>
&nbsp;
<span class="kw1">SELECT</span> @SecondProc &nbsp;<span class="kw1">AS</span> <span class="br0">&#91;</span>2nd<span class="br0">&#93;</span>,@FirstProc <span class="kw1">AS</span> <span class="br0">&#91;</span>1st<span class="br0">&#93;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @SecondProc INT, @FirstProc INT
EXEC @SecondProc = prtest2 @error = @FirstProc   OUTPUT

SELECT @SecondProc  AS [2nd],@FirstProc AS [1st]</pre></div></div>

<p>Output<br />
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;</p>
<pre>2nd	1st
2	1	</pre>
<p>I prefer to return errors that I capture from within the proc as output parameters, I will also use the <em>ERROR_MESSAGE()</em> function to return something that makes more sense to the user than a number. Below is an example</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BEGIN</span> <span class="kw1">TRY</span>
&nbsp; &nbsp; &nbsp;<span class="kw1">SELECT</span> <span class="nu0">1</span><span class="sy0">/</span><span class="nu0">0</span>
<span class="kw1">END</span> <span class="kw1">TRY</span>
&nbsp;
<span class="kw1">BEGIN</span> <span class="kw1">CATCH</span>
&nbsp; &nbsp; &nbsp;<span class="kw1">SELECT</span> ERR<span class="sy0">OR</span>_MESSAGE<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw2">@@ERROR</span>
<span class="kw1">END</span> <span class="kw1">CATCH</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BEGIN TRY
     SELECT 1/0
END TRY

BEGIN CATCH
     SELECT ERROR_MESSAGE(), @@ERROR
END CATCH</pre></div></div>

<p>Output<br />
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-<br />
Divide BY zero ERROR encountered. 8134</p>
<p>What is better for the end user 8134 or &#8220;Divide BY zero ERROR encountered.&#8221;?</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/how-to-capture-the-error/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>&#8216;LocalSqlServer&#8217; Error Deploying WebSecurity in WebMatrix/Web Pages</title>
		<link>/index.php/webdev/serverprogramming/localsqlserver-error-deploying-websecurity/</link>
		<comments>/index.php/webdev/serverprogramming/localsqlserver-error-deploying-websecurity/#respond</comments>
		<pubDate>Tue, 09 Aug 2011 10:52:00 +0000</pubDate>
		<dc:creator><![CDATA[Eli Weinstock-Herman (tarwn)]]></dc:creator>
				<category><![CDATA[Server Programming]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[razor]]></category>
		<category><![CDATA[web pages]]></category>
		<category><![CDATA[webmatrix]]></category>
		<category><![CDATA[websecurity]]></category>

		<guid isPermaLink="false">/index.php/2011/08/localsqlserver-error-deploying-websecurity/</guid>
		<description><![CDATA[Several weeks ago I was working on a sample site in Web Matrix and ran into a brick wall when I attempted to implement WebSecurity against my website. It seemed no matter what I tried I was getting errors about my database, errors about a database I didn't know about, errors trying to deploy the config file at all.]]></description>
				<content:encoded><![CDATA[<p>Several weeks ago I was working on a sample site in Web Matrix and ran into a brick wall when I attempted to implement WebSecurity against my website. It seemed no matter what I tried I was getting errors about my database, errors about a database I didn&#8217;t know about, errors trying to deploy the config file at all. After hours of debugging and random attempts at web.config hackery, I finally tried the basic starter sites and found out that those, too, suffered from problems when you attempt to deploy them.</p>
<blockquote><p>
<strong>Configuration Error</strong><br />
<strong>Description:</strong> An error occurred during the processing of a configuration file required to service this request. Please review the specific error details below and modify your configuration file appropriately.</p>
<p><strong>Parser Error Message:</strong> The connection name &#8216;LocalSqlServer&#8217; was not found in the applications configuration or the connection string is empty.
</p></blockquote>
<p>Today I managed to solve it based on an <a href="http://forum.winhost.com/archive/index.php/t-8697.html">archived forum post</a> I found through google. </p>
<p>The solution is to add the following section to your web.config:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="xml"><thead><tr><td colspan="2"  class="head">XML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="sc-1">&lt;!-- Added in an attempt to make simple security work --&gt;</span>
<span class="sc3"><span class="re1">&lt;connectionStrings<span class="re2">&gt;</span></span></span>
&nbsp; &nbsp; <span class="sc3"><span class="re1">&lt;remove</span> <span class="re0">name</span>=<span class="st0">&quot;LocalSqlServer&quot;</span> <span class="re2">/&gt;</span></span>
&nbsp; &nbsp; <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">name</span>=<span class="st0">&quot;LocalSqlServer&quot;</span> <span class="re0">connectionString</span>=<span class="st0">&quot;Data Source=.App_DataMyJunk.sdf&quot;</span> <span class="re0">providerName</span>=<span class="st0">&quot;System.Data.SqlServerCe.4.0&quot;</span> <span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/connectionStrings<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;appSettings<span class="re2">&gt;</span></span></span>
&nbsp; &nbsp; <span class="sc3"><span class="re1">&lt;add</span> <span class="re0">key</span>=<span class="st0">&quot;enableSimpleMembership&quot;</span> <span class="re0">value</span>=<span class="st0">&quot;true&quot;</span> <span class="re2">/&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/appSettings<span class="re2">&gt;</span></span></span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">&lt;!-- Added in an attempt to make simple security work --&gt;
&lt;connectionStrings&gt;
	&lt;remove name="LocalSqlServer" /&gt;
	&lt;add name="LocalSqlServer" connectionString="Data Source=.App_DataMyJunk.sdf" providerName="System.Data.SqlServerCe.4.0" /&gt;
&lt;/connectionStrings&gt;
&lt;appSettings&gt;
	&lt;add key="enableSimpleMembership" value="true" /&gt;
&lt;/appSettings&gt;</pre></div></div>

<p>Basically what is happening is that my web host has a machine.config with a SQL Connection string called &#8220;LocalSqlServer&#8221; (it&#8217;s created by default by the .Net framework). For some reason when we use anything Membership related, it attempts to access the configured connection string for Membership, even though WebSecurity is provided it&#8217;s own connection string on initialization.</p>
<p>So the solution is to remove the settings that has been applied to our site from the host&#8217;s machine.config and apply a new one. From what I can tell, it doesn&#8217;t seem to matter if the new connection string is accurate, only that it exists.</p>
<p>Yep, this means I don&#8217;t actually have a SQLCE database named, MyJunk. I can tell you&#8217;re disappointed. Also I don&#8217;t know if ./ would work in this path, so please don&#8217;t use this as a how-to guide on how to create a working SQLCE connection string.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/webdev/serverprogramming/localsqlserver-error-deploying-websecurity/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>How to capture the error output from xp_cmdshell in SQL Server</title>
		<link>/index.php/datamgmt/dbprogramming/how-to-capture-error-output-from-xp_cmds/</link>
		<comments>/index.php/datamgmt/dbprogramming/how-to-capture-error-output-from-xp_cmds/#comments</comments>
		<pubDate>Wed, 22 Sep 2010 13:37:55 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[tip]]></category>
		<category><![CDATA[trick]]></category>
		<category><![CDATA[xp_cmdshell]]></category>

		<guid isPermaLink="false">/index.php/2010/09/how-to-capture-error-output-from-xp_cmds/</guid>
		<description><![CDATA[A person asked the following question: I am running the following command: EXEC @ReturnCode = master.dbo.xp_cmdshell @cmdline On the Results tab I get 2 lines Could not find a part of the path &#8216;serverdirectoryfilename&#8217;. NULL How do I capture the first line in an error message? I tried using a Try Catch block with &#8220;SELECT [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>A person asked the following question:</p>
<blockquote><p>I am running the following command:</p>
<p>EXEC @ReturnCode = master.dbo.xp_cmdshell @cmdline</p>
<p>On the Results tab I get 2 lines Could not find a part of the path &#8216;serverdirectoryfilename&#8217;. NULL</p>
<p>How do I capture the first line in an error message? I tried using a Try Catch block with &#8220;SELECT @ErrorMessage = ERROR_MESSAGE()&#8221; and it doesn&#8217;t grab it.</p>
<p>The message is not coming from sys.messages. Where is this error message coming from then?</p></blockquote>
<p>First of all that message comes from the Command Shell/DOS, not from SQL Server. There is a way to grab the message if you store the output in a table. The xp_cmdshell proc will return 1 if there is a failure and 0 if it executed succesfully<br />
So if you were to execute the bogus command <em>bla bla c:</em> you would get the following output</p>
<p><em>&#8216;bla&#8217; is not recognized as an internal or external command,operable program or batch file.</em></p>
<p>If you did something like <em>dir z:</em> when you don&#8217;t have a z drive you would see the following</p>
<p><em>The system cannot find the path specified.</em></p>
<p>Now let&#8217;s look at some code by running a dir command on a drive that doesn&#8217;t exist, if you do have a z drive then change it to something that you don&#8217;t have</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @cmdline <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">500</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; @ReturnCode <span class="kw1">INT</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; @ErrorMessage <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">2000</span><span class="br0">&#41;</span>
&nbsp;
<span class="co1">--Command to execute</span>
<span class="kw1">SELECT</span> @cmdline <span class="sy0">=</span> <span class="st0">'dir z:'</span>
&nbsp;
<span class="co1">-- Initialize variable</span>
<span class="kw1">SELECT</span> @ErrorMessage <span class="sy0">=</span> <span class="st0">''</span>
&nbsp;
<span class="co1">--Create temp table to hold result</span>
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> #temp <span class="br0">&#40;</span>SomeCol <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">500</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp;
<span class="co1">--dump result into temp table</span>
<span class="kw1">INSERT</span> #temp
<span class="kw1">EXEC</span> @ReturnCode <span class="sy0">=</span> master.<span class="me1">dbo</span>.<span class="me1">xp_cmdshell</span> @cmdline
&nbsp;
<span class="co1">-- If we have an error populate variable</span>
<span class="kw1">IF</span> @ReturnCode <span class="sy0">&lt;&gt;</span> <span class="nu0">0</span>
<span class="kw1">BEGIN</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @ErrorMessage <span class="sy0">=</span> @ErrorMessage <span class="sy0">+</span> SomeCol &nbsp; 
&nbsp; &nbsp; <span class="kw1">FROM</span> #temp
&nbsp; &nbsp; <span class="kw1">WHERE</span> SomeCol <span class="kw1">IS</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">--Display error message and return code</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @ErrorMessage <span class="kw1">as</span> ErrorMessage &nbsp;,@ReturnCode <span class="kw1">as</span> ReturnCode
&nbsp;
<span class="kw1">END</span>
<span class="co1">-- Look how 'green' we are</span>
<span class="kw1">DROP</span> <span class="kw1">TABLE</span> #temp</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @cmdline VARCHAR(500),
		@ReturnCode INT, 
		@ErrorMessage varchar(2000)

--Command to execute
SELECT @cmdline = 'dir z:'

-- Initialize variable
SELECT @ErrorMessage = ''

--Create temp table to hold result
CREATE TABLE #temp (SomeCol VARCHAR(500))

--dump result into temp table
INSERT #temp
EXEC @ReturnCode = master.dbo.xp_cmdshell @cmdline

-- If we have an error populate variable
IF @ReturnCode &lt;&gt; 0
BEGIN
	SELECT @ErrorMessage = @ErrorMessage + SomeCol   
	FROM #temp
	WHERE SomeCol IS NOT NULL

	--Display error message and return code
	SELECT @ErrorMessage as ErrorMessage  ,@ReturnCode as ReturnCode

END
-- Look how 'green' we are
DROP TABLE #temp</pre></div></div>

<p>After you run that you should see the following<br />
</p>
<div class="tables">
<table cellpadding="1" cellspacing="1" border="1">
<tr>
<th>ErrorMessage</th>
<th>ReturnCode</th>
</tr>
<tr>
<td>The system cannot find the path specified.</td>
<td>1</td>
</tr>
</table>
</div>
<p>Change

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> @cmdline <span class="sy0">=</span> <span class="st0">'dir z:'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT @cmdline = 'dir z:'</pre></div></div>

<p> to

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> @cmdline <span class="sy0">=</span> <span class="st0">'bla bla z:'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT @cmdline = 'bla bla z:'</pre></div></div>

<p>Run the code again and now you should see the following output.<br />
</p>
<div class="tables">
<table cellpadding="1" cellspacing="1" border="1">
<tr>
<th>ErrorMessage</th>
<th>ReturnCode</th>
</tr>
<tr>
<td>&#8216;bla&#8217; is not recognized as an internal or external command,operable program or batch file.</td>
<td>1</td>
</tr>
</table>
</div>
<p>That is it for this post; as you can see there is a way to grab the error message from xp_cmdshell</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbprogramming/how-to-capture-error-output-from-xp_cmds/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>When should you store @@ROWCOUNT into a variable?</title>
		<link>/index.php/datamgmt/dbprogramming/when-can-you-grab-rowcount-into-a-variab/</link>
		<comments>/index.php/datamgmt/dbprogramming/when-can-you-grab-rowcount-into-a-variab/#comments</comments>
		<pubDate>Fri, 10 Sep 2010 11:53:04 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[@@rowcount]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[gotcha]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[tip]]></category>

		<guid isPermaLink="false">/index.php/2010/09/when-can-you-grab-rowcount-into-a-variab/</guid>
		<description><![CDATA[There was a question I answered the other day where someone complained that the rowcount was always 0. Below is a simplified version of the query, can you tell why @SomeCount will be 0? T-SQL1 2 3 4 5 6 7 8 9 10 declare @SomeCount int &#160; select 1 union all select 2 &#160; [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>There was a question I answered the other day where <a href="http://stackoverflow.com/questions/3575860/sql-why-cant-i-get-the-rowcount-value">someone complained that the rowcount was always 0</a>. Below is a simplified version of the query, can you tell why @SomeCount will be 0?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span>
&nbsp;
<span class="kw1">print</span> <span class="st0">'1'</span>
<span class="kw1">select</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
&nbsp;
<span class="kw1">select</span> @SomeCount </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int

select 1
union all
select 2

print '1'
select @SomeCount = @@rowcount 

select @SomeCount </pre></div></div>

<p>The value that the @SomeCount parameter returns will be 0 because print resets the value of @@ROWCOUNT to 0</p>
<p>Let&#8217;s take a look at another example, but instead of using print we will use a <em>SET @param = value</em> statement. Can you guess what @SomeCount will return in the select statement?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @SomeCount <span class="kw1">INT</span>
&nbsp;
<span class="kw1">SELECT</span> <span class="nu0">1</span>
<span class="kw1">UNION</span> all
<span class="kw1">SELECT</span> <span class="nu0">2</span>
&nbsp;
<span class="kw1">SET</span> &nbsp;@SomeCount <span class="sy0">=</span> <span class="nu0">0</span>
<span class="kw1">SELECT</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span>
&nbsp;
<span class="kw1">SELECT</span> @SomeCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @SomeCount INT
 
SELECT 1
UNION all
SELECT 2
 
SET  @SomeCount = 0
SELECT @SomeCount = @@ROWCOUNT
 
SELECT @SomeCount</pre></div></div>

<p>The value that the @SomeCount parameter returns will be 1 because the <em>SET @param = value</em> always sets the @@ROWCOUNT value to 1. Here is what Books On Line has on statements that make a simple assignment </p>
<blockquote><p>Statements that make a simple assignment always set the @@ROWCOUNT value to 1. No rows are sent to the client. Examples of these statements are: SET @local_variable, RETURN, READTEXT, and select without query statements such as SELECT GETDATE() or SELECT &#8216;Generic Text&#8217;.</p></blockquote>
<p>Let&#8217;s look at another example, what do you think will be returned in the query below</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @SomeCount <span class="kw1">INT</span>, @SomeOtherCount <span class="kw1">int</span>
&nbsp;
&nbsp;
<span class="kw1">SELECT</span> &nbsp;@SomeOtherCount <span class="sy0">=</span> number 
<span class="kw1">FROM</span> master..<span class="me1">spt_values</span>
<span class="kw1">SELECT</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span>
&nbsp;
<span class="kw1">SELECT</span> @SomeCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @SomeCount INT, @SomeOtherCount int
 
 
SELECT  @SomeOtherCount = number 
FROM master..spt_values
SELECT @SomeCount = @@ROWCOUNT
 
SELECT @SomeCount</pre></div></div>

<p>On my machine it returns the value 2506, this is because SQL Server reads all the rows from the master..spt_values table</p>
<p>Books On Line explanation on that one is the following</p>
<blockquote><p>Statements that make an assignment in a query or use RETURN in a query set the @@ROWCOUNT value to the number of rows affected or read by the query, for example: SELECT @local_variable = c1 FROM t1. </p></blockquote>
<p>Let&#8217;s take a look at another rather silly example</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @SomeCount <span class="kw1">INT</span>
&nbsp;
<span class="kw1">SELECT</span> <span class="nu0">1</span>
<span class="kw1">UNION</span> all
<span class="kw1">SELECT</span> <span class="nu0">2</span>
&nbsp;
<span class="kw1">if</span> <span class="nu0">1</span><span class="sy0">=</span><span class="nu0">1</span>
<span class="kw1">SELECT</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span>
&nbsp;
<span class="kw1">SELECT</span> @SomeCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @SomeCount INT
 
SELECT 1
UNION all
SELECT 2
 
if 1=1
SELECT @SomeCount = @@ROWCOUNT
 
SELECT @SomeCount</pre></div></div>

<p>As you can see the IF statement also resets the @@ROWCOUNT and you get back 0</p>
<h2>So when should you store @@ROWCOUNT into a variable?</h2>
<p>If you want to store the rows that were affected by A DML statement then you need to grab @@ROWCOUNT immediately after the DML statement. There can&#8217;t be any code between the DML statement and your code that stores @@ROWCOUNT into a variable.</p>
<p>So instead of this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span>
&nbsp;
<span class="kw1">print</span> <span class="st0">'1'</span>
<span class="kw1">select</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
&nbsp;
<span class="kw1">select</span> @SomeCount </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int

select 1
union all
select 2

print '1'
select @SomeCount = @@rowcount 

select @SomeCount </pre></div></div>

<p>You do this, move the print until after you populate your variable with the @@ROWCOUNT value</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span>
<span class="co1">-- no other code beyween the DML statement and populating @SomeCount </span>
<span class="co1">-- with the @@rowcount value</span>
<span class="kw1">select</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
<span class="kw1">print</span> <span class="st0">'1'</span>
&nbsp;
&nbsp;
<span class="kw1">select</span> @SomeCount </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int

select 1
union all
select 2
-- no other code beyween the DML statement and populating @SomeCount 
-- with the @@rowcount value
select @SomeCount = @@rowcount 
print '1'


select @SomeCount </pre></div></div>

<p>To learn more about @@ROWCOUNT visit Books On Line: http://msdn.microsoft.com/en-us/library/ms187316.aspx</p>
<h2>What about @@error</h2>
<p>I am just giving you a little more code here, the same also applies for @@ERROR, so if you have code that needs to store both @@ERROR and @@ROWCOUNT then do it in one assignment.</p>
<p>There are 3 versions of the same query below, all of them will terminate with an error.<br />
First let&#8217;s look at code that first grabs the rowcount and then the error</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>, @Error <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span><span class="sy0">/</span><span class="nu0">0</span>
&nbsp;
&nbsp;
<span class="kw1">select</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
<span class="kw1">select</span> &nbsp;@Error <span class="sy0">=</span> <span class="kw2">@@error</span>
&nbsp;
&nbsp;
<span class="kw1">select</span> @SomeCount <span class="kw1">as</span> TheRowcount, @Error <span class="kw1">as</span> TheErrorCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int, @Error int

select 1
union all
select 2/0


select @SomeCount = @@rowcount 
select  @Error = @@error


select @SomeCount as TheRowcount, @Error as TheErrorCount</pre></div></div>

<pre>TheRowcount	TheErrorCount
0	        0</pre>
<p>As you can see both variables are 0, TheRowcount is 0 because the query terminated and no rows were returned, TheErrorCount is 0 because the statement that assigned @SomeCount was successful </p>
<p>Here is another example, all we did was reversed the assignment of @SomeCount and @Error</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>, @Error <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span><span class="sy0">/</span><span class="nu0">0</span>
&nbsp;
<span class="kw1">select</span> &nbsp;@Error <span class="sy0">=</span> <span class="kw2">@@error</span>
<span class="kw1">select</span> @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
&nbsp;
<span class="kw1">select</span> @SomeCount <span class="kw1">as</span> TheRowcount, @Error <span class="kw1">as</span> TheErrorCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int, @Error int

select 1
union all
select 2/0

select  @Error = @@error
select @SomeCount = @@rowcount 

select @SomeCount as TheRowcount, @Error as TheErrorCount</pre></div></div>

<pre>TheRowcount	TheErrorCount
1	        8134</pre>
<p>In this case TheRowcount is 1 because the statement that assigned @Error reset @@ROWCOUNT to 0</p>
<p>Finally we will look at what happens when you assign both variables with one statement</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">declare</span> @SomeCount <span class="kw1">int</span>, @Error <span class="kw1">int</span>
&nbsp;
<span class="kw1">select</span> <span class="nu0">1</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="nu0">2</span><span class="sy0">/</span><span class="nu0">0</span>
&nbsp;
<span class="kw1">select</span> &nbsp;@Error <span class="sy0">=</span> <span class="kw2">@@error</span>, @SomeCount <span class="sy0">=</span> <span class="kw2">@@rowcount</span> 
&nbsp;
<span class="kw1">select</span> @SomeCount <span class="kw1">as</span> TheRowcount, @Error <span class="kw1">as</span> TheErrorCount</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">declare @SomeCount int, @Error int

select 1
union all
select 2/0

select  @Error = @@error, @SomeCount = @@rowcount 

select @SomeCount as TheRowcount, @Error as TheErrorCount</pre></div></div>

<pre>TheRowcount	TheErrorCount
0	        8134</pre>
<p>This is correct, TheErrorCount returns the error number and TheRowcount returns 0 because the query blew up</p>
<p>To learn more about @@ERROR visit Books On Line here: http://msdn.microsoft.com/en-us/library/ms188790.aspx</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbprogramming/when-can-you-grab-rowcount-into-a-variab/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Dealing with The multi-part identifier &#8220;dbo.Table.Column&#8221; could not be bound. error in an update statement</title>
		<link>/index.php/datamgmt/dbprogramming/dealing-with-the-multi-part-identifier-d/</link>
		<comments>/index.php/datamgmt/dbprogramming/dealing-with-the-multi-part-identifier-d/#comments</comments>
		<pubDate>Wed, 01 Sep 2010 22:33:18 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[gotcha]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[update]]></category>

		<guid isPermaLink="false">/index.php/2010/09/dealing-with-the-multi-part-identifier-d/</guid>
		<description><![CDATA[One of the best ways to improve your skills is by helping other people in forums and newsgroups. I was doing just that tonight and I stumbled on this piece of code here: http://stackoverflow.com/questions/3622685/transfer-column-data-from-one-database-to-another T-SQL1 2 3 4 5 update &#91;DB1&#93;.&#91;dbo&#93;.&#91;Table1&#93; set &#91;DB1&#93;.&#91;dbo&#93;.&#91;Table1&#93;.&#91;Column1&#93; = &#91;DB2&#93;.&#91;dbo&#93;.&#91;Table1&#93;.&#91;Column1&#93; from &#91;DB1&#93;.&#91;dbo&#93;.&#91;Table1&#93; db1Alias, &#91;DB2&#93;.&#91;dbo&#93;.&#91;Table1&#93; db2Alias where db1Alias.TeamId = db2Alias.TeamId and [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>One of the best ways to improve your skills is by helping other people in forums and newsgroups. I was doing just that tonight and I stumbled on this piece of code here: http://stackoverflow.com/questions/3622685/transfer-column-data-from-one-database-to-another</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">update</span> <span class="br0">&#91;</span>DB1<span class="br0">&#93;</span>.<span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Table1<span class="br0">&#93;</span>
<span class="kw1">set</span> <span class="br0">&#91;</span>DB1<span class="br0">&#93;</span>.<span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Table1<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Column1<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="br0">&#91;</span>DB2<span class="br0">&#93;</span>.<span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Table1<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Column1<span class="br0">&#93;</span>
<span class="kw1">from</span> <span class="br0">&#91;</span>DB1<span class="br0">&#93;</span>.<span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Table1<span class="br0">&#93;</span> db1Alias, <span class="br0">&#91;</span>DB2<span class="br0">&#93;</span>.<span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Table1<span class="br0">&#93;</span> db2Alias
<span class="kw1">where</span> db1Alias.<span class="me1">TeamId</span> <span class="sy0">=</span> db2Alias.<span class="me1">TeamId</span>
and db1Alias.<span class="me1">IndividualId</span> <span class="sy0">=</span> db2Alias.<span class="me1">IndividualId</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">update [DB1].[dbo].[Table1]
set [DB1].[dbo].[Table1].[Column1] = [DB2].[dbo].[Table1].[Column1]
from [DB1].[dbo].[Table1] db1Alias, [DB2].[dbo].[Table1] db2Alias
where db1Alias.TeamId = db2Alias.TeamId
and db1Alias.IndividualId = db2Alias.IndividualId</pre></div></div>

<p>Can you tell what is wrong with the code? If you try to run that you will get the following error</p>
<div style="border:1px solid black;background-color:#444;color:white;margin:0 20px;padding:0 5px 0 5px;">Msg 4104, Level 16, State 1, Line 2<br />
The multi-part identifier &#8220;DB2.dbo.Table1.Column1&#8221; could not be bound.</div>
<p></p>
<p>The problem is that aliases are defined for the tables but not used in the column part.</p>
<p>Let&#8217;s take a closer look with some code that you can actually run. First create these two tables</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">use</span> tempdb
go
&nbsp;
<span class="kw1">create</span> <span class="kw1">table</span> BlaTest<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> BlaTest <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
go
&nbsp;
<span class="kw1">create</span> <span class="kw1">table</span> BlaTest2<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> BlaTest2 <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
go</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">use tempdb
go

create table BlaTest(id int)
insert BlaTest values(1)
go

create table BlaTest2(id int)
insert BlaTest2 values(1)
go</pre></div></div>

<p>Now when you try to run this piece of code, which is the same as the code at the beginning of the post except for the object names, you will get an error.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">update</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span>
<span class="kw1">set</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span>.<span class="me1">id</span> <span class="sy0">=</span>tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest2</span>.<span class="me1">id</span>
<span class="kw1">from</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span> b
<span class="sy0">JOIN</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest2</span> a <span class="kw1">on</span> b.<span class="me1">id</span> <span class="sy0">=</span>a.<span class="me1">id</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">update tempdb.dbo.BlaTest
set tempdb.dbo.BlaTest.id =tempdb.dbo.BlaTest2.id
from tempdb.dbo.BlaTest b
JOIN tempdb.dbo.BlaTest2 a on b.id =a.id</pre></div></div>

<p>Here is the error</p>
<div style="border:1px solid black;background-color:#444;color:white;margin:0 20px;padding:0 5px 0 5px;">Msg 4104, Level 16, State 1, Line 2<br />
The multi-part identifier &#8220;tempdb.dbo.BlaTest2.id&#8221; could not be bound.</div>
<p></p>
<p>So what can be done?</p>
<p>Here is my preferred way of running this query, use the table aliases in the update and the columns</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">update</span> b
<span class="kw1">set</span> b.<span class="me1">id</span> <span class="sy0">=</span>a.<span class="me1">id</span>
<span class="kw1">from</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span> b
<span class="sy0">JOIN</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest2</span> a <span class="kw1">on</span> b.<span class="me1">id</span> <span class="sy0">=</span>a.<span class="me1">id</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">update b
set b.id =a.id
from tempdb.dbo.BlaTest b
JOIN tempdb.dbo.BlaTest2 a on b.id =a.id</pre></div></div>

<p>But you can also write the query like this by using the alias only for the column that is not being updated.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">update</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span>
<span class="kw1">set</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span>.<span class="me1">id</span> <span class="sy0">=</span>a.<span class="me1">id</span>
<span class="kw1">from</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest</span> b
<span class="sy0">JOIN</span> tempdb.<span class="me1">dbo</span>.<span class="me1">BlaTest2</span> a <span class="kw1">on</span> b.<span class="me1">id</span> <span class="sy0">=</span>a.<span class="me1">id</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">update tempdb.dbo.BlaTest
set tempdb.dbo.BlaTest.id =a.id
from tempdb.dbo.BlaTest b
JOIN tempdb.dbo.BlaTest2 a on b.id =a.id</pre></div></div>

<p>The important thing to remember is that you have to use the alias in the table that you are not updating, to be safe just use the alias all over, that way you don&#8217;t have to think whether to use the alias or not.</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbprogramming/dealing-with-the-multi-part-identifier-d/feed/</wfw:commentRss>
		<slash:comments>6</slash:comments>
		</item>
		<item>
		<title>Dealing with the could not allocate new page for database &#8216;TEMPDB&#8217;. There are no more pages available in filegroup DEFAULT error message</title>
		<link>/index.php/datamgmt/datadesign/could-not-allocate-new-page-for-database/</link>
		<comments>/index.php/datamgmt/datadesign/could-not-allocate-new-page-for-database/#respond</comments>
		<pubDate>Tue, 21 Jul 2009 18:01:51 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[database]]></category>
		<category><![CDATA[error]]></category>
		<category><![CDATA[fix]]></category>
		<category><![CDATA[gotcha]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[sql]]></category>
		<category><![CDATA[sql server]]></category>
		<category><![CDATA[tempdb]]></category>

		<guid isPermaLink="false">/index.php/2009/07/could-not-allocate-new-page-for-database/</guid>
		<description><![CDATA[Someone was writing some queries that brought back a lot of data (and I mean a LOT!!) and after a while he got the following message Connectivity error: [Microsoft][ODBC SQL Server Driver][SQL Server]Could not allocate new page for database &#8216;TEMPDB&#8217;. There are no more pages available in filegroup DEFAULT. Space can be created by dropping [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Someone was writing some queries that brought back a lot of data (and I mean a LOT!!) and after a while he got the following message</p>
<blockquote><p>Connectivity error: [Microsoft][ODBC SQL Server Driver][SQL Server]Could not allocate new page for database &#8216;TEMPDB&#8217;. There are no more pages available in filegroup DEFAULT. Space can be created by dropping objects, adding additional files, or or allowing file growth</p></blockquote>
<p>That is not good, fortunately this wasn&#8217;t one of our production machines but a dev/test box.</p>
<p>So what causes this? You might think that tempdb is only used for temporary(#temp or ##temp) tables but that is not true, tempdb is used for a lot of thing and since SQL server 2005 it is used more than ever. Here are some things that tempdb is used for:</p>
<ul>
<li>If you do any ordering on a query and this needs more memory than you have available in RAM it will also go to tempdb</li>
<li>If you have resultsets that are large and you use unions, group by, outer joins, cursors etc</li>
<li>If you use temporary tables</li>
<li>Uncommited transaction that have not been rolled back</li>
<li>DBCC CHECKDB will use the tempdb, the larger your database the more space DBCC CHECKDB will need from tempdb
<p>If you are creating or rebuilding indexes with the SORT_IN_TEMPDB = ON option</p>
<p>Here is some sample code that demonstrates that</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> AdventureWorks;
GO
<span class="kw1">ALTER</span> <span class="kw1">INDEX</span> <span class="sy0">ALL</span> <span class="kw1">ON</span> Production.<span class="me1">Product</span>
REBUILD <span class="kw1">WITH</span> <span class="br0">&#40;</span><span class="kw1">FILLFACTOR</span> <span class="sy0">=</span> <span class="nu0">80</span>, S<span class="sy0">OR</span>T_<span class="sy0">IN</span>_TEMPDB <span class="sy0">=</span> <span class="kw1">ON</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; STATISTICS_N<span class="sy0">OR</span>ECOMPUTE <span class="sy0">=</span> <span class="kw1">ON</span><span class="br0">&#41;</span>;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE AdventureWorks;
GO
ALTER INDEX ALL ON Production.Product
REBUILD WITH (FILLFACTOR = 80, SORT_IN_TEMPDB = ON,
              STATISTICS_NORECOMPUTE = ON);
GO</pre></div></div>

<p>See also <a href="http://msdn.microsoft.com/en-us/library/ms188281.aspx">tempdb and Index Creation</a> in Books On Line<br />
Here is an excerpt</p>
<blockquote><p>If the SORT_IN_TEMPDB option is set to ON and tempdb is on a separate set of disks from the destination filegroup, during the first phase, the reads of the data pages occur on a different disk from the writes to the sort work area in tempdb. This means the disk reads of the data keys generally continue more serially across the disk, and the writes to the tempdb disk also are generally serial, as do the writes to build the final index. Even if other users are using the database and accessing separate disk addresses, the overall pattern of reads and writes are more efficient when SORT_IN_TEMPDB is specified than when it is not.</p></blockquote>
</li>
</ul>
<p><strong>How can you fix this problem? </strong><br />
Here are a couple of ways</p>
<ol>
<li>Restart the SQL Server service, this will recreate the tempdb database</li>
<li>Add another file on another disk with more space</li>
<li>Shrink the log file of tempdb</li>
</ol>
<p>Now most likely you want to put in place some long term solutions after you did a quick fix. First of all, you should make sure that autogrow is not turned off. If you run the query below you don&#8217;t want to see a value of 0 in the growth column</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> growth,<span class="sy0">*</span> <span class="kw1">from</span> master..<span class="me1">sysaltfiles</span>
<span class="kw1">where</span> dbid <span class="sy0">=</span> <span class="kw2">db_id</span><span class="br0">&#40;</span><span class="st0">'tempdb'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select growth,* from master..sysaltfiles
where dbid = db_id('tempdb')</pre></div></div>

<p>This query below is another way of getting the growth value for tempdb</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">use</span> tempdb
go
&nbsp;
<span class="kw1">EXEC</span> <span class="kw3">sp_helpfile</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">use tempdb
go

EXEC sp_helpfile</pre></div></div>

<p>You also want to make sure that tempdb is in simple recovery mode and not in full, this query will return the recovery mode for tempdb</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="kw2">DATABASEPROPERTYEX</span><span class="br0">&#40;</span><span class="st0">'tempdb'</span>,<span class="st0">'recovery'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT DATABASEPROPERTYEX('tempdb','recovery')</pre></div></div>

<p>Ideally you want tempdb on its own drive, doing this will also improve performance. If you can&#8217;t have tempdb on its own drive then make sure you have plenty of space on that drive and if not then add one or more files on another drive.</p>
<p>Make sure that your queries have covering indexes, George wrote an article that explains how to create covering indexes here: <a href="/index.php/DataMgmt/DataDesign/sql-server-covering-indexes">SQL Server covering indexes</a></p>
<p>Most likely you don&#8217;t really want to return multi million rows in 1 big chunk, try doing it in batches that are smaller. The same applies for delete statements, try to do those in chunks, this will also perform much better. </p>
<p></p>
<p>*** <strong>If you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/could-not-allocate-new-page-for-database/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
