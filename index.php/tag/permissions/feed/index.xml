<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>permissions &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/permissions/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>Giving users the ability to change a stored procedure without making them db_owner</title>
		<link>/index.php/datamgmt/dbadmin/mssqlserveradmin/giving-users-the-ability-to/</link>
		<comments>/index.php/datamgmt/dbadmin/mssqlserveradmin/giving-users-the-ability-to/#comments</comments>
		<pubDate>Tue, 08 Jan 2013 15:07:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[dcl]]></category>
		<category><![CDATA[permissions]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2012]]></category>
		<category><![CDATA[stored procedures]]></category>

		<guid isPermaLink="false">/index.php/2013/01/giving-users-the-ability-to/</guid>
		<description><![CDATA[I once did some work for a company and noticed that they were running as sysadmin. When I asked why, their answer was that the stored procedures would not work otherwise. This is very bad practice, in general I create a user, and then give execute permi&#8230;]]></description>
				<content:encoded><![CDATA[<p>I once did some work for a company and noticed that they were running as sysadmin. When I asked why, their answer was that the stored procedures would not work otherwise. This is very bad practice, in general I create a user, and then give execute permissions to the procedures. In some instances the user might also get reader and writer permissions.</p>
<p>Yesterday I got a request from a person who wanted to be able to change two stored procedures on the staging server. There is no need to make this person a db_owner, you can just give the ALTER proc permissions. There are two flavors of the syntax</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">ALTER</span> &nbsp;<span class="kw1">ON</span> <span class="kw1">OBJECT</span>::ProcName <span class="kw1">TO</span> UserName
<span class="kw1">GRANT</span> <span class="kw1">ALTER</span> &nbsp;<span class="kw1">ON</span> &nbsp;ProcName <span class="kw1">TO</span> UserName</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT ALTER  ON OBJECT::ProcName TO UserName
GRANT ALTER  ON  ProcName TO UserName</pre></div></div>

<p>Let&#8217;s take a look at this by writing some code. First create a new database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> Test
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE Test
GO</pre></div></div>

<p>Create a user in that database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>master<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>TestUser<span class="br0">&#93;</span> <span class="kw1">WITH</span> PASSW<span class="sy0">OR</span>D<span class="sy0">=</span>N<span class="st0">'Test'</span>, DEFAULT_DATABASE<span class="sy0">=</span><span class="br0">&#91;</span>test<span class="br0">&#93;</span>, CHECK_EXPIRATION<span class="sy0">=</span><span class="kw1">OFF</span>, CHECK_POLICY<span class="sy0">=</span><span class="kw1">OFF</span>
GO
<span class="kw1">USE</span> <span class="br0">&#91;</span>test<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> <span class="kw1">USER</span> <span class="br0">&#91;</span>TestUser<span class="br0">&#93;</span> <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>TestUser<span class="br0">&#93;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [master]
GO
CREATE LOGIN [TestUser] WITH PASSWORD=N'Test', DEFAULT_DATABASE=[test], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO
USE [test]
GO
CREATE USER [TestUser] FOR LOGIN [TestUser]
GO</pre></div></div>

<p>Now create this very simple stored procedure</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">PROC</span> prTest
<span class="kw1">AS</span>
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE PROC prTest
AS
SELECT GETDATE()</pre></div></div>

<p>Open up another connection, login as TestUser with the password Test. If you try to execuce the stored procedure you will get an error</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXEC</span> prTest</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXEC prTest</pre></div></div>

<p>Msg 229, Level 14, State 5, Procedure prTest, Line 1<br />
The EXECUTE permission was denied on the object &#8216;prTest&#8217;, database &#8216;test&#8217;, schema &#8216;dbo&#8217;.</p>
<p>In the window where you have all the permissions, give execute permissions to this stored procedure to the TestUser. You can use GRANT EXECUTE  ON ProcName TO UserName to accomplish this, there is no need to give additional privileges like db_owner or sysadmin</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">EXECUTE</span> &nbsp;<span class="kw1">ON</span> prTest &nbsp;<span class="kw1">TO</span> TestUser</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT EXECUTE  ON prTest  TO TestUser</pre></div></div>

<p>Now you will see that TestUser can execute the stored procedure.</p>
<p>If TestUser wants to modify the stored procedure you can give TestUser  ALTER StoredProc permissions. First let&#8217;s see what happens if TestUser tries to modify the stored procedure before we gave the permissions</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">PROC</span> prTest
<span class="kw1">AS</span>
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER PROC prTest
AS
SELECT GETDATE()</pre></div></div>

<p>And here is the error</p>
<p>Msg 3701, Level 14, State 20, Procedure prTest, Line 3<br />
Cannot alter the procedure &#8216;prTest&#8217;, because it does not exist or you do not have permission.</p>
<p>Execute the following in the window where you have all the permissions</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">ALTER</span> <span class="kw1">ON</span> prTest <span class="kw1">TO</span> TestUser</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT ALTER ON prTest TO TestUser</pre></div></div>

<p>Now run this again in the window where you are logged in as TestUser</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">PROC</span> prTest
<span class="kw1">AS</span>
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER PROC prTest
AS
SELECT GETDATE()</pre></div></div>

<p>As you now saw, this succeeded.</p>
<p>You can also take away privileges, execute the following in the window where you have all the permissions.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">REVOKE</span> <span class="kw1">ALTER</span> <span class="kw1">ON</span> prTest &nbsp;<span class="kw1">TO</span> TestUser</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">REVOKE ALTER ON prTest  TO TestUser</pre></div></div>

<p>Now when you try to alter the stored procedure again it will fail. </p>
<p>Here is the other way to give permissions, I like the other syntax better, it is shorter and there are no double colon characters</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">ALTER</span> &nbsp;<span class="kw1">ON</span> <span class="kw1">OBJECT</span>::prTest <span class="kw1">TO</span> TestUser</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT ALTER  ON OBJECT::prTest TO TestUser</pre></div></div>

<p>Now trying to modify the stored procedure will work again.</p>
<p>There you have it, it is simple to give users access to modify only the stored procedures that you want, no need to give elevated  privileges that might bite you in the butt down the road</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbadmin/mssqlserveradmin/giving-users-the-ability-to/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Why do you need additional privileges for truncate table compared to delete?</title>
		<link>/index.php/datamgmt/datadesign/why-do-you-need-additional/</link>
		<comments>/index.php/datamgmt/datadesign/why-do-you-need-additional/#comments</comments>
		<pubDate>Sun, 07 Oct 2012 12:04:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Administration]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[delete]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[permissions]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2012]]></category>
		<category><![CDATA[truncate table]]></category>

		<guid isPermaLink="false">/index.php/2012/10/why-do-you-need-additional/</guid>
		<description><![CDATA[One of the people on my team wants to have the ability to truncate tables on the staging database while this person is testing, why are special permissions required compared to a delete?]]></description>
				<content:encoded><![CDATA[<p>One of the people on my team wants to have the ability to truncate tables on the staging database while this person is testing. Here is what Books On Line has about permissions for the TRUNCATED statement</p>
<blockquote><p>The minimum permission required is ALTER on table_name. TRUNCATE TABLE permissions default to the table owner, members of the sysadmin fixed server role, and the db_owner and db_ddladmin fixed database roles, and are not transferable.</p></blockquote>
<p>Before I answer why someone would need ALTER TABLE permissions when the person already has DELETE permissions, let&#8217;s run some code that will show the &#8216;problem&#8217;.</p>
<p>First create a Test database, add one table and insert one row</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> Test
go
&nbsp;
<span class="kw1">USE</span> Test
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> TestTruncate<span class="br0">&#40;</span>Id <span class="kw1">int</span><span class="br0">&#41;</span>
GO
&nbsp;
<span class="kw1">INSERT</span> TestTruncate <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE Test
go

USE Test
GO

CREATE TABLE TestTruncate(Id int)
GO

INSERT TestTruncate values(1)
GO</pre></div></div>

<p>Now create a new user and give the user datareader and datawriter permissions</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> master
GO
<span class="kw1">CREATE</span> LOG<span class="sy0">IN</span> TestLogin <span class="kw1">WITH</span> PASSW<span class="sy0">OR</span>D<span class="sy0">=</span>N<span class="st0">'Test'</span>, 
DEFAULT_DATABASE<span class="sy0">=</span>master, CHECK_EXPIRATION<span class="sy0">=</span><span class="kw1">OFF</span>, CHECK_POLICY<span class="sy0">=</span><span class="kw1">OFF</span>
GO
<span class="kw1">USE</span> Test
GO
<span class="kw1">CREATE</span> <span class="kw1">USER</span> TestLogin <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> TestLogin
GO
<span class="kw1">USE</span> Test
GO
<span class="kw1">ALTER</span> <span class="kw1">ROLE</span> db_datareader <span class="kw1">ADD</span> MEMBER TestLogin
GO
<span class="kw1">USE</span> Test
GO
<span class="kw1">ALTER</span> <span class="kw1">ROLE</span> db_datawriter <span class="kw1">ADD</span> MEMBER TestLogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE master
GO
CREATE LOGIN TestLogin WITH PASSWORD=N'Test', 
DEFAULT_DATABASE=master, CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO
USE Test
GO
CREATE USER TestLogin FOR LOGIN TestLogin
GO
USE Test
GO
ALTER ROLE db_datareader ADD MEMBER TestLogin
GO
USE Test
GO
ALTER ROLE db_datawriter ADD MEMBER TestLogin
GO</pre></div></div>

<p>Now that the user is created, login as that user and run the TRUNCATE TABLE command</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">TRUNCATE</span> <span class="kw1">TABLE</span> TestTruncate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">TRUNCATE TABLE TestTruncate</pre></div></div>

<p><em>Msg 1088, Level 16, State 7, Line 1<br />
Cannot find the object &#8220;TestTruncate&#8221; because it does not exist or you do not have permissions.</em></p>
<p>As you can see, you don&#8217;t have permission. A delete will work just fine</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DELETE</span> TestTruncate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DELETE TestTruncate</pre></div></div>

<p>(1 row(s) affected)</p>
<p>Before I give you a workaround, let&#8217;s try to figure out why the minimum requirement is ALTER TABLE. What is the difference between a DELETE and a TRUNCATE in terms of logging? When  a TRUNCATE occurs, the operation does not log individual row deletions, a DELETE operation does. The reason this is important is because if you have a trigger on the table, in needs to be disabled before the TRUNCATE occurs. <strong>Now you know why ALTER TABLE is required, triggers need to be disabled.</strong></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TABLE</span> SomeTable DISABLE <span class="kw1">TRIGGER</span> SomeTrigger</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TABLE SomeTable DISABLE TRIGGER SomeTrigger</pre></div></div>

<p>And in order to disable the trigger, ALTER TABLE permissions are required as a minimum.</p>
<p>But I don&#8217;t want people altering tables on our staging and QA servers, so here is one way of giving the person the ability to TRUNCATE a table without giving them permissions explicitly. Create a stored procedure and use WITH EXECUTE AS, this will define the execution context of the stored procedure. In the example below, I picked a user that has sufficient privileges to perform the TRUNCATE.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">PROCEDURE</span> prTruncate
<span class="kw1">WITH</span> <span class="kw1">EXECUTE</span> <span class="kw1">AS</span> <span class="st0">'SuperUser'</span>
<span class="kw1">AS</span>
<span class="kw1">TRUNCATE</span> <span class="kw1">TABLE</span> TestTruncate
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE PROCEDURE prTruncate
WITH EXECUTE AS 'SuperUser'
AS
TRUNCATE TABLE TestTruncate
GO</pre></div></div>

<p>All you have to do is give your user execute permissions to the stored procedure you just created</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">EXECUTE</span> <span class="kw1">ON</span> prTruncate <span class="kw1">TO</span> TestLogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT EXECUTE ON prTruncate TO TestLogin
GO</pre></div></div>

<p>Now if you execute the stored procedure as the TestLogin user, you will see it will run just fine</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXEC</span> prTruncate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXEC prTruncate</pre></div></div>

<p>Hope this helps someone in the future who is filling up his log these days</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/why-do-you-need-additional/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Do you still use sp_change_users_login instead of ALTER USER UserName WITH LOGIN = UserName</title>
		<link>/index.php/datamgmt/datadesign/do-you-still-use-sp_change_users_login/</link>
		<comments>/index.php/datamgmt/datadesign/do-you-still-use-sp_change_users_login/#comments</comments>
		<pubDate>Fri, 03 Jun 2011 14:03:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Administration]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[permissions]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2008 r2]]></category>

		<guid isPermaLink="false">/index.php/2011/06/do-you-still-use-sp_change_users_login/</guid>
		<description><![CDATA[If you are on SQL Server 2005 and up and you are still using sp_change_users_login (I know old habits die slow) then listen up, there is an easier way to fix permissions.

If you have a login on one server and you have the same login on another server&#8230;]]></description>
				<content:encoded><![CDATA[<p>If you are on SQL Server 2005 and up and you are still using sp_change_users_login (I know old habits die slow) then listen up, there is an easier way to fix permissions.</p>
<p>If you have a login on one server and you have the same login on another server and you did not use the sp_help_revlogin to create the login with the same SID then you have 2 options. drop and create the user(and apply all the permissions) or you can map the existing database user to a SQL Server login.</p>
<p>This is the old way</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'Update_One'</span>, <span class="st0">'UserName'</span>, <span class="st0">'UserName'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE sp_change_users_login 'Update_One', 'UserName', 'UserName'</pre></div></div>

<p>And here is the new way, much cleaner</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">USER</span> UserName <span class="kw1">WITH</span> LOG<span class="sy0">IN</span> <span class="sy0">=</span> UserName</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER USER UserName WITH LOGIN = UserName</pre></div></div>

<p>Let&#8217;s write some code and see how this all works</p>
<p>First we are creating a new user named TestLogin</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>master<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>TestLogin<span class="br0">&#93;</span> <span class="kw1">WITH</span> PASSW<span class="sy0">OR</span>D<span class="sy0">=</span>N<span class="st0">'test'</span>, DEFAULT_DATABASE<span class="sy0">=</span><span class="br0">&#91;</span>master<span class="br0">&#93;</span>, CHECK_EXPIRATION<span class="sy0">=</span><span class="kw1">OFF</span>, CHECK_POLICY<span class="sy0">=</span><span class="kw1">OFF</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [master]
GO
CREATE LOGIN [TestLogin] WITH PASSWORD=N'test', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO</pre></div></div>

<p>Now it is time to create a new database, in this database we will create the user TestLogin</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> TestLogin
GO
&nbsp;
<span class="kw1">USE</span> TestLogin
GO
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">USER</span> TestLogin <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> TestLogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE TestLogin
GO

USE TestLogin
GO


CREATE USER TestLogin FOR LOGIN TestLogin
GO</pre></div></div>

<p>Now we will backup the database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> master
GO
&nbsp;
<span class="kw1">BACKUP</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">TO</span> &nbsp;<span class="kw1">DISK</span> <span class="sy0">=</span> N<span class="st0">'c:TempTestLogin.BAK'</span> <span class="kw1">WITH</span> NOF<span class="sy0">OR</span>MAT, <span class="sy0">IN</span>IT, &nbsp;NAME <span class="sy0">=</span> N<span class="st0">'TestLogin-Full'</span>, 
SKIP, N<span class="sy0">OR</span>EW<span class="sy0">IN</span>D, NOUNLOAD, &nbsp;STATS <span class="sy0">=</span> <span class="nu0">10</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE master
GO

BACKUP DATABASE TestLogin TO  DISK = N'c:TempTestLogin.BAK' WITH NOFORMAT, INIT,  NAME = N'TestLogin-Full', 
SKIP, NOREWIND, NOUNLOAD,  STATS = 10</pre></div></div>

<p>And now we can drop the database since we will create it again later anyhow</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> master
GO
&nbsp;
<span class="kw1">DROP</span> <span class="kw1">DATABASE</span> TestLogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE master
GO

DROP DATABASE TestLogin
GO</pre></div></div>

<p>Since I want to show you the code so that you can run it on the same server, we will just drop and recreate the login</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>master<span class="br0">&#93;</span>
GO
&nbsp;
<span class="kw1">IF</span> &nbsp;<span class="sy0">EXISTS</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> sys.<span class="me1">server_principals</span> <span class="kw1">WHERE</span> name <span class="sy0">=</span> N<span class="st0">'TestLogin'</span><span class="br0">&#41;</span>
<span class="kw1">DROP</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>TestLogin<span class="br0">&#93;</span>
GO
&nbsp;
&nbsp;
<span class="kw1">USE</span> <span class="br0">&#91;</span>master<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>TestLogin<span class="br0">&#93;</span> <span class="kw1">WITH</span> PASSW<span class="sy0">OR</span>D<span class="sy0">=</span>N<span class="st0">'test'</span>, DEFAULT_DATABASE<span class="sy0">=</span><span class="br0">&#91;</span>master<span class="br0">&#93;</span>, CHECK_EXPIRATION<span class="sy0">=</span><span class="kw1">OFF</span>, CHECK_POLICY<span class="sy0">=</span><span class="kw1">OFF</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [master]
GO

IF  EXISTS (SELECT * FROM sys.server_principals WHERE name = N'TestLogin')
DROP LOGIN [TestLogin]
GO


USE [master]
GO
CREATE LOGIN [TestLogin] WITH PASSWORD=N'test', DEFAULT_DATABASE=[master], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO</pre></div></div>

<p>Now, we will create the same database again with the same user</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> TestLogin
GO
&nbsp;
<span class="kw1">USE</span> TestLogin
GO
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">USER</span> TestLogin <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> TestLogin
GO
&nbsp;
<span class="kw1">USE</span> master
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE TestLogin
GO

USE TestLogin
GO


CREATE USER TestLogin FOR LOGIN TestLogin
GO

USE master
GO</pre></div></div>

<p>Go ahead and restore the backup we created before</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">SET</span> S<span class="sy0">IN</span>GLE_USER <span class="kw1">WITH</span> <span class="kw1">ROLLBACK</span> <span class="kw1">IMMEDIATE</span>
GO
&nbsp;
<span class="kw1">RESTORE</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">FROM</span> &nbsp;<span class="kw1">DISK</span> <span class="sy0">=</span> N<span class="st0">'c:TempTestLogin.BAK'</span> <span class="kw1">WITH</span> &nbsp;<span class="kw1">FILE</span> <span class="sy0">=</span> <span class="nu0">1</span>,
NOUNLOAD, &nbsp;<span class="kw2">REPLACE</span>, &nbsp;STATS <span class="sy0">=</span> <span class="nu0">10</span>
GO
&nbsp;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">SET</span> MULTI_USER <span class="kw1">WITH</span> <span class="kw1">ROLLBACK</span> <span class="kw1">IMMEDIATE</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER DATABASE TestLogin SET SINGLE_USER WITH ROLLBACK IMMEDIATE
GO

RESTORE DATABASE TestLogin FROM  DISK = N'c:TempTestLogin.BAK' WITH  FILE = 1,
NOUNLOAD,  REPLACE,  STATS = 10
GO


ALTER DATABASE TestLogin SET MULTI_USER WITH ROLLBACK IMMEDIATE
GO</pre></div></div>

<p>We now will use this database and use the sp_change_users_login procedure to see if any SIDs are mismatched</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> TestLogin
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'report'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE TestLogin
GO

EXECUTE sp_change_users_login 'report'</pre></div></div>

<p>On my machine, I get the following back</p>
<pre>UserName	UserSID
TestLogin	0x7ED6E205155E9C40BA684E72453BAE1B</pre>
<p>We can easily test this because if you try to login as that user and then execute the command below you will get an error message</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> testlogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE testlogin
GO</pre></div></div>

<p>Msg 916, Level 14, State 1, Line 1<br />
The server principal &#8220;TestLogin&#8221; is not able to access the database &#8220;TestLogin&#8221; under the current security context.</p>
<p>Leave that query window open for now, we will get back to it later.<br />
Now let&#8217;s fix the user by mapping the user to the login</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'Update_One'</span>, <span class="st0">'TestLogin'</span>, <span class="st0">'TestLogin'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE sp_change_users_login 'Update_One', 'TestLogin', 'TestLogin'</pre></div></div>

<p>Now this query doesn&#8217;t return any rows since the user has been fixed</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'report'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE sp_change_users_login 'report'</pre></div></div>

<p>Now refresh the query or connect again and run this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> testlogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE testlogin
GO</pre></div></div>

<p>As you can see it is fine now</p>
<p>Disconnect from the DB with the TestLogin account and then drop the database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> master
GO
&nbsp;
<span class="kw1">DROP</span> <span class="kw1">DATABASE</span> TestLogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE master
GO

DROP DATABASE TestLogin
GO</pre></div></div>

<p>We will create the database again, create the user again and finally we will restore the database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> master
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> TestLogin
GO
&nbsp;
<span class="kw1">USE</span> TestLogin
GO
&nbsp;
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">USER</span> TestLogin <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> TestLogin
GO
&nbsp;
<span class="kw1">USE</span> master
GO
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">SET</span> S<span class="sy0">IN</span>GLE_USER <span class="kw1">WITH</span> <span class="kw1">ROLLBACK</span> <span class="kw1">IMMEDIATE</span>
GO
&nbsp;
<span class="kw1">RESTORE</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">FROM</span> &nbsp;<span class="kw1">DISK</span> <span class="sy0">=</span> N<span class="st0">'c:TempTestLogin.BAK'</span> <span class="kw1">WITH</span> &nbsp;<span class="kw1">FILE</span> <span class="sy0">=</span> <span class="nu0">1</span>,
NOUNLOAD, &nbsp;<span class="kw2">REPLACE</span>, &nbsp;STATS <span class="sy0">=</span> <span class="nu0">10</span>
GO
&nbsp;
&nbsp;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">DATABASE</span> TestLogin <span class="kw1">SET</span> MULTI_USER <span class="kw1">WITH</span> <span class="kw1">ROLLBACK</span> <span class="kw1">IMMEDIATE</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE master
GO

CREATE DATABASE TestLogin
GO

USE TestLogin
GO


CREATE USER TestLogin FOR LOGIN TestLogin
GO

USE master
GO

ALTER DATABASE TestLogin SET SINGLE_USER WITH ROLLBACK IMMEDIATE
GO

RESTORE DATABASE TestLogin FROM  DISK = N'c:TempTestLogin.BAK' WITH  FILE = 1,
NOUNLOAD,  REPLACE,  STATS = 10
GO



ALTER DATABASE TestLogin SET MULTI_USER WITH ROLLBACK IMMEDIATE
GO</pre></div></div>

<p>Just as before, we are getting back the mis matched SID</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> TestLogin
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'report'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE TestLogin
GO

EXECUTE sp_change_users_login 'report'</pre></div></div>

<p>
<pre>UserName	UserSID
TestLogin	0x7ED6E205155E9C40BA684E72453BAE1B</pre>
<p>You will get the same error from before if you try to connect to this database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> testlogin
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE testlogin
GO</pre></div></div>

<p>Msg 916, Level 14, State 1, Line 1<br />
The server principal &#8220;TestLogin&#8221; is not able to access the database &#8220;TestLogin&#8221; under the current security context.</p>
<p>Here is how to do the same thing with ALTER USER as with sp_change_users_login </p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">USER</span> TestLogin <span class="kw1">WITH</span> LOG<span class="sy0">IN</span> <span class="sy0">=</span> TestLogin</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER USER TestLogin WITH LOGIN = TestLogin</pre></div></div>

<p>As you can see, this doesn&#8217;t return anything anymore</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">sp_change_users_login</span> <span class="st0">'report'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE sp_change_users_login 'report'</pre></div></div>

<p>So, start using ALTER USER UserName WITH LOGIN = UserName instead of sp_change_users_login to fix the mappings, sp_change_users_login  is on the <del>endangered</del> deprecated list and will be removed in a feature versions.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/do-you-still-use-sp_change_users_login/feed/</wfw:commentRss>
		<slash:comments>10</slash:comments>
		</item>
		<item>
		<title>What does the lock icon mean in SSMS when looking at a stored procedure?</title>
		<link>/index.php/datamgmt/datadesign/what-does-the-lock-icon/</link>
		<comments>/index.php/datamgmt/datadesign/what-does-the-lock-icon/#comments</comments>
		<pubDate>Wed, 06 Apr 2011 12:37:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[permissions]]></category>
		<category><![CDATA[ssms]]></category>
		<category><![CDATA[stored procedures]]></category>

		<guid isPermaLink="false">/index.php/2011/04/what-does-the-lock-icon/</guid>
		<description><![CDATA[SQL Server Management Studio will sometimes show a lock next to a stored procedure, there are several reasons why this might happen.

The procedure is encrypted
The procedure is a CLR stored procedure
The user doesn't have the view definition permis&#8230;]]></description>
				<content:encoded><![CDATA[<p>SQL Server Management Studio will sometimes show a lock next to a stored procedure, there are several reasons why this might happen.</p>
<p>The procedure is encrypted<br />
The procedure is a CLR stored procedure<br />
The user doesn&#8217;t have the view definition permission for a stored proc</p>
<p>Let&#8217;s take a look at how this all works.</p>
<p>I will first create this database with two stored procedures, one is encrypted, the other one is not</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> bla
GO
&nbsp;
<span class="kw1">USE</span> bla
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">PROCEDURE</span> prTest
<span class="kw1">AS</span>
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">PROCEDURE</span> prTestEncrypted <span class="kw1">WITH</span> ENCRYPTION
<span class="kw1">AS</span>
<span class="kw1">SELECT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE bla
GO

USE bla
GO

CREATE PROCEDURE prTest
AS
SELECT GETDATE()
GO

CREATE PROCEDURE prTestEncrypted WITH ENCRYPTION
AS
SELECT GETDATE()
GO</pre></div></div>

<p>Now when I navigate to the Stored Procedures folder I see the following</p>
<p><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/.evocache/Permissions.PNG/fit-400x320.PNG?mtime=1302099806" width="242" height="228" /></p>
<p>As you can see there is a lock on the encrypted stored procedure</p>
<p>Now, let&#8217;s create a new user with data reader and writer permissions</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>master<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>test<span class="br0">&#93;</span> <span class="kw1">WITH</span> PASSW<span class="sy0">OR</span>D<span class="sy0">=</span>N<span class="st0">'test'</span>, DEFAULT_DATABASE<span class="sy0">=</span><span class="br0">&#91;</span>bla<span class="br0">&#93;</span>, CHECK_EXPIRATION<span class="sy0">=</span><span class="kw1">OFF</span>, CHECK_POLICY<span class="sy0">=</span><span class="kw1">OFF</span>
GO
<span class="kw1">USE</span> <span class="br0">&#91;</span>bla<span class="br0">&#93;</span>
GO
<span class="kw1">CREATE</span> <span class="kw1">USER</span> <span class="br0">&#91;</span>test<span class="br0">&#93;</span> <span class="kw1">FOR</span> LOG<span class="sy0">IN</span> <span class="br0">&#91;</span>test<span class="br0">&#93;</span>
GO
<span class="kw1">USE</span> <span class="br0">&#91;</span>bla<span class="br0">&#93;</span>
GO
<span class="kw1">EXEC</span> <span class="kw3">sp_addrolemember</span> N<span class="st0">'db_datareader'</span>, N<span class="st0">'test'</span>
GO
<span class="kw1">USE</span> <span class="br0">&#91;</span>bla<span class="br0">&#93;</span>
GO
<span class="kw1">EXEC</span> <span class="kw3">sp_addrolemember</span> N<span class="st0">'db_datawriter'</span>, N<span class="st0">'test'</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [master]
GO
CREATE LOGIN [test] WITH PASSWORD=N'test', DEFAULT_DATABASE=[bla], CHECK_EXPIRATION=OFF, CHECK_POLICY=OFF
GO
USE [bla]
GO
CREATE USER [test] FOR LOGIN [test]
GO
USE [bla]
GO
EXEC sp_addrolemember N'db_datareader', N'test'
GO
USE [bla]
GO
EXEC sp_addrolemember N'db_datawriter', N'test'
GO</pre></div></div>

<p>When I now login as that user I don&#8217;t see anything under the stored procedures folder.</p>
<p><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/.evocache/Permissions2.PNG/fit-400x320.PNG?mtime=1302099815" width="269" height="173" /><br />
<br />In order to see the procedures, the user has to have execute permissions.<br />
If I give execute permissions to the stored procedures for the user like this, the user should see them.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">EXECUTE</span> <span class="kw1">ON</span> prTestEncrypted <span class="kw1">TO</span> test
<span class="kw1">GRANT</span> <span class="kw1">EXECUTE</span> <span class="kw1">ON</span> prTest <span class="kw1">TO</span> test</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT EXECUTE ON prTestEncrypted TO test
GRANT EXECUTE ON prTest TO test</pre></div></div>

<p>The user will now see both procs with a lock on them</p>
<p><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/.evocache/Permissions3.PNG/fit-400x320.PNG?mtime=1302099825" width="267" height="199" /></p>
<p>If I grant view definition to the user&#8230;.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">GRANT</span> <span class="kw1">VIEW</span> DEF<span class="sy0">IN</span>ITION <span class="kw1">ON</span> prTestEncrypted <span class="kw1">TO</span> test
<span class="kw1">GRANT</span> <span class="kw1">VIEW</span> DEF<span class="sy0">IN</span>ITION <span class="kw1">ON</span> prTest <span class="kw1">TO</span> test</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">GRANT VIEW DEFINITION ON prTestEncrypted TO test
GRANT VIEW DEFINITION ON prTest TO test</pre></div></div>

<p>The user will now see the lock only on the encrypted stored procedures, just like if he/she was a db owner</p>
<p><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/.evocache/Permissions.PNG/fit-400x320.PNG?mtime=1302099806" width="242" height="228" /></p>
<p>I think there should be different lock icons in SSMS, this way you will now if the proc is encrypted or that you don&#8217;t have view definition permissions&#8230;what do you think?</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/what-does-the-lock-icon/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
	</channel>
</rss>
