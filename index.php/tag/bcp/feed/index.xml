<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>bcp &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/bcp/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>BCP all tables into files from a database</title>
		<link>/index.php/datamgmt/dbprogramming/bcp-all-tables-into-files/</link>
		<comments>/index.php/datamgmt/dbprogramming/bcp-all-tables-into-files/#respond</comments>
		<pubDate>Sun, 31 Mar 2013 11:42:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Database Administration]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[bcp]]></category>
		<category><![CDATA[bulk export]]></category>
		<category><![CDATA[bulk import]]></category>
		<category><![CDATA[data migration]]></category>

		<guid isPermaLink="false">/index.php/2013/03/bcp-all-tables-into-files/</guid>
		<description><![CDATA[Sometimes you want to dump the data from all the tables in a database into files. There is really no fast and easy way to do this. Fortunately it is very easy to roll your own solution. Let's look at what we need to do

1) we need to grab all the tabl&#8230;]]></description>
				<content:encoded><![CDATA[<p>Sometimes you want to dump the data from all the tables in a database into files. There is really no fast and easy way to do this. Fortunately it is very easy to roll your own solution. Let&#8217;s look at what we need to do</p>
<p>1) we need to grab all the tables in the database<br />
2) we need to make sure that the table names are valid<br />
3) we need to specify the output directory<br />
4) we need to make sure that the file names are valid<br />
5) we need to specify how we are connecting to SQL Server</p>
<p><strong>We need to grab all the tables in the database</strong><br />
The query to grab all the names is</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> name <span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT name FROM sys.tables</pre></div></div>

<p>However if you use schemas then that won&#8217;t work, you need to do the following</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> SCHEMA_NAME<span class="br0">&#40;</span>SCHEMA_ID<span class="br0">&#41;</span>,name 
<span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT SCHEMA_NAME(SCHEMA_ID),name 
FROM sys.tables</pre></div></div>

<p>The reason for this is that you can have the same table name in different schemas, you would only get the one in the default schema</p>
<p><strong>We need to make sure that the table names are valid</strong><br />
Sometimes you have table names that have spaces in them or start perhaps with a number. If you have tables like that, you have to put brackets around it. One way to put brackets around tables names is to just do something like this <code>'[' + name + ']'</code> another way is to use the QUOTENAME function</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> &nbsp; <span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>SCHEMA_ID<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT   QUOTENAME(SCHEMA_NAME(SCHEMA_ID))+ '.'
+  QUOTENAME(name) FROM sys.tables</pre></div></div>

<p><strong>We need to specify the output directory</strong><br />
You need to tell bcp where to dump the files</p>
<p><strong>We need to make sure that the file names are valid</strong><br />
Windows does not allow for certain characters in file names</p>
<p>< (less than)
> (greater than)<br />
: (colon)<br />
&#8221; (double quote)<br />
/ (forward slash)<br />
 (backslash)<br />
| (vertical bar or pipe)<br />
? (question mark)<br />
* (asterisk)<br />
If you have to give the files to be imported on a Linux/unix systems then you want to eliminate spaces as well<br />
In that case you end up with something like this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> &nbsp; &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>schema_id<span class="br0">&#41;</span>,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'_'</span> 
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>name,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> 
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span> <span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT    REPLACE(SCHEMA_NAME(schema_id),' ','') + '_' 
+  REPLACE(name,' ','') 
+  QUOTENAME(name) FROM sys.tables</pre></div></div>

<p><strong>We need to specify how we are connecting to SQL Server</strong><br />
You can use password and username to connect to SQL Server or you can use a trusted connections</p>
<h2>Putting it all together</h2>
<p>Here is the complete query</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="st0">'EXEC xp_cmdshell '</span><span class="st0">'bcp '</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--bcp</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="kw2">DB_NAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--database name</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>SCHEMA_ID<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp;<span class="co1">-- schema</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- table</span>
<span class="sy0">+</span> <span class="st0">' out c:temp'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- output directory</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>schema_id<span class="br0">&#41;</span>,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'_'</span> 
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>name,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- file name</span>
<span class="sy0">+</span> <span class="st0">'.txt -T -c'</span><span class="st0">''</span> &nbsp; <span class="co1">-- extension, security </span>
<span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT 'EXEC xp_cmdshell ''bcp '           --bcp
+  QUOTENAME(DB_NAME())+ '.'               --database name
+  QUOTENAME(SCHEMA_NAME(SCHEMA_ID))+ '.'  -- schema
+  QUOTENAME(name)						   -- table
+ ' out c:temp'                          -- output directory
+  REPLACE(SCHEMA_NAME(schema_id),' ','') + '_' 
+  REPLACE(name,' ','')                    -- file name
+ '.txt -T -c'''   -- extension, security 
FROM sys.tables</pre></div></div>

<p>Running that query will give you something like the following</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Production].[ScrapReason] out c:tempProduction_ScrapReason.txt -T -c'</span>
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[HumanResources].[Shift] out c:tempHumanResources_Shift.txt -T -c'</span>
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Production].[ProductCategory] out c:tempProduction_ProductCategory.txt -T -c'</span>
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Purchasing].[ShipMethod] out c:tempPurchasing_ShipMethod.txt -T -c'</span>
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Production].[ProductCostHistory] out c:tempProduction_ProductCostHistory.txt -T -c'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Production].[ScrapReason] out c:tempProduction_ScrapReason.txt -T -c'

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[HumanResources].[Shift] out c:tempHumanResources_Shift.txt -T -c'

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Production].[ProductCategory] out c:tempProduction_ProductCategory.txt -T -c'

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Purchasing].[ShipMethod] out c:tempPurchasing_ShipMethod.txt -T -c'

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Production].[ProductCostHistory] out c:tempProduction_ProductCostHistory.txt -T -c'</pre></div></div>

<p>You can now take that and run it. When you run it, you will see the following output</p>
<p>NULL<br />
Starting copy&#8230;<br />
NULL<br />
32 rows copied.<br />
Network packet size (bytes): 4096<br />
Clock Time (ms.) Total     : 1      Average : (32000.00 rows per sec.)<br />
NULL</p>
<p>Sometines you don&#8217;t want to see that output,In that case we need to <a href="/index.php/DataMgmt/DBAdmin/MSSQLServerAdmin/supressing-xp_cmdshell-output">suppress xp_cmdshell output</a>, you do this by adding ,no_output at the end</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="st0">'EXEC xp_cmdshell '</span><span class="st0">'bcp '</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--bcp</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="kw2">DB_NAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--database name</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>SCHEMA_ID<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp;<span class="co1">-- schema</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- table</span>
<span class="sy0">+</span> <span class="st0">' out c:temp'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- output directory</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>schema_id<span class="br0">&#41;</span>,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'_'</span> 
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>name,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- file name</span>
<span class="sy0">+</span> <span class="st0">'.txt -T -c'</span><span class="st0">',no_output'</span> &nbsp; <span class="co1">-- extension, security, no output </span>
<span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT 'EXEC xp_cmdshell ''bcp '           --bcp
+  QUOTENAME(DB_NAME())+ '.'               --database name
+  QUOTENAME(SCHEMA_NAME(SCHEMA_ID))+ '.'  -- schema
+  QUOTENAME(name)						   -- table
+ ' out c:temp'                          -- output directory
+  REPLACE(SCHEMA_NAME(schema_id),' ','') + '_' 
+  REPLACE(name,' ','')                    -- file name
+ '.txt -T -c'',no_output'   -- extension, security, no output 
FROM sys.tables</pre></div></div>

<p>Now you get something like the following</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Production].[ScrapReason] out c:tempProduction_ScrapReason.txt -T -c'</span>,no_output
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[HumanResources].[Shift] out c:tempHumanResources_Shift.txt -T -c'</span>,no_output
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Production].[ProductCategory] out c:tempProduction_ProductCategory.txt -T -c'</span>,no_output
&nbsp;
<span class="kw1">EXEC</span> xp_cmdshell <span class="st0">'bcp [AdventureWorks2012].[Purchasing].[ShipMethod] out c:tempPurchasing_ShipMethod.txt -T -c'</span>,no_output</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Production].[ScrapReason] out c:tempProduction_ScrapReason.txt -T -c',no_output

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[HumanResources].[Shift] out c:tempHumanResources_Shift.txt -T -c',no_output

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Production].[ProductCategory] out c:tempProduction_ProductCategory.txt -T -c',no_output

EXEC xp_cmdshell 'bcp [AdventureWorks2012].[Purchasing].[ShipMethod] out c:tempPurchasing_ShipMethod.txt -T -c',no_output</pre></div></div>

<p>There you have it, a quick and dirty version to dump all the tables into files.</p>
<p>You can of course enhance this by creating a proc where you can specify only a certain schema, delimiters, how to connect etc etc</p>
<p>If you don&#8217;t want to use xp_cmdshell, you can also dump the results without the xp_cmdshell part into a BAT file and call it from DOS or PowerShell</p>
<p>That query would look like this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="st0">'bcp '</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--bcp</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span><span class="kw2">DB_NAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">--database name</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>SCHEMA_ID<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">+</span> <span class="st0">'.'</span> &nbsp;<span class="co1">-- schema</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">QUOTENAME</span><span class="br0">&#40;</span>name<span class="br0">&#41;</span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- table</span>
<span class="sy0">+</span> <span class="st0">' out c:temp'</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- output directory</span>
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>SCHEMA_NAME<span class="br0">&#40;</span>schema_id<span class="br0">&#41;</span>,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="st0">'_'</span> 
<span class="sy0">+</span> &nbsp;<span class="kw2">REPLACE</span><span class="br0">&#40;</span>name,<span class="st0">' '</span>,<span class="st0">''</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="co1">-- file name</span>
<span class="sy0">+</span> <span class="st0">'.txt -T -c'</span> &nbsp; <span class="co1">-- extension, security, </span>
<span class="kw1">FROM</span> sys.<span class="me1">tables</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT 'bcp '           --bcp
+  QUOTENAME(DB_NAME())+ '.'               --database name
+  QUOTENAME(SCHEMA_NAME(SCHEMA_ID))+ '.'  -- schema
+  QUOTENAME(name)						   -- table
+ ' out c:temp'                          -- output directory
+  REPLACE(SCHEMA_NAME(schema_id),' ','') + '_' 
+  REPLACE(name,' ','')                    -- file name
+ '.txt -T -c'   -- extension, security, 
FROM sys.tables</pre></div></div>

]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbprogramming/bcp-all-tables-into-files/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>BULK INSERT data where the row terminator is a linefeed in SQL Server</title>
		<link>/index.php/datamgmt/dbadmin/mssqlserveradmin/bulk-insert-data-where-the/</link>
		<comments>/index.php/datamgmt/dbadmin/mssqlserveradmin/bulk-insert-data-where-the/#comments</comments>
		<pubDate>Thu, 14 Feb 2013 13:38:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Business Intelligence]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[bcp]]></category>
		<category><![CDATA[bulk insert]]></category>
		<category><![CDATA[files]]></category>
		<category><![CDATA[import]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2012]]></category>

		<guid isPermaLink="false">/index.php/2013/02/bulk-insert-data-where-the/</guid>
		<description><![CDATA[I like to use BULK INSERT or bcp as much as possible, this is especially true if all I need to do is dump the file into a table. For more complex things I will go the SSIS route. Files are generated by all kinds of systems these days, these can be Windo&#8230;]]></description>
				<content:encoded><![CDATA[<p>I like to use BULK INSERT or bcp as much as possible, this is especially true if all I need to do is dump the file into a table. For more complex things I will go the SSIS route. Files are generated by all kinds of systems these days, these can be Windows, *nix, Mac, Amiga and other systems. </p>
<p>Make sure to use something other than notepad when dealing with these files and you want to look at them. Notepad++ or Editplus have more functionality and are many times faster than notepad. The nice thing about either of these is that you can see control characters.</p>
<p>See how you can see the linefeeds here? Can&#8217;t do that in notepad</p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/Denis/LineFeedFile.PNG?mtime=1360855487"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/Denis/LineFeedFile.PNG?mtime=1360855487" width="421" height="223" /></a></div>
<p>So let&#8217;s say you get a file where the row terminator is a linefeed, how would you specify that as a row terminator in BULK INSERT?</p>
<p>You can try newline</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BULK</span> <span class="kw1">INSERT</span> SomeTable
&nbsp; &nbsp;<span class="kw1">FROM</span> <span class="st0">'D:JunkdrawImportMe.txt'</span>
&nbsp; &nbsp;<span class="kw1">WITH</span> <span class="br0">&#40;</span>FIELDTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'t'</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FIRSTROW <span class="sy0">=</span><span class="nu0">2</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ROWTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'n'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BULK INSERT SomeTable
   FROM 'D:JunkdrawImportMe.txt'
   WITH (FIELDTERMINATOR = 't',
         FIRSTROW =2,
         ROWTERMINATOR = 'n')</pre></div></div>

<p>Nope, that doesn&#8217;t work, you get 0 rows inserted</p>
<p>You can try carriage return</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BULK</span> <span class="kw1">INSERT</span> SomeTable
&nbsp; &nbsp;<span class="kw1">FROM</span> <span class="st0">'D:JunkdrawImportMe.txt'</span>
&nbsp; &nbsp;<span class="kw1">WITH</span> <span class="br0">&#40;</span>FIELDTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'t'</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FIRSTROW <span class="sy0">=</span><span class="nu0">2</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ROWTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'r'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BULK INSERT SomeTable
   FROM 'D:JunkdrawImportMe.txt'
   WITH (FIELDTERMINATOR = 't',
         FIRSTROW =2,
         ROWTERMINATOR = 'r')</pre></div></div>

<p>Nope, that doesn&#8217;t work either, you get 0 rows inserted</p>
<p>What about l for linefeed?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BULK</span> <span class="kw1">INSERT</span> SomeTable
&nbsp; &nbsp;<span class="kw1">FROM</span> <span class="st0">'D:JunkdrawImportMe.txt'</span>
&nbsp; &nbsp;<span class="kw1">WITH</span> <span class="br0">&#40;</span>FIELDTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'t'</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FIRSTROW <span class="sy0">=</span><span class="nu0">2</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ROWTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'l'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BULK INSERT SomeTable
   FROM 'D:JunkdrawImportMe.txt'
   WITH (FIELDTERMINATOR = 't',
         FIRSTROW =2,
         ROWTERMINATOR = 'l')</pre></div></div>

<p>You get an error</p>
<p>Msg 4864, Level 16, State 1, Line 1<br />
Bulk load data conversion error (type mismatch or invalid character for the specified codepage) for row 2, column 1 (SomeDate).</p>
<p>What about if you try a CHAR(10) which is a linefeed</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">BULK</span> <span class="kw1">INSERT</span> SomeTable
&nbsp; &nbsp;<span class="kw1">FROM</span> <span class="st0">'D:JunkdrawImportMe.txt'</span>
&nbsp; &nbsp;<span class="kw1">WITH</span> <span class="br0">&#40;</span>FIELDTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="st0">'t'</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FIRSTROW <span class="sy0">=</span><span class="nu0">2</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ROWTERM<span class="sy0">IN</span>AT<span class="sy0">OR</span> <span class="sy0">=</span> <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span> <span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">BULK INSERT SomeTable
   FROM 'D:JunkdrawImportMe.txt'
   WITH (FIELDTERMINATOR = 't',
         FIRSTROW =2,
         ROWTERMINATOR = CHAR(10) )</pre></div></div>

<p>You get this error<br />
Msg 102, Level 15, State 1, Line 5<br />
Incorrect syntax near &#8216;CHAR&#8217;.</p>
<p>Mmm, what if you embed it from within Dynamic SQL</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @cmd <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">1000</span><span class="br0">&#41;</span>
<span class="kw1">SET</span> @cmd <span class="sy0">=</span> <span class="st0">'BULK INSERT SomeTable</span>
<span class="st0">FROM '</span><span class="st0">'D:JunkdrawImportMe.txt'</span><span class="st0">'</span>
<span class="st0">WITH ( &nbsp; &nbsp; &nbsp;FIELDTERMINATOR = '</span><span class="st0">'t'</span><span class="st0">',</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FIRSTROW =2,</span>
<span class="st0"> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;ROWTERMINATOR = '</span><span class="st0">''</span><span class="sy0">+</span><span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="st0">''</span><span class="st0">')'</span>
<span class="kw1">EXEC</span><span class="br0">&#40;</span>@cmd<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @cmd varchar(1000)
SET @cmd = 'BULK INSERT SomeTable
FROM ''D:JunkdrawImportMe.txt''
WITH (      FIELDTERMINATOR = ''t'',
            FIRSTROW =2,
            ROWTERMINATOR = '''+CHAR(10)+''')'
EXEC(@cmd)</pre></div></div>

<p>Bingo, that works.  Keep this in mind next time you get a file with a linefeed and you are struggling importing that file</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbadmin/mssqlserveradmin/bulk-insert-data-where-the/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		</item>
		<item>
		<title>How to copy data/append data into files from within T-SQL</title>
		<link>/index.php/datamgmt/datadesign/how-to-copy-data-append-data-into-files/</link>
		<comments>/index.php/datamgmt/datadesign/how-to-copy-data-append-data-into-files/#respond</comments>
		<pubDate>Mon, 06 Jul 2009 14:17:16 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[bcp]]></category>
		<category><![CDATA[bulk copy]]></category>
		<category><![CDATA[data]]></category>
		<category><![CDATA[files]]></category>
		<category><![CDATA[openrowset]]></category>

		<guid isPermaLink="false">/index.php/2009/07/how-to-copy-data-append-data-into-files/</guid>
		<description><![CDATA[Sometimes you want to quickly copy some data into a text file or you want append some data to a text file but you don&#8217;t feel like opening BIDS or the DTS designer. Here is a way to accomplish what you want from within a query window To copy data into a new file use [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Sometimes you want to quickly copy some data into a text file or you want append some data to a text file but you don&#8217;t feel like opening BIDS or the DTS designer. Here is a way to accomplish what you want from within a query window<br />
To copy data into a new file use BCP (Bulk Copy Program). To append to a file use OPENROWSET</p>
<p>Here is some sample code. First create this table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="de1"><pre class="de1"><span class="kw1">use</span> tempdb
go
&nbsp;
<span class="kw1">create</span> <span class="kw1">table</span> TestData<span class="br0">&#40;</span>Id <span class="kw1">int</span>, SomeValue <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">20</span><span class="br0">&#41;</span>,SomeOtherValue <span class="kw1">Decimal</span><span class="br0">&#40;</span><span class="nu0">6</span>,<span class="nu0">2</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
go
&nbsp;
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">1</span>,<span class="st0">'abcdefg1'</span>,<span class="nu0">3.31</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">2</span>,<span class="st0">'abcdefg2'</span>,<span class="nu0">3.32</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">3</span>,<span class="st0">'abcdefg3'</span>,<span class="nu0">3.33</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">4</span>,<span class="st0">'abcdefg4'</span>,<span class="nu0">3.34</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">5</span>,<span class="st0">'abcdefg5'</span>,<span class="nu0">3.35</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">6</span>,<span class="st0">'abcdefg6'</span>,<span class="nu0">3.36</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">7</span>,<span class="st0">'abcdefg7'</span>,<span class="nu0">3.37</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">8</span>,<span class="st0">'abcdefg8'</span>,<span class="nu0">3.38</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">9</span>,<span class="st0">'abcdefg9'</span>,<span class="nu0">3.39</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">10</span>,<span class="st0">'abcdefg10'</span>,<span class="nu0">3.40</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">11</span>,<span class="st0">'abcdefg11'</span>,<span class="nu0">3.41</span><span class="br0">&#41;</span>
<span class="kw1">insert</span> TestData <span class="kw1">values</span><span class="br0">&#40;</span><span class="nu0">12</span>,<span class="st0">'abcdefg12'</span>,<span class="nu0">3.42</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">use tempdb
go

create table TestData(Id int, SomeValue varchar(20),SomeOtherValue Decimal(6,2))
go

insert TestData values(1,'abcdefg1',3.31)
insert TestData values(2,'abcdefg2',3.32)
insert TestData values(3,'abcdefg3',3.33)
insert TestData values(4,'abcdefg4',3.34)
insert TestData values(5,'abcdefg5',3.35)
insert TestData values(6,'abcdefg6',3.36)
insert TestData values(7,'abcdefg7',3.37)
insert TestData values(8,'abcdefg8',3.38)
insert TestData values(9,'abcdefg9',3.39)
insert TestData values(10,'abcdefg10',3.40)
insert TestData values(11,'abcdefg11',3.41)
insert TestData values(12,'abcdefg12',3.42)</pre></div></div>

<p>Now lets&#8217; first use BCP to copy data into a file. Here is what the command will look like</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1">master..<span class="me1">xp_cmdshell</span> <span class="st0">'bcp &quot;SELECT id, CHAR(34) + SomeValue + CHAR(34),SomeOtherValue FROM tempdb..TestData&quot; queryout C:TestData.txt -t, -c -Slocalhost -T'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">master..xp_cmdshell 'bcp "SELECT id, CHAR(34) + SomeValue + CHAR(34),SomeOtherValue FROM tempdb..TestData" queryout C:TestData.txt -t, -c -Slocalhost -T'</pre></div></div>

<p>So what does all this stuff do? </p>
<p><strong>master..xp_cmdshell</strong> Executes a given command string as an operating-system command shell. </p>
<p><strong>bcp  </strong>is the bulk copy program</p>
<p><strong>&#8220;SELECT id, CHAR(34) + SomeValue + CHAR(34),SomeOtherValue FROM tempdb..TestData&#8221;</strong> This is our query, CHAR(34) is the ascii code for double qoutes, we are putting double quotes around the character values/</p>
<p><strong>queryout </strong>Specifies the direction of the bulk copy</p>
<p><strong>C:TestData.txt</strong> this is the name of the file that will be created</p>
<p><strong>-t,</strong> Specifies the field terminator. The default is t (tab character). We are using this parameter to override the default field terminator by using a comma instead.</p>
<p><strong>-c</strong> Performs the bulk copy operation using a character data type. This option does not prompt for each field</p>
<p><strong>-Slocalhost</strong> tells bcp where to connect to, in this case localhost.</p>
<p><strong>-T</strong> Specifies that bcp connects to SQL Server with a trusted connection. If you want to use login credentials and you username is SQL2008 and the password = pw2008 then instead of -T you would do this -U&#8221;SQL2008&#8243; -P&#8221;pw2008&#8243;</p>
<p>There are a lot more arguments available for the BCP utility, I recommend checking all the available arguments out here: http://msdn.microsoft.com/en-us/library/ms162802.aspx</p>
<p></p>
<h3>Attention/warning!!</h3>
<p>Here are a couple of warnings for you. </p>
<p><strong>xp_cmdshell</strong><br />
It is not a best practice to have xp_cmdshell enabled. As a matter of fact beginning with SQL Server 2005, the product ships with xp_cmdshell disabled. If you try to run xp_cmdshell you will get the following message if it is not enabled<br />
Server: Msg 15281, Level 16, State 1, Procedure xp_cmdshell, Line 1</p>
<p>SQL Server blocked access to procedure &#8216;sys.xp_cmdshell&#8217; of component &#8216;xp_cmdshell&#8217; because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of &#8216;xp_cmdshell&#8217; by using sp_configure. For more information about enabling &#8216;xp_cmdshell&#8217;, see &#8220;Surface Area Configuration&#8221; in SQL Server Books Online.</p>
<p>To enable xp_cmdshell execute the following code</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'show advanced options'</span>, <span class="nu0">1</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'xp_cmdshell'</span>, <span class="st0">'1'</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'show advanced options'</span>, <span class="nu0">0</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE SP_CONFIGURE 'show advanced options', 1
RECONFIGURE WITH OVERRIDE
GO
 
EXECUTE SP_CONFIGURE 'xp_cmdshell', '1'
RECONFIGURE WITH OVERRIDE
GO
 
EXECUTE SP_CONFIGURE 'show advanced options', 0
RECONFIGURE WITH OVERRIDE
GO</pre></div></div>

<p><strong>OPENROWSET </strong><br />
In SQL Server 2005 and 2008 OPENROWSET is also disabled by default, if you try to run an OPENROWSET query then you will see the following message:</p>
<p>Server: Msg 15281, Level 16, State 1, Line 1<br />
SQL Server blocked access to STATEMENT &#8216;OpenRowset/OpenDatasource&#8217; of component &#8216;Ad Hoc Distributed Queries&#8217; because this component is turned off as part of the security configuration for this server. A system administrator can enable the use of &#8216;Ad Hoc Distributed Queries&#8217; by using sp_configure. For more information about enabling &#8216;Ad Hoc Distributed Queries&#8217;, see &#8220;Surface Area Configuration&#8221; in SQL Server Books Online.</p>
<p>To enable OPENROWSET and OPENQUERY you can use the previous script but instead of &#8216;xp_cmdshell&#8217; you will use &#8216;Ad Hoc Distributed Queries&#8217;. The script to enable Ad Hoc Distributed Queries is below</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'show advanced options'</span>, <span class="nu0">1</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'Ad Hoc Distributed Queries'</span>, <span class="st0">'1'</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO
&nbsp;
<span class="kw1">EXECUTE</span> <span class="kw3">SP_CONFIGURE</span> <span class="st0">'show advanced options'</span>, <span class="nu0">0</span>
<span class="kw1">RECONFIGURE</span> <span class="kw1">WITH</span> OVERRIDE
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXECUTE SP_CONFIGURE 'show advanced options', 1
RECONFIGURE WITH OVERRIDE
GO
 
EXECUTE SP_CONFIGURE 'Ad Hoc Distributed Queries', '1'
RECONFIGURE WITH OVERRIDE
GO
 
EXECUTE SP_CONFIGURE 'show advanced options', 0
RECONFIGURE WITH OVERRIDE
GO</pre></div></div>

<p>Now it is time to execute our query, make sure that everything in the code below is on one line in your query window.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1">master..<span class="me1">xp_cmdshell</span> <span class="st0">'bcp &quot;SELECT id, CHAR(34) + SomeValue + CHAR(34),SomeOtherValue FROM tempdb..TestData ORDER BY id&quot; queryout C:TestData.txt -t, -c -Slocalhost -T'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">master..xp_cmdshell 'bcp "SELECT id, CHAR(34) + SomeValue + CHAR(34),SomeOtherValue FROM tempdb..TestData ORDER BY id" queryout C:TestData.txt -t, -c -Slocalhost -T'</pre></div></div>

<p>You should see the following output</p>
<p><em>NULL<br />
Starting copy&#8230;<br />
NULL<br />
12 rows copied.<br />
Network packet size (bytes): 4096<br />
Clock Time (ms.): total        1<br />
NULL</em></p>
<p>Now we will use OPENROWSET to read the file we just created</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> <span class="kw1">OPENROWSET</span><span class="br0">&#40;</span><span class="st0">'Microsoft.Jet.OLEDB.4.0'</span>, 
<span class="st0">'Text;Database=C:;HDR=No;'</span>, <span class="st0">'SELECT * FROM TestData.txt'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
'Text;Database=C:;HDR=No;', 'SELECT * FROM TestData.txt')</pre></div></div>

<p>If everything is correct and ad-hoc queries are enabled on your instance you should see all the rows we inserted. </p>
<p>Now let&#8217;s append a row to the file</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> <span class="kw1">INTO</span> <span class="kw1">OPENROWSET</span><span class="br0">&#40;</span><span class="st0">'Microsoft.Jet.OLEDB.4.0'</span>, 
<span class="st0">'Text;Database=C:;HDR=Yes;'</span>, <span class="st0">'SELECT * FROM TestData.txt'</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="nu0">13</span>,<span class="st0">'abcdefg13'</span>,<span class="nu0">3.43</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
'Text;Database=C:;HDR=Yes;', 'SELECT * FROM TestData.txt')
select 13,'abcdefg13',3.43</pre></div></div>

<p>Running this query below will now return 13 rows</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> <span class="kw1">INTO</span> <span class="kw1">OPENROWSET</span><span class="br0">&#40;</span><span class="st0">'Microsoft.Jet.OLEDB.4.0'</span>, 
<span class="st0">'Text;Database=C:;HDR=Yes;'</span>, <span class="st0">'SELECT * FROM TestData.txt'</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="nu0">13</span>,<span class="st0">'abcdefg13'</span>,<span class="nu0">3.43</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
'Text;Database=C:;HDR=Yes;', 'SELECT * FROM TestData.txt')
select 13,'abcdefg13',3.43</pre></div></div>

<p>What if you want to use OPENROWSET to insert into a file that does not exist yet? Let&#8217;s try it out by changing the name to TestData2.txt.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> <span class="kw1">INTO</span> <span class="kw1">OPENROWSET</span><span class="br0">&#40;</span><span class="st0">'Microsoft.Jet.OLEDB.4.0'</span>, 
<span class="st0">'Text;Database=C:;HDR=Yes;'</span>, <span class="st0">'SELECT * FROM TestData2.txt'</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="nu0">13</span>,<span class="st0">'abcdefg13'</span>,<span class="nu0">3.43</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
'Text;Database=C:;HDR=Yes;', 'SELECT * FROM TestData2.txt')
select 13,'abcdefg13',3.43</pre></div></div>

<p>And here is our message<br />
<em>Server: Msg 7399, Level 16, State 1, Line 1<br />
OLE DB provider &#8216;Microsoft.Jet.OLEDB.4.0&#8217; reported an error.<br />
[OLE/DB provider returned message: The Microsoft Jet database engine could not find the object &#8216;TestData2.txt&#8217;.  Make sure the object exists and that you spell its name and the path name correctly.]<br />
OLE DB error trace [OLE/DB Provider &#8216;Microsoft.Jet.OLEDB.4.0&#8217; IColumnsInfo::GetColumnsInfo returned 0x80004005:   ].</em></p>
<p>Mmm, what if we create a file from within a shell command?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1">master..<span class="me1">xp_cmdshell</span> <span class="st0">'copy nul c:TestData2.txt'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">master..xp_cmdshell 'copy nul c:TestData2.txt'</pre></div></div>

<p><em>1 file(s) copied.<br />
NULL<br />
</em></p>
<p>Now that we created the file, let&#8217;s try again</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> <span class="kw1">INTO</span> <span class="kw1">OPENROWSET</span><span class="br0">&#40;</span><span class="st0">'Microsoft.Jet.OLEDB.4.0'</span>, 
<span class="st0">'Text;Database=C:;HDR=Yes;'</span>, <span class="st0">'SELECT * FROM TestData2.txt'</span><span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestData</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT INTO OPENROWSET('Microsoft.Jet.OLEDB.4.0', 
'Text;Database=C:;HDR=Yes;', 'SELECT * FROM TestData2.txt')
select * from TestData</pre></div></div>

<p><em>Server: Msg 7357, Level 16, State 2, Line 1<br />
Could not process object &#8216;SELECT * FROM TestData2.txt&#8217;. The OLE DB provider &#8216;Microsoft.Jet.OLEDB.4.0&#8242; indicates that the object has no columns.<br />
OLE DB error trace [Non-interface error:  OLE DB provider unable to process object, since the object has no columnsProviderName=&#8217;Microsoft.Jet.OLEDB.4.0&#8242;, Query=SELECT * FROM TestData2.txt&#8217;].</em></p>
<p>As you can see since the file is an empty file JET doesn&#8217;t know how to insert the data</p>
<p>It might be entirely possible to use OPENROWSET to insert into a blank file and if you know how then feel free to leave a comment. But in general to copy data into a file that does not extist yet use bcp and openrowset to append to a file.<br />
If you need do this kind of thing more than once I would recommend to use SSIS (SQL Server Integration Services) or DTS (Data Transformation Services) since it is much more flexible and customizable.</p>
<p></p>
<p>*** <strong>If you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/how-to-copy-data-append-data-into-files/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
