<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>authentication &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/authentication/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>Custom Authentication in ASP.Net Core 2 w/ Cosmos DB</title>
		<link>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/</link>
		<comments>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/#comments</comments>
		<pubDate>Fri, 13 Apr 2018 12:10:01 +0000</pubDate>
		<dc:creator><![CDATA[Eli Weinstock-Herman (tarwn)]]></dc:creator>
				<category><![CDATA[ASP.NET]]></category>
		<category><![CDATA[ASP.Net Core 2]]></category>
		<category><![CDATA[authentication]]></category>
		<category><![CDATA[bcrypt]]></category>
		<category><![CDATA[CosmosDB]]></category>

		<guid isPermaLink="false">/?p=9130</guid>
		<description><![CDATA[I&#8217;m building a B2C website with Cosmos DB as the backend store. This site will have a number of different authentication mechanisms, but I&#8217;m newer to ASP.Net Core 2 and the authentication changes since the prior version so I&#8217;m going to start with a basic Cookie and Login authentication system. This is the second post [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>I&#8217;m building a B2C website with Cosmos DB as the backend store. This site will have a number of different authentication mechanisms, but I&#8217;m newer to ASP.Net Core 2 and the authentication changes since the prior version so I&#8217;m going to start with a basic Cookie and Login authentication system.</p>
<p>This is the second post in a series documenting the creation of this project. If you haven&#8217;t worked with custom authentication in ASP.Net Core 2, are looking for more examples of interacting with Cosmos DB, or just trying to avoid the overkill of Identity and EntityFramework, I hope this is helpful.</p>
<p>If you want to follow along from the beginning, the series starts with <a href="/index.php/webdev/serverprogramming/aspnet/asp-net-core-2-w-cosmosdb-getting-started/" title="Read the first post in the series">ASP.Net Core 2 w/ Cosmos DB: Getting Started </a></p>
<style>
.note-area{
   border: 1px solid #eeeeee; 
   border-left-width: 16px; 
   padding: 1em;
   margin: 1em 0;
}
.warning-area{
   border: 1px solid #FFdddd; 
   border-left-width: 16px; 
   padding: 1em;
   margin: 1em 0;
}
</style>
<h2>Getting Organization</h2>
<p>Instead of grabbing a cup of coffee and pounding away at my keyboard until I&#8217;m done, I prefer to break work down into a smaller set of steps I can work on one at a time. This helps provide a sense of momentum, knowledge that each new step is starting at a known good state, and the safety to throw away a set of changes that isn&#8217;t working out instead of backtracking manually.</p>
<div id="attachment_9155" style="width: 610px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_106-600x406.png" alt="3 Authentication Scenarios: User/Pass, Twitter, API Keys" width="600" height="406" class="size-medium-width wp-image-9155" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_106-600x406.png 600w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106-300x203.png 300w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106-443x300.png 443w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106.png 748w" sizes="(max-width: 600px) 100vw, 600px" /><p class="wp-caption-text">3 Authentication Scenarios: User/Pass, Twitter, API Keys</p></div>
<p>There are two scenarios: Interactive logins and API authentication. For interactive logins, I want folks to have the option of either a username/password registration or a 3rd party OAuth registration (twitter, for example).</p>
<p>At a macro level, I can break this down into:</p>
<ul>
<li>1: Username/Password Registration, Login, Logout, Sessions + Cookies</li>
<li>2: Twitter Registration, Twitter Login</li>
<li>3: API Key management, API Key Authentication</li>
</ul>
<p>This post will cover the first set: building standard username/password authentication down to Cosmos DB. It will also include some refactoring of the <code>Persistence</code> class I created to interact with Cosmos DB and good, secure hashing of passwords.</p>
<p>This is going to be a long post, it may look a little formidable at first, but actual coding time took less than writing it up as a blog post, it&#8217;s extensible (per the next two posts), and we have wide open freedom to apply any HTML and CSS we want and we can worry less about ASP.Net Core 2.1 releasing and breaking everything while we&#8217;re in the middle.</p>
<div id="attachment_9173" style="width: 505px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_107.png" alt="These are the main changes, plus a few POCOs" width="495" height="746" class="size-full wp-image-9173" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_107.png 495w, /wp-content/uploads/2018/04/aspnetcore2cosmos_107-199x300.png 199w" sizes="(max-width: 495px) 100vw, 495px" /><p class="wp-caption-text">These are the main changes, plus a few POCOs</p></div>
<p>All of the noted files above are included in the post. There are also a few POCOs (LoginResults, etc). You can view the full code for this post on github: <a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%232/SampleCosmosCore2App/Membership/CustomMembershipExtensions.cs" title="View on github">tarwn/Sample_ASPNetCore2AndCosmosDB, Post-#2 branch</a></p>
<h2>An Overview of ASP.Net Core 2 Authentication</h2>
<p>ASP.Net Core 2 ships with built-in modules for a variety of use cases: <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/" title="MSDN: ASP.Net Core Authentication">MSDN: ASP.Net Core Authentication</a> </p>
<div class="warning-area">
Be aware that most the MSDN examples mix the concepts of the Authentication middleware with the <code>Identity</code> model. ASP.Net Identity is not required and is, in my opinion, a fairly clumsy abstraction. Even the article on <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/identity-custom-storage-providers">custom authentication</a> assumes you want to use Identity for the business logic and will just be supplying data store implementations that are lightly documented and much wider than needed.</p>
<p>We will be using Principals and Identities for HttpContext, these are standard HttpContext concepts that are not related to &#8220;ASP.Net Core Identity&#8221;.
</p></div>
<p>The purpose of the Authentication modules are to interact with the outside world and provide some standard behavior and configurable options for their specific capabilities. The key behaviors are:</p>
<ul>
<li>Translating external information to Claims: Reading a cookie, receiving an OAuth callback</li>
<li>Challenging a user: Sending them to a login page, starting an OAuth process</li>
<li>Sign In/Out: Persisting claims information back out into the world (writing a cookie)</li>
<li>External behavior for Unauthenticated/Forbidden requests: Sending a 401 Response</li>
</ul>
<p><code>Authentication Schemes</code> uniquely identify each Authentication module, for instance a request that comes in with two cookies would show two sets of Claims, each identified by an <code>AuthenticationScheme</code> from the Authentication module that read it. The <code>AuthenticationScheme</code> can also be used to enforce authentication to a specific <code>Scheme</code> for an endpoint (ignore claims from other modules, does this <code>Scheme</code> say they are allowed in?). A <code>DefaultAuthenticationScheme</code> configuration tell the system which Authentication module to challenge un-authentication users with. Or you can can have an endpoint explicitly issue a Challenge by <code>Scheme</code>, &#8220;Twitter&#8221; for example:</p>
<p><b>Starting a Twitter OAuth Sign-in</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;register/twitter&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
<span class="kw1">public</span> IActionResult RegisterWithTwitter<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> props <span class="sy0">=</span> <span class="kw3">new</span> AuthenticationProperties<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; RedirectUri <span class="sy0">=</span> <span class="st0">&quot;account/register/twitter/continue&quot;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> Challenge<span class="br0">&#40;</span>props, <span class="st0">&quot;Twitter&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[HttpGet("register/twitter")]
[AllowAnonymous]
public IActionResult RegisterWithTwitter()
{
    var props = new AuthenticationProperties()
    {
        RedirectUri = "account/register/twitter/continue"
    };
    return Challenge(props, "Twitter");
}</pre></div></div>

<p>There&#8217;s a lot more, here is a great post: <a href="https://digitalmccullough.com/posts/aspnetcore-auth-system-demystified.html" title="Deep dive into ASP.Net Core 2 Auth">ASP.NET Core 2.0 Authentication and Authorization System Demystified</a>.</p>
<h2>Task 1: Cookies, custom Membership, Cosmos DB, and basic pages</h2>
<p>The first piece we have sliced off is the workflow of Registering, Login, and Logout with cookies for validation. Though I executed this in vertical slices (for instance, I built the registration form from HTML down to Cosmo sDB before starting the login form), the post is presented in finished files or we&#8217;d be staring at the same file 10-12 times in a row.</p>
<h3>Authentication and ICustomMembership</h3>
<p>First, let&#8217;s focus on getting the custom authentication wired in with the Cookies authentication module and a custom Membership object to include business logic.</p>
<p>The concrete <code>CosmosDBMembership</code> object will be responsible for creating and validating users internally against the Cosmos DB store:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/ICustomMembership.cs">SampleCosmosCore2App/Membership/ICustomMembership.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">interface</span> ICustomMembership
<span class="br0">&#123;</span>
&nbsp; &nbsp; CustomMembershipOptions Options <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>RegisterResult<span class="sy0">&gt;</span> RegisterAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> email, <span class="kw4">string</span> password<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>LoginResult<span class="sy0">&gt;</span> LoginAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> password<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Task LogoutAsync<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span><span class="kw4">bool</span><span class="sy0">&gt;</span> ValidateLoginAsync<span class="br0">&#40;</span>ClaimsPrincipal principal<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>SessionDetails<span class="sy0">&gt;</span> GetSessionDetailsAsync<span class="br0">&#40;</span>ClaimsPrincipal principal<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public interface ICustomMembership
{
	CustomMembershipOptions Options { get; }

	Task&lt;RegisterResult&gt; RegisterAsync(string userName, string email, string password);
	Task&lt;LoginResult&gt; LoginAsync(string userName, string password);
	Task LogoutAsync();
	Task&lt;bool&gt; ValidateLoginAsync(ClaimsPrincipal principal);

	Task&lt;SessionDetails&gt; GetSessionDetailsAsync(ClaimsPrincipal principal);
}</pre></div></div>

<p>This reflects the basic set of behaviors we intend to perform, with an options object that includes a <code>DefaultPathAfterLogin</code> and <code>AuthenticationType</code> to use when interacting with Claims and HttpContext SignIn/SignOut methods.</p>
<p>Next, we switch to the <code>Startup.cs</code> and register the concrete <code>CosmosDBMembership</code> class for this interface, register the default scheme (&#8220;Cookies&#8221;), and configure a Cookie authentication module for the &#8220;Cookies&#8221; scheme:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Startup.cs#L44">SampleCosmosCore2App/Startup.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">void</span> ConfigureServices<span class="br0">&#40;</span>IServiceCollection services<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; services<span class="sy0">.</span><span class="me1">AddMvc</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// #1</span>
&nbsp; &nbsp; services<span class="sy0">.</span><span class="me1">AddCustomMembership</span><span class="sy0">&lt;</span>CosmosDBMembership<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#40;</span>options<span class="br0">&#41;</span> <span class="sy0">=&gt;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">AuthenticationType</span> <span class="sy0">=</span> CookieAuthenticationDefaults<span class="sy0">.</span><span class="me1">AuthenticationScheme</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">DefaultPathAfterLogin</span> <span class="sy0">=</span> <span class="st0">&quot;/&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// #2</span>
&nbsp; &nbsp; services<span class="sy0">.</span><span class="me1">AddAuthentication</span><span class="br0">&#40;</span>CookieAuthenticationDefaults<span class="sy0">.</span><span class="me1">AuthenticationScheme</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="co1">// #3</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">AddCookie</span><span class="br0">&#40;</span><span class="br0">&#40;</span>options<span class="br0">&#41;</span> <span class="sy0">=&gt;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">LoginPath</span> <span class="sy0">=</span> <span class="kw3">new</span> PathString<span class="br0">&#40;</span><span class="st0">&quot;/account/login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">LogoutPath</span> <span class="sy0">=</span> <span class="kw3">new</span> PathString<span class="br0">&#40;</span><span class="st0">&quot;/account/logout&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">Events</span> <span class="sy0">=</span> <span class="kw3">new</span> CookieAuthenticationEvents<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// #3</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OnValidatePrincipal <span class="sy0">=</span> async <span class="br0">&#40;</span>c<span class="br0">&#41;</span> <span class="sy0">=&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> membership <span class="sy0">=</span> c<span class="sy0">.</span><span class="me1">HttpContext</span><span class="sy0">.</span><span class="me1">RequestServices</span><span class="sy0">.</span><span class="me1">GetRequiredService</span><span class="sy0">&lt;</span>ICustomMembership<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> isValid <span class="sy0">=</span> await membership<span class="sy0">.</span><span class="me1">ValidateLoginAsync</span><span class="br0">&#40;</span>c<span class="sy0">.</span><span class="me1">Principal</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>isValid<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; c<span class="sy0">.</span><span class="me1">RejectPrincipal</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">public</span> <span class="kw4">void</span> Configure<span class="br0">&#40;</span>IApplicationBuilder app, IHostingEnvironment env<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// #4</span>
&nbsp; &nbsp; app<span class="sy0">.</span><span class="me1">UseAuthentication</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; app<span class="sy0">.</span><span class="me1">UseMvc</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public void ConfigureServices(IServiceCollection services)
{
	services.AddMvc();

	// ...

	// #1
	services.AddCustomMembership&lt;CosmosDBMembership&gt;((options) =&gt; {
		options.AuthenticationType = CookieAuthenticationDefaults.AuthenticationScheme;
		options.DefaultPathAfterLogin = "/";
	});

	// #2
	services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
	// #3
	.AddCookie((options) =&gt;
	{
		options.LoginPath = new PathString("/account/login");
		options.LogoutPath = new PathString("/account/logout");
		options.Events = new CookieAuthenticationEvents()
		{
			// #3
			OnValidatePrincipal = async (c) =&gt;
			{
				var membership = c.HttpContext.RequestServices.GetRequiredService&lt;ICustomMembership&gt;();
				var isValid = await membership.ValidateLoginAsync(c.Principal);
				if (!isValid)
				{
					c.RejectPrincipal();
				}
			}
		};
	});

}

public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
	// ...

	// #4
	app.UseAuthentication();

	app.UseMvc();
}</pre></div></div>

<p><em>Note: While I refer to the &#8220;Cookies&#8221; scheme by name, you&#8217;ll note above I actually use the constant CookieAuthenticationDefaults.AuthenticationScheme</em></p>
<p><b>#1 &#8211; services.AddCustomMembership:</b> Register CosmosDBMembership as a Transient dependency for ICustomMembership vi an <a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CustomMembershipExtensions.cs">extension method (github)</a>.</p>
<p><b>#2 &#8211; services.AddAuthentication:</b> Set the Default Authentication Scheme to our &#8220;Cookies&#8221; scheme to tell the system to use the &#8220;Cookies&#8221; module for challenging Unauthorized users.</p>
<p><b>#3 &#8211; .AddCookie:</b> Lightly configure a Cookies module to use the &#8220;Cookies&#8221; scheme and provide the &#8220;LoginPath&#8221; used for challenging a user. (I don&#8217;t recall why I included &#8220;LogoutPath&#8221;). Wire an event in for <code>OnValidatePrincipal</code> that gets the registered Membership object and asks it if the user is valid according to our business logic.</p>
<p><b>#4 &#8211; app.UseAuthentication: </b> Include the configured authentication middleware in the application</p>
<p>Now that we have wired ourselves into the outside world, let&#8217;s move on to build the business logic and persistence.</p>
<h3>Cosmos DB Refactoring</h3>
<p>In the prior post, I had very basic CRUD logic to read/write a <code>Sample</code> object to Cosmos DB. Now we need to add the concepts of a registered user (<code>LoginUser</code>) and an authorized user session (<code>LoginSession</code>). First we&#8217;re going to do some refactoring.</p>
<p>Here are the challenges:</p>
<ul>
<li>It will be a mess if we add <code>LoginUser</code> logic to <code>Persistence</code> on top of <code>Sample</code></li>
<li><a href="https://azure.microsoft.com/en-us/blog/performance-tips-for-azure-documentdb-part-1-2/" title="MSDN: CosmosDB Performance Tips">Microsoft&#8217;s performance guide</a> says we should use a Singleton for the DocumentClient for performance</li>
</ul>
<div class="note-area">
The three most notable changes from the <a href="https://azure.microsoft.com/en-us/blog/performance-tips-for-azure-documentdb-part-1-2/" title="MSDN: CosmosDB Performance Tips">Performance Tips</a> are configuring the <code>Persistence</code> class (and it&#8217;s DocumentClient) to be a singleton over the lifetime of the web server, calling <code>OpenAsync</code> early so the connection is opened prior to the first real call, and moving the call to <code>EnsureSetupAsync</code> to the registration of the Singleton in <code>Startup.cs</code> so it happens only one time.
</div>
<p>To solve this, Persistence will be split into a top-level class with general behavior and responsibility for the DocumentClient instance, while actual persistence logic will be moved into individual, scoped data classes:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App.Core/Persistence.cs">SampleCosmosCore2App.Core/Persistence.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> Persistence <span class="sy0">:</span> IDisposable
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">string</span> _databaseId<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">private</span> Uri _endpointUri<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">string</span> _primaryKey<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">private</span> DocumentClient _client<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">private</span> <span class="kw4">bool</span> _isDisposing<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> Persistence<span class="br0">&#40;</span>Uri endpointUri, <span class="kw4">string</span> primaryKey, <span class="kw4">string</span> databaseId<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _databaseId <span class="sy0">=</span> databaseId<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _endpointUri <span class="sy0">=</span> endpointUri<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _primaryKey <span class="sy0">=</span> primaryKey<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; _client <span class="sy0">=</span> <span class="kw3">new</span> DocumentClient<span class="br0">&#40;</span>endpointUri, primaryKey<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _client<span class="sy0">.</span><span class="me1">OpenAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; Samples <span class="sy0">=</span> <span class="kw3">new</span> SamplePersistence<span class="br0">&#40;</span>_client, _databaseId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Users <span class="sy0">=</span> <span class="kw3">new</span> UserPersistence<span class="br0">&#40;</span>_client, _databaseId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> UserPersistence Users <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">private</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> SamplePersistence Samples <span class="br0">&#123;</span> <span class="kw1">get</span><span class="sy0">;</span> <span class="kw1">private</span> <span class="kw1">set</span><span class="sy0">;</span> <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task EnsureSetupAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">CreateDatabaseIfNotExistsAsync</span><span class="br0">&#40;</span><span class="kw3">new</span> Database <span class="br0">&#123;</span> Id <span class="sy0">=</span> _databaseId <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; await Task<span class="sy0">.</span><span class="me1">WhenAll</span><span class="br0">&#40;</span><span class="kw3">new</span> Task<span class="br0">&#91;</span><span class="br0">&#93;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Samples<span class="sy0">.</span><span class="me1">EnsureSetupAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Users<span class="sy0">.</span><span class="me1">EnsureSetupAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> Dispose<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>_isDisposing<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _isDisposing <span class="sy0">=</span> <span class="kw1">true</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>_client <span class="sy0">!=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _client<span class="sy0">.</span><span class="me1">Dispose</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class Persistence : IDisposable
{
	private string _databaseId;
	private Uri _endpointUri;
	private string _primaryKey;

	private DocumentClient _client;
	private bool _isDisposing;

	public Persistence(Uri endpointUri, string primaryKey, string databaseId)
	{
		_databaseId = databaseId;
		_endpointUri = endpointUri;
		_primaryKey = primaryKey;

		_client = new DocumentClient(endpointUri, primaryKey);
		_client.OpenAsync();

		Samples = new SamplePersistence(_client, _databaseId);
		Users = new UserPersistence(_client, _databaseId);
	}

	public UserPersistence Users { get; private set; }

	public SamplePersistence Samples { get; private set; }

	public async Task EnsureSetupAsync()
	{
		await _client.CreateDatabaseIfNotExistsAsync(new Database { Id = _databaseId });
		
		await Task.WhenAll(new Task[] {
			Samples.EnsureSetupAsync(),
			Users.EnsureSetupAsync()
		});
	}
	
	public void Dispose()
	{
		if (!_isDisposing)
		{
			_isDisposing = true;
			if (_client != null)
			{
				_client.Dispose();
			}
		}
	}
}</pre></div></div>

<p>And we&#8217;ve exposed access to <code>Sample</code> and <code>LoginUser</code> data through two properties, which are also referenced during the <code>EnsureSetupAsync</code> call (btw: don&#8217;t use a Task.WhenAll for that like I did, bad things happen).</p>
<p>Next, we&#8217;ll stop calling the <code>EnsureSetupAsync</code> method on every persistence call and instead call this one time during the setup of the service.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Startup.cs">SampleCosmosCore2App/Startup.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">void</span> ConfigureServices<span class="br0">&#40;</span>IServiceCollection services<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; services<span class="sy0">.</span><span class="me1">AddSingleton</span><span class="sy0">&lt;</span>Persistence<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#40;</span>s<span class="br0">&#41;</span> <span class="sy0">=&gt;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> p <span class="sy0">=</span> <span class="kw3">new</span> Persistence<span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> Uri<span class="br0">&#40;</span>Configuration<span class="br0">&#91;</span><span class="st0">&quot;CosmosDB:URL&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Configuration<span class="br0">&#91;</span><span class="st0">&quot;CosmosDB:PrimaryKey&quot;</span><span class="br0">&#93;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Configuration<span class="br0">&#91;</span><span class="st0">&quot;CosmosDB:DatabaseId&quot;</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; p<span class="sy0">.</span><span class="me1">EnsureSetupAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">Wait</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> p<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ... auth stuff</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public void ConfigureServices(IServiceCollection services)
{
	// ...

	services.AddSingleton&lt;Persistence&gt;((s) =&gt;
	{
		var p = new Persistence(
			new Uri(Configuration["CosmosDB:URL"]),
					Configuration["CosmosDB:PrimaryKey"],
					Configuration["CosmosDB:DatabaseId"]);
		p.EnsureSetupAsync().Wait();
		return p;
	});

	// ... auth stuff
}</pre></div></div>

<p>Now the setup for CosmosDB will be called just the one time, instead of on every call where it was from the early experimentation.</p>
<p>The last step is actually using these changes to read and write <code>LoginUser</code> and <code>LoginSession</code> instances to CosmosDB.</p>
<h3>Cosmos DB &#8211; Membership</h3>
<p>We have an Interface defined above and the <code>Persistence</code> class has been refactored so we can add new Cosmos DB methods as we need them. Now we can focus on fleshing out the concrete <code>CosmosDBMembership</code> class. This wil then define the Persistence methods we need to add for Cosmos DB.</p>
<ul>
<li>RegisterAsync</li>
<li>LoginAsync</li>
<li>LogoutAsync</li>
<li>ValidateLoginAsync</li>
</ul>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CosmosDBMembership.cs#L86">Membership/CosmosDBMembership.cs &#8211; RegisterAsync</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> async Task<span class="sy0">&lt;</span>RegisterResult<span class="sy0">&gt;</span> RegisterAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> email, <span class="kw4">string</span> password<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> <span class="kw3">new</span> LoginUser<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Username <span class="sy0">=</span> userName,
&nbsp; &nbsp; &nbsp; &nbsp; Email <span class="sy0">=</span> email,
&nbsp; &nbsp; &nbsp; &nbsp; PasswordHash <span class="sy0">=</span> password
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; user <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">CreateUserAsync</span><span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="kw1">catch</span> <span class="br0">&#40;</span>Exception exc<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//TODO reduce breadth of exception statement</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> RegisterResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="st0">&quot;Username is already in use&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; await SignInAsync<span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> RegisterResult<span class="sy0">.</span><span class="me1">GetSuccess</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public async Task&lt;RegisterResult&gt; RegisterAsync(string userName, string email, string password)
{
	var user = new LoginUser()
	{
		Username = userName,
		Email = email,
		PasswordHash = password
	};

	try
	{
		user = await _persistence.Users.CreateUserAsync(user);
	}
	catch (Exception exc)
	{
		//TODO reduce breadth of exception statement
		return RegisterResult.GetFailed("Username is already in use");
	}

	await SignInAsync(user);

	return RegisterResult.GetSuccess();
}</pre></div></div>

<p>Registration is pretty straightforward. Take the 3 required properties, load them into a <code>LoginUser</code> object, persist it, then sign the user in. The one non-obvious piece is the reliance on an <code>Exception</code> to detect duplicate Usernames. We&#8217;re going to add a unique constraint to Cosmos DB later to help enforce unique usernames.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CosmosDBMembership.cs#L52">SampleCosmosCore2App/Membership/CosmosDBMembership.cs &#8211; LoginAsync</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginResult<span class="sy0">&gt;</span> LoginAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> password<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">GetUserByUsernameAsync</span><span class="br0">&#40;</span>userName<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>user <span class="sy0">==</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>user<span class="sy0">.</span><span class="me1">PasswordHash</span> <span class="sy0">!=</span> password<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; await SignInAsync<span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetSuccess</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public async Task&lt;LoginResult&gt; LoginAsync(string userName, string password)
{
	var user = await _persistence.Users.GetUserByUsernameAsync(userName);
	if (user == null)
	{
		return LoginResult.GetFailed();
	}

	if (user.PasswordHash != password)
	{
		return LoginResult.GetFailed();
	}

	await SignInAsync(user);

	return LoginResult.GetSuccess();
}</pre></div></div>

<p>We don&#8217;t have a password hash function yet, so for Login we take a username and password to load a <code>LoginUer</code> from the database, perform a direct comparison, and sign the user in if it is a match.</p>
<p>These both use the SignInAsync method, which creates a <code>LoginSession</code> for the user and uses the Authentication&#8217;s SignIn method for the <code>Options.AuthenticationType</code> we configured back in <code>Startup</code>:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CosmosDBMembership.cs#L133">SampleCosmosCore2App/Membership/CosmosDBMembership.cs &#8211; SignInAsync</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="de1"><pre class="de1"><span class="kw1">private</span> async Task SignInAsync<span class="br0">&#40;</span>LoginUser user<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// key the login to a server-side session id to make it easy to invalidate later</span>
&nbsp; &nbsp; <span class="kw1">var</span> session <span class="sy0">=</span> <span class="kw3">new</span> LoginSession<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; UserId <span class="sy0">=</span> user<span class="sy0">.</span><span class="me1">Id</span>,
&nbsp; &nbsp; &nbsp; &nbsp; CreationTime <span class="sy0">=</span> DateTime<span class="sy0">.</span><span class="me1">UtcNow</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; session <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">CreateSessionAsync</span><span class="br0">&#40;</span>session<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> identity <span class="sy0">=</span> <span class="kw3">new</span> ClaimsIdentity<span class="br0">&#40;</span>Options<span class="sy0">.</span><span class="me1">AuthenticationType</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; identity<span class="sy0">.</span><span class="me1">AddClaim</span><span class="br0">&#40;</span><span class="kw3">new</span> Claim<span class="br0">&#40;</span><span class="st0">&quot;sessionId&quot;</span>, session<span class="sy0">.</span><span class="me1">Id</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; await _context<span class="sy0">.</span><span class="me1">HttpContext</span><span class="sy0">.</span><span class="me1">SignInAsync</span><span class="br0">&#40;</span><span class="kw3">new</span> ClaimsPrincipal<span class="br0">&#40;</span>identity<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">private async Task SignInAsync(LoginUser user)
{
	// key the login to a server-side session id to make it easy to invalidate later
	var session = new LoginSession()
	{
		UserId = user.Id,
		CreationTime = DateTime.UtcNow
	};
	session = await _persistence.Users.CreateSessionAsync(session);

	var identity = new ClaimsIdentity(Options.AuthenticationType);
	identity.AddClaim(new Claim("sessionId", session.Id));
	await _context.HttpContext.SignInAsync(new ClaimsPrincipal(identity));
}</pre></div></div>

<p>Behind the scenes, ASP.Net is calling the <code>SignIn</code> method on the &#8220;Cookies&#8221; authentication module. The Cookies module will take the ClaimsPrincipal we just passed it and write it as a cookie on the outgoing Response (and then read it back in on subsequent Requests). This is how we&#8217;ll know who the user is later. Which brings us to ValidateLoginAsync, which is called from our custom OnValidatePrincipal logic.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CosmosDBMembership.cs#L113">SampleCosmosCore2App/Membership/CosmosDBMembership.cs &#8211; ValidateLoginAsync</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">bool</span><span class="sy0">&gt;</span> ValidateLoginAsync<span class="br0">&#40;</span>ClaimsPrincipal principal<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> sessionId <span class="sy0">=</span> principal<span class="sy0">.</span><span class="me1">FindFirstValue</span><span class="br0">&#40;</span><span class="st0">&quot;sessionId&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>sessionId <span class="sy0">==</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">false</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> session <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">GetSessionAsync</span><span class="br0">&#40;</span>sessionId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>session<span class="sy0">.</span><span class="me1">LogoutTime</span><span class="sy0">.</span><span class="me1">HasValue</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">false</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">true</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public async Task&lt;bool&gt; ValidateLoginAsync(ClaimsPrincipal principal)
{
	var sessionId = principal.FindFirstValue("sessionId");
	if (sessionId == null)
	{
		return false;
	}

	var session = await _persistence.Users.GetSessionAsync(sessionId);
	if (session.LogoutTime.HasValue)
	{
		return false;
	}

	return true;
}</pre></div></div>

<p>We attempt to read the &#8220;sessionId&#8221; claim from the passed Principal and associate it with a saved <code>LoginSession</code> in the database, with a basic verification check to make sure the user has not logged out. In the event that we call false, our OnValidatePrincipal call will reject this principal (ensure it&#8217;s not flagged as &#8220;Authenticated&#8221;).</p>
<p>Finally, we have the last step for a user: Logging out.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Membership/CosmosDBMembership.cs#L73">SampleCosmosCore2App/Membership/CosmosDBMembership.cs &#8211; LogoutAsync</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> async Task LogoutAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; await _context<span class="sy0">.</span><span class="me1">HttpContext</span><span class="sy0">.</span><span class="me1">SignOutAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> sessionId <span class="sy0">=</span> _context<span class="sy0">.</span><span class="me1">HttpContext</span><span class="sy0">.</span><span class="me1">User</span><span class="sy0">.</span><span class="me1">FindFirstValue</span><span class="br0">&#40;</span><span class="st0">&quot;sessionId&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>sessionId <span class="sy0">!=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> session <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">GetSessionAsync</span><span class="br0">&#40;</span>sessionId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; session<span class="sy0">.</span><span class="me1">LogoutTime</span> <span class="sy0">=</span> DateTime<span class="sy0">.</span><span class="me1">UtcNow</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">UpdateSessionAsync</span><span class="br0">&#40;</span>session<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public async Task LogoutAsync()
{
	await _context.HttpContext.SignOutAsync();

	var sessionId = _context.HttpContext.User.FindFirstValue("sessionId");
	if (sessionId != null)
	{
		var session = await _persistence.Users.GetSessionAsync(sessionId);
		session.LogoutTime = DateTime.UtcNow;
		await _persistence.Users.UpdateSessionAsync(session);
	}
}</pre></div></div>

<p>Like the <code>LoginAsync&lt;code&gt; call, we use &lt;code&gt;SignOut</code> to sign out of the configured authentication module. I have not specific the <code>Scheme</code> here, so this may be signing us out of all the things.</p>
<p>Once we've signed out, we can mark the session as logged out too. This is more for informational purposes than anything else, as we've already revoke the cookie above and wouldn't be able to connect the user back to this session on their next page load.</p>
<h3>Cosmos DB - Persistence</h3>
<p>With the business logic defined, now we can create the 6 Persistence calls to Cosmos DB: <code>CreateUserAsync</code>, <code>GetUserAsync</code>, <code>GetUserByUsernameAsync</code>, <code>CreateSessionAsync</code>, <code>GetSessionAsync</code>, <code>UpdateSessionAsync</code></p>
<p>The setup logic has two points of interest. The first is that we make sure we store and re-use the <code>DocumentClient</code> object that is managed from <code>Persistence</code> rather than creating one locally for this class. Secondly, the <code>EnsureSetupAsync</code> method ensures we have a <code>DocumentCollection</code> set up for both Users and Sessions. </p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App.Core/Users/UserPersistence.cs">SampleCosmosCore2App.Core/Users/UserPersistence.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> UserPersistence
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> UserPersistence<span class="br0">&#40;</span>DocumentClient client, <span class="kw4">string</span> databaseId<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _client <span class="sy0">=</span> client<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _databaseId <span class="sy0">=</span> databaseId<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task EnsureSetupAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> databaseUri <span class="sy0">=</span> UriFactory<span class="sy0">.</span><span class="me1">CreateDatabaseUri</span><span class="br0">&#40;</span>_databaseId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Collections</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">CreateDocumentCollectionIfNotExistsAsync</span><span class="br0">&#40;</span>databaseUri, <span class="kw3">new</span> DocumentCollection<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> Id <span class="sy0">=</span> SESSIONS_DOCUMENT_COLLECTION_ID <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> users <span class="sy0">=</span> <span class="kw3">new</span> DocumentCollection<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; users<span class="sy0">.</span><span class="me1">Id</span> <span class="sy0">=</span> USERS_DOCUMENT_COLLECTION_ID<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; users<span class="sy0">.</span><span class="me1">UniqueKeyPolicy</span> <span class="sy0">=</span> <span class="kw3">new</span> UniqueKeyPolicy<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; UniqueKeys <span class="sy0">=</span> <span class="kw3">new</span> Collection<span class="sy0">&lt;</span>UniqueKey<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> UniqueKey<span class="br0">&#123;</span> Paths <span class="sy0">=</span> <span class="kw3">new</span> Collection<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span><span class="br0">&#123;</span> <span class="st0">&quot;/Username&quot;</span> <span class="br0">&#125;</span> <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">CreateDocumentCollectionIfNotExistsAsync</span><span class="br0">&#40;</span>databaseUri, users<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="co1">// ... CRUD methods</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class UserPersistence
{
	// ...

	public UserPersistence(DocumentClient client, string databaseId)
	{
		_client = client;
		_databaseId = databaseId;
	}

	public async Task EnsureSetupAsync()
	{
		var databaseUri = UriFactory.CreateDatabaseUri(_databaseId);

		// Collections
		await _client.CreateDocumentCollectionIfNotExistsAsync(databaseUri, new DocumentCollection() { Id = SESSIONS_DOCUMENT_COLLECTION_ID });
		var users = new DocumentCollection();
		users.Id = USERS_DOCUMENT_COLLECTION_ID;
		users.UniqueKeyPolicy = new UniqueKeyPolicy()
		{
			UniqueKeys = new Collection&lt;UniqueKey&gt;()
			{
				new UniqueKey{ Paths = new Collection&lt;string&gt;{ "/Username" } }
			}
		};
		await _client.CreateDocumentCollectionIfNotExistsAsync(databaseUri, users);
	}
	
	// ... CRUD methods
}</pre></div></div>

<p>The Sessions collection is a straightforward, 1-line <code>CreateDocumentCollectionIfNotExistsAsync</code>, but for the Users we've used a longer form to create the collection so we can define <code>Username</code> as a unique key. This is the second half of the logic in the Membership object that prevents users from registering with a duplicate <code>Username</code>.</p>
<p>With the setup out of the way, now we can concentrate on supplying the necessary CRUD methods that <code>CosmosDBMembership</code> relies on.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App.Core/Users/UserPersistence.cs">SampleCosmosCore2App.Core/Users/UserPersistence.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> UserPersistence
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ... ctor, EnsureSetupAsync ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span> CreateUserAsync<span class="br0">&#40;</span>LoginUser user<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _client<span class="sy0">.</span><span class="me1">CreateDocumentAsync</span><span class="br0">&#40;</span>GetUsersCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, user, <span class="kw3">new</span> RequestOptions<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> JsonConvert<span class="sy0">.</span><span class="me1">DeserializeObject</span><span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span><span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Resource</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span> GetUserAsync<span class="br0">&#40;</span><span class="kw4">string</span> userId<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _client<span class="sy0">.</span><span class="me1">ReadDocumentAsync</span><span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span><span class="br0">&#40;</span>UriFactory<span class="sy0">.</span><span class="me1">CreateDocumentUri</span><span class="br0">&#40;</span>_databaseId, USERS_DOCUMENT_COLLECTION_ID, userId<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> result<span class="sy0">.</span><span class="me1">Document</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span> GetUserByUsernameAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> query <span class="sy0">=</span> _client<span class="sy0">.</span><span class="me1">CreateDocumentQuery</span><span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span><span class="br0">&#40;</span>GetUsersCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw3">new</span> SqlQuerySpec<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QueryText <span class="sy0">=</span> <span class="st0">&quot;SELECT * FROM Users U WHERE U.Username = @username&quot;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Parameters <span class="sy0">=</span> <span class="kw3">new</span> SqlParameterCollection<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw3">new</span> SqlParameter<span class="br0">&#40;</span><span class="st0">&quot;@username&quot;</span>, userName<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> results <span class="sy0">=</span> await query<span class="sy0">.</span><span class="me1">AsDocumentQuery</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">.</span><span class="me1">ExecuteNextAsync</span><span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> results<span class="sy0">.</span><span class="me1">FirstOrDefault</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginSession<span class="sy0">&gt;</span> CreateSessionAsync<span class="br0">&#40;</span>LoginSession session<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _client<span class="sy0">.</span><span class="me1">CreateDocumentAsync</span><span class="br0">&#40;</span>GetSessionsCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, session<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> JsonConvert<span class="sy0">.</span><span class="me1">DeserializeObject</span><span class="sy0">&lt;</span>LoginSession<span class="sy0">&gt;</span><span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Resource</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginSession<span class="sy0">&gt;</span> GetSessionAsync<span class="br0">&#40;</span><span class="kw4">string</span> sessionId<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _client<span class="sy0">.</span><span class="me1">ReadDocumentAsync</span><span class="sy0">&lt;</span>LoginSession<span class="sy0">&gt;</span><span class="br0">&#40;</span>UriFactory<span class="sy0">.</span><span class="me1">CreateDocumentUri</span><span class="br0">&#40;</span>_databaseId, SESSIONS_DOCUMENT_COLLECTION_ID, sessionId<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> result<span class="sy0">.</span><span class="me1">Document</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task UpdateSessionAsync<span class="br0">&#40;</span>LoginSession session<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">ReplaceDocumentAsync</span><span class="br0">&#40;</span>UriFactory<span class="sy0">.</span><span class="me1">CreateDocumentUri</span><span class="br0">&#40;</span>_databaseId, SESSIONS_DOCUMENT_COLLECTION_ID, session<span class="sy0">.</span><span class="me1">Id</span><span class="br0">&#41;</span>, session<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class UserPersistence
{
	// ... ctor, EnsureSetupAsync ...

	public async Task&lt;LoginUser&gt; CreateUserAsync(LoginUser user)
	{
		var result = await _client.CreateDocumentAsync(GetUsersCollectionUri(), user, new RequestOptions() { });
		return JsonConvert.DeserializeObject&lt;LoginUser&gt;(result.Resource.ToString());
	}

	public async Task&lt;LoginUser&gt; GetUserAsync(string userId)
	{
		var result = await _client.ReadDocumentAsync&lt;LoginUser&gt;(UriFactory.CreateDocumentUri(_databaseId, USERS_DOCUMENT_COLLECTION_ID, userId));
		return result.Document;
	}

	public async Task&lt;LoginUser&gt; GetUserByUsernameAsync(string userName)
	{
		var query = _client.CreateDocumentQuery&lt;LoginUser&gt;(GetUsersCollectionUri(), new SqlQuerySpec()
		{
			QueryText = "SELECT * FROM Users U WHERE U.Username = @username",
			Parameters = new SqlParameterCollection()
		   {
			   new SqlParameter("@username", userName)
		   }
		});
		var results = await query.AsDocumentQuery()
								 .ExecuteNextAsync&lt;LoginUser&gt;();
		return results.FirstOrDefault();
	}

	public async Task&lt;LoginSession&gt; CreateSessionAsync(LoginSession session)
	{
		var result = await _client.CreateDocumentAsync(GetSessionsCollectionUri(), session);
		return JsonConvert.DeserializeObject&lt;LoginSession&gt;(result.Resource.ToString());
	}

	public async Task&lt;LoginSession&gt; GetSessionAsync(string sessionId)
	{
		var result = await _client.ReadDocumentAsync&lt;LoginSession&gt;(UriFactory.CreateDocumentUri(_databaseId, SESSIONS_DOCUMENT_COLLECTION_ID, sessionId));
		return result.Document;
	}

	public async Task UpdateSessionAsync(LoginSession session)
	{
		await _client.ReplaceDocumentAsync(UriFactory.CreateDocumentUri(_databaseId, SESSIONS_DOCUMENT_COLLECTION_ID, session.Id), session);
	}

	// ...
}</pre></div></div>

<p>With two exceptions, these calls are 1-2 line methods to write a document to Cosmos DB or read it. Here are the exceptions:</p>
<p><b>CreateUserAsync uses JsonConvert</b> to deserialize the result after inserting it into Cosmos DB. This is not automatic, but since we are relying on the generated <code>id</code> that Cosmos DB assigns our document then we want an object back. The one danger to wtach out for is if we had set some JSON.Net configurations with the <code>DocumentClient</code> we would want to use those here too.</p>
<p><b>GetUserByUsernameAsync uses SQL</b> to query the <code>DocumentCollection</code>. Be very careful about getting your casing correct, this bit me several times. Cosmos DB supports <a href="https://docs.microsoft.com/en-us/azure/cosmos-db/sql-api-sql-query" title="MSDN: Cosmos DB SQL Queries">a limited SQL syntax</a> with support for parameterization.</p>
<p>Now that we have our business and persistence logic, we just need to add some UI on top!</p>
<h3>Adding Registration and Login pages</h3>
<p>The final piece is the Registration and Login pages the user will interact with. Here are the endpoints we need:</p>
<ul>
<li>GET /account/login: display a login page</li>
<li>POST /account/login: perform login + redirect</li>
<li>GET /account/register: display a registration form</li>
<li>POST /account/register: perform registration, login, redirect</li>
<li>GET /account/logout: perform logout + redirect somewhere</li>
<li>GET /account/protected: a page that requires authorization for testing</li>
</ul>
<p>Add a new <code>AccountController</code> to the Controllers folder (Right click, Add, Controller). We'll start out with the registration logic:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Controllers/AccountController.cs#L13">SampleCosmosCore2App/Controllers/AccountController.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>Route<span class="br0">&#40;</span><span class="st0">&quot;account&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">class</span> AccountController <span class="sy0">:</span> Controller
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">private</span> ICustomMembership _membership<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> AccountController<span class="br0">&#40;</span>ICustomMembership membership<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; _membership <span class="sy0">=</span> membership<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;register&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> IActionResult Register<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Register&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpPost<span class="br0">&#40;</span><span class="st0">&quot;register&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>ValidateAntiForgeryToken<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> RegisterPostAsync<span class="br0">&#40;</span>RegisterModel model<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>ModelState<span class="sy0">.</span><span class="me1">IsValid</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Register&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _membership<span class="sy0">.</span><span class="me1">RegisterAsync</span><span class="br0">&#40;</span>model<span class="sy0">.</span><span class="me1">UserName</span>, model<span class="sy0">.</span><span class="me1">Email</span>, model<span class="sy0">.</span><span class="me1">Password</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Failed</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, result<span class="sy0">.</span><span class="me1">ErrorMessage</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Register&quot;</span>, model<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LocalRedirect<span class="br0">&#40;</span>_membership<span class="sy0">.</span><span class="me1">Options</span><span class="sy0">.</span><span class="me1">DefaultPathAfterLogin</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[Route("account")]
public class AccountController : Controller
{
	private ICustomMembership _membership;

	public AccountController(ICustomMembership membership)
	{
		_membership = membership;
	}

	[HttpGet("register")]
	[AllowAnonymous]
	public IActionResult Register()
	{
		return View("Register");
	}

	[HttpPost("register")]
	[AllowAnonymous]
	[ValidateAntiForgeryToken]
	public async Task&lt;IActionResult&gt; RegisterPostAsync(RegisterModel model)
	{
		if (!ModelState.IsValid)
		{
			return View("Register");
		}

		var result = await _membership.RegisterAsync(model.UserName, model.Email, model.Password);
		if (result.Failed)
		{
			ModelState.AddModelError("", result.ErrorMessage);
			return View("Register", model);
		}

		return LocalRedirect(_membership.Options.DefaultPathAfterLogin);
	}

	// ...
}</pre></div></div>

<p>The <code>GET</code> call simply returns a View named "Register". Once they fill in this form, it is <code>POSTed</code> to <code>RegisterPostAsync</code> which verifies the Model is valid, attempts to use our new <code>RegisterAsync</code> method, and then directs to configured default path for newly registered and sign-ed in users. If it fails at any point, it directs the user back to the "Register" view with an error in the <code>ModelState</code>.</p>
<p>Add a new "Account" folder to "Views", then add a new "Register.cshtml" view to this folder.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Views/Account/Register.cshtml">SampleCosmosCore2App/Views/Account/Register.cshtml</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="de1"><pre class="de1">@model SampleCosmosCore2App.Models.Account.RegisterModel
@{
&nbsp; &nbsp; ViewData[&quot;Title&quot;] = &quot;Register&quot;;
&nbsp; &nbsp; Layout = &quot;~/Views/Shared/Layout.cshtml&quot;;
}
&nbsp;
<span class="sc2">&lt;<span class="kw2">h2</span>&gt;</span>Register<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">h2</span>&gt;</span>
&nbsp;
<span class="sc2">&lt;<span class="kw2">form</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;Register&quot;</span> <span class="kw3">method</span><span class="sy0">=</span><span class="st0">&quot;post&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> asp-validation-<span class="kw3">summary</span><span class="sy0">=</span><span class="st0">&quot;ModelOnly&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;submit&quot;</span> <span class="kw3">value</span><span class="sy0">=</span><span class="st0">&quot;Register&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;btn btn-default&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">form</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">@model SampleCosmosCore2App.Models.Account.RegisterModel
@{
    ViewData["Title"] = "Register";
    Layout = "~/Views/Shared/Layout.cshtml";
}

&lt;h2&gt;Register&lt;/h2&gt;

&lt;form asp-action="Register" method="post"&gt;
    &lt;div asp-validation-summary="ModelOnly" class="text-danger"&gt;&lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;label asp-for="UserName" class="control-label"&gt;&lt;/label&gt;
        &lt;input asp-for="UserName" class="form-control" /&gt;
        &lt;span asp-validation-for="UserName" class="text-danger"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;label asp-for="Password" class="control-label"&gt;&lt;/label&gt;
        &lt;input asp-for="Password" class="form-control" /&gt;
        &lt;span asp-validation-for="Password" class="text-danger"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;label asp-for="Email" class="control-label"&gt;&lt;/label&gt;
        &lt;input asp-for="Email" class="form-control" /&gt;
        &lt;span asp-validation-for="Email" class="text-danger"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;input type="submit" value="Register" class="btn btn-default" /&gt;
    &lt;/div&gt;
&lt;/form&gt;</pre></div></div>

<p>And there we go!</p>
<div id="attachment_9137" style="width: 359px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_101.png" alt="Working Registration Form" width="349" height="300" class="size-full wp-image-9137" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_101.png 349w, /wp-content/uploads/2018/04/aspnetcore2cosmos_101-300x258.png 300w" sizes="(max-width: 349px) 100vw, 349px" /><p class="wp-caption-text">Working Registration Form</p></div>
<p>Next up we can follow the same process for wiring in actions for Login GET/POST:</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Controllers/AccountController.cs#L50">SampleCosmosCore2App/Controllers/AccountController.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>Route<span class="br0">&#40;</span><span class="st0">&quot;account&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">class</span> AccountController <span class="sy0">:</span> Controller
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;login&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> IActionResult Login<span class="br0">&#40;</span><span class="kw4">string</span> returnUrl <span class="sy0">=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; TempData<span class="br0">&#91;</span><span class="st0">&quot;returnUrl&quot;</span><span class="br0">&#93;</span> <span class="sy0">=</span> returnUrl<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpPost<span class="br0">&#40;</span><span class="st0">&quot;login&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>ValidateAntiForgeryToken<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> LoginPostAsync<span class="br0">&#40;</span>LoginModel user, &nbsp;<span class="kw4">string</span> returnUrl <span class="sy0">=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>ModelState<span class="sy0">.</span><span class="me1">IsValid</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, <span class="st0">&quot;Username or password is incorrect&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _membership<span class="sy0">.</span><span class="me1">LoginAsync</span><span class="br0">&#40;</span>user<span class="sy0">.</span><span class="me1">UserName</span>, user<span class="sy0">.</span><span class="me1">Password</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Failed</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, <span class="st0">&quot;Username or password is incorrect&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LocalRedirect<span class="br0">&#40;</span>returnUrl <span class="sy0">??</span> _membership<span class="sy0">.</span><span class="me1">Options</span><span class="sy0">.</span><span class="me1">DefaultPathAfterLogin</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[Route("account")]
public class AccountController : Controller
{
	// ...

	[HttpGet("login")]
	[AllowAnonymous]
	public IActionResult Login(string returnUrl = null)
	{
		TempData["returnUrl"] = returnUrl;
		return View("Login");
	}

	[HttpPost("login")]
	[AllowAnonymous]
	[ValidateAntiForgeryToken]
	public async Task&lt;IActionResult&gt; LoginPostAsync(LoginModel user,  string returnUrl = null)
	{
		if (!ModelState.IsValid) {
			ModelState.AddModelError("", "Username or password is incorrect");
			return View("Login", user);
		}

		var result = await _membership.LoginAsync(user.UserName, user.Password);
		if (result.Failed)
		{
			ModelState.AddModelError("", "Username or password is incorrect");
			return View("Login", user);
		}

		return LocalRedirect(returnUrl ?? _membership.Options.DefaultPathAfterLogin);
	}

	// ...
}</pre></div></div>

<p>Like the Registration actions, the <code>GET</code> simply returns a view, the user enters their information, and the <code>POST</code> is validated, sent to our Membership object to create a session (or not), and then the user is redirected to either the passed URL or back to the Login form with an error.</p>
<p><code>returnUrl</code> is provided by the Cookie Authentication module when someone attempts to access a page requiring Authorization and the cookie authentication module challenges them by sending them to this login page.</p>
<p>Next, create a "Login" view in the Views/Account folder like we did with the "Register" View.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Views/Account/Login.cshtml">Views/Account/Login.cshtml</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="de1"><pre class="de1">@model SampleCosmosCore2App.Models.Account.LoginModel
&nbsp;
@{
&nbsp; &nbsp; ViewData[&quot;Title&quot;] = &quot;Login&quot;;
&nbsp; &nbsp; Layout = &quot;~/Views/Shared/Layout.cshtml&quot;;
}
&nbsp;
<span class="sc2">&lt;<span class="kw2">h2</span>&gt;</span>Login<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">h2</span>&gt;</span>
&nbsp;
<span class="sc2">&lt;<span class="kw2">form</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;Login&quot;</span> <span class="kw3">method</span><span class="sy0">=</span><span class="st0">&quot;post&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> asp-validation-<span class="kw3">summary</span><span class="sy0">=</span><span class="st0">&quot;ModelOnly&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Password&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;submit&quot;</span> <span class="kw3">value</span><span class="sy0">=</span><span class="st0">&quot;Login&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;btn btn-default&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">a</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;Register&quot;</span>&gt;</span>Register<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">a</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">form</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">@model SampleCosmosCore2App.Models.Account.LoginModel

@{
    ViewData["Title"] = "Login";
    Layout = "~/Views/Shared/Layout.cshtml";
}

&lt;h2&gt;Login&lt;/h2&gt;

&lt;form asp-action="Login" method="post"&gt;
    &lt;div asp-validation-summary="ModelOnly" class="text-danger"&gt;&lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;label asp-for="UserName" class="control-label"&gt;&lt;/label&gt;
        &lt;input asp-for="UserName" class="form-control" /&gt;
        &lt;span asp-validation-for="UserName" class="text-danger"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;label asp-for="Password" class="control-label"&gt;&lt;/label&gt;
        &lt;input asp-for="Password" class="form-control" /&gt;
        &lt;span asp-validation-for="Password" class="text-danger"&gt;&lt;/span&gt;
    &lt;/div&gt;
    &lt;div class="form-group"&gt;
        &lt;input type="submit" value="Login" class="btn btn-default" /&gt;
        &lt;a asp-action="Register"&gt;Register&lt;/a&gt;
    &lt;/div&gt;
&lt;/form&gt;</pre></div></div>

<p>And there we go, a new login form!</p>
<div id="attachment_9138" style="width: 362px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_102.png" alt="Working Login Form!" width="352" height="281" class="size-full wp-image-9138" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_102.png 352w, /wp-content/uploads/2018/04/aspnetcore2cosmos_102-300x239.png 300w" sizes="(max-width: 352px) 100vw, 352px" /><p class="wp-caption-text">Working Login Form!</p></div>
<p>Finally we need a way for the user to logout and a protected endpoint to test against. These are pretty minimal and my test "protected" endpoint is barely more than an empty view.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/d7c5907d45154685b62127c714394b29734f8e60/SampleCosmosCore2App/Controllers/AccountController.cs#L80">SampleCosmosCore2App/Controllers/AccountController.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> AccountController <span class="sy0">:</span> Controller
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;logout&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>Authorize<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> LogoutAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _membership<span class="sy0">.</span><span class="me1">LogoutAsync</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> RedirectToAction<span class="br0">&#40;</span><span class="st0">&quot;login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;protected&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>Authorize<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> <span class="kw1">Protected</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ... get some session details and return the view</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class AccountController : Controller
{
	// ...

	[HttpGet("logout")]
	[Authorize]
	public async Task&lt;IActionResult&gt; LogoutAsync()
	{
		await _membership.LogoutAsync();
		return RedirectToAction("login");
	}

	[HttpGet("protected")]
	[Authorize]
	public async Task&lt;IActionResult&gt; Protected()
	{
		// ... get some session details and return the view
	}

	// ...
}</pre></div></div>

<p>For the logout, we're using the <code>LogoutAsync</code> method that signs out of the authentication module (clearing the cookie) then redirect to the login screen. The "Protected" endpoint has a couple more lines of logic to get soe data from the Membership object and pass it to the view, but an empty View would work just as well (look at the github link above for the full detail if you want it).</p>
<p>Success, that's a fully functional Membership system! With a really poor password strategy.</p>
<h2>Task 2: Password Hashing</h2>
<p>If you recall, back 60 pages ago, we passed the plain text password from the user straight into Cosmos DB and later relied on basic string comparison to validate user logins. This is something you never want to do in the real world, so the next step is to add a one-way cryptographic hash.</p>
<div id="attachment_9140" style="width: 610px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_104-600x213.png" alt="CosmosDB User - Before Hashing" width="600" height="213" class="size-medium-width wp-image-9140" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_104-600x213.png 600w, /wp-content/uploads/2018/04/aspnetcore2cosmos_104-300x106.png 300w, /wp-content/uploads/2018/04/aspnetcore2cosmos_104-768x273.png 768w, /wp-content/uploads/2018/04/aspnetcore2cosmos_104-845x300.png 845w, /wp-content/uploads/2018/04/aspnetcore2cosmos_104.png 868w" sizes="(max-width: 600px) 100vw, 600px" /><p class="wp-caption-text">CosmosDB User - Before Hashing</p></div>
<p>Don't worry, this is a lot shorter than the previous steps. </p>
<p><a href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet" title="OWASP Password Storage Cheat Sheet">OWASP's guidance</a> is to use an Argon2 library, but I wasn't comfortable with the maturity of those projects for .Net, so I'm using a BCrypt implementation instead.</p>
<div class="note-area">
The goal of libraries like Argon2 and BCrypt is to not only hash the password value in a way that can't be reversed, but also do so in a way that is slow, which limits the ability to brute force guess the password.
</div>
<p>To add BCrypt to the solution, install the <a href="https://www.nuget.org/packages/BCrypt.Net-Core/" title="BCrypt.Net-Core on Nuget.org">nuget package</a> from the UI or the Package Manager Console: <code>Install-Package BCrypt.Net-Core</code>.</p>
<p>Now we just have to make two small changes to implement it during registration and login.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%232/SampleCosmosCore2App/Membership/CosmosDBMembership.cs">SampleCosmosCore2App/Membership/CosmosDBMembership.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> CosmosDBMembership <span class="sy0">:</span> ICustomMembership
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginResult<span class="sy0">&gt;</span> LoginAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> password<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">GetUserByUsernameAsync</span><span class="br0">&#40;</span>userName<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>user <span class="sy0">==</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// CHANGE #1</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>BCrypt<span class="sy0">.</span><span class="me1">Net</span><span class="sy0">.</span><span class="me1">BCrypt</span><span class="sy0">.</span><span class="me1">Verify</span><span class="br0">&#40;</span>password, user<span class="sy0">.</span><span class="me1">PasswordHash</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; await SignInAsync<span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetSuccess</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>RegisterResult<span class="sy0">&gt;</span> RegisterAsync<span class="br0">&#40;</span><span class="kw4">string</span> userName, <span class="kw4">string</span> email, <span class="kw4">string</span> password<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// CHANGE #2</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> passwordHash <span class="sy0">=</span> BCrypt<span class="sy0">.</span><span class="me1">Net</span><span class="sy0">.</span><span class="me1">BCrypt</span><span class="sy0">.</span><span class="me1">HashPassword</span><span class="br0">&#40;</span>password<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> <span class="kw3">new</span> LoginUser<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Username <span class="sy0">=</span> userName,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Email <span class="sy0">=</span> email,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PasswordHash <span class="sy0">=</span> passwordHash
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class CosmosDBMembership : ICustomMembership
{
	// ...

	public async Task&lt;LoginResult&gt; LoginAsync(string userName, string password)
	{
		var user = await _persistence.Users.GetUserByUsernameAsync(userName);
		if (user == null)
		{
			return LoginResult.GetFailed();
		}

		// CHANGE #1
		if (!BCrypt.Net.BCrypt.Verify(password, user.PasswordHash))
		{
			return LoginResult.GetFailed();
		}

		await SignInAsync(user);

		return LoginResult.GetSuccess();
	}
	
	// ...
	
	public async Task&lt;RegisterResult&gt; RegisterAsync(string userName, string email, string password)
	{
		// CHANGE #2
		var passwordHash = BCrypt.Net.BCrypt.HashPassword(password);
		var user = new LoginUser()
		{
			Username = userName,
			Email = email,
			PasswordHash = passwordHash
		};

		// ...
	}

	// ...
}</pre></div></div>

<p><code>LoginAsync</code>: replace the string comparison with <code>BCrypt.Net.BCrypt.Verify</code>.</p>
<p><code>RegisterAsync</code>: hash the password before populating the <code>PasswordHash</code> property.</p>
<p>And now when we look at a registered user in the CosmosDB Data Explorer, we can see a nicely hashed password instead of plain text:</p>
<div id="attachment_9141" style="width: 610px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_105-600x191.png" alt="Data Explorer view of User - Now with Hashed Password!" width="600" height="191" class="size-medium-width wp-image-9141" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_105-600x191.png 600w, /wp-content/uploads/2018/04/aspnetcore2cosmos_105-300x96.png 300w, /wp-content/uploads/2018/04/aspnetcore2cosmos_105-768x245.png 768w, /wp-content/uploads/2018/04/aspnetcore2cosmos_105.png 916w" sizes="(max-width: 600px) 100vw, 600px" /><p class="wp-caption-text">Data Explorer view of User - Now with Hashed Password!</p></div>
<p>Success!</p>
<h2>Next Steps</h2>
<p>That probably felt pretty involved. I've written custom auth logic for just about every version of ASP.Net and I've found that once you get a handle on the theory and changes that have occurred to the Request/Response lifecycle, it becomes relatively easy to write your own custom auth logic that will continue to work abd be extended for many versions of ASP.Net to come. </p>
<p>Between this post and the last one, we now have an ASP.Net Core 2 site running against CosmosDB with authentication. Next we'll extend the interactive authentication to include a third-party Twitter login, still using the built-in middleware to do the heavy lifting. Then after we buidl that, we'll layer in API authentication with user-manageable API tokens.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		</item>
		<item>
		<title>Custom Authentication in ASP.Net Core 1 (without Identity)</title>
		<link>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-without-identity/</link>
		<comments>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-without-identity/#comments</comments>
		<pubDate>Fri, 08 Sep 2017 11:59:48 +0000</pubDate>
		<dc:creator><![CDATA[Eli Weinstock-Herman (tarwn)]]></dc:creator>
				<category><![CDATA[ASP.NET]]></category>
		<category><![CDATA[asp.net core]]></category>
		<category><![CDATA[authentication]]></category>
		<category><![CDATA[bcrypt]]></category>

		<guid isPermaLink="false">/?p=8790</guid>
		<description><![CDATA[Performing Authentication and Authorization has changed from ASP.Net to ASP.Net Core. Rather than relying on attributes, ASP.Net Core uses middleware similar to NancyFX and Rails. This is a short, step-by-step approach to implementing custom Authentication in ASP.Net Core without the overhead (and assumptions) of the new Identity model. The goal is to support basic necessities [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>Performing Authentication and Authorization has changed from ASP.Net to ASP.Net Core. Rather than relying on attributes, ASP.Net Core uses middleware similar to NancyFX and Rails. This is a short, step-by-step approach to implementing custom Authentication in ASP.Net Core without the overhead (and assumptions) of the new Identity model. </p>
<p>The goal is to support basic necessities like a Login page with cookie-based authentication tickets that properly require HTTPS in production, but gracefully fail back to HTTP in local development.</p>
<h2>Cookie Middleware</h2>
<p>ASP.Net Core has Cookie Middleware we can use out of the box: <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/cookie" title="Using Cookie Authentication without ASP.NET Core Identity">Using Cookie Authentication without ASP.NET Core Identity</a></p>
<div style="border: 1px solid #EEBBBB; border-left: 16px solid #EEBBBB; padding: 1em">
<div style="color: #883333; font-weight: bold">
Warning: This only applies for ASP.Net Core 1.0, not 2.0.
</div>
<p>ASP.Net Core 2.0 has pivoted authentication in a different direction, ASP.Net Core 2 Custom Authentication is covered in a <a href="/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/">newer post</a>.
</div>
<p>This middleware provides support for a number of things we want: directing unauthenticated users to a LoginPath, redirecting access denied requests, authentication tickets with sliding expirations and encryption, and hooks to tie into the process for additional custom logic.</p>
<p>Add the Cookie Authentication middleware in the Startup.Configure method:</p>
<p><b>APIProject/Startup.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
</pre></td><td class="de1"><pre class="de1">&nbsp;<span class="kw1">public</span> <span class="kw4">void</span> Configure<span class="br0">&#40;</span>IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ... other setup ...</span>
&nbsp;
&nbsp; &nbsp; app<span class="sy0">.</span><span class="me1">UseCookieAuthentication</span><span class="br0">&#40;</span><span class="kw3">new</span> CookieAuthenticationOptions<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// A string to identify the authentication scheme we used, useful for filtering in Authorize attributes</span>
&nbsp; &nbsp; &nbsp; &nbsp; AuthenticationScheme <span class="sy0">=</span> <span class="st0">&quot;NAME_OF_YOUR_COOKIE_SCHEME&quot;</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Location to send people too to log in</span>
&nbsp; &nbsp; &nbsp; &nbsp; LoginPath <span class="sy0">=</span> <span class="kw3">new</span> PathString<span class="br0">&#40;</span><span class="st0">&quot;/Account/Login&quot;</span><span class="br0">&#41;</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Location to send people who fail to authenticate when required</span>
&nbsp; &nbsp; &nbsp; &nbsp; AccessDeniedPath <span class="sy0">=</span> <span class="kw3">new</span> PathString<span class="br0">&#40;</span><span class="st0">&quot;/Account/Forbidden&quot;</span><span class="br0">&#41;</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Automatically check authentication on every call?</span>
&nbsp; &nbsp; &nbsp; &nbsp; AutomaticAuthenticate <span class="sy0">=</span> <span class="kw1">true</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Challenge every request (enforce requirement to have this auth scheme if it got this far)</span>
&nbsp; &nbsp; &nbsp; &nbsp; AutomaticChallenge <span class="sy0">=</span> <span class="kw1">true</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Expiration of the authentication ticket </span>
&nbsp; &nbsp; &nbsp; &nbsp; ExpireTimeSpan <span class="sy0">=</span> TimeSpan<span class="sy0">.</span><span class="me1">FromMinutes</span><span class="br0">&#40;</span><span class="nu0">30</span><span class="br0">&#41;</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Update the timeout each time a new request comes in</span>
&nbsp; &nbsp; &nbsp; &nbsp; SlidingExpiration <span class="sy0">=</span> <span class="kw1">true</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; Events <span class="sy0">=</span> <span class="kw3">new</span> CookieAuthenticationEvents<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Overwrite the attempt to redirect API calls to login page w/ 401 response instead</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; OnRedirectToLogin <span class="sy0">=</span> <span class="br0">&#40;</span>ctx<span class="br0">&#41;</span> <span class="sy0">=&gt;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// return true 401 to API calls, continue redirect to login for interactive</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>ctx<span class="sy0">.</span><span class="me1">Request</span><span class="sy0">.</span><span class="me1">Path</span><span class="sy0">.</span><span class="me1">StartsWithSegments</span><span class="br0">&#40;</span><span class="st0">&quot;/api&quot;</span><span class="br0">&#41;</span> <span class="sy0">&amp;&amp;</span> ctx<span class="sy0">.</span><span class="me1">Response</span><span class="sy0">.</span><span class="me1">StatusCode</span> <span class="sy0">==</span> <span class="nu0">200</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx<span class="sy0">.</span><span class="me1">Response</span><span class="sy0">.</span><span class="me1">StatusCode</span> <span class="sy0">=</span> <span class="nu0">401</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> Task<span class="sy0">.</span><span class="me1">FromResult</span><span class="sy0">&lt;</span><span class="kw4">object</span><span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="kw1">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx<span class="sy0">.</span><span class="me1">Response</span><span class="sy0">.</span><span class="me1">Redirect</span><span class="br0">&#40;</span>ctx<span class="sy0">.</span><span class="me1">RedirectUri</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> Task<span class="sy0">.</span><span class="me1">FromResult</span><span class="sy0">&lt;</span><span class="kw4">object</span><span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="kw1">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>,
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ... other setup ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse"> public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{
	// ... other setup ...

	app.UseCookieAuthentication(new CookieAuthenticationOptions() {

		// A string to identify the authentication scheme we used, useful for filtering in Authorize attributes
		AuthenticationScheme = "NAME_OF_YOUR_COOKIE_SCHEME",

		// Location to send people too to log in
		LoginPath = new PathString("/Account/Login"),

		// Location to send people who fail to authenticate when required
		AccessDeniedPath = new PathString("/Account/Forbidden"),

		// Automatically check authentication on every call?
		AutomaticAuthenticate = true,

		// Challenge every request (enforce requirement to have this auth scheme if it got this far)
		AutomaticChallenge = true,

		// Expiration of the authentication ticket 
		ExpireTimeSpan = TimeSpan.FromMinutes(30),

		// Update the timeout each time a new request comes in
		SlidingExpiration = true,

		Events = new CookieAuthenticationEvents() {

			// Overwrite the attempt to redirect API calls to login page w/ 401 response instead
			OnRedirectToLogin = (ctx) =&gt; {
				// return true 401 to API calls, continue redirect to login for interactive
				if (ctx.Request.Path.StartsWithSegments("/api") &amp;&amp; ctx.Response.StatusCode == 200)
				{
					ctx.Response.StatusCode = 401;
					return Task.FromResult&lt;object&gt;(null);
				}

				ctx.Response.Redirect(ctx.RedirectUri);
				return Task.FromResult&lt;object&gt;(null);
			},

		}
	});

	// ... other setup ...
}</pre></div></div>

<p><i>Note the OnRedirectToLogin logic, this causes the middleware to return basic 401 HTTP errors for calls through the &#8220;/api&#8221; path instead of redirects to the login page</i></p>
<h2>Account Controller</h2>
<p>To support the endpoints above, and some others that may be useful, we need a simple Account controller:</p>
<p><b>APIProject/Controllers/InteractiveAccountController.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>ApiExceptionFilter<span class="br0">&#93;</span>
<span class="br0">&#91;</span>Route<span class="br0">&#40;</span><span class="st0">&quot;Account&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">class</span> InteractiveAccountController <span class="sy0">:</span> Controller
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Unauthorized&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> GetUnauthorizedAsync<span class="br0">&#40;</span><span class="kw4">string</span> returnUrl<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;You really should login first.&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Forbidden&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">string</span> GetForbidden<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;Forbidden&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;TimedOut&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">string</span> GetTimedOut<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;TimedOut&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> GetLogin<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> principal <span class="sy0">=</span> <span class="kw3">new</span> ClaimsPrincipal<span class="br0">&#40;</span><span class="kw3">new</span> StandardUser<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">Authentication</span><span class="sy0">.</span><span class="me1">SignInAsync</span><span class="br0">&#40;</span><span class="st0">&quot;NAME_OF_YOUR_COOKIE_SCHEME&quot;</span>, principal<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;Success!&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Logout&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> GetLogout<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">Authentication</span><span class="sy0">.</span><span class="me1">SignOutAsync</span><span class="br0">&#40;</span><span class="st0">&quot;NAME_OF_YOUR_COOKIE_SCHEME&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// TODO replace with redirect to login once it exists</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="st0">&quot;Goodbye!&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[ApiExceptionFilter]
[Route("Account")]
public class InteractiveAccountController : Controller
{
	[HttpGet("Unauthorized")]
	public async Task&lt;string&gt; GetUnauthorizedAsync(string returnUrl)
	{
		return "You really should login first.";
	}

	[HttpGet("Forbidden")]
	public string GetForbidden()
	{
		return "Forbidden";
	}

	[HttpGet("TimedOut")]
	public string GetTimedOut()
	{
		return "TimedOut";
	}

	[HttpGet("Login")]
	public async Task&lt;string&gt; GetLogin()
	{
		var principal = new ClaimsPrincipal(new StandardUser());
		await HttpContext.Authentication.SignInAsync("NAME_OF_YOUR_COOKIE_SCHEME", principal);
		return "Success!";
	}

	[HttpGet("Logout")]
	public async Task&lt;string&gt; GetLogout()
	{
		await HttpContext.Authentication.SignOutAsync("NAME_OF_YOUR_COOKIE_SCHEME");
		// TODO replace with redirect to login once it exists
		return "Goodbye!";
	}
}</pre></div></div>

<h2>Authorize</h2>
<p>Once we have an authenticated user, we can add the standard <code>[Authorize]</code> attribute on any controllers or methods to ensure access will require authentication (or challenge if it&#8217;s not present). If we had multiple methods of authentication (interactive user, some API access, etc), we could further restrict these actions to just the cookie-based authenticated requests by specifying that authentication scheme in the attribute:<br />
<code>[Authorize(ActiveAuthenticationSchemes = "NAME_OF_YOUR_COOKIE_SCHEME")]</code></p>
<p>An easy way to verify things are in working order is to decorate another Controller/Action with Authorize and attempt to visit it. We should get redirected to <code>Unauthorized</code> on the Account controller above. If we visit <code>Login</code> first, then visit our sample Action we should be allowed in. Visit <code>Logout</code> and then our sample Action, we&#8217;re back at Unauthorized.</p>
<h2>Ensure Endpoints have Authorization</h2>
<p>Now that we have the middleware in place, the Account pages, and a sample page, we should add some protection to make sure we don&#8217;t leave any pages exposed accidentally. This step is optional, but it&#8217;s something I prefer to do for every application I work on. </p>
<p>Using the sample code from <a href="/index.php/webdev/asp-net-ensure-your-actions-arent-missing-authorization-with-unit-tests/">a prior ASP.Net post</a>, we can write a quick unit test that will inspect all Actions and require them to either have explicit [Authorize] or [AllowAnonymous] attributes. This will protect us from accidentally pushing an unprotected endpoint.</p>
<p>Unfortunately, APIExplorer in ASP.Net Core is even less documented so we have to rely on Reflection instead:</p>
<p><b>APIProject.Tests/SecurityTests.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
</pre></td><td class="de1"><pre class="de1">&nbsp; &nbsp; <span class="br0">&#91;</span>TestFixture<span class="br0">&#93;</span>
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">class</span> SecurityTests
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Func<span class="sy0">&lt;</span><span class="kw4">object</span>, <span class="kw4">bool</span><span class="sy0">&gt;</span> IsMVCAttributeAuth <span class="sy0">=</span> <span class="br0">&#40;</span>o<span class="br0">&#41;</span> <span class="sy0">=&gt;</span> <span class="br0">&#40;</span>o <span class="kw3">is</span> AuthorizeAttribute <span class="sy0">||</span> o <span class="kw3">is</span> AllowAnonymousAttribute<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> AllMvcActionsHaveExplicitAuthorizationDefined_UsingStandardReflection<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> actionsMissingAuth <span class="sy0">=</span> <span class="kw3">new</span> List<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// 1</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> controllers <span class="sy0">=</span> Assembly<span class="sy0">.</span><span class="me1">GetAssembly</span><span class="br0">&#40;</span><span class="kw3">typeof</span><span class="br0">&#40;</span>InteractiveAccountController<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">GetLoadableTypes</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Where</span><span class="br0">&#40;</span>t <span class="sy0">=&gt;</span> <span class="kw3">typeof</span><span class="br0">&#40;</span>Controller<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">IsAssignableFrom</span><span class="br0">&#40;</span>t<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span> <span class="br0">&#40;</span><span class="kw1">var</span> controller <span class="kw1">in</span> controllers<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// 2</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if the controller has it, all it's actions are covered also</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>controller<span class="sy0">.</span><span class="me1">GetCustomAttributes</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">Any</span><span class="br0">&#40;</span>a <span class="sy0">=&gt;</span> IsMVCAttributeAuth<span class="br0">&#40;</span>a<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">continue</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> actions <span class="sy0">=</span> controller<span class="sy0">.</span><span class="me1">GetMethods</span><span class="br0">&#40;</span>BindingFlags<span class="sy0">.</span><span class="me1">Instance</span> <span class="sy0">|</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BindingFlags<span class="sy0">.</span><span class="me1">DeclaredOnly</span> <span class="sy0">|</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; BindingFlags<span class="sy0">.</span><span class="kw1">Public</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">foreach</span> <span class="br0">&#40;</span><span class="kw1">var</span> action <span class="kw1">in</span> actions<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// 3</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// if the action has a defined authorization filter, it's covered</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>action<span class="sy0">.</span><span class="me1">GetCustomAttributes</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">Any</span><span class="br0">&#40;</span>a <span class="sy0">=&gt;</span> IsMVCAttributeAuth<span class="br0">&#40;</span>a<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">continue</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// no controller or action defined, add it to the list</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; actionsMissingAuth<span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw4">String</span><span class="sy0">.</span><span class="me1">Format</span><span class="br0">&#40;</span><span class="st0">&quot;{0}.{1}&quot;</span>, controller<span class="sy0">.</span><span class="me1">Name</span>, action<span class="sy0">.</span><span class="me1">Name</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// 4</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>actionsMissingAuth<span class="sy0">.</span><span class="me1">Any</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Assert<span class="sy0">.</span><span class="me1">Fail</span><span class="br0">&#40;</span><span class="kw4">String</span><span class="sy0">.</span><span class="me1">Format</span><span class="br0">&#40;</span><span class="st0">&quot;{0} action(s) do not have explicit authorization: {1}&quot;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; actionsMissingAuth<span class="sy0">.</span><span class="me1">Count</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">String</span><span class="sy0">.</span><span class="kw1">Join</span><span class="br0">&#40;</span><span class="st0">&quot;,&quot;</span>, actionsMissingAuth<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">static</span> <span class="kw4">class</span> AssemblyExtensions
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">public</span> <span class="kw1">static</span> IEnumerable<span class="sy0">&lt;</span>Type<span class="sy0">&gt;</span> GetLoadableTypes<span class="br0">&#40;</span><span class="kw1">this</span> Assembly assembly<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> assembly<span class="sy0">.</span><span class="me1">GetTypes</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">catch</span> <span class="br0">&#40;</span>ReflectionTypeLoadException e<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> e<span class="sy0">.</span><span class="me1">Types</span><span class="sy0">.</span><span class="kw1">Where</span><span class="br0">&#40;</span>t <span class="sy0">=&gt;</span> t <span class="sy0">!=</span> <span class="kw1">null</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">    [TestFixture]
    public class SecurityTests
    {
        Func&lt;object, bool&gt; IsMVCAttributeAuth = (o) =&gt; (o is AuthorizeAttribute || o is AllowAnonymousAttribute);

        [Test]
        public void AllMvcActionsHaveExplicitAuthorizationDefined_UsingStandardReflection()
        {
            var actionsMissingAuth = new List&lt;string&gt;();

            // 1
            var controllers = Assembly.GetAssembly(typeof(InteractiveAccountController)).GetLoadableTypes()
                          .Where(t =&gt; typeof(Controller).IsAssignableFrom(t));

            foreach (var controller in controllers)
            {
                // 2
                // if the controller has it, all it's actions are covered also
                if (controller.GetCustomAttributes().Any(a =&gt; IsMVCAttributeAuth(a)))
                    continue;

                var actions = controller.GetMethods(BindingFlags.Instance |
                                                    BindingFlags.DeclaredOnly |
                                                    BindingFlags.Public);
                foreach (var action in actions)
                {
                    // 3
                    // if the action has a defined authorization filter, it's covered
                    if (action.GetCustomAttributes().Any(a =&gt; IsMVCAttributeAuth(a)))
                        continue;

                    // no controller or action defined, add it to the list
                    actionsMissingAuth.Add(String.Format("{0}.{1}", controller.Name, action.Name));
                }
            }

            // 4
            if (actionsMissingAuth.Any())
            {
                Assert.Fail(String.Format("{0} action(s) do not have explicit authorization: {1}",
                              actionsMissingAuth.Count,
                              String.Join(",", actionsMissingAuth)));
            }
        }
    }


    public static class AssemblyExtensions
    {
        public static IEnumerable&lt;Type&gt; GetLoadableTypes(this Assembly assembly)
        {
            try
            {
                return assembly.GetTypes();
            }
            catch (ReflectionTypeLoadException e)
            {
                return e.Types.Where(t =&gt; t != null);
            }
        }
    }</pre></div></div>

<h2>Add Real Login Pages and Logic</h2>
<p>I&#8217;m not going to push a particular storage solution on you, so I have two interfaces I&#8217;ll be using as stand-ins for all of my &#8220;storage&#8221; needs:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">interface</span> IUserStorage
<span class="br0">&#123;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>User<span class="sy0">&gt;</span> GetUserByUsernameAsync<span class="br0">&#40;</span><span class="kw4">string</span> username<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>User<span class="sy0">&gt;</span> GetUserAsync<span class="br0">&#40;</span>Guid userId<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">public</span> <span class="kw4">interface</span> ISessionManager
<span class="br0">&#123;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span>IPrincipal<span class="sy0">&gt;</span> CreateSessionAsync<span class="br0">&#40;</span>Guid userId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Task<span class="sy0">&lt;</span><span class="kw4">bool</span><span class="sy0">&gt;</span> IsSessionValidAsync<span class="br0">&#40;</span>IPrincipal principal<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw4">bool</span> IsUserValidForSession<span class="br0">&#40;</span>User user<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public interface IUserStorage
{
    Task&lt;User&gt; GetUserByUsernameAsync(string username);
    Task&lt;User&gt; GetUserAsync(Guid userId);
}

public interface ISessionManager
{
    Task&lt;IPrincipal&gt; CreateSessionAsync(Guid userId);
    Task&lt;bool&gt; IsSessionValidAsync(IPrincipal principal);
    bool IsUserValidForSession(User user);
}</pre></div></div>

<p>I am also using <a href="https://en.wikipedia.org/wiki/Bcrypt">BCrypt</a> for password hashing. BCrypt is a slow hashing function that makes brute force attempts computationally expensive. To verify a hashed BCrypt password, we have to pull it out of our store and ask BCrypt to verify it (instead of some methods that allow you to hash a new value and compare at the storage level).</p>
<p><b>APIProject/Controllers/InteractiveAccountController.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="de1"><pre class="de1"><span class="sy0">...</span>
&nbsp;
<span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> GetLoginAsync<span class="br0">&#40;</span><span class="kw4">string</span> returnUrl<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, <span class="kw3">new</span> LoginModel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ReturnURL <span class="sy0">=</span> returnUrl <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>HttpPost<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> PostLoginAsync<span class="br0">&#40;</span><span class="kw4">string</span> username, <span class="kw4">string</span> password, <span class="kw4">string</span> returnUrl<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// Did they provide all the details?</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>username<span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw4">String</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>password<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, <span class="kw3">new</span> LoginModel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ReturnURL <span class="sy0">=</span> returnUrl, UserName <span class="sy0">=</span> username, Error <span class="sy0">=</span> <span class="st0">&quot;Please provide both a username and password.&quot;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// Load the User and see if BCrypt can verify the entered password matches the stored hash</span>
&nbsp; &nbsp; <span class="kw1">var</span> secrets <span class="sy0">=</span> await _userStorage<span class="sy0">.</span><span class="me1">GetUserByUsernameAsync</span><span class="br0">&#40;</span>username<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>secrets <span class="sy0">==</span> <span class="kw1">null</span> <span class="sy0">||</span> <span class="sy0">!</span>BCrypt<span class="sy0">.</span><span class="me1">Net</span><span class="sy0">.</span><span class="me1">BCrypt</span><span class="sy0">.</span><span class="me1">Verify</span><span class="br0">&#40;</span>password, secrets<span class="sy0">.</span><span class="me1">PasswordHash</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, <span class="kw3">new</span> LoginModel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ReturnURL <span class="sy0">=</span> returnUrl, UserName <span class="sy0">=</span> username, Error <span class="sy0">=</span> <span class="st0">&quot;Sorry, could not find a user with that name and password.&quot;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp;
&nbsp; &nbsp; <span class="co1">// Verify the user is allowed to start a session (record is enabled, etc)</span>
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>_sessionManager<span class="sy0">.</span><span class="me1">IsUserValidForSession</span><span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span>, <span class="kw3">new</span> LoginModel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> ReturnURL <span class="sy0">=</span> returnUrl, UserName <span class="sy0">=</span> username, Error <span class="sy0">=</span> <span class="st0">&quot;Sorry, your account is currently disabled.&quot;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// Create a principal for the session/user and put it in the cookie</span>
&nbsp; &nbsp; <span class="kw1">var</span> principal <span class="sy0">=</span> await _sessionManager<span class="sy0">.</span><span class="me1">CreateSessionAsync</span><span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">Authentication</span><span class="sy0">.</span><span class="me1">SignInAsync</span><span class="br0">&#40;</span><span class="st0">&quot;NAME_OF_YOUR_COOKIE_SCHEME&quot;</span>, principal<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// Redirect the user</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw4">String</span><span class="sy0">.</span><span class="me1">IsNullOrWhiteSpace</span><span class="br0">&#40;</span>returnUrl<span class="br0">&#41;</span> <span class="sy0">||</span> returnUrl<span class="sy0">.</span><span class="me1">ToLower</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">StartsWith</span><span class="br0">&#40;</span><span class="st0">&quot;/account/login&quot;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; returnUrl <span class="sy0">=</span> <span class="st0">&quot;/&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> Redirect<span class="br0">&#40;</span>returnUrl<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;Logout&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> GetLogout<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">Authentication</span><span class="sy0">.</span><span class="me1">SignOutAsync</span><span class="br0">&#40;</span><span class="st0">&quot;NAME_OF_YOUR_COOKIE_SCHEME&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> Redirect<span class="br0">&#40;</span><span class="st0">&quot;/account/login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="sy0">...</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">...

[HttpGet("Login")]
public async Task&lt;IActionResult&gt; GetLoginAsync(string returnUrl)
{
    return View("Login", new LoginModel() { ReturnURL = returnUrl });
}

[HttpPost("Login")]
public async Task&lt;IActionResult&gt; PostLoginAsync(string username, string password, string returnUrl)
{
    // Did they provide all the details?
    if (string.IsNullOrEmpty(username) || String.IsNullOrEmpty(password))
        return View("Login", new LoginModel() { ReturnURL = returnUrl, UserName = username, Error = "Please provide both a username and password." });

    // Load the User and see if BCrypt can verify the entered password matches the stored hash
    var secrets = await _userStorage.GetUserByUsernameAsync(username);
    if (secrets == null || !BCrypt.Net.BCrypt.Verify(password, secrets.PasswordHash))
        return View("Login", new LoginModel() { ReturnURL = returnUrl, UserName = username, Error = "Sorry, could not find a user with that name and password." });
   
    // Verify the user is allowed to start a session (record is enabled, etc)
    if(!_sessionManager.IsUserValidForSession(user))
        return View("Login", new LoginModel() { ReturnURL = returnUrl, UserName = username, Error = "Sorry, your account is currently disabled." });

    // Create a principal for the session/user and put it in the cookie
    var principal = await _sessionManager.CreateSessionAsync(user);
    await HttpContext.Authentication.SignInAsync("NAME_OF_YOUR_COOKIE_SCHEME", principal);

    // Redirect the user
    if (String.IsNullOrWhiteSpace(returnUrl) || returnUrl.ToLower().StartsWith("/account/login"))
        returnUrl = "/";

    return Redirect(returnUrl);
}

[HttpGet("Logout")]
public async Task&lt;IActionResult&gt; GetLogout()
{
    await HttpContext.Authentication.SignOutAsync("NAME_OF_YOUR_COOKIE_SCHEME");
    return Redirect("/account/login");
}

...</pre></div></div>

<p>Inside the <code>ISessionManager.CreateSessionAsync</code>, we create a session in storage with an id and then when the Principal is created we add that Id as a claim in the Principal. This is how we&#8217;ll look up the session on later requests to get the user information.</p>
<p>The Cookie middleware will take care of built-in timeouts, but we also need to add a check in case someone disables the user (or whatever criteria is necessary in your system). Add this to the Startup.cs setup.</p>
<p><b>APIProject/Startup.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="de1"><pre class="de1">app<span class="sy0">.</span><span class="me1">UseCookieAuthentication</span><span class="br0">&#40;</span><span class="kw3">new</span> CookieAuthenticationOptions<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; <span class="sy0">...</span>
&nbsp;
&nbsp; &nbsp; <span class="me1">Events</span> <span class="sy0">=</span> <span class="kw3">new</span> CookieAuthenticationEvents<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">...</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Use my ISessionManager to ensure session is still valid (user not disabled) or reject the principal if it is no longer valid</span>
&nbsp; &nbsp; &nbsp; &nbsp; OnValidatePrincipal <span class="sy0">=</span> async <span class="br0">&#40;</span>ctx<span class="br0">&#41;</span> <span class="sy0">=&gt;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> sessionManager <span class="sy0">=</span> ctx<span class="sy0">.</span><span class="me1">HttpContext</span><span class="sy0">.</span><span class="me1">RequestServices</span><span class="sy0">.</span><span class="me1">GetRequiredService</span><span class="sy0">&lt;</span>ISessionManager<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> isSessionValid <span class="sy0">=</span> await sessionManager<span class="sy0">.</span><span class="me1">IsSessionValidAsync</span><span class="br0">&#40;</span>ctx<span class="sy0">.</span><span class="me1">Principal</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>isSessionValid<span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx<span class="sy0">.</span><span class="me1">RejectPrincipal</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">app.UseCookieAuthentication(new CookieAuthenticationOptions() {

	...

	Events = new CookieAuthenticationEvents() {

		...

		// Use my ISessionManager to ensure session is still valid (user not disabled) or reject the principal if it is no longer valid
		OnValidatePrincipal = async (ctx) =&gt; {
			var sessionManager = ctx.HttpContext.RequestServices.GetRequiredService&lt;ISessionManager&gt;();
			var isSessionValid = await sessionManager.IsSessionValidAsync(ctx.Principal);
			if (!isSessionValid) {
				ctx.RejectPrincipal();
			}
		}
	}
});</pre></div></div>

<p><code>ISessionManager.IsSessionValidAsync</code> can now pull that Id claim we created above, get the associated user, and do any number of additional validations on the session length, user enabled state, and so on.</p>
<h2>Accessing the User/Session</h2>
<p>The last step is to the ability to access the User in other controllers. Controllers have a <code>User</code> property that grants access to the ClaimsPrincipal created during login. Assuming we had also stored a property like &#8220;UserId&#8221; in <code>ISessionManager.CreateSessionAsync</code> then we can access it like this:</p>
<p><b>APIProject/Controllers/AnyOldController.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">var</span> userIdClaim <span class="sy0">=</span> User<span class="sy0">.</span><span class="me1">FindFirst</span><span class="br0">&#40;</span><span class="st0">&quot;UserId&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">var</span> userId <span class="sy0">=</span> Guid<span class="sy0">.</span><span class="me1">Parse</span><span class="br0">&#40;</span>userIdClaim<span class="sy0">.</span><span class="kw1">Value</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">var userIdClaim = User.FindFirst("UserId");
var userId = Guid.Parse(userIdClaim.Value);</pre></div></div>

<p>The second time I jumped through this particular hoop, I added a method to my SessionManager that accepted a Controller and looked the user up from the database, so I could do this instead:</p>
<p><b>APIProject/Controllers/AnyOldController.cs</b></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">var</span> user <span class="sy0">=</span> await _sessionManager<span class="sy0">.</span><span class="me1">GetCurrentUserAsync</span><span class="br0">&#40;</span><span class="kw1">this</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">var user = await _sessionManager.GetCurrentUserAsync(this);</pre></div></div>

<p>The Session Id mentioned in the prior section is handled the same way.</p>
<h2>Final Checklist</h2>
<p>If you&#8217;re using this to follow along and implement, here are the pieces you should have:</p>
<ul>
<li>Startup.cs: The CookieMiddleware configured with expiration, automatic challenge, 401 redirects for APIs, and re-validation of the session</li>
<li>InteractiveAccountController: GET/POST for Login, GET for Logout, pages for Forbidden plus the Views for these pages</li>
<li>UserStore and SessionManager implementations, with just a few functions needed and ability to extend the ClaimsPrincipal with more fields as you grow</li>
</ul>
<p>You can go as light or heavy as you need to with storage, relational or non-relational, as needed. You have BCrypt, one of the small set of recommended options from <a href="https://www.owasp.org/index.php/Password_Storage_Cheat_Sheet">OWASP</a> (or upgrade to <a href="https://www.nuget.org/packages/Liphsoft.Crypto.Argon2">Argon2</a>). You have cookies with encrypted contents (including the expiration date) that automatically default to <code>secure</code> for HTTPS websites.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-without-identity/feed/</wfw:commentRss>
		<slash:comments>4</slash:comments>
		</item>
	</channel>
</rss>
