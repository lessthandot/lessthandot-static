<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>visual studio 2008 &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/visual-studio-2008/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>Running static code analysis on SQL Server database with Visual Studio Team System for database architects</title>
		<link>/index.php/datamgmt/datadesign/running-static-code-analysis-on-sql-serv/</link>
		<comments>/index.php/datamgmt/datadesign/running-static-code-analysis-on-sql-serv/#respond</comments>
		<pubDate>Sun, 31 Jan 2010 23:35:26 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Administration]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[code analysis]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[visual studio 2008]]></category>

		<guid isPermaLink="false">/index.php/2010/01/running-static-code-analysis-on-sql-serv/</guid>
		<description><![CDATA[To me it seems that Visual Studio Team System 2008 Database Edition is the stepchild of the Visual Studio family. Even in shops that have MSDN Universal/Ultimate subscriptions this version is just not used that much. Maybe it is that long name of this product, I still prefer DataDude. I would like to show you [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>To me it seems that Visual Studio Team System 2008 Database Edition is the stepchild of the Visual Studio family. Even in shops that have MSDN Universal/Ultimate subscriptions this version is just not used that much. Maybe it is that long name of this product, I still prefer DataDude. I would like to show you that if you do have licenses for this tool then you should use it because it has some great features. Today we will focus on static code analysis.</p>
<p>Before we start, make sure to grab Microsoft Visual Studio Team System 2008 Database Edition GDR R2<br />
and install that on top of your Visual Studio Team System 2008 Database Edition. This install adds the following things to Visual Studio</p>
<p>In addition to providing support for SQL Server 2008 database projects, this release incorporates many previously released Power Tools as well as several new features. The new features include distinct Build and Deploy phases, Static Code Analysis and improved integration with SQL CLR projects.</p>
<p>Database Edition no longer requires a Design Database. Therefore, it is no longer necessary to install an instance of SQL Express or SQL Server prior to using Database Edition.<br />
You can download  Microsoft Visual Studio Team System 2008 Database Edition GDR R2  here http://www.microsoft.com/downloads/details.aspx?FamilyID=bb3ad767-5f69-4db9-b1c9-8f55759846ed&amp;displaylang=en</p>
<p>Once you have everything installed, start up Visual Studio and create a new database project. You should see something similar to the pic below</p>
<div class="image_block"><img src="/wp-content/uploads/blogs/DataMgmt//db1.png" alt="" title="" width="630" height="426" /></div>
<p>Create a new database connection, you can do that by going to  View&#8211;>Server Explorer. Under Data Connections add a new connection to your database that you want to connect to, follow the wizard and create the connection. Now I decided to run static code analysis against the aspnetdb database that is used with ASP.NET. If you want to follow along and use this same database, take a look at this post<a href="/index.php/WebDev/ServerProgramming/ASPNET/setting-up-sql-server-with-asp-net-mvc"> Setting up SQL Server with ASP.NET MVC</a> to see how to set it up</p>
<p>Once your database is setup go to the Solution explorer, right click on the project and select Import Database Objects and Settings. </p>
<div class="image_block"><img src="/wp-content/uploads/blogs/DataMgmt//db2.png" alt="" title="" width="276" height="197" /></div>
<p>The following dialog will be shown</p>
<div class="image_block"><img src="/wp-content/uploads/blogs/DataMgmt//db3.png" alt="" title="" width="841" height="301" /></div>
<p>Pick your connection and then click start</p>
<p>The output will be similar to this</p>
<p>1/30/2010 11:26:40 AM	Import of database schema has started.<br />
1/30/2010 11:26:45 AM	Adding all files to the project&#8230;<br />
1/30/2010 11:26:46 AM	Finished adding all files to the project.<br />
1/30/2010 11:26:46 AM	Done<br />
1/30/2010 11:26:46 AM	Import of database schema is complete.<br />
1/30/2010 11:26:46 AM	A summary of the import operation has been saved to the log file C:SVNInterrogateASPInterrogateASPImport Schema LogsInterrogateASP_20100130042639.log.<br />
1/30/2010 11:26:46 AM	Press Finish to continue&#8230;</p>
<p>Here is what the solution explorer looks like, as you can see the folder hierarchy is very similar to the one in SSMS</p>
<div class="image_block"><img src="/wp-content/uploads/blogs/DataMgmt//db4.png" alt="" title="" width="345" height="765" /></div>
<p>Okay now we are ready to run our static code analysis, click on Data&#8211;>Static Code Analysis&#8211;Run<br />
<img src="http://imgur.com/oqRCC.png" alt="Run Analysis" title="Run Analysis" /></p>
<p>Here is the output from that, this creates 216 warnings, I have not pasted the whole output here because it is longer than this whole blog post and most warnings are the same but just for different objects. Here is just a small part and we will look at two of those procedures mentioned in this</p>
<p><span class="MT_smaller">Running Code Analysis&#8230;<br />
Verifying project state&#8230;<br />
Finished verifying project state.<br />
Loading project references&#8230;<br />
Loading project files&#8230;<br />
Building the project model and resolving object interdependencies&#8230;<br />
Validating the project model&#8230;<br />
ASPNET_APPLICATIONS_CREATEAPPLICATION.PROC.SQL(7,79)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_APPLICATIONS_CREATEAPPLICATION.PROC.SQL(24,15)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_CHECKSCHEMAVERSION.PROC.SQL(9,35)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_MEMBERSHIP_CHANGEPASSWORDQUESTIONANDANSWER.PROC.SQL(11,38)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_MEMBERSHIP_CHANGEPASSWORDQUESTIONANDANSWER.PROC.SQL(11,58)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_MEMBERSHIP_CHANGEPASSWORDQUESTIONANDANSWER.PROC.SQL(12,31)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_MEMBERSHIP_CHANGEPASSWORDQUESTIONANDANSWER.PROC.SQL(14,13)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_GETUSERSINROLES.PROC.SQL(9,75)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_GETUSERSINROLES.PROC.SQL(17,14)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_GETUSERSINROLES.PROC.SQL(23,32)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_ISUSERINROLE.PROC.SQL(10,75)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_ISUSERINROLE.PROC.SQL(20,31)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_ISUSERINROLE.PROC.SQL(27,31)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(10,64)Warning : SR0015 : Microsoft.Performance : Deterministic function call (LOWER) might cause an unnecessary table scan.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(52,32)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(60,83)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(86,32)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(94,83)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(102,35)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(102,47)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(108,23)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(108,36)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(108,56)Warning : SR0010 : Microsoft.Design : Old-style JOIN syntax is used.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(110,7)Warning : SR0004 : Microsoft.Performance : A column without an index that is used as an IN predicate test expression might degrade performance.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(111,7)Warning : SR0004 : Microsoft.Performance : A column without an index that is used as an IN predicate test expression might degrade performance.<br />
ASPNET_USERSINROLES_REMOVEUSERSFROMROLES.PROC.SQL(118,8)Warning : SR0004 : Microsoft.Performance : A column without an index that is used as an IN predicate test expression might degrade performance.<br />
ASPNET_WEBEVENT_LOGEVENT.PROC.SQL(44,9)Warning : SR0014 : Microsoft.Design : Data loss might occur when casting from Decimal to Decimal.<br />
ASPNET_WEBEVENT_LOGEVENT.PROC.SQL(45,9)Warning : SR0014 : Microsoft.Design : Data loss might occur when casting from Decimal to Decimal.<br />
Code analysis complete &#8212; 0 error(s), 216 warning(s)</span></p>
<p>Now I was intrigued so I picked the aspnet_Applications_CreateApplication stored procedure from that list.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>aspnetdb<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;StoredProcedure [dbo].[aspnet_Applications_CreateApplication] &nbsp; &nbsp;Script Date: 01/17/2010 15:51:15 ******/</span>
<span class="kw1">SET</span> ANSI_<span class="sy0">NULL</span>S <span class="kw1">ON</span>
GO
<span class="kw1">SET</span> QUOTED_IDENTIFIER <span class="kw1">OFF</span>
GO
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">PROCEDURE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>aspnet_Applications_CreateApplication<span class="br0">&#93;</span>
&nbsp; &nbsp; @ApplicationName &nbsp; &nbsp; &nbsp;<span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">256</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; @ApplicationId &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">UNIQUEIDENTIFIER</span> <span class="kw1">OUTPUT</span>
<span class="kw1">AS</span>
<span class="kw1">BEGIN</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@ApplicationId <span class="sy0">=</span> ApplicationId <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_Applications</span> <span class="kw1">WHERE</span> <span class="kw2">LOWER</span><span class="br0">&#40;</span>@ApplicationName<span class="br0">&#41;</span> <span class="sy0">=</span> LoweredApplicationName
&nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span>@ApplicationId <span class="kw1">IS</span> <span class="sy0">NULL</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">DECLARE</span> @TranStarted &nbsp; <span class="kw1">BIT</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> <span class="kw2">@@TRANCOUNT</span> <span class="sy0">=</span> <span class="nu0">0</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@ApplicationId <span class="sy0">=</span> ApplicationId
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_Applications</span> <span class="kw1">WITH</span> <span class="br0">&#40;</span>UPDLOCK, <span class="kw1">HOLDLOCK</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> <span class="kw2">LOWER</span><span class="br0">&#40;</span>@ApplicationName<span class="br0">&#41;</span> <span class="sy0">=</span> LoweredApplicationName
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span>@ApplicationId <span class="kw1">IS</span> <span class="sy0">NULL</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@ApplicationId <span class="sy0">=</span> NEWID<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">INSERT</span> &nbsp;dbo.<span class="me1">aspnet_Applications</span> <span class="br0">&#40;</span>ApplicationId, ApplicationName, LoweredApplicationName<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">VALUES</span> &nbsp;<span class="br0">&#40;</span>@ApplicationId, @ApplicationName, <span class="kw2">LOWER</span><span class="br0">&#40;</span>@ApplicationName<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span><span class="kw2">@@ERROR</span> <span class="sy0">=</span> <span class="nu0">0</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">COMMIT</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ELSE</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ROLLBACK</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">END</span>
&nbsp; &nbsp; <span class="kw1">END</span>
<span class="kw1">END</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [aspnetdb]
GO
/****** Object:  StoredProcedure [dbo].[aspnet_Applications_CreateApplication]    Script Date: 01/17/2010 15:51:15 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
 
ALTER PROCEDURE [dbo].[aspnet_Applications_CreateApplication]
    @ApplicationName      NVARCHAR(256),
    @ApplicationId        UNIQUEIDENTIFIER OUTPUT
AS
BEGIN
    SELECT  @ApplicationId = ApplicationId FROM dbo.aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
 
    IF(@ApplicationId IS NULL)
    BEGIN
        DECLARE @TranStarted   BIT
        SET @TranStarted = 0
 
        IF( @@TRANCOUNT = 0 )
        BEGIN
            BEGIN TRANSACTION
            SET @TranStarted = 1
        END
        ELSE
            SET @TranStarted = 0
 
        SELECT  @ApplicationId = ApplicationId
        FROM dbo.aspnet_Applications WITH (UPDLOCK, HOLDLOCK)
        WHERE LOWER(@ApplicationName) = LoweredApplicationName
 
        IF(@ApplicationId IS NULL)
        BEGIN
            SELECT  @ApplicationId = NEWID()
            INSERT  dbo.aspnet_Applications (ApplicationId, ApplicationName, LoweredApplicationName)
            VALUES  (@ApplicationId, @ApplicationName, LOWER(@ApplicationName))
        END
 
 
        IF( @TranStarted = 1 )
        BEGIN
            IF(@@ERROR = 0)
            BEGIN
            SET @TranStarted = 0
            COMMIT TRANSACTION
            END
            ELSE
            BEGIN
                SET @TranStarted = 0
                ROLLBACK TRANSACTION
            END
        END
    END
END</pre></div></div>

<p>As you can see it uses the LOWER function in this line</p>
<p>WHERE LOWER(@ApplicationName) = LoweredApplicationName</p>
<p>It actually tells you on which line and position this is actually used (ASPNET_APPLICATIONS_CREATEAPPLICATION.PROC.SQL(7,79)Warning) so this means line 7, position 79</p>
<p>Here is another stored procedure, this one uses the LOWER function and old style joins</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> <span class="br0">&#91;</span>aspnetdb<span class="br0">&#93;</span>
GO
<span class="coMULTI">/****** Object: &nbsp;StoredProcedure [dbo].[aspnet_UsersInRoles_RemoveUsersFromRoles] &nbsp; &nbsp;Script Date: 01/17/2010 15:53:59 ******/</span>
<span class="kw1">SET</span> ANSI_<span class="sy0">NULL</span>S <span class="kw1">ON</span>
GO
<span class="kw1">SET</span> QUOTED_IDENTIFIER <span class="kw1">OFF</span>
GO
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">PROCEDURE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>aspnet_UsersInRoles_RemoveUsersFromRoles<span class="br0">&#93;</span>
&nbsp; &nbsp; @ApplicationName &nbsp;<span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">256</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; @UserNames &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">4000</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; @RoleNames &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">4000</span><span class="br0">&#41;</span>
<span class="kw1">AS</span>
<span class="kw1">BEGIN</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @AppId <span class="kw1">UNIQUEIDENTIFIER</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@AppId <span class="sy0">=</span> <span class="sy0">NULL</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@AppId <span class="sy0">=</span> ApplicationId <span class="kw1">FROM</span> aspnet_Applications <span class="kw1">WHERE</span> <span class="kw2">LOWER</span><span class="br0">&#40;</span>@ApplicationName<span class="br0">&#41;</span> <span class="sy0">=</span> LoweredApplicationName
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@AppId <span class="kw1">IS</span> <span class="sy0">NULL</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">RETURN</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @TranStarted &nbsp; <span class="kw1">BIT</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> <span class="kw2">@@TRANCOUNT</span> <span class="sy0">=</span> <span class="nu0">0</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">BEGIN</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @tbNames &nbsp;<span class="kw1">TABLE</span><span class="br0">&#40;</span>Name <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">256</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @tbRoles &nbsp;<span class="kw1">TABLE</span><span class="br0">&#40;</span>RoleId <span class="kw1">UNIQUEIDENTIFIER</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @tbUsers &nbsp;<span class="kw1">TABLE</span><span class="br0">&#40;</span>UserId <span class="kw1">UNIQUEIDENTIFIER</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @Num &nbsp; &nbsp; &nbsp;<span class="kw1">INT</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @Pos &nbsp; &nbsp; &nbsp;<span class="kw1">INT</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @NextPos &nbsp;<span class="kw1">INT</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @Name &nbsp; &nbsp; <span class="kw1">NVARCHAR</span><span class="br0">&#40;</span><span class="nu0">256</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @CountAll <span class="kw1">INT</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @CountU &nbsp; <span class="kw1">INT</span>
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @CountR &nbsp; <span class="kw1">INT</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">SET</span> @Num <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @Pos <span class="sy0">=</span> <span class="nu0">1</span>
&nbsp; &nbsp; <span class="kw1">WHILE</span><span class="br0">&#40;</span>@Pos <span class="sy0">&lt;=</span> <span class="kw2">LEN</span><span class="br0">&#40;</span>@RoleNames<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @NextPos <span class="sy0">=</span> <span class="kw2">CHARINDEX</span><span class="br0">&#40;</span>N<span class="st0">','</span>, @RoleNames, &nbsp;@Pos<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@NextPos <span class="sy0">=</span> <span class="nu0">0</span> <span class="sy0">OR</span> @NextPos <span class="kw1">IS</span> <span class="sy0">NULL</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @NextPos <span class="sy0">=</span> <span class="kw2">LEN</span><span class="br0">&#40;</span>@RoleNames<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @Name <span class="sy0">=</span> <span class="kw2">RTRIM</span><span class="br0">&#40;</span><span class="kw2">LTRIM</span><span class="br0">&#40;</span><span class="kw2">SUBSTRING</span><span class="br0">&#40;</span>@RoleNames, @Pos, @NextPos <span class="sy0">-</span> @Pos<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @Pos <span class="sy0">=</span> @NextPos<span class="sy0">+</span><span class="nu0">1</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">INSERT</span> <span class="kw1">INTO</span> @tbNames <span class="kw1">VALUES</span> <span class="br0">&#40;</span>@Name<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @Num <span class="sy0">=</span> @Num <span class="sy0">+</span> <span class="nu0">1</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">INSERT</span> <span class="kw1">INTO</span> @tbRoles
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> RoleId
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; dbo.<span class="me1">aspnet_Roles</span> ar, @tbNames t
&nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp;<span class="kw2">LOWER</span><span class="br0">&#40;</span>t.<span class="me1">Name</span><span class="br0">&#41;</span> <span class="sy0">=</span> ar.<span class="me1">LoweredRoleName</span> <span class="sy0">AND</span> ar.<span class="me1">ApplicationId</span> <span class="sy0">=</span> @AppId
&nbsp; &nbsp; <span class="kw1">SELECT</span> @CountR <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@CountR <span class="sy0">&lt;&gt;</span> @Num<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">1</span> N<span class="st0">''</span>, Name
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; @tbNames
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp;<span class="kw2">LOWER</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> ar.<span class="me1">LoweredRoleName</span> <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_Roles</span> ar, &nbsp;@tbRoles r <span class="kw1">WHERE</span> r.<span class="me1">RoleId</span> <span class="sy0">=</span> ar.<span class="me1">RoleId</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ROLLBACK</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">RETURN</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">DELETE</span> <span class="kw1">FROM</span> @tbNames <span class="kw1">WHERE</span> <span class="nu0">1</span><span class="sy0">=</span><span class="nu0">1</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @Num <span class="sy0">=</span> <span class="nu0">0</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @Pos <span class="sy0">=</span> <span class="nu0">1</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">WHILE</span><span class="br0">&#40;</span>@Pos <span class="sy0">&lt;=</span> <span class="kw2">LEN</span><span class="br0">&#40;</span>@UserNames<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @NextPos <span class="sy0">=</span> <span class="kw2">CHARINDEX</span><span class="br0">&#40;</span>N<span class="st0">','</span>, @UserNames, &nbsp;@Pos<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@NextPos <span class="sy0">=</span> <span class="nu0">0</span> <span class="sy0">OR</span> @NextPos <span class="kw1">IS</span> <span class="sy0">NULL</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @NextPos <span class="sy0">=</span> <span class="kw2">LEN</span><span class="br0">&#40;</span>@UserNames<span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @Name <span class="sy0">=</span> <span class="kw2">RTRIM</span><span class="br0">&#40;</span><span class="kw2">LTRIM</span><span class="br0">&#40;</span><span class="kw2">SUBSTRING</span><span class="br0">&#40;</span>@UserNames, @Pos, @NextPos <span class="sy0">-</span> @Pos<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> @Pos <span class="sy0">=</span> @NextPos<span class="sy0">+</span><span class="nu0">1</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">INSERT</span> <span class="kw1">INTO</span> @tbNames <span class="kw1">VALUES</span> <span class="br0">&#40;</span>@Name<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> @Num <span class="sy0">=</span> @Num <span class="sy0">+</span> <span class="nu0">1</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">INSERT</span> <span class="kw1">INTO</span> @tbUsers
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> UserId
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; dbo.<span class="me1">aspnet_Users</span> ar, @tbNames t
&nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp;<span class="kw2">LOWER</span><span class="br0">&#40;</span>t.<span class="me1">Name</span><span class="br0">&#41;</span> <span class="sy0">=</span> ar.<span class="me1">LoweredUserName</span> <span class="sy0">AND</span> ar.<span class="me1">ApplicationId</span> <span class="sy0">=</span> @AppId
&nbsp;
&nbsp; &nbsp; <span class="kw1">SELECT</span> @CountU <span class="sy0">=</span> <span class="kw2">@@ROWCOUNT</span>
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@CountU <span class="sy0">&lt;&gt;</span> @Num<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">1</span> Name, N<span class="st0">''</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; @tbNames
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp;<span class="kw2">LOWER</span><span class="br0">&#40;</span>Name<span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> au.<span class="me1">LoweredUserName</span> <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_Users</span> au, &nbsp;@tbUsers u <span class="kw1">WHERE</span> u.<span class="me1">UserId</span> <span class="sy0">=</span> au.<span class="me1">UserId</span><span class="br0">&#41;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ROLLBACK</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">RETURN</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">SELECT</span> &nbsp;@CountAll <span class="sy0">=</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; &nbsp;dbo.<span class="me1">aspnet_UsersInRoles</span> ur, @tbUsers u, @tbRoles r
&nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp; ur.<span class="me1">UserId</span> <span class="sy0">=</span> u.<span class="me1">UserId</span> <span class="sy0">AND</span> ur.<span class="me1">RoleId</span> <span class="sy0">=</span> r.<span class="me1">RoleId</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="br0">&#40;</span>@CountAll <span class="sy0">&lt;&gt;</span> @CountU <span class="sy0">*</span> @CountR<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">BEGIN</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">1</span> UserName, RoleName
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; &nbsp; &nbsp; &nbsp; @tbUsers tu, @tbRoles tr, dbo.<span class="me1">aspnet_Users</span> u, dbo.<span class="me1">aspnet_Roles</span> r
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> &nbsp; &nbsp; &nbsp; &nbsp;u.<span class="me1">UserId</span> <span class="sy0">=</span> tu.<span class="me1">UserId</span> <span class="sy0">AND</span> r.<span class="me1">RoleId</span> <span class="sy0">=</span> tr.<span class="me1">RoleId</span> <span class="sy0">AND</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tu.<span class="me1">UserId</span> <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> ur.<span class="me1">UserId</span> <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_UsersInRoles</span> ur <span class="kw1">WHERE</span> ur.<span class="me1">RoleId</span> <span class="sy0">=</span> tr.<span class="me1">RoleId</span><span class="br0">&#41;</span> <span class="sy0">AND</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;tr.<span class="me1">RoleId</span> <span class="sy0">NOT</span> <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> ur.<span class="me1">RoleId</span> <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_UsersInRoles</span> ur <span class="kw1">WHERE</span> ur.<span class="me1">UserId</span> <span class="sy0">=</span> tu.<span class="me1">UserId</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">ROLLBACK</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">RETURN</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">END</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">DELETE</span> <span class="kw1">FROM</span> dbo.<span class="me1">aspnet_UsersInRoles</span>
&nbsp; &nbsp; <span class="kw1">WHERE</span> UserId <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> UserId <span class="kw1">FROM</span> @tbUsers<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; <span class="sy0">AND</span> RoleId <span class="sy0">IN</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> RoleId <span class="kw1">FROM</span> @tbRoles<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">IF</span><span class="br0">&#40;</span> @TranStarted <span class="sy0">=</span> <span class="nu0">1</span> <span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">COMMIT</span> <span class="kw1">TRANSACTION</span>
&nbsp; &nbsp; <span class="kw1">RETURN</span><span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span>
<span class="kw1">END</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE [aspnetdb]
GO
/****** Object:  StoredProcedure [dbo].[aspnet_UsersInRoles_RemoveUsersFromRoles]    Script Date: 01/17/2010 15:53:59 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER OFF
GO
 
ALTER PROCEDURE [dbo].[aspnet_UsersInRoles_RemoveUsersFromRoles]
    @ApplicationName  NVARCHAR(256),
    @UserNames        NVARCHAR(4000),
    @RoleNames        NVARCHAR(4000)
AS
BEGIN
    DECLARE @AppId UNIQUEIDENTIFIER
    SELECT  @AppId = NULL
    SELECT  @AppId = ApplicationId FROM aspnet_Applications WHERE LOWER(@ApplicationName) = LoweredApplicationName
    IF (@AppId IS NULL)
        RETURN(2)
 
 
    DECLARE @TranStarted   BIT
    SET @TranStarted = 0
 
    IF( @@TRANCOUNT = 0 )
    BEGIN
        BEGIN TRANSACTION
        SET @TranStarted = 1
    END
 
    DECLARE @tbNames  TABLE(Name NVARCHAR(256) NOT NULL PRIMARY KEY)
    DECLARE @tbRoles  TABLE(RoleId UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    DECLARE @tbUsers  TABLE(UserId UNIQUEIDENTIFIER NOT NULL PRIMARY KEY)
    DECLARE @Num      INT
    DECLARE @Pos      INT
    DECLARE @NextPos  INT
    DECLARE @Name     NVARCHAR(256)
    DECLARE @CountAll INT
    DECLARE @CountU   INT
    DECLARE @CountR   INT
 
 
    SET @Num = 0
    SET @Pos = 1
    WHILE(@Pos &lt;= LEN(@RoleNames))
    BEGIN
        SELECT @NextPos = CHARINDEX(N',', @RoleNames,  @Pos)
        IF (@NextPos = 0 OR @NextPos IS NULL)
            SELECT @NextPos = LEN(@RoleNames) + 1
        SELECT @Name = RTRIM(LTRIM(SUBSTRING(@RoleNames, @Pos, @NextPos - @Pos)))
        SELECT @Pos = @NextPos+1
 
        INSERT INTO @tbNames VALUES (@Name)
        SET @Num = @Num + 1
    END
 
    INSERT INTO @tbRoles
      SELECT RoleId
      FROM   dbo.aspnet_Roles ar, @tbNames t
      WHERE  LOWER(t.Name) = ar.LoweredRoleName AND ar.ApplicationId = @AppId
    SELECT @CountR = @@ROWCOUNT
 
    IF (@CountR &lt;&gt; @Num)
    BEGIN
        SELECT TOP 1 N'', Name
        FROM   @tbNames
        WHERE  LOWER(Name) NOT IN (SELECT ar.LoweredRoleName FROM dbo.aspnet_Roles ar,  @tbRoles r WHERE r.RoleId = ar.RoleId)
        IF( @TranStarted = 1 )
            ROLLBACK TRANSACTION
        RETURN(2)
    END
 
 
    DELETE FROM @tbNames WHERE 1=1
    SET @Num = 0
    SET @Pos = 1
 
 
    WHILE(@Pos &lt;= LEN(@UserNames))
    BEGIN
        SELECT @NextPos = CHARINDEX(N',', @UserNames,  @Pos)
        IF (@NextPos = 0 OR @NextPos IS NULL)
            SELECT @NextPos = LEN(@UserNames) + 1
        SELECT @Name = RTRIM(LTRIM(SUBSTRING(@UserNames, @Pos, @NextPos - @Pos)))
        SELECT @Pos = @NextPos+1
 
        INSERT INTO @tbNames VALUES (@Name)
        SET @Num = @Num + 1
    END
 
    INSERT INTO @tbUsers
      SELECT UserId
      FROM   dbo.aspnet_Users ar, @tbNames t
      WHERE  LOWER(t.Name) = ar.LoweredUserName AND ar.ApplicationId = @AppId
 
    SELECT @CountU = @@ROWCOUNT
    IF (@CountU &lt;&gt; @Num)
    BEGIN
        SELECT TOP 1 Name, N''
        FROM   @tbNames
        WHERE  LOWER(Name) NOT IN (SELECT au.LoweredUserName FROM dbo.aspnet_Users au,  @tbUsers u WHERE u.UserId = au.UserId)
 
        IF( @TranStarted = 1 )
            ROLLBACK TRANSACTION
        RETURN(1)
    END
 
    SELECT  @CountAll = COUNT(*)
    FROM    dbo.aspnet_UsersInRoles ur, @tbUsers u, @tbRoles r
    WHERE   ur.UserId = u.UserId AND ur.RoleId = r.RoleId
 
    IF (@CountAll &lt;&gt; @CountU * @CountR)
    BEGIN
        SELECT TOP 1 UserName, RoleName
        FROM         @tbUsers tu, @tbRoles tr, dbo.aspnet_Users u, dbo.aspnet_Roles r
        WHERE        u.UserId = tu.UserId AND r.RoleId = tr.RoleId AND
                     tu.UserId NOT IN (SELECT ur.UserId FROM dbo.aspnet_UsersInRoles ur WHERE ur.RoleId = tr.RoleId) AND
                     tr.RoleId NOT IN (SELECT ur.RoleId FROM dbo.aspnet_UsersInRoles ur WHERE ur.UserId = tu.UserId)
        IF( @TranStarted = 1 )
            ROLLBACK TRANSACTION
        RETURN(3)
    END
 
    DELETE FROM dbo.aspnet_UsersInRoles
    WHERE UserId IN (SELECT UserId FROM @tbUsers)
      AND RoleId IN (SELECT RoleId FROM @tbRoles)
    IF( @TranStarted = 1 )
        COMMIT TRANSACTION
    RETURN(0)
END</pre></div></div>

<p>So, as you can see it is pretty simple to use Visual Studio Team System 2008 Database Edition to perform static code analysis, the question is of course if you dare to run this against your own database?</p>
<p>I will be back with another post to explore some other things that this tool can do</p>
<p>*** <strong>Remember, if you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/running-static-code-analysis-on-sql-serv/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Failed to access IIS metabase or why it is important to do things in the correct order</title>
		<link>/index.php/webdev/webdesigngraphicsstyling/failed-to-access-iis-metabase-or-why-it/</link>
		<comments>/index.php/webdev/webdesigngraphicsstyling/failed-to-access-iis-metabase-or-why-it/#respond</comments>
		<pubDate>Thu, 04 Dec 2008 12:11:17 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Web Design, Graphics and Styling]]></category>
		<category><![CDATA[asp.net]]></category>
		<category><![CDATA[iis]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[visual studio 2008]]></category>

		<guid isPermaLink="false">/index.php/2008/12/failed-to-access-iis-metabase-or-why-it/</guid>
		<description><![CDATA[So yesterday I got a new machine at work. I decided to only install SQL Server 2008 and Visual Studio 2008 on this box. First I installed Visual Studio 2008, after that I installed Visual Studio 2008 Service Pack 1 and then I installed SQL Server 2008. I still remember when I tried to install [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>So yesterday I got a new machine at work. I decided to only install SQL Server 2008 and Visual Studio 2008 on this box. First I installed Visual Studio 2008, after that I installed Visual Studio 2008 Service Pack 1 and then I installed SQL Server 2008. I still remember when I tried to install SQL Server 2008 RTM on my older machine with Visual Studio 2008 and it wouldn&#8217;t do it because you needed SP1 for the framework first, this got released 2 days later or so.</p>
<p>So then I noticed that IIS was not installed on this box, of course you need the CD/DVD to add components to the Operating System. I went to MSDN, downloaded the Operating System, installed IIS and thought I was in business.</p>
<p>Do you see the problem yet?</p>
<p>I loaded up the website that runs on my machine and got the following message</p>
<p><strong>Failed to access IIS metabase</strong></p>
<p>Failed to access IIS metabase? What is that? Since I am lucky that I work with this Ukranian ASP.NET expert he told me to paste the following into the Run command from the Start menu</p>
<p><strong>%windir%Microsoft.NETFrameworkv2.0.50727aspnet_regiis.exe -i</strong></p>
<p>The version (v2.0.50727) might be different on your machine, it worked like a charm on mine.</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/webdev/webdesigngraphicsstyling/failed-to-access-iis-metabase-or-why-it/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
	</channel>
</rss>
