<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>triggers &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/triggers/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>SQL Advent 2012 Day 4: Triggers, what to do, what not to do</title>
		<link>/index.php/datamgmt/dbprogramming/triggers-what-to-do-what/</link>
		<comments>/index.php/datamgmt/dbprogramming/triggers-what-to-do-what/#comments</comments>
		<pubDate>Tue, 04 Dec 2012 10:04:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Business Intelligence]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[database]]></category>
		<category><![CDATA[ddl triggers]]></category>
		<category><![CDATA[dml triggers]]></category>
		<category><![CDATA[rdbms]]></category>
		<category><![CDATA[sql]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[sql server 2012]]></category>
		<category><![CDATA[t-sql]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2012/12/triggers-what-to-do-what/</guid>
		<description><![CDATA[This is day four of the SQL Advent 2012 series of blog posts. Today we are going to look at triggers. Triggers are a great way to keep your database in a consistent state. There are two types of triggers, DML triggers and DLL triggers. DML triggers  res&#8230;]]></description>
				<content:encoded><![CDATA[<p>This is day four of the <a href="/index.php/DataMgmt/DBProgramming/sql-advent-2012-here-is">SQL Advent 2012 series</a> of blog posts. Today we are going to look at triggers. Triggers are a great way to keep your database in a consistent state. There are two types of triggers, DML triggers and DLL triggers. DML triggers  respond to Data Manipulation Statements (Insert, Delete, Update) DDL triggers respond to Data Definition Language events. </p>
<p>Some things that DML triggers are used for:</p>
<ul>
<li>Keeps your databases from having wrong data by doing checks that can&#8217;t be handled with constraints</li>
<li>Filling in values that are not supplied and can&#8217;t be handled through default constraints since these don&#8217;t fire on updates </li>
<li>Calculation summary values and updates the summary table with that value</li>
<li>Used as a mechanism to maintain an audit trail for DML statements</li>
</ul>
<p>Some things that DDL triggers are used for:</p>
<ul>
<li>Automatically add columns to a table if they were not added, for example LastUpdated and InsertedBy columns</li>
<li>Notify a DBA when a database has been created, dropped or altered</li>
<li>Used as a mechanism to maintain an audit trail for DDL statements, capture every time an object has been created, dropped or altered and by who</li>
</ul>
<p>Most common mistake people make when first starting writing triggers is that they write it in such a way that it will only work if you insert/update/delete one row at a time. A trigger fires per batch not per row, you have to take this into consideration otherwise your DML statements will blow up. How to do this is explained in this post <a href="/index.php/DataMgmt/DBProgramming/MSSQLServer/best-practice-coding-sql-server-triggers">Best Practice: Coding SQL Server triggers for multi-row operations</a>, there is no point recreating that post here.</p>
<p>Another problem that I see is that some people think a trigger is SQL Server&#8217;s version of crontab, you will see code that sends email, kicks off jobs, runs stored procedures. This is the wrong approach, a trigger should be lean and mean, it should execute as fast as possible, if you need to do some additional things then dump some data from the trigger into a processing table and then use that table to do your additional tasks. Don&#8217;t use triggers as a messaging system either, SQL Server comes with Service Broker, use that instead. Triggers might look like hammers to some people but I guarantee you not everything is a nail&#8230;.</p>
<p>You could end up with a real difficult thing to debug, one trigger that kicks off other triggers, now have fun debugging the trigger hell you got yourself into&#8230;.or worse debug this mess if you inherited this&#8230;.this is like the GOTO spaghetti code of databases.</p>
<p>Since triggers work besides the scenes you might spend hours debugging something only to find out that a trigger modified the value</p>
<p>One thing I always find interesting is when someone sees two <em>n rows affected</em> statements when they only did one insert, you know a person like that has not been exposed to triggers yet</p>
<p>Some people will say that you don&#8217;t need triggers for anything and that they do more harm than good, I myself don&#8217;t agree with that, triggers have a place but they should not be abused and overused, the same can be said of views</p>
<p>What is your opinion, are triggers needed or are they not needed?</p>
<p>That is all for day four of the <a href="/index.php/DataMgmt/DBProgramming/sql-advent-2012-here-is">SQL Advent 2012 series</a>, come back tomorrow for the next one, you can also check out all the posts from last year here: <a href="/index.php/DataMgmt/DataDesign/sql-advent-2011-recap">SQL Advent 2011 Recap</a></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/dbprogramming/triggers-what-to-do-what/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>SQL Advent 2011 Day 13: DDL Triggers</title>
		<link>/index.php/datamgmt/datadesign/sql-advent-2011-day-13/</link>
		<comments>/index.php/datamgmt/datadesign/sql-advent-2011-day-13/#respond</comments>
		<pubDate>Tue, 13 Dec 2011 13:41:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[ddl triggers]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2011/12/sql-advent-2011-day-13/</guid>
		<description><![CDATA[Today we are going to take a look at DDL triggers. DDL triggers have Server or Database Scope, DDL triggers can fire in response to a T-SQL event processed in the current database, or on the current server.]]></description>
				<content:encoded><![CDATA[<p>In my <a href="/index.php/DataMgmt/DataDesign/are-you-ready-for-sql">Are you ready for SQL Server 2012 or are you still partying like it is 1999?</a> post, I wrote about how you should start using SQL Server 2005 and SQL Server 2008 functionality now in order to prepare for SQL Server 2012. I still see tons of code that is written in the pre 2005 style and people still keep using those functions, procs and statements even though SQL Server 2005 and 2008 have much better functionality.</p>
<p>Today we are going to take a look at DDL triggers. DDL triggers have Server or Database Scope, DDL triggers can fire in response to a T-SQL event processed in the current database, or on the current server. For example a CREATE_TABLE event can fire on a database level as well as on a server level, a DROP_DATABASE can only fire on the server level. DDL triggers can be a very powerful tool for auditing purposes as well.</p>
<p>Let&#8217;s take a quick look at a DDL trigger for a CREATE_TABLE event, this trigger will fire every time someone issues a CREATE TABLE T-SQL DDL statement</p>
<p>This trigger is created to capture all CREATE_TABLE events in the tempdb database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> tempdb
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> DBLevelsafety 
<span class="kw1">ON</span> <span class="kw1">DATABASE</span> 
<span class="kw1">FOR</span> CREATE_TABLE
<span class="kw1">AS</span> 
&nbsp; &nbsp;<span class="kw1">PRINT</span> <span class="st0">'You must disable Trigger &quot;DBLevelsafety&quot; to drop or alter tables!'</span> 
&nbsp; &nbsp;<span class="kw1">ROLLBACK</span>
;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE tempdb
GO

CREATE TRIGGER DBLevelsafety 
ON DATABASE 
FOR CREATE_TABLE
AS 
   PRINT 'You must disable Trigger "DBLevelsafety" to drop or alter tables!' 
   ROLLBACK
;</pre></div></div>

<p>If you try to create a table now in the tempdb database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> tempdb
GO
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> bla<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE tempdb
GO
CREATE TABLE bla(id int)</pre></div></div>

<p>You will get the following message</p>
<p><em>You must disable Trigger &#8220;DBLevelsafety&#8221; to drop or alter tables!<br />
Msg 3609, Level 16, State 2, Line 1<br />
The transaction ended in the trigger. The batch has been aborted.</em></p>
<p>Let&#8217;s drop the trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DROP</span> <span class="kw1">TRIGGER</span> DBLevelsafety</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DROP TRIGGER DBLevelsafety</pre></div></div>

<p><em>Msg 3701, Level 11, State 5, Line 1<br />
Cannot drop the trigger &#8216;DBLevelsafety&#8217;, because it does not exist or you do not have permission.</em></p>
<p>In order to drop a DDL trigger, the syntax is a little different from a DML trigger, you need to add ON DATABASE  or ON ALL SERVER after the name, Try it again</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DROP</span> <span class="kw1">TRIGGER</span> DBLevelsafety <span class="kw1">ON</span> <span class="kw1">DATABASE</span> </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DROP TRIGGER DBLevelsafety ON DATABASE </pre></div></div>

<p>Now create a DDL triggers that will fire in any database.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> ServerLevelsafety 
<span class="kw1">ON</span> <span class="sy0">ALL</span> SERVER 
<span class="kw1">FOR</span> CREATE_TABLE
<span class="kw1">AS</span> 
&nbsp; &nbsp;<span class="kw1">PRINT</span> <span class="st0">'You must disable Trigger &quot;ServerLevelsafety&quot; to drop or alter tables!'</span> 
&nbsp; &nbsp;<span class="kw1">ROLLBACK</span>
;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TRIGGER ServerLevelsafety 
ON ALL SERVER 
FOR CREATE_TABLE
AS 
   PRINT 'You must disable Trigger "ServerLevelsafety" to drop or alter tables!' 
   ROLLBACK
;</pre></div></div>

<p>Go into the model database and try to create a table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> model
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> temp<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE model
GO

CREATE TABLE temp(id int)</pre></div></div>

<p><em>You must disable Trigger &#8220;ServerLevelsafety&#8221; to drop or alter tables!<br />
Msg 3609, Level 16, State 2, Line 2<br />
The transaction ended in the trigger. The batch has been aborted.</em></p>
<p>Now switch to tempdb and see if you can create a table there</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> tempdb
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> temp<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE tempdb
GO

CREATE TABLE temp(id int)</pre></div></div>

<p><em>You must disable Trigger &#8220;ServerLevelsafety&#8221; to drop or alter tables!<br />
Msg 3609, Level 16, State 2, Line 2<br />
The transaction ended in the trigger. The batch has been aborted.</em></p>
<p>Nope, as you can see you can&#8217;t create a table in any database<br />
Drop the trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DROP</span> <span class="kw1">TRIGGER</span> ServerLevelsafety <span class="kw1">ON</span> <span class="sy0">ALL</span> SERVER </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DROP TRIGGER ServerLevelsafety ON ALL SERVER </pre></div></div>

<p>Verify that you can indeed create a table again</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> tempdb
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> temp<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE tempdb
GO

CREATE TABLE temp(id int)</pre></div></div>

<p>Let&#8217;s take a look at another example. What if you want to log anytime someone issues a DROP TABLE command in any database? You can easily accomplish that, and by using the EVENTDATA function you can capture the exact command that was used.</p>
<p>First create a new database with one table, this table will be used to store the messages from the trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> Logs
GO
&nbsp;
<span class="kw1">USE</span> Logs
GO
&nbsp;
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> TriggerLog<span class="br0">&#40;</span>DDL <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">300</span><span class="br0">&#41;</span>,DatabaseName <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>,ExecutedBy <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, EventDate <span class="kw1">DATETIME</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE Logs
GO

USE Logs
GO

CREATE TABLE TriggerLog(DDL VARCHAR(300),DatabaseName VARCHAR(100),ExecutedBy VARCHAR(100), EventDate DATETIME)
GO</pre></div></div>

<p>Create the following trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> trDropTable
<span class="kw1">ON</span> <span class="sy0">ALL</span> SERVER <span class="co1">-- A server level trigger</span>
<span class="kw1">FOR</span> DROP_TABLE <span class="co1">--Event we want to capture</span>
<span class="kw1">AS</span>
&nbsp; <span class="kw1">INSERT</span> tempdb..<span class="me1">TriggerLog</span>
&nbsp; <span class="kw1">SELECT</span> EVENTDATA<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]'</span>,<span class="st0">'nvarchar(max)'</span><span class="br0">&#41;</span>, <span class="co1">-- T-SQL command</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;EVENTDATA<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'(/EVENT_INSTANCE/DatabaseName)[1]'</span>,<span class="st0">'nvarchar(max)'</span><span class="br0">&#41;</span>, &nbsp;<span class="co1">-- database name</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUSER_SNAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,<span class="kw2">USER_NAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TRIGGER trDropTable
ON ALL SERVER -- A server level trigger
FOR DROP_TABLE --Event we want to capture
AS
  INSERT tempdb..TriggerLog
  SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)'), -- T-SQL command
		 EVENTDATA().value('(/EVENT_INSTANCE/DatabaseName)[1]','nvarchar(max)'),  -- database name
        COALESCE(SUSER_SNAME(),USER_NAME()),
        GETDATE();
GO</pre></div></div>

<p>The EVENT_INSTANCE/TSQLCommand/CommandText part of EVENTDATA will give us the actual command that was executed, the /EVENT_INSTANCE/DatabaseName part will give use the database name.</p>
<p>It is time to take it for a test, run the following block of code</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="de1"><pre class="de1"><span class="kw1">USE</span> Tempdb
GO
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> bla<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span>
GO
<span class="kw1">DROP</span> <span class="kw1">TABLE</span> bla
&nbsp;
<span class="kw1">USE</span> model
GO
<span class="kw1">CREATE</span> <span class="kw1">TABLE</span> bla<span class="br0">&#40;</span>id <span class="kw1">int</span><span class="br0">&#41;</span>
GO
<span class="kw1">DROP</span> <span class="kw1">TABLE</span> bla</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">USE Tempdb
GO
CREATE TABLE bla(id int)
GO
DROP TABLE bla

USE model
GO
CREATE TABLE bla(id int)
GO
DROP TABLE bla</pre></div></div>

<p>Now if you look in your TriggerLog table, you will see 2 rows</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> Logs..<span class="me1">TriggerLog</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT * FROM Logs..TriggerLog</pre></div></div>

<p>As you can see we have the two rows, since we grab the database name as well we can see what database it was run in in case you have the same table name in multiple databases</p>
<pre>DDL	        DatabaseName	ExecutedBy	EventDate
--------------  -------------   --------------- ------------------------
DROP TABLE bla	tempdb          Denis-PCDenis	2011-12-12 20:47:23.607
DROP TABLE bla	model           Denis-PCDenis	2011-12-12 20:47:23.780</pre>
<p>Also take a look at my post <a href="/index.php/DataMgmt/DBProgramming/MSSQLServer/use-ddl-triggers-to-track">Use DDL Triggers To Track Table Changes</a> to learn how you can capture all the DDL changes that were applied to a table over time&#8230;.powerful stuff!</p>
<p>I just scratched the surface with what you can do with DDL triggers, below is a list of all the events that you can create your trigger for.</p>
<h2>DDL Statements That Have Server or Database Scope</h2>
<p></p>
<div class="tables">
<table>
<tr>
<th>DDL Events</th>
<th>DDL Events</th>
<th>DDL Events</th>
</tr>
<tr>
<td>
<p>CREATE_APPLICATION_ROLE (Applies to the CREATE APPLICATION ROLE statement and <strong>sp_addapprole</strong>. If a new schema is created, this event also triggers a CREATE_SCHEMA event.)</p>
</td>
<td>
<p>ALTER_APPLICATION_ROLE (Applies to the ALTER APPLICATION ROLE statement and <strong>sp_approlepassword</strong>.)</p>
</td>
<td>
<p>DROP_APPLICATION_ROLE (Applies to the DROP APPLICATION ROLE statement and <strong>sp_dropapprole</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_ASSEMBLY</p>
</td>
<td>
<p>ALTER_ASSEMBLY</p>
</td>
<td>
<p>DROP_ASSEMBLY</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_ASYMMETRIC_KEY</p>
</td>
<td>
<p>ALTER_ASYMMETRIC_KEY</p>
</td>
<td>
<p>DROP_ASYMMETRIC_KEY</p>
</td>
</tr>
<tr>
<td>
<p>ALTER_AUTHORIZATION</p>
</td>
<td>
<p>ALTER_AUTHORIZATION_DATABASE (Applies to the ALTER AUTHORIZATION statement when ON DATABASE is specified, and <strong>sp_changedbowner</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_BROKER_PRIORITY</p>
</td>
<td>
<p>ALTER_BROKER_PRIORITY</p>
</td>
<td>
<p>DROP_BROKER_PRIORITY</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_CERTIFICATE</p>
</td>
<td>
<p>ALTER_CERTIFICATE</p>
</td>
<td>
<p>DROP_CERTIFICATE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_CONTRACT</p>
</td>
<td>
<p>DROP_CONTRACT</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>ADD_COUNTER_SIGNATURE</p>
</td>
<td>
<p>DROP_COUNTER_SIGNATURE</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_CREDENTIAL</p>
</td>
<td>
<p>ALTER_CREDENTIAL</p>
</td>
<td>
<p>DROP_CREDENTIAL</p>
</td>
</tr>
<tr>
<td>
<p>GRANT_DATABASE</p>
</td>
<td>
<p>DENY_DATABASE</p>
</td>
<td>
<p>REVOKE_DATABASE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_DATABASE_AUDIT_SPEFICIATION</p>
</td>
<td>
<p>ALTER_DATABASE_AUDIT_SPEFICIATION</p>
</td>
<td>
<p>DENY_DATABASE_AUDIT_SPEFICIATION</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_DATABASE_ENCRYPTION_KEY</p>
</td>
<td>
<p>ALTER_DATABASE_ENCRYPTION_KEY</p>
</td>
<td>
<p>DROP_DATABASE_ENCRYPTION_KEY</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_DEFAULT</p>
</td>
<td>
<p>DROP_DEFAULT</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>BIND_DEFAULT (Applies to <strong>sp_bindefault</strong>.)</p>
</td>
<td>
<p>UNBIND_DEFAULT (Applies to <strong>sp_unbindefault</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_EVENT_NOTIFICATION</p>
</td>
<td>
<p>DROP_EVENT_NOTIFICATION</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_EXTENDED_PROPERTY (Applies to <strong>sp_addextendedproperty</strong>.)</p>
</td>
<td>
<p>ALTER_EXTENDED_PROPERTY (Applies to <strong>sp_updateextendedproperty</strong>.)</p>
</td>
<td>
<p>DROP_EXTENDED_PROPERTY (Applies to <strong>sp_dropextendedproperty</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_FULLTEXT_CATALOG (Applies to the CREATE FULLTEXT CATALOG statement and <strong>sp_fulltextcatalog</strong> when <span class="parameter">create</span> is specified.) </p>
</td>
<td>
<p>ALTER_FULLTEXT_CATALOG (Applies to the ALTER FULLTEXT CATALOG statement, <strong>sp_fulltextcatalog</strong> when <span class="parameter">start_incremental</span>, <span class="parameter">start_full</span>, <span class="parameter">Stop</span>, or <span class="parameter">Rebuild</span> is specified, and <strong>sp_fulltext_database</strong> when <span class="parameter">enable</span> is specified.)</p>
</td>
<td>
<p>DROP_FULLTEXT_CATALOG (Applies to the DROP FULLTEXT CATALOG statement and <strong>sp_fulltextcatalog</strong> when <span class="parameter">drop</span> is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_FULLTEXT_INDEX (Applies to the CREATE FULLTEXT INDEX statement and <strong>sp_fulltexttable</strong> when <span class="parameter">create</span> is specified.)</p>
</td>
<td>
<p>ALTER_FULLTEXT_INDEX (Applies to the ALTER FULLTEXT INDEX statement, <strong>sp_fulltextcatalog</strong> when <span class="parameter">start_full</span>, <span class="parameter">start_incremental</span>, or <span class="parameter">stop</span> is specified, <strong>sp_fulltext_column</strong>, and <strong>sp_fulltext_table</strong> when any action other than <span class="parameter">create</span> or <span class="parameter">drop</span> is specified.)</p>
</td>
<td>
<p>DROP_FULLTEXT_INDEX (Applies to the DROP FULLTEXT INDEX statement and <strong>sp_fulltexttable</strong> when <span class="parameter">drop</span> is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_FULLTEXT_STOPLIST</p>
</td>
<td>
<p>ALTER_FULLTEXT_STOPLIST</p>
</td>
<td>
<p>DROP_FULLTEXT_STOPLIST</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_FUNCTION</p>
</td>
<td>
<p>ALTER_FUNCTION</p>
</td>
<td>
<p>DROP_FUNCTION</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_INDEX</p>
</td>
<td>
<p>ALTER_INDEX (Applies to the ALTER INDEX statement and <strong>sp_indexoption</strong>.)</p>
</td>
<td>
<p>DROP_INDEX</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_MASTER_KEY</p>
</td>
<td>
<p>ALTER_MASTER_KEY</p>
</td>
<td>
<p>DROP_MASTER_KEY</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_MESSAGE_TYPE</p>
</td>
<td>
<p>ALTER_MESSAGE_TYPE</p>
</td>
<td>
<p>DROP_MESSAGE_TYPE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_PARTITION_FUNCTION</p>
</td>
<td>
<p>ALTER_PARTITION_FUNCTION</p>
</td>
<td>
<p>DROP_PARTITION_FUNCTION</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_PARTITION_SCHEME</p>
</td>
<td>
<p>ALTER_PARTITION_SCHEME</p>
</td>
<td>
<p>DROP_PARTITION_SCHEME</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_PLAN_GUIDE (Applies to <strong>sp_create_plan_guide</strong>.)</p>
</td>
<td>
<p>ALTER_PLAN_GUIDE (Applies to <strong>sp_control_plan_guide</strong> when ENABLE, ENABLE ALL, DISABLE, or DISABLE ALL is specified.)</p>
</td>
<td>
<p>DROP_PLAN_GUIDE (Applies to <strong>sp_control_plan_guide</strong> when DROP or DROP ALL is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_PROCEDURE</p>
</td>
<td>
<p>ALTER_PROCEDURE (Applies to the ALTER PROCEDURE statement and <strong>sp_procoption</strong>.)</p>
</td>
<td>
<p>DROP_PROCEDURE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_QUEUE</p>
</td>
<td>
<p>ALTER_QUEUE</p>
</td>
<td>
<p>DROP_QUEUE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_REMOTE_SERVICE_BINDING</p>
</td>
<td>
<p>ALTER_REMOTE_SERVICE_BINDING</p>
</td>
<td>
<p>DROP_REMOTE_SERVICE_BINDING</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_SPATIAL_INDEX</p>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>RENAME (Applies to <strong>sp_rename</strong>)</p>
</td>
<td>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_ROLE (Applies to the CREATE ROLE statement, <strong>sp_addrole</strong>, and <strong>sp_addgroup</strong>.)</p>
</td>
<td>
<p>ALTER_ROLE</p>
</td>
<td>
<p>DROP_ROLE (Applies to the DROP ROLE statement, <strong>sp_droprole</strong>, and <strong>sp_dropgroup</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>ADD_ROLE_MEMBER</p>
</td>
<td>
<p>DROP_ROLE_MEMBER</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_ROUTE</p>
</td>
<td>
<p>ALTER_ROUTE</p>
</td>
<td>
<p>DROP_ROUTE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_RULE</p>
</td>
<td>
<p>DROP_RULE</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>BIND_RULE (Applies to <strong>sp_bindrule</strong>.)</p>
</td>
<td>
<p>UNBIND_RULE (Applies to <strong>sp_unbindrule</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_SCHEMA (Applies to the CREATE SCHEMA statement, <strong>sp_addrole</strong>, <strong>sp_adduser</strong>, <strong>sp_addgroup</strong>, and <strong>sp_grantdbaccess</strong>.)</p>
</td>
<td>
<p>ALTER_SCHEMA (Applies to the ALTER SCHEMA statement and <strong>sp_changeobjectowner</strong>.)</p>
</td>
<td>
<p>DROP_SCHEMA</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_SERVICE</p>
</td>
<td>
<p>ALTER_SERVICE</p>
</td>
<td>
<p>DROP_SERVICE</p>
</td>
</tr>
<tr>
<td>
<p>ALTER_SERVICE_MASTER_KEY</p>
</td>
<td>
<p>BACKUP_SERVICE_MASTER_KEY</p>
</td>
<td>
<p>RESTORE_SERVICE_MASTER_KEY</p>
</td>
</tr>
<tr>
<td>
<p>ADD_SIGNATURE</p>
</td>
<td>
<p>DROP_SIGNATURE</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_SPATIAL_INDEX</p>
</td>
<td>
<p>ALTER_INDEX can be used for spatial indexes.</p>
</td>
<td>
<p>DROP_INDEX can be used for spatial indexes.</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_STATISTICS</p>
</td>
<td>
<p>DROP_STATISTICS</p>
</td>
<td>
<p>UPDATE_STATISTICS</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_SYMMETRIC_KEY</p>
</td>
<td>
<p>ALTER_SYMMETRIC_KEY</p>
</td>
<td>
<p>DROP_SYMMETRIC_KEY</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_SYNONYM</p>
</td>
<td>
<p>DROP_SYNONYM</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_TABLE</p>
</td>
<td>
<p>ALTER_TABLE (Applies to the ALTER TABLE statement and <strong>sp_tableoption</strong>.)</p>
</td>
<td>
<p>DROP_TABLE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_TRIGGER</p>
</td>
<td>
<p>ALTER_TRIGGER (Applies to the ALTER TRIGGER statement and <strong>sp_settriggerorder</strong>.)</p>
</td>
<td>
<p>DROP_TRIGGER</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_TYPE (Applies to the CREATE TYPE statement and <strong>sp_addtype</strong>.)</p>
</td>
<td>
<p>DROP_TYPE (Applies to the DROP TYPE statement and <strong>sp_droptype</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_USER (Applies to the CREATE USER statement, <strong>sp_adduser</strong>, and <strong>sp_grantdbaccess</strong>.)</p>
</td>
<td>
<p>ALTER_USER (Applies to ALTER USER statement and <strong>sp_change_users_login</strong>.)</p>
</td>
<td>
<p>DROP_USER (Applies to the DROP USER statement, <strong>sp_dropuser</strong>, and <strong>sp_revokedbaccess</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_VIEW</p>
</td>
<td>
<p>ALTER_VIEW</p>
</td>
<td>
<p>DROP_VIEW</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_XML_INDEX</p>
</td>
<td>
<p>ALTER_INDEX can be used for XML indexes.</p>
</td>
<td>
<p>DROP_INDEX can be used for XML indexes.</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_XML_SCHEMA_COLLECTION</p>
</td>
<td>
<p>ALTER_XML_SCHEMA_COLLECTION</p>
</td>
<td>
<p>DROP_XML_SCHEMA_COLLECTION</p>
</td>
</tr>
</table>
</div>
<h2>DDL Statements That Have Server Scope</h2>
<p></p>
<div class="tables">
<table>
<tr>
<th>DDL Events</th>
<th>DDL Events</th>
<th>DDL Events</th>
</tr>
<tr>
<td>
<p>ALTER_AUTHORIZATION_SERVER</p>
</td>
<td>
<p>ALTER_SERVER_CONFIGURATION</p>
</td>
<td>
<p>ALTER_INSTANCE (Applies to <strong>sp_configure</strong> and <strong>sp_addserver</strong> when a local server instance is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_CREDENTIAL</p>
</td>
<td>
<p>ALTER_CREDENTIAL</p>
</td>
<td>
<p>DROP_CREDENTIAL</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_CRYPTOGRAPHIC_PROVIDER</p>
</td>
<td>
<p>ALTER_CRYPTOGRAPHIC_PROVIDER</p>
</td>
<td>
<p>DROP_CRYPTOGRAPHIC_PROVIDER</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_DATABASE</p>
</td>
<td>
<p>ALTER_DATABASE (Applies to the ALTER DATABASE statement and <strong>sp_fulltext_database</strong>.)</p>
</td>
<td>
<p>DROP_DATABASE</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_ENDPOINT</p>
</td>
<td>
<p>ALTER_ENDPOINT</p>
</td>
<td>
<p>DROP_ENDPOINT</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_EVENT_SESSION</p>
</td>
<td>
<p>ALTER_EVENT_SESSION</p>
</td>
<td>
<p>DROP_EVENT_SESSION</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_EXTENDED_PROCEDURE (Applies to <strong>sp_addextendedproc</strong>.)</p>
</td>
<td>
<p>DROP_EXTENDED_PROCEDURE (Applies to <strong>sp_dropextendedproc</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_LINKED_SERVER (Applies to <strong>sp_addlinkedserver</strong>.)</p>
</td>
<td>
<p>ALTER_LINKED_SERVER (Applies to <strong>sp_serveroption</strong>.)</p>
</td>
<td>
<p>DROP_LINKED_SERVER (Applies to <strong>sp_dropserver</strong> when a linked server is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_LINKED_SERVER_LOGIN (Applies to <strong>sp_addlinkedsrvlogin</strong>.)</p>
</td>
<td>
<p>DROP_LINKED_SERVER_LOGIN (Applies to <strong>sp_droplinkedsrvlogin</strong>.)</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_LOGIN (Applies to the CREATE LOGIN statement, <strong>sp_addlogin</strong>, <strong>sp_grantlogin</strong>, <strong>xp_grantlogin</strong>, and <strong>sp_denylogin</strong> when used on a nonexistent login that must be implicitly created.)</p>
</td>
<td>
<p>ALTER_LOGIN (Applies to the ALTER LOGIN statement, <strong>sp_defaultdb</strong>, <strong>sp_defaultlanguage</strong>, <strong>sp_password</strong>, and <strong>sp_change_users_login</strong> when <span class="parameter">Auto_Fix</span> is specified.)</p>
</td>
<td>
<p>DROP_LOGIN (Applies to the DROP LOGIN statement, <strong>sp_droplogin</strong>, <strong>sp_revokelogin</strong>, and <strong>xp_revokelogin</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_MESSAGE (Applies to <strong>sp_addmessage</strong>.)</p>
</td>
<td>
<p>ALTER_MESSAGE (Applies to <strong>sp_altermessage</strong>.)</p>
</td>
<td>
<p>DROP_MESSAGE (Applies to <strong>sp_dropmessage</strong>.)</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_REMOTE_SERVER (Applies to <strong>sp_addserver</strong>.)</p>
</td>
<td>
<p>ALTER_REMOTE_SERVER (Applies to <strong>sp_setnetname</strong>.)</p>
</td>
<td>
<p>DROP_REMOTE_SERVER (Applies to <strong>sp_dropserver</strong> when a remote server is specified.)</p>
</td>
</tr>
<tr>
<td>
<p>GRANT_SERVER</p>
</td>
<td>
<p>DENY_SERVER</p>
</td>
<td>
<p>REVOKE_SERVER</p>
</td>
</tr>
<tr>
<td>
<p>ADD_SERVER_ROLE_MEMBER</p>
</td>
<td>
<p>DROP_SERVER_ROLE_MEMBER</p>
</td>
<td>
</td>
</tr>
<tr>
<td>
<p>CREATE_SERVER_AUDIT</p>
</td>
<td>
<p>ALTER_SERVER_AUDIT</p>
</td>
<td>
<p>DROP_SERVER_AUDIT</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_SERVER_AUDIT_SPECIFICATION</p>
</td>
<td>
<p>ALTER_SERVER_AUDIT_SPECIFICATION</p>
</td>
<td>
<p>DROP_SERVER_AUDIT_SPECIFICATION</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_RESOURCE_POOL</p>
</td>
<td>
<p>ALTER_RESOURCE_POOL</p>
</td>
<td>
<p>DROP_RESOURCE_POOL</p>
</td>
</tr>
<tr>
<td>
<p>CREATE_WORKLOAD_GROUP</p>
</td>
<td>
<p>CREATE_WORKLOAD_GROUP</p>
</td>
<td>
<p>CREATE_WORKLOAD_GROUP</p>
</td>
</tr>
</table>
</div>
<p>Come back tomorrow for the next post in this series</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/sql-advent-2011-day-13/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>Raise your hand if you have seen code that sends email from within a trigger in SQL Server</title>
		<link>/index.php/datamgmt/datadesign/raise-your-hand-if-you/</link>
		<comments>/index.php/datamgmt/datadesign/raise-your-hand-if-you/#comments</comments>
		<pubDate>Wed, 11 May 2011 11:19:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[mail]]></category>
		<category><![CDATA[pitfalls]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2011/05/raise-your-hand-if-you/</guid>
		<description><![CDATA[Please leave me a comment if you have written or have seen a trigger that is written in such a way that it will send an email when a value changes in a table.

I am looking at the following question: Email trigger when data is changed

ALTER TRIGGER&#8230;]]></description>
				<content:encoded><![CDATA[<p>Please leave me a comment if you have written or have seen a trigger that is written in such a way that it will send an email when a value changes in a table.</p>
<p>I am looking at the following question: <a href="http://stackoverflow.com/questions/5964495/email-trigger-when-data-is-changed">Email trigger when data is changed</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TRIGGER</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>RVABestellingenAantalWijzigenTrigger<span class="br0">&#93;</span>
<span class="kw1">ON</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>RVA_Bestellingen<span class="br0">&#93;</span> &nbsp;
<span class="kw1">AFTER</span> <span class="kw1">UPDATE</span>
<span class="kw1">AS</span>
<span class="co1">--Vars</span>
<span class="kw1">DECLARE</span> @body <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">500</span><span class="br0">&#41;</span>
<span class="kw1">DECLARE</span> @BestellingID <span class="kw1">int</span>
<span class="kw1">DECLARE</span> @CategorieID <span class="kw1">int</span>
<span class="kw1">DECLARE</span> @SubCategorieID <span class="kw1">int</span>
<span class="kw1">DECLARE</span> @AantalOrigineel <span class="kw1">int</span>
<span class="kw1">DECLARE</span> @AantalNieuw <span class="kw1">int</span>
<span class="kw1">DECLARE</span> @LocatieNaam <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>
<span class="kw1">DECLARE</span> @ComponentNaam <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>
<span class="kw1">DECLARE</span> @CategorieNaam <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>
<span class="kw1">DECLARE</span> @SubCategorieNaam <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>
<span class="kw1">DECLARE</span> @Datum <span class="kw1">datetime</span>
&nbsp;
<span class="kw1">if</span> <span class="kw1">update</span><span class="br0">&#40;</span>Aantal<span class="br0">&#41;</span> <span class="coMULTI">/*and (SELECT Datum FROM inserted) = cast(floor(cast(dateadd(day,1,getdate()) as float)) as datetime) &nbsp;*/</span> and &nbsp; <span class="br0">&#40;</span><span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span>,<span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,<span class="nu0">108</span><span class="br0">&#41;</span><span class="sy0">&gt;</span><span class="st0">'11:00'</span><span class="br0">&#41;</span>
<span class="kw1">begin</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">--Zetten aantallen</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @AantalOrigineel &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> Aantal <span class="kw1">FROM</span> deleted<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @AantalNieuw &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> Aantal <span class="kw1">FROM</span> inserted<span class="br0">&#41;</span> 
&nbsp; &nbsp; <span class="kw1">SET</span> @BestellingID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> BestellingID <span class="kw1">FROM</span> inserted<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @CategorieID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> CategorieID <span class="kw1">FROM</span> inserted<span class="br0">&#41;</span> &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">SET</span> @SubCategorieID &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> SubCategorieID <span class="kw1">FROM</span> inserted<span class="br0">&#41;</span> 
&nbsp;
&nbsp; &nbsp; <span class="co1">--Zetten locatienaam en componentnaam</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @LocatieNaam <span class="sy0">=</span> <span class="br0">&#40;</span><span class="st0">'RVA Aanpassingen Locatie: '</span><span class="sy0">+</span>LocatieNaam<span class="br0">&#41;</span>, @ComponentNaam<span class="sy0">=</span>OfficieleNaam, @Datum<span class="sy0">=</span>Datum
&nbsp; &nbsp; <span class="kw1">FROM</span> RVA_Bestellingen r
&nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">OUTER</span> <span class="sy0">JOIN</span> Locaties l <span class="kw1">on</span> l.<span class="me1">LocatieID</span> <span class="sy0">=</span> r.<span class="me1">LocatieID</span>
&nbsp; &nbsp; <span class="kw1">LEFT</span> <span class="sy0">OUTER</span> <span class="sy0">JOIN</span> Componenten c <span class="kw1">on</span> c.<span class="me1">ComponentID</span> <span class="sy0">=</span> r.<span class="me1">ComponentID</span>
&nbsp; &nbsp; <span class="kw1">WHERE</span> r.<span class="me1">BestellingID</span> <span class="sy0">=</span> @BestellingID &nbsp; &nbsp;
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">SELECT</span> @CategorieNaam <span class="sy0">=</span> Categorie
&nbsp; &nbsp; <span class="kw1">FROM</span> RVA_HoofdCategorie
&nbsp; &nbsp; <span class="kw1">WHERE</span> HoofdCategorieID <span class="sy0">=</span> @CategorieID &nbsp; 
&nbsp;
&nbsp; &nbsp; <span class="kw1">SELECT</span> @SubCategorieNaam <span class="sy0">=</span> Categorie
&nbsp; &nbsp; <span class="kw1">FROM</span> dbo.<span class="me1">RVA_SubCategorie</span>
&nbsp; &nbsp; <span class="kw1">WHERE</span> SubCategorieID <span class="sy0">=</span> @SubCategorieID &nbsp; &nbsp; &nbsp;
&nbsp;
&nbsp; &nbsp; <span class="co1">--Zet boyd</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @body <span class="sy0">=</span> <span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="st0">'HoofdCategorie: '</span> <span class="sy0">+</span> @CategorieNaam<span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span><span class="st0">'SubCategorie: '</span> <span class="sy0">+</span> @SubCategorieNaam<span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="st0">'Componentnaam: '</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> @ComponentNaam <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="st0">'Origineel aantal: '</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span>@AantalOrigineel <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="st0">'Nieuw aantal: '</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="kw1">CAST</span><span class="br0">&#40;</span>@AantalNieuw <span class="kw1">as</span> <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> <span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">13</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="st0">'Leverdatum: '</span> <span class="sy0">+</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">+</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span>,@Datum,<span class="nu0">105</span><span class="br0">&#41;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#41;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">--Mailen naar Adeline</span>
&nbsp; &nbsp; &nbsp;<span class="kw1">EXEC</span> master..<span class="kw3">xp_sendmail</span> 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @recipients <span class="sy0">=</span> <span class="st0">'fake@fake.fake'</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @message &nbsp; &nbsp;<span class="sy0">=</span> @body, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @subject &nbsp; &nbsp;<span class="sy0">=</span> @LocatieNaam
<span class="kw1">end</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TRIGGER [dbo].[RVABestellingenAantalWijzigenTrigger]
ON [dbo].[RVA_Bestellingen]  
AFTER UPDATE
AS
--Vars
DECLARE @body varchar(500)
DECLARE @BestellingID int
DECLARE @CategorieID int
DECLARE @SubCategorieID int
DECLARE @AantalOrigineel int
DECLARE @AantalNieuw int
DECLARE @LocatieNaam varchar(255)
DECLARE @ComponentNaam varchar(255)
DECLARE @CategorieNaam varchar(255)
DECLARE @SubCategorieNaam varchar(255)
DECLARE @Datum datetime

if update(Aantal) /*and (SELECT Datum FROM inserted) = cast(floor(cast(dateadd(day,1,getdate()) as float)) as datetime)  */ and   (convert(varchar,getdate(),108)&gt;'11:00')
begin

    --Zetten aantallen
    SET @AantalOrigineel            = (SELECT Aantal FROM deleted)
    SET @AantalNieuw                = (SELECT Aantal FROM inserted) 
    SET @BestellingID               = (SELECT BestellingID FROM inserted)
    SET @CategorieID                = (SELECT CategorieID FROM inserted)    
    SET @SubCategorieID             = (SELECT SubCategorieID FROM inserted) 

    --Zetten locatienaam en componentnaam
    SELECT @LocatieNaam = ('RVA Aanpassingen Locatie: '+LocatieNaam), @ComponentNaam=OfficieleNaam, @Datum=Datum
    FROM RVA_Bestellingen r
    LEFT OUTER JOIN Locaties l on l.LocatieID = r.LocatieID
    LEFT OUTER JOIN Componenten c on c.ComponentID = r.ComponentID
    WHERE r.BestellingID = @BestellingID    


    SELECT @CategorieNaam = Categorie
    FROM RVA_HoofdCategorie
    WHERE HoofdCategorieID = @CategorieID   

    SELECT @SubCategorieNaam = Categorie
    FROM dbo.RVA_SubCategorie
    WHERE SubCategorieID = @SubCategorieID      

    --Zet boyd
    SET @body = (
                    SELECT 
                        'HoofdCategorie: ' + @CategorieNaam+ char(10)+char(13)
                        +'SubCategorie: ' + @SubCategorieNaam+ char(10)+char(13)
                        + 'Componentnaam: '
                        + @ComponentNaam + char(10)+char(13)
                        + 'Origineel aantal: '
                        + CAST(@AantalOrigineel as varchar(50) ) + char(10)+char(13)
                        + 'Nieuw aantal: '
                        + CAST(@AantalNieuw as varchar(50) ) + char(10)+char(13)
                        + 'Leverdatum: ' +
                        + convert(varchar(50),@Datum,105)                       
                )

    --Mailen naar Adeline
     EXEC master..xp_sendmail 
            @recipients = 'fake@fake.fake', 
            @message    = @body, 
            @subject    = @LocatieNaam
end</pre></div></div>

<p>And I am just shaking my head, for one it doesn&#8217;t take into account muliple rows being updated, see <a href="/index.php/DataMgmt/DBProgramming/MSSQLServer/best-practice-coding-sql-server-triggers">Best Practice: Coding SQL Server triggers for multi-row operations</a> for more on that topic</p>
<p>The second bad thing is of course that you want your trigger to complete as fast as possible, you don&#8217;t want it to email a bunch of people. What if the email blows up?<br />
Ideally you would write a query inside the trigger that dumps the desired results into another table, then you would have a job that checks that table every minute or so and does the emailing.</p>
<p>Now I admit, I have written a trigger in the past that emailed when something got inserted, this was a table that would interact with Great <del>Pains</del> Plains. Once we decided to insert nine thousand rows as a stress test from a batch, and yes we brought down the whole exchange server, the email went out to I believe 20 people, this was the time of 3 MB inboxes  <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>Lastly this person is on SQL Server 2008 and is still using xp_sendmail and not sp_send_dbmail</p>
<p>Enough ranting, leave me a comment if you do send emails from withing triggers. If you do so, did you ever have any problems with it?</p>
<p>*** <strong>If you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/raise-your-hand-if-you/feed/</wfw:commentRss>
		<slash:comments>9</slash:comments>
		</item>
		<item>
		<title>Match your defaults with your trigger values to prevent horrible fragmentation on your indexes and tables</title>
		<link>/index.php/datamgmt/datadesign/match-your-defaults-with-your/</link>
		<comments>/index.php/datamgmt/datadesign/match-your-defaults-with-your/#comments</comments>
		<pubDate>Fri, 06 May 2011 13:47:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[pitfalls]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2011/05/match-your-defaults-with-your/</guid>
		<description><![CDATA[Here is a quick demonstration that shows you what can happen when you use defaults that are much shorter than the value that is updated from an insert trigger. The ModifiedBy  column has a default of '' but in the trigger it gets updated to 'Someapplica&#8230;]]></description>
				<content:encoded><![CDATA[<p>Here is a quick demonstration that shows you what can happen when you use defaults that are much shorter than the value that is updated from an insert trigger. The ModifiedBy  column has a default of &#8221; but in the trigger it gets updated to &#8216;SomeapplicationName used by &#8216; +SUSER_NAME(). Ideally you want the default to also be &#8216;SomeapplicationName used by &#8216; +SUSER_NAME()</p>
<p>Let&#8217;s take a look, first create the following table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> TestFrag <span class="br0">&#40;</span>
&nbsp; &nbsp; id <span class="kw1">INT</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">IDENTITY</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>, 
&nbsp; &nbsp; SomeData <span class="kw1">UNIQUEIDENTIFIER</span> <span class="kw1">DEFAULT</span> newsequentialid<span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; Somedate <span class="kw1">datetime</span> <span class="kw1">DEFAULT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; SomeOtherData <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">200</span><span class="br0">&#41;</span> <span class="kw1">DEFAULT</span> <span class="st0">'bla'</span>,
&nbsp; &nbsp; ModifiedBy <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="kw1">DEFAULT</span> <span class="st0">''</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE TestFrag (
	id INT NOT NULL IDENTITY PRIMARY KEY, 
	SomeData UNIQUEIDENTIFIER DEFAULT newsequentialid(),
	Somedate datetime DEFAULT GETDATE(),
	SomeOtherData CHAR(200) DEFAULT 'bla',
	ModifiedBy varchar(100) DEFAULT '')</pre></div></div>

<p>Add a trigger on that table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Tr_TestFrag<span class="br0">&#93;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>TestFrag<span class="br0">&#93;</span> <span class="kw1">FOR</span> <span class="kw1">Insert</span> 
<span class="kw1">AS</span>
<span class="kw1">UPDATE</span> t
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> &nbsp; &nbsp;ModifiedBy <span class="sy0">=</span> <span class="st0">'SomeapplicationName used by '</span> <span class="sy0">+</span>SUSER_NAME<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; TestFrag t
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">JOIN</span> inserted i <span class="kw1">ON</span> t.<span class="me1">id</span> <span class="sy0">=</span> i.<span class="me1">id</span>
&nbsp; &nbsp; &nbsp; &nbsp;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TRIGGER [dbo].[Tr_TestFrag] ON [dbo].[TestFrag] FOR Insert 
AS
UPDATE t
        SET    ModifiedBy = 'SomeapplicationName used by ' +SUSER_NAME()
        FROM   TestFrag t
        JOIN inserted i ON t.id = i.id
       
GO</pre></div></div>

<p>Now add another identical table, the only difference is that the default matches what gets updated from within the trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> TestFrag2 <span class="br0">&#40;</span>
&nbsp; &nbsp; id <span class="kw1">INT</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span> <span class="kw1">IDENTITY</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span>, 
&nbsp; &nbsp; SomeData <span class="kw1">UNIQUEIDENTIFIER</span> <span class="kw1">DEFAULT</span> newsequentialid<span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; Somedate <span class="kw1">datetime</span> <span class="kw1">DEFAULT</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; SomeOtherData <span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">200</span><span class="br0">&#41;</span> <span class="kw1">DEFAULT</span> <span class="st0">'bla'</span>,
&nbsp; &nbsp; ModifiedBy <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="kw1">DEFAULT</span> <span class="st0">'SomeapplicationName used by '</span> <span class="sy0">+</span>SUSER_NAME<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE TestFrag2 (
	id INT NOT NULL IDENTITY PRIMARY KEY, 
	SomeData UNIQUEIDENTIFIER DEFAULT newsequentialid(),
	Somedate datetime DEFAULT GETDATE(),
	SomeOtherData CHAR(200) DEFAULT 'bla',
	ModifiedBy varchar(100) DEFAULT 'SomeapplicationName used by ' +SUSER_NAME())</pre></div></div>

<p>Here is the other trigger</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>Tr_TestFrag2<span class="br0">&#93;</span> <span class="kw1">ON</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>TestFrag2<span class="br0">&#93;</span> <span class="kw1">FOR</span> <span class="kw1">Insert</span> 
<span class="kw1">AS</span>
<span class="kw1">UPDATE</span> t
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">SET</span> &nbsp; &nbsp;ModifiedBy <span class="sy0">=</span> <span class="st0">'SomeapplicationName used by '</span> <span class="sy0">+</span>SUSER_NAME<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> &nbsp; TestFrag2 t
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">JOIN</span> inserted i <span class="kw1">ON</span> t.<span class="me1">id</span> <span class="sy0">=</span> i.<span class="me1">id</span>
&nbsp; &nbsp; &nbsp; &nbsp;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TRIGGER [dbo].[Tr_TestFrag2] ON [dbo].[TestFrag2] FOR Insert 
AS
UPDATE t
        SET    ModifiedBy = 'SomeapplicationName used by ' +SUSER_NAME()
        FROM   TestFrag2 t
        JOIN inserted i ON t.id = i.id
       
GO</pre></div></div>

<p>Now let&#8217;s pump 100000 rows into both tables</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> TestFrag<span class="br0">&#40;</span>Somedate<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">100000</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span> 
<span class="kw1">FROM</span> sysobjects s1
<span class="sy0">CROSS</span> <span class="sy0">JOIN</span> sysobjects s2
<span class="sy0">CROSS</span> <span class="sy0">JOIN</span> sysobjects s3</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT TestFrag(Somedate)
SELECT TOP 100000 GETDATE() 
FROM sysobjects s1
CROSS JOIN sysobjects s2
CROSS JOIN sysobjects s3</pre></div></div>


<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> TestFrag2<span class="br0">&#40;</span>Somedate<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">100000</span> <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span> 
<span class="kw1">FROM</span> sysobjects s1
<span class="sy0">CROSS</span> <span class="sy0">JOIN</span> sysobjects s2
<span class="sy0">CROSS</span> <span class="sy0">JOIN</span> sysobjects s3</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT TestFrag2(Somedate)
SELECT TOP 100000 GETDATE() 
FROM sysobjects s1
CROSS JOIN sysobjects s2
CROSS JOIN sysobjects s3</pre></div></div>

<p>Run this to just verify that we have the same data</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">10</span> <span class="sy0">*</span> <span class="kw1">FROM</span> TestFrag
<span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">10</span> <span class="sy0">*</span> <span class="kw1">FROM</span> TestFrag2</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT TOP 10 * FROM TestFrag
SELECT TOP 10 * FROM TestFrag2</pre></div></div>

<p>Now let&#8217;s look how much space each table is using</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">EXEC</span> <span class="kw3">sp_spaceused</span> <span class="st0">'TestFrag'</span>
<span class="kw1">EXEC</span> <span class="kw3">sp_spaceused</span> <span class="st0">'TestFrag2'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">EXEC sp_spaceused 'TestFrag'
EXEC sp_spaceused 'TestFrag2'</pre></div></div>

<p></p>
<pre>name		rows		reserved	data		index_size	unused
TestFrag	100000     	47240 KB	47064 KB	104 KB		72 KB
TestFrag2	100000     	28744 KB	28576 KB	112 KB		56 KB</pre>
<p>
See that, the table with the same default as in the trigger is using a lot less data?</p>
<p>Now let&#8217;s see how bad the fragmentation is. Here is the 2005 and up version</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> &nbsp;
&nbsp; &nbsp; <span class="kw2">OBJECT_NAME</span><span class="br0">&#40;</span>i.<span class="kw2">OBJECT_ID</span><span class="br0">&#41;</span> <span class="kw1">AS</span> TableName
&nbsp; &nbsp; ,indexstats.<span class="me1">index_id</span>
&nbsp; &nbsp; ,index_type_desc
&nbsp; &nbsp; ,avg_fragmentation_in_percent
&nbsp; &nbsp; ,page_count
&nbsp; &nbsp; ,record_count
&nbsp; &nbsp; ,fill_factor
<span class="kw1">FROM</span> &nbsp; &nbsp;
sys.<span class="me1">dm_db_index_physical_stats</span><span class="br0">&#40;</span><span class="kw2">DB_ID</span><span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="sy0">NULL</span>, <span class="st0">'DETAILED'</span><span class="br0">&#41;</span> indexstats
<span class="kw1">INNER</span> <span class="sy0">JOIN</span> sys.<span class="me1">indexes</span> i <span class="kw1">ON</span> i.<span class="kw2">OBJECT_ID</span> <span class="sy0">=</span> indexstats.<span class="kw2">OBJECT_ID</span>
<span class="sy0">AND</span> i.<span class="me1">index_id</span> <span class="sy0">=</span> indexstats.<span class="me1">index_id</span>
<span class="kw1">WHERE</span> <span class="kw2">OBJECT_NAME</span><span class="br0">&#40;</span>i.<span class="kw2">OBJECT_ID</span><span class="br0">&#41;</span> in <span class="br0">&#40;</span><span class="st0">'TestFrag'</span>,<span class="st0">'TestFrag2'</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT  
    OBJECT_NAME(i.OBJECT_ID) AS TableName
    ,indexstats.index_id
    ,index_type_desc
    ,avg_fragmentation_in_percent
    ,page_count
    ,record_count
    ,fill_factor
FROM    
sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, 'DETAILED') indexstats
INNER JOIN sys.indexes i ON i.OBJECT_ID = indexstats.OBJECT_ID
AND i.index_id = indexstats.index_id
WHERE OBJECT_NAME(i.OBJECT_ID) in ('TestFrag','TestFrag2')</pre></div></div>

<p></p>
<div class="tables">
<table>
<tr>
<th>TableName</th>
<th>	index_id</th>
<th>	index_type_desc	</th>
<th>avg_fragmentation_in_percent</th>
<th>	page_count</th>
<th>	record_count</th>
<th>	fill_factor</th>
</tr>
<tr>
<td>TestFrag</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>99.422063573007</td>
<td>	5883</td>
<td>	100000</td>
<td>	0</td>
</tr>
<tr>
<td>TestFrag</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>0</td>
<td>	11</td>
<td>	5883</td>
<td>	0</td>
</tr>
<tr>
<td>TestFrag</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>0</td>
<td>	1</td>
<td>	11</td>
<td>	0</td>
</tr>
<tr>
<td>TestFrag2</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>0.335946248600224</td>
<td>	3572</td>
<td>	100000</td>
<td>	0</td>
</tr>
<tr>
<td>TestFrag2</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>0</td>
<td>	12</td>
<td>	3572</td>
<td>	0</td>
</tr>
<tr>
<td>TestFrag2</td>
<td>1</td>
<td>CLUSTERED INDEX</td>
<td>0</td>
<td>	1</td>
<td>	12</td>
<td>	0</td>
</tr>
</table>
</div>
<p>Yikes, do you see that, one table is completely fragmented.</p>
<p>Here is the 2000 version by using showcontig</p>
<pre>DBCC SHOWCONTIG scanning 'TestFrag' table...
Table: 'TestFrag' (933578364); index ID: 1, database ID: 14
TABLE level scan performed.
- Pages Scanned................................: &lt;strong&gt;5883&lt;/strong&gt;
- Extents Scanned..............................: 738
- Extent Switches..............................: 5879
- Avg. Pages per Extent........................: 8.0
- Scan Density [Best Count:Actual Count].......: 12.52% [736:5880]
- Logical Scan Fragmentation ..................: &lt;strong&gt;99.42%&lt;/strong&gt;
- Extent Scan Fragmentation ...................: 0.27%
- Avg. Bytes Free per Page.....................: &lt;strong&gt;3234.5&lt;/strong&gt;
- Avg. Page Density (full).....................: 60.04%
DBCC execution completed. If DBCC printed error messages, contact your system administrator.


DBCC SHOWCONTIG scanning 'TestFrag2' table...
Table: 'TestFrag2' (1205579333); index ID: 1, database ID: 14
TABLE level scan performed.
- Pages Scanned................................: &lt;strong&gt;3572&lt;/strong&gt;
- Extents Scanned..............................: 450
- Extent Switches..............................: 449
- Avg. Pages per Extent........................: 7.9
- Scan Density [Best Count:Actual Count].......: 99.33% [447:450]
- Logical Scan Fragmentation ..................: &lt;strong&gt;0.34%&lt;/strong&gt;
- Extent Scan Fragmentation ...................: 0.44%
- Avg. Bytes Free per Page.....................: &lt;strong&gt;89.3&lt;/strong&gt;
- Avg. Page Density (full).....................: 98.90%
DBCC execution completed. If DBCC printed error messages, contact your system administrator.</pre>
<p>As you can see you will get horrible page splits if your trigger expands the row every time an insert happens.</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/match-your-defaults-with-your/feed/</wfw:commentRss>
		<slash:comments>1</slash:comments>
		</item>
		<item>
		<title>Use DDL Triggers To Track Table Changes</title>
		<link>/index.php/datamgmt/datadesign/use-ddl-triggers-to-track/</link>
		<comments>/index.php/datamgmt/datadesign/use-ddl-triggers-to-track/#comments</comments>
		<pubDate>Thu, 21 Apr 2011 07:28:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[alter table]]></category>
		<category><![CDATA[auditing]]></category>
		<category><![CDATA[ddl]]></category>
		<category><![CDATA[ddl triggers]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2011/04/use-ddl-triggers-to-track/</guid>
		<description><![CDATA[Someone wanted to know when and by who a certain table was dropped, I told the person that you can do this with a DDL trigger.Wouldn't it be nice if you could track exactly all the DDL statements that were executed on a table in your database? Well, you can by using DDL Triggers]]></description>
				<content:encoded><![CDATA[<p>Someone wanted to know when and by who a certain table was dropped, I told the person that you can do this with a DDL trigger.Wouldn&#8217;t it be nice if you could track exactly all the DDL statements that were executed on a table in your database? Well, you can by using DDL Triggers, DDL Triggers were added in SQL Server 2005. </p>
<p>DDL triggers are a special kind of trigger that fire in response to Data Definition Language (DDL) statements. They can be used to perform administrative tasks in the database such as auditing and regulating database operations. A DDL trigger can be created on the database level or on the server level. In this post I will create a database level DDL trigger that will listen for the ALTER TABLE command.</p>
<p>First I will create a sample database</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">DATABASE</span> TestTrigger
GO
&nbsp;
<span class="kw1">USE</span> TestTrigger
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE DATABASE TestTrigger
GO

USE TestTrigger
GO</pre></div></div>

<p>Now I will create a table which will hold the DDL statement, the time and the login of the person who executed the statement</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> TriggerLog<span class="br0">&#40;</span>DDL <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">300</span><span class="br0">&#41;</span>, ExecutedBy <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>, EventDate <span class="kw1">datetime</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE TriggerLog(DDL VARCHAR(300), ExecutedBy VARCHAR(100), EventDate datetime)
GO</pre></div></div>

<p>Here is what my DDL trigger will look like, more information about DDL triggers can be found here: http://msdn.microsoft.com/en-us/library/ms189799.aspx</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TRIGGER</span> trALterTable 
<span class="kw1">ON</span> <span class="kw1">DATABASE</span> <span class="co1">-- A DB level trigger</span>
<span class="kw1">FOR</span> ALTER_TABLE <span class="co1">--Event we want to capture</span>
<span class="kw1">AS</span> 
&nbsp; <span class="kw1">INSERT</span> TriggerLog
&nbsp; <span class="kw1">SELECT</span> EVENTDATA<span class="br0">&#40;</span><span class="br0">&#41;</span>.<span class="kw1">value</span><span class="br0">&#40;</span><span class="st0">'(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]'</span>,<span class="st0">'nvarchar(max)'</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">COALESCE</span><span class="br0">&#40;</span><span class="kw2">SUSER_SNAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span>,<span class="kw2">USER_NAME</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw2">GETDATE</span><span class="br0">&#40;</span><span class="br0">&#41;</span>;
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TRIGGER trALterTable 
ON DATABASE -- A DB level trigger
FOR ALTER_TABLE --Event we want to capture
AS 
  INSERT TriggerLog
  SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)'), 
		COALESCE(SUSER_SNAME(),USER_NAME()), 
		GETDATE();
GO</pre></div></div>

<p>The code in the trigger should be pretty simple to follow. The line <em>EVENTDATA().value(&#8216;(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]&#8217;,&#8217;nvarchar(max)&#8217;)</em> is grabbing the DDL statement, more about EVENTDATA() can be found here: http://msdn.microsoft.com/en-us/library/ms173781.aspx</p>
<p>Next up is the test table that we will use to play around with</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> test<span class="br0">&#40;</span>id <span class="kw1">INT</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE test(id INT)</pre></div></div>

<p>The following block of code will add a column, change the data type of the column and will finally drop the column</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">ADD</span> SomeDate <span class="kw1">date</span>
GO
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">ALTER</span> <span class="kw1">COLUMN</span> SomeDate datetime2
GO
&nbsp;
&nbsp;
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">DROP</span> <span class="kw1">COLUMN</span> SomeDate 
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TABLE test
ADD SomeDate date
GO

ALTER TABLE test
ALTER COLUMN SomeDate datetime2
GO


ALTER TABLE test
DROP COLUMN SomeDate 
GO</pre></div></div>

<p>Now let&#8217;s see what we have in our log table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> TriggerLog
<span class="kw1">order</span> <span class="kw1">by</span> EventDate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT * FROM TriggerLog
order by EventDate</pre></div></div>

<p>
Here is the output<br />
</p>
<div class="tables">
<table>
<tr>
<th>DDL</th>
<th>ExecutedBy</th>
<th>	EventDate</th>
</tr>
<tr>
<td>ALTER TABLE test ADD SomeDate date</td>
<td>Denis-PCDenis</td>
<td>2011-04-19 20:18:07.590</td>
</tr>
<tr>
<td>ALTER TABLE test ALTER COLUMN SomeDate datetime2</td>
<td>Denis-PCDenis</td>
<td>2011-04-19 20:18:09.900</td>
</tr>
<tr>
<td>ALTER TABLE test DROP COLUMN SomeDate </td>
<td>Denis-PCDenis</td>
<td>2011-04-19 20:18:11.610</td>
</tr>
<table>
</table>
</table>
</div>
<p>
As you can see we have all the DDL statements captured in the table, the time it happened and the person who did it.<br />
Let&#8217;s just drop and recreate the table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">drop</span> <span class="kw1">table</span> Test
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">drop table Test
GO</pre></div></div>

<p>Now create the table again</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> test<span class="br0">&#40;</span>id <span class="kw1">INT</span><span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE test(id INT)
GO</pre></div></div>

<p>If you now execute this query, you will get back pretty much all the DDL statements that we executed before</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> DDL <span class="sy0">+</span> <span class="st0">'GO'</span>
<span class="kw1">FROM</span> TriggerLog
<span class="kw1">ORDER</span> <span class="kw1">BY</span> EventDate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT DDL + 'GO'
FROM TriggerLog
ORDER BY EventDate</pre></div></div>

<p>Here is what it looks like if you copied the results and pasted them into a query window.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">ADD</span> SomeDate <span class="kw1">date</span>
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">ALTER</span> <span class="kw1">COLUMN</span> SomeDate datetime2
GO
<span class="kw1">ALTER</span> <span class="kw1">TABLE</span> test
<span class="kw1">DROP</span> <span class="kw1">COLUMN</span> SomeDate 
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TABLE test
ADD SomeDate date
GO
ALTER TABLE test
ALTER COLUMN SomeDate datetime2
GO
ALTER TABLE test
DROP COLUMN SomeDate 
GO</pre></div></div>

<p>This was just a small example of how a DDL trigger works, A DDL trigger enables you to also not allow ALTER TABLE statements during business hours or for certain user even though they are db owner.</p>
<p>To see all the events that DDL triggers can listen for you can use the  sys.trigger_event_types Object Catalog View</p>
<pre>select type_name from sys.trigger_event_types </pre>
<p>Here is a partial result set</p>
<p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;<br />
CREATE_TABLE<br />
ALTER_TABLE<br />
DROP_TABLE<br />
CREATE_INDEX<br />
ALTER_INDEX<br />
DROP_INDEX<br />
CREATE_STATISTICS<br />
UPDATE_STATISTICS<br />
DROP_STATISTICS<br />
CREATE_SYNONYM<br />
DROP_SYNONYM<br />
CREATE_VIEW<br />
ALTER_VIEW<br />
DROP_VIEW<br />
CREATE_PROCEDURE</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/use-ddl-triggers-to-track/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Best Practice: Coding SQL Server triggers for multi-row operations</title>
		<link>/index.php/datamgmt/datadesign/best-practice-coding-sql-server-triggers/</link>
		<comments>/index.php/datamgmt/datadesign/best-practice-coding-sql-server-triggers/#comments</comments>
		<pubDate>Thu, 12 Nov 2009 18:12:21 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[how to]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>
		<category><![CDATA[sql server 2008]]></category>
		<category><![CDATA[tip]]></category>
		<category><![CDATA[triggers]]></category>

		<guid isPermaLink="false">/index.php/2009/11/best-practice-coding-sql-server-triggers/</guid>
		<description><![CDATA[Best Practice: coding SQL Server triggers for multi-row operations

There are many forum posts where people code triggers but these triggers are coded incorrectly because they don't account for multi-row operations. A trigger fires per batch not per r&#8230;]]></description>
				<content:encoded><![CDATA[<p>Best Practice: coding SQL Server triggers for multi-row operations</p>
<p>There are many forum posts where people code triggers but these triggers are coded incorrectly because they don&#8217;t account for multi-row operations. A trigger fires per batch not per row, if you are lucky you will get an error&#8230;if you are not lucky you will not get an error but it might take a while before you notice that you are missing a whole bunch of data<br />
Let&#8217;s take a look, first create these two tables</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> Test<span class="br0">&#40;</span>id <span class="kw1">int</span> <span class="kw1">identity</span> not null <span class="kw1">primary</span> <span class="kw1">key</span>, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SomeDate <span class="kw1">datetime</span> not null<span class="br0">&#41;</span>
GO
&nbsp;
<span class="kw1">create</span> <span class="kw1">table</span> TestHistory<span class="br0">&#40;</span>id <span class="kw1">int</span> &nbsp;not null, 
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; InsertedDate <span class="kw1">datetime</span> not null<span class="br0">&#41;</span>
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table Test(id int identity not null primary key, 
			SomeDate datetime not null)
GO

create table TestHistory(id int  not null, 
			InsertedDate datetime not null)
GO</pre></div></div>

<p>Now create this trigger, this trigger is very simple, it basically inserts a row into the history table every time an insert happens in the test table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> &nbsp;<span class="kw1">TRIGGER</span> trTest
&nbsp; &nbsp; <span class="kw1">ON</span> Test
&nbsp; &nbsp; <span class="kw1">FOR</span> <span class="kw1">INSERT</span>
&nbsp; &nbsp; <span class="kw1">AS</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="kw2">@@ROWCOUNT</span> <span class="sy0">=</span><span class="nu0">0</span>
&nbsp; &nbsp; <span class="kw1">RETURN</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @id <span class="kw1">int</span>
&nbsp; &nbsp; <span class="kw1">SET</span> @id <span class="sy0">=</span> <span class="br0">&#40;</span><span class="kw1">SELECT</span> id 
&nbsp; &nbsp; <span class="kw1">FROM</span> inserted<span class="br0">&#41;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">INSERT</span> TestHistory <span class="br0">&#40;</span>id,InsertedDate<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @id, <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE  TRIGGER trTest
    ON Test
    FOR INSERT
    AS
     
    IF @@ROWCOUNT =0
    RETURN
     
    DECLARE @id int
    SET @id = (SELECT id 
    FROM inserted)
    
    INSERT TestHistory (id,InsertedDate)
    SELECT @id, getdate()
    
    GO</pre></div></div>

<p>Run this insert statement which only inserts one row</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span> <span class="kw1">values</span><span class="br0">&#40;</span><span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate) values(getdate())</pre></div></div>

<p>Now run this to see what is in the history table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103</pre>
<p>That all works fine, what happens when we try to insert 2 rows?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate)
select getdate()
union all
select getdate() + 1</pre></div></div>

<p>Here is the error.</p>
<p><em>Server: Msg 512, Level 16, State 1, Procedure trTest, Line 11<br />
Subquery returned more than 1 value. This is not permitted when the subquery follows =, !=, <, <= , >, >= or when the subquery is used as an expression.<br />
The statement has been terminated.</em></p>
<p>What would happen if you coded the trigger in this way</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TRIGGER</span> trTest
&nbsp; &nbsp; <span class="kw1">ON</span> Test
&nbsp; &nbsp; <span class="kw1">FOR</span> <span class="kw1">INSERT</span>
&nbsp; &nbsp; <span class="kw1">AS</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="kw2">@@ROWCOUNT</span> <span class="sy0">=</span><span class="nu0">0</span>
&nbsp; &nbsp; <span class="kw1">RETURN</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">DECLARE</span> @id <span class="kw1">int</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @id <span class="sy0">=</span> id 
&nbsp; &nbsp; <span class="kw1">FROM</span> inserted
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">INSERT</span> TestHistory <span class="br0">&#40;</span>id,InsertedDate<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> @id, <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TRIGGER trTest
    ON Test
    FOR INSERT
    AS
     
    IF @@ROWCOUNT =0
    RETURN
     
    DECLARE @id int
    SELECT @id = id 
    FROM inserted
    
    INSERT TestHistory (id,InsertedDate)
    SELECT @id, getdate()
    
    GO</pre></div></div>

<p>Now insert one row</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span> <span class="kw1">values</span><span class="br0">&#40;</span><span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate) values(getdate())</pre></div></div>

<p>We look again what is in the history table, as you can see we have id 1 and 4, this is because id 2 and 3 failed and were rolled back</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103
4	2009-11-12 14:52:08.370</pre>
<p>Here is where it gets interesting, run this code</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate)
select getdate()
union all
select getdate() + 1</pre></div></div>

<p>That runs fine but when we look now we are missing row 5 in the history table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103
4	2009-11-12 14:52:08.370
6	2009-11-12 14:52:20.167</pre>
<p>let&#8217;s try that again</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate)
select getdate()
union all
select getdate() + 1</pre></div></div>

<p>Now we are missing row 7 in the history table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103
4	2009-11-12 14:52:08.370
6	2009-11-12 14:52:20.167
8	2009-11-12 14:52:38.917</pre>
<p>The problem is with this line of code</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> @id <span class="sy0">=</span> id <span class="kw1">FROM</span> inserted</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT @id = id FROM inserted</pre></div></div>

<p>@id will only hold the value for the row that was returned last in the result set</p>
<p>Here is how you would change the trigger to work correctly</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TRIGGER</span> trTest
&nbsp; &nbsp; <span class="kw1">ON</span> Test
&nbsp; &nbsp; <span class="kw1">FOR</span> <span class="kw1">INSERT</span>
&nbsp; &nbsp; <span class="kw1">AS</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; <span class="kw1">IF</span> <span class="kw2">@@ROWCOUNT</span> <span class="sy0">=</span><span class="nu0">0</span>
&nbsp; &nbsp; <span class="kw1">RETURN</span>
&nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">INSERT</span> TestHistory <span class="br0">&#40;</span>id,InsertedDate<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">SELECT</span> id, <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="kw1">FROM</span> inserted
&nbsp; &nbsp; 
GO</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TRIGGER trTest
    ON Test
    FOR INSERT
    AS
     
    IF @@ROWCOUNT =0
    RETURN
     
        
    INSERT TestHistory (id,InsertedDate)
    SELECT id, getdate()
    FROM inserted
    
GO</pre></div></div>

<p>Now run this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span> <span class="kw1">values</span><span class="br0">&#40;</span><span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate) values(getdate())</pre></div></div>

<p>We can now verify that it works correctly</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103
4	2009-11-12 14:52:08.370
6	2009-11-12 14:52:20.167
8	2009-11-12 14:52:38.917
9	2009-11-12 14:53:44.433</pre>
<p>Now run this for 2 rows</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">insert</span> Test<span class="br0">&#40;</span>SomeDate<span class="br0">&#41;</span>
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="kw1">union</span> all
<span class="kw1">select</span> <span class="kw2">getdate</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="nu0">1</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">insert Test(SomeDate)
select getdate()
union all
select getdate() + 1</pre></div></div>

<p>And as you can see both rows were inserted into the history table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">select</span> <span class="sy0">*</span> <span class="kw1">from</span> TestHistory</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">select * from TestHistory</pre></div></div>

<pre>1	2009-11-12 14:51:21.103
4	2009-11-12 14:52:08.370
6	2009-11-12 14:52:20.167
8	2009-11-12 14:52:38.917
9	2009-11-12 14:53:44.433
10	2009-11-12 14:53:51.870
11	2009-11-12 14:53:51.870</pre>
<p>So what is worse in this case? The error message or the fact that the code didn&#8217;t blow up but that the insert wasn&#8217;t working correctly? I&#8217;ll take an error message any time over the other problem.</p>
<p>I am putting together a <a href="http://wiki.lessthandot.com/index.php/SQL_Server_Programming_Best_Practices">SQL Server Best Programming Practices</a> wiki page, this blog post is part of it as are other posts and articles either from this site as well as from other sites. I am still working on the <a href="http://wiki.lessthandot.com/index.php/SQL_Server_Programming_Best_Practices">SQL Server Best Programming Practices</a> wiki page but I encourage you to bookmark it and come back every now and then because I will be adding more content</p>
<p></p>
<p>*** <strong>If you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/best-practice-coding-sql-server-triggers/feed/</wfw:commentRss>
		<slash:comments>11</slash:comments>
		</item>
	</channel>
</rss>
