<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="I’m building a B2C website with Cosmos DB as the back-end store and starting with common elements like Authentication. In my prior post, we connected the Cookie Middleware with custom membership logic and a standard username/password login method. In this one, we&#8217;ll be extending the system to also allow users to register and login via [&hellip;]" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB Comments Feed" href="/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Custom Authentication in ASP.Net Core 2 w/ Cosmos DB' href='/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/' />
<link rel='next' title='Adding User-Managed API Keys to ASP.Net Core 2 w/ Cosmos DB' href='/index.php/uncategorized/adding-user-managed-api-keys-to-asp-net-core-2-w-cosmos-db/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/" />
<link rel='shortlink' href='/?p=9170' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Faspnet%2Fadding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Faspnet%2Fadding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/uncategorized/adding-user-managed-api-keys-to-asp-net-core-2-w-cosmos-db/" rel="next">Adding User-Managed API Keys to ASP.Net Core 2 w/ Cosmos DB</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/" rel="prev">Custom Authentication in ASP.Net Core 2 w/ Cosmos DB</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/" class="post-title">Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB</a></h1>
					<div class="post-byline">by <a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)" rel="author">Eli Weinstock-Herman (tarwn)</a> on April 17, 2018 in category <a href="/index.php/category/webdev/serverprogramming/aspnet/" rel="category tag">ASP.NET</a>. Article views: 5,235 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&text=RT @LessThanDot Blog - Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB by @tarwn" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB&source=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&quote=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>I’m building a B2C website with Cosmos DB as the back-end store and starting with common elements like Authentication. In <a href="/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/" title="Custom Authentication for ASP.Net Core 2 with Cosmos DB">my prior post</a>, we connected the Cookie Middleware with custom membership logic and a standard username/password login method. In this one, we&#8217;ll be extending the system to also allow users to register and login via a third party provider (Twitter). </p>
<div id="attachment_9155" style="width: 610px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_106-600x406.png" alt="3 Authentication Scenarios: User/Pass, Twitter, API Keys" width="600" height="406" class="size-medium-width wp-image-9155" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_106-600x406.png 600w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106-300x203.png 300w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106-443x300.png 443w, /wp-content/uploads/2018/04/aspnetcore2cosmos_106.png 748w" sizes="(max-width: 600px) 100vw, 600px" /><p class="wp-caption-text">3 Authentication Scenarios: User/Pass, Twitter, API Keys</p></div>
<p>In this post I&#8217;ll also start exploring <code>User Authentications</code> as a separate document collection, rather than as additional fields on my User document. I&#8217;ve noticed in several past systems I&#8217;ve built API keys and authentication mechanisms as properties on Users, but recently started considering that, like my house keys, mixing properties of the user with authentication methods on a single &#8220;User&#8221; record has been making me uncomfortable.</p>
<div id="attachment_9181" style="width: 236px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_202.png" alt="Defining People (Users) Separate from House Keys (User Authentication)" width="226" height="161" class="size-full wp-image-9181" /><p class="wp-caption-text">Defining People (Users) Separate from House Keys (User Authentication)</p></div>
<p>Let&#8217;s find out if this works.</p>
<style>
.note-area{
   border: 1px solid #eeeeee; 
   border-left-width: 16px; 
   padding: 1em;
   margin: 1em 0;
}
.warning-area{
   border: 1px solid #FFdddd; 
   border-left-width: 16px; 
   padding: 1em;
   margin: 1em 0;
}
</style>
<h2>Breaking it down</h2>
<p>In the prior post, I outlined the authentication needs of this system and started breaking it into separate steps forward. Interactive logins would be able to take advantage of a standard username/password system or, alternatively, using a third-party system like Twitter. Once  a user has an account, they can create and manage API Key/Secret pairs for API access (which is the next post).</p>
<p>So where are we so far? We have built an ASP.net Core 2 website and added Cookie Middleware that is associated with <code>LoginSession</code> classes stored in Cosmos DB. Users can register with a username, password, and email address and are stored as <code>LoginUser</code> documents in Cosmos DB. Business logic for this is bundled up in a concrete <code>CosmosDBMembership</code> class while the Persistence logic to work with Cosmos DB is encapsulated in a UserPersistence class, both of which are registered with the built-in ASP.Net Core 2 Dependency Injeciton services collection. </p>
<p>Let&#8217;s extend the Membership logic to support Twitter:</p>
<div id="attachment_9182" style="width: 408px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_201.png" alt="File Changes for Twitter Addition" width="398" height="816" class="size-full wp-image-9182" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_201.png 398w, /wp-content/uploads/2018/04/aspnetcore2cosmos_201-146x300.png 146w" sizes="(max-width: 398px) 100vw, 398px" /><p class="wp-caption-text">File Changes for Twitter Addition</p></div>
<p>Here&#8217;s what we&#8217;ll be adding:</p>
<ul>
<li>A Register via Twitter button, callback URL + form, and registration endpoint</li>
<li>A Login via Twitter button and callback URL</li>
<li>Some supporting methods in <code>CosmosDBMembership</code></li>
<li>Some supporting methods in <code>Persistence.Users</code></li>
<li>A new <code>DocumentCollection</code> in Cosmos DB for alternative User Authentications</li>
</ul>
<p>This is a much smaller task then the initial work to put in custom authentication, but like that post I&#8217;ll present the changes file-by-file rather than in the order I developed them in.</p>
<p>The source code through this set of changes is available here: <a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/commits/Post-%233" title="Sample_ASPNetCore2AndCosmosDB, Post #3 Branch">github: Sample_ASPNetCore2AndCosmosDB, Post #3 Branch</a></p>
<h2>Using the Twitter Middleware</h2>
<p>The Twitter middleware uses a standard OAuth sign-in process, but does so in a way that takes care of all the details for us. </p>
<p>When a <code>Challenge</code> is issued through the twitter middleware, it takes precautions like generating a one time roundtrip token and stores that token and additional parameters for us in a shortlived cookie. It then sends the user over to twitter with a callback URL and that roundtrip token which Twitter uses once the User has logged in and granted us access. Twitter calls back to the callback, which is handled 100% by the middleware, including verifying that roundtrip token came back around successfully. Information from Twitter is added to the Claims on the HttpContext, just as cookie informaiton is when we use the Cookie Middleware, so we can then use that information to perform our internal authorization logic.</p>
<div id="attachment_9183" style="width: 595px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_203.png" alt="Twitter OAuth and Middleware Flow" width="585" height="624" class="size-full wp-image-9183" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_203.png 585w, /wp-content/uploads/2018/04/aspnetcore2cosmos_203-281x300.png 281w" sizes="(max-width: 585px) 100vw, 585px" /><p class="wp-caption-text">Twitter OAuth and Middleware Flow</p></div>
<p>Once they&#8217;re logged in (or registered), we can generate a session and forward them to the URL they were originally headed to.</p>
<h3>Set Up Twitter</h3>
<p>The first step is to set up credentials with Twitter for the application. The documented <a href="https://docs.microsoft.com/en-us/aspnet/core/security/authentication/social/twitter-logins?view=aspnetcore-2.1&#038;tabs=aspnetcore2x" title="MSDN: ASP.Net Core 2 Twitter Setup">MSDN setup documentation</a> has good steps for this, so we can follow through on the twitter side to get an app and access key setup.</p>
<div id="attachment_9184" style="width: 610px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_204-600x495.png" alt="Twitter App Setup" width="600" height="495" class="size-medium-width wp-image-9184" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_204-600x495.png 600w, /wp-content/uploads/2018/04/aspnetcore2cosmos_204-300x248.png 300w, /wp-content/uploads/2018/04/aspnetcore2cosmos_204-364x300.png 364w, /wp-content/uploads/2018/04/aspnetcore2cosmos_204.png 760w" sizes="(max-width: 600px) 100vw, 600px" /><p class="wp-caption-text">Twitter App Setup</p></div>
<p>We&#8217;ll be storing the API Key and access token in our settings file for now, later we&#8217;ll take advantage of secrets management to store it in a way that doesn&#8217;t expose it to git.</p>
<h3>Add Middleware</h3>
<p>The next part is to configure the middleware to use those App settings from Twitter. Once we receive the information back from Twitter, we will use that twitter Id to either continue user registration or attempt to log the user in, depending on where they started. Rather than build conditional logic into the Twitter options for the middleware, we can instead provide a final URL to redirect to for each endpoint:</p>
<ul>
<li><code>/account/login/twitter</code> should finally redirect to <code>/account/login/twitter/continue</code></li>
<li><code>/account/register/twitter</code> should finally redirect to <code>/account/login/register/continue</code></li>
</ul>
<p>When the redirect comes back from Twitter, it passed back account information that is parsed into claims on the HttpContext. </p>
<div class="note-area">
During the Twitter authentication challenge, there is an internal cookie to carry state between the call to twitter and callback. Once the account information has been parsed, however, that information exists purely in the HttpContext for that request.
</div>
<p>To bridge the gap between receiving the Twitter information and being able to use it on the final redirect, we can register a second Cookie middleware and tell twitter to use that middleware&#8217;s <code>AuthenticationScheme</code> for SignIn. This way, once the Twitter middleware has finished parsing the Claims, it will turn around and &#8220;SignIn&#8221; via the new Cookie Middleware. This writes the claims from Twitter to a new cookie for subsequent requests.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%233/SampleCosmosCore2App/Startup.cs">SampleCosmosCore2App/Startup.cs</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">void</span> ConfigureServices<span class="br0">&#40;</span>IServiceCollection services<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp;<span class="co1">// ... MVC, Membership</span>
&nbsp;
&nbsp; &nbsp; services<span class="sy0">.</span><span class="me1">AddAuthentication</span><span class="br0">&#40;</span>CookieAuthenticationDefaults<span class="sy0">.</span><span class="me1">AuthenticationScheme</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/* External Auth Providers */</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">AddCookie</span><span class="br0">&#40;</span><span class="st0">&quot;ExternalCookie&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">AddTwitter</span><span class="br0">&#40;</span><span class="st0">&quot;Twitter&quot;</span>, options <span class="sy0">=&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">SignInScheme</span> <span class="sy0">=</span> <span class="st0">&quot;ExternalCookie&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">ConsumerKey</span> <span class="sy0">=</span> Configuration<span class="br0">&#91;</span><span class="st0">&quot;Authentication:Twitter:ConsumerKey&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; options<span class="sy0">.</span><span class="me1">ConsumerSecret</span> <span class="sy0">=</span> Configuration<span class="br0">&#91;</span><span class="st0">&quot;Authentication:Twitter:ConsumerSecret&quot;</span><span class="br0">&#93;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="coMULTI">/* 'Session' Cookie Provider */</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">AddCookie</span><span class="br0">&#40;</span><span class="br0">&#40;</span>options<span class="br0">&#41;</span> <span class="sy0">=&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public void ConfigureServices(IServiceCollection services)
{
   // ... MVC, Membership

    services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
        /* External Auth Providers */
        .AddCookie("ExternalCookie")
        .AddTwitter("Twitter", options =&gt;
        {
            options.SignInScheme = "ExternalCookie";

            options.ConsumerKey = Configuration["Authentication:Twitter:ConsumerKey"];
            options.ConsumerSecret = Configuration["Authentication:Twitter:ConsumerSecret"];
        })
        /* 'Session' Cookie Provider */
        .AddCookie((options) =&gt;
        {
            // ...
        });
}</pre></div></div>

<p>So the only three configurations we need here are the new Cookie provider with an explicit <code>AuthenticationScheme</code>, configuring Twitter to Sign In via that <code>AuthenticationScheme</code>, and then adding our Twitter Key and Secret via the appsettings.json file.</p>
<h2>Login Endpoints</h2>
<p>To support the Login flow, we need a set of new endpoints and a button.</p>
<p>We&#8217;ll add a new <code>/account/login/twitter</code> endpoint with a final callback of <code>/account/login/twitter/continue</code> redirect URL to perform the actual Sign On, and we&#8217;ll add a button to the existing Login view:</p>
<div id="attachment_9185" style="width: 361px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_205.png" alt="Addition of a &quot;Login with Twitter&quot; button" width="351" height="379" class="size-full wp-image-9185" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_205.png 351w, /wp-content/uploads/2018/04/aspnetcore2cosmos_205-278x300.png 278w" sizes="(max-width: 351px) 100vw, 351px" /><p class="wp-caption-text">Addition of a &#8220;Login with Twitter&#8221; button</p></div>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%233/SampleCosmosCore2App/Views/Account/Login.cshtml">SampleCosmosCore2App/Views/Account/Login.cshtml</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1">...
<span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;box&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">h2</span>&gt;</span>Login<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">h2</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">a</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;LoginWithTwitter&quot;</span> asp-route-returnUrl<span class="sy0">=</span><span class="st0">&quot;@TempData[&quot;</span>returnUrl<span class="st0">&quot;]&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;btn-white&quot;</span>&gt;</span>Login with Twitter<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">a</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; ...
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">...
&lt;div class="box"&gt;
    &lt;h2&gt;Login&lt;/h2&gt;

    &lt;a asp-action="LoginWithTwitter" asp-route-returnUrl="@TempData["returnUrl"]" class="btn-white"&gt;Login with Twitter&lt;/a&gt;

    ...
&lt;/div&gt;</pre></div></div>

<p>Then we add the endpoints to the Account controller to start the Twitter authentication process and capture the callback values at the end to start a new login session.</p>
<p><a href=""></a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;login/twitter&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
<span class="kw1">public</span> IActionResult LoginWithTwitter<span class="br0">&#40;</span><span class="kw4">string</span> returnUrl <span class="sy0">=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> props <span class="sy0">=</span> <span class="kw3">new</span> AuthenticationProperties<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; RedirectUri <span class="sy0">=</span> <span class="st0">&quot;account/login/twitter/continue?returnUrl=&quot;</span> <span class="sy0">+</span> HttpUtility<span class="sy0">.</span><span class="me1">UrlEncode</span><span class="br0">&#40;</span>returnUrl<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> Challenge<span class="br0">&#40;</span>props, <span class="st0">&quot;Twitter&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;login/twitter/continue&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> LoginWithTwitterContinueAsync<span class="br0">&#40;</span><span class="kw4">string</span> returnUrl <span class="sy0">=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// use twitter info to create a session</span>
&nbsp; &nbsp; <span class="kw1">var</span> cookie <span class="sy0">=</span> await HttpContext<span class="sy0">.</span><span class="me1">AuthenticateAsync</span><span class="br0">&#40;</span><span class="st0">&quot;ExternalCookie&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> twitterId <span class="sy0">=</span> cookie<span class="sy0">.</span><span class="me1">Principal</span><span class="sy0">.</span><span class="me1">FindFirst</span><span class="br0">&#40;</span><span class="st0">&quot;urn:twitter:userid&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _membership<span class="sy0">.</span><span class="me1">LoginExternalAsync</span><span class="br0">&#40;</span><span class="st0">&quot;Twitter&quot;</span>, twitterId<span class="sy0">.</span><span class="kw1">Value</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Failed</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, <span class="st0">&quot;Twitter account not recognized, have you registered yet?&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">SignOutAsync</span><span class="br0">&#40;</span><span class="st0">&quot;ExternalCookie&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> LocalRedirect<span class="br0">&#40;</span>returnUrl <span class="sy0">??</span> _membership<span class="sy0">.</span><span class="me1">Options</span><span class="sy0">.</span><span class="me1">DefaultPathAfterLogin</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[HttpGet("login/twitter")]
[AllowAnonymous]
public IActionResult LoginWithTwitter(string returnUrl = null)
{
    var props = new AuthenticationProperties()
    {
        RedirectUri = "account/login/twitter/continue?returnUrl=" + HttpUtility.UrlEncode(returnUrl)
    };
    return Challenge(props, "Twitter");
}

[HttpGet("login/twitter/continue")]
[AllowAnonymous]
public async Task&lt;IActionResult&gt; LoginWithTwitterContinueAsync(string returnUrl = null)
{
    // use twitter info to create a session
    var cookie = await HttpContext.AuthenticateAsync("ExternalCookie");
    var twitterId = cookie.Principal.FindFirst("urn:twitter:userid");

    var result = await _membership.LoginExternalAsync("Twitter", twitterId.Value);
    if (result.Failed)
    {
        ModelState.AddModelError("", "Twitter account not recognized, have you registered yet?");
        return View("Login");
    }

    await HttpContext.SignOutAsync("ExternalCookie");

    return LocalRedirect(returnUrl ?? _membership.Options.DefaultPathAfterLogin);
}</pre></div></div>

<p>The Twitter information comes back in the &#8220;ExternalCookie&#8221; we registered in the Startup configuration. We&#8217;ll add a method to <code>CosmosDBMembership</code> to create a <code>LoginSession</code> just like we do with a username/password, except for a third-party identity instead. The last step is to clean up the &#8220;External Cookie&#8221; using it&#8217;s <code>SignOut</code> method.</p>
<div class="note-area">
Originally I added the <code>SignOut</code> for cleanliness, but it was later pointed out to me that this is extra overhead going across the wire on every Request/Response and, in some cases, can actually result in &#8220;Request Too Long&#8221; web server errors if you stack up too many cookies.
</div>
<h3>Registration Endpoints</h3>
<p>The registration flow is similar to the login flow, but we need one additional endpoint to serve up the registration form once we have the user&#8217;s twitter information for authentication.</p>
<div id="attachment_9186" style="width: 357px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_206.png" alt="&quot;Continue with Twitter&quot; on Register Form" width="347" height="395" class="size-full wp-image-9186" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_206.png 347w, /wp-content/uploads/2018/04/aspnetcore2cosmos_206-264x300.png 264w" sizes="(max-width: 347px) 100vw, 347px" /><p class="wp-caption-text">&#8220;Continue with Twitter&#8221; on Register Form</p></div>
<div id="attachment_9187" style="width: 354px" class="wp-caption aligncenter"><img src="/wp-content/uploads/2018/04/aspnetcore2cosmos_207.png" alt="Continuing Registration after logging in as @sqlishard" width="344" height="276" class="size-full wp-image-9187" srcset="/wp-content/uploads/2018/04/aspnetcore2cosmos_207.png 344w, /wp-content/uploads/2018/04/aspnetcore2cosmos_207-300x241.png 300w" sizes="(max-width: 344px) 100vw, 344px" /><p class="wp-caption-text">Continuing Registration after logging in as @sqlishard</p></div>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%233/SampleCosmosCore2App/Views/Account/Register.cshtml">SampleCosmosCore2App/Views/Account/Register.cshtml</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1">...
&nbsp;
<span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;box&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">h2</span>&gt;</span>Create Account<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">h2</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">a</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;RegisterWithTwitter&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;btn-white&quot;</span>&gt;</span>Continue with Twitter<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">a</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; ...
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">...

&lt;div class="box"&gt;
    &lt;h2&gt;Create Account&lt;/h2&gt;

    &lt;a asp-action="RegisterWithTwitter" class="btn-white"&gt;Continue with Twitter&lt;/a&gt;

    ...
&lt;/div&gt;</pre></div></div>

<p>Like the Login form, we add a link to the Registration form.</p>
<p><a href="https://github.com/tarwn/Sample_ASPNetCore2AndCosmosDB/blob/Post-%233/SampleCosmosCore2App/Views/Account/RegisterWithTwitterContinue.cshtml">SampleCosmosCore2App/Views/Account/RegisterWithTwitterContinue.cshtml</a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="html4strict"><thead><tr><td colspan="2"  class="head">HTML</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="de1"><pre class="de1">@model SampleCosmosCore2App.Models.Account.RegisterWithTwitterModel
&nbsp;
@{
&nbsp; &nbsp; ViewData[&quot;Title&quot;] = &quot;Register&quot;;
&nbsp; &nbsp; Layout = &quot;~/Views/Shared/Layout.cshtml&quot;;
}
&nbsp;
<span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;box&quot;</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">h2</span>&gt;</span>Create Account<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">h2</span>&gt;</span>
&nbsp;
&nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">form</span> asp-<span class="kw3">action</span><span class="sy0">=</span><span class="st0">&quot;RegisterWithTwitterContinueAsync&quot;</span> <span class="kw3">method</span><span class="sy0">=</span><span class="st0">&quot;post&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> asp-validation-<span class="kw3">summary</span><span class="sy0">=</span><span class="st0">&quot;ModelOnly&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Welcome <span class="sc2">&lt;<span class="kw2">span</span>&gt;</span>@Model.TwitterUsername<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>!
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;TwitterUsername&quot;</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;hidden&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;TwitterId&quot;</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;hidden&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;UserName&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">label</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;control-label&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">label</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> asp-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-control&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">span</span> asp-validation-<span class="kw3">for</span><span class="sy0">=</span><span class="st0">&quot;Email&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;text-danger&quot;</span>&gt;&lt;<span class="sy0">/</span><span class="kw2">span</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">div</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;form-group&quot;</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="kw2">input</span> <span class="kw3">type</span><span class="sy0">=</span><span class="st0">&quot;submit&quot;</span> <span class="kw3">value</span><span class="sy0">=</span><span class="st0">&quot;Register&quot;</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;btn btn-default&quot;</span> <span class="sy0">/</span>&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span>
&nbsp; &nbsp; <span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">form</span>&gt;</span>
<span class="sc2">&lt;<span class="sy0">/</span><span class="kw2">div</span>&gt;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">@model SampleCosmosCore2App.Models.Account.RegisterWithTwitterModel

@{
    ViewData["Title"] = "Register";
    Layout = "~/Views/Shared/Layout.cshtml";
}

&lt;div class="box"&gt;
    &lt;h2&gt;Create Account&lt;/h2&gt;

    &lt;form asp-action="RegisterWithTwitterContinueAsync" method="post"&gt;
        &lt;div asp-validation-summary="ModelOnly" class="text-danger"&gt;&lt;/div&gt;
        &lt;div class="form-group"&gt;
            Welcome &lt;span&gt;@Model.TwitterUsername&lt;/span&gt;!
            &lt;input asp-for="TwitterUsername" type="hidden" /&gt;
            &lt;input asp-for="TwitterId" type="hidden" /&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;label asp-for="UserName" class="control-label"&gt;&lt;/label&gt;
            &lt;input asp-for="UserName" class="form-control" /&gt;
            &lt;span asp-validation-for="UserName" class="text-danger"&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;label asp-for="Email" class="control-label"&gt;&lt;/label&gt;
            &lt;input asp-for="Email" class="form-control" /&gt;
            &lt;span asp-validation-for="Email" class="text-danger"&gt;&lt;/span&gt;
        &lt;/div&gt;
        &lt;div class="form-group"&gt;
            &lt;input type="submit" value="Register" class="btn btn-default" /&gt;
        &lt;/div&gt;
    &lt;/form&gt;
&lt;/div&gt;</pre></div></div>

<p>And a view that collects a username (for display purposes) once they&#8217;ve authenticated with Twitter.</p>
<p>Then we can add the 3 endpoints to start the twitter <code>Challenge</code>, extract the details and feed them into the Registration form, then complete the Registration and log the user in for the first time:</p>
<p><a href=""></a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;register/twitter&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
<span class="kw1">public</span> IActionResult RegisterWithTwitter<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> props <span class="sy0">=</span> <span class="kw3">new</span> AuthenticationProperties<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; RedirectUri <span class="sy0">=</span> <span class="st0">&quot;account/register/twitter/continue&quot;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> Challenge<span class="br0">&#40;</span>props, <span class="st0">&quot;Twitter&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>HttpGet<span class="br0">&#40;</span><span class="st0">&quot;register/twitter/continue&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="br0">&#91;</span>AllowAnonymous<span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> RegisterWithTwitterContinueAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// use twitter info to set some sensible defaults</span>
&nbsp; &nbsp; <span class="kw1">var</span> cookie <span class="sy0">=</span> await HttpContext<span class="sy0">.</span><span class="me1">AuthenticateAsync</span><span class="br0">&#40;</span><span class="st0">&quot;ExternalCookie&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> twitterId <span class="sy0">=</span> cookie<span class="sy0">.</span><span class="me1">Principal</span><span class="sy0">.</span><span class="me1">FindFirst</span><span class="br0">&#40;</span><span class="st0">&quot;urn:twitter:userid&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> twitterUsername <span class="sy0">=</span> cookie<span class="sy0">.</span><span class="me1">Principal</span><span class="sy0">.</span><span class="me1">FindFirst</span><span class="br0">&#40;</span><span class="st0">&quot;urn:twitter:screenname&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// verify the id is not already registered, short circuit to login screen</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>await _membership<span class="sy0">.</span><span class="me1">IsAlreadyRegisteredAsync</span><span class="br0">&#40;</span><span class="st0">&quot;Twitter&quot;</span>, twitterId<span class="sy0">.</span><span class="kw1">Value</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, $<span class="st0">&quot;Welcome back! Your twitter account @{twitterUsername.Value} is already registered. Maybe login instead?&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;Login&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> suggestedUsername <span class="sy0">=</span> await FindUniqueSuggestionAsync<span class="br0">&#40;</span>twitterUsername<span class="sy0">.</span><span class="kw1">Value</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> model <span class="sy0">=</span> <span class="kw3">new</span> RegisterWithTwitterModel<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; TwitterId <span class="sy0">=</span> twitterId<span class="sy0">.</span><span class="kw1">Value</span>,
&nbsp; &nbsp; &nbsp; &nbsp; TwitterUsername <span class="sy0">=</span> twitterUsername<span class="sy0">.</span><span class="kw1">Value</span>,
&nbsp; &nbsp; &nbsp; &nbsp; UserName <span class="sy0">=</span> suggestedUsername
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;RegisterWithTwitterContinue&quot;</span>, model<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>HttpPost<span class="br0">&#40;</span><span class="st0">&quot;register/twitter/continue&quot;</span><span class="br0">&#41;</span><span class="br0">&#93;</span>
<span class="kw1">public</span> async Task<span class="sy0">&lt;</span>IActionResult<span class="sy0">&gt;</span> RegisterWithTwitterContinueAsync<span class="br0">&#40;</span>RegisterWithTwitterModel model<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span>ModelState<span class="sy0">.</span><span class="me1">IsValid</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;RegisterWithTwitterContinue&quot;</span>, model<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _membership<span class="sy0">.</span><span class="me1">RegisterExternalAsync</span><span class="br0">&#40;</span>model<span class="sy0">.</span><span class="me1">UserName</span>, model<span class="sy0">.</span><span class="me1">Email</span>, <span class="st0">&quot;Twitter&quot;</span>, model<span class="sy0">.</span><span class="me1">TwitterId</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Failed</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; ModelState<span class="sy0">.</span><span class="me1">AddModelError</span><span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, result<span class="sy0">.</span><span class="me1">ErrorMessage</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> View<span class="br0">&#40;</span><span class="st0">&quot;RegisterWithTwitterContinue&quot;</span>, model<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; await HttpContext<span class="sy0">.</span><span class="me1">SignOutAsync</span><span class="br0">&#40;</span><span class="st0">&quot;ExternalCookie&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> LocalRedirect<span class="br0">&#40;</span>_membership<span class="sy0">.</span><span class="me1">Options</span><span class="sy0">.</span><span class="me1">DefaultPathAfterLogin</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[HttpGet("register/twitter")]
[AllowAnonymous]
public IActionResult RegisterWithTwitter()
{
    var props = new AuthenticationProperties()
    {
        RedirectUri = "account/register/twitter/continue"
    };
    return Challenge(props, "Twitter");
}

[HttpGet("register/twitter/continue")]
[AllowAnonymous]
public async Task&lt;IActionResult&gt; RegisterWithTwitterContinueAsync()
{
    // use twitter info to set some sensible defaults
    var cookie = await HttpContext.AuthenticateAsync("ExternalCookie");
    var twitterId = cookie.Principal.FindFirst("urn:twitter:userid");
    var twitterUsername = cookie.Principal.FindFirst("urn:twitter:screenname");

    // verify the id is not already registered, short circuit to login screen
    if (await _membership.IsAlreadyRegisteredAsync("Twitter", twitterId.Value))
    {
        ModelState.AddModelError("", $"Welcome back! Your twitter account @{twitterUsername.Value} is already registered. Maybe login instead?");
        return View("Login");
    }

    var suggestedUsername = await FindUniqueSuggestionAsync(twitterUsername.Value);

    var model = new RegisterWithTwitterModel() {
        TwitterId = twitterId.Value,
        TwitterUsername = twitterUsername.Value,
        UserName = suggestedUsername
    };

    return View("RegisterWithTwitterContinue", model);
}

[HttpPost("register/twitter/continue")]
public async Task&lt;IActionResult&gt; RegisterWithTwitterContinueAsync(RegisterWithTwitterModel model)
{
    if (!ModelState.IsValid)
    {
        return View("RegisterWithTwitterContinue", model);
    }

    var result = await _membership.RegisterExternalAsync(model.UserName, model.Email, "Twitter", model.TwitterId);
    if (result.Failed)
    {
        ModelState.AddModelError("", result.ErrorMessage);
        return View("RegisterWithTwitterContinue", model);
    }

    await HttpContext.SignOutAsync("ExternalCookie");

    return LocalRedirect(_membership.Options.DefaultPathAfterLogin);
}</pre></div></div>

<p>Once again, the last step in the process is to SignOut of the &#8220;ExternalCookie&#8221;, cleaning up after the stored Twitter information.</p>
<h2>Membership and Persistence</h2>
<p>The changes for the membership object are fairly light. We need to be able to:</p>
<ul>
<li><code>Register(username, email, "Twitter", twitterId)</code>: Register a new account w/ Twitter authentication</li>
<li><code>Login("Twitter", twitterId)</code>: Login with &#8220;Twitter&#8221; authentication</li>
</ul>
<p>These will expose the new Persistence methods we need against Cosmos DB.</p>
<p><a href=""></a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> CosmosDBMembership <span class="sy0">:</span> ICustomMembership
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginResult<span class="sy0">&gt;</span> LoginExternalAsync<span class="br0">&#40;</span><span class="kw4">string</span> scheme, <span class="kw4">string</span> identity<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> authScheme <span class="sy0">=</span> StringToScheme<span class="br0">&#40;</span>scheme<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">GetUserByAuthenticationAsync</span><span class="br0">&#40;</span>authScheme, identity<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>user <span class="sy0">==</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; await SignInAsync<span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> LoginResult<span class="sy0">.</span><span class="me1">GetSuccess</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>RegisterResult<span class="sy0">&gt;</span> RegisterExternalAsync<span class="br0">&#40;</span><span class="kw4">string</span> username, <span class="kw4">string</span> email, <span class="kw4">string</span> scheme, <span class="kw4">string</span> identity<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> user <span class="sy0">=</span> <span class="kw3">new</span> LoginUser<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Username <span class="sy0">=</span> username,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Email <span class="sy0">=</span> email
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> userAuth <span class="sy0">=</span> <span class="kw3">new</span> LoginUserAuthentication<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Scheme <span class="sy0">=</span> StringToScheme<span class="br0">&#40;</span>scheme<span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Identity <span class="sy0">=</span> identity
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; user <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">CreateUserAsync</span><span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">catch</span> <span class="br0">&#40;</span>Exception<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">//TODO reduce breadth of exception statement</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> RegisterResult<span class="sy0">.</span><span class="me1">GetFailed</span><span class="br0">&#40;</span><span class="st0">&quot;Username is already in use&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; userAuth<span class="sy0">.</span><span class="me1">UserId</span> <span class="sy0">=</span> user<span class="sy0">.</span><span class="me1">Id</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; userAuth <span class="sy0">=</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">CreateUserAuthenticationAsync</span><span class="br0">&#40;</span>userAuth<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">catch</span> <span class="br0">&#40;</span>Exception<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// cleanup</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">DeleteUserAsync</span><span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">throw</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; await SignInAsync<span class="br0">&#40;</span>user<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> RegisterResult<span class="sy0">.</span><span class="me1">GetSuccess</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">bool</span><span class="sy0">&gt;</span> IsAlreadyRegisteredAsync<span class="br0">&#40;</span><span class="kw4">string</span> scheme, <span class="kw4">string</span> identity<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> await _persistence<span class="sy0">.</span><span class="me1">Users</span><span class="sy0">.</span><span class="me1">IsIdentityRegisteredAsync</span><span class="br0">&#40;</span>StringToScheme<span class="br0">&#40;</span>scheme<span class="br0">&#41;</span>, identity<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class CosmosDBMembership : ICustomMembership
{
    // ...

    public async Task&lt;LoginResult&gt; LoginExternalAsync(string scheme, string identity)
    {
        var authScheme = StringToScheme(scheme);
        var user = await _persistence.Users.GetUserByAuthenticationAsync(authScheme, identity);
        if (user == null)
        {
            return LoginResult.GetFailed();
        }

        await SignInAsync(user);

        return LoginResult.GetSuccess();
    }

    public async Task&lt;RegisterResult&gt; RegisterExternalAsync(string username, string email, string scheme, string identity)
    {
        var user = new LoginUser()
        {
            Username = username,
            Email = email
        };
        var userAuth = new LoginUserAuthentication()
        {
            Scheme = StringToScheme(scheme),
            Identity = identity
        };

        try
        {
            user = await _persistence.Users.CreateUserAsync(user);
        }
        catch (Exception)
        {
            //TODO reduce breadth of exception statement
            return RegisterResult.GetFailed("Username is already in use");
        }

        try
        {
            userAuth.UserId = user.Id;
            userAuth = await _persistence.Users.CreateUserAuthenticationAsync(userAuth);
        }
        catch (Exception)
        {
            // cleanup
            await _persistence.Users.DeleteUserAsync(user);
            throw;
        }

        await SignInAsync(user);

        return RegisterResult.GetSuccess();
    }

    public async Task&lt;bool&gt; IsAlreadyRegisteredAsync(string scheme, string identity)
    {
        return await _persistence.Users.IsIdentityRegisteredAsync(StringToScheme(scheme), identity);
    }

    // ...
}</pre></div></div>

<p>The Login method is straightforward: Find a user that has a UserAuthentication of Twitter with the given twitter id. If we can&#8217;t find a user, we don&#8217;t know who they are.</p>
<p>Registration is a little trickier. We have to create and store both a <code>LoginUser</code> and <code>LoginUserAuthentication</code> object to successfully register the user and we need the generated <code>id</code> from the <code>LoginUser</code> that Cosmos DB generates from that save to populate the <code>UserId</code> property on the &#8220;LoginUserAuthentication</code> before saving. So we create both classes, populate the <code>UserId</code> in between saves, and if the second save fails for any reason we delete the initial <code>LoginUser</code> document.</p>
<p>I&#8217;m not sure that I like the &#8220;Twitter&#8221; string being passed around, so you can see I&#8217;ve switched to an enumerated value for Persistence and will likely refactor that back up the stack later.</p>
<p>Persistence needs some additional setup to create the new DocumentCollection, a method to retrieve a <code>LoginUser</code> document for a given Twitter identity, ability to Delete a user document, and methods to create and check given Twitter identities in the system.<br />
<a href=""></a></p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">class</span> UserPersistence
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task EnsureSetupAsync<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> databaseUri <span class="sy0">=</span> UriFactory<span class="sy0">.</span><span class="me1">CreateDatabaseUri</span><span class="br0">&#40;</span>_databaseId<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// Collections</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">CreateDocumentCollectionIfNotExistsAsync</span><span class="br0">&#40;</span>databaseUri, <span class="kw3">new</span> DocumentCollection<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> Id <span class="sy0">=</span> AUTHS_DOCUMENT_COLLECTION_ID <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co2">#region Users</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp; &nbsp; &nbsp; &nbsp; 
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginUser<span class="sy0">&gt;</span> GetUserByAuthenticationAsync<span class="br0">&#40;</span>AuthenticationScheme authenticationScheme, <span class="kw4">string</span> identity<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> query <span class="sy0">=</span> _client<span class="sy0">.</span><span class="me1">CreateDocumentQuery</span><span class="sy0">&lt;</span>LoginUserAuthentication<span class="sy0">&gt;</span><span class="br0">&#40;</span>GetAuthenticationsCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw3">new</span> SqlQuerySpec<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QueryText <span class="sy0">=</span> <span class="st0">&quot;SELECT * FROM UserAuthentications UA WHERE UA.Scheme = @scheme AND UA.Identity = @identity&quot;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Parameters <span class="sy0">=</span> <span class="kw3">new</span> SqlParameterCollection<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> SqlParameter<span class="br0">&#40;</span><span class="st0">&quot;@scheme&quot;</span>, authenticationScheme<span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> SqlParameter<span class="br0">&#40;</span><span class="st0">&quot;@identity&quot;</span>, identity<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> results <span class="sy0">=</span> await query<span class="sy0">.</span><span class="me1">AsDocumentQuery</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">ExecuteNextAsync</span><span class="sy0">&lt;</span>LoginUserAuthentication<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span> <span class="br0">&#40;</span>results<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">==</span> <span class="nu0">0</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">null</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">else</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> await GetUserAsync<span class="br0">&#40;</span>results<span class="sy0">.</span><span class="me1">First</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">UserId</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task DeleteUserAsync<span class="br0">&#40;</span>LoginUser user<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; await _client<span class="sy0">.</span><span class="me1">DeleteDocumentAsync</span><span class="br0">&#40;</span>UriFactory<span class="sy0">.</span><span class="me1">CreateDocumentUri</span><span class="br0">&#40;</span>_databaseId, USERS_DOCUMENT_COLLECTION_ID, user<span class="sy0">.</span><span class="me1">Id</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co2">#endregion</span>
&nbsp;
&nbsp; &nbsp; <span class="co2">#region Additional Authentication Methods</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span>LoginUserAuthentication<span class="sy0">&gt;</span> CreateUserAuthenticationAsync<span class="br0">&#40;</span>LoginUserAuthentication userAuth<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await _client<span class="sy0">.</span><span class="me1">CreateDocumentAsync</span><span class="br0">&#40;</span>GetAuthenticationsCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, userAuth, <span class="kw3">new</span> RequestOptions<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span> <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> JsonConvert<span class="sy0">.</span><span class="me1">DeserializeObject</span><span class="sy0">&lt;</span>LoginUserAuthentication<span class="sy0">&gt;</span><span class="br0">&#40;</span>result<span class="sy0">.</span><span class="me1">Resource</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> async Task<span class="sy0">&lt;</span><span class="kw4">bool</span><span class="sy0">&gt;</span> IsIdentityRegisteredAsync<span class="br0">&#40;</span>AuthenticationScheme authenticationScheme, <span class="kw4">string</span> identity<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> query <span class="sy0">=</span> _client<span class="sy0">.</span><span class="me1">CreateDocumentQuery</span><span class="sy0">&lt;</span><span class="kw4">int</span><span class="sy0">&gt;</span><span class="br0">&#40;</span>GetAuthenticationsCollectionUri<span class="br0">&#40;</span><span class="br0">&#41;</span>, <span class="kw3">new</span> SqlQuerySpec<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; QueryText <span class="sy0">=</span> <span class="st0">&quot;SELECT VALUE COUNT(1) FROM UserAuthentications UA WHERE UA.Scheme = @scheme AND UA.Identity = @identity&quot;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Parameters <span class="sy0">=</span> <span class="kw3">new</span> SqlParameterCollection<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> SqlParameter<span class="br0">&#40;</span><span class="st0">&quot;@scheme&quot;</span>, authenticationScheme<span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> SqlParameter<span class="br0">&#40;</span><span class="st0">&quot;@identity&quot;</span>, identity<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> await query<span class="sy0">.</span><span class="me1">AsDocumentQuery</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">ExecuteNextAsync</span><span class="sy0">&lt;</span><span class="kw4">int</span><span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> result<span class="sy0">.</span><span class="me1">Single</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> <span class="nu0">1</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="co2">#endregion</span>
&nbsp;
&nbsp; &nbsp; <span class="co1">// ...</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public class UserPersistence
{
    // ...

    public async Task EnsureSetupAsync()
    {
        var databaseUri = UriFactory.CreateDatabaseUri(_databaseId);

        // Collections
        // ...
        await _client.CreateDocumentCollectionIfNotExistsAsync(databaseUri, new DocumentCollection() { Id = AUTHS_DOCUMENT_COLLECTION_ID });
        // ...
    }

    #region Users

    // ...
        
    public async Task&lt;LoginUser&gt; GetUserByAuthenticationAsync(AuthenticationScheme authenticationScheme, string identity)
    {
        var query = _client.CreateDocumentQuery&lt;LoginUserAuthentication&gt;(GetAuthenticationsCollectionUri(), new SqlQuerySpec()
        {
            QueryText = "SELECT * FROM UserAuthentications UA WHERE UA.Scheme = @scheme AND UA.Identity = @identity",
            Parameters = new SqlParameterCollection()
            {
                new SqlParameter("@scheme", authenticationScheme),
                new SqlParameter("@identity", identity)
            }
        });
        var results = await query.AsDocumentQuery()
                                    .ExecuteNextAsync&lt;LoginUserAuthentication&gt;();
        if (results.Count == 0)
        {
            return null;
        }
        else
        {
            return await GetUserAsync(results.First().UserId);
        }
    }

    // ...

    public async Task DeleteUserAsync(LoginUser user)
    {
        await _client.DeleteDocumentAsync(UriFactory.CreateDocumentUri(_databaseId, USERS_DOCUMENT_COLLECTION_ID, user.Id));
    }

    #endregion

    #region Additional Authentication Methods

    public async Task&lt;LoginUserAuthentication&gt; CreateUserAuthenticationAsync(LoginUserAuthentication userAuth)
    {
        var result = await _client.CreateDocumentAsync(GetAuthenticationsCollectionUri(), userAuth, new RequestOptions() { });
        return JsonConvert.DeserializeObject&lt;LoginUserAuthentication&gt;(result.Resource.ToString());
    }


    public async Task&lt;bool&gt; IsIdentityRegisteredAsync(AuthenticationScheme authenticationScheme, string identity)
    {
        var query = _client.CreateDocumentQuery&lt;int&gt;(GetAuthenticationsCollectionUri(), new SqlQuerySpec()
        {
            QueryText = "SELECT VALUE COUNT(1) FROM UserAuthentications UA WHERE UA.Scheme = @scheme AND UA.Identity = @identity",
            Parameters = new SqlParameterCollection()
            {
                new SqlParameter("@scheme", authenticationScheme),
                new SqlParameter("@identity", identity)
            }
        });
        var result = await query.AsDocumentQuery()
                                .ExecuteNextAsync&lt;int&gt;();
        return result.Single() == 1;
    }

    #endregion

    // ...
}</pre></div></div>

<p>These all follow naturally from the methods created for prior posts. </p>
<h2>Wrapping Up, Next Steps</h2>
<p>Adding Twitter as an alternative interactive login method was pretty easy, once I figured out how the Middleware worked behind the scenes. Adding a second or third method would also be relatively easy, though I would likely want to use the Middleware options to remap specific claims like &#8220;urn:twitter:userid&#8221; and the matching value for LinkedIn or others to a common set of named claims to funnel redirects into a common set of callback URls.</p>
<p>Next up is the final Authentication post, adding in a per-request API key/secret method that relies on revocable API keys the user will manage as additional <code>LoginUserAuthentication</code> identities.</p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/webdev/serverprogramming/aspnet/custom-authentication-in-asp-net-core-2-w-cosmos-db/'>Custom Authentication in ASP.Net Core 2 w/ Cosmos DB</a><p>I'm building a B2C website with Cosmos DB as the backend store. This site will&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/webdev/serverprogramming/aspnet/asp-net-core-2-w-cosmosdb-getting-started/'>ASP.Net Core 2 w/ Cosmos DB: Getting Started</a><p>I am building the basic foundation for a B2C web application, using ASP.Net Core 2&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2><img class="bioPic" src="http://www.tiernok.com/images/RedShirt_80.jpg" alt="User bio image"/>My roles have included accidental DBA, lone developer, systems architect, team lead, VP of Engineering, and general troublemaker. On the technical front I work in web development, distributed systems, test automation, and devop-sy areas like delivery pipelines and integration of all the auditable things. <br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/tarwn" title="tarwn at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.linkedin.com/in/eliweinstockherman" title="tarwn at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="http://tiernok.com/" title="tarwn at HomePage" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_homepage.png" alt="HomePage" /></a><a href="https://plus.google.com/114520820167873768473" title="tarwn at Google Plus" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_gplus.png" alt="Google Plus" /></a><a href="/index.php/author/tarwn/feed/" title="Blog RSS feed for tarwn" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 5,235 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/tarwn/">Read More Posts by Eli Weinstock-Herman (tarwn)</a>
						</div>
					</div>
					<div>
						<label>Tags:</label> <a href="/index.php/tag/asp-net-core-2/" rel="tag">ASP.Net Core 2</a>, <a href="/index.php/tag/cosmosdb/" rel="tag">CosmosDB</a> 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&text=RT @LessThanDot Blog - Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB by @tarwn" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB&source=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&quote=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/&title=Adding Twitter Authentication to an ASP.Net Core 2 site w/ Cosmos DB" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		No comments posted so far	</h4>
					<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/webdev/serverprogramming/aspnet/adding-twitter-authentication-to-an-asp-net-core-2-site-w-cosmos-db/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='9170' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="918317b57931b6b7a7d29490fe5ec9f9"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765457"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
