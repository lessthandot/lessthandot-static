<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   SquishIt Integration with Amazon S3 / Cloudfront</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   SquishIt Integration with Amazon S3 / Cloudfront" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="For the unfortunate souls not in the know (or is it the fortunate souls using one of the myriad alternatives?), SquishIt is a library used to optimize content delivery at runtime in ASP.net applications.  It combines and minifies javascript files, and a&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; SquishIt Integration with Amazon S3 / Cloudfront Comments Feed" href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='The Tech on Tap v1.2 SharePoint Top 10' href='/index.php/itprofessionals/professionaldevelopment/the-tech-on-tap-v1/' />
<link rel='next' title='T-SQL Tuesday #31 – Reporting Services Logs' href='/index.php/datamgmt/dbadmin/t-sql-tuesday-31-reporting/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/" />
<link rel='shortlink' href='/?p=1646' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Fmaking-squishit-work-with-amazon%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Fmaking-squishit-work-with-amazon%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/datamgmt/dbadmin/t-sql-tuesday-31-reporting/" rel="next">T-SQL Tuesday #31 – Reporting Services Logs</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/itprofessionals/professionaldevelopment/the-tech-on-tap-v1/" rel="prev">The Tech on Tap v1.2 SharePoint Top 10</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/" class="post-title">SquishIt Integration with Amazon S3 / Cloudfront</a></h1>
					<div class="post-byline">by <a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich" rel="author">Alex Ullrich</a> on June 12, 2012 in category <a href="/index.php/category/webdev/serverprogramming/aspnet/" rel="category tag">ASP.NET</a> <a href="/index.php/category/webdev/serverprogramming/" rel="category tag">Server Programming</a>. Article views: 23,324 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&text=RT @LessThanDot Blog - SquishIt Integration with Amazon S3 / Cloudfront by @AlexCuse" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront&source=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&quote=SquishIt Integration with Amazon S3 / Cloudfront" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>For the unfortunate souls not in the know (or is it the fortunate souls using one of the myriad alternatives?), <a href="https://github.com/jetheredge/SquishIt">SquishIt</a> is a library used to optimize content delivery at runtime in ASP.net applications.  It combines and minifies javascript files, and also does a bit of preprocessing for things like <a href="http://lesscss.org/">LESS</a> and <a href="http://coffeescript.org/">CoffeeScript</a>.  I&#8217;ve been working with Justin Etheredge (<a href="http://www.codethinked.com/">blog</a>|<a href="https://twitter.com/#!/justinetheredge">twitter</a>) on this for a while, first on patches for various bugs I encountered trying to use SquishIt on linux, but more recently my focus has been on improving extensibility.  One of the areas that I really felt the library could benefit from increased extensibility is the area of CDN support.  I&#8217;ve been doing a lot of work with Amazon CloudFront lately, and decided it would be cool to see how cleanly I could get SquishIt to work with the service.</p>
<h3>SquishIt CDN Support in Previous Versions</h3>
<p>I suppose it makes sense to start with what we already had in place.  CDN support in SquishIt has been slowly progressing, largely thanks to community contributions.  As of version 0.8.6 we did have support for injecting a base URL into asset paths, but this required you to know the generated file name in advance and upload it to your CDN through other means.  While this worked, and could be easily automated in your build process, it wasn&#8217;t exactly convenient.  The pull requests we&#8217;ve gotten have done a fairly good job showing us what the community wants in terms of CDN support, so it feels like it is time to start trying to treat it as a first class citizen.    The first thing I would like is a way to render the combined file directly to my CDN if it doesn&#8217;t already exist, and maybe a way to force overwriting the file if need be.</p>
<h3>Adding Support for Custom Renderers</h3>
<p>For a while now, SquishIt has had an IRenderer interface.  It has been there, but it has only been used internally to support rendering to the file system or to an in-memory cache.  To get started, we needed to expose this interface publicly so that other assemblies could provide implementations.  Once exposed, we need to enable consumers to supply their custom renderers to the SquishIt core somehow.</p>
<p>SquishIt uses a fluent configuration syntax for setting up individual bundles, and that seemed as good a place to start as any.  Typical usage looks something like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1">Bundle<span class="sy0">.</span><span class="me1">JavaScript</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithAttribute</span><span class="br0">&#40;</span><span class="st0">&quot;attrName&quot;</span>, <span class="st0">&quot;attrValue&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="st0">&quot;file1.js&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="st0">&quot;/otherscripts/file2.js&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">Render</span><span class="br0">&#40;</span><span class="st0">&quot;combinedOutput.js&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">Bundle.JavaScript()
    .WithAttribute("attrName", "attrValue")
    .Add("file1.js")
    .Add("/otherscripts/file2.js")
    .Render("combinedOutput.js");</pre></div></div>

<p>So the first thing that came to mind was to add something like a &#8220;WithFileRenderer&#8221; method.  This would give us a way to inject a renderer into a bundle and have it used to render the combined files.  However, we probably don&#8217;t want to render to the CDN while debugging, so &#8220;WithReleaseFileRenderer&#8221; might be more appropriate.   Setting up the method went something like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1">IRenderer releaseFileRenderer<span class="sy0">;</span>
&nbsp;
<span class="kw1">public</span> T WithReleaseFileRenderer<span class="br0">&#40;</span>IRenderer renderer<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">releaseFileRenderer</span> <span class="sy0">=</span> renderer<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="br0">&#40;</span>T<span class="br0">&#41;</span><span class="kw1">this</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">IRenderer releaseFileRenderer;

public T WithReleaseFileRenderer(IRenderer renderer)
{
    this.releaseFileRenderer = renderer;
    return (T)this;
}</pre></div></div>

<p>We also want a way to configure this globally, to do that we needed to add a bit to our configuration class.  This was basically the same thing:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1">IRenderer _defaultReleaseRenderer<span class="sy0">;</span>
<span class="kw1">public</span> Configuration UseReleaseRenderer<span class="br0">&#40;</span>IRenderer releaseRenderer<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; _defaultReleaseRenderer <span class="sy0">=</span> releaseRenderer<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">this</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">IRenderer _defaultReleaseRenderer;
public Configuration UseReleaseRenderer(IRenderer releaseRenderer)
{
    _defaultReleaseRenderer = releaseRenderer;
    return this;
}</pre></div></div>

<p>Finally, we need to change the way the file renderer is obtained when we go to render the combined assets.  Previously we were instantiating a new FileRenderer or CacheRenderer depending on circumstance, and passing that renderer into the main rendering method.  This won&#8217;t cut it anymore, as our needs have gotten significantly more complex.  The constraints we have to deal with are as follows:</p>
<ul>
<li>When debugging we should use a normal file renderer</li>
<li>We should favor a renderer configured at the instance level over one configured statically</li>
<li>If no instance or static renderer is configured we should use the old default behavior</li>
</ul>
<p>So the constructor calls for a new FileRenderer are replaced with calls to this method:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">protected</span> IRenderer GetFileRenderer<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> debugStatusReader<span class="sy0">.</span><span class="me1">IsDebuggingEnabled</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">?</span> <span class="kw3">new</span> FileRenderer<span class="br0">&#40;</span>fileWriterFactory<span class="br0">&#41;</span> <span class="sy0">:</span>
&nbsp; &nbsp; &nbsp; &nbsp; bundleState<span class="sy0">.</span><span class="me1">ReleaseFileRenderer</span> <span class="sy0">??</span>
&nbsp; &nbsp; &nbsp; &nbsp; Configuration<span class="sy0">.</span><span class="me1">Instance</span><span class="sy0">.</span><span class="me1">DefaultReleaseRenderer</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">??</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw3">new</span> FileRenderer<span class="br0">&#40;</span>fileWriterFactory<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">protected IRenderer GetFileRenderer()
{
    return debugStatusReader.IsDebuggingEnabled() ? new FileRenderer(fileWriterFactory) :
        bundleState.ReleaseFileRenderer ??
        Configuration.Instance.DefaultReleaseRenderer() ??
        new FileRenderer(fileWriterFactory);
}</pre></div></div>

<p>This is basically all we needed to do to enable us to plug in a custom renderer to use in release mode.  Now we can look at how we can make the CDN integration happen.</p>
<h3>Building the S3 Keys</h3>
<p>The only really tricky thing about building the renderer is that it takes a string representing the disk location to render to.  Changing what the renderer takes as a parameter would involve a more significant change to the core behavior than I&#8217;m comfortable making right now, so the first thing we need is a way to turn these disk locations into keys that S3 can use.  The key we create needs to match the relative path to that of the locally-rendered asset so that injecting the base url will yield the absolute path that we need.</p>
<p>None of this is terribly difficult &#8211; the main edge cases we need to cover are</p>
<ul>
<li>Root appearing twice in the file path (because of Windows&#8217; drive lettering this is mostly an issue running on unix-based systems)</li>
<li>Virtual directories</li>
</ul>
<p>To meet these requirements the two pieces of information that we need inside the key builder are the physical application path and virtual directory.  Here are some tests:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">void</span> ReturnToRelative<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> root <span class="sy0">=</span> <span class="st_h">@&quot;C:fakedir&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> file <span class="sy0">=</span> <span class="st_h">@&quot;anotherfile.js&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> expected <span class="sy0">=</span> <span class="st_h">@&quot;another/file.js&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> builder <span class="sy0">=</span> <span class="kw3">new</span> KeyBuilder<span class="br0">&#40;</span>root, <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Assert<span class="sy0">.</span><span class="me1">AreEqual</span><span class="br0">&#40;</span>expected, builder<span class="sy0">.</span><span class="me1">GetKeyFor</span><span class="br0">&#40;</span>root <span class="sy0">+</span> file<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">void</span> ReturnToRelative_Injects_Virtual_Directory<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> root <span class="sy0">=</span> <span class="st_h">@&quot;C:fakedir&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> file <span class="sy0">=</span> <span class="st_h">@&quot;anotherfile.js&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> vdir <span class="sy0">=</span> <span class="st0">&quot;/this&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> expected <span class="sy0">=</span> <span class="st_h">@&quot;this/another/file.js&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> builder <span class="sy0">=</span> <span class="kw3">new</span> KeyBuilder<span class="br0">&#40;</span>root, vdir<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Assert<span class="sy0">.</span><span class="me1">AreEqual</span><span class="br0">&#40;</span>expected, builder<span class="sy0">.</span><span class="me1">GetKeyFor</span><span class="br0">&#40;</span>root <span class="sy0">+</span> file<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">void</span> ReturnToRelative_Only_Replaces_First_Occurrence_Of_Root<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> root <span class="sy0">=</span> <span class="st_h">@&quot;test/&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> file <span class="sy0">=</span> <span class="st_h">@&quot;another/andthen/test/again.js&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> expected <span class="sy0">=</span> <span class="st_h">@&quot;another/andthen/test/again.js&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> builder <span class="sy0">=</span> <span class="kw3">new</span> KeyBuilder<span class="br0">&#40;</span>root, <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Assert<span class="sy0">.</span><span class="me1">AreEqual</span><span class="br0">&#40;</span>expected, builder<span class="sy0">.</span><span class="me1">GetKeyFor</span><span class="br0">&#40;</span>root <span class="sy0">+</span> file<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[Test]
public void ReturnToRelative()
{
    var root = @"C:fakedir";
    var file = @"anotherfile.js";
    var expected = @"another/file.js";

    var builder = new KeyBuilder(root, "");
    Assert.AreEqual(expected, builder.GetKeyFor(root + file));
}

[Test]
public void ReturnToRelative_Injects_Virtual_Directory()
{
    var root = @"C:fakedir";
    var file = @"anotherfile.js";
    var vdir = "/this";
    var expected = @"this/another/file.js";

    var builder = new KeyBuilder(root, vdir);
    Assert.AreEqual(expected, builder.GetKeyFor(root + file));
}

[Test]
public void ReturnToRelative_Only_Replaces_First_Occurrence_Of_Root()
{
    var root = @"test/";
    var file = @"another/andthen/test/again.js";
    var expected = @"another/andthen/test/again.js";

    var builder = new KeyBuilder(root, "");
    Assert.AreEqual(expected, builder.GetKeyFor(root + file));
}</pre></div></div>

<p>And the implementation for the KeyBuilder:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="de1"><pre class="de1"><span class="kw1">internal</span> <span class="kw4">class</span> KeyBuilder <span class="sy0">:</span> IKeyBuilder
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">readonly</span> <span class="kw4">string</span> physicalApplicationPath<span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">readonly</span> <span class="kw4">string</span> virtualDirectory<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> KeyBuilder<span class="br0">&#40;</span><span class="kw4">string</span> physicalApplicationPath, <span class="kw4">string</span> virtualDirectory<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">physicalApplicationPath</span> <span class="sy0">=</span> physicalApplicationPath<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">virtualDirectory</span> <span class="sy0">=</span> virtualDirectory<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">string</span> GetKeyFor<span class="br0">&#40;</span><span class="kw4">string</span> path<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> RelativeFromAbsolutePath<span class="br0">&#40;</span>path<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">TrimStart</span><span class="br0">&#40;</span><span class="st0">'/'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw4">string</span> RelativeFromAbsolutePath<span class="br0">&#40;</span><span class="kw4">string</span> path<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; path <span class="sy0">=</span> path<span class="sy0">.</span><span class="me1">StartsWith</span><span class="br0">&#40;</span>physicalApplicationPath<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">?</span> path<span class="sy0">.</span><span class="me1">Substring</span><span class="br0">&#40;</span>physicalApplicationPath<span class="sy0">.</span><span class="me1">Length</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">:</span> path<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> virtualDirectory <span class="sy0">+</span> <span class="st0">&quot;/&quot;</span> <span class="sy0">+</span> path<span class="sy0">.</span><span class="me1">Replace</span><span class="br0">&#40;</span><span class="st_h">@&quot;&quot;</span>, <span class="st0">&quot;/&quot;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">TrimStart</span><span class="br0">&#40;</span><span class="st0">'/'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">internal class KeyBuilder : IKeyBuilder
{
    readonly string physicalApplicationPath;
    readonly string virtualDirectory;

    public KeyBuilder(string physicalApplicationPath, string virtualDirectory)
    {
        this.physicalApplicationPath = physicalApplicationPath;
        this.virtualDirectory = virtualDirectory;
    }

    public string GetKeyFor(string path)
    {
        return RelativeFromAbsolutePath(path).TrimStart('/');
    }

    string RelativeFromAbsolutePath(string path)
    {
        path = path.StartsWith(physicalApplicationPath)
                        ? path.Substring(physicalApplicationPath.Length)
                        : path;

        return virtualDirectory + "/" + path.Replace(@"", "/").TrimStart('/');
    }
}</pre></div></div>

<p>Now that we have a means to build keys we can look at implementing the S3 Renderer.</p>
<h3>S3 Renderer Implementation</h3>
<p>The interface for renderers is very simple.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">interface</span> IRenderer
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw4">void</span> Render<span class="br0">&#40;</span><span class="kw4">string</span> content, <span class="kw4">string</span> outputPath<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public interface IRenderer
{
    void Render(string content, string outputPath);
}</pre></div></div>

<p>The only things we&#8217;ll need to implement this method are an initialized S3 client, a bucket and the key builder we implemented in the last section.  By default, we won&#8217;t want to upload our content if it already exists on the CDN, so we will need to check for existence before uploading the content.  This can be done by querying for object metadata using the desired key &#8211; if the file doesn&#8217;t exist we will get a &#8220;not found&#8221; status on the exception thrown by the s3 client.  So the most important test will look like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">void</span> Render_Uploads_If_File_Doesnt_Exist<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> s3client <span class="sy0">=</span> <span class="kw3">new</span> Mock<span class="sy0">&lt;</span>AmazonS3<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> keyBuilder <span class="sy0">=</span> <span class="kw3">new</span> Mock<span class="sy0">&lt;</span>IKeyBuilder<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> key <span class="sy0">=</span> <span class="st0">&quot;key&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> bucket <span class="sy0">=</span> <span class="st0">&quot;bucket&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> path <span class="sy0">=</span> <span class="st0">&quot;path&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> content <span class="sy0">=</span> <span class="st0">&quot;content&quot;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; keyBuilder<span class="sy0">.</span><span class="me1">Setup</span><span class="br0">&#40;</span>kb <span class="sy0">=&gt;</span> kb<span class="sy0">.</span><span class="me1">GetKeyFor</span><span class="br0">&#40;</span>path<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">Returns</span><span class="br0">&#40;</span>key<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; s3client<span class="sy0">.</span><span class="me1">Setup</span><span class="br0">&#40;</span>c <span class="sy0">=&gt;</span> c<span class="sy0">.</span><span class="me1">GetObjectMetadata</span><span class="br0">&#40;</span>It<span class="sy0">.</span><span class="kw3">Is</span><span class="sy0">&lt;</span>GetObjectMetadataRequest<span class="sy0">&gt;</span><span class="br0">&#40;</span>gomr <span class="sy0">=&gt;</span> gomr<span class="sy0">.</span><span class="me1">BucketName</span> <span class="sy0">==</span> bucket <span class="sy0">&amp;&amp;</span> gomr<span class="sy0">.</span><span class="me1">Key</span> <span class="sy0">==</span> key<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="me1">Throws</span><span class="br0">&#40;</span><span class="kw3">new</span> AmazonS3Exception<span class="br0">&#40;</span><span class="st0">&quot;&quot;</span>, HttpStatusCode<span class="sy0">.</span><span class="me1">NotFound</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">using</span><span class="br0">&#40;</span><span class="kw1">var</span> renderer <span class="sy0">=</span> S3Renderer<span class="sy0">.</span><span class="me1">Create</span><span class="br0">&#40;</span>s3client<span class="sy0">.</span><span class="kw4">Object</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>bucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithKeyBuilder</span><span class="br0">&#40;</span>keyBuilder<span class="sy0">.</span><span class="kw4">Object</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; renderer<span class="sy0">.</span><span class="me1">Render</span><span class="br0">&#40;</span>content, path<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; s3client<span class="sy0">.</span><span class="me1">Verify</span><span class="br0">&#40;</span>c <span class="sy0">=&gt;</span> c<span class="sy0">.</span><span class="me1">PutObject</span><span class="br0">&#40;</span>It<span class="sy0">.</span><span class="kw3">Is</span><span class="sy0">&lt;</span>PutObjectRequest<span class="sy0">&gt;</span><span class="br0">&#40;</span>por <span class="sy0">=&gt;</span> por<span class="sy0">.</span><span class="me1">Key</span> <span class="sy0">==</span> key <span class="sy0">&amp;&amp;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; por<span class="sy0">.</span><span class="me1">BucketName</span> <span class="sy0">==</span> bucket <span class="sy0">&amp;&amp;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; por<span class="sy0">.</span><span class="me1">ContentBody</span> <span class="sy0">==</span> content <span class="sy0">&amp;&amp;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; por<span class="sy0">.</span><span class="me1">CannedACL</span> <span class="sy0">==</span> S3CannedACL<span class="sy0">.</span><span class="me1">NoACL</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[Test]
public void Render_Uploads_If_File_Doesnt_Exist()
{
    var s3client = new Mock&lt;AmazonS3&gt;();
    var keyBuilder = new Mock&lt;IKeyBuilder&gt;();

    var key = "key";
    var bucket = "bucket";
    var path = "path";
    var content = "content";

    keyBuilder.Setup(kb =&gt; kb.GetKeyFor(path)).Returns(key);

    s3client.Setup(c =&gt; c.GetObjectMetadata(It.Is&lt;GetObjectMetadataRequest&gt;(gomr =&gt; gomr.BucketName == bucket &amp;&amp; gomr.Key == key))).
        Throws(new AmazonS3Exception("", HttpStatusCode.NotFound));

    using(var renderer = S3Renderer.Create(s3client.Object)
                            .WithBucketName(bucket)
                            .WithKeyBuilder(keyBuilder.Object))
    {
        renderer.Render(content, path);
    }

    s3client.Verify(c =&gt; c.PutObject(It.Is&lt;PutObjectRequest&gt;(por =&gt; por.Key == key &amp;&amp;
                                                                        por.BucketName == bucket &amp;&amp;
                                                                        por.ContentBody == content &amp;&amp;
                                                                        por.CannedACL == S3CannedACL.NoACL)));
}</pre></div></div>

<p>Note that it is checking the PutObjectRequest to ensure that the ACL used is &#8220;NoACL&#8221;.  This is probably not an optimal default (most people will want the &#8220;PublicRead&#8221; ACL I imagine) but I decided to err on the side of caution and force people to opt-in to making their content publicly visible.  The implementation for the render method looks something like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">void</span> Render<span class="br0">&#40;</span><span class="kw4">string</span> content, <span class="kw4">string</span> outputPath<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>outputPath<span class="br0">&#41;</span> <span class="sy0">||</span> <span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrEmpty</span><span class="br0">&#40;</span>content<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">throw</span> <span class="kw3">new</span> InvalidOperationException<span class="br0">&#40;</span><span class="st0">&quot;Can't render to S3 with missing key/content.&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> key <span class="sy0">=</span> keyBuilder<span class="sy0">.</span><span class="me1">GetKeyFor</span><span class="br0">&#40;</span>outputPath<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>FileExists<span class="br0">&#40;</span>key<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; UploadContent<span class="br0">&#40;</span>key, content<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">void</span> UploadContent<span class="br0">&#40;</span><span class="kw4">string</span> key, <span class="kw4">string</span> content<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> PutObjectRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>bucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithKey</span><span class="br0">&#40;</span>key<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithCannedACL</span><span class="br0">&#40;</span>cannedACL<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithContentBody</span><span class="br0">&#40;</span>content<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; s3client<span class="sy0">.</span><span class="me1">PutObject</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw4">bool</span> FileExists<span class="br0">&#40;</span><span class="kw4">string</span> key<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> GetObjectMetadataRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>bucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithKey</span><span class="br0">&#40;</span>key<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> response <span class="sy0">=</span> s3client<span class="sy0">.</span><span class="me1">GetObjectMetadata</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">true</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="kw1">catch</span><span class="br0">&#40;</span>AmazonS3Exception ex<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>ex<span class="sy0">.</span><span class="me1">StatusCode</span> <span class="sy0">==</span> HttpStatusCode<span class="sy0">.</span><span class="me1">NotFound</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">false</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">throw</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public void Render(string content, string outputPath)
{
    if(string.IsNullOrEmpty(outputPath) || string.IsNullOrEmpty(content)) throw new InvalidOperationException("Can't render to S3 with missing key/content.");

    var key = keyBuilder.GetKeyFor(outputPath);
    if(!FileExists(key))
    {
        UploadContent(key, content);
    }
}

void UploadContent(string key, string content)
{
    var request = new PutObjectRequest()
        .WithBucketName(bucket)
        .WithKey(key)
        .WithCannedACL(cannedACL)
        .WithContentBody(content);

    s3client.PutObject(request);
}

bool FileExists(string key)
{
    try
    {
        var request = new GetObjectMetadataRequest()
            .WithBucketName(bucket)
            .WithKey(key);

        var response = s3client.GetObjectMetadata(request);

        return true;
    }
    catch(AmazonS3Exception ex)
    {
        if(ex.StatusCode == HttpStatusCode.NotFound)
        {
            return false;
        }
        throw;
    }
}</pre></div></div>

<p>It has gotten slightly more complex since then (I&#8217;ve added configurable headers and an option for forcing overwrite of the existing file) but the core logic remains the same.  It&#8217;s a fairly naive implementation but my experience with the Amazon services has been good enough so far that I haven&#8217;t encountered a lot of the exceptions that I hope to add handling for in the future.</p>
<h3>Adding Invalidation</h3>
<p>At this point we should be able to render our content directly to S3, but this doesn&#8217;t get us all the way to where we need to be.  While hosting static content in S3 offers some advantages over hosting it locally and it <strong>can</strong> work as a CDN, using CloudFront to deliver your S3 content makes more sense if you really want to minimize latency.  To make this work we&#8217;ll just need to add an invaliator to the mix.  A test for the core usage looks like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="de1"><pre class="de1"><span class="br0">&#91;</span>Test<span class="br0">&#93;</span>
<span class="kw1">public</span> <span class="kw4">void</span> Invalidate<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> cloudfrontClient <span class="sy0">=</span> <span class="kw3">new</span> Mock<span class="sy0">&lt;</span>AmazonCloudFront<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> distributionId <span class="sy0">=</span> Guid<span class="sy0">.</span><span class="me1">NewGuid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> bucket <span class="sy0">=</span> Guid<span class="sy0">.</span><span class="me1">NewGuid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> distribution <span class="sy0">=</span> bucket <span class="sy0">+</span> <span class="st0">&quot;.s3.amazonaws.com&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> key <span class="sy0">=</span> Guid<span class="sy0">.</span><span class="me1">NewGuid</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> listDistributionsResponse <span class="sy0">=</span> <span class="kw3">new</span> ListDistributionsResponse<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; listDistributionsResponse<span class="sy0">.</span><span class="me1">Distribution</span><span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="kw3">new</span> CloudFrontDistribution
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Id <span class="sy0">=</span> distributionId,
&nbsp; &nbsp; &nbsp; &nbsp; DistributionConfig <span class="sy0">=</span> <span class="kw3">new</span> CloudFrontDistributionConfig
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; S3Origin <span class="sy0">=</span> <span class="kw3">new</span> S3Origin<span class="br0">&#40;</span>distribution, <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; cloudfrontClient<span class="sy0">.</span><span class="me1">Setup</span><span class="br0">&#40;</span>cfc <span class="sy0">=&gt;</span> cfc<span class="sy0">.</span><span class="me1">ListDistributions</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">Returns</span><span class="br0">&#40;</span>listDistributionsResponse<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> invalidator <span class="sy0">=</span> <span class="kw3">new</span> CloudFrontInvalidator<span class="br0">&#40;</span>cloudfrontClient<span class="sy0">.</span><span class="kw4">Object</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; invalidator<span class="sy0">.</span><span class="me1">InvalidateObject</span><span class="br0">&#40;</span>bucket, key<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; cloudfrontClient<span class="sy0">.</span><span class="me1">Verify</span><span class="br0">&#40;</span>cfc <span class="sy0">=&gt;</span> cfc<span class="sy0">.</span><span class="me1">PostInvalidation</span><span class="br0">&#40;</span>It<span class="sy0">.</span><span class="kw3">Is</span><span class="sy0">&lt;</span>PostInvalidationRequest<span class="sy0">&gt;</span><span class="br0">&#40;</span>pir <span class="sy0">=&gt;</span> pir<span class="sy0">.</span><span class="me1">DistributionId</span> <span class="sy0">==</span> distributionId
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">&amp;&amp;</span> pir<span class="sy0">.</span><span class="me1">InvalidationBatch</span><span class="sy0">.</span><span class="me1">Paths</span><span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">==</span> <span class="nu0">1</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">&amp;&amp;</span> pir<span class="sy0">.</span><span class="me1">InvalidationBatch</span><span class="sy0">.</span><span class="me1">Paths</span><span class="sy0">.</span><span class="me1">First</span><span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="sy0">==</span> key<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">[Test]
public void Invalidate()
{
    var cloudfrontClient = new Mock&lt;AmazonCloudFront&gt;();

    var distributionId = Guid.NewGuid().ToString();
    var bucket = Guid.NewGuid().ToString();
    var distribution = bucket + ".s3.amazonaws.com";
    var key = Guid.NewGuid().ToString();

    var listDistributionsResponse = new ListDistributionsResponse();
    listDistributionsResponse.Distribution.Add(new CloudFrontDistribution
    {
        Id = distributionId,
        DistributionConfig = new CloudFrontDistributionConfig
        {
            S3Origin = new S3Origin(distribution, null)
        }
    });

    cloudfrontClient.Setup(cfc =&gt; cfc.ListDistributions())
        .Returns(listDistributionsResponse);

    var invalidator = new CloudFrontInvalidator(cloudfrontClient.Object);
    invalidator.InvalidateObject(bucket, key);

    cloudfrontClient.Verify(cfc =&gt; cfc.PostInvalidation(It.Is&lt;PostInvalidationRequest&gt;(pir =&gt; pir.DistributionId == distributionId
        &amp;&amp; pir.InvalidationBatch.Paths.Count == 1
        &amp;&amp; pir.InvalidationBatch.Paths.First() == key)));
}</pre></div></div>

<p>The implementation is pretty straightforward, and will look very familiar to anyone who read my post regarding <a href="/index.php/WebDev/ServerProgramming/copying-buckets-with-the-amazon-s3-api">copying buckets with the S3 API</a>.  There are only two changes, first that we only need to invalidate one object at a time, and second that we only want to query for the list of CloudFront distributions once.  Code for the CloudFront invalidator looks like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="de1"><pre class="de1"><span class="kw4">class</span> CloudFrontInvalidator <span class="sy0">:</span> IDisposable, IInvalidator
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">const</span> <span class="kw4">string</span> amazonBucketUriSuffix <span class="sy0">=</span> <span class="st0">&quot;.s3.amazonaws.com&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">const</span> <span class="kw4">string</span> dateFormatWithMilliseconds <span class="sy0">=</span> <span class="st0">&quot;yyyy-MM-dd hh:mm:ss.ff&quot;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">readonly</span> AmazonCloudFront cloudFrontClient<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> CloudFrontInvalidator<span class="br0">&#40;</span>AmazonCloudFront cloudFrontClient<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">this</span><span class="sy0">.</span><span class="me1">cloudFrontClient</span> <span class="sy0">=</span> cloudFrontClient<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> InvalidateObject<span class="br0">&#40;</span><span class="kw4">string</span> bucket, <span class="kw4">string</span> key<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> distId <span class="sy0">=</span> GetDistributionIdFor<span class="br0">&#40;</span>bucket<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrWhiteSpace</span><span class="br0">&#40;</span>distId<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> invalidationRequest <span class="sy0">=</span> <span class="kw3">new</span> PostInvalidationRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDistribtionId</span><span class="br0">&#40;</span>distId<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithInvalidationBatch</span><span class="br0">&#40;</span><span class="kw3">new</span> InvalidationBatch<span class="br0">&#40;</span>DateTime<span class="sy0">.</span><span class="me1">Now</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span>dateFormatWithMilliseconds<span class="br0">&#41;</span>, <span class="kw3">new</span> List<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> <span class="br0">&#123;</span> key <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cloudFrontClient<span class="sy0">.</span><span class="me1">PostInvalidation</span><span class="br0">&#40;</span>invalidationRequest<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; Dictionary<span class="sy0">&lt;</span><span class="kw4">string</span>, <span class="kw4">string</span><span class="sy0">&gt;</span> distributionNameAndIds<span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw4">string</span> GetDistributionIdFor<span class="br0">&#40;</span><span class="kw4">string</span> bucketName<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; distributionNameAndIds <span class="sy0">=</span> distributionNameAndIds <span class="sy0">??</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cloudFrontClient<span class="sy0">.</span><span class="me1">ListDistributions</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">Distribution</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">ToDictionary</span><span class="br0">&#40;</span>cfd <span class="sy0">=&gt;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cfd<span class="sy0">.</span><span class="me1">DistributionConfig</span><span class="sy0">.</span><span class="me1">S3Origin</span><span class="sy0">.</span><span class="me1">DNSName</span><span class="sy0">.</span><span class="me1">Replace</span><span class="br0">&#40;</span>amazonBucketUriSuffix, <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; cfd <span class="sy0">=&gt;</span> cfd<span class="sy0">.</span><span class="me1">Id</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw4">string</span> id <span class="sy0">=</span> <span class="kw1">null</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; distributionNameAndIds<span class="sy0">.</span><span class="me1">TryGetValue</span><span class="br0">&#40;</span>bucketName, <span class="kw1">out</span> id<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">return</span> id<span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">public</span> <span class="kw4">void</span> Dispose<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; cloudFrontClient<span class="sy0">.</span><span class="me1">Dispose</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">class CloudFrontInvalidator : IDisposable, IInvalidator
{
    const string amazonBucketUriSuffix = ".s3.amazonaws.com";
    const string dateFormatWithMilliseconds = "yyyy-MM-dd hh:mm:ss.ff";
    readonly AmazonCloudFront cloudFrontClient;

    public CloudFrontInvalidator(AmazonCloudFront cloudFrontClient)
    {
        this.cloudFrontClient = cloudFrontClient;
    }

    public void InvalidateObject(string bucket, string key)
    {
        var distId = GetDistributionIdFor(bucket);
        if(!string.IsNullOrWhiteSpace(distId))
        {
            var invalidationRequest = new PostInvalidationRequest()
                .WithDistribtionId(distId)
                .WithInvalidationBatch(new InvalidationBatch(DateTime.Now.ToString(dateFormatWithMilliseconds), new List&lt;string&gt; { key }));

            cloudFrontClient.PostInvalidation(invalidationRequest);
        }
    }

    Dictionary&lt;string, string&gt; distributionNameAndIds;

    string GetDistributionIdFor(string bucketName)
    {
        distributionNameAndIds = distributionNameAndIds ??
            cloudFrontClient.ListDistributions()
            .Distribution
            .ToDictionary(cfd =&gt;
                cfd.DistributionConfig.S3Origin.DNSName.Replace(amazonBucketUriSuffix, ""),
                cfd =&gt; cfd.Id);

        string id = null;
        distributionNameAndIds.TryGetValue(bucketName, out id);
        return id;
    }

    public void Dispose()
    {
        cloudFrontClient.Dispose();
    }
}</pre></div></div>

<p>As an interesting aside, while I was working on this Amazon released <a href="http://aws.amazon.com/releasenotes/7875688065681094">support for querystring invalidation/versioning</a>, which is SquishIt&#8217;s default behavior.  I had planned to add a release note telling people that they would need to use squishit&#8217;s &#8220;hash in filename&#8221; option, but it seems like now there won&#8217;t be any need 🙂</p>
<h3>Neat, But How Do I Use This?</h3>
<p>It&#8217;s nice that this all works on paper (and in unit tests) but how do we actually tie everything together?  One of the key design decisions was that the renderer is instantiated with pre-initialized CloudFront and S3 clients.  This way users aren&#8217;t locked into a certain method of getting credentials or anything like that.  To use the custom renderer for only a particular bundle usage would be something like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">var</span> s3client <span class="sy0">=</span> <span class="kw3">new</span> AmazonS3Client<span class="br0">&#40;</span><span class="st0">&quot;accessKey&quot;</span>, <span class="st0">&quot;secretKey&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">var</span> renderer <span class="sy0">=</span> S3Renderer<span class="sy0">.</span><span class="me1">Create</span><span class="br0">&#40;</span>s3client<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span><span class="st0">&quot;bucket&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDefaultKeyBuilder</span><span class="br0">&#40;</span>HttpContext<span class="sy0">.</span><span class="me1">Current</span><span class="sy0">.</span><span class="me1">Request</span><span class="sy0">.</span><span class="me1">PhysicalApplicationPath</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HttpContext<span class="sy0">.</span><span class="me1">Current</span><span class="sy0">.</span><span class="me1">Request</span><span class="sy0">.</span><span class="me1">ApplicationPath</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithCannedAcl</span><span class="br0">&#40;</span>S3CannedACL<span class="sy0">.</span><span class="me1">PublicRead</span><span class="br0">&#41;</span> <span class="kw1">as</span> IRenderer<span class="sy0">;</span>
&nbsp;
Bundle<span class="sy0">.</span><span class="me1">JavaScript</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithReleaseFileRenderer</span><span class="br0">&#40;</span>renderer<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithOutputBaseHref</span><span class="br0">&#40;</span><span class="st0">&quot;http://s3.amazonaws.com/bucket&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="st0">&quot;file1.js&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#40;</span><span class="st0">&quot;file2.js&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">Render</span><span class="br0">&#40;</span><span class="st0">&quot;combined.js&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">var s3client = new AmazonS3Client("accessKey", "secretKey");
var renderer = S3Renderer.Create(s3client)
    .WithBucketName("bucket")
    .WithDefaultKeyBuilder(HttpContext.Current.Request.PhysicalApplicationPath,
                                    HttpContext.Current.Request.ApplicationPath)
    .WithCannedAcl(S3CannedACL.PublicRead) as IRenderer;

Bundle.JavaScript()
    .WithReleaseFileRenderer(renderer)
    .WithOutputBaseHref("http://s3.amazonaws.com/bucket")
    .Add("file1.js")
    .Add("file2.js")
    .Render("combined.js");</pre></div></div>

<p>This is nice, but I think the global configuration is probably what people will be using more often.  As is common in ASP.net apps a lot of the setup magic for this happens in the app initialization.  So you&#8217;d add something like this to your Application_Start method (in Global.asax.cs):</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="de1"><pre class="de1"><span class="kw1">var</span> s3client <span class="sy0">=</span> <span class="kw3">new</span> AmazonS3Client<span class="br0">&#40;</span><span class="st0">&quot;accessKey&quot;</span>, <span class="st0">&quot;secretKey&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="kw1">var</span> renderer <span class="sy0">=</span> S3Renderer<span class="sy0">.</span><span class="me1">Create</span><span class="br0">&#40;</span>s3client<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span><span class="st0">&quot;bucket&quot;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDefaultKeyBuilder</span><span class="br0">&#40;</span>HttpContext<span class="sy0">.</span><span class="me1">Current</span><span class="sy0">.</span><span class="me1">Request</span><span class="sy0">.</span><span class="me1">PhysicalApplicationPath</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; HttpContext<span class="sy0">.</span><span class="me1">Current</span><span class="sy0">.</span><span class="me1">Request</span><span class="sy0">.</span><span class="me1">ApplicationPath</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithCannedAcl</span><span class="br0">&#40;</span>S3CannedACL<span class="sy0">.</span><span class="me1">PublicRead</span><span class="br0">&#41;</span> <span class="kw1">as</span> IRenderer<span class="sy0">;</span>
&nbsp;
Bundle<span class="sy0">.</span><span class="me1">ConfigureDefaults</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">UseReleaseRenderer</span><span class="br0">&#40;</span>renderer<span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="sy0">.</span><span class="me1">UseDefaultOutputBaseHref</span><span class="br0">&#40;</span><span class="st0">&quot;http://s3.amazonaws.com/bucket&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">var s3client = new AmazonS3Client("accessKey", "secretKey");
var renderer = S3Renderer.Create(s3client)
    .WithBucketName("bucket")
    .WithDefaultKeyBuilder(HttpContext.Current.Request.PhysicalApplicationPath,
                                    HttpContext.Current.Request.ApplicationPath)
    .WithCannedAcl(S3CannedACL.PublicRead) as IRenderer;

Bundle.ConfigureDefaults()
    .UseReleaseRenderer(renderer)
    .UseDefaultOutputBaseHref("http://s3.amazonaws.com/bucket");</pre></div></div>

<p>I tried to make this something that could be run via WebActivator, but had trouble finding a method to use that would have access to the HttpContext (needed to resolve application path and virtual directory) so for now it needs to be set up manually.  This may be for the best though, as it doesn&#8217;t force any particular convention for access key / secret key retrieval.  It doesn&#8217;t <strong>feel</strong> like a ton of setup code to me, hopefully others will agree.</p>
<h3>What&#8217;s Next</h3>
<p>Now that SquishIt 0.8.7 has been released I can finally start planning to make this available <a href="http://nuget.org/packages/SquishIt.S3">on NuGet</a> as a standard package (currently in beta until I get a little more testing).  It can be installed like any other, but will require updating SquishIt if you&#8217;re using a pre-0.8.7 version.  If you need to report any issues encountered while using the library, or feel like contributing some code, please do so <a href="https://github.com/AlexCuse/SquishIt.S3">on github</a>.  Oh, and if you just want to kick the tires on SquishIt without all this other nonsense, or try making it work with another CDN you can find the core library <a href="http://nuget.org/packages/SquishIt">on NuGet</a> as well.</p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/'>Copying Buckets With The Amazon S3 API</a><p>One of the projects I have been working on is a system for managing content&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/webdev/serverprogramming/preprocessor-extensibility-in-squishit-0-9/'>Preprocessor Extensibility in SquishIt 0.9</a><p>For the past couple years, .net developers have been embracing various content preprocessors as they&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2><img class="bioPic" src="http://forum.lessthandot.com/download/file.php?avatar=56_1270084566.jpg" alt="User bio image"/>Alex is a software engineer from southeastern PA, where he lives with a lovely wife and a veritable smorgasbord of pets.  He loves mountain biking, open source software, barbecue and Syracuse basketball.<br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/AlexCuse" title="AlexCuse at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.linkedin.com/in/alexullrich" title="AlexCuse at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="/index.php/author/alexcuse/feed/" title="Blog RSS feed for AlexCuse" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 23,324 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/alexcuse/">Read More Posts by Alex Ullrich</a>
						</div>
					</div>
					<div>
						<label>Tags:</label> <a href="/index.php/tag/squishit/" rel="tag">squishit</a> 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&text=RT @LessThanDot Blog - SquishIt Integration with Amazon S3 / Cloudfront by @AlexCuse" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront&source=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&quote=SquishIt Integration with Amazon S3 / Cloudfront" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/&title=SquishIt Integration with Amazon S3 / Cloudfront" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		6 Comments	</h4>
			<ol class="comments-list">
					<li class="comment even thread-even depth-1" id="comment-5362">
				<div id="div-comment-5362" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/b4b999ab98bfa8ebe3bcafd5fe185912?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/b4b999ab98bfa8ebe3bcafd5fe185912?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://irwinj.blogspot.com/' rel='external nofollow' class='url'>Jason</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-5362">
			September 4, 2012 at 10:46 pm</a>		</div>

		<p>Great post and great work &#8211; this is exactly what I was looking for. Thanks for the hard work.</p>
<p>I have three questions if you wouldn&#8217;t mind clarifying a few things:</p>
<p>1. Do you have any suggestions for urls embedded in CSS files? For instance if I have a css file containing a background-url attribute that points to an &#8216;images&#8217; folder on my web server and that file is bundled and the resulting file moved to the CDN the link to that background image is broken. I don&#8217;t know if squishit supports that kind of scenario. The only thing i can think of is fully qualifying the url (pointing it to my CDN) &#8211; but that is something that I&#8217;d like to avoid as I would like to keep the files local and unbundled during development.<br />
2. Do you have any idea when this will exit the pre-release phase? I&#8217;m planning on starting to use it soon and was wondering if it is still a work in progress<br />
3. Can the UseDefaultOutputBaseHref be used without a specific protocol (i.e. using // instead of <a href="" rel="nofollow">https://</a>) or  is there a reason why the protocol is required here. I&#8217;m just wondering.</p>
<p>Again, thanks for the great work!<br />
Jason</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=5362#respond' onclick='return addComment.moveForm( "div-comment-5362", "5362", "respond", "1646" )' aria-label='Reply to Jason'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-5363">
				<div id="div-comment-5363" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-5363">
			September 5, 2012 at 6:28 am</a>		</div>

		<p>1. I would suggest using relative paths, and putting your images onto the CDN also, mimicking the folder structure you keep locally for development.  Relative paths are resolved relative to the CSS file, so if all your content is hosted on the CDN you shouldn&#8217;t have any problem.</p>
<p>2. Honestly the code is pretty simple &#8211; the only thing I want to confirm is that I can get querystring hashes down in the renderer now that cloudfront supports querystring invalidation.  If you use the &#8220;HashInFilename&#8221; option (by rendering to filename_#.css etc&#8230;) it should definitely be fine.  I really just wanted some other people to test it before taking it out of pre-release, so if you don&#8217;t mind being the guinea pig go for it.  I will do my best to resolve any issues you encounter quickly (this is just coming back on my radar as SquishIt 0.9 settles in).  I feel pretty confident we can have an official release ready in a week or two if you help with the testing.</p>
<p>3. I&#8217;ve never used a protocol-relative URL for the default output href but don&#8217;t see why it wouldn&#8217;t work.  If it doesn&#8217;t work for you, post an issue to the SquishIt core on github, because it definitely should 🙂</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=5363#respond' onclick='return addComment.moveForm( "div-comment-5363", "5363", "respond", "1646" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-5360">
				<div id="div-comment-5360" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/64f302887d952dbe5ff06bf431a1b3e3?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/64f302887d952dbe5ff06bf431a1b3e3?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.openrent.co.uk/' rel='external nofollow' class='url'>Daz Bradbury</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-5360">
			November 22, 2012 at 7:09 am</a>		</div>

		<p>Absolutely awesome.</p>
<p>I was hosting on Appharbor, and had a world of pain with RequestReduce, so switched to Squishit as the architecture is a lot more straight forward.</p>
<p>Initially, there were a few problems, as with multiple workers, I had the choice of putting things in the cache, or creating each bundle on application startup such that each worker would know how to process it.</p>
<p>Then I saw this article, and I have to say, it was a breeze to implement &#8211; I forked the repo thinking I would need to make some changes, but that worry was ill-placed.</p>
<p>I made a few modificiations to your initial config which were needed, namely:</p>
<p>a) When creating an s3client, if you&#8217;re using a different region to the default US, you&#8217;ll need to specify it as such (in this case, EUWest):</p>
<p>var s3client = new AmazonS3Client(&#8220;accessKey&#8221;, &#8220;secretKey&#8221;, Amazon.RegionEndpoint.EUWest1);</p>
<p>Otherwise, Amazon will throw: </p>
<p>“Maximum number of retry attempts reached”</p>
<p>b) Part of the point in doing this, for me at least, was so static code is easily cacheable in production. As such, most users will probably want to add the following line to the renderer creation:</p>
<p>.WithHeaders(Amazon.S3.Util.AmazonS3Util.CreateHeaderEntry(&#8220;Cache-Control&#8221;, &#8220;public, max-age=3153600&#8221;))</p>
<p>Otherwise, this worked perfectly, injected my cloudfront url, and was a breeze!</p>
<p>Thanks for sharing!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=5360#respond' onclick='return addComment.moveForm( "div-comment-5360", "5360", "respond", "1646" )' aria-label='Reply to Daz Bradbury'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-5361">
				<div id="div-comment-5361" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-5361">
			November 23, 2012 at 6:51 pm</a>		</div>

		<p>Glad to hear its working well for you!  I didn&#8217;t even think about the region thing, but the problem you ran into makes me happy that I didn&#8217;t make any assumptions about how people are using the amazon services.</p>
<p>Thanks for sharing your experience &#8211; this post has basically become the readme for the library so it will probably save someone from running into the same issue you encountered 🙂</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=5361#respond' onclick='return addComment.moveForm( "div-comment-5361", "5361", "respond", "1646" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-953204">
				<div id="div-comment-953204" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/0d6c07f5df908e1f6bd267c86cb5b6c8?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/0d6c07f5df908e1f6bd267c86cb5b6c8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://Aurusit.com/' rel='external nofollow' class='url'>amogh</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-953204">
			May 28, 2014 at 3:54 am</a>		</div>

		<p>hi Alex,</p>
<p>i used SquishIt for Bundle the js / css<br />
i want to ask you that,<br />
i have amazon s3 bucket which contain image and Google speed suggest me to<br />
Leverage browser caching for those image.<br />
so can we used SquishIt  to make bundle all images in sprite and used it.<br />
can we used the method what you wrote upside to set &#8221; Cache Control Header&#8221;</p>
<p>thank you </p>
<p>Amogh</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=953204#respond' onclick='return addComment.moveForm( "div-comment-953204", "953204", "respond", "1646" )' aria-label='Reply to amogh'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-956419">
				<div id="div-comment-956419" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#comment-956419">
			May 28, 2014 at 10:15 am</a>		</div>

		<p>No, SquishIt does not have any support for image spriting.  I think Cassette does, and RequestReduce might.</p>
<p>If you are just looking to upload s3 assets from .net code then the method shown for setting cache control headers should work.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/?replytocom=956419#respond' onclick='return addComment.moveForm( "div-comment-956419", "956419", "respond", "1646" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='1646' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="06409663226af2f3114485aa4e0a23b4"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765963"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
