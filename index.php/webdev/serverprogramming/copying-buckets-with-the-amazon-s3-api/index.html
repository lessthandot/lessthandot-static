<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   Copying Buckets With The Amazon S3 API</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   Copying Buckets With The Amazon S3 API" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="One of the projects I have been working on is a system for managing content on our network of websites.  One of our requirements is that changes don't take effect immediately, but on a separate preview network where our customer can look to see that her&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; Copying Buckets With The Amazon S3 API Comments Feed" href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='OUTPUT Clause and @@identity, scope_identity()' href='/index.php/datamgmt/datadesign/output-clause-and-identity-scope_identity/' />
<link rel='next' title='Getting Flexible With NDepend 4 and CQLinq' href='/index.php/architect/designingsoftware/getting-flexible-with-ndepend-4-and-cqlinq/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/" />
<link rel='shortlink' href='/?p=1629' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Fcopying-buckets-with-the-amazon-s3-api%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fwebdev%2Fserverprogramming%2Fcopying-buckets-with-the-amazon-s3-api%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/architect/designingsoftware/getting-flexible-with-ndepend-4-and-cqlinq/" rel="next">Getting Flexible With NDepend 4 and CQLinq</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/datamgmt/datadesign/output-clause-and-identity-scope_identity/" rel="prev">OUTPUT Clause and @@identity, scope_identity()</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/" class="post-title">Copying Buckets With The Amazon S3 API</a></h1>
					<div class="post-byline">by <a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich" rel="author">Alex Ullrich</a> on May 29, 2012 in category <a href="/index.php/category/webdev/serverprogramming/aspnet/" rel="category tag">ASP.NET</a> <a href="/index.php/category/webdev/serverprogramming/" rel="category tag">Server Programming</a>. Article views: 17,352 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&text=RT @LessThanDot Blog - Copying Buckets With The Amazon S3 API by @AlexCuse" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API&source=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&quote=Copying Buckets With The Amazon S3 API" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>One of the projects I have been working on is a system for managing content on our network of websites.  One of our requirements is that changes don&#8217;t take effect immediately, but on a separate preview network where our customer can look to see that her changes show the way she expected before pushing them into the production environment.  Because of this requirement, we need to maintain 2 separate sets of product images (hosted on Amazon S3, with their CloudFront CDN used for the production sites).</p>
<p>Allowing our content management system to save image changes to Amazon and render their locations in our app was trivial, but we found the push mechanism for moving changes into the live environment a bit challenging.  The work for moving database changes was already done when I started on the project, so most of the challenges I saw were in relation to copying the images.  What we really wanted was a true bucket copy (emptying the destination bucket altogether and replacing its content with that of the source bucket) &#8211; but the <a href="http://docs.amazonwebservices.com/AmazonS3/latest/API/RESTBucketOps.html">REST API for S3</a> does not support copy at the bucket level currently.</p>
<p>When designing our solution we needed to optimize not only on performance and maintainability, but on cost.  The <a href="http://aws.amazon.com/s3/pricing/">pricing model for S3</a> has charges associated with most request types so it&#8217;s not efficient to simply copy all the items in the source bucket to the destination.  In addition, this wouldn&#8217;t handle deleting objects that have been removed in the source bucket.  So the naive solution becomes a two step process of deleting all of a bucket&#8217;s content, then copying over all the content from the other bucket.  In a scenario where the actual degree of change is likely to be minimal incurring this kind of cost is not a great option (and it&#8217;s likely to perform poorly as well).  When you add the challenge of CDN cache invalidation and <a href="http://aws.amazon.com/cloudfront/pricing/">pricing for CloudFront</a> to the equation this looks even less attractive.</p>
<p>This post will go over the implementation we came up with for bucket copying.  Code is written in C# using the <a href="http://aws.amazon.com/sdkfornet/">AWS SDK for .net</a>, but it is all possible using the REST API directly.  I will add that the AWS SDK is a very nice tool &#8211; typically I would choose to use <a href="https://github.com/restsharp/restsharp">RestSharp</a> to go directly at the REST API, but Amazon has taken a lot of time to build a nice fluent syntax for building requests and some helper functions that make life easy enough to make it worth a look &#8211; it is far nicer than some of the other client libraries out there, in large part because it doesn&#8217;t try to hide the fact that you&#8217;re working with a set of webservices.  But I digress.  The process for copying a bucket is pretty straightforward:</p>
<ol>
<li>Check for destination bucket existence, create if needed</li>
<li>List Objects in Both Buckets</li>
<li>Identify keys for Insert, Update and Deletion (COPYs and DELETEs)</li>
<li>Perform COPY / DELETE</li>
<li>Invalidations (Updates only)</li>
</ol>
<p>So here we go.</p>
</p>
<h3>Check for Bucket Existence</h3>
<p>Checking for bucket existence is a piece of cake, thanks to a static helper function in the .net SDK that takes a bucket name and an s3 client.  I chose to hide this call behind an instance method so that I could mock it during unit tests, but this is not strictly necessary.  I think that behind the scenes this method simply issues a HEAD request on a bucket and returns false if a 404 is encountered.  As you&#8217;d expect creating the bucket is done via a PUT request on the bucket resource.  Code is as follows:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="de1"><pre class="de1"><span class="kw4">void</span> CreateDestinationBucketIfNeeded<span class="br0">&#40;</span><span class="kw4">string</span> bucketName<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span>BucketExists<span class="br0">&#40;</span>bucketName<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> PutBucketRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>bucketName<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; _s3Client<span class="sy0">.</span><span class="me1">PutBucket</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">public</span> <span class="kw1">virtual</span> <span class="kw4">bool</span> BucketExists<span class="br0">&#40;</span><span class="kw4">string</span> bucketName<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> Amazon<span class="sy0">.</span><span class="me1">S3</span><span class="sy0">.</span><span class="me1">Util</span><span class="sy0">.</span><span class="me1">AmazonS3Util</span><span class="sy0">.</span><span class="me1">DoesS3BucketExist</span><span class="br0">&#40;</span>bucketName, _s3Client<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">void CreateDestinationBucketIfNeeded(string bucketName)
{
    if(!BucketExists(bucketName))
    {
        var request = new PutBucketRequest()
            .WithBucketName(bucketName);

        _s3Client.PutBucket(request);
    }
}

public virtual bool BucketExists(string bucketName)
{
    return Amazon.S3.Util.AmazonS3Util.DoesS3BucketExist(bucketName, _s3Client);
}</pre></div></div>

<h3>List Objects in a Bucket</h3>
<p>Listing objects in an S3 bucket is very easy.  You just need to issue a signed GET request to myBucket.s3.amazonaws.com.  The only gotcha is it only returns up to 1000 objects in a single response, so getting a complete list can take multiple requests.  It helps to know a few things when putting this together &#8211; first that objects are listed in alphabetical order, second that we can include a &#8220;marker&#8221; parameter in our request telling AWS what key to start with, and third that the response from this method includes an &#8220;IsTruncated&#8221; flag.  The C# code to list objects looks like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="de1"><pre class="de1">IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> ObjectsFor<span class="br0">&#40;</span><span class="kw4">string</span> bucketName<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> result <span class="sy0">=</span> <span class="kw3">new</span> List<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> response <span class="sy0">=</span> <span class="kw3">new</span> ListObjectsResponse<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">do</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> ListObjectsRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>bucketName<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>response<span class="sy0">.</span><span class="me1">IsTruncated</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; request<span class="sy0">.</span><span class="me1">Marker</span> <span class="sy0">=</span> response<span class="sy0">.</span><span class="me1">NextMarker</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; response <span class="sy0">=</span> _s3Client<span class="sy0">.</span><span class="me1">ListObjects</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; result<span class="sy0">.</span><span class="me1">AddRange</span><span class="br0">&#40;</span>response<span class="sy0">.</span><span class="me1">S3Objects</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="br0">&#125;</span> <span class="kw1">while</span><span class="br0">&#40;</span>response<span class="sy0">.</span><span class="me1">IsTruncated</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; 
&nbsp; &nbsp; response<span class="sy0">.</span><span class="me1">Dispose</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">return</span> result<span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">IEnumerable&lt;S3Object&gt; ObjectsFor(string bucketName)
{
    var result = new List&lt;S3Object&gt;();

    var response = new ListObjectsResponse();
    do
    {
        var request = new ListObjectsRequest()
            .WithBucketName(bucketName);

        if(response.IsTruncated)
        {
            request.Marker = response.NextMarker;
        }

        response = _s3Client.ListObjects(request);
        result.AddRange(response.S3Objects);

    } while(response.IsTruncated);
    
    response.Dispose();

    return result;
}</pre></div></div>

<h3>
<p>Identify Inserts, Updates and Deletes</p>
</h3>
<p>Once we have the contents of both buckets, we need to determine which objects need to be inserted to, updated in, and deleted from the destination bucket.  For deleted objects we will be issuing DELETE requests, and for Inserts and Updates we will be copying objects across using a special PUT request.  The DELETE requests can be batched, supporting up to 1000 deletions in a single request, while the PUT requests need to be issued on an object by object basis.</p>
<p>These subsets of can be identified by comparing the objects in source and destination bucket.  Deletes will include all objects in the destination that aren&#8217;t in the source.  Updates will include all objects present in both buckets that have changed (this can be determined by comparing the ETags on the objects).  Inserts will of course contain all objects that exist in the source but not the destination.</p>
<p>C# helps us out a bit here, as LINQ makes it easy to do these comparisons without having to do any nasty looping.  For the inserts and deletes we need to spoof an outer join which LINQ doesn&#8217;t really have a great API for, but I still find it helpful to be able to think about these operations in set-based terms instead of in terms of the tedious iterative comparison that actually gets done behind all the LINQ magic.</p>
<p>Code to identify these sets of objects can be found here:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="de1"><pre class="de1">IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> ObjectsToUpdate<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> sourceObjects, IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> destinationObjects<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">from</span> src <span class="kw1">in</span> sourceObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">join</span> dest <span class="kw1">in</span> destinationObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on src<span class="sy0">.</span><span class="me1">Key</span> equals dest<span class="sy0">.</span><span class="me1">Key</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">where</span> src<span class="sy0">.</span><span class="me1">Size</span> <span class="sy0">&gt;</span> <span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> src<span class="sy0">.</span><span class="me1">ETag</span> <span class="sy0">!=</span> dest<span class="sy0">.</span><span class="me1">ETag</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">select</span> src<span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> ObjectsToInsert<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> sourceObjects, IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> destinationObjects<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">from</span> src <span class="kw1">in</span> sourceObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">join</span> dest <span class="kw1">in</span> destinationObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on src<span class="sy0">.</span><span class="me1">Key</span> equals dest<span class="sy0">.</span><span class="me1">Key</span> <span class="kw1">into</span> joinedObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">from</span> coalescedDest <span class="kw1">in</span> joinedObjects<span class="sy0">.</span><span class="me1">DefaultIfEmpty</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">where</span> src<span class="sy0">.</span><span class="me1">Size</span> <span class="sy0">&gt;</span> <span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> coalescedDest <span class="sy0">==</span> <span class="kw1">null</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">select</span> src<span class="sy0">;</span>
<span class="br0">&#125;</span>
&nbsp;
IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> ObjectsToDelete<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> sourceObjects, IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> destinationObjects<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">return</span> <span class="kw1">from</span> dest <span class="kw1">in</span> destinationObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">join</span> src <span class="kw1">in</span> sourceObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;on dest<span class="sy0">.</span><span class="me1">Key</span> equals src<span class="sy0">.</span><span class="me1">Key</span> <span class="kw1">into</span> joinedObjects
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">from</span> coalescedSrc <span class="kw1">in</span> joinedObjects<span class="sy0">.</span><span class="me1">DefaultIfEmpty</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">where</span> dest<span class="sy0">.</span><span class="me1">Size</span> <span class="sy0">&gt;</span> <span class="nu0">0</span> <span class="sy0">&amp;&amp;</span> coalescedSrc <span class="sy0">==</span> <span class="kw1">null</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span class="kw1">select</span> dest<span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">IEnumerable&lt;S3Object&gt; ObjectsToUpdate(IEnumerable&lt;S3Object&gt; sourceObjects, IEnumerable&lt;S3Object&gt; destinationObjects)
{
    return from src in sourceObjects
           join dest in destinationObjects
               on src.Key equals dest.Key
           where src.Size &gt; 0 &amp;&amp; src.ETag != dest.ETag
           select src;
}

IEnumerable&lt;S3Object&gt; ObjectsToInsert(IEnumerable&lt;S3Object&gt; sourceObjects, IEnumerable&lt;S3Object&gt; destinationObjects)
{
    return from src in sourceObjects
           join dest in destinationObjects
               on src.Key equals dest.Key into joinedObjects
           from coalescedDest in joinedObjects.DefaultIfEmpty()
           where src.Size &gt; 0 &amp;&amp; coalescedDest == null
           select src;
}

IEnumerable&lt;S3Object&gt; ObjectsToDelete(IEnumerable&lt;S3Object&gt; sourceObjects, IEnumerable&lt;S3Object&gt; destinationObjects)
{
    return from dest in destinationObjects
           join src in sourceObjects
               on dest.Key equals src.Key into joinedObjects
           from coalescedSrc in joinedObjects.DefaultIfEmpty()
           where dest.Size &gt; 0 &amp;&amp; coalescedSrc == null
           select dest;
}</pre></div></div>

<h3>Perform Insert/Delete</h3>
<p>Inserts and deletes are the easy part.  We just need to process the list of objects and issue the appropriate requests.  There are two important optimizations here &#8211; we can batch deletes, and we can parallelize copies.  Batching deletes will help to minimize network chatter, and parallelizing copies will help to force as much network chatter as possible into a shorter amount of time ðŸ™‚  I was torn on whether or not to paralellize the copies, but decided that in essence we are performing a ton of blocking I/O requests <em><strong>with another computer doing all the work</strong></em>.  If you have real concerns about flooding your network connection you may not want to make this optimization, or do it in a way that allows you to dial down the amount of concurrency but after testing with the calls made in parallel I found a copy of a bucket with ~500 objects finished in about 25% of the time on my dual core laptop, and I was sold.</p>
<p>The inserts are the easiest part:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="de1"><pre class="de1"><span class="kw4">void</span> CopyObjects<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> items, Func<span class="sy0">&lt;</span>S3Object, CopyObjectRequest<span class="sy0">&gt;</span> requestBuilder<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> exceptions <span class="sy0">=</span> <span class="kw3">new</span> ConcurrentQueue<span class="sy0">&lt;</span>Exception<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Parallel<span class="sy0">.</span><span class="kw1">ForEach</span><span class="br0">&#40;</span>items, obj <span class="sy0">=&gt;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> captured <span class="sy0">=</span> obj<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> requestBuilder<span class="br0">&#40;</span>obj<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _s3Client<span class="sy0">.</span><span class="me1">CopyObject</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">catch</span><span class="br0">&#40;</span>Exception ex<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exceptions<span class="sy0">.</span><span class="me1">Enqueue</span><span class="br0">&#40;</span>ex<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>exceptions<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">throw</span> <span class="kw3">new</span> AggregateException<span class="br0">&#40;</span>exceptions<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">void CopyObjects(IEnumerable&lt;S3Object&gt; items, Func&lt;S3Object, CopyObjectRequest&gt; requestBuilder)
{
    var exceptions = new ConcurrentQueue&lt;Exception&gt;();
    Parallel.ForEach(items, obj =&gt;
    {
        try
        {
            var captured = obj;
            var request = requestBuilder(obj);
            _s3Client.CopyObject(request);
        }
        catch(Exception ex)
        {
            exceptions.Enqueue(ex);
        }
    });

    if(exceptions.Count &gt; 0) throw new AggregateException(exceptions);
}</pre></div></div>

<p>Deletes were pretty simple as well, only difference being the batching of requests:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">var</span> toDelete <span class="sy0">=</span> ObjectsToDelete<span class="br0">&#40;</span>sourceObjects, destinationObjects<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToList</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="kw1">while</span><span class="br0">&#40;</span>toDelete<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> batch <span class="sy0">=</span> toDelete<span class="sy0">.</span><span class="me1">Take</span><span class="br0">&#40;</span><span class="nu0">1000</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> DeleteObjectsRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithKeys</span><span class="br0">&#40;</span>batch<span class="sy0">.</span><span class="kw1">Select</span><span class="br0">&#40;</span>k <span class="sy0">=&gt;</span> <span class="kw3">new</span> KeyVersion<span class="br0">&#40;</span>k<span class="sy0">.</span><span class="me1">Key</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToArray</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; _s3Client<span class="sy0">.</span><span class="me1">DeleteObjects</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; toDelete<span class="sy0">.</span><span class="me1">RemoveRange</span><span class="br0">&#40;</span><span class="nu0">0</span>, toDelete<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">1000</span> <span class="sy0">?</span> <span class="nu0">1000</span> <span class="sy0">:</span> toDelete<span class="sy0">.</span><span class="me1">Count</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">var toDelete = ObjectsToDelete(sourceObjects, destinationObjects).ToList();

while(toDelete.Count &gt; 0)
{
    var batch = toDelete.Take(1000);
    var request = new DeleteObjectsRequest()
                        .WithBucketName(destinationBucket)
                        .WithKeys(batch.Select(k =&gt; new KeyVersion(k.Key)).ToArray());

    _s3Client.DeleteObjects(request);

    toDelete.RemoveRange(0, toDelete.Count &gt; 1000 ? 1000 : toDelete.Count);
}</pre></div></div>

<h3>Perform Updates</h3>
<p>This step is not really anything special but it is different enough for me to exclude it from it&#8217;s counterparts in step 3.  We are basically doing the same copy operation for each object that we did for the inserts, but we also need to worry about cache invalidation on the CloudFront CDN.  The invalidation can be batched, so it makes sense to build the list of keys updated while we do the copy, then send a single invalidation request.</p>
<p>So we can change the code for copy to something like this, taking an optional parameter containing a function to add the object&#8217;s key to a list of keys to be invalidated:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="de1"><pre class="de1"><span class="kw4">void</span> CopyObjects<span class="br0">&#40;</span>IEnumerable<span class="sy0">&lt;</span>S3Object<span class="sy0">&gt;</span> items, Func<span class="sy0">&lt;</span>S3Object, CopyObjectRequest<span class="sy0">&gt;</span> requestBuilder, Action<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> addToInvalidationList <span class="sy0">=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> exceptions <span class="sy0">=</span> <span class="kw3">new</span> ConcurrentQueue<span class="sy0">&lt;</span>Exception<span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; Parallel<span class="sy0">.</span><span class="kw1">ForEach</span><span class="br0">&#40;</span>items, obj <span class="sy0">=&gt;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">try</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> captured <span class="sy0">=</span> obj<span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> requestBuilder<span class="br0">&#40;</span>obj<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _s3Client<span class="sy0">.</span><span class="me1">CopyObject</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>addToInvalidationList <span class="sy0">!=</span> <span class="kw1">null</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; addToInvalidationList<span class="br0">&#40;</span>captured<span class="sy0">.</span><span class="me1">Key</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">catch</span><span class="br0">&#40;</span>Exception ex<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exceptions<span class="sy0">.</span><span class="me1">Enqueue</span><span class="br0">&#40;</span>ex<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>exceptions<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">throw</span> <span class="kw3">new</span> AggregateException<span class="br0">&#40;</span>exceptions<span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">void CopyObjects(IEnumerable&lt;S3Object&gt; items, Func&lt;S3Object, CopyObjectRequest&gt; requestBuilder, Action&lt;string&gt; addToInvalidationList = null)
{
    var exceptions = new ConcurrentQueue&lt;Exception&gt;();
    Parallel.ForEach(items, obj =&gt;
    {
        try
        {
            var captured = obj;
            var request = requestBuilder(obj);
            _s3Client.CopyObject(request);
            if(addToInvalidationList != null)
                addToInvalidationList(captured.Key);
        }
        catch(Exception ex)
        {
            exceptions.Enqueue(ex);
        }
    });

    if(exceptions.Count &gt; 0) throw new AggregateException(exceptions);
}</pre></div></div>

<p>I&#8217;ll concede that this is not the simplest possible thing &#8211; it would probably be easier to call the old copy code and then pass the keys from the updated objects collection, but I do like that it captures the keys of the objects that are actually copied.  If we changed the approach to do something like what is happening with the delete operation that trims the collection while processing, the keys collection we pass for invalidation would end up empty.  I could also just have too much functional programming on the brain I guess ðŸ˜‰</p>
<p>Once we have the list of keys, performing the actual invalidation is relatively simple.  We do need to generate a unique &#8220;caller reference&#8221; that amazon uses to ensure that duplicate requests aren&#8217;t processed (remember, each object invalidated triggers some kind of action on potentially hundreds of servers, so this is not a cheap operation for you OR for Amazon).  The hardest part is probably identifying whether there is a CloudFront distribution to worry about in the first place.  The key to finding whether there is a distribution attached to a bucket or not relies on the knowledge that for an s3 origin, the DNSName property will be &#8220;bucketname.s3.amazonaws.com&#8221; &#8211; so by stripping out &#8220;.s3.amazonaws.com&#8221; from our available distributions&#8217; DNS names we can find if one matches our bucket.</p>
<p>The code for invalidation looks like this:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre></td><td class="de1"><pre class="de1"><span class="kw1">const</span> <span class="kw4">string</span> dateFormatWithMilliseconds <span class="sy0">=</span> <span class="st0">&quot;yyyy-MM-dd hh:mm:ss.ff&quot;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">void</span> InvalidateObjects<span class="br0">&#40;</span><span class="kw4">string</span> destinationBucket, List<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span> keysToInvalidate<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span>keysToInvalidate<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> distId <span class="sy0">=</span> GetDistributionIdFor<span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw4">string</span><span class="sy0">.</span><span class="me1">IsNullOrWhiteSpace</span><span class="br0">&#40;</span>distId<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> invalidationRequest <span class="sy0">=</span> <span class="kw3">new</span> PostInvalidationRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDistribtionId</span><span class="br0">&#40;</span>distId<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithInvalidationBatch</span><span class="br0">&#40;</span><span class="kw3">new</span> InvalidationBatch<span class="br0">&#40;</span>DateTime<span class="sy0">.</span><span class="me1">Now</span><span class="sy0">.</span><span class="me1">ToString</span><span class="br0">&#40;</span>dateFormatWithMilliseconds<span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;keysToInvalidate<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; _cloudFrontClient<span class="sy0">.</span><span class="me1">PostInvalidation</span><span class="br0">&#40;</span>invalidationRequest<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&nbsp;
<span class="kw1">const</span> <span class="kw4">string</span> amazonBucketUriSuffix <span class="sy0">=</span> <span class="st0">&quot;.s3.amazonaws.com&quot;</span><span class="sy0">;</span>
&nbsp;
<span class="kw4">string</span> GetDistributionIdFor<span class="br0">&#40;</span><span class="kw4">string</span> bucketName<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; <span class="kw1">var</span> distributionNameAndIds <span class="sy0">=</span>
&nbsp; &nbsp; &nbsp; &nbsp; _cloudFrontClient<span class="sy0">.</span><span class="me1">ListDistributions</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">Distribution</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">ToDictionary</span><span class="br0">&#40;</span>cfd <span class="sy0">=&gt;</span> cfd<span class="sy0">.</span><span class="me1">DistributionConfig</span><span class="sy0">.</span><span class="me1">S3Origin</span><span class="sy0">.</span><span class="me1">DNSName</span><span class="sy0">.</span><span class="me1">Replace</span><span class="br0">&#40;</span>amazonBucketUriSuffix, <span class="st0">&quot;&quot;</span><span class="br0">&#41;</span>, cfd <span class="sy0">=&gt;</span> cfd<span class="sy0">.</span><span class="me1">Id</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw4">string</span> id <span class="sy0">=</span> <span class="kw1">null</span><span class="sy0">;</span>
&nbsp; &nbsp; distributionNameAndIds<span class="sy0">.</span><span class="me1">TryGetValue</span><span class="br0">&#40;</span>bucketName, <span class="kw1">out</span> id<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">return</span> id<span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">const string dateFormatWithMilliseconds = "yyyy-MM-dd hh:mm:ss.ff";

void InvalidateObjects(string destinationBucket, List&lt;string&gt; keysToInvalidate)
{
    if(keysToInvalidate.Count &gt; 0)
    {
        var distId = GetDistributionIdFor(destinationBucket);
        if(!string.IsNullOrWhiteSpace(distId))
        {
            var invalidationRequest = new PostInvalidationRequest()
                .WithDistribtionId(distId)
                .WithInvalidationBatch(new InvalidationBatch(DateTime.Now.ToString(dateFormatWithMilliseconds),
                                                                     keysToInvalidate));

            _cloudFrontClient.PostInvalidation(invalidationRequest);
        }
    }
}

const string amazonBucketUriSuffix = ".s3.amazonaws.com";

string GetDistributionIdFor(string bucketName)
{
    var distributionNameAndIds =
        _cloudFrontClient.ListDistributions()
        .Distribution
        .ToDictionary(cfd =&gt; cfd.DistributionConfig.S3Origin.DNSName.Replace(amazonBucketUriSuffix, ""), cfd =&gt; cfd.Id);

    string id = null;
    distributionNameAndIds.TryGetValue(bucketName, out id);
    return id;
}</pre></div></div>

<h3>Tying it All Together</h3>
<p>OK so we have all these methods to facilitate copying buckets but how do we actually do it?  I&#8217;m glad you asked.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="csharp"><thead><tr><td colspan="2"  class="head">C#</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="de1"><pre class="de1"><span class="kw1">public</span> <span class="kw4">void</span> Copy<span class="br0">&#40;</span><span class="kw4">string</span> sourceBucket, <span class="kw4">string</span> destinationBucket<span class="br0">&#41;</span>
<span class="br0">&#123;</span>
&nbsp; &nbsp; CreateDestinationBucketIfNeeded<span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> sourceObjects <span class="sy0">=</span> ObjectsFor<span class="br0">&#40;</span>sourceBucket<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">var</span> destinationObjects <span class="sy0">=</span> ObjectsFor<span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> toDelete <span class="sy0">=</span> ObjectsToDelete<span class="br0">&#40;</span>sourceObjects, destinationObjects<span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToList</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="kw1">while</span><span class="br0">&#40;</span>toDelete<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">0</span><span class="br0">&#41;</span>
&nbsp; &nbsp; <span class="br0">&#123;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> batch <span class="sy0">=</span> toDelete<span class="sy0">.</span><span class="me1">Take</span><span class="br0">&#40;</span><span class="nu0">1000</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="kw1">var</span> request <span class="sy0">=</span> <span class="kw3">new</span> DeleteObjectsRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithBucketName</span><span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithKeys</span><span class="br0">&#40;</span>batch<span class="sy0">.</span><span class="kw1">Select</span><span class="br0">&#40;</span>k <span class="sy0">=&gt;</span> <span class="kw3">new</span> KeyVersion<span class="br0">&#40;</span>k<span class="sy0">.</span><span class="me1">Key</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="me1">ToArray</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; _s3Client<span class="sy0">.</span><span class="me1">DeleteObjects</span><span class="br0">&#40;</span>request<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; toDelete<span class="sy0">.</span><span class="me1">RemoveRange</span><span class="br0">&#40;</span><span class="nu0">0</span>, toDelete<span class="sy0">.</span><span class="me1">Count</span> <span class="sy0">&gt;</span> <span class="nu0">1000</span> <span class="sy0">?</span> <span class="nu0">1000</span> <span class="sy0">:</span> toDelete<span class="sy0">.</span><span class="me1">Count</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp; &nbsp; <span class="br0">&#125;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> buildCopyRequest <span class="sy0">=</span> <span class="kw3">new</span> Func<span class="sy0">&lt;</span>S3Object, CopyObjectRequest<span class="sy0">&gt;</span><span class="br0">&#40;</span>s3obj <span class="sy0">=&gt;</span> <span class="kw3">new</span> CopyObjectRequest<span class="br0">&#40;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithSourceBucket</span><span class="br0">&#40;</span>sourceBucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDestinationBucket</span><span class="br0">&#40;</span>destinationBucket<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithSourceKey</span><span class="br0">&#40;</span>s3obj<span class="sy0">.</span><span class="me1">Key</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithDestinationKey</span><span class="br0">&#40;</span>s3obj<span class="sy0">.</span><span class="me1">Key</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; &nbsp; <span class="sy0">.</span><span class="me1">WithCannedACL</span><span class="br0">&#40;</span>S3CannedACL<span class="sy0">.</span><span class="me1">PublicRead</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; CopyObjects<span class="br0">&#40;</span>ObjectsToInsert<span class="br0">&#40;</span>sourceObjects, destinationObjects<span class="br0">&#41;</span>, buildCopyRequest<span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; <span class="kw1">var</span> keysToInvalidate <span class="sy0">=</span> <span class="kw3">new</span> ConcurrentBag<span class="sy0">&lt;</span><span class="kw4">string</span><span class="sy0">&gt;</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; CopyObjects<span class="br0">&#40;</span>ObjectsToUpdate<span class="br0">&#40;</span>sourceObjects, destinationObjects<span class="br0">&#41;</span>, buildCopyRequest, keysToInvalidate<span class="sy0">.</span><span class="kw1">Add</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
&nbsp; &nbsp; InvalidateObjects<span class="br0">&#40;</span>destinationBucket, keysToInvalidate<span class="sy0">.</span><span class="me1">ToList</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">public void Copy(string sourceBucket, string destinationBucket)
{
    CreateDestinationBucketIfNeeded(destinationBucket);

    var sourceObjects = ObjectsFor(sourceBucket);
    var destinationObjects = ObjectsFor(destinationBucket);

    var toDelete = ObjectsToDelete(sourceObjects, destinationObjects).ToList();
    while(toDelete.Count &gt; 0)
    {
        var batch = toDelete.Take(1000);
        var request = new DeleteObjectsRequest()
            .WithBucketName(destinationBucket)
            .WithKeys(batch.Select(k =&gt; new KeyVersion(k.Key)).ToArray());

        _s3Client.DeleteObjects(request);

        toDelete.RemoveRange(0, toDelete.Count &gt; 1000 ? 1000 : toDelete.Count);
    }

    var buildCopyRequest = new Func&lt;S3Object, CopyObjectRequest&gt;(s3obj =&gt; new CopyObjectRequest()
        .WithSourceBucket(sourceBucket)
        .WithDestinationBucket(destinationBucket)
        .WithSourceKey(s3obj.Key)
        .WithDestinationKey(s3obj.Key)
        .WithCannedACL(S3CannedACL.PublicRead));

    CopyObjects(ObjectsToInsert(sourceObjects, destinationObjects), buildCopyRequest);

    var keysToInvalidate = new ConcurrentBag&lt;string&gt;();

    CopyObjects(ObjectsToUpdate(sourceObjects, destinationObjects), buildCopyRequest, keysToInvalidate.Add);

    InvalidateObjects(destinationBucket, keysToInvalidate.ToList());
}</pre></div></div>

<p>Note that the delete happens inline instead of in a separate method as with the copies.  This is because it wasn&#8217;t reusable, and because the act of deleting the items changes the collection.  As a result it seemed cleaner to just do it inline.</p>
<p>This is really all there is to it.  Hopefully copying buckets in this manner is something that finds its way into the REST API for S3 at some point, but in the meantime this process seems to be working pretty well.  It is not the prettiest code, but it runs reasonably fast for our smallish buckets, and I think it is doing a good job minimizing what our customer has to pay for the service each month.  It was interesting working on this problem, because it forced thinking about the problem in terms of Amazon&#8217;s pricing structure (though because Amazon doesn&#8217;t charge for data transfer within s3 regions it really becomes the same as thinking in terms of minimizing http requests).  This kind of thing isn&#8217;t always a driver of implementation so it was a nice mental exercise.  Now we just have to hope they never change their pricing structure ðŸ˜‰</p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/webdev/serverprogramming/making-squishit-work-with-amazon/'>SquishIt Integration with Amazon S3 / Cloudfront</a><p>For the unfortunate souls not in the know (or is it the fortunate souls using&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/run-microsoft-windows-server-and-sql-ser/'>Run Microsoft Windows Server And SQL Server in the cloud on Amazon EC2</a><p>Run Microsoft Windows Server And SQL Server in the cloud on Amazon EC2 Amazon Elastic&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2><img class="bioPic" src="http://forum.lessthandot.com/download/file.php?avatar=56_1270084566.jpg" alt="User bio image"/>Alex is a software engineer from southeastern PA, where he lives with a lovely wife and a veritable smorgasbord of pets.  He loves mountain biking, open source software, barbecue and Syracuse basketball.<br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/AlexCuse" title="AlexCuse at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.linkedin.com/in/alexullrich" title="AlexCuse at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="/index.php/author/alexcuse/feed/" title="Blog RSS feed for AlexCuse" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 17,352 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/alexcuse/">Read More Posts by Alex Ullrich</a>
						</div>
					</div>
					<div>
						<label>Tags:</label> <a href="/index.php/tag/amazon/" rel="tag">amazon</a>, <a href="/index.php/tag/c/" rel="tag">c#</a>, <a href="/index.php/tag/linq/" rel="tag">linq</a>, <a href="/index.php/tag/rest/" rel="tag">rest</a>, <a href="/index.php/tag/s3/" rel="tag">s3</a> 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&text=RT @LessThanDot Blog - Copying Buckets With The Amazon S3 API by @AlexCuse" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API&source=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&quote=Copying Buckets With The Amazon S3 API" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/&title=Copying Buckets With The Amazon S3 API" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		6 Comments	</h4>
			<ol class="comments-list">
					<li class="comment byuser comment-author-chrissie1 even thread-even depth-1" id="comment-5326">
				<div id="div-comment-5326" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/70e155e88e0ead5e2bdcb3e1c57506b4?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/70e155e88e0ead5e2bdcb3e1c57506b4?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Christiaan Baes (chrissie1)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5326">
			May 29, 2012 at 1:04 pm</a>		</div>

		<p>Testing the commentsystem. You should be honored.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5326#respond' onclick='return addComment.moveForm( "div-comment-5326", "5326", "respond", "1629" )' aria-label='Reply to Christiaan Baes (chrissie1)'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-5327">
				<div id="div-comment-5327" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5327">
			May 29, 2012 at 2:03 pm</a>		</div>

		<p>I&#8217;m honored any time a luminary such as yourself gives me the time of day.  Good to see a note about a blog comment that seems almost like it was left by a human ðŸ™‚</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5327#respond' onclick='return addComment.moveForm( "div-comment-5327", "5327", "respond", "1629" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-5328">
				<div id="div-comment-5328" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/fa7ff42c42ae3c6aaa70cd93572d19f7?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/fa7ff42c42ae3c6aaa70cd93572d19f7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.simplicitycollectionsoftware.com/' rel='external nofollow' class='url'>Cody Marshall</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5328">
			June 5, 2012 at 2:23 pm</a>		</div>

		<p>In your ObjectsFor function, you have a do while loop, in the loop you are setting request.Marker to a response.NextMarker&#8230; however, you re-initialize a new request object in each round of the loop, I don&#8217;t see how setting request.Marker is even doing anything here&#8230; shouldn&#8217;t you pull your request instantiation out of the loop, perhaps like so:</p>
<p>    var request = new ListObjectsRequest()<br />
        .WithBucketName(bucketName);<br />
    var response = new ListObjectsResponse();<br />
    do<br />
    { <br />
        if(response.IsTruncated)<br />
        {<br />
            request.Marker = response.NextMarker;<br />
        }</p>
<p>        response = _s3Client.ListObjects(request);<br />
        result.AddRange(response.S3Objects);</p>
<p>    } while(response.IsTruncated);</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5328#respond' onclick='return addComment.moveForm( "div-comment-5328", "5328", "respond", "1629" )' aria-label='Reply to Cody Marshall'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-5329">
				<div id="div-comment-5329" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5329">
			June 5, 2012 at 2:31 pm</a>		</div>

		<p>Using a new request each time is by design.  Overwriting the *response* is what is important here so we have fresh values for IsTruncated and NextMarker when building the next request.  I suppose we could use the same request each time, but it just felt dirty to me. </p>
<p>The important thing is that NextMarker is set (if needed) between request construction and request execution.  So as long as the request is modified before the line:</p>
<p><codespan>response = _s3Client.ListObjects(request);</codespan></p>
<p>We are good.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5329#respond' onclick='return addComment.moveForm( "div-comment-5329", "5329", "respond", "1629" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-5330">
				<div id="div-comment-5330" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/fa7ff42c42ae3c6aaa70cd93572d19f7?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/fa7ff42c42ae3c6aaa70cd93572d19f7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.simplicitycollectionsoftware.com/' rel='external nofollow' class='url'>Cody Marshall</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5330">
			June 5, 2012 at 3:16 pm</a>		</div>

		<p>Oh right&#8230; request.Marker is set before ListObjects(request) is called.</p>
<p>Nevermind&#8230; and thanks for the response!</p>
<p>Cody</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5330#respond' onclick='return addComment.moveForm( "div-comment-5330", "5330", "respond", "1629" )' aria-label='Reply to Cody Marshall'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-5331">
				<div id="div-comment-5331" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/01528c1402523a792252f4e95c8217ca?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/01528c1402523a792252f4e95c8217ca?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='https://www.facebook.com/mesarim.vaher' rel='external nofollow' class='url'>Mesarim Vaher</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#comment-5331">
			March 9, 2013 at 11:50 am</a>		</div>

		<p>Thanks for this inspiring piece of code. I like the way you use LINQ and your insightful discussion along the article. This is an excellent article! Thumbs Up.</p>
<p>Regards,<br />
Messy V</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/?replytocom=5331#respond' onclick='return addComment.moveForm( "div-comment-5331", "5331", "respond", "1629" )' aria-label='Reply to Mesarim Vaher'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/webdev/serverprogramming/copying-buckets-with-the-amazon-s3-api/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='1629' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="912d2b1c7b2826caf99687388d2e8f7c"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765492"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
