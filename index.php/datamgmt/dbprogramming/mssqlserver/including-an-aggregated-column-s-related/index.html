<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   Including an Aggregated Column&#8217;s Related Values</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   Including an Aggregated Column&#8217;s Related Values" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="In this co-authored blog post, Naomi and I will present six different solutions to the commonly experienced query problem of how to include an aggregated column's related values - values from the same row in the group that provided the displayed value.&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; Including an Aggregated Column&#8217;s Related Values Comments Feed" href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Ecofont, Will this save the planet?' href='/index.php/itprofessionals/ethicsit/ecofont-will-this-save-the-planet/' />
<link rel='next' title='Setting SQLDataSource parameter from the code-behind' href='/index.php/webdev/webdesigngraphicsstyling/setting-sqldatasource-parameter-from-the/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/" />
<link rel='shortlink' href='/?p=510' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbprogramming%2Fmssqlserver%2Fincluding-an-aggregated-column-s-related%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbprogramming%2Fmssqlserver%2Fincluding-an-aggregated-column-s-related%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/webdev/webdesigngraphicsstyling/setting-sqldatasource-parameter-from-the/" rel="next">Setting SQLDataSource parameter from the code-behind</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/itprofessionals/ethicsit/ecofont-will-this-save-the-planet/" rel="prev">Ecofont, Will this save the planet?</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/" class="post-title">Including an Aggregated Column&#8217;s Related Values</a></h1>
					<div class="post-byline">by <a href="/index.php/author/emtucifor/" title="Posts by Erik" rel="author">Erik</a> on July 18, 2009 in category <a href="/index.php/category/datamgmt/dbprogramming/mssqlserver/" rel="category tag">Microsoft SQL Server</a>. Article views: 32,535 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&text=RT @LessThanDot Blog - Including an Aggregated Column&amp;#8217;s Related Values by emtucifor" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values&source=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&quote=Including an Aggregated Column&amp;#8217;s Related Values" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>In this co-authored blog post, <a href="http://forum.lessthandot.com/memberlist.php?mode=viewprofile&amp;u=314">Naomi</a> and I will present six different solutions to the commonly experienced query problem of how to include an aggregated column&#8217;s related values &#8211; values from the same row in the group that provided the displayed value.</p>
<h2>Background</h2>
<p>It&#8217;s a fairly simple query to select the maximum date for each group in a GROUP BY query. You just throw in a Max() on the date column and then GROUP BY the other columns. For example,</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;CustomerID,
&nbsp; &nbsp;LastOrderDate <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>
<span class="kw1">FROM</span> Orders
<span class="kw1">GROUP</span> <span class="kw1">BY</span> CustomerID</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   CustomerID,
   LastOrderDate = Max(OrderDate)
FROM Orders
GROUP BY CustomerID</pre></div></div>

<p>But a common query need is to include other column values from the same row as the most recent date. Unfortunately, putting aggregates on other columns doesn&#8217;t work:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;CustomerID,
&nbsp; &nbsp;LastOrderDate <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>,
&nbsp; &nbsp;LastSubTotal <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>SubTotal<span class="br0">&#41;</span> <span class="co1">-- wrong: won't be the subtotal from Max(OrderDate), but the greatest order total ever placed by this customer.</span>
<span class="kw1">FROM</span> Orders
<span class="kw1">GROUP</span> <span class="kw1">BY</span> CustomerID</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   CustomerID,
   LastOrderDate = Max(OrderDate),
   LastSubTotal = Max(SubTotal) -- wrong: won't be the subtotal from Max(OrderDate), but the greatest order total ever placed by this customer.
FROM Orders
GROUP BY CustomerID</pre></div></div>

<p>It&#8217;s almost like you need some kind of Max(OrderDate->SubTotal).</p>
<p>Note that the desired results are fairly easy in MS Access using the aggregate functions Last and First:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;CustomerID,
&nbsp; &nbsp;LastOrderDate <span class="sy0">=</span> <span class="kw1">Last</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>,
&nbsp; &nbsp;SubTotal <span class="sy0">=</span> <span class="kw1">Last</span><span class="br0">&#40;</span>SubTotal<span class="br0">&#41;</span>
<span class="kw1">FROM</span> Orders
<span class="kw1">GROUP</span> <span class="kw1">BY</span> CustomerID
<span class="kw1">ORDER</span> <span class="kw1">BY</span> OrderDate</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   CustomerID,
   LastOrderDate = Last(OrderDate),
   SubTotal = Last(SubTotal)
FROM Orders
GROUP BY CustomerID
ORDER BY OrderDate</pre></div></div>

<p>What happens in Access is that the Last() aggregate combines with the ORDER BY clause to select values from the row containing the most recent Order Date.</p>
<p>However, these functions are not available in SQL Server, likely because the query engine only does ordering at the very end, after GROUP BY and HAVING are processed. While this may seem like a defect, it is really a deliberate design trade-off, with compensations elsewhere in the engine.</p>
<h2>Test Case</h2>
<p>In order to have enough data to make results significant and also to let others run the same queries against the same data, we are going to use the AdventureWorks sample database.</p>
<p>In our scenario, we want to show customers&#8217; account numbers along with the date and subtotal of their most recent order. We&#8217;re keeping it simple for clarity, but note that you can include as many columns as you like. In a later installment we&#8217;ll do these same queries with more columns and different scenarios, and will expand on some of the queries a bit. We&#8217;ll also discuss performance to help you select between them.</p>
<p>Note that the aggregate doesn&#8217;t have to be on a date. Perhaps you want to know the date of the largest dollar value order per customer. In this case, you&#8217;d be doing a Max() on the order value instead of a date, and you would most certainly run into duplicates. Keep this in mind when reading below and when developing your own queries.</p>
<p>The basic query we&#8217;ll be working with is:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;LastOrderDate <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>O.<span class="me1">OrderDate</span><span class="br0">&#41;</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   LastOrderDate = Max(O.OrderDate)
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID</pre></div></div>

<p>What we want to do is also return the Subtotal value from the same row as the LastOrderDate.</p>
<h3>Some Approaches to the Problem</h3>
<p>We know of only a few basic approaches to the problem:</p>
<div>&#8211; <strong>Key Search</strong> &#8212; use the LastOrderDate column as a key (along with customer AccountNumber) to locate the correct rows in the OrderHeader table. This requires an extra join and also the key isn&#8217;t unique, so we might have to perform another Max() on a unique column and join another time, with the new column added to the key.</p>
<p>&#8211; <strong>Number and Filter</strong> &#8212; select all rows from OrderHeader, and number them in a way exploitable to correctly filter out unwanted rows. Observe that this won&#8217;t require hitting the table again, but it could use a lot of extra resources to temporarily materialize more data. Skipping over obvious poor choices such as a temp table with an ordered update or a cursor, options might be a windowing function (SQL 2005 and up) or a temp table with an identity column (SQL 2000).</p>
<p>&#8211; <strong>Simulate MS Access</strong> &#8212; simulate how MS Access works somehow, getting only the data we need in a single table access (seek or scan). Let&#8217;s imagine how the SQL engine already performs a Max. As it touches each row, it must store the intermediate value that is the best candidate so far for all the seen values. And it has to have one of these per group, per column. All that is needed is that every time it writes the Max() candidate into its temporary storage, it also writes the extra column we want into the same data.</p>
<p>How could we do this ourselves? We need to ORDER BY OrderDate but actually yield SubTotal. SubTotal clearly won&#8217;t sort in the correct order by itself. Remembering Max(OrderDate->SubTotal), what if it wasn&#8217;t by itself, and somehow contained the OrderDate, too, to make it sort properly? So here we have an idea about packing both columns into a single value that sorts correctly yet can still be used to get the SubTotal back out. When the engine does its Max() bit as usual on the date and stores the best candidate, it will also be forced to store the other value at the same time (which we can extract later).</p></div>
<p>So let&#8217;s use those ideas and turn them into real queries. Unless otherwise stated, queries will work with SQL Server 2000.</p>
<h2>Key Search</h2>
</p>
<h3>1. Correlated Subquery</h3>
<ul>
<li>Relies on unique order dates to avoid selecting multiple rows per customer.</li>
<li>Correlated subqueries perform well with small datasets and badly with large datasets (though better with SQL 2005 and 2008 because they can sometimes get converted to real joins).</li>
<li>Performance degrades geometrically as rows increase.</li>
<li>Does not handle NULLs correctly.</li>
</ul>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
<span class="kw1">WHERE</span>
&nbsp; &nbsp;O.<span class="me1">OrderDate</span> <span class="sy0">=</span> <span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw2">Max</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> SalesOrderHeader O2
&nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> O2.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span>
&nbsp; &nbsp;<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   O.OrderDate,
   O.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID 
WHERE
   O.OrderDate = (
      SELECT Max(OrderDate)
      FROM SalesOrderHeader O2
      WHERE O2.CustomerID = O.CustomerID
   )</pre></div></div>

<p>Another version of correlated subquery which sometimes performs much better is</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
<span class="kw1">WHERE</span>
&nbsp; &nbsp;O.<span class="me1">OrderID</span> <span class="sy0">=</span> <span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> <span class="kw1">top</span> <span class="nu0">1</span> OrderID 
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> SalesOrderHeader O2
&nbsp; &nbsp; &nbsp; <span class="kw1">WHERE</span> O2.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> <span class="kw1">order</span> <span class="kw1">by</span> O2.<span class="me1">OrderDate</span> <span class="kw1">Desc</span>, O2.<span class="me1">OrderID</span> <span class="kw1">DESC</span><span class="br0">&#41;</span>
&nbsp; &nbsp;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   O.OrderDate,
   O.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID 
WHERE
   O.OrderID = (
      SELECT top 1 OrderID 
      FROM SalesOrderHeader O2
      WHERE O2.CustomerID = O.CustomerID order by O2.OrderDate Desc, O2.OrderID DESC)
   </pre></div></div>

<p>Another variation of this query is (suggested by Alejandro Mesa (Hunchback) in this <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/0217ddf4-bcab-4f2b-a81c-70841753cb23">MSDN thread</a>):</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O1.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O1.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O1 <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O1.<span class="me1">CustomerID</span> 
<span class="kw1">WHERE</span> not exists <span class="br0">&#40;</span><span class="kw1">select</span> <span class="nu0">1</span> <span class="kw1">from</span> Sales.<span class="me1">SalesOrderHeader</span> O2 <span class="kw1">where</span> O2.<span class="me1">CustomerID</span> <span class="sy0">=</span> O1.<span class="me1">CustomerID</span> and O1.<span class="me1">OrderDate</span> <span class="sy0">&lt;</span> O2.<span class="me1">OrderDate</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   O1.OrderDate,
   O1.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O1 ON C.CustomerID = O1.CustomerID 
WHERE not exists (select 1 from Sales.SalesOrderHeader O2 where O2.CustomerID = O1.CustomerID and O1.OrderDate &lt; O2.OrderDate)</pre></div></div>

<p>Note, that the first variation of this query may return duplicate rows, but the second will always return only one row per group (with the latest OrderID).</p>
<p>The third variation of this query with NOT EXISTS will produce duplicates in case of the same date, but can also be easily adjusted to return only one row with the max OrderID:</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O1.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O1.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O1 <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O1.<span class="me1">CustomerID</span> 
<span class="kw1">WHERE</span> not exists <span class="br0">&#40;</span><span class="kw1">select</span> <span class="nu0">1</span> <span class="kw1">from</span> Sales.<span class="me1">SalesOrderHeader</span> O2 <span class="kw1">where</span> O2.<span class="me1">CustomerID</span> <span class="sy0">=</span> O1.<span class="me1">CustomerID</span> and <span class="br0">&#40;</span>O1.<span class="me1">OrderDate</span> <span class="sy0">&lt;</span> O2.<span class="me1">OrderDate</span> <span class="sy0">OR</span> 
<span class="br0">&#40;</span>O1.<span class="me1">OrderDate</span> <span class="sy0">=</span> O2.<span class="me1">OrderDate</span> and O1.<span class="me1">OrderID</span> <span class="sy0">&lt;</span> O2.<span class="me1">OrderID</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   O1.OrderDate,
   O1.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O1 ON C.CustomerID = O1.CustomerID 
WHERE not exists (select 1 from Sales.SalesOrderHeader O2 where O2.CustomerID = O1.CustomerID and (O1.OrderDate &lt; O2.OrderDate OR 
(O1.OrderDate = O2.OrderDate and O1.OrderID &lt; O2.OrderID)))</pre></div></div>

</p>
<h3>2. Derived Table</h3>
</p>
<ul>
<li>Relies on unique order dates to avoid selecting multiple rows per customer.</li>
<li>Performs better than the correlated subquery when querying a significant portion of all customers, but worse when only querying a few, since the last order date for every customer is always calculated.</li>
<li>Performance degrades linearly as rows increase.</li>
<li>Does not handle NULLs correctly.</li>
</ul>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> <span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span> CustomerID, LastOrderDate <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">GROUP</span> <span class="kw1">BY</span> CustomerID
&nbsp; &nbsp;<span class="br0">&#41;</span> O2 <span class="kw1">ON</span> O.<span class="me1">CustomerID</span> <span class="sy0">=</span> O2.<span class="me1">CustomerID</span> <span class="sy0">AND</span> O.<span class="me1">OrderDate</span> <span class="sy0">=</span> O2.<span class="me1">LastOrderDate</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   C.AccountNumber,
   O.OrderDate,
   O.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID 
   INNER JOIN (
      SELECT CustomerID, LastOrderDate = Max(OrderDate)
      FROM Sales.SalesOrderHeader
      GROUP BY CustomerID
   ) O2 ON O.CustomerID = O2.CustomerID AND O.OrderDate = O2.LastOrderDate</pre></div></div>

<p></p>
<h2>Number and Filter</h2>
</p>
<h3>Windowing Functions</h3>
<p>The windowing functions were introduced in SQL Server 2005, so the two queries below will not work in SQL Server 2000.</p>
<ul>
<li>Will always return one row per customer. Using RANK() instead of ROW_NUMBER() will yield the same results as queries 1 and 2.</li>
<li>Easily supports not just 1 but <em>n</em> rows per group.</li>
<li>Performance degrades fairly linearly as rows increase. The windowing functions are fast but huge rowsets can begin to bog them down.</li>
</ul>
<h3>3. Windowing Function &#8211; Two Stages</h3>
</p>
<ul>
<li>A common table expression is not needed, but is cleaner. The CTE query can be made into a derived table if desired.</li>
</ul>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">WITH</span> OrderData <span class="kw1">AS</span> <span class="br0">&#40;</span>
&nbsp; &nbsp;<span class="kw1">SELECT</span>
&nbsp; &nbsp; &nbsp; C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp; &nbsp; O.<span class="me1">OrderDate</span>,
&nbsp; &nbsp; &nbsp; O.<span class="me1">SubTotal</span>,
&nbsp; &nbsp; &nbsp; Selector <span class="sy0">=</span> ROW_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span>PARTITION <span class="kw1">BY</span> O.<span class="me1">CustomerID</span> <span class="kw1">ORDER</span> <span class="kw1">BY</span> O.<span class="me1">OrderDate</span> <span class="kw1">DESC</span><span class="br0">&#41;</span>
&nbsp; &nbsp;<span class="kw1">FROM</span>
&nbsp; &nbsp; &nbsp; Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp; &nbsp; <span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> AccountNumber, OrderDate, SubTotal
<span class="kw1">FROM</span> OrderData
<span class="kw1">WHERE</span> Selector <span class="sy0">=</span> <span class="nu0">1</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">WITH OrderData AS (
   SELECT
      C.AccountNumber,
      O.OrderDate,
      O.SubTotal,
      Selector = ROW_NUMBER() OVER (PARTITION BY O.CustomerID ORDER BY O.OrderDate DESC)
   FROM
      Sales.Customer C
      INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID 
)
SELECT AccountNumber, OrderDate, SubTotal
FROM OrderData
WHERE Selector = 1</pre></div></div>

<h3>4. Windowing Function &#8211; One Stage</h3>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="kw1">TOP</span> <span class="nu0">1</span> <span class="kw1">WITH</span> TIES
&nbsp; &nbsp;C.<span class="me1">AccountNumber</span>,
&nbsp; &nbsp;O.<span class="me1">OrderDate</span>,
&nbsp; &nbsp;O.<span class="me1">SubTotal</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;Sales.<span class="me1">Customer</span> C
&nbsp; &nbsp;<span class="kw1">INNER</span> <span class="sy0">JOIN</span> Sales.<span class="me1">SalesOrderHeader</span> O <span class="kw1">ON</span> C.<span class="me1">CustomerID</span> <span class="sy0">=</span> O.<span class="me1">CustomerID</span> 
<span class="kw1">ORDER</span> <span class="kw1">BY</span>
&nbsp; &nbsp;ROW_NUMBER<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">OVER</span> <span class="br0">&#40;</span>PARTITION <span class="kw1">by</span> O.<span class="me1">CustomerID</span> <span class="kw1">ORDER</span> <span class="kw1">BY</span> OrderDate <span class="kw1">DESC</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT TOP 1 WITH TIES
   C.AccountNumber,
   O.OrderDate,
   O.SubTotal
FROM
   Sales.Customer C
   INNER JOIN Sales.SalesOrderHeader O ON C.CustomerID = O.CustomerID 
ORDER BY
   ROW_NUMBER() OVER (PARTITION by O.CustomerID ORDER BY OrderDate DESC)</pre></div></div>

<p></p>
<h2>Simulate MS Access</h2>
</p>
<h3>5. Compound Key, aka Packed Values</h3>
<ul>
<li>Uses only one table access with a simple GROUP BY.</li>
<li>Naomi first learned this idea from <a href="http://forum.foxclub.ru/read.php?32,177183,177232#msg-177232">a Russian SQL FAQ</a>.</li>
<li>Erik cooked up a similar idea in 2008.</li>
<li>This example uses a varchar column to hold the packed values, but be aware that converting to and from binary is faster than char (plus harder to use and more error-prone) and binary aggregation is faster. The crucial part is being able to faithfully extract the data that was put in.</li>
<li>This query has no problem with duplicates. It does effectively sort by the full compound value, so if multiple orders for the same customer can be on the same order date and you want some other column to determine which one is selected, it has to be included in the packed data.</li>
<li>As given, this query does not handle NULLs at all. A few strategic Coalesces can fix that.</li>
<li>There is no significant performance difference between unpacking one many-item compound value or many one-item compound values (though you&#8217;d always include all columns needed for ordering).</li>
</ul>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span>
&nbsp; &nbsp;CustomerID,
&nbsp; &nbsp;LastOrderDate,
&nbsp; &nbsp;LastSubTotal <span class="sy0">=</span> <span class="kw1">Convert</span><span class="br0">&#40;</span><span class="kw1">money</span>, <span class="kw2">Substring</span><span class="br0">&#40;</span>DateAndSubtotal, <span class="nu0">20</span>, <span class="nu0">25</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="kw1">FROM</span>
&nbsp; &nbsp;<span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">SELECT</span>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CustomerID,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LastOrderDate <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span>OrderDate<span class="br0">&#41;</span>,
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;DateAndSubtotal <span class="sy0">=</span> <span class="kw2">Max</span><span class="br0">&#40;</span><span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span>, OrderDate, <span class="nu0">121</span><span class="br0">&#41;</span> <span class="sy0">+</span> <span class="kw1">Convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span>, Subtotal<span class="br0">&#41;</span><span class="br0">&#41;</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">FROM</span> Sales.<span class="me1">SalesOrderHeader</span>
&nbsp; &nbsp; &nbsp; <span class="kw1">GROUP</span> <span class="kw1">BY</span> CustomerID
&nbsp; &nbsp;<span class="br0">&#41;</span> X</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT
   CustomerID,
   LastOrderDate,
   LastSubTotal = Convert(money, Substring(DateAndSubtotal, 20, 25))
FROM
   (
      SELECT
         CustomerID,
         LastOrderDate = Max(OrderDate),
         DateAndSubtotal = Max(convert(varchar(50), OrderDate, 121) + Convert(varchar(50), Subtotal))
      FROM Sales.SalesOrderHeader
      GROUP BY CustomerID
   ) X</pre></div></div>

<p>Isn&#8217;t that cool? I don&#8217;t advocate using it all the time, but when performance is bad and the trade-offs are worth it, do it.</p>
<p>In closing, thank you for visiting. We hope this is useful to you. You might like to see the next installment <a href="/index.php/DataMgmt/DataDesign/including-an-aggregated-column-s-related-2">Including an Aggregated Column&#8217;s Related Values &#8211; Part 2</a>, discussing this issue in further depth.</p>
<p>Erik</p>
<p>P.S. I would like to thank <a href="http://forum.lessthandot.com/memberlist.php?mode=viewprofile&amp;u=314">Naomi</a> for co-authoring this blog post with me. She did the heavy lifting of actually writing queries and testing their performance; I just fleshed out the explanations a bit.</p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/including-an-aggregated-column-s-related-2/'>Including an Aggregated Column's Related Values - Part 2</a><p>This blog post contains test cases for the first article in the series Including an&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/the-ten-most-asked-sql-server-questions-1/'>The Ten Most Asked SQL Server Questions And Their Answers</a><p>If you are active in the SQL Server newsgroups and forums as I am, you&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2>Erik has been working in IT since 1993 and starting in 2004 has specialized in MS SQL Server query writing, database design, and reporting services. He also professionally does web site design/developing and writes C# applications (mostly for projects involving his databases and web sites).

His career in the industry truly started when he first began using computers in the late 70s. In 1984 he began programming on the IBM PCJr, and performed game testing on King's Quest I. These early experiences gave him the taste and drive to continue an incremental and self-taught path all the way to his current position.

Erik is also interested in taekwondo, go (ranks 4k on KGS), sci-fi books, mathematics, philosophy, religion, and rollerblading. He and his family live on the West Coast of the US.<br style="clear: left" /></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 32,535 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/emtucifor/">Read More Posts by Erik</a>
						</div>
					</div>
					<div>
						 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&text=RT @LessThanDot Blog - Including an Aggregated Column&amp;#8217;s Related Values by emtucifor" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values&source=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&quote=Including an Aggregated Column&amp;#8217;s Related Values" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/&title=Including an Aggregated Column&amp;#8217;s Related Values" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		16 Comments	</h4>
			<ol class="comments-list">
					<li class="comment byuser comment-author-SQLDenis even thread-even depth-1" id="comment-1569">
				<div id="div-comment-1569" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1569">
			July 19, 2009 at 9:00 am</a>		</div>

		<p>Excellent post and much needed. Thank you both.</p>
<p>I actually ask this question when I interview people and I can tell you that 95% of the people are NOT able to write any of these 5 versions. They can write a query that gives the max for one column for example but when you tell them that you want all the columns it becomes problematic</p>
<p>Would love to see the performance differences between the 5 queries</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1569#respond' onclick='return addComment.moveForm( "div-comment-1569", "1569", "respond", "510" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-onpnt odd alt thread-odd thread-alt depth-1" id="comment-1572">
				<div id="div-comment-1572" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9666550a97e912e0dff5023dddb78e64?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/9666550a97e912e0dff5023dddb78e64?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ted Krueger (onpnt)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1572">
			July 20, 2009 at 5:58 am</a>		</div>

		<p>Agree, this is a really good post and one that deffinetely gets people.  I had to work with my SQL Dev a few times getting over this hill.  </p>
<p>Very nice Erik and Naomi!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1572#respond' onclick='return addComment.moveForm( "div-comment-1572", "1572", "respond", "510" )' aria-label='Reply to Ted Krueger (onpnt)'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-thirster42 even thread-even depth-1" id="comment-1575">
				<div id="div-comment-1575" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/026f3abfbd6ac89b6dbabbd4cef2e83d?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/026f3abfbd6ac89b6dbabbd4cef2e83d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">David Forck (thirster42)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1575">
			July 21, 2009 at 7:25 am</a>		</div>

		<p>good read.  still haven&#8217;t quite wrapped my mind on how row_number works.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1575#respond' onclick='return addComment.moveForm( "div-comment-1575", "1575", "respond", "510" )' aria-label='Reply to David Forck (thirster42)'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1580">
				<div id="div-comment-1580" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/51e7a057f06038ca919f246ad945a411?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/51e7a057f06038ca919f246ad945a411?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Moacyr Zalcman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1580">
			July 28, 2009 at 6:48 am</a>		</div>

		<p>Excellent post, in Universal Thread I asked this matter and normally use the CTE approach, but is important to have things clarified as this post does.</p>
<p>Thanks</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1580#respond' onclick='return addComment.moveForm( "div-comment-1580", "1580", "respond", "510" )' aria-label='Reply to Moacyr Zalcman'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1570">
				<div id="div-comment-1570" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1016fc37c71635a4bdad17ac9482b36a?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1016fc37c71635a4bdad17ac9482b36a?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1570">
			November 10, 2009 at 2:21 pm</a>		</div>

		<p>Great post. </p>
<p>For the Simulate MS Access compound key solution I found that using a style of 126 as in the following: </p>
<p>MAX(CONVERT(VARCHAR(50), OrderDate, 126)</p>
<p>produced inconsistent datetime lengths for the data I had.</p>
<p>I used the following:</p>
<p>MAX(CONVERT(VARCHAR(50), OrderDate, 20) and it worked ok for me.</p>
<p>I would like to thank you for a great post. One of the best I have seen on the internet.</p>
<p>cheers<br />
Mark</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1570#respond' onclick='return addComment.moveForm( "div-comment-1570", "1570", "respond", "510" )' aria-label='Reply to Mark'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-emtucifor bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-1571">
				<div id="div-comment-1571" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Erik</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1571">
			November 10, 2009 at 4:02 pm</a>		</div>

		<p>Mark,</p>
<p>Thanks for the compliment!</p>
<p>About the lengths, that&#8217;s very interesting. I don&#8217;t understand how style 126 would give inconsistent lengths, since each value is padded out to its max length. Could you give some examples of values that resulted in different lengths?</p>
<p>I can at least say for certain that using style 20 will not give correct results because it loses precision by truncating the milliseconds portion of the given datetime.</p>
<p>Style 126: 2009-11-10T15:03:01.003<br />
Style <span style="visibility:hidden">0</span>20: 2009-11-10<span style="visibility:hidden">T</span>15:03:01</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1571#respond' onclick='return addComment.moveForm( "div-comment-1571", "1571", "respond", "510" )' aria-label='Reply to Erik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1573">
				<div id="div-comment-1573" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1016fc37c71635a4bdad17ac9482b36a?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1016fc37c71635a4bdad17ac9482b36a?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1573">
			November 11, 2009 at 3:50 pm</a>		</div>

		<p>Hi Emtucifor</p>
<p>Please look at these dates</p>
<p>2009-07-27 12:22:44.537      datetime     <br />
2009-07-27T12:22:44.537      Style 126</p>
<p>2005-11-21 00:00:00.000      datetime    <br />
2005-11-21T00:00:00          Style 126</p>
<p>
When the time portion of the datetime is zero it will have a smaller length.</p>
<p>Zero Time is very common in migrated dates from a database with dates only.</p>
<p>Please advise if you get the same results or if I have made a mistake</p>
<p>regards<br />
Mark</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1573#respond' onclick='return addComment.moveForm( "div-comment-1573", "1573", "respond", "510" )' aria-label='Reply to Mark'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-emtucifor bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-1574">
				<div id="div-comment-1574" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Erik</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1574">
			November 11, 2009 at 4:43 pm</a>		</div>

		<p>Thank you, Mark! You are correct. I will fix the blog post. For style 126, the milliseconds portion of the date is left off when it is zero. This is very disappointing because in Books Online it says:</p>
<p>CAST and CONVERT (Transact-SQL) <br />
Style 126<br />
Standard ISO8601<br />
Input/Output yyyy-mm-ddThh:mm:ss.mmm (no spaces)</p>
<p>This led me to believe that it would always display mmm. There is no notation about mmm being suppressed when milliseconds are 0.</p>
<p>It looks like style 121 (ODBC canonical with milliseconds) is now demonstrably superior to style 127, no thanks to Microsoft.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1574#respond' onclick='return addComment.moveForm( "div-comment-1574", "1574", "respond", "510" )' aria-label='Reply to Erik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-naomi even thread-even depth-1" id="comment-1579">
				<div id="div-comment-1579" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Naomi Nosonovsky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1579">
			March 10, 2010 at 8:53 am</a>		</div>

		<p>Please see this thread <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/36fa158c-184a-45fa-8875-9a4ffff33c3b"> for an interesting discussion</a> &#8211; looks like we may want to perform more tests.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1579#respond' onclick='return addComment.moveForm( "div-comment-1579", "1579", "respond", "510" )' aria-label='Reply to Naomi Nosonovsky'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-naomi odd alt thread-odd thread-alt depth-1" id="comment-1576">
				<div id="div-comment-1576" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Naomi Nosonovsky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1576">
			April 29, 2010 at 10:09 pm</a>		</div>

		<p>I made some changes today based on <a href="http://social.msdn.microsoft.com/Forums/en-US/transactsql/thread/0217ddf4-bcab-4f2b-a81c-70841753cb23">this thread</a>.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1576#respond' onclick='return addComment.moveForm( "div-comment-1576", "1576", "respond", "510" )' aria-label='Reply to Naomi Nosonovsky'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1577">
				<div id="div-comment-1577" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/03ce22e24e353992698c07ff23f15b7d?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/03ce22e24e353992698c07ff23f15b7d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Paul</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1577">
			November 2, 2011 at 6:20 am</a>		</div>

		<p>Very useful post. I only use SQL2000 and had come up with method 1 from my own first principles. </p>
<p>Method 2 was very ineresting and for my complex piece of work was more efficient.</p>
<p>I did however eventually use a method not listed here. I precalculated the value I needed and stored that max value on the parent table (couldn&#8217;t use a #temp). The execution time pre-calculation plus the actual query together was less than either method 1 or 2.</p>
<p>Perhaps not elegant or normalised but it was faster.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1577#respond' onclick='return addComment.moveForm( "div-comment-1577", "1577", "respond", "510" )' aria-label='Reply to Paul'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-emtucifor bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-1578">
				<div id="div-comment-1578" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Erik</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1578">
			November 2, 2011 at 10:39 am</a>		</div>

		<p>@Paul,</p>
<p>As long as the max value is unique per parent scope you are in good shape with that method. Saving values temporarily to a table is often a good way to increase performance as this uses a smaller resource footprint and guarantees the engine&#8217;s fast choice of correct execution plan for each individual step.</p>
<p>I would, however, caution against storing temporary Max values in parent tables. If the column is intended to be permanent, then your table is badly denormalized and the value can become out of synch. If the column is intended to be temporary, then one shouldn&#8217;t be mucking up the transaction log with spurious updates to a table that hasn&#8217;t actually changed. Instead, I would use a temp table, which will only affect tempdb and for any appreciable number of rows could be superior to a table variable as it will have statistics aiding in execution plan choice.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1578#respond' onclick='return addComment.moveForm( "div-comment-1578", "1578", "respond", "510" )' aria-label='Reply to Erik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1581">
				<div id="div-comment-1581" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/016210a6d523126277ac27ac063cecd5?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/016210a6d523126277ac27ac063cecd5?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">bob</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1581">
			February 24, 2012 at 11:02 am</a>		</div>

		<p>This is a great summay of different approaches.  It would be really helpful if it could be supplemented by some example performance data.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1581#respond' onclick='return addComment.moveForm( "div-comment-1581", "1581", "respond", "510" )' aria-label='Reply to bob'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-naomi odd alt thread-odd thread-alt depth-1" id="comment-1582">
				<div id="div-comment-1582" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/61e248e3f536e25c08658d205808b113?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Naomi Nosonovsky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1582">
			February 24, 2012 at 2:32 pm</a>		</div>

		<p>Did you see this blog post<br />
<a href="/index.php/DataMgmt/DataDesign/including-an-aggregated-column-s-related-2">Including aggregated column&#8217;s related values &#8211; part 2</a></p>
<p>The reference is at the bottom of this blog post</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1582#respond' onclick='return addComment.moveForm( "div-comment-1582", "1582", "respond", "510" )' aria-label='Reply to Naomi Nosonovsky'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1568">
				<div id="div-comment-1568" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/d72b25890498cc94bfcaac7703da3616?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/d72b25890498cc94bfcaac7703da3616?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://solar-roof-tiles.co.uk/' rel='external nofollow' class='url'>Samuel Lilleker</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-1568">
			October 2, 2012 at 7:47 am</a>		</div>

		<p>Thanks for this post helped me loads!</p>
<p>I am using this as part of a script to grab unique email addresses attached to user accounts as part of migrating to a new website. The new site has different user account restraints ie unique emails. old site many user account could have the same email addresses so had to find the usernames with most recent activity. Thanks again!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=1568#respond' onclick='return addComment.moveForm( "div-comment-1568", "1568", "respond", "510" )' aria-label='Reply to Samuel Lilleker'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="pingback odd alt thread-odd thread-alt depth-1" id="comment-5681514">
				<div id="div-comment-5681514" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.codingblog.cn/blog/109405.html' rel='external nofollow' class='url'>sql server只使用最近的值选择不同的行 &#8211; CodingBlog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#comment-5681514">
			June 8, 2017 at 3:59 pm</a>		</div>

		<p>[&#8230;] also Including an Aggregated Column&#8217;s Related Values for 5 different ways to do this kind of [&#8230;]</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/?replytocom=5681514#respond' onclick='return addComment.moveForm( "div-comment-5681514", "5681514", "respond", "510" )' aria-label='Reply to sql server只使用最近的值选择不同的行 &#8211; CodingBlog'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/datamgmt/dbprogramming/mssqlserver/including-an-aggregated-column-s-related/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='510' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="320722549d1751cf3f247855f937b982"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552766453"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
