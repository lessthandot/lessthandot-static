<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="A couple of days ago a coworker was having problems with an insert statement. This insert statement needed to insert data into a table if that data didn't already exists in the table he was inserting to.The table he was inserting to had about 20 mil&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller Comments Feed" href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Book Review &#8211; NHibernate 3.0 Cookbook' href='/index.php/desktopdev/mstech/book-review-nhibernate-3-0-cookbook/' />
<link rel='next' title='What SQL Server book would you recommend for a Sybase and Oracle admin?' href='/index.php/datamgmt/dbprogramming/what-sql-server-book-would-you-recommend/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/" />
<link rel='shortlink' href='/?p=934' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbprogramming%2Fuse-a-outer-loop-join-for-faster-perform%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbprogramming%2Fuse-a-outer-loop-join-for-faster-perform%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/datamgmt/dbprogramming/what-sql-server-book-would-you-recommend/" rel="next">What SQL Server book would you recommend for a Sybase and Oracle admin?</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/desktopdev/mstech/book-review-nhibernate-3-0-cookbook/" rel="prev">Book Review &#8211; NHibernate 3.0 Cookbook</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/" class="post-title">Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller</a></h1>
					<div class="post-byline">by <a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis" rel="author">SQLDenis</a> on November 5, 2010 in category <a href="/index.php/category/datamgmt/dbprogramming/" rel="category tag">Database Programming</a> <a href="/index.php/category/datamgmt/dbprogramming/mssqlserver/" rel="category tag">Microsoft SQL Server</a>. Article views: 20,193 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&text=RT @LessThanDot Blog - Use an  OUTER LOOP JOIN for faster performance when one of the tables is mu... by @denisgobo" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller&source=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&quote=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>A couple of days ago a coworker was having problems with an insert statement. This insert statement needed to insert data into a table if that data didn&#8217;t already exists in the table he was inserting to.</p>
<p>The table he was inserting to had about 20 million rows and the table he was inserting from had about 100 thousand rows. The problem he had was that the left join that checked if the rows existed was nor performing very well. Since one table was much smaller compared to the other table I suggested a <em>left outer loop join</em>. Once he changed to the <em>left outer loop join</em> the query was about 20 times faster because now it performed an index seek instead of an index scan.</p>
<p>Here is what Books On Line has to say about <a href="http://msdn.microsoft.com/en-us/library/ms191318.aspx">Nested loop joins</a></p>
<blockquote><p>A nested loops join is particularly effective if the outer input is small and the inner input is preindexed and large. In many small transactions, such as those affecting only a small set of rows, index nested loops joins are superior to both merge joins and hash joins. In large queries, however, nested loops joins are often not the optimal choice.</p></blockquote>
<p>Of course it would be nice if we had some code that showed the difference, the code in this article will use the following 3 methods:</p>
<p>regular left join<br />
not exists<br />
left loop join</p>
<p>First we need to create some data, in order to do that we will create a small table and then use that in a cross join to populate the table which will hold 20 million rows.</p>
<p>This table will hold values from AAA until ZZZ</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> TestSomeValue <span class="br0">&#40;</span>SomeChar <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
go
&nbsp;
;<span class="kw1">with</span> cte <span class="kw1">as</span><span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="kw1">char</span><span class="br0">&#40;</span>number<span class="br0">&#41;</span> <span class="kw1">as</span> charnum
<span class="kw1">from</span> master..<span class="me1">spt_values</span>
<span class="kw1">where</span> type <span class="sy0">=</span> <span class="st0">'p'</span>
and number between <span class="nu0">65</span> and <span class="nu0">90</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">insert</span> TestSomeValue
<span class="kw1">select</span> c.<span class="me1">charnum</span> <span class="sy0">+</span> c2.<span class="me1">charnum</span> <span class="sy0">+</span> c3.<span class="me1">charnum</span> 
<span class="kw1">from</span> cte c cross join cte c2
cross join cte c3</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table TestSomeValue (SomeChar char(3))
go

;with cte as(
select char(number) as charnum
from master..spt_values
where type = 'p'
and number between 65 and 90)

insert TestSomeValue
select c.charnum + c2.charnum + c3.charnum 
from cte c cross join cte c2
cross join cte c3</pre></div></div>

<p>This will be our large table with 20212400 rows, this might run for a couple of minutes</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> TestLarge <span class="br0">&#40;</span>SomeValue <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span>, SomeDate <span class="kw1">datetime</span>, SomeFlag <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>, SomeOtherValue <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
go
&nbsp;
&nbsp;
&nbsp;
<span class="kw1">insert</span> TestLarge
<span class="kw1">select</span> <span class="sy0">*</span>,<span class="nu0">1</span>,NEWID<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">from</span> TestSomeValue t
cross join <span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="kw2">dateadd</span><span class="br0">&#40;</span>dd,number,<span class="st0">'20010101'</span><span class="br0">&#41;</span> <span class="kw1">as</span> SomeDate
<span class="kw1">from</span> master..<span class="me1">spt_values</span>
<span class="kw1">where</span> type <span class="sy0">=</span> <span class="st0">'p'</span>
and number <span class="sy0">&lt;</span> <span class="nu0">1150</span><span class="br0">&#41;</span> x</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table TestLarge (SomeValue char(3), SomeDate datetime, SomeFlag char(1), SomeOtherValue varchar(100))
go



insert TestLarge
select *,1,NEWID() from TestSomeValue t
cross join (
select dateadd(dd,number,'20010101') as SomeDate
from master..spt_values
where type = 'p'
and number &lt; 1150) x</pre></div></div>

<p>This will be our small table and will have 115456 rows</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">table</span> TestSmall <span class="br0">&#40;</span>SomeValue <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">3</span><span class="br0">&#41;</span>, SomeDate <span class="kw1">datetime</span>, SomeFlag <span class="kw1">char</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span>, SomeOtherValue <span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
go
&nbsp;
<span class="co1">--insert 105456 rows that do not exist</span>
<span class="kw1">insert</span> TestSmall
<span class="kw1">select</span> <span class="sy0">*</span>,<span class="nu0">1</span>,NEWID<span class="br0">&#40;</span><span class="br0">&#41;</span> <span class="kw1">from</span> TestSomeValue t
cross join <span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="kw2">dateadd</span><span class="br0">&#40;</span>dd,number,<span class="st0">'20010101'</span><span class="br0">&#41;</span> <span class="kw1">as</span> SomeDate
<span class="kw1">from</span> master..<span class="me1">spt_values</span>
<span class="kw1">where</span> type <span class="sy0">=</span> <span class="st0">'p'</span>
and number between <span class="nu0">1160</span> and <span class="nu0">1165</span><span class="br0">&#41;</span> x
&nbsp;
<span class="co1">--insert 10000 rows that do exist</span>
<span class="kw1">insert</span> TestSmall
<span class="kw1">select</span> <span class="kw1">top</span> <span class="nu0">10000</span> <span class="sy0">*</span> 
<span class="kw1">from</span> TestLarge</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create table TestSmall (SomeValue char(3), SomeDate datetime, SomeFlag char(1), SomeOtherValue varchar(100))
go

--insert 105456 rows that do not exist
insert TestSmall
select *,1,NEWID() from TestSomeValue t
cross join (
select dateadd(dd,number,'20010101') as SomeDate
from master..spt_values
where type = 'p'
and number between 1160 and 1165) x

--insert 10000 rows that do exist
insert TestSmall
select top 10000 * 
from TestLarge</pre></div></div>

<p>Create a clustered index on both tables, this also might take a couple of minutes</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">create</span> <span class="kw1">clustered</span> <span class="kw1">index</span> ix_TestSmall <span class="kw1">on</span> TestSmall<span class="br0">&#40;</span>SomeValue,SomeDate,SomeFlag,SomeOtherValue<span class="br0">&#41;</span>
go
&nbsp;
&nbsp;
<span class="kw1">create</span> <span class="kw1">clustered</span> <span class="kw1">index</span> ix_TestLarge <span class="kw1">on</span> TestLarge<span class="br0">&#40;</span>SomeValue,SomeDate,SomeFlag,SomeOtherValue<span class="br0">&#41;</span>
go</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">create clustered index ix_TestSmall on TestSmall(SomeValue,SomeDate,SomeFlag,SomeOtherValue)
go


create clustered index ix_TestLarge on TestLarge(SomeValue,SomeDate,SomeFlag,SomeOtherValue)
go</pre></div></div>

<p>Here we have the 3 versions of the same kind of query, a plain vanilla left join, a not exist and a left loop join</p>
<p>Include the actual execution plan and run these 3 queries</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="de1"><pre class="de1"><span class="kw1">Select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null
&nbsp;
<span class="kw1">select</span> <span class="kw2">count</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> &nbsp;<span class="co1">--105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">where</span> not exists <span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="nu0">1</span> <span class="kw1">from</span> &nbsp;TestLarge t2 <span class="kw1">where</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> outer loop join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">Select COUNT(*) -- 105456
from TestSmall t1
left join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null

select count(*)  --105456
from TestSmall t1
where not exists (
select 1 from  TestLarge t2 where t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue)

select COUNT(*) -- 105456
from TestSmall t1
left outer loop join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null</pre></div></div>

<p>Below is the execution plan generated when you run these 3 queries, click on the image for a larger version.</p>
<div class="image_block"><img src="/wp-content/uploads/blogs/DataMgmt/ExecutionPlan.png" alt="Execution Plan" title="Execution Plan" width="979" height="521" /></div>
<p>As you can see the loop join doesn&#8217;t look that impressive compared to the rest, however it is the only query that does a seek instead of a scan</p>
<p>What about the reads? Run the following query</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre></td><td class="de1"><pre class="de1"><span class="kw1">set</span> <span class="kw1">statistics</span> io <span class="kw1">on</span>
go
<span class="kw1">select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null
&nbsp;
<span class="kw1">select</span> <span class="kw2">count</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> &nbsp;<span class="co1">--105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">where</span> not exists <span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="nu0">1</span> <span class="kw1">from</span> &nbsp;TestLarge t2 <span class="kw1">where</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> outer loop join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null
&nbsp;
<span class="kw1">set</span> <span class="kw1">statistics</span> io <span class="kw1">off</span>
go</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">set statistics io on
go
select COUNT(*) -- 105456
from TestSmall t1
left join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null

select count(*)  --105456
from TestSmall t1
where not exists (
select 1 from  TestLarge t2 where t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue)

select COUNT(*) -- 105456
from TestSmall t1
left outer loop join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null

set statistics io off
go</pre></div></div>

<p>Here is what is returned<br />
<strong>Left Join</strong><br />
Table &#8216;Worktable&#8217;. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0<br />
Table &#8216;TestLarge&#8217;. Scan count 1, logical reads 159177, physical reads 0, read-ahead reads 0<br />
Table &#8216;TestSmall&#8217;. Scan count 1, logical reads 913, physical reads 0, read-ahead reads 0</p>
<p><strong>Not Exist</strong><br />
Table &#8216;TestSmall&#8217;. Scan count 1, logical reads 913, physical reads 0, read-ahead reads 0<br />
Table &#8216;TestLarge&#8217;. Scan count 1, logical reads 159177, physical reads 0, read-ahead reads 0</p>
<p><strong>Left Loop Join</strong><br />
Table &#8216;TestLarge&#8217;. Scan count 115456, logical reads 492566, physical reads 0, read-ahead reads 0<br />
Table &#8216;TestSmall&#8217;. Scan count 3, logical reads 1006, physical reads 0, read-ahead reads 0<br />
Table &#8216;Worktable&#8217;. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0</p>
<p>Finally let&#8217;s look at how long each query took</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre></td><td class="de1"><pre class="de1"><span class="kw1">set</span> <span class="kw1">statistics</span> <span class="kw1">time</span> <span class="kw1">on</span>
go
<span class="kw1">select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null
&nbsp;
<span class="kw1">select</span> <span class="kw2">count</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> &nbsp;<span class="co1">--105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">where</span> not exists <span class="br0">&#40;</span>
<span class="kw1">select</span> <span class="nu0">1</span> <span class="kw1">from</span> &nbsp;TestLarge t2 <span class="kw1">where</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span><span class="br0">&#41;</span>
&nbsp;
<span class="kw1">select</span> <span class="kw2">COUNT</span><span class="br0">&#40;</span><span class="sy0">*</span><span class="br0">&#41;</span> <span class="co1">-- 105456</span>
<span class="kw1">from</span> TestSmall t1
<span class="kw1">left</span> outer loop join TestLarge t2 <span class="kw1">on</span> t1.<span class="me1">SomeValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeValue</span>
and t1.<span class="me1">SomeDate</span> <span class="sy0">=</span>t2.<span class="me1">SomeDate</span>
and t1.<span class="me1">SomeFlag</span> <span class="sy0">=</span> t2.<span class="me1">SomeFlag</span>
and t1.<span class="me1">SomeOtherValue</span> <span class="sy0">=</span> t2.<span class="me1">SomeOtherValue</span>
<span class="kw1">where</span> t2.<span class="me1">SomeValue</span> <span class="kw1">is</span> null
&nbsp;
&nbsp;
<span class="kw1">set</span> <span class="kw1">statistics</span> <span class="kw1">time</span> <span class="kw1">off</span>
go</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">set statistics time on
go
select COUNT(*) -- 105456
from TestSmall t1
left join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null

select count(*)  --105456
from TestSmall t1
where not exists (
select 1 from  TestLarge t2 where t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue)

select COUNT(*) -- 105456
from TestSmall t1
left outer loop join TestLarge t2 on t1.SomeValue = t2.SomeValue
and t1.SomeDate =t2.SomeDate
and t1.SomeFlag = t2.SomeFlag
and t1.SomeOtherValue = t2.SomeOtherValue
where t2.SomeValue is null


set statistics time off
go</pre></div></div>

<p><strong>Left Join</strong><br />
 SQL Server Execution Times:<br />
   CPU time = 7269 ms,  elapsed time = 7396 ms.</p>
<p><strong>Not Exist</strong><br />
 SQL Server Execution Times:<br />
   CPU time = 21450 ms,  elapsed time = 21574 ms.</p>
<p><strong>Left Loop Join</strong><br />
 SQL Server Execution Times:<br />
   CPU time = <strong>811 ms</strong>,  elapsed time = <strong>449 ms</strong>.</p>
<p>And voilà, as you can see the <em>left loop join</em> is much faster than either of those two other queries. Just a word of caution, do not go ahead and start changing all of your queries, the optimizer is pretty smart about what to do. But of course even the smartest ones get it wrong sometime and that is when you can use table hints and query hints to get the performance you want</p>
<p>*** <strong>Remember, if you have a SQL related question, try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/sql-advent-2011-day-15/'>SQL Advent 2011 Day 15: Joins</a><p>In my Are you ready for SQL Server 2012 or are you still partying like&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/difference-between-a-cross-join/'>Difference between a cross join and a full outer join</a><p>We are interviewing for some SQL developer positions and it seems that most people that&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2><img class="bioPic" src="http://www.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d.png" alt="User bio image"/>Denis has been working with SQL Server since version 6.5. Although he worked as an ASP/JSP/ColdFusion developer before the dot com bust, he has been working exclusively as a database developer/architect since 2002. In addition to English, Denis is also fluent in Croatian and Dutch, but he can curse in many other languages and dialects (just ask the SQL optimizer) He lives in Princeton, NJ with his wife and three kids.<br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/denisgobo" title="SQLDenis at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.facebook.com/profile.php?id=http://www.facebook.com/denis.gobo" title="SQLDenis at Facebook" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Facebook" /></a><a href="http://www.linkedin.com/in/denisgobo" title="SQLDenis at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="http://denisgobo.blogspot.com/" title="SQLDenis at HomePage" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_homepage.png" alt="HomePage" /></a><a href="http://www.flickr.com/photos/denisgobo//" title="SQLDenis at Flickr" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_flickr.png" alt="Flickr" /></a><a href="/index.php/author/SQLDenis/feed/" title="Blog RSS feed for SQLDenis" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 20,193 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/SQLDenis/">Read More Posts by SQLDenis</a>
						</div>
					</div>
					<div>
						 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&text=RT @LessThanDot Blog - Use an  OUTER LOOP JOIN for faster performance when one of the tables is mu... by @denisgobo" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller&source=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&quote=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/&title=Use an  OUTER LOOP JOIN for faster performance when one of the tables is much smaller" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		13 Comments	</h4>
			<ol class="comments-list">
					<li class="comment byuser comment-author-emtucifor even thread-even depth-1" id="comment-3312">
				<div id="div-comment-3312" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Erik</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3312">
			November 5, 2010 at 9:40 am</a>		</div>

		<p>SELECT COUNT(*)<br />
FROM TestSmall t1<br />
OUTER APPLY (<br />
SELECT 1 Z<br />
FROM TestLarge t2<br />
WHERE<br />
t1.SomeValue = t2.SomeValue<br />
and t1.SomeDate =t2.SomeDate<br />
and t1.SomeFlag = t2.SomeFlag<br />
and t1.SomeOtherValue = t2.SomeOtherValue<br />
) X<br />
WHERE X.Z IS NULL</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3312#respond' onclick='return addComment.moveForm( "div-comment-3312", "3312", "respond", "934" )' aria-label='Reply to Erik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3313">
				<div id="div-comment-3313" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://ozamora.com/' rel='external nofollow' class='url'>Oscar Zamora</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3313">
			November 5, 2010 at 9:43 am</a>		</div>

		<p>I had instances where I needed to force the join operations for very large tables. But isn&#8217;t it better to have up to date statistics rather than forcing a join type within the code?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3313#respond' onclick='return addComment.moveForm( "div-comment-3313", "3313", "respond", "934" )' aria-label='Reply to Oscar Zamora'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3314">
				<div id="div-comment-3314" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27b999fb8e550b60303452fb1ae134ed?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27b999fb8e550b60303452fb1ae134ed?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://twitter.com/jrothmanshore' rel='external nofollow' class='url'>Jeremy Rothman-Shore</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3314">
			November 5, 2010 at 9:47 am</a>		</div>

		<p>Are you dropping clean buffers between these tests?  Your last example is doing significantly more logical reads.  If your data is not actually in RAM, you may find that they performance benefit evaporates.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3314#respond' onclick='return addComment.moveForm( "div-comment-3314", "3314", "respond", "934" )' aria-label='Reply to Jeremy Rothman-Shore'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-3315">
				<div id="div-comment-3315" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3315">
			November 5, 2010 at 9:55 am</a>		</div>

		<p>Oscar, stats are up to date, I actually just manually updated them and no change</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3315#respond' onclick='return addComment.moveForm( "div-comment-3315", "3315", "respond", "934" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor even thread-even depth-1" id="comment-3316">
				<div id="div-comment-3316" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3316">
			November 5, 2010 at 10:00 am</a>		</div>

		<p>Emtucifor, LEFT JOIN and OUTER APPLY generate the same plan</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3316#respond' onclick='return addComment.moveForm( "div-comment-3316", "3316", "respond", "934" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-3317">
				<div id="div-comment-3317" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3317">
			November 5, 2010 at 10:02 am</a>		</div>

		<p>Jeremy, I just ran this</p>
<p>
DBCC DROPCLEANBUFFERS<br />
DBCC FREEPROCCACHE</p>
<p>SET STATISTICS IO ON<br />
go<br />
SELECT COUNT(*) &#8212; 105456<br />
FROM TestSmall t1<br />
LEFT join TestLarge t2 ON t1.SomeValue = t2.SomeValue<br />
and t1.SomeDate =t2.SomeDate<br />
and t1.SomeFlag = t2.SomeFlag<br />
and t1.SomeOtherValue = t2.SomeOtherValue<br />
WHERE t2.SomeValue IS null</p>
<p>SET STATISTICS IO OFF<br />
go</p>
<p>DBCC DROPCLEANBUFFERS<br />
DBCC FREEPROCCACHE</p>
<p>SET STATISTICS IO ON<br />
go<br />
SELECT COUNT(*)  &#8211;105456<br />
FROM TestSmall t1<br />
WHERE not exists (<br />
SELECT 1 FROM  TestLarge t2 WHERE t1.SomeValue = t2.SomeValue<br />
and t1.SomeDate =t2.SomeDate<br />
and t1.SomeFlag = t2.SomeFlag<br />
and t1.SomeOtherValue = t2.SomeOtherValue)</p>
<p>SET STATISTICS IO OFF<br />
go</p>
<p>DBCC DROPCLEANBUFFERS<br />
DBCC FREEPROCCACHE</p>
<p>SET STATISTICS IO ON<br />
go<br />
SELECT COUNT(*) &#8212; 105456<br />
FROM TestSmall t1<br />
LEFT outer loop join TestLarge t2 ON t1.SomeValue = t2.SomeValue<br />
and t1.SomeDate =t2.SomeDate<br />
and t1.SomeFlag = t2.SomeFlag<br />
and t1.SomeOtherValue = t2.SomeOtherValue<br />
WHERE t2.SomeValue IS null</p>
<p>SET STATISTICS IO OFF<br />
go</p>
<p>
Here is the output</p>
<p>
DBCC execution completed. If DBCC printed error messages, contact your system administrator.<br />
DBCC execution completed. If DBCC printed error messages, contact your system administrator.</p>
<p>(1 row(s) affected)<br />
Table &#8216;TestSmall&#8217;. Scan count 9, logical reads 1011, physical reads 24, read-ahead reads 954<br />
Table &#8216;TestLarge&#8217;. Scan count 9, logical reads 160192, physical reads 732, read-ahead reads 159204<br />
Table &#8216;Worktable&#8217;. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0</p>
<p>(1 row(s) affected)<br />
DBCC execution completed. If DBCC printed error messages, contact your system administrator.<br />
DBCC execution completed. If DBCC printed error messages, contact your system administrator.</p>
<p>(1 row(s) affected)<br />
Table &#8216;TestSmall&#8217;. Scan count 1, logical reads 917, physical reads 9, read-ahead reads 954<br />
Table &#8216;TestLarge&#8217;. Scan count 1, logical reads 159184, physical reads 114, read-ahead reads 159209</p>
<p>(1 row(s) affected)<br />
DBCC execution completed. If DBCC printed error messages, contact your system administrator.<br />
DBCC execution completed. If DBCC printed error messages, contact your system administrator.<br />
Warning: The join order has been enforced because a local join hint is used.</p>
<p>(1 row(s) affected)<br />
Table &#8216;TestLarge&#8217;. Scan count 115456, logical reads 1065175, physical reads 27, read-ahead reads 145092<br />
Table &#8216;TestSmall&#8217;. Scan count 9, logical reads 1011, physical reads 17, read-ahead reads 954<br />
Table &#8216;Worktable&#8217;. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0</p>
<p>(1 row(s) affected)</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3317#respond' onclick='return addComment.moveForm( "div-comment-3317", "3317", "respond", "934" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-emtucifor even thread-even depth-1" id="comment-3318">
				<div id="div-comment-3318" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/27d6e9660735af7bad858dbf2f1eecbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Erik</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3318">
			November 5, 2010 at 11:15 am</a>		</div>

		<p>Thanks for checking. It would be cool if you could OUTER LOOP APPLY&#8230;</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3318#respond' onclick='return addComment.moveForm( "div-comment-3318", "3318", "respond", "934" )' aria-label='Reply to Erik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3319">
				<div id="div-comment-3319" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://ozamora.com/' rel='external nofollow' class='url'>Oscar Zamora</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3319">
			November 5, 2010 at 11:49 am</a>		</div>

		<p>SQLDenis, this is a great example. I always pay attention to reads, and this simply blew up the optimizer as it implied that the amount of reads was higher than just performing a MERGE JOIN.</p>
<p>Now, I always thought that there was a reverse correlation between I/O reads and performance. But this sample clearly implies that higher reads does not necessarily mean bad performance.</p>
<p>I need an explanation about that tho&#8230;. Will research</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3319#respond' onclick='return addComment.moveForm( "div-comment-3319", "3319", "respond", "934" )' aria-label='Reply to Oscar Zamora'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3320">
				<div id="div-comment-3320" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/d9ddc1b28c9f2a50fb544fd571a741aa?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://ozamora.com/' rel='external nofollow' class='url'>Oscar Zamora</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3320">
			November 5, 2010 at 12:35 pm</a>		</div>

		<p>This is what I found out. When the cache is empty, it takes 10 seconds on my test system to return the results using a nested loop and 11 seconds using a merge join.</p>
<p>What I can infer from this test is that if the data is in cache, RAM is much faster to scan than disk hence it takes just a few seconds to return using a nested loop.</p>
<p>But because the optimizer does not really know how fast is your disk subsystem or RAM speed, it tries to infer that due to the huge amount of scan counts that the nested loop will generate, it is automatically more expensive than just issuing a merge join.</p>
<p>In any case, this is still a great example that shows that the optimizer is pretty darn good, but not perfect.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3320#respond' onclick='return addComment.moveForm( "div-comment-3320", "3320", "respond", "934" )' aria-label='Reply to Oscar Zamora'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3321">
				<div id="div-comment-3321" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1b219d1b09a1a74a7c089c10c4b20a9c?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1b219d1b09a1a74a7c089c10c4b20a9c?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://sqlblog.com/blogs/paul_white/default.aspx' rel='external nofollow' class='url'>Paul White NZ</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3321">
			November 6, 2010 at 11:14 am</a>		</div>

		<p>Hi Dennis,</p>
<p>Did you record elapsed times for the tests with DBCC DROPCLEANBUFFERS included?</p>
<p>The total physical reads (including read-ahead) look very similar for all the methods.</p>
<p>I enjoyed reading this entry, thank you.</p>
<p>Paul</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3321#respond' onclick='return addComment.moveForm( "div-comment-3321", "3321", "respond", "934" )' aria-label='Reply to Paul White NZ'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-ramireddyindia even thread-even depth-1" id="comment-3322">
				<div id="div-comment-3322" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/a4aee79c2ac4e2871a8e2f41d7d88c8a?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/a4aee79c2ac4e2871a8e2f41d7d88c8a?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ramireddy</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3322">
			November 7, 2010 at 8:10 pm</a>		</div>

		<p>Hi dennis,</p>
<p>      Nice Article.</p>
<p>       I removed the final 3 join conditions and kept only one condition &#8220;t1.somevalue = t2.somevalue&#8221; and run the 3 queries again. It Give the CPU times as &#8220;28766ms&#8221;, &#8220;953ms&#8221;  ,&#8221;30359&#8243;  for the query 1,2,3 respectively. It seems to be some other factors like no of join conditions also effecting the CPU time. One wild assumption is If the join involves 2 or more conditions, &#8220;Merge&#8221; join will evaluate all comparision operations all at a time, where as Nested loops will do it one by one?????</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3322#respond' onclick='return addComment.moveForm( "div-comment-3322", "3322", "respond", "934" )' aria-label='Reply to Ramireddy'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-3324">
				<div id="div-comment-3324" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/8bb9306c20064ce9446a69ca09f460fd?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/8bb9306c20064ce9446a69ca09f460fd?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.google.com/profiles/guercheLE' rel='external nofollow' class='url'>Luciano Evaristo Guerche (Gor</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3324">
			November 8, 2010 at 9:03 am</a>		</div>

		<p>Dennis,</p>
<p>I am quite sure what is changing the join type is not the &#8220;left&#8221; nor the &#8220;outer&#8221;, but the &#8220;loop&#8221; join hint.</p>
<p>&#8220;loop&#8221;, &#8220;merge&#8221; and &#8220;hash&#8221; can also be used with inner and right joins. I don&#8217;t like giving hints because sql server is supposed to select better execution plan (but sometimes it does not, unfortunately), so that&#8217;s why the hints were advised for.</p>
<p>Cheers.</p>
<p>&#8212;<br />
P.S.: I just gave the following T-SQL statement a hint so that the NOT EXISTS clause also uses a nested/loop join. Take a look and let me know what do you think about.</p>
<p>SELECT COUNT(*)  &#8211;105456<br />
FROM TestSmall t1<br />
WHERE not exists (<br />
SELECT 1 FROM  TestLarge t2 WHERE t1.SomeValue = t2.SomeValue<br />
and t1.SomeDate =t2.SomeDate<br />
and t1.SomeFlag = t2.SomeFlag<br />
and t1.SomeOtherValue = t2.SomeOtherValue)<br />
OPTION (LOOP JOIN)</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3324#respond' onclick='return addComment.moveForm( "div-comment-3324", "3324", "respond", "934" )' aria-label='Reply to Luciano Evaristo Guerche (Gor'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-3323">
				<div id="div-comment-3323" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5a29aa9f0d9ac24c19c6167612e079d5?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5a29aa9f0d9ac24c19c6167612e079d5?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://gertjans.home.xs4all.nl/sql/' rel='external nofollow' class='url'>Gert-Jan Strik</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#comment-3323">
			January 18, 2012 at 2:38 pm</a>		</div>

		<p>I ran your example.</p>
<p>The query plan I got for the first query was slightly different (executed on SQL Server 2008, 10.0.5500.0). There is an extra BitMap operator in the query plan, although I don&#8217;t see it every time. See below.</p>
<p>|&#8211;Compute Scalar(DEFINE:(Expr1006=CONVERT_IMPLICIT(int,Expr1010,0)))<br />
   |&#8211;Stream Aggregate(DEFINE:(Expr1010=Count(*)))<br />
      |&#8211;Parallelism(Gather Streams)<br />
         |&#8211;Filter(WHERE:(TestLarge.SomeValue as t2.SomeValue IS NULL))<br />
            |&#8211;Hash Match(Left Outer Join, HASH:(t1.SomeValue, t1.SomeDate, t1.SomeFlag, t1.SomeOtherValue)=(t2.SomeValue, t2.SomeDate, t2.SomeFlag, t2.SomeOtherValue), RESIDUAL:(TestSmall.SomeValue as t1.SomeValue=TestLarge.SomeValue as t2.SomeValue AND TestSmall.SomeDate as t1.SomeDate=TestLarge.SomeDate as t2.SomeDate AND TestSmall.SomeFlag as t1.SomeFlag=TestLarge.SomeFlag as t2.SomeFlag AND TestSmall.SomeOtherValue as t1.SomeOtherValue=TestLarge.SomeOtherValue as t2.SomeOtherValue))<br />
                 |&#8211;Bitmap(HASH:(t1.SomeValue, t1.SomeDate, t1.SomeFlag, t1.SomeOtherValue), DEFINE:(Bitmap1009))<br />
                 |  |&#8211;Parallelism(Repartition Streams, Hash Partitioning, PARTITION COLUMNS:(t1.SomeValue, t1.SomeDate, t1.SomeFlag, t1.SomeOtherValue))<br />
                 |     |&#8211;Clustered Index Scan(OBJECT:(TestSmall.ix_TestSmall AS t1))<br />
                 |&#8211;Parallelism(Repartition Streams, Hash Partitioning, PARTITION COLUMNS:(t2.SomeValue, t2.SomeDate, t2.SomeFlag, t2.SomeOtherValue))<br />
                    |&#8211;Clustered Index Scan(OBJECT:(TestLarge.ix_TestLarge AS t2), WHERE:(PROBE(Bitmap1009,TestLarge.SomeValue as t2.SomeValue,TestLarge.SomeDate as t2.SomeDate,TestLarge.SomeFlag as t2.SomeFlag,TestLarge.SomeOtherValue as t2.SomeOtherValue)))</p>
<p>
When I ran the queries with a hot cache, the Loop Join version blew the other out of the water.</p>
<p>However, with a cold cache, on my system, the Loop Join version performs slightly worse than the Hash Match version, approximately 12%.</p>
<p>The Outer Apply version that poster Erik suggested performs about the same as the default query plan, both with a hot and cold cache.</p>
<p>I have to say, that you have chosen a very specific setup. You have declared both tables without any Unique index / constraint. Even the clustered index is not unique (in both tables), even though both tables only have unique data for the clustered index keys. I don&#8217;t think that that is a very common scenario&#8230;</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/?replytocom=3323#respond' onclick='return addComment.moveForm( "div-comment-3323", "3323", "respond", "934" )' aria-label='Reply to Gert-Jan Strik'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/datamgmt/dbprogramming/use-a-outer-loop-join-for-faster-perform/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='934' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="0a09c8844ba8f0936c20bd791130d6b6"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765618"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
