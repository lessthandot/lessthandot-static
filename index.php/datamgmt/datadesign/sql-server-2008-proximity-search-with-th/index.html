<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   SQL Server 2008 Proximity Search With The Geography Data Type</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   SQL Server 2008 Proximity Search With The Geography Data Type" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="George and I decided to show you how you can do simple radius searches based on Zip Codes, he did the SQL 2005 and before version here:   SQL Server Zipcode Latitude/Longitude proximity distance search and I will do the SQL Server 2008 version.The f&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; SQL Server 2008 Proximity Search With The Geography Data Type Comments Feed" href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='SQL Server Zipcode Latitude/Longitude proximity distance search' href='/index.php/datamgmt/datadesign/sql-server-zipcode-latitude-longitude-pr/' />
<link rel='next' title='SQL Friday, The Best SQL Server Links Of The Past Week Episode 11' href='/index.php/datamgmt/datadesign/sql-friday-the-best-sql-server-links-of-11/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/" />
<link rel='shortlink' href='/?p=324' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdatadesign%2Fsql-server-2008-proximity-search-with-th%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdatadesign%2Fsql-server-2008-proximity-search-with-th%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/datamgmt/datadesign/sql-friday-the-best-sql-server-links-of-11/" rel="next">SQL Friday, The Best SQL Server Links Of The Past Week Episode 11</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/datamgmt/datadesign/sql-server-zipcode-latitude-longitude-pr/" rel="prev">SQL Server Zipcode Latitude/Longitude proximity distance search</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/" class="post-title">SQL Server 2008 Proximity Search With The Geography Data Type</a></h1>
					<div class="post-byline">by <a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis" rel="author">SQLDenis</a> on February 11, 2009 in category <a href="/index.php/category/datamgmt/datadesign/" rel="category tag">Data Modelling and Design</a> <a href="/index.php/category/datamgmt/dbprogramming/mssqlserver/" rel="category tag">Microsoft SQL Server</a>. Article views: 89,677 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&text=RT @LessThanDot Blog - SQL Server 2008 Proximity Search With The Geography Data Type by @denisgobo" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type&source=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&quote=SQL Server 2008 Proximity Search With The Geography Data Type" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>George and I decided to show you how you can do simple radius searches based on Zip Codes, he did the SQL 2005 and before version here:   <a href="/index.php/DataMgmt/DataDesign/sql-server-zipcode-latitude-longitude-pr">SQL Server Zipcode Latitude/Longitude proximity distance search</a> and I will do the SQL Server 2008 version.</p>
<p>The first thing we need to do is load our data. There are various sources for this data, ranging from free to expensive monthly subscriptions. One source of free data is: http://download.geonames.org/export/zip/ make sure to grab the US.ZIP file for this demo. Unrar/Unzip the file and you will have a US.txt file.</p>
<p>Once you have downloaded your data, the next step is to import it in to your database. You can use the following script to do it.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> ZipCodesTemp<span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>Country<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>ZipCode<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>City<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">200</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span><span class="kw1">STATE</span><span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>StateAbbreviation<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>County<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Unused1<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Unused2<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Latitude<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">DECIMAL</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">8</span>,<span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Longitude<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">DECIMAL</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">8</span>,<span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Unused3<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>
&nbsp; &nbsp; <span class="br0">&#41;</span>
&nbsp;
&nbsp;
<span class="kw1">DECLARE</span> @bulk_cmd <span class="kw1">VARCHAR</span><span class="br0">&#40;</span><span class="nu0">1000</span><span class="br0">&#41;</span>
<span class="kw1">SET</span> @bulk_cmd <span class="sy0">=</span> <span class="st0">'BULK INSERT ZipCodesTemp</span>
<span class="st0"> &nbsp; FROM '</span><span class="st0">'C:YourFolderUS.txt'</span><span class="st0">'</span>
<span class="st0"> &nbsp; WITH (FIELDTERMINATOR='</span><span class="st0">'t'</span><span class="st0">', ROWTERMINATOR = '</span><span class="st0">''</span><span class="sy0">+</span><span class="kw1">CHAR</span><span class="br0">&#40;</span><span class="nu0">10</span><span class="br0">&#41;</span><span class="sy0">+</span><span class="st0">''</span><span class="st0">')'</span>
&nbsp;
<span class="kw1">EXEC</span><span class="br0">&#40;</span>@bulk_cmd<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE ZipCodesTemp(
    [Country] [VARCHAR](2) NULL,
    [ZipCode] [VARCHAR](5) NULL,
    [City] [VARCHAR](200) NULL,
    [STATE] [VARCHAR](50) NULL,
    [StateAbbreviation] [VARCHAR](2) NULL,
    [County] [VARCHAR](50) NULL,
    [Unused1] [VARCHAR](5) NULL,
    [Unused2] [VARCHAR](1) NULL,
    [Latitude] [DECIMAL](8,5) NULL,
    [Longitude] [DECIMAL](8,5) NULL,
    [Unused3] [VARCHAR](1) NULL
    )


DECLARE @bulk_cmd VARCHAR(1000)
SET @bulk_cmd = 'BULK INSERT ZipCodesTemp
   FROM ''C:YourFolderUS.txt''
   WITH (FIELDTERMINATOR=''t'', ROWTERMINATOR = '''+CHAR(10)+''')'
 
EXEC(@bulk_cmd)</pre></div></div>

<p>Now you will create this table</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> ZipCodes<span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>Country<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span> &nbsp;<span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>ZipCode<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>City<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">200</span><span class="br0">&#41;</span> &nbsp;<span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span><span class="kw1">STATE</span><span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> &nbsp;<span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>StateAbbreviation<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">2</span><span class="br0">&#41;</span> &nbsp;<span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>County<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">VARCHAR</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">50</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Latitude<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">DECIMAL</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">8</span>,<span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>Longitude<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">DECIMAL</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">8</span>,<span class="nu0">5</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>GeogCol1<span class="br0">&#93;</span> <span class="br0">&#91;</span>GEOGRAPHY<span class="br0">&#93;</span> &nbsp;<span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>GeogColTemp<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>
&nbsp; &nbsp; <span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE ZipCodes(
    [Country] [VARCHAR](2)  NULL,
    [ZipCode] [VARCHAR](5) NOT NULL,
    [City] [VARCHAR](200)  NULL,
    [STATE] [VARCHAR](50)  NULL,
    [StateAbbreviation] [VARCHAR](2)  NULL,
    [County] [VARCHAR](50) NULL,
    [Latitude] [DECIMAL](8,5) NOT NULL,
    [Longitude] [DECIMAL](8,5) NOT NULL,
    [GeogCol1] [GEOGRAPHY]  NULL,
    [GeogColTemp] [varchar](100) NULL
    )</pre></div></div>

<p>There is at least one duplicate row in this file so we will import only uniques</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">INSERT</span> &nbsp;ZipCodes <span class="br0">&#40;</span>Country,ZipCode,City,<span class="kw1">STATE</span>,StateAbbreviation,County,Latitude,Longitude<span class="br0">&#41;</span>
<span class="kw1">SELECT</span> <span class="kw1">DISTINCT</span> Country,ZipCode,City,<span class="kw1">STATE</span>,StateAbbreviation,County,Latitude,Longitude
<span class="kw1">FROM</span> &nbsp;ZipCodesTemp</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">INSERT  ZipCodes (Country,ZipCode,City,STATE,StateAbbreviation,County,Latitude,Longitude)
SELECT DISTINCT Country,ZipCode,City,STATE,StateAbbreviation,County,Latitude,Longitude
FROM  ZipCodesTemp</pre></div></div>

<p>Our next step will be to update the GeogCol1 table with something that SQL server can understand.<br />
Here is some sample code that displays the format of this datatype</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @h geography;
<span class="kw1">SET</span> @h <span class="sy0">=</span> geography::STGeomFromText<span class="br0">&#40;</span><span class="st0">'POINT(-77.36750 38.98390)'</span>, <span class="nu0">4326</span><span class="br0">&#41;</span>;
<span class="kw1">SELECT</span> @h</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @h geography;
SET @h = geography::STGeomFromText('POINT(-77.36750 38.98390)', 4326);
SELECT @h</pre></div></div>

<p>output<br />
&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-<br />
0xE6100000010C6744696FF07D4340EC51B81E855753C0</p>
<p>As you can see it is some binary data. This data is using the World Geodetic System 1984 (WGS 84)</p>
<p>To see if this is supported in your database you can run this query</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> sys.<span class="me1">spatial_reference_systems</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT * FROM sys.spatial_reference_systems</pre></div></div>

<p>And yes in my database it has a spatial_reference_id of 4326</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> <span class="sy0">*</span> <span class="kw1">FROM</span> sys.<span class="me1">spatial_reference_systems</span>
<span class="kw1">WHERE</span> spatial_reference_id <span class="sy0">=</span> <span class="nu0">4326</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT * FROM sys.spatial_reference_systems
WHERE spatial_reference_id = 4326</pre></div></div>

<p>Here is the meta data</p>
<p>GEOGCS[&#8220;WGS 84&#8221;, DATUM[&#8220;World Geodetic System 1984&#8221;,<br />
ELLIPSOID[&#8220;WGS 84&#8221;, 6378137, 298.257223563]], PRIMEM[&#8220;Greenwich&#8221;, 0],<br />
UNIT[&#8220;Degree&#8221;, 0.0174532925199433]]</p>
<p>Back to our code, in order to have this data in our table</p>
<p>SET @h = geography::STGeomFromText(&#8216;POINT(-77.36750 38.98390)&#8217;, 4326);</p>
<p>We need to do some things, first we update our temp column</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">UPDATE</span> zipcodes 
<span class="kw1">SET</span> GeogColTemp<span class="sy0">=</span> <span class="st0">'POINT('</span> <span class="sy0">+</span> <span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>,longitude<span class="br0">&#41;</span> 
<span class="sy0">+</span><span class="st0">' '</span> <span class="sy0">+</span> &nbsp;<span class="kw1">convert</span><span class="br0">&#40;</span><span class="kw1">varchar</span><span class="br0">&#40;</span><span class="nu0">100</span><span class="br0">&#41;</span>,latitude<span class="br0">&#41;</span> <span class="sy0">+</span><span class="st0">')'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">UPDATE zipcodes 
SET GeogColTemp= 'POINT(' + convert(varchar(100),longitude) 
+' ' +  convert(varchar(100),latitude) +')'</pre></div></div>

<p>Now we can update out geography column</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">UPDATE</span> zipcodes 
<span class="kw1">SET</span> GeogCol1 <span class="sy0">=</span> &nbsp;geography::STGeomFromText<span class="br0">&#40;</span>GeogColTemp,<span class="nu0">4326</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">UPDATE zipcodes 
SET GeogCol1 =  geography::STGeomFromText(GeogColTemp,4326)</pre></div></div>

<p>We can drop the temp column now</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TABLE</span> zipcodes <span class="kw1">DROP</span> <span class="kw1">COLUMN</span> GeogColTemp</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TABLE zipcodes DROP COLUMN GeogColTemp</pre></div></div>

<p>Now we have to add a primary key, this is needed because otherwise we won&#8217;t be able to create our spatial index and the following message would be displayed</p>
<p>Server: Msg 12008, Level 16, State 1, Line 1<br />
Table &#8216;zipcodes&#8217; does not have a clustered primary key as required by the spatial index. Make sure that the primary key column exists on the table before creating a spatial index.</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">ALTER</span> <span class="kw1">TABLE</span> zipcodes <span class="kw1">ADD</span> 
&nbsp; &nbsp; <span class="kw1">CONSTRAINT</span> <span class="br0">&#91;</span>PK_ZipCode<span class="br0">&#93;</span> <span class="kw1">PRIMARY</span> <span class="kw1">KEY</span> &nbsp;<span class="kw1">CLUSTERED</span> 
&nbsp; &nbsp; <span class="br0">&#40;</span>
&nbsp; &nbsp; &nbsp; &nbsp; Zipcode,
&nbsp; &nbsp; &nbsp; &nbsp; Longitude
&nbsp; &nbsp; <span class="br0">&#41;</span> <span class="kw1">WITH</span> &nbsp;<span class="kw1">FILLFACTOR</span> <span class="sy0">=</span> <span class="nu0">100</span> </pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">ALTER TABLE zipcodes ADD 
	CONSTRAINT [PK_ZipCode] PRIMARY KEY  CLUSTERED 
	(
		Zipcode,
		Longitude
	) WITH  FILLFACTOR = 100 </pre></div></div>

<p>Create the spatial index</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> SPATIAL <span class="kw1">INDEX</span> SIndx_SpatialTable_geography_col1 
&nbsp; &nbsp;<span class="kw1">ON</span> zipcodes<span class="br0">&#40;</span>GeogCol1<span class="br0">&#41;</span>;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE SPATIAL INDEX SIndx_SpatialTable_geography_col1 
   ON zipcodes(GeogCol1);</pre></div></div>

<p>first I will show you an example to calculate the distance that you can execute</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
</pre></td><td class="de1"><pre class="de1"><span class="kw1">DECLARE</span> @g geography;
<span class="kw1">DECLARE</span> @h geography;
<span class="kw1">SET</span> @h <span class="sy0">=</span> geography::STGeomFromText<span class="br0">&#40;</span><span class="st0">'POINT(-77.36750 38.98390)'</span>, <span class="nu0">4326</span><span class="br0">&#41;</span>;
<span class="kw1">SET</span> @g <span class="sy0">=</span> geography::STGeomFromText<span class="br0">&#40;</span><span class="st0">'POINT(-77.36160 38.85570)'</span>, <span class="nu0">4326</span><span class="br0">&#41;</span>;
<span class="kw1">SELECT</span> @g.<span class="me1">STDistance</span><span class="br0">&#40;</span>@h<span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">1609.344</span>;</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">DECLARE @g geography;
DECLARE @h geography;
SET @h = geography::STGeomFromText('POINT(-77.36750 38.98390)', 4326);
SET @g = geography::STGeomFromText('POINT(-77.36160 38.85570)', 4326);
SELECT @g.STDistance(@h)/1609.344;</pre></div></div>

<p>as you can see the distance is 8.8490611480890067</p>
<p>Now I want to see all the zipcode which are within 20 miles of zipcode 10028 (yes I used to live there)</p>
<p>Here is a way that will take a long time since it is not sargable, this will take about 2 seconds</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> h.<span class="sy0">*</span> 
<span class="kw1">FROM</span> zipcodes g 
<span class="sy0">JOIN</span> zipcodes h <span class="kw1">on</span> g.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> h.<span class="me1">zipcode</span>
<span class="sy0">AND</span> g.<span class="me1">zipcode</span> <span class="sy0">=</span> <span class="st0">'10028'</span>
<span class="sy0">AND</span> h.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> <span class="st0">'10028'</span>
<span class="kw1">WHERE</span> g.<span class="me1">GeogCol1</span>.<span class="me1">STDistance</span><span class="br0">&#40;</span>h.<span class="me1">GeogCol1</span><span class="br0">&#41;</span><span class="sy0">/</span><span class="nu0">1609.344</span> <span class="sy0">&lt;=</span> <span class="nu0">20</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT h.* 
FROM zipcodes g 
JOIN zipcodes h on g.zipcode &lt;&gt; h.zipcode
AND g.zipcode = '10028'
AND h.zipcode &lt;&gt; '10028'
WHERE g.GeogCol1.STDistance(h.GeogCol1)/1609.344 &lt;= 20</pre></div></div>

<p>Now we all know functions on the left side of the operator are bad, here is how this is optimized, we switch the calculation to the right side of the = sign</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> h.<span class="sy0">*</span> 
<span class="kw1">FROM</span> zipcodes g 
<span class="sy0">JOIN</span> zipcodes h <span class="kw1">on</span> g.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> h.<span class="me1">zipcode</span>
<span class="sy0">AND</span> g.<span class="me1">zipcode</span> <span class="sy0">=</span> <span class="st0">'10028'</span>
<span class="sy0">AND</span> h.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> <span class="st0">'10028'</span>
<span class="kw1">WHERE</span> g.<span class="me1">GeogCol1</span>.<span class="me1">STDistance</span><span class="br0">&#40;</span>h.<span class="me1">GeogCol1</span><span class="br0">&#41;</span><span class="sy0">&lt;=</span><span class="br0">&#40;</span><span class="nu0">20</span> <span class="sy0">*</span> <span class="nu0">1609.344</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT h.* 
FROM zipcodes g 
JOIN zipcodes h on g.zipcode &lt;&gt; h.zipcode
AND g.zipcode = '10028'
AND h.zipcode &lt;&gt; '10028'
WHERE g.GeogCol1.STDistance(h.GeogCol1)&lt;=(20 * 1609.344)</pre></div></div>

<p>that ran in between 15 and 60 milliseconds</p>
<p>To find everything between 10 and 20 miles you can use this</p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> h.<span class="sy0">*</span> 
<span class="kw1">FROM</span> zipcodes g 
<span class="sy0">JOIN</span> zipcodes h <span class="kw1">on</span> g.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> h.<span class="me1">zipcode</span>
<span class="sy0">AND</span> g.<span class="me1">zipcode</span> <span class="sy0">=</span> <span class="st0">'10028'</span>
<span class="sy0">AND</span> h.<span class="me1">zipcode</span> <span class="sy0">&lt;&gt;</span> <span class="st0">'10028'</span>
<span class="kw1">WHERE</span> g.<span class="me1">GeogCol1</span>.<span class="me1">STDistance</span><span class="br0">&#40;</span>h.<span class="me1">GeogCol1</span><span class="br0">&#41;</span><span class="sy0">&lt;=</span><span class="br0">&#40;</span><span class="nu0">20</span> <span class="sy0">*</span> <span class="nu0">1609.344</span><span class="br0">&#41;</span>
<span class="sy0">AND</span> g.<span class="me1">GeogCol1</span>.<span class="me1">STDistance</span><span class="br0">&#40;</span>h.<span class="me1">GeogCol1</span><span class="br0">&#41;</span><span class="sy0">&gt;=</span> <span class="br0">&#40;</span><span class="nu0">10</span> <span class="sy0">*</span> <span class="nu0">1609.344</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT h.* 
FROM zipcodes g 
JOIN zipcodes h on g.zipcode &lt;&gt; h.zipcode
AND g.zipcode = '10028'
AND h.zipcode &lt;&gt; '10028'
WHERE g.GeogCol1.STDistance(h.GeogCol1)&lt;=(20 * 1609.344)
AND g.GeogCol1.STDistance(h.GeogCol1)&gt;= (10 * 1609.344)</pre></div></div>

<p>As you can see doing stuff like this on SQL Server 2008 is fairly easy because of the geograpy data type</p>
<p>*** <strong>If you have a SQL related question try our <a href="http://forum.lessthandot.com/viewforum.php?f=17">Microsoft SQL Server Programming</a> forum or our <a href="http://forum.lessthandot.com/viewforum.php?f=22">Microsoft SQL Server Admin</a> forum</strong><ins></ins></p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/sql-server-zipcode-latitude-longitude-pr/'>SQL Server Zipcode Latitude/Longitude proximity distance search</a><p>Have you ever wanted to add functionality that allows you to perform simple radius searches&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/datadesign/review-of-beginning-spatial-with-sql-ser-2008/'>Review Of Beginning Spatial With SQL Server 2008</a><p>I will just start of by saying that Beginning Spatial With SQL Server 2008 written&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2><img class="bioPic" src="http://www.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d.png" alt="User bio image"/>Denis has been working with SQL Server since version 6.5. Although he worked as an ASP/JSP/ColdFusion developer before the dot com bust, he has been working exclusively as a database developer/architect since 2002. In addition to English, Denis is also fluent in Croatian and Dutch, but he can curse in many other languages and dialects (just ask the SQL optimizer) He lives in Princeton, NJ with his wife and three kids.<br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/denisgobo" title="SQLDenis at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.facebook.com/profile.php?id=http://www.facebook.com/denis.gobo" title="SQLDenis at Facebook" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Facebook" /></a><a href="http://www.linkedin.com/in/denisgobo" title="SQLDenis at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="http://denisgobo.blogspot.com/" title="SQLDenis at HomePage" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_homepage.png" alt="HomePage" /></a><a href="http://www.flickr.com/photos/denisgobo//" title="SQLDenis at Flickr" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_flickr.png" alt="Flickr" /></a><a href="/index.php/author/SQLDenis/feed/" title="Blog RSS feed for SQLDenis" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 89,677 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/SQLDenis/">Read More Posts by SQLDenis</a>
						</div>
					</div>
					<div>
						<label>Tags:</label> <a href="/index.php/tag/geography/" rel="tag">geography</a>, <a href="/index.php/tag/geomapping/" rel="tag">geomapping</a>, <a href="/index.php/tag/spatial-data/" rel="tag">spatial data</a>, <a href="/index.php/tag/sql-server-2008/" rel="tag">sql server 2008</a> 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&text=RT @LessThanDot Blog - SQL Server 2008 Proximity Search With The Geography Data Type by @denisgobo" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type&source=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&quote=SQL Server 2008 Proximity Search With The Geography Data Type" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/&title=SQL Server 2008 Proximity Search With The Geography Data Type" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		50 Comments	</h4>
			<ol class="comments-list">
					<li class="comment even thread-even depth-1" id="comment-932">
				<div id="div-comment-932" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/94dbf897e10c9ec09bcdcabba6a80fbf?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/94dbf897e10c9ec09bcdcabba6a80fbf?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://sqlfool.com/' rel='external nofollow' class='url'>Michelle Ufford</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-932">
			February 11, 2009 at 2:46 pm</a>		</div>

		<p>I have absolutely no use for this, but this is a really cool new feature and a really great post.  Thanks, Denis!  🙂</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=932#respond' onclick='return addComment.moveForm( "div-comment-932", "932", "respond", "324" )' aria-label='Reply to Michelle Ufford'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-934">
				<div id="div-comment-934" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-934">
			February 11, 2009 at 2:48 pm</a>		</div>

		<p>You are welcome. </p>
<p>Credits go to George since he came up with the idea of the blogpost I just happened to do the 2008 version</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=934#respond' onclick='return addComment.moveForm( "div-comment-934", "934", "respond", "324" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse even thread-even depth-1" id="comment-935">
				<div id="div-comment-935" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-935">
			February 11, 2009 at 9:12 pm</a>		</div>

		<p>Thanks for doing this you guys, I&#8217;d really been wanting to see a good tutorial to get me up to speed on this.  I&#8217;m about to move crummy web page to a SQL 2008 host, I&#8217;m really hoping I&#8217;ll be able to use this feature for a new and improved version of the location thing I&#8217;m working on.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=935#respond' onclick='return addComment.moveForm( "div-comment-935", "935", "respond", "324" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alexcuse odd alt thread-odd thread-alt depth-1" id="comment-937">
				<div id="div-comment-937" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5e8bfdc77e52098a1ab2ddd1cd2a176f?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Alex Ullrich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-937">
			February 12, 2009 at 11:10 pm</a>		</div>

		<p>I had a little beef with their data for one zip code.  This is more like it</p>
<p>update ZipCodes <br />
set GeogCol1 = geography::STGeomFromText(&#8216;POINT(40.02963540591171 -75.56317090988159)&#8217;, 4326) <br />
where ZipCode = 19345</p>
<p>These spatial indexes are pretty impressive!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=937#respond' onclick='return addComment.moveForm( "div-comment-937", "937", "respond", "324" )' aria-label='Reply to Alex Ullrich'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-920">
				<div id="div-comment-920" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/a3c1ebd2e3497fe62303608b65d670a7?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/a3c1ebd2e3497fe62303608b65d670a7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://cconway.com/' rel='external nofollow' class='url'>Chuck Conway</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-920">
			May 14, 2009 at 4:52 pm</a>		</div>

		<p>My apologies if I missed it, but in some of your procedures you use &#8216;1609.344&#8217; in some of the calculations.</p>
<p>What is &#8216;1609.344&#8217; ?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=920#respond' onclick='return addComment.moveForm( "div-comment-920", "920", "respond", "324" )' aria-label='Reply to Chuck Conway'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-921">
				<div id="div-comment-921" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-921">
			May 14, 2009 at 5:20 pm</a>		</div>

		<p>Chuck, it is done to convert to miles, the metric system is used in geospatial calculations</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=921#respond' onclick='return addComment.moveForm( "div-comment-921", "921", "respond", "324" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-923">
				<div id="div-comment-923" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/a3c1ebd2e3497fe62303608b65d670a7?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/a3c1ebd2e3497fe62303608b65d670a7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.cconway.com/' rel='external nofollow' class='url'>Chuck Conway</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-923">
			May 14, 2009 at 9:51 pm</a>		</div>

		<p>Thanks!</p>
<p>I see it now. I didn&#8217;t think about the conversion.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=923#respond' onclick='return addComment.moveForm( "div-comment-923", "923", "respond", "324" )' aria-label='Reply to Chuck Conway'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-925">
				<div id="div-comment-925" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/f0981b9e05cb8c36b4e984384a9c9a16?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/f0981b9e05cb8c36b4e984384a9c9a16?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.lekevin.com/' rel='external nofollow' class='url'>Tien</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-925">
			July 14, 2009 at 4:34 pm</a>		</div>

		<p>Thank you so much for a great tutorial about geograpy data type.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=925#respond' onclick='return addComment.moveForm( "div-comment-925", "925", "respond", "324" )' aria-label='Reply to Tien'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-903">
				<div id="div-comment-903" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/79782354dee6dbec51ca40f5c4dbccbc?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/79782354dee6dbec51ca40f5c4dbccbc?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.kidseatcheaptonight.com/' rel='external nofollow' class='url'>Jeremy Kane</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-903">
			August 11, 2009 at 12:13 am</a>		</div>

		<p>I was very glad to find this article!  I have a site I&#8217;m working on, and by using the techniques described in this blog, I was able to make my proximity searching MUCH faster.</p>
<p>I wrote a blog entry (<a href="http://www.kidseatcheaptonight.com/blog/2009/08/site-updated-speed-increase.aspx" rel="nofollow">http://www.kidseatcheaptonight.com/blog/2009/08/site-updated-speed-increase.aspx</a>) pointing some people to this blog, if any tech geeks happen to come across my site, hopefully they will pay your blog a visit too.</p>
<p>Thanks!<br />
Jeremy</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=903#respond' onclick='return addComment.moveForm( "div-comment-903", "903", "respond", "324" )' aria-label='Reply to Jeremy Kane'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-933">
				<div id="div-comment-933" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/a6dcef9b01c0d14c89d619a1a380e9fd?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/a6dcef9b01c0d14c89d619a1a380e9fd?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">JoeSF</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-933">
			September 8, 2009 at 10:52 am</a>		</div>

		<p>I would highly recommend doing the geography right from the original numeric rather than converting to text:</p>
<p>geography::Point(latitude, longitude, 4326);</p>
<p>As in:</p>
<p>DECLARE @h geography;<br />
SET @h = geography::Point(-77.36750, 38.98390, 4326);<br />
SELECT @h</p>
<p>Then there is no interim conversion and problems are resolved before the statement is run.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=933#respond' onclick='return addComment.moveForm( "div-comment-933", "933", "respond", "324" )' aria-label='Reply to JoeSF'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938">
				<div id="div-comment-938" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/24be993aea00af87bdbde132a81669dd?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/24be993aea00af87bdbde132a81669dd?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">joe mocerino</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-938">
			September 11, 2009 at 3:10 pm</a>		</div>

		<p>this is great and works well.  one question, how can i sort by distinct (closer to farthest)?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=938#respond' onclick='return addComment.moveForm( "div-comment-938", "938", "respond", "324" )' aria-label='Reply to joe mocerino'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-939">
				<div id="div-comment-939" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-939">
			September 11, 2009 at 5:23 pm</a>		</div>

		<p>Joe,</p>
<p>can you try if</p>
<p>ORDER BY g.GeogCol1.STDistance(h.GeogCol1)</p>
<p>works for you, not near a PC with sql server right now but that should work</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=939#respond' onclick='return addComment.moveForm( "div-comment-939", "939", "respond", "324" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-904">
				<div id="div-comment-904" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/967b2b1acb1e41d583859289a354c947?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/967b2b1acb1e41d583859289a354c947?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Bass</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-904">
			October 30, 2009 at 9:44 am</a>		</div>

		<p>Hi &#8230; Denis &#8230;<br />
to connvert to miles we used this : &#8216;1609.344&#8217;<br />
and what the value if i want to convert to metre</p>
<p>
thanx</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=904#respond' onclick='return addComment.moveForm( "div-comment-904", "904", "respond", "324" )' aria-label='Reply to Bass'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-905">
				<div id="div-comment-905" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-905">
			October 30, 2009 at 10:53 am</a>		</div>

		<p>Bass for meters leave of the division</p>
<p>examples</p>
<p>&#8211;MILES<br />
DECLARE @g geography;<br />
DECLARE @h geography;<br />
SET @h = geography::STGeomFromText(&#8216;POINT(-77.36750 38.98390)&#8217;, 4326);<br />
SET @g = geography::STGeomFromText(&#8216;POINT(-77.36160 38.85570)&#8217;, 4326);<br />
SELECT @g.STDistance(@h)/1609.344; &#8211;miles  8.84906114808901<br />
GO</p>
<p>&#8211;METERS<br />
DECLARE @g geography;<br />
DECLARE @h geography;<br />
SET @h = geography::STGeomFromText(&#8216;POINT(-77.36750 38.98390)&#8217;, 4326);<br />
SET @g = geography::STGeomFromText(&#8216;POINT(-77.36160 38.85570)&#8217;, 4326);<br />
SELECT @g.STDistance(@h); &#8211;meters&#8230;14241.1834643102<br />
Go</p>
<p>&#8211;KILOMETERS<br />
DECLARE @g geography;<br />
DECLARE @h geography;<br />
SET @h = geography::STGeomFromText(&#8216;POINT(-77.36750 38.98390)&#8217;, 4326);<br />
SET @g = geography::STGeomFromText(&#8216;POINT(-77.36160 38.85570)&#8217;, 4326);<br />
SELECT @g.STDistance(@h)/1000;  &#8211;kilometers  14.2411834643102<br />
GO</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=905#respond' onclick='return addComment.moveForm( "div-comment-905", "905", "respond", "324" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-906">
				<div id="div-comment-906" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/967b2b1acb1e41d583859289a354c947?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/967b2b1acb1e41d583859289a354c947?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Bass</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-906">
			October 31, 2009 at 12:36 am</a>		</div>

		<p>Thanx a large ,,, Denis</p>
<p>Actually  i v been create simple GIS applcations <br />
using sql server 2008 for database and<br />
visual studio 2008 to build the appliaction &#8230;</p>
<p>but i dont know how to preview spatial data on visual studio 2008 as shown on sql server 2008 &#8230;</p>
<p>if you have reference or tutorial for me&#8230;<br />
i am very appreciated &#8230;.</p>
<p>i hope you not borring for my question</p>
<p>thanx before<br />
and sory i am not good enough in english &#8230;</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=906#respond' onclick='return addComment.moveForm( "div-comment-906", "906", "respond", "324" )' aria-label='Reply to Bass'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-929">
				<div id="div-comment-929" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/83bb7e1a599db67bbca07e49a2b47ed7?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/83bb7e1a599db67bbca07e49a2b47ed7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Eve</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-929">
			December 11, 2009 at 11:51 pm</a>		</div>

		<p>I am taking a T-SQL class and need some help.  I have to writw UDF that takes as input the latitude and lingitutde of each of two points on the earth&#8217;s surface, and calculates the distance between the ow points.  The @distance formula was given and need the accuracy of one tenth of a mile.</p>
<p>Hope some can help!<br />
Eve</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=929#respond' onclick='return addComment.moveForm( "div-comment-929", "929", "respond", "324" )' aria-label='Reply to Eve'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-chrissie1 even thread-even depth-1" id="comment-930">
				<div id="div-comment-930" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/70e155e88e0ead5e2bdcb3e1c57506b4?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/70e155e88e0ead5e2bdcb3e1c57506b4?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Christiaan Baes (chrissie1)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-930">
			December 12, 2009 at 2:09 am</a>		</div>

		<p>Questions like these are better posted in the forum.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=930#respond' onclick='return addComment.moveForm( "div-comment-930", "930", "respond", "324" )' aria-label='Reply to Christiaan Baes (chrissie1)'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-900">
				<div id="div-comment-900" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/511ca0e74d1eb43b8e5aeea1f1a9b778?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/511ca0e74d1eb43b8e5aeea1f1a9b778?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ash</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-900">
			January 29, 2010 at 7:19 am</a>		</div>

		<p>This stuff is amazing.  I&#8217;ve just started rewriting a proximity search piece of one of our websites and happened upon this little gem.  Thanks Denis and George!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=900#respond' onclick='return addComment.moveForm( "div-comment-900", "900", "respond", "324" )' aria-label='Reply to Ash'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-911">
				<div id="div-comment-911" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/69434c939404dbb509ce4aba92112bd7?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/69434c939404dbb509ce4aba92112bd7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.scratty.com/' rel='external nofollow' class='url'>Matt</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-911">
			February 8, 2010 at 7:24 pm</a>		</div>

		<p>This is GREAT!!  Wow, been working with Zip Code radius searches and this makes it so much easier.   Thanks!!!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=911#respond' onclick='return addComment.moveForm( "div-comment-911", "911", "respond", "324" )' aria-label='Reply to Matt'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-912">
				<div id="div-comment-912" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/69434c939404dbb509ce4aba92112bd7?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/69434c939404dbb509ce4aba92112bd7?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Matt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-912">
			February 8, 2010 at 7:53 pm</a>		</div>

		<p>One question, why doesn&#8217;t the query return the zip code that was searched in the results?   The distance would be 0 but is still less than the search radius.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=912#respond' onclick='return addComment.moveForm( "div-comment-912", "912", "respond", "324" )' aria-label='Reply to Matt'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-944">
				<div id="div-comment-944" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/264237a87d9751b61b6ad78672eb1de8?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/264237a87d9751b61b6ad78672eb1de8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ashar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-944">
			May 7, 2010 at 11:09 am</a>		</div>

		<p>Excellent Post. Thank you very much!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=944#respond' onclick='return addComment.moveForm( "div-comment-944", "944", "respond", "324" )' aria-label='Reply to Ashar'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-910">
				<div id="div-comment-910" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/476c693aa3e4f3dd27cb58b1ab026f2b?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/476c693aa3e4f3dd27cb58b1ab026f2b?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Tony</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-910">
			June 27, 2010 at 1:23 am</a>		</div>

		<p>Excellent Post, but I have the same question as Matt.  The query that you had provided doesn&#8217;t return the zipcode that is being searched around.  Anyone have a solution to that?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=910#respond' onclick='return addComment.moveForm( "div-comment-910", "910", "respond", "324" )' aria-label='Reply to Tony'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-914">
				<div id="div-comment-914" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5cc28e554ffd4b52de18997952c8dba2?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5cc28e554ffd4b52de18997952c8dba2?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ashey</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-914">
			July 27, 2010 at 12:59 pm</a>		</div>

		<p>We threw this together to do radius searches based on city rather than a starting zip code.  All based on Denis&#8217; article.</p>
<p>CREATE FUNCTION [dbo].[GetProximityZipCodesByCityStateCountry] <br />
(<br />
	@Country varchar(2), <br />
	@City varchar(200),<br />
	@State varchar(2),<br />
	@MinRadius int,<br />
	@MaxRadius int,<br />
	@Units char(1)<br />
)<br />
RETURNS <br />
@Zips TABLE <br />
(<br />
	ZipCode varchar(5)<br />
)<br />
AS<br />
BEGIN<br />
	DECLARE @Min int, @Max int, @center Geography</p>
<p>	IF(@Units = &#8216;k&#8217;) &#8211;Kilometers<br />
		SELECT @Min = (@MinRadius * 1000), @Max = (@MaxRadius * 1000)<br />
	ELSE &#8212; Miles<br />
		SELECT @Min = (@MinRadius * 1609.344), @Max = (@MaxRadius * 1609.344)</p>
<p>	SET @center = (SELECT geography::STGeomFromText(&#8216;POINT(&#8216; + CONVERT(VARCHAR(100),AVG(Longitude)) +&#8217; &#8216; +  CONVERT(VARCHAR(100),AVG(Latitude)) +&#8217;)&#8217;,4326) <br />
				   FROM ZipCodes g <br />
				   WHERE Country = @Country AND City = @City and StateAbbreviation = @State)</p>
<p>	INSERT INTO @Zips<br />
	SELECT ZipCode<br />
	FROM zipcodes<br />
	WHERE GeogCol1.STDistance(@center) BETWEEN @Min AND @Max</p>
<p>	RETURN <br />
END<br />
GO</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=914#respond' onclick='return addComment.moveForm( "div-comment-914", "914", "respond", "324" )' aria-label='Reply to Ashey'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-SQLDenis bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-916">
				<div id="div-comment-916" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/7a49149d4d4b9242348b95a2c561c20d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">SQLDenis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-916">
			July 27, 2010 at 1:04 pm</a>		</div>

		<p>Ashey, looks cool, thanks for the code</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=916#respond' onclick='return addComment.moveForm( "div-comment-916", "916", "respond", "324" )' aria-label='Reply to SQLDenis'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-941">
				<div id="div-comment-941" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/b9cffa5cf81394e973bb139779d333ec?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/b9cffa5cf81394e973bb139779d333ec?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">jack</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-941">
			November 25, 2010 at 2:22 am</a>		</div>

		<p>I have not been able to load the provided us.text data set without errors. Feel stupid sense there is no other posts on it. I get errors saying the unused 3 column is too short. So i make it bigger varchar(100) and the data goes in but now there is longitude info in the unused 3. I have tried to use excel to format the set to go in correctly with no luck.. and this is another dumb queston but what is the point of the 3 empty columns in the data set anyways???</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=941#respond' onclick='return addComment.moveForm( "div-comment-941", "941", "respond", "324" )' aria-label='Reply to jack'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-915">
				<div id="div-comment-915" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Elizabeth</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-915">
			May 3, 2011 at 3:14 pm</a>		</div>

		<p>I&#8217;m having the same problem as Jack, any suggestions? Jack &#8211; did you get it to work?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=915#respond' onclick='return addComment.moveForm( "div-comment-915", "915", "respond", "324" )' aria-label='Reply to Elizabeth'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-917">
				<div id="div-comment-917" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.ryanhelms.com/' rel='external nofollow' class='url'>Ryan</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-917">
			May 7, 2011 at 10:06 pm</a>		</div>

		<p>Guys, I had the same problem. The fix was to add a column after unused2. I added unused3 and changed the current unused3 to unused 4. Then they will both be populated.</p>
<p>Hope this help,<br />
Ryan<br />
ryan(@)ryanhelms.com</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=917#respond' onclick='return addComment.moveForm( "div-comment-917", "917", "respond", "324" )' aria-label='Reply to Ryan'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-918">
				<div id="div-comment-918" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.ryanhelms.com/' rel='external nofollow' class='url'>Ryan Helms</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-918">
			May 8, 2011 at 5:53 pm</a>		</div>

		<p>First, thanks for the great head start with working on the proximity search portion of my application. This has all been a great help. I knew the geography data type would come in handy at some point!</p>
<p>I only have one question. This is obviously disregarding any input on services to get driving time, rather than point to point calculations? This is great for part of my solution, but driving time would complete it. </p>
<p>Any ideas would be greatly appreciated.</p>
<p>Thanks<br />
Ryan</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=918#respond' onclick='return addComment.moveForm( "div-comment-918", "918", "respond", "324" )' aria-label='Reply to Ryan Helms'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-919">
				<div id="div-comment-919" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/93e7f58298fb56f5bed74b7565b5568d?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.ryanhelms.com/' rel='external nofollow' class='url'>Ryan Helms</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-919">
			May 8, 2011 at 6:05 pm</a>		</div>

		<p>* I meant driving mileage / time, not just time.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=919#respond' onclick='return addComment.moveForm( "div-comment-919", "919", "respond", "324" )' aria-label='Reply to Ryan Helms'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-922">
				<div id="div-comment-922" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Elizabeth</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-922">
			May 10, 2011 at 6:43 am</a>		</div>

		<p>I got the data loaded now, but I also have the question about how to include the zip code that is being searched from, we&#8217;d want to include that in any results.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=922#respond' onclick='return addComment.moveForm( "div-comment-922", "922", "respond", "324" )' aria-label='Reply to Elizabeth'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-931">
				<div id="div-comment-931" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/1c841cef99697f3d6efcd2b10edd05e8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Elizabeth</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-931">
			May 20, 2011 at 7:45 am</a>		</div>

		<p>Ashey &#8211; </p>
<p>I am looking to use this for finding all records in our database that are, for example, within 5 miles of Los Angeles. It looks like this returns the zip codes that are within 5 miles of a central point, but for a place like Los Angeles, that doesn&#8217;t even return all the zip codes that are in Los Angeles, let alone ones that are 5 miles outside LA. </p>
<p>Do you have any suggestions for how I could accomplish this? Thanks.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=931#respond' onclick='return addComment.moveForm( "div-comment-931", "931", "respond", "324" )' aria-label='Reply to Elizabeth'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-926">
				<div id="div-comment-926" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/a198f62810dfe4359d92c1e4072593f1?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/a198f62810dfe4359d92c1e4072593f1?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.michaelwells.com/' rel='external nofollow' class='url'>Michael</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-926">
			July 12, 2011 at 1:43 am</a>		</div>

		<p>Elizabeth-</p>
<p>If you define Los Angeles as just a collection of Zip codes, than you can expand that to &#8220;Los Angeles + 5 miles out&#8221; by applying Denis&#8217; search process to every Zip in the Los Angeles data set, and removing duplicates.</p>
<p>e.g. in the version of the data set I currently have, there are 104 zip codes identified where stateabbreviation = &#8216;CA&#8217; and city = &#8216;Los Angeles&#8217;.  Select all zips within 5 miles of any of those Zips, and you should get pretty much what you&#8217;re looking for&#8230; all zips within Los Angeles + 5 mi</p>
<p>Remember you&#8217;re searching from the centroid of each zip, so there&#8217;s some distance between there and the boundary of the &#8220;Zip area&#8221; (which is a very vague concept; Zip codes are not polygons).  Depending on how accurate you&#8217;re trying to be you might add a bit to your 5 mile radius to compensate for that. </p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=926#respond' onclick='return addComment.moveForm( "div-comment-926", "926", "respond", "324" )' aria-label='Reply to Michael'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-943">
				<div id="div-comment-943" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/ed763474cef5e56d8351b40b8781ebb9?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/ed763474cef5e56d8351b40b8781ebb9?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Peter</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-943">
			July 25, 2011 at 4:02 pm</a>		</div>

		<p>I&#8217;m not sure if I&#8217;m doing something wrong or if the script is out of date with the file but I&#8217;m getting errors. Thanks for writing the article though.</p>
<p>My errors are below:</p>
<p>
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 1, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 2, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 3, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 4, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 5, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 6, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 7, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 8, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 9, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 10, column 11 (Unused3).<br />
Msg 4863, Level 16, State 1, Line 1<br />
Bulk load data conversion error (truncation) for row 11, column 11 (Unused3).<br />
Msg 4865, Level 16, State 1, Line 1<br />
Cannot bulk load because the maximum number of errors (10) was exceeded.<br />
Msg 7399, Level 16, State 1, Line 1<br />
The OLE DB provider &#8220;BULK&#8221; for linked server &#8220;(null)&#8221; reported an error. The provider did not give any information about the error.<br />
Msg 7330, Level 16, State 2, Line 1<br />
Cannot fetch a row from OLE DB provider &#8220;BULK&#8221; for linked server &#8220;(null)&#8221;.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=943#respond' onclick='return addComment.moveForm( "div-comment-943", "943", "respond", "324" )' aria-label='Reply to Peter'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-908">
				<div id="div-comment-908" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/55d40e976586a7f3f5039b21ee48d128?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/55d40e976586a7f3f5039b21ee48d128?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Kunwal</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-908">
			August 10, 2011 at 7:18 am</a>		</div>

		<p>I have applied this procedure posted above in my application this procedure is good to get geolocation of Person using ZipCode.<br />
I have used google api to get latitude and longitude from zip code but sometimes it will give me lat. and log. or sometimes it will not return.<br />
I am having this kind of problem.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=908#respond' onclick='return addComment.moveForm( "div-comment-908", "908", "respond", "324" )' aria-label='Reply to Kunwal'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-940">
				<div id="div-comment-940" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/b599b264e0bc6d49cd52b7d7dc57ac1e?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/b599b264e0bc6d49cd52b7d7dc57ac1e?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Mani</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-940">
			September 13, 2011 at 9:11 am</a>		</div>

		<p>I also got the same Bulk data error, just change the Unused3 datatype to varchar(30), just that latitude values get imported to longitude field and longitude values get imported to unused3 field with a return carriage (char(10)) added to second row onwards in the unused3 field, so you need to replace this character or you would find the cannot convert varchar to numeric errors.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=940#respond' onclick='return addComment.moveForm( "div-comment-940", "940", "respond", "324" )' aria-label='Reply to Mani'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-945">
				<div id="div-comment-945" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/0ef458193d3157de855587814e436bc8?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/0ef458193d3157de855587814e436bc8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Stitch</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-945">
			September 19, 2011 at 5:42 pm</a>		</div>

		<p>I got the bulk data errors too. Instead of creating the ZipCodesTemp table I let the data import wizard create the table for me. First I renamed the text file &#8220;US.txt&#8221; to &#8220;ZipCodesTemp.txt&#8221;. Next, I let the data import wizard data-type the columns as it saw fit (varchar(50)). As you continue, you see the wizard wants to import this data into the &#8220;ZipCodesTemp&#8221; table that does not yet exist. The wizard will automatically create the table and import all of the records. This resulted in zero errors with over 43,000+ records imported.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=945#respond' onclick='return addComment.moveForm( "div-comment-945", "945", "respond", "324" )' aria-label='Reply to Stitch'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-2" id="comment-5257618">
				<div id="div-comment-5257618" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/df29760418f1c18fac8237b2867bf469?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/df29760418f1c18fac8237b2867bf469?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-5257618">
			September 19, 2016 at 4:07 pm</a>		</div>

		<p>Renaming US.txt to ZipCodesTemp.txt and using the data import wizard fixed myriad problems with bulk insert &#8230;thanks!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=5257618#respond' onclick='return addComment.moveForm( "div-comment-5257618", "5257618", "respond", "324" )' aria-label='Reply to Brian'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-946">
				<div id="div-comment-946" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/0ef458193d3157de855587814e436bc8?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/0ef458193d3157de855587814e436bc8?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Stitch</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-946">
			September 19, 2011 at 6:06 pm</a>		</div>

		<p>P.S. This was an incredibly useful article with easy to follow instructions and awesome examples. Thank you for taking the time to demonstrate how this new functionality works. </p>
<p>Michelle Ufford, the very first poster (02/11/09 @ 14:46 ), said, &#8220;I have absolutely no use for this, but this is a really cool new feature and a really great post.&#8221;</p>
<p>For anyone else who might be wondering, &#8220;What would I ever use this for?&#8221; Well, as a web application developer, I have a customer who wants to be able to offer a list of available jobs in and around the area the web visitor is surfing from before the visitor enters any data.</p>
<p>One FREE source that will tell you the location of the visitor&#8217;s ISP (the company that issued the external IP Address of the device they used on the Internet): <a href="http://www.geoplugin.net/json.gp?jsoncallback=" rel="nofollow">http://www.geoplugin.net/json.gp?jsoncallback=</a>?</p>
<p>Give it a try. Paste the above URL in your browser and you will see a JSON result with a lot of useful info including latitude and longitude.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=946#respond' onclick='return addComment.moveForm( "div-comment-946", "946", "respond", "324" )' aria-label='Reply to Stitch'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-913">
				<div id="div-comment-913" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/20ddd054b6246dc5794c2b0bc514224a?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/20ddd054b6246dc5794c2b0bc514224a?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Jason</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-913">
			October 6, 2011 at 4:02 pm</a>		</div>

		<p>Wow, thanks! So awesome! Using this tutorial, I got this up and running so easily. </p>
<p>Does all geographic data need to be in one table with one spacial index? Or, do the performance benefits remain if you join two tables with their own spacial indexes and use the geographic methods on them (e.g. .STDistance)?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=913#respond' onclick='return addComment.moveForm( "div-comment-913", "913", "respond", "324" )' aria-label='Reply to Jason'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-936">
				<div id="div-comment-936" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/bb726fe8586712cf079c8fcece6b3cf6?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/bb726fe8586712cf079c8fcece6b3cf6?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Bryon Pierce</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-936">
			October 26, 2011 at 3:25 pm</a>		</div>

		<p>Thank you this is exactly what I needed, I was looking forward to having chance of using and understanding Geography Data types.</p>
<p>With so many Smart Phone applications using Lat and long along with mapping, having Geo data by zip when detailed Lat long are not available this is a great way to move forward.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=936#respond' onclick='return addComment.moveForm( "div-comment-936", "936", "respond", "324" )' aria-label='Reply to Bryon Pierce'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-907">
				<div id="div-comment-907" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/13ecbac753887edd913e01864b9d6819?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/13ecbac753887edd913e01864b9d6819?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Ken Mazur</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-907">
			December 1, 2011 at 8:38 am</a>		</div>

		<p>Any chance you&#8217;ve come up with a way to get the zip code for a particular lat/long?  If so, can you share it with me.<br />
Thanks<br />
Ken</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=907#respond' onclick='return addComment.moveForm( "div-comment-907", "907", "respond", "324" )' aria-label='Reply to Ken Mazur'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-901">
				<div id="div-comment-901" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/9eab1eea6bb8fa69bbd6fd679e951930?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/9eab1eea6bb8fa69bbd6fd679e951930?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">sadia</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-901">
			January 2, 2012 at 9:54 am</a>		</div>

		<p>Great post 🙂</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=901#respond' onclick='return addComment.moveForm( "div-comment-901", "901", "respond", "324" )' aria-label='Reply to sadia'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-927">
				<div id="div-comment-927" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/2a33710fad74bda1c88b8f87104ec056?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/2a33710fad74bda1c88b8f87104ec056?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Stanton</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-927">
			January 30, 2012 at 9:05 am</a>		</div>

		<p>Just wanted to say thanks for posting this, been looking for a way to calculate distances using tables and not variables and you were the first one to help me!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=927#respond' onclick='return addComment.moveForm( "div-comment-927", "927", "respond", "324" )' aria-label='Reply to Stanton'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-924">
				<div id="div-comment-924" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/f497fcfe3d387b5fc70922d92643e76a?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/f497fcfe3d387b5fc70922d92643e76a?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Tiger</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-924">
			August 12, 2012 at 5:41 am</a>		</div>

		<p>Fantastic Article &#8211; Just started using the new geography type and this helped big time</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=924#respond' onclick='return addComment.moveForm( "div-comment-924", "924", "respond", "324" )' aria-label='Reply to Tiger'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-928">
				<div id="div-comment-928" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/b8d8f8129a1234cb2d8ccfd098e2476c?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/b8d8f8129a1234cb2d8ccfd098e2476c?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Marco</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-928">
			June 17, 2013 at 5:28 pm</a>		</div>

		<p>This worked for the US values but I tried to apply the same logic and scripts to create a proximity lookup for Canada (I used the CA.txt file) and I got an error stating that latitude had to be in the range -90 to 90.  This affects about 30% of the addresses in Canada.<br />
How is this possible when the ranges are supposed to be -180 to 180?  If anyone knows why I am getting this error, please let me know.  Thank you.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=928#respond' onclick='return addComment.moveForm( "div-comment-928", "928", "respond", "324" )' aria-label='Reply to Marco'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-902">
				<div id="div-comment-902" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/2857fac513e86383670f2494d960af09?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/2857fac513e86383670f2494d960af09?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Lillen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-902">
			August 7, 2013 at 11:55 am</a>		</div>

		<p>Greetings,</p>
<p>When I run this part.<br />
ALTER TABLE zipcodes ADD </p>
<p>    CONSTRAINT [PK_ZipCode] PRIMARY KEY  CLUSTERED </p>
<p>    (</p>
<p>        Zipcode,</p>
<p>        Longitude</p>
<p>    ) WITH  FILLFACTOR = 100</p>
<p>
I get this error message&#8230;  Any ideas why there is a duplicate key?</p>
<p>Msg 1505, Level 16, State 1, Line 2<br />
The CREATE UNIQUE INDEX statement terminated because a duplicate key was found for the object name &#8216;dbo.ZipCodes&#8217; and the index name &#8216;PK_ZipCode&#8217;. The duplicate key value is (10804, -73.78630).<br />
Msg 1750, Level 16, State 0, Line 2<br />
Could not create constraint. See previous errors.<br />
The statement has been terminated.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=902#respond' onclick='return addComment.moveForm( "div-comment-902", "902", "respond", "324" )' aria-label='Reply to Lillen'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-909">
				<div id="div-comment-909" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/b6e31e4d30466a6e672256196cfeca8b?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/b6e31e4d30466a6e672256196cfeca8b?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Oseroke</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-909">
			August 22, 2013 at 6:22 am</a>		</div>

		<p>Hello All,<br />
Brilliant and well-explained article. Thank you very much.</p>
<p>Is there any particular reason why you used World Geodetic System 1984? I played around with other spatial_reference_ids and I noticed the value was different.</p>
<p>Regards.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=909#respond' onclick='return addComment.moveForm( "div-comment-909", "909", "respond", "324" )' aria-label='Reply to Oseroke'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-942">
				<div id="div-comment-942" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/10af40f16ee590caf661c01b2b7aa963?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/10af40f16ee590caf661c01b2b7aa963?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Shannon Dunn</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-942">
			November 14, 2013 at 7:29 pm</a>		</div>

		<p>I have used this code and it works great, BUT it does not include the actual zip code that I am entering. All the ones around it BUT the zip code itself. How can I make sure this is included in the results?. </p>
<p>Also is it required to declare h and g as geography objects? I am not a big SQL guy. 🙂</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=942#respond' onclick='return addComment.moveForm( "div-comment-942", "942", "respond", "324" )' aria-label='Reply to Shannon Dunn'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-1604966">
				<div id="div-comment-1604966" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://1.gravatar.com/avatar/aca04a7e8fb04268cca178e2668b9ba2?s=64&#038;d=mm&#038;r=g' srcset='http://1.gravatar.com/avatar/aca04a7e8fb04268cca178e2668b9ba2?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Samuel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-1604966">
			August 16, 2014 at 11:58 pm</a>		</div>

		<p>Thanks for the awesome article but I fail to understand the signifiance of the spatial id in the beginning of the article.  Any help is appreciated, thanks!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=1604966#respond' onclick='return addComment.moveForm( "div-comment-1604966", "1604966", "respond", "324" )' aria-label='Reply to Samuel'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-5176737">
				<div id="div-comment-5176737" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/5bc17c22751c84047994df1eafe292ee?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/5bc17c22751c84047994df1eafe292ee?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">WickedW</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#comment-5176737">
			August 6, 2016 at 12:31 pm</a>		</div>

		<p>Simply just to say THANK YOU 🙂<br />
Works like lightening.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/?replytocom=5176737#respond' onclick='return addComment.moveForm( "div-comment-5176737", "5176737", "respond", "324" )' aria-label='Reply to WickedW'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/datamgmt/datadesign/sql-server-2008-proximity-search-with-th/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='324' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="0537fb40a68c18da59a35c2bfe1ca554"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765671"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
