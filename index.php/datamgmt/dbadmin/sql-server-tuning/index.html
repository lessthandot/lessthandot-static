<!DOCTYPE html>
<html lang="en-US">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
		<link rel="shortcut icon" href="http://lessthandot.com/favicon.ico" type="image/vnd.microsoft.icon" />
	<title>Less Than Dot - Blog -   SQL Server Query Tuning – Back to Basics</title>
	<meta prefix="og: http://ogp.me/ns#" property="og:title" content="Less Than Dot - Blog -   SQL Server Query Tuning – Back to Basics" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:url" content="/index.php/datamgmt/dbadmin/sql-server-tuning/" />
		<meta prefix="og: http://ogp.me/ns#" property="og:image" content="http://lessthandot.com/images/logo_prod.png" />
	<meta prefix="og: http://ogp.me/ns#" property="og:type" content="article" />
	<meta prefix="og: http://ogp.me/ns#" property="og:site_name" content="LessThanDot" />
	<meta prefix="og: http://ogp.me/ns#" property="og:description" content="The first stage to tuning a query is the coding.  Take a look at the query in listing 1SELECTSUM(OrderQty) AS TotalQuantity,salesman.LastName,salesman.FirstName,hdr.ShipDateFROM[Sales].[SalesOrderHeader] hdrJOIN [Sales].[SalesOrderDetail&hellip;" />
	<link rel="alternate" type="application/rss+xml" title="RSS 2.0" href="/index.php/feed/" />
	<link rel="alternate" type="application/atom+xml" title="Atom" href="/index.php/feed/atom/" />

	<!-- this page is the canonical URL -->	
	<link rel="stylesheet" href="/wp-content/themes/lessthandot2009/style.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsite.css" type="text/css" />
	<link rel="stylesheet" href="http://lessthandot.com/includes/allsiteprint.css" media="print" type="text/css" />

	<link rel='dns-prefetch' href='//ajax.googleapis.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="LessthanDot &raquo; SQL Server Query Tuning – Back to Basics Comments Feed" href="/index.php/datamgmt/dbadmin/sql-server-tuning/feed/" />
		<script type="text/javascript">
			window._wpemojiSettings = {"baseUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/72x72\/","ext":".png","svgUrl":"https:\/\/s.w.org\/images\/core\/emoji\/2\/svg\/","svgExt":".svg","source":{"concatemoji":"\/wp-includes\/js\/wp-emoji-release.min.js?ver=4.6.1"}};
			!function(a,b,c){function d(a){var c,d,e,f,g,h=b.createElement("canvas"),i=h.getContext&&h.getContext("2d"),j=String.fromCharCode;if(!i||!i.fillText)return!1;switch(i.textBaseline="top",i.font="600 32px Arial",a){case"flag":return i.fillText(j(55356,56806,55356,56826),0,0),!(h.toDataURL().length<3e3)&&(i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,65039,8205,55356,57096),0,0),c=h.toDataURL(),i.clearRect(0,0,h.width,h.height),i.fillText(j(55356,57331,55356,57096),0,0),d=h.toDataURL(),c!==d);case"diversity":return i.fillText(j(55356,57221),0,0),e=i.getImageData(16,16,1,1).data,f=e[0]+","+e[1]+","+e[2]+","+e[3],i.fillText(j(55356,57221,55356,57343),0,0),e=i.getImageData(16,16,1,1).data,g=e[0]+","+e[1]+","+e[2]+","+e[3],f!==g;case"simple":return i.fillText(j(55357,56835),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode8":return i.fillText(j(55356,57135),0,0),0!==i.getImageData(16,16,1,1).data[0];case"unicode9":return i.fillText(j(55358,56631),0,0),0!==i.getImageData(16,16,1,1).data[0]}return!1}function e(a){var c=b.createElement("script");c.src=a,c.type="text/javascript",b.getElementsByTagName("head")[0].appendChild(c)}var f,g,h,i;for(i=Array("simple","flag","unicode8","diversity","unicode9"),c.supports={everything:!0,everythingExceptFlag:!0},h=0;h<i.length;h++)c.supports[i[h]]=d(i[h]),c.supports.everything=c.supports.everything&&c.supports[i[h]],"flag"!==i[h]&&(c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&c.supports[i[h]]);c.supports.everythingExceptFlag=c.supports.everythingExceptFlag&&!c.supports.flag,c.DOMReady=!1,c.readyCallback=function(){c.DOMReady=!0},c.supports.everything||(g=function(){c.readyCallback()},b.addEventListener?(b.addEventListener("DOMContentLoaded",g,!1),a.addEventListener("load",g,!1)):(a.attachEvent("onload",g),b.attachEvent("onreadystatechange",function(){"complete"===b.readyState&&c.readyCallback()})),f=c.source||{},f.concatemoji?e(f.concatemoji):f.wpemoji&&f.twemoji&&(e(f.twemoji),e(f.wpemoji)))}(window,document,window._wpemojiSettings);
		</script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
<link rel='stylesheet' id='bwp-syntax-css'  href='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/css/bwp-syntax-global.css?ver=4.6.1' type='text/css' media='all' />
<script type='text/javascript' src='http://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4'></script>
<script type='text/javascript' src='/wp-content/plugins/better-wordpress-syntax-based-on-geshi/js/bwp-syntax.js?ver=4.6.1'></script>
<link rel='https://api.w.org/' href='/wp-json/' />
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='SQL Advent 2012 Day 9: Reinventing the wheel' href='/index.php/datamgmt/dbprogramming/sql-advent-2012-day-10/' />
<link rel='next' title='SQL Advent 2012 Day 10: SQL Server Maintenance' href='/index.php/webdev/business-intelligence/sql-server-maintenance/' />
<meta name="generator" content="WordPress 4.6.1" />
<link rel="canonical" href="/index.php/datamgmt/dbadmin/sql-server-tuning/" />
<link rel='shortlink' href='/?p=1838' />
<link rel="alternate" type="application/json+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbadmin%2Fsql-server-tuning%2F" />
<link rel="alternate" type="text/xml+oembed" href="/wp-json/oembed/1.0/embed?url=http%3A%2F%2F%2Findex.php%2Fdatamgmt%2Fdbadmin%2Fsql-server-tuning%2F&#038;format=xml" />
<style type='text/css'>.rp4wp-related-posts ul{width:100%;padding:0;margin:0;float:left;}
.rp4wp-related-posts ul>li{list-style:none;padding:0;margin:0;padding-bottom:20px;clear:both;}
.rp4wp-related-posts ul>li>p{margin:0;padding:0;}
.rp4wp-related-post-image{width:35%;padding-right:25px;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box;float:left;}</style>
	<script src="http://lessthandot.com/includes/allsite.js" type="text/javascript" ></script>
</head>
<body>
<div id="contain"><div id="subcontain"><div id="ttl"><div id="hdr"><div id="snav"><a href="http://lessthandot.com/login.php?backtrack=/index.php/datamgmt/dbadmin/sql-server-tuning/?">Member Login</a>
</div><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="logoc"><img src="http://lessthandot.com/images/logo_prod.png" alt="LessThanDot Site Logo" border="0" /></a><h1>LessThanDot</h1><div class="pgsttl">A decade of helpful technical content</div></div><div id="nav">
<ul>
<li><a href="http://lessthandot.com/" title="LessThanDot Launchpad" id="h" ><span>Launchpad</span></a></li>
<li class="cur"><a href="/" title="LessThanDot Blogs" id="b" ><span>Blogs</span></a></li>
<li><a href="http://forum.lessthandot.com/" title="LessThanDot Community Forums" id="f" ><span>Forum</span></a></li>
<li><a href="http://wiki.lessthandot.com/" title="LessThanDot Wiki Articles" id="w" ><span>Wiki</span></a></li>
<li><a href="http://sqlcop.lessthandot.com/" title="LessThanDot SQLCop" id="a" ><span>SQLCop</span></a></li>
<li><a href="http://lessthandot.com/account.php" title="Your Account Settings" id="r"  class="l_ie"><span>My Account</span></a></li></ul></div>
</div><div id="content">
<div id="fac"><div id="fa">
		<p>Less Than Dot is a community of passionate IT professionals and enthusiasts dedicated to sharing technical knowledge, experience, and assistance. Inside you will find reference materials, interesting technical discussions, and expert tips and commentary.</p></div></div><div class="content-sidebar">
	<div id="social" class="sdsec">
		<h2>LTD Social Sitings</h2>
		<div>
		<a id="social_twitter" href="http://twitter.com/LessThanDot/" title="Follow us on Twitter" ><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Lessthandot twitter"/></a> 
		<a href="http://www.linkedin.com/groups?home=&amp;gid=113440" title="Join us on LinkedIn" ><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="Lessthandot Linkedin" /></a> 
		<a href="http://www.facebook.com/group.php?gid=19330511063" title="Join us on Facebook" ><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Lessthandot facebook"/></a> 
		<a href="http://lessthandot.com/rss.php" title="LessThanDot News Feed" ><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="Lessthandot rss"/></a> 
		</div>
		<p><em>Note: Watch for social icons on posts by your favorite authors to follow their postings on these and other social sites.</em></p>
	</div><div class="content-sidebar-section">
<h2>Tag cloud</h2>
	<p class="tag-cloud">
		<a href='/index.php/tag/net/' class='tag-link-245 tag-link-position-1' title='21 topics' style='font-size: 8.9565217391304pt;'>.net</a> <a href='/index.php/tag/asp-net/' class='tag-link-168 tag-link-position-2' title='21 topics' style='font-size: 8.9565217391304pt;'>asp.net</a> <a href='/index.php/tag/azure-2/' class='tag-link-321 tag-link-position-3' title='29 topics' style='font-size: 10.173913043478pt;'>azure</a> <a href='/index.php/tag/book/' class='tag-link-130 tag-link-position-4' title='26 topics' style='font-size: 9.7391304347826pt;'>book</a> <a href='/index.php/tag/business-intelligence-2/' class='tag-link-256 tag-link-position-5' title='30 topics' style='font-size: 10.260869565217pt;'>business intelligence</a> <a href='/index.php/tag/c/' class='tag-link-138 tag-link-position-6' title='40 topics' style='font-size: 11.304347826087pt;'>c#</a> <a href='/index.php/tag/database/' class='tag-link-134 tag-link-position-7' title='31 topics' style='font-size: 10.434782608696pt;'>database</a> <a href='/index.php/tag/excel/' class='tag-link-155 tag-link-position-8' title='16 topics' style='font-size: 8pt;'>excel</a> <a href='/index.php/tag/gotcha/' class='tag-link-240 tag-link-position-9' title='19 topics' style='font-size: 8.6086956521739pt;'>gotcha</a> <a href='/index.php/tag/how-to/' class='tag-link-272 tag-link-position-10' title='44 topics' style='font-size: 11.652173913043pt;'>how to</a> <a href='/index.php/tag/mongodb/' class='tag-link-765 tag-link-position-11' title='17 topics' style='font-size: 8.2608695652174pt;'>mongodb</a> <a href='/index.php/tag/nosql/' class='tag-link-775 tag-link-position-12' title='18 topics' style='font-size: 8.4347826086957pt;'>nosql</a> <a href='/index.php/tag/performance/' class='tag-link-179 tag-link-position-13' title='26 topics' style='font-size: 9.7391304347826pt;'>performance</a> <a href='/index.php/tag/security-2/' class='tag-link-398 tag-link-position-14' title='25 topics' style='font-size: 9.5652173913043pt;'>security</a> <a href='/index.php/tag/sql/' class='tag-link-132 tag-link-position-15' title='42 topics' style='font-size: 11.478260869565pt;'>sql</a> <a href='/index.php/tag/sql-advent-2012/' class='tag-link-1416 tag-link-position-16' title='18 topics' style='font-size: 8.4347826086957pt;'>sql advent 2012</a> <a href='/index.php/tag/sql-friday/' class='tag-link-377 tag-link-position-17' title='18 topics' style='font-size: 8.4347826086957pt;'>sql friday</a> <a href='/index.php/tag/sql-server/' class='tag-link-154 tag-link-position-18' title='145 topics' style='font-size: 16.086956521739pt;'>sql server</a> <a href='/index.php/tag/sql-server-2000/' class='tag-link-366 tag-link-position-19' title='45 topics' style='font-size: 11.739130434783pt;'>sql server 2000</a> <a href='/index.php/tag/sql-server-2005/' class='tag-link-327 tag-link-position-20' title='118 topics' style='font-size: 15.391304347826pt;'>sql server 2005</a> <a href='/index.php/tag/sql-server-2008/' class='tag-link-152 tag-link-position-21' title='237 topics' style='font-size: 18pt;'>sql server 2008</a> <a href='/index.php/tag/sql-server-2008-r2/' class='tag-link-548 tag-link-position-22' title='38 topics' style='font-size: 11.130434782609pt;'>sql server 2008 r2</a> <a href='/index.php/tag/sql-server-2012/' class='tag-link-1161 tag-link-position-23' title='76 topics' style='font-size: 13.739130434783pt;'>sql server 2012</a> <a href='/index.php/tag/ssis-2/' class='tag-link-501 tag-link-position-24' title='52 topics' style='font-size: 12.260869565217pt;'>ssis</a> <a href='/index.php/tag/ssms/' class='tag-link-640 tag-link-position-25' title='18 topics' style='font-size: 8.4347826086957pt;'>ssms</a> <a href='/index.php/tag/ssrs-2/' class='tag-link-557 tag-link-position-26' title='27 topics' style='font-size: 9.9130434782609pt;'>ssrs</a> <a href='/index.php/tag/syndicated/' class='tag-link-1407 tag-link-position-27' title='67 topics' style='font-size: 13.217391304348pt;'>syndicated</a> <a href='/index.php/tag/t-sql/' class='tag-link-185 tag-link-position-28' title='26 topics' style='font-size: 9.7391304347826pt;'>t-sql</a> <a href='/index.php/tag/tip/' class='tag-link-194 tag-link-position-29' title='46 topics' style='font-size: 11.826086956522pt;'>tip</a> <a href='/index.php/tag/unit-testing/' class='tag-link-162 tag-link-position-30' title='17 topics' style='font-size: 8.2608695652174pt;'>unit testing</a>	</p>
</div>		<div class="content-sidebar-section">
		<h2>Authors</h2>
			<ul class="author-list dimmed">
				<li><a href="/index.php/author/SQLDenis/" title="Posts by SQLDenis">SQLDenis</a> <a href="/index.php/author/SQLDenis/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (597)</li><li><a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)">Ted Krueger (onpnt)</a> <a href="/index.php/author/onpnt/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (355)</li><li><a href="/index.php/author/grrlgeek/" title="Posts by Jes Borland">Jes Borland</a> <a href="/index.php/author/grrlgeek/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (202)</li><li><a href="/index.php/author/tarwn/" title="Posts by Eli Weinstock-Herman (tarwn)">Eli Weinstock-Herman (tarwn)</a> <a href="/index.php/author/tarwn/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (190)</li><li><a href="/index.php/author/koenverbeeck/" title="Posts by Koen Verbeeck">Koen Verbeeck</a> <a href="/index.php/author/koenverbeeck/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (100)</li><li><a href="/index.php/author/alexcuse/" title="Posts by Alex Ullrich">Alex Ullrich</a> <a href="/index.php/author/alexcuse/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (55)</li><li><a href="/index.php/author/gmmastros/" title="Posts by George Mastros (gmmastros)">George Mastros (gmmastros)</a> <a href="/index.php/author/gmmastros/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (45)</li><li><a href="/index.php/author/axel8s/" title="Posts by Axel Achten (axel8s)">Axel Achten (axel8s)</a> <a href="/index.php/author/axel8s/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (28)</li><li><a href="/index.php/author/naomi/" title="Posts by Naomi Nosonovsky">Naomi Nosonovsky</a> <a href="/index.php/author/naomi/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (27)</li><li><a href="/index.php/author/thirster42/" title="Posts by David Forck (thirster42)">David Forck (thirster42)</a> <a href="/index.php/author/thirster42/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (24)</li><li><a href="/index.php/author/chopstik/" title="Posts by chopstik">chopstik</a> <a href="/index.php/author/chopstik/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (20)</li><li><a href="/index.php/author/kconan/" title="Posts by Kevin Conan">Kevin Conan</a> <a href="/index.php/author/kconan/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (18)</li><li><a href="/index.php/author/robearl/" title="Posts by Rob Earl">Rob Earl</a> <a href="/index.php/author/robearl/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (14)</li><li><a href="/index.php/author/thatrickguy/" title="Posts by ThatRickGuy">ThatRickGuy</a> <a href="/index.php/author/thatrickguy/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (12)</li><li><a href="/index.php/author/sqlarcher/" title="Posts by SQLArcher">SQLArcher</a> <a href="/index.php/author/sqlarcher/feed/"><img src="http://lessthandot.com/images/bdg_rss_icon_sm.png" style="border: none;" /></a> (11)</li>                <li><a href="http://lessthandot.com/Stats/BlogAuthors.php">More...</a></li>
			</ul>
		</div>
				<div class="content-sidebar-section">
		<h2>Categories</h2>
			<ul class="categories-list">
					<li class="cat-item cat-item-10"><a href="/index.php/category/all/" >All Blogs</a>
</li>
	<li class="cat-item cat-item-5"><a href="/index.php/category/architect/" >Architecture, Design and Strategy</a>
</li>
	<li class="cat-item cat-item-1759"><a href="/index.php/category/artificial-intelligence/" >Artificial Intelligence</a>
</li>
	<li class="cat-item cat-item-6"><a href="/index.php/category/datamgmt/" >Data Management</a>
</li>
	<li class="cat-item cat-item-7"><a href="/index.php/category/desktopdev/" >Desktop Developer</a>
</li>
	<li class="cat-item cat-item-8"><a href="/index.php/category/enterprisedev/" >Enterprise Developer</a>
</li>
	<li class="cat-item cat-item-11"><a href="/index.php/category/itprofessionals/" >IT Professionals</a>
</li>
	<li class="cat-item cat-item-12"><a href="/index.php/category/itstudents/" >IT Students and Researchers</a>
</li>
	<li class="cat-item cat-item-1743"><a href="/index.php/category/management/" >Management</a>
</li>
	<li class="cat-item cat-item-9"><a href="/index.php/category/sysadmins/" >System Admins</a>
</li>
	<li class="cat-item cat-item-1"><a href="/index.php/category/uncategorized/" >Uncategorized</a>
</li>
	<li class="cat-item cat-item-4"><a href="/index.php/category/webdev/" >Web Developer</a>
</li>
			</ul>
		</div>
		</div><div class="content-main">
				<div class="post-navigation">
				<div class="post-navigation-forward"><a href="/index.php/webdev/business-intelligence/sql-server-maintenance/" rel="next">SQL Advent 2012 Day 10: SQL Server Maintenance</a> &raquo; </div>
				<div class="post-navigation-back">&laquo; <a href="/index.php/datamgmt/dbprogramming/sql-advent-2012-day-10/" rel="prev">SQL Advent 2012 Day 9: Reinventing the wheel</a></div>
			</div>
			<div class="post-area instapaper_body">
				<div class="post-title-line">
										<h1 class="instapaper_ignore"><a href="/index.php/datamgmt/dbadmin/sql-server-tuning/" class="post-title">SQL Server Query Tuning – Back to Basics</a></h1>
					<div class="post-byline">by <a href="/index.php/author/onpnt/" title="Posts by Ted Krueger (onpnt)" rel="author">Ted Krueger (onpnt)</a> on December 9, 2012 in category <a href="/index.php/category/datamgmt/dbadmin/" rel="category tag">Database Administration</a> <a href="/index.php/category/datamgmt/dbprogramming/mssqlserver/" rel="category tag">Microsoft SQL Server</a> <a href="/index.php/category/datamgmt/dbadmin/mssqlserveradmin/" rel="category tag">Microsoft SQL Server Admin</a>. Article views: 95,013 </div>
				</div>
				<div class="post-tagline"><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&text=RT @LessThanDot Blog - SQL Server Query Tuning &ndash; Back to Basics by @onpnt" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics&source=/index.php/datamgmt/dbadmin/sql-server-tuning/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbadmin/sql-server-tuning/&quote=SQL Server Query Tuning &ndash; Back to Basics" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics" class="instapaper_button">Instapaper</a></div>

				<div class="post-content"><p>The first stage to tuning a query is the coding.  Take a look at the query in listing 1</p>
<p>
<blockquote>Note: The query above is utilizing three tables pulled from the database AdventureWorks2012.  To create these tables, import them without any indexes into another database.  Use a SELECT INTO or <a href="/index.php/DataMgmt/DBAdmin/title-12">any other number of import methods</a> to build the tables. </p></blockquote>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> 
<span class="kw2">SUM</span><span class="br0">&#40;</span>OrderQty<span class="br0">&#41;</span> <span class="kw1">AS</span> TotalQuantity
,salesman.<span class="me1">LastName</span> 
,salesman.<span class="me1">FirstName</span>
,hdr.<span class="me1">ShipDate</span>
<span class="kw1">FROM</span>
<span class="br0">&#91;</span>Sales<span class="br0">&#93;</span>.<span class="br0">&#91;</span>SalesOrderHeader<span class="br0">&#93;</span> hdr 
<span class="sy0">JOIN</span> <span class="br0">&#91;</span>Sales<span class="br0">&#93;</span>.<span class="br0">&#91;</span>SalesOrderDetail<span class="br0">&#93;</span> dtl <span class="kw1">ON</span> hdr.<span class="br0">&#91;</span>SalesOrderID<span class="br0">&#93;</span> <span class="sy0">=</span> dtl.<span class="me1">SalesOrderID</span>
<span class="sy0">JOIN</span> Person.<span class="me1">Person</span> salesman <span class="kw1">ON</span> hdr.<span class="me1">SalesPersonID</span> <span class="sy0">=</span> salesman.<span class="me1">BusinessEntityID</span>
<span class="kw1">WHERE</span> <span class="kw1">Year</span><span class="br0">&#40;</span>hdr.<span class="me1">ShipDate</span><span class="br0">&#41;</span> <span class="sy0">=</span> <span class="nu0">2005</span>
<span class="kw1">GROUP</span> <span class="kw1">BY</span> 
&nbsp;salesman.<span class="me1">LastName</span> 
,salesman.<span class="me1">FirstName</span>
,hdr.<span class="me1">ShipDate</span>
<span class="kw1">HAVING</span> <span class="kw2">SUM</span><span class="br0">&#40;</span>OrderQty<span class="br0">&#41;</span> <span class="sy0">&gt;</span> <span class="nu0">10</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> LastName</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT 
SUM(OrderQty) AS TotalQuantity
,salesman.LastName 
,salesman.FirstName
,hdr.ShipDate
FROM
[Sales].[SalesOrderHeader] hdr 
JOIN [Sales].[SalesOrderDetail] dtl ON hdr.[SalesOrderID] = dtl.SalesOrderID
JOIN Person.Person salesman ON hdr.SalesPersonID = salesman.BusinessEntityID
WHERE Year(hdr.ShipDate) = 2005
GROUP BY 
 salesman.LastName 
,salesman.FirstName
,hdr.ShipDate
HAVING SUM(OrderQty) &gt; 10
ORDER BY LastName</pre></div></div>

</p>
<p>Listing 1</p>
<p>The above code is an extract from a mock monitoring system for an internal dashboard display for an inside sales center.  Each monitor that is distributed through the sales center displays 5 to 6 charts at any given time showing key performance indicators (KPIs) by customer sales.  For the query in listing 1, the KPI that is obtained displays a table and a line chart showing sales per customer, by name, for the current year.  Due to a different report showing critical sales pitfalls of any sale that had a quantity less than 10, which has been deemed by the business as a loss due to cost, the query only returns sales with a quantity greater than 10 units.  </p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/tuning_101_1.gif?mtime=1355031677"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/tuning_101_1.gif?mtime=1355031677" width="624" height="195" /></a><br />
Figure 2</div>
</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-171.png?mtime=1355031677"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-171.png?mtime=1355031677" width="624" height="217" /></a><br />
Figure 3</div>
</p>
<p>Formatting aside, this chart can quickly show inside sales where to focus on.  The associates of the inside sales department focus on this chart when making calls to customers, when they are not seeking new customers.  </p>
<p>This type of chart and query are extremely common with this type of visual representation of what is happening in sales.  Almost all departments that rely on visual dashboards, either from monitors located around the department or on0demand execution from computers, have these types of charts to help them focus on key areas of business.  As data professionals, it is our task to ensure these queries are efficient and the end result, the dashboard, loads efficiently and quickly without any problems.</p>
<p><strong>The Code Tuning Exercise</strong></p>
<p>When code comes across from new development, it is the best time to make changes for best practices and efficiency before it is introduced into a production situation.  Let’s look at the query in listing 1.</p>
<p>There are a few things we want to key on</p>
<ol>
<li>Sargability</li>
<li>Sorting and Grouping needs</li>
<li>Memory allocation needs (cache)</li>
<li>Index needs</li>
</ol>
<p>Of course, best practices should always be a task in review for any query review and tuning efforts.  We simply cannot go through each bad practice with one query and in one article.  What we can do, with most queries, is cover the first 4 steps.  </p>
<p><strong>Sargability – Code Changes</strong></p>
<p>Sargable queries come down to search argument capable, or effectively utilizing indexing to minimize time, memory usage and overall consumption of resource like IO to fulfill the query’s needs.  This indicates the primary area to review first is the WHERE &#8211; the predicates area of the query.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-172.png?mtime=1355031677"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-172.png?mtime=1355031677" width="418" height="174" /></a><br />
Figure 4</div>
</p>
<p>A good rule to go by out of the box is, anything that manipulates the left side of the comparison will indicate a non-sargable situation.  In listing 1, the function Year on the column ShipDate to the left, comparing 2005 to the resulting value, causes this to be a non-sargable predicate &#8211;  a predicate that cannot fully take advantage of indexing.   The YEAR() function is used in this example due to the high usage of it just as shown in listing 1.  Luckily, there is an effective way to write this in a sargable manner.</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">WHERE</span> hdr.<span class="me1">ShipDate</span> <span class="sy0">&gt;=</span> <span class="st0">'2005-01-01'</span> <span class="sy0">AND</span> hdr.<span class="me1">ShipDate</span> <span class="sy0">&lt;=</span> <span class="st0">'2005-12-31'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">WHERE hdr.ShipDate &gt;= '2005-01-01' AND hdr.ShipDate &lt;= '2005-12-31'</pre></div></div>

</p>
<p>Listing 2</p>
</p>
<p>Listing 2 shows a method for querying the ShipDate value for all rows that will be a match to the year 2005.  By creating the predicates of a ShipDate greater than the 1st of the year and less than the last day of the year, we can effectively search the index instead of scanning the entire contents of the index to fulfill the needs.</p>
<p>Other common non-sargable predicates use LEFT, RIGHT, DATEDIFF, DATEPART and misusing LIKE for wildcard search on the left side of a string parameter.</p>
<p><strong>Sorting and Grouping</strong></p>
<p>Sorting data in a query can be a battle that can be won but is more often lost.  The need to sort data is almost always prevalent in data representation.  However, where the data is sorted is a key aspect of the data to focus on.  SQL Server often sorts very effectively on small volumes of data.  However, when data exceeds an estimated memory allocation upon the optimization cycle, the memory needs grows in order to fulfill the queries results.  When this happens, sorting is commonly spilled into the tempdb system database.  There are several areas that can be focused on when tempdb is involved.  One of the most effective is limiting when tempdb is required for these sorting situations.  </p>
<p>Take the example below.</p>
<p>Table tempdb_usage has the following schema and contains 2 million rows of data.</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
5
6
7
8
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">TABLE</span> <span class="br0">&#91;</span>dbo<span class="br0">&#93;</span>.<span class="br0">&#91;</span>tempdb_usage<span class="br0">&#93;</span><span class="br0">&#40;</span>
&nbsp; &nbsp; <span class="br0">&#91;</span>id<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">int</span><span class="br0">&#93;</span> <span class="kw1">IDENTITY</span><span class="br0">&#40;</span><span class="nu0">1</span>,<span class="nu0">1</span><span class="br0">&#41;</span> <span class="sy0">NOT</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>bla1<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">36</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>bla2<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">36</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>bla3<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">varchar</span><span class="br0">&#93;</span><span class="br0">&#40;</span><span class="nu0">36</span><span class="br0">&#41;</span> <span class="sy0">NULL</span>,
&nbsp; &nbsp; <span class="br0">&#91;</span>SomeDate<span class="br0">&#93;</span> <span class="br0">&#91;</span><span class="kw1">datetime</span><span class="br0">&#93;</span> <span class="sy0">NULL</span>
<span class="br0">&#41;</span>
<span class="kw1">CREATE</span> <span class="kw1">INDEX</span> IDX_WEIRD<span class="sy0">IN</span>DEX_USE <span class="kw1">ON</span> tempdb_usage <span class="br0">&#40;</span>bla1<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE TABLE [dbo].[tempdb_usage](
	[id] [int] IDENTITY(1,1) NOT NULL,
	[bla1] [varchar](36) NULL,
	[bla2] [varchar](36) NULL,
	[bla3] [varchar](36) NULL,
	[SomeDate] [datetime] NULL
)
CREATE INDEX IDX_WEIRDINDEX_USE ON tempdb_usage (bla1)</pre></div></div>

</p>
<p>
<blockquote>Note: you can find code to load this table for testing of your own from <a href="http://forum.lessthandot.com/viewtopic.php?f=17&amp;t=13566">this LessThanDot forum thread</a>.</p></blockquote>
<p>Listing 3</p>
</p>
<p>The data is as shown in figure 5</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-173.png?mtime=1355031678"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-173.png?mtime=1355031678" width="624" height="237" /></a><br />
Figure 5</div>
</p>
<p>If the following query was executed against this table to return all the rows in column bla1 that are similar to the parameter string of “data”</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> bla1 <span class="kw1">FROM</span> dbo.<span class="br0">&#91;</span>tempdb_usage<span class="br0">&#93;</span>
<span class="kw1">WHERE</span> bla1 <span class="sy0">LIKE</span> <span class="st0">'bla1 data %'</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT bla1 FROM dbo.[tempdb_usage]
WHERE bla1 LIKE 'bla1 data %'</pre></div></div>

</p>
<p>Listing 4</p>
<p>The above query would result in a plan that effectively scans on the index created from listing 3 (in an OLAP situation, this would be acceptable).</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-174.png?mtime=1355031679"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-174.png?mtime=1355031679" width="580" height="182" /></a><br />
Figure 6</div>
</p>
<p>If this were an OLAP setup, the query and resulting plan would typically be acceptable.  However, if the reporting needs that caused this query to be written and utilized also required the data to be sorted by columns, the needs of the query would drastically change.  To take a close look at what sorting would do to the tempdb utilization to fulfill the query, we can look at sys.dm_io_virtual_file_stats. </p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> num_of_reads,num_of_writes <span class="kw1">FROM</span> sys.<span class="me1">dm_io_virtual_file_stats</span><span class="br0">&#40;</span><span class="kw2">DB_ID</span><span class="br0">&#40;</span><span class="st0">'tempdb'</span><span class="br0">&#41;</span>, <span class="nu0">1</span><span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT num_of_reads,num_of_writes FROM sys.dm_io_virtual_file_stats(DB_ID('tempdb'), 1)</pre></div></div>

</p>
<p>Listing 5</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-175.png?mtime=1355031679"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-175.png?mtime=1355031679" width="368" height="70" /></a><br />
Figure 7</div>
</p>
<p>The results above are from the query in listing 4 being executed.  To get a good baseline of the tempdb utilization, run listing 4 again and then compare the difference.  </p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-176.png?mtime=1355031679"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-176.png?mtime=1355031679" width="400" height="83" /></a><br />
Figure 8</div>
</p>
<p>This shows us that tempdb was written to with a factor of 5 given the query from listing 4.  Overall, this is a low number and we could live with it on a lot of instances.  To show how sorting in SQL Server could drastically change this utilization, execute the query in listing 6. </p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
</pre></td><td class="de1"><pre class="de1"><span class="kw1">SELECT</span> bla1 <span class="kw1">FROM</span> dbo.<span class="br0">&#91;</span>tempdb_usage<span class="br0">&#93;</span>
<span class="kw1">WHERE</span> bla1 <span class="sy0">LIKE</span> <span class="st0">'bla1 data %'</span>
<span class="kw1">ORDER</span> <span class="kw1">BY</span> bla2</pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">SELECT bla1 FROM dbo.[tempdb_usage]
WHERE bla1 LIKE 'bla1 data %'
ORDER BY bla2</pre></div></div>

</p>
<p>Listing 6</p>
<p>The first thing to note is the sort operation in the execution plan.  In many queries, an ORDER BY may be hard to focus on.  In an execution plan, they may stick out a bit more and give a point in the query to refer back to. </p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-177.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-177.png?mtime=1355031680" width="624" height="142" /></a><br />
Figure 9</div>
</p>
<p>Notice first that the warning indicator of red on the highest cost operation has moved from the index scan and to the sort operation.  Now, check the tempdb usage that was needed to fulfill the demand the query has.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-178.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-178.png?mtime=1355031680" width="358" height="79" /></a><br />
Figure 10</div>
</p>
<p>As shown, the use of tempdb when the estimated memory needs of the plan is exceeded is drastic.  In a baseline situation, there would be a major spike in tempdb utilization and overall, cause for concern, review or tempdb configuration changes to handle the increased need.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-179.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-179.png?mtime=1355031680" width="252" height="230" /></a><br />
Figure 11</div>
</p>
<p>The above query could effectively be sorted in the final tool to eliminate the ORDER BY all together.  Reporting Services has its own sorting capability as do most of the other reporting mechanisms used in most enterprise installations.  The key is to measure the effects of the reporting tools or services against the needs of SQL Server performing the sorting.  You will find that this tuning effort does lend to a 50/50 finding of, 50% will kick back to better performance, even with the tempdb utilization, over the reporting tool’s memory consumption of overall performance of sorting the data at runtime. </p>
<p><strong>Memory allocation needs (cache)</strong></p>
<p>How a query is written and the supporting indexes that are in place to assist in the queries can have a major impact on how many pages are read into memory by SQL Server.  Lowering the number of pages needed should always be an area to focus on when tuning efforts are made.  This can be done on queries that are not implemented and queries that are monitored in the plan cache of SQL Server by monitoring and creating baselines of the usage over time.  </p>
<p>To monitor cached pages, the Cache Pages counter can be utilized.  To test a query by tuning it after it is found to be suffering or during review, DMV sys.dm_os_buffer_descriptions and sys.indexes catalog view can be utilized.  Refer to “<a href="/index.php/DataMgmt/DBAdmin/MSSQLServerAdmin/adding-nonclustered-index-on-primary">Adding nonclustered index on primary keys</a>” for a query that is used in the results for pages allocated in figure 12.</p>
<p>Executing the query from listing 1 results in the following buffer allocations</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-180.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-180.png?mtime=1355031680" width="624" height="127" /></a><br />
Figure 12</div>
</p>
<p>At this time, no indexing has been performed on the tables the query is reading.  This results in 3 HEAP tables and an overall consumption of 39MB of the buffer.</p>
<p>The next step to perform in the tuning efforts would be to effectively lower the pages that are read into the buffer.  This is done by effective indexing and by the methods we’ve already covered.  Since indexing can single-handedly have the most impact on performance, that is what we will cover next.  While working through indexing the query in listing 1, we will monitor the pages allocated and refer back to this section to show how indexing efforts not only enhance the speed of the query but, lower the complete resource consumption on the SQL Server entirely. </p>
<p><strong>Indexing</strong></p>
<p>As stated, indexing can have the highest impact on performance for a SQL Server instance.  This is because, indexing can restrict the needs for resources by limiting the volume of resources needed to fulfill a query.  This includes IO, Memory and CPU utilization.  Each resources relates to the other in terms of, when IO is high, CPU is effected and the same can be said about memory.  </p>
<p>In listing 1, the following actual execution plan is generated by the optimization process in SQL Server.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-181.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-181.png?mtime=1355031680" width="624" height="170" /></a><br />
Figure 13</div>
</p>
<p>
<blockquote>Note: <a href="http://www.sqlsentry.net/plan-explorer/sql-server-query-view.asp">Plan Explorer Pro</a> is utilized in all the execution plan and tuning efforts shown in this article.  This tool is also available in a free version from <a href="http://www.sqlsentry.net/plan-explorer/sql-server-query-view.asp">SQL Sentry</a>.  The pro version is highly recommended and an asset to tuning.</p></blockquote>
<p>Some high cost operations that can be identified quickly in any execution plan are</p>
<ul>
<li>Physical Join – hash, merge, nested loop poorly used)</li>
<li>Table scans</li>
<li>Index scans</li>
<li>Table Valued Functions</li>
<li>Sorts</li>
<li>Lookups</li>
</ul>
<p>The above 6 operations are a great place to start when tuning by execution plan use.  In listing 1 and the execution plan generated, three table scans are quickly identified.  These three table scans can be eliminated by indexing both the predicates and the output lists.  This is known as creating a covering index.  A covering index is an index that completely fulfills the needs of the query by <em>covering </em>the search arguments (predicates) and the columns that are to be returned by the query.  </p>
<p>Look at the table scan on SalesOrderHeader</p>
</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-182.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-182.png?mtime=1355031680" width="791" height="179" /></a><br />
Figure 14</div>
</p>
<p>The scan contained a sort on ShipDate and then SalesOrderID and SalesPersonID with a filter on ShipDate.  This tells us all we need to create an effective index on SalesOrderHeader.</p>
<p>Some basics of index creation: Columns in an output list are typically better suited for a nonkey area or the INCLUDE.  Foreign keys (FK) or keys used as JOIN criteria should be indexed but can be part of the index key columns if they fulfill the covering index concept.  In most cases, FK indexes should be created at all times to ensure efficient use in queries.  Predicates or, for Plan Explorer, filters, should be in the key column listing and in many cases, can be ordered as they fall in the predicates ordering.  </p>
<p>With these basic steps, the following indexes can be created.</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
3
4
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">CLUSTERED</span> <span class="kw1">INDEX</span> IDX_SalesOrderID <span class="kw1">ON</span> Sales.<span class="me1">SalesOrderHeader</span> <span class="br0">&#40;</span>SalesOrderID<span class="br0">&#41;</span>
<span class="kw1">CREATE</span> <span class="kw1">NONCLUSTERED</span> <span class="kw1">INDEX</span> IDX_SalesPersonID <span class="kw1">ON</span> Sales.<span class="me1">SalesOrderHeader</span> <span class="br0">&#40;</span>SalesPersonID<span class="br0">&#41;</span>
<span class="kw1">CREATE</span> <span class="kw1">NONCLUSTERED</span> <span class="kw1">INDEX</span> IDX_COVER_HEADER <span class="kw1">ON</span> Sales.<span class="me1">SalesOrderHeader</span> <span class="br0">&#40;</span>ShipDate<span class="br0">&#41;</span> 
<span class="sy0">IN</span>CLUDE <span class="br0">&#40;</span>SalesOrderID, SalesPersonID<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE CLUSTERED INDEX IDX_SalesOrderID ON Sales.SalesOrderHeader (SalesOrderID)
CREATE NONCLUSTERED INDEX IDX_SalesPersonID ON Sales.SalesOrderHeader (SalesPersonID)
CREATE NONCLUSTERED INDEX IDX_COVER_HEADER ON Sales.SalesOrderHeader (ShipDate) 
INCLUDE (SalesOrderID, SalesPersonID)</pre></div></div>

</p>
<p>Listing 7</p>
<p>Execute the query from listing 1 again in Plan Explorer and review the results from our index creation</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-183.png?mtime=1355031680"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-183.png?mtime=1355031680" width="624" height="92" /></a><br />
Figure 15</div>
</p>
<p>Checking the page allocation and how it has changed from our initial results, we can see that the FK indexes are utilized as well as the new index.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-184.png?mtime=1355031681"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-184.png?mtime=1355031681" width="624" height="114" /></a><br />
Figure 16</div>
</p>
<p>Recall prior in figure 12, the HEAP and resulting pages pulled into the buffer were 799.  This has now been reduced to a total of 31 for SalesOrderHeader.  As well as the buffered page count being tuned, the execution plan generated has also been tuned for SalesOrderHeader.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-185.png?mtime=1355031681"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-185.png?mtime=1355031681" width="624" height="149" /></a><br />
Figure 17</div>
</p>
<p>Following the same effective steps to create indexes, cover the remaining table scans from the figure 18.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-186.png?mtime=1355031682"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-186.png?mtime=1355031682" width="624" height="165" /></a><br />
Figure 18</div>
</p>
<p>Person.Person</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">CLUSTERED</span> <span class="kw1">INDEX</span> IDX_BusinessEntityID <span class="kw1">ON</span> Person.<span class="me1">Person</span> <span class="br0">&#40;</span>BusinessEntityID<span class="br0">&#41;</span>
<span class="kw1">CREATE</span> <span class="kw1">NONCLUSTERED</span> <span class="kw1">INDEX</span> IDX_FirstLastName <span class="kw1">ON</span> Person.<span class="me1">Person</span> <span class="br0">&#40;</span>FirstName,LastName<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE CLUSTERED INDEX IDX_BusinessEntityID ON Person.Person (BusinessEntityID)
CREATE NONCLUSTERED INDEX IDX_FirstLastName ON Person.Person (FirstName,LastName)</pre></div></div>

</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-187.png?mtime=1355031682"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-187.png?mtime=1355031682" width="624" height="48" /></a><br />
Figure 19</div>
</p>
<p>Sales.SalesOrderDetail</p>
<p>

<div class="bwp-syntax-block clearfix">
<div class="bwp-syntax-toolbar"><div class="bwp-syntax-control"><a href="javascript:;" class="bwp-syntax-source-switch" title="View Source Code"></a></div></div>
<div class="bwp-syntax-wrapper clearfix bwp-syntax-simple"><table class="tsql"><thead><tr><td colspan="2"  class="head">T-SQL</td></tr></thead><tbody><tr class="li1"><td class="ln"><pre class="de1">1
2
</pre></td><td class="de1"><pre class="de1"><span class="kw1">CREATE</span> <span class="kw1">CLUSTERED</span> <span class="kw1">INDEX</span> IDX_SalesOrderID_DTL <span class="kw1">ON</span> Sales.<span class="me1">SalesOrderDetail</span> <span class="br0">&#40;</span>SalesOrderID<span class="br0">&#41;</span>
<span class="kw1">CREATE</span> <span class="kw1">NONCLUSTERED</span> <span class="kw1">INDEX</span> IDX_OrderQTY <span class="kw1">ON</span> Sales.<span class="me1">SalesOrderDetail</span> <span class="br0">&#40;</span>OrderQTY<span class="br0">&#41;</span></pre></td></tr></tbody></table></div>
<div class="bwp-syntax-source"><pre class="no-parse">CREATE CLUSTERED INDEX IDX_SalesOrderID_DTL ON Sales.SalesOrderDetail (SalesOrderID)
CREATE NONCLUSTERED INDEX IDX_OrderQTY ON Sales.SalesOrderDetail (OrderQTY)</pre></div></div>

</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-188.png?mtime=1355031682"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-188.png?mtime=1355031682" width="624" height="35" /></a><br />
Figure 20</div>
</p>
<p>Plan completion after indexing</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-189.png?mtime=1355031682"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-189.png?mtime=1355031682" width="624" height="161" /></a><br />
Figure 21</div>
</p>
<p>The final step will be reviewing the buffered pages again to ensure the query is utilizing as little resources as needed at this time.</p>
<p>
<div class="image_block"><a href="/wp-content/uploads/blogs/DataMgmt/-190.png?mtime=1355032754"><img alt="" src="/wp-content/uploads/blogs/DataMgmt/-190.png?mtime=1355032754" width="624" height="149" /></a><br />
Figure 22</div>
</p>
<p><strong>Summary</strong></p>
<p>With all the tuning efforts that are made with today’s high-volume databases, indexing and coding best practices are still an extremely effective and important first stage for ensuring resources are utilized effectively.  Best practice coding standards such as writing sargable queries can ensure coding efforts prove the efficiency they have to offer while returning mission critical data.  Finally, while indexing, monitoring buffer and extending to resource needs, should be done on even the simplest queries.</p>
<p>Using these steps in their basic form is almost a daily review of any SQL Server and database resource.  Although many other tuning areas are to be performed such as IO subsystems configurations, memory expansion and types as well as CPU expansion while taking into account altering and setting SQL Server configurations as needed, indexing and what has been covered today still remains the highest impact areas of the relational database.  </p>
<div class='rp4wp-related-posts'>
<h3>Related Posts</h3>
<ul>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/dbadmin/sql-server-dba-tip-missing-index-dmv/'>SQL Server DBA Tip 12 – SQL Server Tuning – Missing Index DMV</a><p>Prior to SQL Server 2005, determining index needs was a much more intense process.  The&hellip;</p></div>
</li>
<li><div class='rp4wp-related-post-content'>
<a href='/index.php/datamgmt/dbprogramming/adding-nonclustered-index-on-primary/'>Adding nonclustered index on primary keys</a><p>Recently, during a pre-conference seminar that I presented, the group and I had a long&hellip;</p></div>
</li>
</ul>
</div>
</div>
				<div class="post-author">
					<div class="userInfo"><h2>About the Author</h2>Ted Krueger is a SQL Server MVP and Author that has been working in development and database administration and the owner of a successful consulting business, DataMetrics Consulting.  Specialties range from High Availability and Disaster / Recovery setup and testing methods down to custom assembly development for SQL Server Reporting Services.  Ted blogs and is also one of the founders of LessThanDot.com technology community.  Some of the articles focused on are Backup / Recovery, Security, SSIS and working on SQL Server and using all of the SQL Server features available to create stable and scalable database services.  <br style="clear: left" /><div class="bioSoc"><span class="bioSocTitle">Social Sitings</span><a href="http://twitter.com/onpnt" title="onpnt at Twitter" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_twitter.png" alt="Twitter" /></a><a href="http://www.facebook.com/profile.php?id=https://www.facebook.com/onpntfirearms" title="onpnt at Facebook" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_facebook.png" alt="Facebook" /></a><a href="http://www.linkedin.com/pub/ted-krueger/2/183/b66" title="onpnt at LinkedIn" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_linkedin.png" alt="LinkedIn" /></a><a href="http://www.datametricsconsulting.com/" title="onpnt at HomePage" class="bioSocLink" rel="author"><img src="http://lessthandot.com/images/bdg_homepage.png" alt="HomePage" /></a><a href="/index.php/author/onpnt/feed/" title="Blog RSS feed for onpnt" class="bioSocLink"><img src="http://lessthandot.com/images/bdg_rss_icon.png" alt="LTD RSS Feed" /></a></div></div>				</div>
				<div class="post-foot instapaper_ignore">
					<div class="post-tagline">
						<div class="post-foot-views"><label>Article views:</label> 95,013 </div>
						<div class="post-foot-more-posts">
                            <a href="/index.php/author/onpnt/">Read More Posts by Ted Krueger (onpnt)</a>
						</div>
					</div>
					<div>
						 
					</div>
					<div class="post-tagline" style="height: auto">
						<span class="social-button-label">Share:</span><a href="https://twitter.com/intent/tweet?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&text=RT @LessThanDot Blog - SQL Server Query Tuning &ndash; Back to Basics by @onpnt" class="twitter-share-button-static" target="_blank"><i></i><span class="label">Tweet</span></a><a href="http://www.linkedin.com/shareArticle?mini=true&url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics&source=/index.php/datamgmt/dbadmin/sql-server-tuning/" target="_blank" title="Share on LinkedIn" class="svg-button"><img alt="Share on LinkedIn"  src="http://lessthandot.com/images/LinkedIn.svg" /></a><a href="http://www.reddit.com/submit?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics" target="_blank" title="Submit to Reddit" class="svg-button"><img alt="Submit to Reddit" src="http://lessthandot.com/images/Reddit.svg" /></a><a href="https://www.facebook.com/sharer/sharer.php?u=/index.php/datamgmt/dbadmin/sql-server-tuning/&quote=SQL Server Query Tuning &ndash; Back to Basics" title="Share on Facebook" target="_blank" class="svg-button"><img alt="Share on Facebook" src="http://lessthandot.com/images/Facebook.svg" /></a> <a href="http://www.instapaper.com/hello2?url=/index.php/datamgmt/dbadmin/sql-server-tuning/&title=SQL Server Query Tuning &ndash; Back to Basics" class="instapaper_button">Instapaper</a>					</div>			
				</div>
				<div class="comments-area instapaper_ignore">
	<h4 class="comments-title">
		3 Comments	</h4>
			<ol class="comments-list">
					<li class="comment even thread-even depth-1" id="comment-5691">
				<div id="div-comment-5691" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://0.gravatar.com/avatar/c97a3622cfa5e02193f0faad3ae3727b?s=64&#038;d=mm&#038;r=g' srcset='http://0.gravatar.com/avatar/c97a3622cfa5e02193f0faad3ae3727b?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">sql solutions</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbadmin/sql-server-tuning/#comment-5691">
			May 3, 2013 at 12:29 am</a>		</div>

		<p>Hi, I used to get many latest news form your post. This post on SQL tuning is really interesting. Keep on doing.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbadmin/sql-server-tuning/?replytocom=5691#respond' onclick='return addComment.moveForm( "div-comment-5691", "5691", "respond", "1838" )' aria-label='Reply to sql solutions'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-5689">
				<div id="div-comment-5689" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/8083f53832487357bee37dbc08722525?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/8083f53832487357bee37dbc08722525?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn"><a href='http://www.entrancesoftware.com/blog/' rel='external nofollow' class='url'>Val</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbadmin/sql-server-tuning/#comment-5689">
			May 8, 2013 at 1:11 pm</a>		</div>

		<p>I recently post a three part series on SQL server tuning that you may find helpful: <a href="http://www.entrancesoftware.com/2013/04/12/software-consultant-best-practices-sql-databases-indexing/" rel="nofollow">http://www.entrancesoftware.com/2013/04/12/software-consultant-best-practices-sql-databases-indexing/</a></p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbadmin/sql-server-tuning/?replytocom=5689#respond' onclick='return addComment.moveForm( "div-comment-5689", "5689", "respond", "1838" )' aria-label='Reply to Val'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-5690">
				<div id="div-comment-5690" class="comment-body">
				<div class="comment-author vcard">
			<img alt='' src='http://2.gravatar.com/avatar/20bdfcb9478a94ed3a13809ece5f8852?s=64&#038;d=mm&#038;r=g' srcset='http://2.gravatar.com/avatar/20bdfcb9478a94ed3a13809ece5f8852?s=128&amp;d=mm&amp;r=g 2x' class='avatar avatar-64 photo' height='64' width='64' />			<cite class="fn">Harsh</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="/index.php/datamgmt/dbadmin/sql-server-tuning/#comment-5690">
			July 10, 2013 at 1:30 am</a>		</div>

		<p>THanks for this, I also found this good article on SQL query tuning:</p>
<p>
<a href="http://www.programmerinterview.com/index.php/database-sql/how-to-tune-sql-queries-2/" rel="nofollow">http://www.programmerinterview.com/index.php/database-sql/how-to-tune-sql-queries-2/</a></p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='/index.php/datamgmt/dbadmin/sql-server-tuning/?replytocom=5690#respond' onclick='return addComment.moveForm( "div-comment-5690", "5690", "respond", "1838" )' aria-label='Reply to Harsh'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol>
						<div id="respond" class="comment-respond">
			<h3 id="reply-title" class="comment-reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/index.php/datamgmt/dbadmin/sql-server-tuning/#respond" style="display:none;">Cancel reply</a></small></h3>				<form action="/wp-comments-post.php" method="post" id="commentform" class="comment-form">
					<p class="comment-notes"><span id="email-notes">Your email address will not be published.</span> Required fields are marked <span class="required">*</span></p><p class="comment-form-comment"><label for="comment">Comment</label> <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='1838' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><input type="hidden" id="killer_value" name="killer_value" value="3e89ebdb49f712c7d90d1b39e348bbbf"/><noscript>Sorry, but you are required to use a javascript enabled brower to comment here.</noscript>				</form>
					</div><!-- #respond -->
		</div>			</div>
				<br style="clear: both;" />
</div>
		</div>
		<div id="page-footer">
			<div id="botnav"><a href="http://lessthandot.com/" title="LessThanDot Launchpad">Launchpad</a> | <a href="http://lessthandot.com/account.php" title="Your Account Settings">My Account</a> | <a href="http://lessthandot.com/statistics.php" title="Statistics">Statistics</a> | <a href="http://lessthandot.com/donate.php" title="Donate">Donate</a> | <a href="http://lessthandot.com/contactus.php" title="Contact Us">Contact Us</a> | <a href="http://lessthandot.com/aboutus.php" title="About the LessThanDot Team">&copy;2008 - 2019 LessThanDot, LLC</a></div>

		<script type='text/javascript'>
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-4471405-1']);
		_gaq.push(['_trackPageview']);
		_gaq.push(['_setCustomVar', 1, 'Environment', 'lessthandot.com', 3]);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	  </script>			<div class="validator"><a href="http://validator.w3.org/check?uri=referer">Valid XHTML</a> | <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Validate the CSS for this page at the W3C website">Valid CSS</a> | 2018-11-11 15:52</div>
		</div>
	</div>
</div>
<!-- <script type="text/javascript" src="http://apis.google.com/js/plusone.js"></script> -->
<script type='text/javascript' src='/wp-includes/js/wp-embed.min.js?ver=4.6.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var spam_destroyer = {"key":"159ff9dcc225580310c2de238cdd1f1a","lifetime":"3600","limit":"1552765735"};
/* ]]> */
</script>
<script type='text/javascript' src='/wp-content/plugins/spam-destroyer/kill.js?ver=1.2'></script>
</body>
</html>
